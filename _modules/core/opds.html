
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.opds &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.opds</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">parse_qsl</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">defaultdict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">.cdn</span> <span class="kn">import</span> <span class="n">cdnify</span>
<span class="kn">from</span> <span class="nn">.classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">.entrypoint</span> <span class="kn">import</span> <span class="n">EntryPoint</span>
<span class="kn">from</span> <span class="nn">.facets</span> <span class="kn">import</span> <span class="n">FacetConstants</span>
<span class="kn">from</span> <span class="nn">.lane</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Facets</span><span class="p">,</span>
    <span class="n">FacetsWithEntryPoint</span><span class="p">,</span>
    <span class="n">FeaturedFacets</span><span class="p">,</span>
    <span class="n">Lane</span><span class="p">,</span>
    <span class="n">Pagination</span><span class="p">,</span>
    <span class="n">SearchFacets</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.lcp.credential</span> <span class="kn">import</span> <span class="n">LCPCredentialFactory</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CachedFeed</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">Measurement</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.flask_util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSEntryResponse</span><span class="p">,</span>
    <span class="n">OPDSFeedResponse</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.opds_writer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AtomFeed</span><span class="p">,</span>
    <span class="n">OPDSFeed</span><span class="p">,</span>
    <span class="n">OPDSMessage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="UnfulfillableWork"><a class="viewcode-back" href="../../core.html#core.opds.UnfulfillableWork">[docs]</a><span class="k">class</span> <span class="nc">UnfulfillableWork</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise this exception when it turns out a Work currently cannot be</span>
<span class="sd">    fulfilled through any means, *and* this is a problem sufficient to</span>
<span class="sd">    cancel the creation of an &lt;entry&gt; for the Work.</span>

<span class="sd">    For commercial works, this might be because the collection</span>
<span class="sd">    contains no licenses. For open-access works, it might be because</span>
<span class="sd">    none of the delivery mechanisms could be mirrored.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Annotator"><a class="viewcode-back" href="../../core.html#core.opds.Annotator">[docs]</a><span class="k">class</span> <span class="nc">Annotator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The Annotator knows how to present an OPDS feed in a specific</span>
<span class="sd">    application context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">opds_cache_field</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">simple_opds_entry</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Annotator.is_work_entry_solo"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.is_work_entry_solo">[docs]</a>    <span class="k">def</span> <span class="nf">is_work_entry_solo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a boolean value indicating whether the work&#39;s OPDS catalog entry is served by itself,</span>
<span class="sd">            rather than as a part of the feed.</span>

<span class="sd">        :param work: Work object</span>
<span class="sd">        :type work: core.model.work.Work</span>

<span class="sd">        :return: Boolean value indicating whether the work&#39;s OPDS catalog entry is served by itself,</span>
<span class="sd">            rather than as a part of the feed</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Annotator.annotate_work_entry"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.annotate_work_entry">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_work_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span>
                            <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make any custom modifications necessary to integrate this</span>
<span class="sd">        OPDS entry into the application&#39;s workflow.</span>

<span class="sd">        :work: The Work whose OPDS entry is being annotated.</span>
<span class="sd">        :active_license_pool: Of all the LicensePools associated with this</span>
<span class="sd">           Work, the client has expressed interest in this one.</span>
<span class="sd">        :edition: The Edition to use when associating bibliographic</span>
<span class="sd">           metadata with this entry. You will probably not need to use</span>
<span class="sd">           this, because bibliographic metadata was associated with</span>
<span class="sd">           the entry when it was created.</span>
<span class="sd">        :identifier: Of all the Identifiers associated with this</span>
<span class="sd">           Work, the client has expressed interest in this one.</span>
<span class="sd">        :param feed: An OPDSFeed -- the feed in which this entry will be</span>
<span class="sd">           situated.</span>
<span class="sd">        :param entry: An lxml Element object, the entry that will be added</span>
<span class="sd">           to the feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First, try really hard to find an Identifier that we can</span>
        <span class="c1"># use to make the &lt;id&gt; tag.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active_license_pool</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">identifier</span>
            <span class="k">elif</span> <span class="n">edition</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>

        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">))</span>

        <span class="c1"># Add a permalink if one is available.</span>
        <span class="n">permalink_uri</span><span class="p">,</span> <span class="n">permalink_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permalink_for</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">identifier</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">permalink_uri</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;alternate&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">permalink_uri</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">permalink_type</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_work_entry_solo</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                    <span class="n">entry</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">permalink_uri</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">permalink_type</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">active_license_pool</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="o">!=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">INTERNAL_PROCESSING</span><span class="p">:</span>
                <span class="c1"># INTERNAL_PROCESSING indicates a dummy LicensePool</span>
                <span class="c1"># created as a stand-in, e.g. by the metadata wrangler.</span>
                <span class="c1"># This component is not actually distributing the book,</span>
                <span class="c1"># so it should not have a bibframe:distribution tag.</span>
                <span class="n">provider_name_attr</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}ProviderName&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">BIBFRAME_NS</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">provider_name_attr</span> <span class="p">:</span> <span class="n">data_source</span><span class="p">}</span>
                <span class="n">data_source_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                    <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}distribution&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">BIBFRAME_NS</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">data_source_tag</span><span class="p">])</span>

            <span class="c1"># We use Atom &#39;published&#39; for the date the book first became</span>
            <span class="c1"># available to people using this application.</span>
            <span class="n">avail</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">availability_time</span>
            <span class="k">if</span> <span class="n">avail</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
                <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avail</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">avail</span> <span class="o">&lt;=</span> <span class="n">today</span><span class="p">:</span> <span class="c1"># Avoid obviously wrong values.</span>
                    <span class="n">availability_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;published&quot;</span><span class="p">)</span>
                    <span class="c1"># TODO: convert to local timezone.</span>
                    <span class="n">availability_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">_strftime</span><span class="p">(</span><span class="n">avail</span><span class="p">)</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">availability_tag</span><span class="p">])</span>

        <span class="c1"># If this OPDS entry is being used as part of a grouped feed</span>
        <span class="c1"># (which is up to the Annotator subclass), we need to add a</span>
        <span class="c1"># group link.</span>
        <span class="n">group_uri</span><span class="p">,</span> <span class="n">group_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_uri</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">identifier</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">group_uri</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">GROUP_REL</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">group_uri</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_title</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">last_update_time</span><span class="p">:</span>
            <span class="c1"># NOTE: This is a default that works in most cases. When</span>
            <span class="c1"># ordering ElasticSearch results by last update time,</span>
            <span class="c1"># `work` is a WorkSearchResult object containing a more</span>
            <span class="c1"># reliable value that you can use if you want.</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">last_update_time</span>
        <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">_strftime</span><span class="p">(</span><span class="n">updated</span><span class="p">))])</span></div>

<div class="viewcode-block" id="Annotator.annotate_feed"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.annotate_feed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">annotate_feed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make any custom modifications necessary to integrate this</span>
<span class="sd">        OPDS feed into the application&#39;s workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Annotator.group_uri"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.group_uri">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">group_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The URI to be associated with this Work when making it part of</span>
<span class="sd">        a grouped feed.</span>

<span class="sd">        By default, this does nothing. See circulation/LibraryAnnotator</span>
<span class="sd">        for a subclass that does something.</span>

<span class="sd">        :return: A 2-tuple (URI, title)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Annotator.rating_tag"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.rating_tag">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rating_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">type_uri</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a schema:Rating tag for the given type and value.&quot;&quot;&quot;</span>
        <span class="n">rating_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;Rating&quot;</span><span class="p">))</span>
        <span class="n">value_key</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s1">&#39;ratingValue&#39;</span><span class="p">)</span>
        <span class="n">rating_tag</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value_key</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_uri</span><span class="p">:</span>
            <span class="n">type_key</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s1">&#39;additionalType&#39;</span><span class="p">)</span>
            <span class="n">rating_tag</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">type_key</span><span class="p">,</span> <span class="n">type_uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rating_tag</span></div>

<div class="viewcode-block" id="Annotator.cover_links"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.cover_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cover_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all links to be used as cover links for this work.</span>

<span class="sd">        In a distribution application, each work will have only one</span>
<span class="sd">        link. In a content server-type application, each work may have</span>
<span class="sd">        a large number of links.</span>

<span class="sd">        :return: A 2-tuple (thumbnail_links, full_links)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thumbnails</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">full</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">:</span>
                <span class="n">thumbnails</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdnify</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">:</span>
                <span class="n">full</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdnify</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">thumbnails</span><span class="p">,</span> <span class="n">full</span></div>

<div class="viewcode-block" id="Annotator.categories"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.categories">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">categories</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all relevant classifications of this work.</span>

<span class="sd">        :return: A dictionary mapping &#39;scheme&#39; URLs to dictionaries of</span>
<span class="sd">            attribute-value pairs.</span>

<span class="sd">        Notable attributes: &#39;term&#39;, &#39;label&#39;, &#39;http://schema.org/ratingValue&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">categories</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fiction_term</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">fiction</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fiction_term</span> <span class="o">=</span> <span class="s1">&#39;Fiction&#39;</span>
        <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">fiction</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">fiction_term</span> <span class="o">=</span> <span class="s1">&#39;Nonfiction&#39;</span>
        <span class="k">if</span> <span class="n">fiction_term</span><span class="p">:</span>
            <span class="n">fiction_scheme</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_FICTION_STATUS</span>
            <span class="n">categories</span><span class="p">[</span><span class="n">fiction_scheme</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">fiction_scheme</span> <span class="o">+</span> <span class="n">fiction_term</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="n">fiction_term</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">simplified_genres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wg</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">work_genres</span><span class="p">:</span>
            <span class="n">simplified_genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">simplified_genres</span><span class="p">:</span>
            <span class="n">categories</span><span class="p">[</span><span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                     <span class="n">label</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">simplified_genres</span>
            <span class="p">]</span>

        <span class="c1"># Add the appeals as a category of schema</span>
        <span class="c1"># http://librarysimplified.org/terms/appeal</span>
        <span class="n">schema_url</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span> <span class="o">+</span> <span class="s2">&quot;appeals/&quot;</span>
        <span class="n">appeals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">categories</span><span class="p">[</span><span class="n">schema_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">appeals</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">CHARACTER_APPEAL</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">appeal_character</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">LANGUAGE_APPEAL</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">appeal_language</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">SETTING_APPEAL</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">appeal_setting</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">STORY_APPEAL</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">appeal_story</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">appeal</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">schema_url</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">weight_field</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;ratingValue&quot;</span><span class="p">)</span>
                <span class="n">appeal</span><span class="p">[</span><span class="n">weight_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">appeals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appeal</span><span class="p">)</span>

        <span class="c1"># Add the audience as a category of schema</span>
        <span class="c1"># http://schema.org/audience</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span><span class="p">:</span>
            <span class="n">audience_uri</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SCHEMA_NS</span> <span class="o">+</span> <span class="s2">&quot;audience&quot;</span>
            <span class="n">categories</span><span class="p">[</span><span class="n">audience_uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">audience</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Any book can have a target age, but the target age</span>
        <span class="c1"># is only relevant for childrens&#39; and YA books.</span>
        <span class="n">audiences_with_target_age</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">target_age</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="ow">in</span> <span class="n">audiences_with_target_age</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">uri_lookup</span><span class="p">[</span><span class="n">Subject</span><span class="o">.</span><span class="n">AGE_RANGE</span><span class="p">]</span>
            <span class="n">target_age</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">target_age_string</span>
            <span class="k">if</span> <span class="n">target_age</span><span class="p">:</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">target_age</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">target_age</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">categories</span></div>

<div class="viewcode-block" id="Annotator.authors"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.authors">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">authors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create one or more &lt;author&gt; and &lt;contributor&gt; tags for the given</span>
<span class="sd">        Work.</span>

<span class="sd">        :param work: The Work under consideration.</span>
<span class="sd">        :param edition: The Edition to use as a reference</span>
<span class="sd">            for bibliographic information, including the list of</span>
<span class="sd">            Contributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contributor_tag</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># contributor_tag decided that this contribution doesn&#39;t</span>
                <span class="c1"># need a tag.</span>
                <span class="k">continue</span>
            <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">authors</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">authors</span>

        <span class="c1"># We have no author information, so we add empty &lt;author&gt; tag</span>
        <span class="c1"># to avoid the implication (per RFC 4287 4.2.1) that this book</span>
        <span class="c1"># was written by whoever wrote the OPDS feed.</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))]</span></div>

<div class="viewcode-block" id="Annotator.contributor_tag"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.contributor_tag">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">contributor_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">contribution</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build an &lt;author&gt; or &lt;contributor&gt; tag for a Contribution.</span>

<span class="sd">        :param contribution: A Contribution.</span>
<span class="sd">        :param state: A defaultdict of sets, which may be used to keep</span>
<span class="sd">            track of what happened during previous calls to</span>
<span class="sd">            contributor_tag for a given Work.</span>
<span class="sd">        :return: A Tag, or None if creating a Tag for this Contribution</span>
<span class="sd">            would be redundant or of low value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contributor</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">role</span>

        <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLES</span><span class="p">:</span>
            <span class="n">tag_f</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">author</span>
            <span class="n">marc_role</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag_f</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">contributor</span>
            <span class="n">marc_role</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">MARC_ROLE_CODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">marc_role</span><span class="p">:</span>
                <span class="c1"># This contribution is not one that we publish as</span>
                <span class="c1"># a &lt;atom:contributor&gt; tag. Skip it.</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span>
        <span class="n">name_key</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name_key</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="n">marc_role</span><span class="p">]:</span>
            <span class="c1"># We&#39;ve already credited this person with this</span>
            <span class="c1"># MARC role. Returning a tag would be redundant.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Okay, we&#39;re creating a tag.</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">marc_role</span><span class="p">:</span>
            <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}role&#39;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPF_NS</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_role</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_f</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="o">**</span><span class="n">properties</span><span class="p">)</span>

        <span class="c1"># Record the fact that we credited this person with this role,</span>
        <span class="c1"># so that we don&#39;t do it again on a subsequent call.</span>
        <span class="n">state</span><span class="p">[</span><span class="n">marc_role</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tag</span></div>

<div class="viewcode-block" id="Annotator.series"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.series">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">series_name</span><span class="p">,</span> <span class="n">series_position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a schema:Series tag for the given name and position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">series_details</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">series_details</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_name</span>
        <span class="k">if</span> <span class="n">series_position</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series_details</span><span class="p">[</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">series_position</span><span class="p">)</span>
        <span class="n">series_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;Series&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">series_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series_tag</span></div>

<div class="viewcode-block" id="Annotator.content"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.content">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an HTML summary of this work.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">summary_text</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">summary_text</span>
            <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">work</span><span class="o">.</span><span class="n">summary_text</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">content</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">summary_text</span>
        <span class="k">return</span> <span class="n">summary</span></div>

<div class="viewcode-block" id="Annotator.lane_id"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.lane_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lane_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">featured_feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span></div>

<div class="viewcode-block" id="Annotator.work_id"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.work_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">work_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">urn</span></div>

<div class="viewcode-block" id="Annotator.permalink_for"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.permalink_for">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">permalink_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a permanent link a client can follow for information about</span>
<span class="sd">        this entry, and only this entry.</span>

<span class="sd">        Note that permalink is distinct from the Atom &lt;id&gt;,</span>
<span class="sd">        which is always the identifier&#39;s URN.</span>

<span class="sd">        :return: A 2-tuple (URL, media type). If a single value is</span>
<span class="sd">            returned, the media type will be presumed to be that of an</span>
<span class="sd">            OPDS entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In the absence of any specific controllers, there is no</span>
        <span class="c1"># permalink. This method must be defined in a subclass.</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Annotator.lane_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.lane_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lane_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.feed_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.feed_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">feed_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.groups_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.groups_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">groups_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.search_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.search_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">search_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.default_lane_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.default_lane_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_lane_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.featured_feed_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.featured_feed_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">featured_feed_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.facet_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.facet_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">facet_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Annotator.navigation_url"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.navigation_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">navigation_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.active_licensepool_for"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.active_licensepool_for">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">active_licensepool_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Which license pool would be/has been used to issue a license for</span>
<span class="sd">        this work?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">work</span><span class="o">.</span><span class="n">active_license_pool</span><span class="p">()</span></div>

<div class="viewcode-block" id="Annotator.sort_works_for_groups_feed"><a class="viewcode-back" href="../../core.html#core.opds.Annotator.sort_works_for_groups_feed">[docs]</a>    <span class="k">def</span> <span class="nf">sort_works_for_groups_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">works</span></div></div>


<div class="viewcode-block" id="VerboseAnnotator"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator">[docs]</a><span class="k">class</span> <span class="nc">VerboseAnnotator</span><span class="p">(</span><span class="n">Annotator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The default Annotator for machine-to-machine integration.</span>

<span class="sd">    This Annotator describes all categories and authors for the book</span>
<span class="sd">    in great detail.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">opds_cache_field</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">verbose_opds_entry</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="VerboseAnnotator.annotate_work_entry"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator.annotate_work_entry">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_work_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span>
                            <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VerboseAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">annotate_work_entry</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_ratings</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></div>

<div class="viewcode-block" id="VerboseAnnotator.add_ratings"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator.add_ratings">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_ratings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a quality rating to the work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">type_uri</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">Measurement</span><span class="o">.</span><span class="n">QUALITY</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">quality</span><span class="p">),</span>
                <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">rating</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Measurement</span><span class="o">.</span><span class="n">POPULARITY</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">popularity</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">rating_tag</span><span class="p">(</span><span class="n">type_uri</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="VerboseAnnotator.categories"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator.categories">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">categories</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send out _all_ categories for the work.</span>

<span class="sd">        (So long as the category type has a URI associated with it in</span>
<span class="sd">        Subject.uri_lookup.)</span>

<span class="sd">        :param policy: A PresentationCalculationPolicy to</span>
<span class="sd">            use when deciding how deep to go when finding equivalent</span>
<span class="sd">            identifiers for the work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span> <span class="ow">or</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
            <span class="n">equivalent_identifier_cutoff</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">by_scheme_and_term</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">identifier_ids</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">all_identifier_ids</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">classifications</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">classifications_for_identifier_ids</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classifications</span><span class="p">:</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span>
            <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">Subject</span><span class="o">.</span><span class="n">uri_lookup</span><span class="p">:</span>
                <span class="n">scheme</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">uri_lookup</span><span class="p">[</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                <span class="n">term</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">identifier</span>
                <span class="n">weight_field</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;ratingValue&quot;</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">by_scheme_and_term</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">value</span><span class="p">[</span><span class="n">weight_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">by_scheme_and_term</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">by_scheme_and_term</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">weight_field</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">weight</span>

        <span class="c1"># Collapse by_scheme_and_term to by_scheme</span>
        <span class="n">by_scheme</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">term</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">by_scheme_and_term</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">by_scheme</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">by_scheme</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">VerboseAnnotator</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">categories</span><span class="p">(</span><span class="n">work</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">by_scheme</span></div>

<div class="viewcode-block" id="VerboseAnnotator.authors"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator.authors">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">authors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a detailed &lt;author&gt; tag for each author.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">detailed_author</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">author_contributors</span><span class="p">]</span></div>

<div class="viewcode-block" id="VerboseAnnotator.detailed_author"><a class="viewcode-back" href="../../core.html#core.opds.VerboseAnnotator.detailed_author">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detailed_author</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">contributor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a Contributor into a detailed &lt;author&gt; tag.&quot;&quot;&quot;</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">sort_name</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}sort_name&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">)</span>
        <span class="n">sort_name</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span>

        <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sort_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contributor</span><span class="o">.</span><span class="n">family_name</span><span class="p">:</span>
            <span class="n">family_name</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;family_name&quot;</span><span class="p">))</span>
            <span class="n">family_name</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">contributor</span><span class="o">.</span><span class="n">family_name</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">family_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contributor</span><span class="o">.</span><span class="n">wikipedia_name</span><span class="p">:</span>
            <span class="n">wikipedia_name</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}wikipedia_name&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">)</span>
            <span class="n">wikipedia_name</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">contributor</span><span class="o">.</span><span class="n">wikipedia_name</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wikipedia_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contributor</span><span class="o">.</span><span class="n">viaf</span><span class="p">:</span>
            <span class="n">viaf_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;sameas&quot;</span><span class="p">))</span>
            <span class="n">viaf_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;http://viaf.org/viaf/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">contributor</span><span class="o">.</span><span class="n">viaf</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">viaf_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contributor</span><span class="o">.</span><span class="n">lc</span><span class="p">:</span>
            <span class="n">lc_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;sameas&quot;</span><span class="p">))</span>
            <span class="n">lc_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;http://id.loc.gov/authorities/names/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">contributor</span><span class="o">.</span><span class="n">lc</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc_tag</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="AcquisitionFeed"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed">[docs]</a><span class="k">class</span> <span class="nc">AcquisitionFeed</span><span class="p">(</span><span class="n">OPDSFeed</span><span class="p">):</span>

    <span class="n">FACET_REL</span> <span class="o">=</span> <span class="s2">&quot;http://opds-spec.org/facet&quot;</span>

<div class="viewcode-block" id="AcquisitionFeed.groups"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.groups">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">groups</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span>
               <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The acquisition feed for &#39;featured&#39; items from a given lane&#39;s</span>
<span class="sd">        sublanes, organized into per-lane groups.</span>

<span class="sd">        NOTE: If the lane has no sublanes, a grouped feed will</span>
<span class="sd">        probably be unsatisfying. Call page() instead with an</span>
<span class="sd">        appropriate Facets object.</span>

<span class="sd">        :param pagination: A Pagination object. No single child of this lane</span>
<span class="sd">            will contain more than `pagination.size` items.</span>
<span class="sd">        :param facets: A GroupsFacet object.</span>

<span class="sd">        :param response_kwargs: Extra keyword arguments to pass into</span>
<span class="sd">            the OPDSFeedResponse constructor.</span>

<span class="sd">        :return: An OPDSFeedResponse containing the feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_make_annotator</span><span class="p">(</span><span class="n">annotator</span><span class="p">)</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span> <span class="ow">or</span> <span class="n">FeaturedFacets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">worklist</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_generate_groups</span><span class="p">(</span>
                <span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="n">worklist</span><span class="p">,</span>
                <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
                <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">search_debug</span><span class="o">=</span><span class="n">search_debug</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="n">worklist</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
            <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">refresher_method</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
            <span class="o">**</span><span class="n">response_kwargs</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_generate_groups</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span>
        <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">search_engine</span><span class="p">,</span> <span class="n">search_debug</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method called by groups() when a grouped feed</span>
<span class="sd">        must be regenerated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Try to get a set of (Work, WorkList) 2-tuples</span>
        <span class="c1"># to make a normal grouped feed.</span>
        <span class="n">works_and_lanes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span>
                <span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
                <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">search_debug</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Make a typical grouped feed.</span>
        <span class="n">all_works</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span><span class="p">,</span> <span class="n">sublane</span> <span class="ow">in</span> <span class="n">works_and_lanes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sublane</span><span class="o">==</span><span class="n">worklist</span><span class="p">:</span>
                <span class="c1"># We are looking at the groups feed for (e.g.)</span>
                <span class="c1"># &quot;Science Fiction&quot;, and we&#39;re seeing a book</span>
                <span class="c1"># that is featured within &quot;Science Fiction&quot; itself</span>
                <span class="c1"># rather than one of the sublanes.</span>
                <span class="c1">#</span>
                <span class="c1"># We want to assign this work to a group called &quot;All</span>
                <span class="c1"># Science Fiction&quot; and point its &#39;group URI&#39; to</span>
                <span class="c1"># the linear feed of the &quot;Science Fiction&quot; lane</span>
                <span class="c1"># (as opposed to the groups feed, which is where we</span>
                <span class="c1"># are now).</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">lane</span><span class="o">=</span><span class="n">worklist</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">worklist</span><span class="o">.</span><span class="n">display_name_for_all</span><span class="p">,</span>
                    <span class="n">link_to_list_feed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We are looking at the groups feed for (e.g.)</span>
                <span class="c1"># &quot;Science Fiction&quot;, and we&#39;re seeing a book</span>
                <span class="c1"># that is featured within one of its sublanes,</span>
                <span class="c1"># such as &quot;Space Opera&quot;.</span>
                <span class="c1">#</span>
                <span class="c1"># We want to assign this work to a group derived</span>
                <span class="c1"># from the sublane.</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lane</span><span class="o">=</span><span class="n">sublane</span><span class="p">)</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">lanes_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">all_works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="n">all_works</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">sort_works_for_groups_feed</span><span class="p">(</span><span class="n">all_works</span><span class="p">)</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">all_works</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span>

        <span class="c1"># Regardless of whether or not the entries in feed can be</span>
        <span class="c1"># grouped together, we want to apply certain feed-level</span>
        <span class="c1"># annotations.</span>

        <span class="c1"># A grouped feed may link to alternate entry points into</span>
        <span class="c1"># the data.</span>
        <span class="n">entrypoints</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">selectable_entrypoints</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">make_link</span><span class="p">(</span><span class="n">ep</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">annotator</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span>
                    <span class="n">worklist</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">entrypoint</span><span class="o">=</span><span class="n">ep</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_entrypoint_links</span><span class="p">(</span>
                <span class="n">feed</span><span class="p">,</span> <span class="n">make_link</span><span class="p">,</span> <span class="n">entrypoints</span><span class="p">,</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span>
            <span class="p">)</span>

        <span class="c1"># A grouped feed may have breadcrumb links.</span>
        <span class="n">feed</span><span class="o">.</span><span class="n">add_breadcrumb_links</span><span class="p">(</span><span class="n">worklist</span><span class="p">,</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">)</span>

        <span class="c1"># Miscellaneous.</span>
        <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">worklist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feed</span>

<div class="viewcode-block" id="AcquisitionFeed.page"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.page">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">page</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span>
             <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a feed representing one page of works from a given lane.</span>

<span class="sd">        :param response_kwargs: Extra keyword arguments to pass into</span>
<span class="sd">            the OPDSFeedResponse constructor.</span>

<span class="sd">        :return: An OPDSFeedResponse containing the feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">worklist</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span> <span class="ow">or</span> <span class="n">Facets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">pagination</span> <span class="o">=</span> <span class="n">pagination</span> <span class="ow">or</span> <span class="n">Pagination</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_make_annotator</span><span class="p">(</span><span class="n">annotator</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_generate_page</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span>
                <span class="n">search_engine</span><span class="p">,</span> <span class="n">search_debug</span>
            <span class="p">)</span>

        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;max_age&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="n">worklist</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
            <span class="n">refresher_method</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_generate_page</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span>
        <span class="n">search_engine</span><span class="p">,</span> <span class="n">search_debug</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method called by page() when a cached feed</span>
<span class="sd">        must be regenerated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">works</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">works</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
            <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">search_debug</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">works</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># It&#39;s possible that works() returned a database query or</span>
            <span class="c1"># other generator-like object, but at this point we want</span>
            <span class="c1"># an actual list of Work objects.</span>
            <span class="n">works</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">works</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pagination</span><span class="o">.</span><span class="n">page_has_loaded</span><span class="p">:</span>
            <span class="c1"># Depending on how the works were obtained,</span>
            <span class="c1"># Pagination.page_loaded may or may not have been called</span>
            <span class="c1"># yet.</span>
            <span class="n">pagination</span><span class="o">.</span><span class="n">page_loaded</span><span class="p">(</span><span class="n">works</span><span class="p">)</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span>

        <span class="n">entrypoints</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">selectable_entrypoints</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="c1"># A paginated feed may have multiple entry points into the</span>
            <span class="c1"># same dataset.</span>
            <span class="k">def</span> <span class="nf">make_link</span><span class="p">(</span><span class="n">ep</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span>
                    <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">entrypoint</span><span class="o">=</span><span class="n">ep</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_entrypoint_links</span><span class="p">(</span>
                <span class="n">feed</span><span class="p">,</span> <span class="n">make_link</span><span class="p">,</span> <span class="n">entrypoints</span><span class="p">,</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span>
            <span class="p">)</span>

        <span class="c1"># Add URLs to change faceted views of the collection.</span>
        <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">facet_links</span><span class="p">(</span><span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">works</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pagination</span><span class="o">.</span><span class="n">has_next_page</span><span class="p">:</span>
            <span class="c1"># There are works in this list. Add a &#39;next&#39; link.</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="o">.</span><span class="n">next_page</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pagination</span><span class="o">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="o">.</span><span class="n">first_page</span><span class="p">))</span>

        <span class="n">previous_page</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">previous_page</span>
        <span class="k">if</span> <span class="n">previous_page</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">previous_page</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="n">FacetsWithEntryPoint</span><span class="p">):</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_breadcrumb_links</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">)</span>

        <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feed</span>

<div class="viewcode-block" id="AcquisitionFeed.from_query"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.from_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_query</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">feed_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">url_fn</span><span class="p">,</span> <span class="n">annotator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build  a feed representing one page of a given list. Currently used for</span>
<span class="sd">        creating an OPDS feed for a custom list and not cached.</span>

<span class="sd">        TODO: This is used by the circulation manager admin interface.</span>
<span class="sd">        Investigate changing the code that uses this to use the search</span>
<span class="sd">        index -- this is inefficient and creates an alternate code path</span>
<span class="sd">        that may harbor bugs.</span>

<span class="sd">        TODO: This cannot currently return OPDSFeedResponse because the</span>
<span class="sd">        admin interface modifies the feed after it&#39;s generated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">page_of_works</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">pagination</span><span class="o">.</span><span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="n">feed</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">feed_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_of_works</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pagination</span><span class="o">.</span><span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pagination</span><span class="o">.</span><span class="n">has_next_page</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url_fn</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">next_page</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pagination</span><span class="o">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url_fn</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">first_page</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pagination</span><span class="o">.</span><span class="n">previous_page</span><span class="p">:</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url_fn</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">previous_page</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">feed</span></div>

<div class="viewcode-block" id="AcquisitionFeed.as_response"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.as_response">[docs]</a>    <span class="k">def</span> <span class="nf">as_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert this feed into an OPDSFEedResponse.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OPDSFeedResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.as_error_response"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.as_error_response">[docs]</a>    <span class="k">def</span> <span class="nf">as_error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert this feed into an OPDSFEedResponse that should be treated</span>
<span class="sd">        by intermediaries as an error -- that is, treated as private</span>
<span class="sd">        and not cached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_response</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_annotator</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">annotator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to make sure there&#39;s some kind of Annotator.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">annotator</span><span class="p">:</span>
            <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">annotator</span><span class="p">):</span>
            <span class="n">annotator</span> <span class="o">=</span> <span class="n">annotator</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">annotator</span>

<div class="viewcode-block" id="AcquisitionFeed.facet_link"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.facet_link">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">facet_link</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a set of attributes for a facet link.</span>

<span class="sd">        :param href: Destination of the link.</span>
<span class="sd">        :param title: Human-readable description of the facet.</span>
<span class="sd">        :param facet_group_name: The facet group to which the facet belongs,</span>
<span class="sd">           e.g. &quot;Sort By&quot;.</span>
<span class="sd">        :param is_active: True if this is the client&#39;s currently</span>
<span class="sd">           selected facet.</span>

<span class="sd">        :return: A dictionary of attributes, suitable for passing as</span>
<span class="sd">            keyword arguments into OPDSFeed.add_link_to_feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">FACET_REL</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}facetGroup&#39;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_group_name</span>
        <span class="k">if</span> <span class="n">is_active</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}activeFacet&#39;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">return</span> <span class="n">args</span></div>

<div class="viewcode-block" id="AcquisitionFeed.add_entrypoint_links"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.add_entrypoint_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_entrypoint_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">url_generator</span><span class="p">,</span> <span class="n">entrypoints</span><span class="p">,</span>
                             <span class="n">selected_entrypoint</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="s1">&#39;Formats&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add links to a feed forming an OPDS facet group for a set of</span>
<span class="sd">        EntryPoints.</span>

<span class="sd">        :param feed: A lxml Tag object.</span>
<span class="sd">        :param url_generator: A callable that returns the entry point</span>
<span class="sd">            URL when passed an EntryPoint.</span>
<span class="sd">        :param entrypoints: A list of all EntryPoints in the facet group.</span>
<span class="sd">        :param selected_entrypoint: The current EntryPoint, if selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entrypoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">selected_entrypoint</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">entrypoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="c1"># There is only one entry point. Unless the currently</span>
            <span class="c1"># selected entry point is somehow different, there&#39;s no</span>
            <span class="c1"># need to put any links at all here -- a facet group with</span>
            <span class="c1"># one one facet might as well not be there.</span>
            <span class="k">return</span>

        <span class="n">is_default</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">entrypoint</span> <span class="ow">in</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_entrypoint_link</span><span class="p">(</span>
                <span class="n">url_generator</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">selected_entrypoint</span><span class="p">,</span> <span class="n">is_default</span><span class="p">,</span>
                <span class="n">group_name</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">link</span><span class="p">)</span>
                <span class="n">is_default</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_entrypoint_link</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">url_generator</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">selected_entrypoint</span><span class="p">,</span>
            <span class="n">is_default</span><span class="p">,</span> <span class="n">group_name</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create arguments for add_link_to_feed for a link that navigates</span>
<span class="sd">        between EntryPoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">display_title</span> <span class="o">=</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">DISPLAY_TITLES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">display_title</span><span class="p">:</span>
            <span class="c1"># Shouldn&#39;t happen.</span>
            <span class="k">return</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">url_generator</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="n">is_selected</span> <span class="o">=</span> <span class="n">entrypoint</span> <span class="ow">is</span> <span class="n">selected_entrypoint</span>
        <span class="n">link</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">facet_link</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">display_title</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">is_selected</span><span class="p">)</span>

        <span class="c1"># Unlike a normal facet group, every link in this facet</span>
        <span class="c1"># group has an additional attribute marking it as an entry</span>
        <span class="c1"># point.</span>
        <span class="c1">#</span>
        <span class="c1"># In OPDS 2 this can become an additional rel value,</span>
        <span class="c1"># removing the need for a custom attribute.</span>
        <span class="n">link</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}facetGroupType&#39;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">]</span> <span class="o">=</span> <span class="n">FacetConstants</span><span class="o">.</span><span class="n">ENTRY_POINT_REL</span>
        <span class="k">return</span> <span class="n">link</span>

<div class="viewcode-block" id="AcquisitionFeed.add_breadcrumb_links"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.add_breadcrumb_links">[docs]</a>    <span class="k">def</span> <span class="nf">add_breadcrumb_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add information necessary to find your current place in the</span>
<span class="sd">        site&#39;s navigation.</span>

<span class="sd">        A link with rel=&quot;start&quot; points to the start of the site</span>

<span class="sd">        A &lt;simplified:entrypoint&gt; section describes the current entry point.</span>

<span class="sd">        A &lt;simplified:breadcrumbs&gt; section contains a sequence of</span>
<span class="sd">        breadcrumb links.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add the top-level link with rel=&#39;start&#39;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span>
        <span class="n">top_level_title</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">top_level_title</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;Collection Home&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span>
            <span class="n">feed</span><span class="o">=</span><span class="n">xml</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">default_lane_url</span><span class="p">(),</span>
            <span class="n">title</span><span class="o">=</span><span class="n">top_level_title</span>
        <span class="p">)</span>

        <span class="c1"># Add a link to the direct parent with rel=&quot;up&quot;.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: the &#39;direct parent&#39; may be the same lane but without</span>
        <span class="c1"># the entry point specified. Fixing this would also be a good</span>
        <span class="c1"># opportunity to refactor the code for figuring out parent and</span>
        <span class="c1"># parent_title.</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
            <span class="n">parent_title</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">display_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_title</span> <span class="o">=</span> <span class="n">top_level_title</span>

        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">up_uri</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span>
                <span class="n">feed</span><span class="o">=</span><span class="n">xml</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">up_uri</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">parent_title</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_breadcrumbs</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">)</span>

        <span class="c1"># Annotate the feed with a simplified:entryPoint for the</span>
        <span class="c1"># current EntryPoint.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_current_entrypoint</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.search"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.search">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">search_engine</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span>
               <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a search against the given search engine and return</span>
<span class="sd">        the results as a Flask Response.</span>

<span class="sd">        :param _db: A database connection</span>
<span class="sd">        :param title: The title of the resulting OPDS feed.</span>
<span class="sd">        :param url: The URL from which the feed will be served.</span>
<span class="sd">        :param search_engine: An ExternalSearchIndex.</span>
<span class="sd">        :param query: The search query</span>
<span class="sd">        :param pagination: A Pagination</span>
<span class="sd">        :param facets: A Facets</span>
<span class="sd">        :param annotator: An Annotator</span>
<span class="sd">        :param response_kwargs: Keyword arguments to pass into the OPDSFeedResponse</span>
<span class="sd">            constructor.</span>
<span class="sd">        :return: An ODPSFeedResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span> <span class="ow">or</span> <span class="n">SearchFacets</span><span class="p">()</span>
        <span class="n">pagination</span> <span class="o">=</span> <span class="n">pagination</span> <span class="ow">or</span> <span class="n">Pagination</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">search_engine</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span>
        <span class="p">)</span>
        <span class="n">opds_feed</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span>
        <span class="p">)</span>
        <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span>
            <span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">default_lane_url</span><span class="p">(),</span>
            <span class="n">title</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">top_level_title</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># A feed of search results may link to alternate entry points</span>
        <span class="c1"># into those results.</span>
        <span class="n">entrypoints</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">selectable_entrypoints</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">make_link</span><span class="p">(</span><span class="n">ep</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">annotator</span><span class="o">.</span><span class="n">search_url</span><span class="p">(</span>
                    <span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">entrypoint</span><span class="o">=</span><span class="n">ep</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_entrypoint_links</span><span class="p">(</span>
                <span class="n">opds_feed</span><span class="p">,</span> <span class="n">make_link</span><span class="p">,</span> <span class="n">entrypoints</span><span class="p">,</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># There are works in this list. Add a &#39;next&#39; link.</span>
            <span class="n">next_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">search_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="o">.</span><span class="n">next_page</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pagination</span><span class="o">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">search_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="o">.</span><span class="n">first_page</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">first_url</span><span class="p">)</span>

        <span class="n">previous_page</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">previous_page</span>
        <span class="k">if</span> <span class="n">previous_page</span><span class="p">:</span>
            <span class="n">previous_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">search_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">previous_page</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;previous&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">previous_url</span><span class="p">)</span>

        <span class="c1"># Add &quot;up&quot; link.</span>
        <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">annotator</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">lane</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>

        <span class="c1"># Add URLs to change enabled faceted views</span>
        <span class="n">enabled_order_facets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">all_order_facets</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">facet</span><span class="p">:</span> <span class="s2">&quot;Sort by&quot;</span> <span class="ow">in</span> <span class="n">facet</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">facet_links</span><span class="p">(</span><span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">original_facet</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">order</span>
        <span class="k">for</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">all_order_facets</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">facet</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">enabled_order_facets</span><span class="p">:</span>
                <span class="n">facets</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="n">original_facet</span><span class="p">:</span>
                    <span class="n">facet</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">facet_link</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">facet</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">facet</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">facet_group_name</span><span class="o">=</span><span class="s2">&quot;Sort by&quot;</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">facet</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">facet_link</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">facet</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">facet</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">facet_group_name</span><span class="o">=</span><span class="s2">&quot;Sort by&quot;</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># cls.facet_links generates a /feed/ url, but we want to use</span>
                <span class="c1"># search_url to generate a /search/ url. We also want to generate</span>
                <span class="c1"># the facet url for this given ordering facet instead of the original facet.</span>
                <span class="n">facet</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">search_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
                <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">opds_feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">facet</span><span class="p">)</span>
        <span class="n">facets</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">original_facet</span>

        <span class="c1"># We do not add breadcrumbs to this feed since you&#39;re not</span>
        <span class="c1"># technically searching the this lane; you are searching the</span>
        <span class="c1"># library&#39;s entire collection, using _some_ of the constraints</span>
        <span class="c1"># imposed by this lane (notably language and audience).</span>

        <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">opds_feed</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OPDSFeedResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">opds_feed</span><span class="p">),</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.single_entry"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.single_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">single_entry</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a single-entry OPDS document for one specific work.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param work: A Work</span>
<span class="sd">        :param work: An Annotator</span>
<span class="sd">        :param force_create: Create the OPDS entry from scratch even</span>
<span class="sd">            if there&#39;s already a cached one.</span>
<span class="sd">        :param raw: If this is False (the default), a Flask Response will be returned,</span>
<span class="sd">            ready to be sent over the network. Otherwise an object representing</span>
<span class="sd">            the underlying OPDS entry will be returned.</span>
<span class="sd">        :param use_cache: Boolean value determining whether the OPDS cache shall be used.</span>
<span class="sd">        :param response_kwargs: These keyword arguments will be passed into the Response</span>
<span class="sd">            constructor, if it is invoked.</span>
<span class="sd">        :return: A Response, if `raw` is false. Otherwise, an OPDSMessage</span>
<span class="sd">            or an etree._Element -- whatever was returned by</span>
<span class="sd">            OPDSFeed.create_entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">feed</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">Edition</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">create_entry</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">even_if_no_license_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">force_create</span><span class="o">=</span><span class="n">force_create</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span>

        <span class="c1"># Since this &lt;entry&gt; tag is going to be the root of an XML</span>
        <span class="c1"># document it&#39;s essential that it include an up-to-date nsmap,</span>
        <span class="c1"># even if it was generated from an old cached &lt;entry&gt; tag that</span>
        <span class="c1"># had an older nsmap.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;drm&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="c1"># This workaround (creating a brand new tag) is necessary</span>
            <span class="c1"># because the nsmap attribute is immutable. See</span>
            <span class="c1"># https://bugs.launchpad.net/lxml/+bug/555602</span>
            <span class="n">nsmap</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">nsmap</span>
            <span class="n">nsmap</span><span class="p">[</span><span class="s1">&#39;drm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">DRM_NS</span>
            <span class="n">new_root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">nsmap</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="n">new_root</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[:]</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">new_root</span>
        <span class="k">if</span> <span class="n">raw</span> <span class="ow">or</span> <span class="n">entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">OPDSMessage</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="c1"># This is probably an error message; don&#39;t cache it</span>
            <span class="c1"># even if it would otherwise be cached.</span>
            <span class="n">response_kwargs</span><span class="p">[</span><span class="s1">&#39;max_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">response_kwargs</span><span class="p">[</span><span class="s1">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span>

        <span class="c1"># It&#39;s common for a single OPDS entry to be returned as the</span>
        <span class="c1"># result of an unsafe operation, so we will default to setting</span>
        <span class="c1"># the response as private and uncacheable.</span>
        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;max_age&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">OPDSEntryResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">entry</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.error_message"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.error_message">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">error_message</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">error_status</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an error result into an OPDSMessage suitable for</span>
<span class="sd">        adding to a feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OPDSMessage</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">,</span> <span class="n">error_status</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.facet_links"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.facet_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">facet_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create links for this feed&#39;s navigational facet groups.</span>

<span class="sd">        This does not create links for the entry point facet group,</span>
<span class="sd">        because those links should only be present in certain</span>
<span class="sd">        circumstances, and this method doesn&#39;t know if those</span>
<span class="sd">        circumstances apply. You need to decide whether to call</span>
<span class="sd">        add_entrypoint_links in addition to calling this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">new_facets</span><span class="p">,</span> <span class="n">selected</span> <span class="ow">in</span> <span class="n">facets</span><span class="o">.</span><span class="n">facet_groups</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">facet_url</span><span class="p">(</span><span class="n">new_facets</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">group_title</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">GROUP_DISPLAY_TITLES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">facet_title</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">FACET_DISPLAY_TITLES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">group_title</span> <span class="ow">and</span> <span class="n">facet_title</span><span class="p">):</span>
                <span class="c1"># This facet group or facet, is not recognized by the</span>
                <span class="c1"># system. It may be left over from an earlier version,</span>
                <span class="c1"># or just weird junk data.</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="bp">cls</span><span class="o">.</span><span class="n">facet_link</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">facet_title</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_title</span><span class="p">),</span> <span class="n">selected</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">precomposed_entries</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Turn a list of works, messages, and precomposed &lt;opds&gt; entries</span>
<span class="sd">        into a feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">annotator</span><span class="p">:</span>
            <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">annotator</span><span class="p">):</span>
            <span class="n">annotator</span> <span class="o">=</span> <span class="n">annotator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span> <span class="o">=</span> <span class="n">annotator</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AcquisitionFeed</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="c1"># Add the precomposed entries and the messages.</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">precomposed_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">OPDSMessage</span><span class="p">):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

<div class="viewcode-block" id="AcquisitionFeed.add_entry"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.add_entry">[docs]</a>    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to create an OPDS &lt;entry&gt;. If successful, append it to</span>
<span class="sd">        the feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_entry</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">OPDSMessage</span><span class="p">):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entry</span></div>

<div class="viewcode-block" id="AcquisitionFeed.create_entry"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.create_entry">[docs]</a>    <span class="k">def</span> <span class="nf">create_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">even_if_no_license_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">force_create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a work into an entry for an acquisition feed.&quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">Edition</span><span class="p">):</span>
            <span class="n">active_edition</span> <span class="o">=</span> <span class="n">work</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
            <span class="n">active_license_pool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">active_license_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">active_licensepool_for</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
                <span class="c1"># We have a license pool but no work. Most likely we don&#39;t have</span>
                <span class="c1"># metadata for this work yet.</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">active_license_pool</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">identifier</span>
                <span class="n">active_edition</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
                <span class="n">active_edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_edition</span><span class="o">.</span><span class="n">primary_identifier</span>

        <span class="c1"># There&#39;s no reason to present a book that has no active license pool.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> HAS NO IDENTIFIER&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_license_pool</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">even_if_no_license_pool</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NO ACTIVE LICENSE POOL FOR </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="s2">&quot;I&#39;ve heard about this work but have no active licenses for it.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_edition</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NO ACTIVE EDITION FOR </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="s2">&quot;I&#39;ve heard about this work but have no metadata for it.&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_entry</span><span class="p">(</span>
                <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span>
                <span class="n">force_create</span><span class="p">,</span> <span class="n">use_cache</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">UnfulfillableWork</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Work </span><span class="si">%r</span><span class="s2"> is not fulfillable, refusing to create an &lt;entry&gt;.&quot;</span><span class="p">,</span>
                <span class="n">work</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="s2">&quot;I know about this work but can offer no way of fulfilling it.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Exception generating OPDS entry for </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">e</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_create_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span>
                      <span class="n">identifier</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a complete OPDS entry for the given Work.</span>

<span class="sd">        The OPDS entry will contain bibliographic information about</span>
<span class="sd">        the Work, as well as information derived from a specific</span>
<span class="sd">        LicensePool and Identifier associated with the Work.</span>

<span class="sd">        :param work: The Work whose OPDS entry the client is interested in.</span>
<span class="sd">        :active_license_pool: Of all the LicensePools associated with this</span>
<span class="sd">           Work, the client has expressed interest in this one.</span>
<span class="sd">        :param edition: The edition to use as the presentation edition</span>
<span class="sd">            when creating the entry. If this is not present, the work&#39;s</span>
<span class="sd">            existing presentation edition will be used.</span>
<span class="sd">        :identifier: Of all the Identifiers associated with this</span>
<span class="sd">           Work, the client has expressed interest in this one.</span>
<span class="sd">        :param force_create: Create this entry even if there&#39;s already</span>
<span class="sd">            a cached one.</span>
<span class="sd">        :param use_cache: If true, a newly created entry will be cached</span>
<span class="sd">            in the appropriate storage field of Work -- either</span>
<span class="sd">            simple_opds_entry or verbose_opds_entry. (NOTE: this has some</span>
<span class="sd">            overlap with force_create which is difficult to explain.)</span>
<span class="sd">        :return: An lxml Element object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">opds_cache_field</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">work</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_create</span> <span class="ow">and</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xml</span><span class="p">:</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_entry_xml</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">edition</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tounicode</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">use_cache</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Now add the stuff specific to the selected Identifier</span>
        <span class="c1"># and LicensePool.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">annotate_work_entry</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xml</span>

    <span class="k">def</span> <span class="nf">_make_entry_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new (incomplete) OPDS entry for the given work.</span>

<span class="sd">        It will be completed later, in an application-specific way,</span>
<span class="sd">        in annotate_work_entry().</span>

<span class="sd">        :param work: The Work that needs an OPDS entry.</span>
<span class="sd">        :param edition: The edition to use as the presentation edition</span>
<span class="sd">            when creating the entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edition</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>

        <span class="c1"># Find the .epub link</span>
        <span class="n">epub_href</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cover_quality</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">qualities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">qualities</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Work quality&quot;</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">quality</span><span class="p">))</span>
        <span class="n">full_url</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thumbnail_urls</span><span class="p">,</span> <span class="n">full_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">cover_links</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rel</span><span class="p">,</span> <span class="n">urls</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">full_urls</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">,</span> <span class="n">thumbnail_urls</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                <span class="c1"># TODO: This is suboptimal. We know the media types</span>
                <span class="c1"># associated with these URLs when they are</span>
                <span class="c1"># Representations, but we don&#39;t have a way to connect</span>
                <span class="c1"># the cover_full_url with the corresponding</span>
                <span class="c1"># Representation, and performance considerations make</span>
                <span class="c1"># it impractical to follow the object reference every</span>
                <span class="c1"># time.</span>
                <span class="n">image_type</span> <span class="o">=</span> <span class="s2">&quot;image/png&quot;</span>
                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpeg&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">):</span>
                    <span class="n">image_type</span> <span class="o">=</span> <span class="s2">&quot;image/jpeg&quot;</span>
                <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gif&quot;</span><span class="p">):</span>
                    <span class="n">image_type</span> <span class="o">=</span> <span class="s2">&quot;image/gif&quot;</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">image_type</span><span class="p">))</span>

        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">medium</span><span class="p">:</span>
            <span class="n">additional_type</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">medium_to_additional_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">edition</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">additional_type</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No additionalType for medium </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">edition</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>
            <span class="n">additional_type_field</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;additionalType&quot;</span><span class="p">)</span>
            <span class="n">kw</span><span class="p">[</span><span class="n">additional_type_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_type</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">entry</span><span class="p">(</span>
            <span class="n">AtomFeed</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">NO_TITLE</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">subtitle</span><span class="p">:</span>
            <span class="n">subtitle_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s2">&quot;alternativeHeadline&quot;</span><span class="p">))</span>
            <span class="n">subtitle_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">subtitle</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtitle_tag</span><span class="p">)</span>

        <span class="n">author_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">authors</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">edition</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">author_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">series</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">series_position</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">content_type</span><span class="p">)])</span>


        <span class="n">permanent_work_id_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}pwid&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">)</span>
        <span class="n">permanent_work_id_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">permanent_work_id</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permanent_work_id_tag</span><span class="p">)</span>

        <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

        <span class="n">categories_by_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">categories</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">category_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">categories</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">categories_by_scheme</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="n">category</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                <span class="n">category</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">category_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="o">**</span><span class="n">category</span><span class="p">)</span>
                <span class="n">category_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category_tag</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">category_tags</span><span class="p">)</span>

        <span class="c1"># print(&quot; ID %s TITLE %s AUTHORS %s&quot; % (tag, work.title, work.authors))</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">language_code</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">language_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}language&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">DCTERMS_NS</span><span class="p">)</span>
            <span class="n">language_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">language</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">language_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
            <span class="n">publisher_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}publisher&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">DCTERMS_NS</span><span class="p">)</span>
            <span class="n">publisher_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">publisher</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">publisher_tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">imprint</span><span class="p">:</span>
            <span class="n">imprint_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}publisherImprint&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">BIB_SCHEMA_NS</span><span class="p">)</span>
            <span class="n">imprint_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">imprint</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">imprint_tag</span><span class="p">])</span>

        <span class="c1"># Entry.issued is the date the ebook came out, as distinct</span>
        <span class="c1"># from Entry.published (which may refer to the print edition</span>
        <span class="c1"># or some original edition way back when).</span>
        <span class="c1">#</span>
        <span class="c1"># For Dublin Core &#39;issued&#39; we use Entry.issued if we have it</span>
        <span class="c1"># and Entry.published if not. In general this means we use</span>
        <span class="c1"># issued date for Gutenberg and published date for other</span>
        <span class="c1"># sources.</span>
        <span class="c1">#</span>
        <span class="c1"># For the date the book was added to our collection we use</span>
        <span class="c1"># atom:published.</span>
        <span class="c1">#</span>
        <span class="c1"># Note: feedparser conflates dc:issued and atom:published, so</span>
        <span class="c1"># it can&#39;t be used to extract this information. However, these</span>
        <span class="c1"># tags are consistent with the OPDS spec.</span>
        <span class="n">issued</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">issued</span> <span class="ow">or</span> <span class="n">edition</span><span class="o">.</span><span class="n">published</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">issued</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">issued</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            <span class="n">issued_already</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">issued</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="n">issued_already</span> <span class="o">=</span> <span class="p">(</span><span class="n">issued</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">issued</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
                <span class="n">issued_already</span> <span class="o">=</span> <span class="p">(</span><span class="n">issued</span> <span class="o">&lt;=</span> <span class="n">today</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">issued_already</span><span class="p">:</span>
                <span class="n">issued_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}issued&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">DCTERMS_NS</span><span class="p">)</span>
                <span class="c1"># Use datetime.isoformat instead of datetime.strftime because</span>
                <span class="c1"># strftime only works on dates after 1890, and we have works</span>
                <span class="c1"># that were issued much earlier than that.</span>
                <span class="c1"># TODO: convert to local timezone, not that it matters much.</span>
                <span class="n">issued_tag</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">issued</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">issued_tag</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">entry</span>


    <span class="n">CURRENT_ENTRYPOINT_ATTRIBUTE</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}entryPoint&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span>

<div class="viewcode-block" id="AcquisitionFeed.show_current_entrypoint"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.show_current_entrypoint">[docs]</a>    <span class="k">def</span> <span class="nf">show_current_entrypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotate this given feed with a simplified:entryPoint</span>
<span class="sd">        attribute pointing to the current entrypoint&#39;s TYPE_URI.</span>

<span class="sd">        This gives clients an overall picture of the type of works in</span>
<span class="sd">        the feed, and a way to distinguish between one EntryPoint</span>
<span class="sd">        and another.</span>

<span class="sd">        :param entrypoint: An EntryPoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entrypoint</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">URI</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_ENTRYPOINT_ATTRIBUTE</span><span class="p">]</span> <span class="o">=</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">URI</span></div>

<div class="viewcode-block" id="AcquisitionFeed.add_breadcrumbs"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.add_breadcrumbs">[docs]</a>    <span class="k">def</span> <span class="nf">add_breadcrumbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">include_lane</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add list of ancestor links in a breadcrumbs element.</span>

<span class="sd">        :param lane: Add breadcrumbs from up to this lane.</span>
<span class="sd">        :param include_lane: Include `lane` itself in the breadcrumbs.</span>
<span class="sd">        :param entrypoint: The currently selected entrypoint, if any.</span>

<span class="sd">        TODO: The switchover from &quot;no entry point&quot; to &quot;entry point&quot; needs</span>
<span class="sd">        its own breadcrumb link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entrypoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entrypoint_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entrypoint_query</span> <span class="o">=</span> <span class="s2">&quot;?entrypoint=&quot;</span> <span class="o">+</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">INTERNAL_NAME</span>

        <span class="c1"># Breadcrumbs for lanes may be end up being cut off by a</span>
        <span class="c1"># patron-type-specific root lane. If so, that lane -- not the</span>
        <span class="c1"># site root -- should become the first breadcrumb.</span>
        <span class="n">site_root_lane</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">usable_parentage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lane</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">parentage</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">root_for_patron_type</span><span class="p">:</span>
                    <span class="c1"># Root lane for a specific patron type. The root is</span>
                    <span class="c1"># treated specially, so it should not be added to</span>
                    <span class="c1"># usable_parentage. Any lanes between this lane and the</span>
                    <span class="c1"># library root should not be included at all.</span>
                    <span class="n">site_root_lane</span> <span class="o">=</span> <span class="n">ancestor</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">ancestor</span> <span class="o">!=</span> <span class="n">lane</span> <span class="ow">or</span> <span class="n">include_lane</span><span class="p">:</span>
                    <span class="c1"># A lane may appear in its own breadcrumbs</span>
                    <span class="c1"># only if include_lane is True.</span>
                    <span class="n">usable_parentage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">lane</span> <span class="o">==</span> <span class="n">site_root_lane</span> <span class="ow">or</span>
            <span class="p">(</span>
                <span class="n">site_root_lane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">annotator</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span> <span class="o">==</span> <span class="n">annotator</span><span class="o">.</span><span class="n">default_lane_url</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># There are no extra breadcrumbs: either we are at the</span>
            <span class="c1"># site root, or we are at a lane that is the root for a</span>
            <span class="c1"># specific patron type.</span>
            <span class="k">return</span>

        <span class="c1"># Start work on a simplified:breadcrumbs tag.</span>
        <span class="n">breadcrumbs</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
            <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}breadcrumbs&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span>
        <span class="p">)</span>

        <span class="c1"># Add root link. This is either the link to the site root</span>
        <span class="c1"># or to the root lane for some patron type.</span>
        <span class="k">if</span> <span class="n">site_root_lane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">default_lane_url</span><span class="p">()</span>
            <span class="n">root_title</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">top_level_title</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">site_root_lane</span><span class="p">)</span>
            <span class="n">root_title</span> <span class="o">=</span> <span class="n">site_root_lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">root_link</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">root_title</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">root_url</span><span class="p">)</span>
        <span class="n">breadcrumbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_link</span><span class="p">)</span>

        <span class="c1"># Add entrypoint selection link</span>
        <span class="k">if</span> <span class="n">entrypoint</span><span class="p">:</span>
            <span class="n">breadcrumbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AtomFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">INTERNAL_NAME</span><span class="p">,</span>
                    <span class="n">href</span><span class="o">=</span><span class="n">root_url</span> <span class="o">+</span> <span class="n">entrypoint_query</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add links for all usable lanes between `lane` and `site_root_lane`</span>
        <span class="c1"># (possibly including `lane` itself).</span>
        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">usable_parentage</span><span class="p">):</span>
            <span class="n">lane_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lane_url</span> <span class="o">==</span> <span class="n">root_url</span><span class="p">:</span>
                <span class="c1"># Root lane for the entire site.</span>
                <span class="k">break</span>

            <span class="n">breadcrumbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AtomFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">ancestor</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                    <span class="n">href</span><span class="o">=</span><span class="n">lane_url</span> <span class="o">+</span> <span class="n">entrypoint_query</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Append the breadcrumbs to the feed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">breadcrumbs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.minimal_opds_entry"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.minimal_opds_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">minimal_opds_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">cover</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
        <span class="n">most_recent_update</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">representations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cover</span><span class="p">:</span>
            <span class="n">cover_representation</span> <span class="o">=</span> <span class="n">cover</span><span class="o">.</span><span class="n">representation</span>
            <span class="n">representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover</span><span class="o">.</span><span class="n">representation</span><span class="p">)</span>
            <span class="n">cover_link</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">cover_representation</span><span class="o">.</span><span class="n">public_url</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">cover_representation</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_link</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cover_representation</span><span class="o">.</span><span class="n">thumbnails</span><span class="p">:</span>
                <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">cover_representation</span><span class="o">.</span><span class="n">thumbnails</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">)</span>
                <span class="n">thumbnail_link</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                    <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">public_url</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span>
                <span class="p">)</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thumbnail_link</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
            <span class="n">description_e</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description_e</span><span class="p">)</span>
            <span class="n">representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description</span><span class="o">.</span><span class="n">representation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">quality</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Annotator</span><span class="o">.</span><span class="n">rating_tag</span><span class="p">(</span><span class="n">Measurement</span><span class="o">.</span><span class="n">QUALITY</span><span class="p">,</span> <span class="n">quality</span><span class="p">))</span>

        <span class="c1"># The update date is the most recent date any of these</span>
        <span class="c1"># resources were mirrored/fetched.</span>
        <span class="n">potential_update_dates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span><span class="o">.</span><span class="n">mirrored_at</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">fetched_at</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">representations</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">mirrored_at</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">fetched_at</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">most_recent_update</span><span class="p">:</span>
            <span class="n">potential_update_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">most_recent_update</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">potential_update_dates</span><span class="p">:</span>
            <span class="n">update_date</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">potential_update_dates</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">_strftime</span><span class="p">(</span><span class="n">update_date</span><span class="p">)))</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">entry</span><span class="p">(</span>
            <span class="n">AtomFeed</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">),</span>
            <span class="n">AtomFeed</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">NO_TITLE</span><span class="p">),</span>
            <span class="o">*</span><span class="n">elements</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">entry</span></div>

<div class="viewcode-block" id="AcquisitionFeed.link"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.link">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">)</span></div>

<div class="viewcode-block" id="AcquisitionFeed.acquisition_link"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.acquisition_link">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">acquisition_link</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">active_loan</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">initial_type</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indirect_types</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">indirect_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">link</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">initial_type</span><span class="p">)</span>
        <span class="n">indirect</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indirect_acquisition</span><span class="p">(</span><span class="n">indirect_types</span><span class="p">)</span>

        <span class="c1"># In the case of LCP we have to include a patron&#39;s hashed passphrase</span>
        <span class="c1"># inside the acquisition link so client applications can use it to bypass authentication</span>
        <span class="c1"># and will not ask patrons to enter their passphrases</span>
        <span class="c1"># For more information please look here:</span>
        <span class="c1"># https://readium.org/lcp-specs/notes/lcp-key-retrieval.html#including-a-hashed-passphrase-in-an-opds-1-catalog</span>
        <span class="k">if</span> <span class="n">active_loan</span> <span class="ow">and</span> <span class="n">active_loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LCP</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">active_loan</span><span class="p">)</span>
            <span class="n">lcp_credential_factory</span> <span class="o">=</span> <span class="n">LCPCredentialFactory</span><span class="p">()</span>
            <span class="n">hashed_passphrase</span> <span class="o">=</span> <span class="n">lcp_credential_factory</span><span class="o">.</span><span class="n">get_hashed_passphrase</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">active_loan</span><span class="o">.</span><span class="n">patron</span><span class="p">)</span>

            <span class="n">hashed_passphrase_element</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}hashed_passphrase&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">LCP_NS</span><span class="p">)</span>
            <span class="n">hashed_passphrase_element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">hashed_passphrase</span>

            <span class="n">link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashed_passphrase_element</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indirect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">link</span></div>

<div class="viewcode-block" id="AcquisitionFeed.indirect_acquisition"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.indirect_acquisition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">indirect_acquisition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">indirect_types</span><span class="p">):</span>
        <span class="n">top_level_parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">indirect_types</span><span class="p">:</span>
            <span class="n">indirect_link</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
                <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}indirectAcquisition&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">indirect_link</span><span class="p">])</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">indirect_link</span>
            <span class="k">if</span> <span class="n">top_level_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">top_level_parent</span> <span class="o">=</span> <span class="n">indirect_link</span>
        <span class="k">return</span> <span class="n">top_level_parent</span></div>

<div class="viewcode-block" id="AcquisitionFeed.license_tags"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.license_tags">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">license_tags</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="c1"># Generate a list of licensing tags. These should be inserted</span>
        <span class="c1"># into a &lt;link&gt; tag.</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">availability_tag_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">suppress_since</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">since</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">until</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">default_loan_period</span> <span class="o">=</span> <span class="n">default_reservation_period</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loan</span> <span class="ow">or</span> <span class="n">hold</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">loan</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">loan</span>
            <span class="k">elif</span> <span class="n">hold</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">hold</span>
            <span class="n">default_loan_period</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">library</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">integration_client</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;available&#39;</span>
            <span class="n">since</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">start</span>
            <span class="n">until</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">default_loan_period</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hold</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                <span class="n">default_reservation_period</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">default_reservation_period</span>
                <span class="p">)</span>
            <span class="n">until</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">default_loan_period</span><span class="p">,</span> <span class="n">default_reservation_period</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready&#39;</span>
                <span class="n">since</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;reserved&#39;</span>
                <span class="n">since</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">start</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">license_pool</span><span class="o">.</span><span class="n">open_access</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">unlimited_access</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">self_hosted</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;available&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unavailable&#39;</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">since</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;since&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">_strftime</span><span class="p">(</span><span class="n">since</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">until</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">_strftime</span><span class="p">(</span><span class="n">until</span><span class="p">)</span>
        <span class="n">tag_name</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}availability&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span>
        <span class="n">availability_tag</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">availability_tag</span><span class="p">)</span>

        <span class="c1"># Open-access pools do not need to display &lt;opds:holds&gt; or &lt;opds:copies&gt;.</span>
        <span class="k">if</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">open_access</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">unlimited_access</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span>

        <span class="n">holds_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">hold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This shouldn&#39;t happen, but if it does, assume we&#39;re last</span>
                <span class="c1"># in the list.</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">total</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span>

            <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">holds_kw</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="n">total</span><span class="p">:</span>
                <span class="c1"># The patron&#39;s hold position appears larger than the total</span>
                <span class="c1"># number of holds. This happens frequently because the</span>
                <span class="c1"># number of holds and a given patron&#39;s hold position are</span>
                <span class="c1"># updated by different processes. Don&#39;t propagate this</span>
                <span class="c1"># appearance to the client.</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">position</span>
            <span class="k">elif</span> <span class="n">position</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># The book is reserved for this patron but they&#39;re not</span>
                <span class="c1"># counted as having it on hold. This is the only case</span>
                <span class="c1"># where we know that the total number of holds is</span>
                <span class="c1"># *greater* than the hold position.</span>
                <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">holds_kw</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

        <span class="n">holds</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}holds&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">,</span> <span class="o">**</span><span class="n">holds_kw</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span>

        <span class="n">copies_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">available</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">copies</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}copies&quot;</span> <span class="o">%</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">,</span> <span class="o">**</span><span class="n">copies_kw</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copies</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tags</span></div>

<div class="viewcode-block" id="AcquisitionFeed.format_types"><a class="viewcode-back" href="../../core.html#core.opds.AcquisitionFeed.format_types">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">format_types</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a set of types suitable for passing into</span>
<span class="sd">        acquisition_link().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># If this is a streaming book, you have to get an OPDS entry, then</span>
        <span class="c1"># get a direct link to the streaming reader from that.</span>
        <span class="k">if</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">:</span>
            <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ENTRY_TYPE</span><span class="p">)</span>

        <span class="c1"># If this is a DRM-encrypted book, you have to get through the DRM</span>
        <span class="c1"># to get the goodies inside.</span>
        <span class="n">drm</span> <span class="o">=</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">drm_scheme_media_type</span>
        <span class="k">if</span> <span class="n">drm</span><span class="p">:</span>
            <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drm</span><span class="p">)</span>

        <span class="c1"># Finally, you get the goodies.</span>
        <span class="n">media</span> <span class="o">=</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">content_type_media_type</span>
        <span class="k">if</span> <span class="n">media</span><span class="p">:</span>
            <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">media</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">types</span></div></div>


<div class="viewcode-block" id="LookupAcquisitionFeed"><a class="viewcode-back" href="../../core.html#core.opds.LookupAcquisitionFeed">[docs]</a><span class="k">class</span> <span class="nc">LookupAcquisitionFeed</span><span class="p">(</span><span class="n">AcquisitionFeed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used when the user has requested a lookup of a specific identifier,</span>
<span class="sd">    which may be different from the identifier used by the Work&#39;s</span>
<span class="sd">    default LicensePool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LookupAcquisitionFeed.create_entry"><a class="viewcode-back" href="../../core.html#core.opds.LookupAcquisitionFeed.create_entry">[docs]</a>    <span class="k">def</span> <span class="nf">create_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an Identifier and a Work into an entry for an acquisition</span>
<span class="sd">        feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span><span class="p">,</span> <span class="n">work</span> <span class="o">=</span> <span class="n">work</span>

        <span class="c1"># Unless the client is asking for something impossible</span>
        <span class="c1"># (e.g. the Identifier is not really associated with the</span>
        <span class="c1"># Work), we should be able to use the cached OPDS entry for</span>
        <span class="c1"># the Work.</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">:</span>
            <span class="n">active_licensepool</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the default active LicensePool for the Work.</span>
            <span class="n">active_licensepool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotator</span><span class="o">.</span><span class="n">active_licensepool_for</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="n">error_status</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_licensepool</span><span class="p">:</span>
            <span class="n">error_status</span> <span class="o">=</span> <span class="mi">404</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Identifier not found in collection&quot;</span>
        <span class="k">elif</span> <span class="n">identifier</span><span class="o">.</span><span class="n">work</span> <span class="o">!=</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">error_status</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;I tried to generate an OPDS entry for the identifier &quot;</span><span class="si">%s</span><span class="s1">&quot; using a Work not associated with that identifier.&#39;</span> <span class="o">%</span> <span class="n">identifier</span><span class="o">.</span><span class="n">urn</span>

        <span class="k">if</span> <span class="n">error_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">error_status</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">active_licensepool</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">active_licensepool</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_entry</span><span class="p">(</span>
                <span class="n">work</span><span class="p">,</span> <span class="n">active_licensepool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">UnfulfillableWork</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Work </span><span class="si">%r</span><span class="s2"> is not fulfillable, refusing to create an &lt;entry&gt;.&quot;</span><span class="p">,</span>
                <span class="n">work</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="mi">403</span><span class="p">,</span>
                <span class="s2">&quot;I know about this work but can offer no way of fulfilling it.&quot;</span>
            <span class="p">)</span></div></div>

<div class="viewcode-block" id="NavigationFacets"><a class="viewcode-back" href="../../core.html#core.opds.NavigationFacets">[docs]</a><span class="k">class</span> <span class="nc">NavigationFacets</span><span class="p">(</span><span class="n">FeaturedFacets</span><span class="p">):</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">NAVIGATION_TYPE</span></div>

<div class="viewcode-block" id="NavigationFeed"><a class="viewcode-back" href="../../core.html#core.opds.NavigationFeed">[docs]</a><span class="k">class</span> <span class="nc">NavigationFeed</span><span class="p">(</span><span class="n">OPDSFeed</span><span class="p">):</span>

<div class="viewcode-block" id="NavigationFeed.navigation"><a class="viewcode-back" href="../../core.html#core.opds.NavigationFeed.navigation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">navigation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span>
                   <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The navigation feed with links to a given lane&#39;s sublanes.</span>

<span class="sd">        :param response_kwargs: Extra keyword arguments to pass into</span>
<span class="sd">            the OPDSFeedResponse constructor.</span>

<span class="sd">        :return: A Response</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">_make_annotator</span><span class="p">(</span><span class="n">annotator</span><span class="p">)</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span> <span class="ow">or</span> <span class="n">NavigationFacets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_generate_navigation</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">annotator</span>
            <span class="p">)</span>

        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;mimetype&#39;</span><span class="p">,</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">NAVIGATION_FEED_TYPE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span>
            <span class="n">worklist</span><span class="o">=</span><span class="n">worklist</span><span class="p">,</span>
            <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
            <span class="n">refresher_method</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
            <span class="o">**</span><span class="n">response_kwargs</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_generate_navigation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
                             <span class="n">annotator</span><span class="p">):</span>

        <span class="n">feed</span> <span class="o">=</span> <span class="n">NavigationFeed</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">worklist</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="c1"># We can&#39;t generate links to children, since this Worklist</span>
            <span class="c1"># has no children, so we&#39;ll generate a link to the</span>
            <span class="c1"># Worklist&#39;s page-type feed instead.</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;All &quot;</span> <span class="o">+</span> <span class="n">worklist</span><span class="o">.</span><span class="n">display_name</span>
            <span class="n">page_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">visible_children</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">display_name</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">navigation_url</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">child_url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NAVIGATION_FEED_TYPE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">child_url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">child_url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">)</span>

        <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">worklist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feed</span>

<div class="viewcode-block" id="NavigationFeed.add_entry"><a class="viewcode-back" href="../../core.html#core.opds.NavigationFeed.add_entry">[docs]</a>    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">NAVIGATION_FEED_TYPE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an OPDS navigation entry for a URL.&quot;&quot;&quot;</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">AtomFeed</span><span class="o">.</span><span class="n">entry</span><span class="p">(</span>
            <span class="n">AtomFeed</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">url</span><span class="p">)])</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">AtomFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;subsection&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></div></div>


<span class="c1"># Mock annotators for use in unit tests.</span>

<div class="viewcode-block" id="TestAnnotator"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator">[docs]</a><span class="k">class</span> <span class="nc">TestAnnotator</span><span class="p">(</span><span class="n">Annotator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<div class="viewcode-block" id="TestAnnotator.lane_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.lane_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lane_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">has_visible_children</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="TestAnnotator.feed_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.feed_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">feed_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">url_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">facets</span><span class="o">.</span><span class="n">query_string</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="k">if</span> <span class="n">pagination</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">pagination</span><span class="o">.</span><span class="n">query_string</span>
        <span class="k">return</span> <span class="n">base</span></div>

<div class="viewcode-block" id="TestAnnotator.search_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.search_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">search_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">url_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">pagination</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">pagination</span><span class="o">.</span><span class="n">query_string</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
            <span class="n">facet_query_string</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">query_string</span>
            <span class="k">if</span> <span class="n">facet_query_string</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">facet_query_string</span>
        <span class="k">return</span> <span class="n">base</span></div>

<div class="viewcode-block" id="TestAnnotator.groups_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.groups_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">groups_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
            <span class="n">facet_string</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">facets</span><span class="o">.</span><span class="n">query_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">facet_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="s2">&quot;http://groups/</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">facet_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestAnnotator.default_lane_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.default_lane_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_lane_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestAnnotator.facet_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.facet_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">facet_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;http://facet/&quot;</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestAnnotator.navigation_url"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.navigation_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">navigation_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;http://navigation/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span></div>

<div class="viewcode-block" id="TestAnnotator.top_level_title"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotator.top_level_title">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">top_level_title</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Test Top Level Title&quot;</span></div></div>


<div class="viewcode-block" id="TestAnnotatorWithGroup"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotatorWithGroup">[docs]</a><span class="k">class</span> <span class="nc">TestAnnotatorWithGroup</span><span class="p">(</span><span class="n">TestAnnotator</span><span class="p">):</span>

<div class="viewcode-block" id="TestAnnotatorWithGroup.group_uri"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotatorWithGroup.group_uri">[docs]</a>    <span class="k">def</span> <span class="nf">group_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">lanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="n">lane_dic</span> <span class="o">=</span> <span class="n">lanes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lane_name</span> <span class="o">=</span> <span class="n">lane_dic</span><span class="p">[</span><span class="s1">&#39;lane&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lane_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;http://group/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lane_name</span><span class="p">,</span>
                <span class="s2">&quot;Group Title for </span><span class="si">%s</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="n">lane_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestAnnotatorWithGroup.group_uri_for_lane"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotatorWithGroup.group_uri_for_lane">[docs]</a>    <span class="k">def</span> <span class="nf">group_uri_for_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;http://groups/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                    <span class="s2">&quot;Groups of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;http://groups/&quot;</span><span class="p">,</span> <span class="s2">&quot;Top-level groups&quot;</span></div>

<div class="viewcode-block" id="TestAnnotatorWithGroup.top_level_title"><a class="viewcode-back" href="../../core.html#core.opds.TestAnnotatorWithGroup.top_level_title">[docs]</a>    <span class="k">def</span> <span class="nf">top_level_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Test Top Level Title&quot;</span></div></div>


<div class="viewcode-block" id="TestUnfulfillableAnnotator"><a class="viewcode-back" href="../../core.html#core.opds.TestUnfulfillableAnnotator">[docs]</a><span class="k">class</span> <span class="nc">TestUnfulfillableAnnotator</span><span class="p">(</span><span class="n">TestAnnotator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise an UnfulfillableWork exception when asked to annotate an entry.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestUnfulfillableAnnotator.annotate_work_entry"><a class="viewcode-back" href="../../core.html#core.opds.TestUnfulfillableAnnotator.annotate_work_entry">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_work_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">UnfulfillableWork</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>