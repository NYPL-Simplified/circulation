
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>core.metadata_layer &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.metadata_layer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;An abstract way of representing incoming metadata and applying it</span>
<span class="sd">to Identifiers and Editions.</span>

<span class="sd">This acts as an intermediary between the third-party integrations</span>
<span class="sd">(which have this information in idiosyncratic formats) and the</span>
<span class="sd">model. Doing a third-party integration should be as simple as putting</span>
<span class="sd">the information into this format.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoResultFound</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pymarc</span> <span class="kn">import</span> <span class="n">MARCReader</span>

<span class="kn">from</span> <span class="nn">.classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>
<span class="kn">from</span> <span class="nn">.util.http</span> <span class="kn">import</span> <span class="n">RemoteIntegrationException</span>
<span class="kn">from</span> <span class="nn">.util.personal_names</span> <span class="kn">import</span> <span class="n">name_tidy</span>
<span class="kn">from</span> <span class="nn">.util.median</span> <span class="kn">import</span> <span class="n">median</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">CoverageRecord</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">Equivalency</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">License</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
    <span class="n">LinkRelations</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">Resource</span><span class="p">,</span>
    <span class="n">Timestamp</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">.classifier</span> <span class="kn">import</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">NO_NUMBER</span>
<span class="kn">from</span> <span class="nn">.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>
<span class="kn">from</span> <span class="nn">.util.personal_names</span> <span class="kn">import</span> <span class="n">display_name_to_sort_name</span>
<span class="kn">from</span> <span class="nn">.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">strptime_utc</span><span class="p">,</span> <span class="n">to_utc</span><span class="p">,</span> <span class="n">utc_now</span>

<div class="viewcode-block" id="ReplacementPolicy"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ReplacementPolicy">[docs]</a><span class="k">class</span> <span class="nc">ReplacementPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;How serious should we be about overwriting old metadata with</span>
<span class="sd">    this new metadata?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">link_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">content_modifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">http_get</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">even_if_not_apparently_updated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">presentation_calculation_policy</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span> <span class="o">=</span> <span class="n">subjects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rights</span> <span class="o">=</span> <span class="n">rights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">formats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_content</span> <span class="o">=</span> <span class="n">link_content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">even_if_not_apparently_updated</span> <span class="o">=</span> <span class="n">even_if_not_apparently_updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">mirrors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_modifier</span> <span class="o">=</span> <span class="n">content_modifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">analytics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_get</span> <span class="o">=</span> <span class="n">http_get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presentation_calculation_policy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">presentation_calculation_policy</span> <span class="ow">or</span>
            <span class="n">PresentationCalculationPolicy</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ReplacementPolicy.from_license_source"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ReplacementPolicy.from_license_source">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_license_source</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When gathering data from the license source, overwrite all old data</span>
<span class="sd">        from this source with new data from the same source. Also</span>
<span class="sd">        overwrite an old rights status with an updated status and update</span>
<span class="sd">        the list of available formats. Log availability changes to the</span>
<span class="sd">        configured analytics services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="n">Analytics</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span>
            <span class="o">**</span><span class="n">args</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ReplacementPolicy.from_metadata_source"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ReplacementPolicy.from_metadata_source">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_metadata_source</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When gathering data from a metadata source, overwrite all old data</span>
<span class="sd">        from this source, but do not overwrite the rights status or</span>
<span class="sd">        the available formats. License sources are the authority on rights</span>
<span class="sd">        and formats, and metadata sources have no say in the matter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ReplacementPolicy.append_only"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ReplacementPolicy.append_only">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">append_only</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Don&#39;t overwrite any information, just append it.</span>

<span class="sd">        This should probably never be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span>
        <span class="p">)</span></div></div>

<div class="viewcode-block" id="SubjectData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.SubjectData">[docs]</a><span class="k">class</span> <span class="nc">SubjectData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

        <span class="c1"># Because subjects are sometimes evaluated according to keyword</span>
        <span class="c1"># matching, it&#39;s important that any leading or trailing white</span>
        <span class="c1"># space is removed during import.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;SubjectData type=&quot;</span><span class="si">%s</span><span class="s1">&quot; identifier=&quot;</span><span class="si">%s</span><span class="s1">&quot; name=&quot;</span><span class="si">%s</span><span class="s1">&quot; weight=</span><span class="si">%d</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ContributorData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData">[docs]</a><span class="k">class</span> <span class="nc">ContributorData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">family_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wikipedia_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">lc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">viaf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biography</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="n">sort_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family_name</span> <span class="o">=</span> <span class="n">family_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wikipedia_name</span> <span class="o">=</span> <span class="n">wikipedia_name</span>
        <span class="k">if</span> <span class="n">roles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roles</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">roles</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">roles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span> <span class="o">=</span> <span class="n">viaf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="o">=</span> <span class="n">biography</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">aliases</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># extra is a dictionary of stuff like birthdates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">extra</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># TODO:  consider if it&#39;s time for ContributorData to connect back to Contributions</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;ContributorData sort=&quot;</span><span class="si">%s</span><span class="s1">&quot; display=&quot;</span><span class="si">%s</span><span class="s1">&quot; family=&quot;</span><span class="si">%s</span><span class="s1">&quot; wiki=&quot;</span><span class="si">%s</span><span class="s1">&quot; roles=</span><span class="si">%r</span><span class="s1"> lc=</span><span class="si">%s</span><span class="s1"> viaf=</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wikipedia_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span><span class="p">)</span>


<div class="viewcode-block" id="ContributorData.from_contribution"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.from_contribution">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_contribution</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">contribution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a ContributorData object from a data-model Contribution</span>
<span class="sd">        object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">sort_name</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">family_name</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span>
            <span class="n">wikipedia_name</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">wikipedia_name</span><span class="p">,</span>
            <span class="n">lc</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span>
            <span class="n">viaf</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">viaf</span><span class="p">,</span>
            <span class="n">biography</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">biography</span><span class="p">,</span>
            <span class="n">aliases</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">aliases</span><span class="p">,</span>
            <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">contribution</span><span class="o">.</span><span class="n">role</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ContributorData.lookup"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.lookup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">sort_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">viaf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a (potentially synthetic) ContributorData based on</span>
<span class="sd">        the best available information in the database.</span>

<span class="sd">        :return: A ContributorData.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="o">==</span><span class="n">sort_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display_name</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">display_name</span><span class="o">==</span><span class="n">display_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">lc</span><span class="o">==</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">viaf</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">viaf</span><span class="o">==</span><span class="n">viaf</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">clauses</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Contributor information provided!&quot;</span><span class="p">)</span>

        <span class="n">or_clause</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">clauses</span><span class="p">)</span>
        <span class="n">contributors</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contributor</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_clause</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contributors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We have no idea who this person is.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># We found at least one matching Contributor. Let&#39;s try to</span>
        <span class="c1"># build a composite ContributorData for the person.</span>
        <span class="n">values_by_field</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="c1"># If all the people we found share (e.g.) a VIAF field, then</span>
        <span class="c1"># we can use that as a clue when doing a search -- anyone with</span>
        <span class="c1"># that VIAF number is probably this person, even if their display</span>
        <span class="c1"># name doesn&#39;t match.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contributors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">sort_name</span><span class="p">:</span>
                <span class="n">values_by_field</span><span class="p">[</span><span class="s1">&#39;sort_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sort_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
                <span class="n">values_by_field</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lc</span><span class="p">:</span>
                <span class="n">values_by_field</span><span class="p">[</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">viaf</span><span class="p">:</span>
                <span class="n">values_by_field</span><span class="p">[</span><span class="s1">&#39;viaf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">viaf</span><span class="p">)</span>

        <span class="c1"># Use any passed-in values as default values for the</span>
        <span class="c1"># ContributorData. Below, missing values may be filled in and</span>
        <span class="c1"># inaccurate values may be replaced.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">sort_name</span><span class="o">=</span><span class="n">sort_name</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">lc</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span>
            <span class="n">viaf</span><span class="o">=</span><span class="n">viaf</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values_by_field</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># All the Contributors we found have the same</span>
                <span class="c1"># value for this field. We can use it.</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ContributorData</span><span class="p">(</span><span class="n">roles</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ContributorData.apply"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the passed-in Contributor-type object with this</span>
<span class="sd">        ContributorData&#39;s information.</span>

<span class="sd">        :param: destination -- the Contributor or ContributorData object to</span>
<span class="sd">            write this ContributorData object&#39;s metadata to.</span>
<span class="sd">        :param: replace -- Replacement policy (not currently used).</span>

<span class="sd">        :return: the possibly changed Contributor object and a flag of whether it&#39;s been changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) into </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">destination</span><span class="o">.</span><span class="n">viaf</span><span class="p">)</span>

        <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">sort_name</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">existing_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">destination</span><span class="o">.</span><span class="n">aliases</span><span class="p">)</span>
        <span class="n">new_aliases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">destination</span><span class="o">.</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">sort_name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_aliases</span><span class="p">:</span>
                <span class="n">new_aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_aliases</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">new_aliases</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">destination</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span>
                <span class="n">destination</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">lc</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">viaf</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">viaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viaf</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family_name</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">family_name</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">family_name</span><span class="p">):</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">family_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family_name</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">display_name</span><span class="p">):</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wikipedia_name</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wikipedia_name</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">wikipedia_name</span><span class="p">):</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">wikipedia_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wikipedia_name</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biography</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">biography</span><span class="p">):</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">biography</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biography</span>
            <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO:  Contributor.merge_into also looks at</span>
        <span class="c1"># contributions.  Could maybe extract contributions from roles,</span>
        <span class="c1"># but not sure it&#39;d be useful.</span>

        <span class="k">return</span> <span class="n">destination</span><span class="p">,</span> <span class="n">made_changes</span></div>


<div class="viewcode-block" id="ContributorData.find_sort_name"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.find_sort_name">[docs]</a>    <span class="k">def</span> <span class="nf">find_sort_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Try as hard as possible to find this person&#39;s sort name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span><span class="p">:</span>
            <span class="c1"># log.debug(</span>
            <span class="c1">#     &quot;%s already has a sort name: %s&quot;,</span>
            <span class="c1">#     self.display_name,</span>
            <span class="c1">#     self.sort_name</span>
            <span class="c1"># )</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find sort name for a contributor with no display name!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Is there a contributor already in the database with this</span>
        <span class="c1"># exact sort name? If so, use their display name.</span>
        <span class="c1"># If not, take our best guess based on the display name.</span>
        <span class="n">sort_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name_to_sort_name_from_existing_contributor</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="n">sort_name</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Time to break out the big guns. Ask the metadata wrangler</span>
        <span class="c1"># if it can find a sort name for this display name.</span>
        <span class="k">if</span> <span class="n">metadata_client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sort_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name_to_sort_name_through_canonicalizer</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># There was some kind of problem with the metadata</span>
                <span class="c1"># wrangler. Act as though no metadata wrangler had</span>
                <span class="c1"># been provided.</span>
                <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Metadata client exception while determining sort name for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="n">sort_name</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If there&#39;s still no sort name, take our best guess based</span>
        <span class="c1"># on the display name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="n">display_name_to_sort_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ContributorData.display_name_to_sort_name_from_existing_contributor"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.display_name_to_sort_name_from_existing_contributor">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">display_name_to_sort_name_from_existing_contributor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">display_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the sort name for this book&#39;s author, assuming it&#39;s easy.</span>

<span class="sd">        &#39;Easy&#39; means we already have an established sort name for a</span>
<span class="sd">        Contributor with this exact display name.</span>

<span class="sd">        If it&#39;s not easy, this will be taken care of later with a call to</span>
<span class="sd">        the metadata wrangler&#39;s author canonicalization service.</span>

<span class="sd">        If we have a copy of this book in our collection (the only</span>
<span class="sd">        time an external list item is relevant), this will probably be</span>
<span class="sd">        easy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contributors</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contributor</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">display_name</span><span class="o">==</span><span class="n">display_name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Contributor</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">contributors</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Determined that sort name of </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> based on previously existing contributor&quot;</span><span class="p">,</span>
                <span class="n">display_name</span><span class="p">,</span>
                <span class="n">contributors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_name</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">contributors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_name</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_display_name_to_sort_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">,</span> <span class="n">identifier_obj</span>
    <span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">metadata_client</span><span class="o">.</span><span class="n">canonicalize_author_name</span><span class="p">(</span>
            <span class="n">identifier_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="n">sort_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">sort_name</span> <span class="o">=</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
                <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)):</span>
                <span class="n">sort_name</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Canonicalizer found sort name for </span><span class="si">%r</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">identifier_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">sort_name</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Canonicalizer could not find sort name for </span><span class="si">%r</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">identifier_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">sort_name</span>

<div class="viewcode-block" id="ContributorData.display_name_to_sort_name_through_canonicalizer"><a class="viewcode-back" href="../../core.html#core.metadata_layer.ContributorData.display_name_to_sort_name_through_canonicalizer">[docs]</a>    <span class="k">def</span> <span class="nf">display_name_to_sort_name_through_canonicalizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">):</span>
        <span class="n">sort_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">identifier_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
            <span class="n">sort_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name_to_sort_name</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">,</span> <span class="n">identifier_obj</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_name</span><span class="p">:</span>
            <span class="n">sort_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name_to_sort_name</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">sort_name</span></div></div>


<div class="viewcode-block" id="IdentifierData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.IdentifierData">[docs]</a><span class="k">class</span> <span class="nc">IdentifierData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;IdentifierData type=&quot;</span><span class="si">%s</span><span class="s1">&quot; identifier=&quot;</span><span class="si">%s</span><span class="s1">&quot; weight=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
        <span class="p">)</span>

<div class="viewcode-block" id="IdentifierData.load"><a class="viewcode-back" href="../../core.html#core.metadata_layer.IdentifierData.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="LinkData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.LinkData">[docs]</a><span class="k">class</span> <span class="nc">LinkData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">thumbnail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rights_explanation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">original</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transformation_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rel is required&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either href or content is required&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="n">rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">href</span> <span class="o">=</span> <span class="n">href</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">thumbnail</span>
        <span class="c1"># This handles content sources like unglue.it that have rights for each link</span>
        <span class="c1"># rather than each edition, and rights for cover images.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">=</span> <span class="n">rights_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rights_explanation</span> <span class="o">=</span> <span class="n">rights_explanation</span>
        <span class="c1"># If this LinkData is a derivative, it may also contain the original link</span>
        <span class="c1"># and the settings used to transform the original into the derivative.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="n">original</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_settings</span> <span class="o">=</span> <span class="n">transformation_settings</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">guessed_media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the media type of a link is unknown, take a guess.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">:</span>
            <span class="c1"># We know.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">href</span><span class="p">:</span>
            <span class="c1"># Take a guess.</span>
            <span class="k">return</span> <span class="n">Representation</span><span class="o">.</span><span class="n">guess_url_media_type_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">href</span><span class="p">)</span>

        <span class="c1"># No idea.</span>
        <span class="c1"># TODO: We might be able to take a further guess based on the</span>
        <span class="c1"># content and the link relation.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;, </span><span class="si">%d</span><span class="s2"> bytes content&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">:</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="s1">&#39;, has thumbnail&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;LinkData: rel=&quot;</span><span class="si">%s</span><span class="s1">&quot; href=&quot;</span><span class="si">%s</span><span class="s1">&quot; media_type=</span><span class="si">%r%s%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span> <span class="n">thumbnail</span><span class="p">,</span>
            <span class="n">content</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LinkData.mirror_type"><a class="viewcode-back" href="../../core.html#core.metadata_layer.LinkData.mirror_type">[docs]</a>    <span class="k">def</span> <span class="nf">mirror_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the type of mirror that should be used for the link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">GENERIC_OPDS_ACQUISITION</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">PROTECTED_ACCESS_BOOKS</span></div></div>


<div class="viewcode-block" id="MeasurementData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MeasurementData">[docs]</a><span class="k">class</span> <span class="nc">MeasurementData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">quantity_measured</span><span class="p">,</span>
                 <span class="n">value</span><span class="p">,</span>
                 <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">taken_at</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quantity_measured</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;quantity_measured is required.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;measurement value is required.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantity_measured</span> <span class="o">=</span> <span class="n">quantity_measured</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taken_at</span> <span class="o">=</span> <span class="n">taken_at</span> <span class="ow">or</span> <span class="n">utc_now</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;MeasurementData quantity=&quot;</span><span class="si">%s</span><span class="s1">&quot; value=</span><span class="si">%f</span><span class="s1"> weight=</span><span class="si">%d</span><span class="s1"> taken=</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantity_measured</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taken_at</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FormatData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.FormatData">[docs]</a><span class="k">class</span> <span class="nc">FormatData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">drm_scheme</span>
        <span class="k">if</span> <span class="n">link</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">LinkData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Expected LinkData object, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">=</span> <span class="n">rights_uri</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span></div>


<div class="viewcode-block" id="LicenseData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.LicenseData">[docs]</a><span class="k">class</span> <span class="nc">LicenseData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">checkout_url</span><span class="p">,</span> <span class="n">status_url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remaining_checkouts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">concurrent_checkouts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkout_url</span> <span class="o">=</span> <span class="n">checkout_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_url</span> <span class="o">=</span> <span class="n">status_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">expires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="n">remaining_checkouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_checkouts</span> <span class="o">=</span> <span class="n">concurrent_checkouts</span></div>


<div class="viewcode-block" id="TimestampData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.TimestampData">[docs]</a><span class="k">class</span> <span class="nc">TimestampData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">CLEAR_VALUE</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">CLEAR_VALUE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">achievements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">counter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A constructor intended to be used by a service to customize its</span>
<span class="sd">        eventual Timestamp.</span>

<span class="sd">        service, service_type, and collection cannot be set through</span>
<span class="sd">        this constructor, because they are generally not under the</span>
<span class="sd">        control of the code that runs the service. They are set</span>
<span class="sd">        afterwards, in finalize().</span>

<span class="sd">        :param start: The time that the service should be considered to</span>
<span class="sd">           have started running.</span>
<span class="sd">        :param finish: The time that the service should be considered</span>
<span class="sd">           to have stopped running.</span>
<span class="sd">        :param achievements: A string describing what was achieved by the</span>
<span class="sd">           service.</span>
<span class="sd">        :param counter: A single integer item of state representing the point</span>
<span class="sd">           at which the service left off.</span>
<span class="sd">        :param exception: A traceback representing an exception that stopped</span>
<span class="sd">           the progress of the service.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># These are set by finalize().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">achievements</span> <span class="o">=</span> <span class="n">achievements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this TimestampData represent an unrecoverable failure?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_VALUE</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this TimestampData represent an operation that has</span>
<span class="sd">        completed?</span>

<span class="sd">        An operation is completed if it has failed, or if the time of its</span>
<span class="sd">        completion is known.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_failure</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_VALUE</span><span class="p">)</span>

<div class="viewcode-block" id="TimestampData.finalize"><a class="viewcode-back" href="../../core.html#core.metadata_layer.TimestampData.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">service_type</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">finish</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">achievements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize any values that were not set during the constructor.</span>

<span class="sd">        This is intended to be run by the code that originally ran the</span>
<span class="sd">        service.</span>

<span class="sd">        The given values for `start`, `finish`, `achievements`,</span>
<span class="sd">        `counter`, and `exception` will be used only if the service</span>
<span class="sd">        did not specify its own values for those fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span> <span class="o">=</span> <span class="n">service_type</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">finish</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">finish</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">finish</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="TimestampData.collection"><a class="viewcode-back" href="../../core.html#core.metadata_layer.TimestampData.collection">[docs]</a>    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TimestampData.apply"><a class="viewcode-back" href="../../core.html#core.metadata_layer.TimestampData.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Not enough information to write TimestampData to the database.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">achievements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="MetaToModelUtility"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MetaToModelUtility">[docs]</a><span class="k">class</span> <span class="nc">MetaToModelUtility</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains functionality common to both CirculationData and Metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer - mirror code&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MetaToModelUtility.mirror_link"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MetaToModelUtility.mirror_link">[docs]</a>    <span class="k">def</span> <span class="nf">mirror_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_object</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a copy of the given link and make sure it gets</span>
<span class="sd">        mirrored. If it&#39;s a full-size image, create a thumbnail and</span>
<span class="sd">        mirror that too.</span>

<span class="sd">        The model_object can be either a pool or an edition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">MIRRORED</span><span class="p">:</span>
            <span class="c1"># we only host locally open-source epubs and cover images</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">:</span>
                <span class="c1"># The log message only makes sense if the resource is</span>
                <span class="c1"># hosted elsewhere.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not mirroring </span><span class="si">%s</span><span class="s2">: rel=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span>
            <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">==</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Not mirroring </span><span class="si">%s</span><span class="s2">: rights status=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">mirror_type</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">mirror_type</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mirror_type</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">mirrors</span><span class="p">:</span>
            <span class="n">mirror</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mirror</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No mirror uploader with key </span><span class="si">%s</span><span class="s2"> found&quot;</span> <span class="o">%</span> <span class="n">mirror_type</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">http_get</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">http_get</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">link_obj</span><span class="p">)</span>
        <span class="n">original_url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;About to mirror </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">original_url</span><span class="p">)</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">model_object</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">):</span>
                <span class="n">pools</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_object</span><span class="p">]</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">model_object</span><span class="o">.</span><span class="n">identifier</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">identifier</span> <span class="ow">and</span> <span class="n">identifier</span><span class="o">.</span><span class="n">primarily_identifies</span> <span class="ow">and</span> <span class="n">identifier</span><span class="o">.</span><span class="n">primarily_identifies</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">edition</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">primarily_identifies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">Edition</span><span class="p">):</span>
                <span class="n">pools</span> <span class="o">=</span> <span class="n">model_object</span><span class="o">.</span><span class="n">license_pools</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">model_object</span><span class="o">.</span><span class="n">primary_identifier</span>
                <span class="n">edition</span> <span class="o">=</span> <span class="n">model_object</span>
        <span class="k">if</span> <span class="n">edition</span> <span class="ow">and</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">identifier</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">link_obj</span><span class="o">.</span><span class="n">identifier</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="o">!=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">identifier</span><span class="p">)):</span>
            <span class="c1"># insanity found</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Tried to mirror a link with an invalid identifier </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">max_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">link_content</span><span class="p">:</span>
            <span class="c1"># We want to fetch the representation again, even if we</span>
            <span class="c1"># already have a recent usable copy. If we fetch it and it</span>
            <span class="c1"># hasn&#39;t changed, we&#39;ll keep using the one we have.</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># This will fetch a representation of the original and</span>
        <span class="c1"># store it in the database.</span>
        <span class="n">representation</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">http_get</span><span class="p">,</span>
            <span class="n">presumed_media_type</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Make sure the (potentially newly-fetched) representation is</span>
        <span class="c1"># associated with the resource.</span>
        <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">representation</span>

        <span class="c1"># If we couldn&#39;t fetch this representation, don&#39;t mirror it,</span>
        <span class="c1"># and if this was an open/protected access link, then suppress the associated</span>
        <span class="c1"># license pool until someone fixes it manually.</span>
        <span class="c1"># The license pool to suppress will be either the passed-in model_object (if it&#39;s of type pool),</span>
        <span class="c1"># or the license pool associated with the passed-in model object (if it&#39;s of type edition).</span>
        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">fetch_exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pools</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">suppressed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">license_exception</span> <span class="o">=</span> <span class="s2">&quot;Fetch exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">fetch_exception</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">license_exception</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># If we fetched the representation and it hasn&#39;t changed,</span>
        <span class="c1"># the previously mirrored version is fine. Don&#39;t mirror it</span>
        <span class="c1"># again.</span>
        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span> <span class="ow">and</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Representation has not changed, assuming mirror at </span><span class="si">%s</span><span class="s2"> is up to date.&quot;</span><span class="p">,</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_url</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">status_code</span> <span class="o">//</span> <span class="mi">100</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Representation </span><span class="si">%s</span><span class="s2"> gave </span><span class="si">%s</span><span class="s2"> status code, not mirroring.&quot;</span><span class="p">,</span>
                <span class="n">representation</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">representation</span><span class="o">.</span><span class="n">status_code</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">content_modifier</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">content_modifier</span><span class="p">(</span><span class="n">representation</span><span class="p">)</span>

        <span class="c1"># The metadata may have some idea about the media type for this</span>
        <span class="c1"># LinkObject, but it could be wrong. If the representation we</span>
        <span class="c1"># actually just saw is a mirrorable media type, that takes</span>
        <span class="c1"># precedence. If we were expecting this link to be mirrorable</span>
        <span class="c1"># but we actually saw something that&#39;s not, assume our original</span>
        <span class="c1"># metadata was right and the server told us the wrong media type.</span>
        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">and</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirrorable_media_type</span><span class="p">:</span>
            <span class="n">link</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirrorable_media_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saw unsupported media type for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Assuming original media type </span><span class="si">%s</span><span class="s2"> is correct&quot;</span><span class="p">,</span>
                              <span class="n">representation</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
                <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not mirroring </span><span class="si">%s</span><span class="s2">: unsupported media type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">representation</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Determine the best URL to use when mirroring this</span>
        <span class="c1"># representation.</span>
        <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">in</span> <span class="n">Representation</span><span class="o">.</span><span class="n">BOOK_MEDIA_TYPES</span> <span class="ow">or</span> \
                <span class="n">link</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">in</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MEDIA_TYPES</span><span class="p">:</span>
            <span class="n">url_title</span> <span class="o">=</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">extension</span><span class="p">()</span>
            <span class="n">mirror_url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">book_url</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">url_title</span><span class="p">,</span>
                <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span>
                <span class="n">open_access</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">default_filename</span><span class="p">(</span>
                <span class="n">link_obj</span><span class="p">,</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span>
            <span class="p">)</span>
            <span class="n">mirror_url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">cover_image_url</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">filename</span>
            <span class="p">)</span>

        <span class="c1"># Mirror it.</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">pools</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">collection</span> <span class="k">if</span> <span class="n">pools</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">mirror</span><span class="o">.</span><span class="n">mirror_one</span><span class="p">(</span><span class="n">representation</span><span class="p">,</span> <span class="n">mirror_to</span><span class="o">=</span><span class="n">mirror_url</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">)</span>

        <span class="c1"># If we couldn&#39;t mirror an open/protected access link representation, suppress</span>
        <span class="c1"># the license pool until someone fixes it manually.</span>
        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pools</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">suppressed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">license_exception</span> <span class="o">=</span> <span class="s2">&quot;Mirror exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_exception</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">license_exception</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">:</span>
            <span class="c1"># Create and mirror a thumbnail.</span>
            <span class="n">thumbnail_filename</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">default_filename</span><span class="p">(</span>
                <span class="n">link_obj</span><span class="p">,</span> <span class="n">Representation</span><span class="o">.</span><span class="n">PNG_MEDIA_TYPE</span>
            <span class="p">)</span>
            <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">cover_image_url</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">thumbnail_filename</span><span class="p">,</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">MAX_THUMBNAIL_HEIGHT</span>
            <span class="p">)</span>
            <span class="n">thumbnail</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
                <span class="n">max_height</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">MAX_THUMBNAIL_HEIGHT</span><span class="p">,</span>
                <span class="n">max_width</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">MAX_THUMBNAIL_WIDTH</span><span class="p">,</span>
                <span class="n">destination_url</span><span class="o">=</span><span class="n">thumbnail_url</span><span class="p">,</span>
                <span class="n">destination_media_type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">PNG_MEDIA_TYPE</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="c1"># A thumbnail was created distinct from the original</span>
                <span class="c1"># image. Mirror it as well.</span>
                <span class="n">mirror</span><span class="o">.</span><span class="n">mirror_one</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">mirror_to</span><span class="o">=</span><span class="n">thumbnail_url</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">SELF_HOSTED_BOOKS</span><span class="p">:</span>
            <span class="c1"># If we mirrored book content successfully, remove it from</span>
            <span class="c1"># the database to save space. We do keep images in case we</span>
            <span class="c1"># ever need to resize them or mirror them elsewhere.</span>
            <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirrored_at</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_exception</span><span class="p">:</span>
                <span class="n">representation</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="CirculationData"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData">[docs]</a><span class="k">class</span> <span class="nc">CirculationData</span><span class="p">(</span><span class="n">MetaToModelUtility</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information about actual copies of a book that can be delivered to</span>
<span class="sd">    patrons.</span>

<span class="sd">    As distinct from Metadata, which is a container for information</span>
<span class="sd">    about a book.</span>

<span class="sd">    Basically,</span>
<span class="sd">        Metadata : Edition :: CirculationData : Licensepool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
        <span class="s2">&quot;Abstract metadata layer - Circulation data&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data_source</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">licenses_owned</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">licenses_available</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">licenses_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">patrons_in_hold_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">default_rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">licenses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">last_checked</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param data_source: The authority providing the lending licenses.</span>
<span class="sd">            This may be a DataSource object or the name of the data source.</span>
<span class="sd">        :param primary_identifier: An Identifier or IdentifierData representing</span>
<span class="sd">            how the lending authority distinguishes this book from others.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span> <span class="o">=</span> <span class="n">data_source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">data_source</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_identifier</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span> <span class="o">=</span> <span class="n">primary_identifier</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
                <span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span> <span class="o">=</span> <span class="n">primary_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">licenses_owned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="n">licenses_available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="o">=</span> <span class="n">licenses_reserved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">patrons_in_hold_queue</span>

        <span class="c1"># If no &#39;last checked&#39; data was provided, assume the data was</span>
        <span class="c1"># just gathered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span> <span class="o">=</span> <span class="n">last_checked</span> <span class="ow">or</span> <span class="n">utc_now</span><span class="p">()</span>

        <span class="c1"># format contains pdf/epub, drm, link</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">formats</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_rights_uri</span><span class="p">(</span><span class="n">data_source_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_rights_uri</span><span class="o">=</span><span class="n">default_rights_uri</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__links</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>

        <span class="c1"># Information about individual terms for each license in a pool.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">licenses</span> <span class="o">=</span> <span class="n">licenses</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__links</span>

    <span class="nd">@links</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If got passed all links, undiscriminately, filter out to only those relevant to</span>
<span class="sd">            pools (the rights-related links).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># start by deleting any old links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__links</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg_links</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">arg_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">CIRCULATION_ALLOWED</span><span class="p">:</span>
                <span class="c1"># TODO:  what about Hyperlink.SAMPLE?</span>
                <span class="c1"># only accept the types of links relevant to pools</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

                <span class="c1"># An open-access link or open-access rights implies a FormatData object.</span>
                <span class="n">open_access_link</span> <span class="o">=</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">)</span>
                <span class="c1"># try to deduce if the link is open-access, even if it doesn&#39;t explicitly say it is</span>
                <span class="n">rights_uri</span> <span class="o">=</span>  <span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span>
                <span class="n">open_access_rights_link</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">in</span> <span class="n">Representation</span><span class="o">.</span><span class="n">BOOK_MEDIA_TYPES</span>
                    <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span>
                    <span class="ow">and</span> <span class="n">rights_uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">open_access_link</span> <span class="ow">or</span> <span class="n">open_access_rights_link</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">open_access_link</span>
                        <span class="ow">and</span> <span class="n">rights_uri</span> <span class="o">!=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">rights_uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">):</span>
                        <span class="c1"># We don&#39;t know exactly what&#39;s going on here but</span>
                        <span class="c1"># the link said it was an open-access book</span>
                        <span class="c1"># and the rights URI doesn&#39;t contradict it,</span>
                        <span class="c1"># so treat it as a generic open-access book.</span>
                        <span class="n">rights_uri</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">GENERIC_OPEN_ACCESS</span>
                    <span class="n">format_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">format</span> <span class="ow">and</span> <span class="nb">format</span><span class="o">.</span><span class="n">link</span> <span class="ow">and</span> <span class="nb">format</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">href</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">format</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">:</span>
                                <span class="nb">format</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">=</span> <span class="n">rights_uri</span>
                            <span class="n">format_found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">format_found</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">FormatData</span><span class="p">(</span>
                                <span class="n">content_type</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
                                <span class="n">drm_scheme</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">,</span>
                                <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
                                <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">description_string</span> <span class="o">=</span> <span class="s1">&#39;&lt;CirculationData primary_identifier=</span><span class="si">%(primary_identifier)r</span><span class="s1">| licenses_owned=</span><span class="si">%(licenses_owned)s</span><span class="s1">|&#39;</span>
        <span class="n">description_string</span> <span class="o">+=</span> <span class="s1">&#39; licenses_available=</span><span class="si">%(licenses_available)s</span><span class="s1">| default_rights_uri=</span><span class="si">%(default_rights_uri)s</span><span class="s1">|&#39;</span>
        <span class="n">description_string</span> <span class="o">+=</span> <span class="s1">&#39; links=</span><span class="si">%(links)r</span><span class="s1">| formats=</span><span class="si">%(formats)r</span><span class="s1">| data_source=</span><span class="si">%(data_source)s</span><span class="s1">|&gt;&#39;</span>


        <span class="n">description_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;licenses_owned&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span><span class="p">:</span>
            <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;primary_identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;primary_identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span>
        <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;licenses_available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span>
        <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;default_rights_uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span>
        <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span>
        <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span>
        <span class="n">description_data</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span>

        <span class="k">return</span> <span class="n">description_string</span> <span class="o">%</span> <span class="n">description_data</span>

<div class="viewcode-block" id="CirculationData.data_source"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData.data_source">[docs]</a>    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the DataSource associated with this circulation information.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data source </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span></div>

<div class="viewcode-block" id="CirculationData.primary_identifier"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData.primary_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">primary_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the Identifier associated with this circulation information.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span><span class="p">:</span>
                <span class="n">obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_obj</span></div>

<div class="viewcode-block" id="CirculationData.license_pool"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData.license_pool">[docs]</a>    <span class="k">def</span> <span class="nf">license_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create a LicensePool object for this CirculationData.</span>

<span class="sd">        :param collection: The LicensePool object will be associated with</span>
<span class="sd">            the given Collection.</span>

<span class="sd">        :param analytics: If the LicensePool is newly created, the event</span>
<span class="sd">            will be tracked with this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find license pool: no collection provided.&quot;</span>
            <span class="p">)</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find license pool: CirculationData has no primary identifier.&quot;</span>
            <span class="p">)</span>

        <span class="n">data_source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source_obj</span><span class="p">,</span>
            <span class="n">foreign_id_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">foreign_id</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_open_access_link</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">availability_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span>
            <span class="c1"># This is our first time seeing this LicensePool. Log its</span>
            <span class="c1"># occurrence as a separate analytics event.</span>
            <span class="k">if</span> <span class="n">analytics</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                    <span class="n">analytics</span><span class="o">.</span><span class="n">collect_event</span><span class="p">(</span>
                        <span class="n">library</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span>
                        <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_TITLE_ADD</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span><span class="p">,</span>
                        <span class="n">old_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">last_checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span>

        <span class="k">return</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_open_access_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this Circulation object have an associated open-access link?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span>
             <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span>
             <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">href</span>
             <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">rights_uri</span> <span class="o">!=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span>
            <span class="p">]</span>
        <span class="p">)</span>


<div class="viewcode-block" id="CirculationData.set_default_rights_uri"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData.set_default_rights_uri">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_rights_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default_rights_uri</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span> <span class="o">=</span> <span class="n">default_rights_uri</span>

        <span class="k">elif</span> <span class="n">data_source_name</span><span class="p">:</span>
            <span class="c1"># We didn&#39;t get rights passed in, so use the default rights for the data source if any.</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">DATA_SOURCE_DEFAULT_RIGHTS_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_source_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span> <span class="o">=</span> <span class="n">default</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span><span class="p">:</span>
            <span class="c1"># We still haven&#39;t determined rights, so it&#39;s unknown.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">UNKNOWN</span></div>

<div class="viewcode-block" id="CirculationData.apply"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CirculationData.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the title with this CirculationData&#39;s information.</span>

<span class="sd">        :param collection: A Collection representing actual copies of</span>
<span class="sd">            this title. Availability information (e.g. number of copies)</span>
<span class="sd">            will be associated with a LicensePool in this Collection. If</span>
<span class="sd">            this is not present, only delivery information (e.g. format</span>
<span class="sd">            information and open-access downloads) will be processed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Immediately raise an exception if there is information that</span>
        <span class="c1"># can only be stored in a LicensePool, but we have no</span>
        <span class="c1"># Collection to tell us which LicensePool to use. This is</span>
        <span class="c1"># indicative of an error in programming.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                               <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                               <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                               <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot store circulation information because no &quot;</span>
                <span class="s2">&quot;Collection was provided.&quot;</span>
            <span class="p">)</span>

        <span class="n">made_changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">replace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="p">()</span>

        <span class="n">analytics</span> <span class="o">=</span> <span class="n">replace</span><span class="o">.</span><span class="n">analytics</span> <span class="ow">or</span> <span class="n">Analytics</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
            <span class="n">pool</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pool</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="c1"># First, make sure all links in self.links are mirrored (if necessary)</span>
        <span class="c1"># and associated with the book&#39;s identifier.</span>

        <span class="c1"># TODO: be able to handle the case where the URL to a link changes or</span>
        <span class="c1"># a link disappears.</span>
        <span class="n">link_objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">CIRCULATION_ALLOWED</span><span class="p">:</span>
                <span class="n">link_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
                    <span class="n">media_type</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">content</span>
                <span class="p">)</span>
                <span class="n">link_objects</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">link_obj</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">CIRCULATION_ALLOWED</span><span class="p">:</span>
                <span class="n">link_obj</span> <span class="o">=</span> <span class="n">link_objects</span><span class="p">[</span><span class="n">link</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">mirrors</span><span class="p">:</span>
                    <span class="c1"># We need to mirror this resource.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mirror_link</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

        <span class="c1"># Next, make sure the DeliveryMechanisms associated</span>
        <span class="c1"># with the book reflect the formats in self.formats.</span>
        <span class="n">old_lpdms</span> <span class="o">=</span> <span class="n">new_lpdms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">old_lpdms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">)</span>

        <span class="c1"># Before setting and unsetting delivery mechanisms, which may</span>
        <span class="c1"># change the open-access status of the work, see what it the</span>
        <span class="c1"># status currently is.</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span>
        <span class="n">old_open_access</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">open_access</span> <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">and</span> <span class="nb">format</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">link</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">format</span><span class="o">.</span><span class="n">content_type</span><span class="p">:</span>
                    <span class="nb">format</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span>
                <span class="n">link_obj</span> <span class="o">=</span> <span class="n">link_objects</span><span class="p">[</span><span class="nb">format</span><span class="o">.</span><span class="n">link</span><span class="p">]</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># This can cause a non-open-access LicensePool to go open-access.</span>
            <span class="n">lpdm</span> <span class="o">=</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="nb">format</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">.</span><span class="n">drm_scheme</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">.</span><span class="n">rights_uri</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rights_uri</span><span class="p">,</span>
                <span class="n">resource</span>
            <span class="p">)</span>
            <span class="n">new_lpdms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpdm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">formats</span><span class="p">:</span>
            <span class="c1"># If any preexisting LicensePoolDeliveryMechanisms were</span>
            <span class="c1"># not mentioned in self.formats, remove the corresponding</span>
            <span class="c1"># LicensePoolDeliveryMechanisms.</span>
            <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">old_lpdms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lpdm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_lpdms</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">fulfills</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loan </span><span class="si">%i</span><span class="s2"> is associated with a format that is no longer available. Deleting its delivery mechanism.&quot;</span> <span class="o">%</span> <span class="n">loan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                        <span class="n">loan</span><span class="o">.</span><span class="n">fulfillment</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># This can cause an open-access LicensePool to go</span>
                    <span class="c1"># non-open-access.</span>
                    <span class="n">lpdm</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">new_open_access</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">open_access</span> <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">)</span>
        <span class="n">open_access_status_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_open_access</span> <span class="o">!=</span> <span class="n">new_open_access</span><span class="p">)</span>

        <span class="n">old_licenses</span> <span class="o">=</span> <span class="n">new_licenses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">old_licenses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">licenses</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="k">for</span> <span class="n">license</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses</span><span class="p">:</span>
                <span class="n">license_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">License</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">license</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">license_pool_id</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">license_obj</span><span class="o">.</span><span class="n">checkout_url</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">checkout_url</span>
                <span class="n">license_obj</span><span class="o">.</span><span class="n">status_url</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">status_url</span>
                <span class="n">license_obj</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">expires</span>
                <span class="n">license_obj</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">remaining_checkouts</span>
                <span class="n">license_obj</span><span class="o">.</span><span class="n">concurrent_checkouts</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">concurrent_checkouts</span>
                <span class="n">new_licenses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">license_obj</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">license</span> <span class="ow">in</span> <span class="n">old_licenses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">license</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_licenses</span> <span class="ow">and</span> <span class="n">license</span><span class="o">.</span><span class="n">loans</span><span class="p">:</span>
                <span class="c1"># TODO: For ODL, I don&#39;t think this will happen, but</span>
                <span class="c1"># it seems right not to delete the license if it does.</span>
                <span class="c1"># We have the status URL we can use to check on the license,</span>
                <span class="c1"># and if it is removed from the ODL feed when there are</span>
                <span class="c1"># still loans we&#39;ll need it.</span>
                <span class="c1"># But if we track individual licenses for other protocols,</span>
                <span class="c1"># we may need to handle this differently.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;License </span><span class="si">%i</span><span class="s2"> is no longer available but still has loans.&quot;</span> <span class="o">%</span> <span class="n">license</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Finally, if we have data for a specific Collection&#39;s license</span>
        <span class="c1"># for this book, find its LicensePool and update it.</span>
        <span class="n">changed_availability</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_availability_needs_update</span><span class="p">(</span><span class="n">pool</span><span class="p">):</span>
            <span class="c1"># Update availabily information. This may result in</span>
            <span class="c1"># the issuance of additional circulation events.</span>
            <span class="n">changed_availability</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">update_availability</span><span class="p">(</span>
                <span class="n">new_licenses_owned</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">,</span>
                <span class="n">new_licenses_available</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">,</span>
                <span class="n">new_licenses_reserved</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span><span class="p">,</span>
                <span class="n">new_patrons_in_hold_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span><span class="p">,</span>
                <span class="n">analytics</span><span class="o">=</span><span class="n">analytics</span><span class="p">,</span>
                <span class="n">as_of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span>
            <span class="p">)</span>

        <span class="c1"># If this is the first time we&#39;ve seen this pool, or we never</span>
        <span class="c1"># made a Work for it, make one now.</span>
        <span class="n">work_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">work_changed</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">work</span><span class="o">.</span><span class="n">set_presentation_ready</span><span class="p">()</span>
                <span class="n">work_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">made_changes</span> <span class="o">=</span> <span class="p">(</span><span class="n">made_changes</span> <span class="ow">or</span> <span class="n">changed_availability</span>
                        <span class="ow">or</span> <span class="n">open_access_status_changed</span>
                        <span class="ow">or</span> <span class="n">work_changed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pool</span><span class="p">,</span> <span class="n">made_changes</span></div>

    <span class="k">def</span> <span class="nf">_availability_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this CirculationData represent information more recent than</span>
<span class="sd">        what we have for the given LicensePool?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span><span class="p">:</span>
            <span class="c1"># Assume that our data represents the state of affairs</span>
            <span class="c1"># right now.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">last_checked</span><span class="p">:</span>
            <span class="c1"># It looks like the LicensePool has never been checked.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span> <span class="o">&gt;=</span> <span class="n">pool</span><span class="o">.</span><span class="n">last_checked</span></div>


<div class="viewcode-block" id="Metadata"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata">[docs]</a><span class="k">class</span> <span class="nc">Metadata</span><span class="p">(</span><span class="n">MetaToModelUtility</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A (potentially partial) set of metadata for a published work.&quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Abstract metadata layer&quot;</span><span class="p">)</span>

    <span class="n">BASIC_EDITION_FIELDS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;sort_title&#39;</span><span class="p">,</span> <span class="s1">&#39;subtitle&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;series&#39;</span><span class="p">,</span> <span class="s1">&#39;series_position&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;imprint&#39;</span><span class="p">,</span>
        <span class="s1">&#39;issued&#39;</span><span class="p">,</span> <span class="s1">&#39;published&#39;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data_source</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">sort_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">series_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">imprint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">issued</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">recommendations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">contributors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">measurements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">data_source_last_updated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="c1"># Note: brought back to keep callers of bibliographic extraction process_one() methods simple.</span>
            <span class="n">circulation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="c1"># data_source is where the data comes from (e.g. overdrive, metadata wrangler, admin interface),</span>
        <span class="c1"># and not necessarily where the associated Identifier&#39;s LicencePool&#39;s lending licenses are coming from.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span> <span class="o">=</span> <span class="n">data_source</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_title</span> <span class="o">=</span> <span class="n">sort_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">subtitle</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">string_to_alpha_3</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span>
        <span class="c1"># medium is book/audio/video, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_position</span> <span class="o">=</span> <span class="n">series_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imprint</span> <span class="o">=</span> <span class="n">imprint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">issued</span> <span class="o">=</span> <span class="n">issued</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">published</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span> <span class="o">=</span> <span class="n">recommendations</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span> <span class="o">=</span> <span class="n">subjects</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span> <span class="o">=</span> <span class="n">contributors</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span> <span class="o">=</span> <span class="n">measurements</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulation</span>

        <span class="c1"># renamed last_update_time to data_source_last_updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_last_updated</span> <span class="o">=</span> <span class="n">data_source_last_updated</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__links</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__links</span>

    <span class="nd">@links</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If got passed all links, undiscriminately, filter out to only those relevant to</span>
<span class="sd">            editions (the image/cover/etc links).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># start by deleting any old links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__links</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg_links</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">arg_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">METADATA_ALLOWED</span><span class="p">:</span>
                <span class="c1"># only accept the types of links relevant to editions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>


<div class="viewcode-block" id="Metadata.from_edition"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.from_edition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_edition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a basic Metadata object for the given Edition.</span>

<span class="sd">        This doesn&#39;t contain everything but it contains enough</span>
<span class="sd">        information to run guess_license_pools.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">BASIC_EDITION_FIELDS</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="n">contributors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
            <span class="n">contributor</span> <span class="o">=</span> <span class="n">ContributorData</span><span class="o">.</span><span class="n">from_contribution</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>
            <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
            <span class="c1"># This should only happen for low-quality data sources such as</span>
            <span class="c1"># the NYT best-seller API.</span>
            <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="ow">and</span> <span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="o">!=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">UNKNOWN_AUTHOR</span><span class="p">:</span>
                <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ContributorData</span><span class="p">(</span><span class="n">sort_name</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">,</span>
                                    <span class="n">display_name</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
                                    <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_data</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Metadata</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">contributors</span><span class="o">=</span><span class="n">contributors</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Metadata.normalize_contributors"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.normalize_contributors">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_contributors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure that all contributors without a .sort_name get one.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">contributor</span> <span class="ow">in</span> <span class="n">contributors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">:</span>
                <span class="n">contributor</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">metadata_client</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">primary_author</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">primary_author</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">author_contributor_tiers</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">tier</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                        <span class="n">primary_author</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">primary_author</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">primary_author</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">primary_author</span>


<div class="viewcode-block" id="Metadata.update"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update this Metadata object with values from the given Metadata</span>
<span class="sd">        object.</span>

<span class="sd">        TODO: We might want to take a policy object as an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASIC_EDITION_FIELDS</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_value</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;contributors&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;contributors&#39;</span><span class="p">)</span>
            <span class="c1"># if we already have a better value, don&#39;t override it with a &quot;missing info&quot; placeholder value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">old_value</span> <span class="ow">and</span> <span class="n">new_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">UNKNOWN_AUTHOR</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;contributors&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Metadata.calculate_permanent_work_id"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.calculate_permanent_work_id">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_permanent_work_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to calculate a permanent work ID from this metadata.</span>

<span class="sd">        This may require asking a metadata wrangler to turn a display name</span>
<span class="sd">        into a sort name--thus the `metadata_client` argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">primary_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_author</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_author</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_author</span><span class="o">.</span><span class="n">sort_name</span> <span class="ow">and</span> <span class="n">metadata_client</span><span class="p">:</span>
            <span class="n">primary_author</span><span class="o">.</span><span class="n">find_sort_name</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span>
            <span class="p">)</span>

        <span class="n">sort_author</span> <span class="o">=</span> <span class="n">primary_author</span><span class="o">.</span><span class="n">sort_name</span>
        <span class="n">pwid</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">calculate_permanent_work_id_for_title_and_author</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">sort_author</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="o">=</span><span class="n">pwid</span>
        <span class="k">return</span> <span class="n">pwid</span></div>

<div class="viewcode-block" id="Metadata.associate_with_identifiers_based_on_permanent_work_id"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.associate_with_identifiers_based_on_permanent_work_id">[docs]</a>    <span class="k">def</span> <span class="nf">associate_with_identifiers_based_on_permanent_work_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to associate this object&#39;s primary identifier with</span>
<span class="sd">        the primary identifiers of Editions in the database which share</span>
<span class="sd">        a permanent work ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">):</span>
            <span class="c1"># We don&#39;t have the information necessary to carry out this</span>
            <span class="c1"># task.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">:</span>
            <span class="c1"># We don&#39;t know the medium of this item, and we only want</span>
            <span class="c1"># to associate it with other items of the same type.</span>
            <span class="k">return</span>

        <span class="n">primary_identifier_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># Try to find the primary identifiers of other Editions with</span>
        <span class="c1"># the same permanent work ID and the same medium, representing</span>
        <span class="c1"># books already in our collection.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">primarily_identifies</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                        <span class="n">Identifier</span><span class="o">.</span><span class="n">LICENSE_PROVIDING_IDENTIFIER_TYPES</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span>
                <span class="p">)</span>
        <span class="n">identifiers_same_work_id</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">same_work_id</span> <span class="ow">in</span> <span class="n">identifiers_same_work_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">same_work_id</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span>
                <span class="ow">or</span> <span class="n">same_work_id</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Discovered that </span><span class="si">%r</span><span class="s2"> is equivalent to </span><span class="si">%r</span><span class="s2"> because of matching permanent work ID </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">same_work_id</span><span class="p">,</span> <span class="n">primary_identifier_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span>
                <span class="p">)</span>
                <span class="n">primary_identifier_obj</span><span class="o">.</span><span class="n">equivalent_to</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">same_work_id</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span></div>

<div class="viewcode-block" id="Metadata.data_source"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.data_source">[docs]</a>    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data source specified!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data source </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_obj</span></div>

<div class="viewcode-block" id="Metadata.edition"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.edition">[docs]</a>    <span class="k">def</span> <span class="nf">edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">create_if_not_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find or create the edition described by this Metadata object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find edition: metadata has no primary identifier.&quot;</span>
            <span class="p">)</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Edition</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">create_if_not_exists</span><span class="o">=</span><span class="n">create_if_not_exists</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Metadata.consolidate_identifiers"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.consolidate_identifiers">[docs]</a>    <span class="k">def</span> <span class="nf">consolidate_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">by_weight</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
            <span class="n">by_weight</span><span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">identifier</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">new_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">),</span> <span class="n">weights</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">by_weight</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">new_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">IdentifierData</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                               <span class="n">weight</span><span class="o">=</span><span class="n">median</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">new_identifiers</span></div>

<div class="viewcode-block" id="Metadata.guess_license_pools"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.guess_license_pools">[docs]</a>    <span class="k">def</span> <span class="nf">guess_license_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to find existing license pools for this Metadata.&quot;&quot;&quot;</span>
        <span class="n">potentials</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">contributor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">x</span> <span class="ow">in</span> <span class="n">contributor</span><span class="o">.</span><span class="n">roles</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">,</span>
                     <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">contributor</span><span class="o">.</span><span class="n">find_sort_name</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">)</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">base</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="o">==</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># A match based on work ID is the most reliable.</span>
            <span class="n">pwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_permanent_work_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">)</span>
            <span class="n">clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">,</span> <span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier_id</span><span class="o">==</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">)</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="o">==</span><span class="n">pwid</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">:</span>
                <span class="n">qu</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span><span class="o">==</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
                <span class="n">qu</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">author</span><span class="o">==</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># Look for the book by an unknown author (our mistake)</span>
                <span class="n">qu</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">author</span><span class="o">==</span><span class="n">Edition</span><span class="o">.</span><span class="n">UNKNOWN_AUTHOR</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># See if there is any book with this title at all.</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">potentials</span></div>

    <span class="k">def</span> <span class="nf">_run_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qu</span><span class="p">,</span> <span class="n">potentials</span><span class="p">,</span> <span class="n">confidence</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="n">pools</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">license_pools</span>
            <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lp</span> <span class="ow">and</span> <span class="n">lp</span><span class="o">.</span><span class="n">deliverable</span> <span class="ow">and</span> <span class="n">potentials</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">confidence</span><span class="p">:</span>
                    <span class="n">potentials</span><span class="p">[</span><span class="n">lp</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">success</span>

    <span class="n">REL_REQUIRES_NEW_PRESENTATION_EDITION</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">LinkRelations</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">LinkRelations</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span>
    <span class="p">]</span>
    <span class="n">REL_REQUIRES_FULL_RECALCULATION</span> <span class="o">=</span> <span class="p">[</span><span class="n">LinkRelations</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">]</span>

    <span class="c1"># TODO: We need to change all calls to apply() to use a ReplacementPolicy</span>
    <span class="c1"># instead of passing in individual `replace` arguments. Once that&#39;s done,</span>
    <span class="c1"># we can get rid of the `replace` arguments.</span>
<div class="viewcode-block" id="Metadata.apply"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">metadata_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">replace_identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">replace_subjects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">replace_contributions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">replace_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">replace_formats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">replace_rights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply this metadata to the given edition.</span>

<span class="sd">        :return: (edition, made_core_changes), where edition is the newly-updated object, and made_core_changes</span>
<span class="sd">            answers the question: were any edition core fields harmed in the making of this update?</span>
<span class="sd">            So, if title changed, return True.</span>
<span class="sd">            New: If contributors changed, this is now considered a core change,</span>
<span class="sd">            so work.simple_opds_feed refresh can be triggered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">edition</span><span class="p">)</span>

        <span class="c1"># If summary, subjects, or measurements change, then any Work</span>
        <span class="c1"># associated with this edition will need a full presentation</span>
        <span class="c1"># recalculation.</span>
        <span class="n">work_requires_full_recalculation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># If any other data changes, then any Work associated with</span>
        <span class="c1"># this edition will need to have its presentation edition</span>
        <span class="c1"># regenerated, but we can do it on the cheap.</span>
        <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">replace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
                <span class="n">identifiers</span><span class="o">=</span><span class="n">replace_identifiers</span><span class="p">,</span>
                <span class="n">subjects</span><span class="o">=</span><span class="n">replace_subjects</span><span class="p">,</span>
                <span class="n">contributions</span><span class="o">=</span><span class="n">replace_contributions</span><span class="p">,</span>
                <span class="n">links</span><span class="o">=</span><span class="n">replace_links</span><span class="p">,</span>
                <span class="n">formats</span><span class="o">=</span><span class="n">replace_formats</span><span class="p">,</span>
                <span class="n">rights</span><span class="o">=</span><span class="n">replace_rights</span><span class="p">,</span>
                <span class="n">even_if_not_apparently_updated</span><span class="o">=</span><span class="n">force</span>
            <span class="p">)</span>

        <span class="c1"># We were given an Edition, so either this metadata&#39;s</span>
        <span class="c1"># primary_identifier must be missing or it must match the</span>
        <span class="c1"># Edition&#39;s primary identifier.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Metadata&#39;s primary identifier (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">) does not match edition&#39;s primary identifier (</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                        <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Check whether we should do any work at all.</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_last_updated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">replace</span><span class="o">.</span><span class="n">even_if_not_apparently_updated</span><span class="p">:</span>
            <span class="n">coverage_record</span> <span class="o">=</span> <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coverage_record</span><span class="p">:</span>
                <span class="n">check_time</span> <span class="o">=</span> <span class="n">coverage_record</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_last_updated</span>
                <span class="k">if</span> <span class="n">check_time</span> <span class="o">&gt;=</span> <span class="n">last_time</span><span class="p">:</span>
                    <span class="c1"># The metadata has not changed since last time. Do nothing.</span>
                    <span class="k">return</span> <span class="n">edition</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">metadata_client</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_permanent_work_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">metadata_client</span><span class="p">)</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;APPLYING METADATA TO EDITION: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASIC_EDITION_FIELDS</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;permanent_work_id&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">old_edition_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="n">new_metadata_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_metadata_value</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_metadata_value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_metadata_value</span> <span class="o">!=</span> <span class="n">old_edition_value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">new_metadata_value</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">NO_NUMBER</span><span class="p">]:</span>
                    <span class="n">new_metadata_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">new_metadata_value</span><span class="p">)</span>
                <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Create equivalencies between all given identifiers and</span>
        <span class="c1"># the edition&#39;s primary identifier.</span>
        <span class="n">contributors_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_contributions</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span>
                                  <span class="n">metadata_client</span><span class="p">,</span> <span class="n">replace</span><span class="o">.</span><span class="n">contributions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contributors_changed</span><span class="p">:</span>
            <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO: remove equivalencies when replace.identifiers is True.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">identifier_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier_data</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">identifier_data</span><span class="o">.</span><span class="n">identifier</span><span class="o">==</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span> <span class="ow">and</span>
                    <span class="n">identifier_data</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                    <span class="c1"># These are the same identifier.</span>
                    <span class="k">continue</span>
                <span class="n">new_identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_data</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">identifier_data</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
                <span class="n">identifier</span><span class="o">.</span><span class="n">equivalent_to</span><span class="p">(</span>
                    <span class="n">data_source</span><span class="p">,</span> <span class="n">new_identifier</span><span class="p">,</span> <span class="n">identifier_data</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="n">new_subjects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="n">new_subjects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="c1"># Remove any old Subjects from this data source, unless they</span>
            <span class="c1"># are also in the list of new subjects.</span>
            <span class="n">surviving_classifications</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="n">classification</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">subject</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">classification</span><span class="o">.</span><span class="n">weight</span>

            <span class="k">for</span> <span class="n">classification</span> <span class="ow">in</span> <span class="n">identifier</span><span class="o">.</span><span class="n">classifications</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">classification</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">data_source</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">_key</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_subjects</span><span class="p">:</span>
                        <span class="c1"># The data source has stopped claiming that</span>
                        <span class="c1"># this classification should exist.</span>
                        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
                        <span class="n">work_requires_full_recalculation</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># The data source maintains that this</span>
                        <span class="c1"># classification is a good idea. We don&#39;t have</span>
                        <span class="c1"># to do anything.</span>
                        <span class="k">del</span> <span class="n">new_subjects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="n">surviving_classifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This classification comes from some other data</span>
                    <span class="c1"># source.  Don&#39;t mess with it.</span>
                    <span class="n">surviving_classifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">classifications</span> <span class="o">=</span> <span class="n">surviving_classifications</span>

        <span class="c1"># Apply all new subjects to the identifier.</span>
        <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_subjects</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">subject</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">subject</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="n">work_requires_full_recalculation</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Associate all links with the primary identifier.</span>
        <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">links</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surviving_hyperlinks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">hyperlink</span> <span class="ow">in</span> <span class="n">identifier</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hyperlink</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">data_source</span><span class="p">:</span>
                    <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hyperlink</span><span class="p">)</span>
                    <span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">surviving_hyperlinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyperlink</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
                <span class="n">identifier</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">surviving_hyperlinks</span>

        <span class="n">link_objects</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">METADATA_ALLOWED</span><span class="p">:</span>
                <span class="n">original_resource</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="p">:</span>
                    <span class="n">rights_status</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">)</span>
                    <span class="n">original_resource</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                        <span class="n">_db</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">href</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_resource</span><span class="o">.</span><span class="n">data_source</span><span class="p">:</span>
                        <span class="n">original_resource</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
                    <span class="n">original_resource</span><span class="o">.</span><span class="n">rights_status</span> <span class="o">=</span> <span class="n">rights_status</span>
                    <span class="n">original_resource</span><span class="o">.</span><span class="n">rights_explanation</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">rights_explanation</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="n">original_resource</span><span class="o">.</span><span class="n">set_fetched_content</span><span class="p">(</span>
                            <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">guessed_media_type</span><span class="p">,</span>
                            <span class="n">link</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="n">link_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
                    <span class="n">media_type</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">guessed_media_type</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">rights_status_uri</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">,</span>
                    <span class="n">rights_explanation</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">rights_explanation</span><span class="p">,</span>
                    <span class="n">original_resource</span><span class="o">=</span><span class="n">original_resource</span><span class="p">,</span>
                    <span class="n">transformation_settings</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">transformation_settings</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REL_REQUIRES_NEW_PRESENTATION_EDITION</span><span class="p">:</span>
                    <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REL_REQUIRES_FULL_RECALCULATION</span><span class="p">:</span>
                    <span class="n">work_requires_full_recalculation</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">link_objects</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">link_obj</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">:</span>
                    <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span>
                    <span class="n">thumbnail_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                        <span class="n">rel</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">href</span><span class="p">,</span>
                        <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
                        <span class="n">media_type</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">guessed_media_type</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">content</span>
                    <span class="p">)</span>
                    <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">thumbnail_obj</span><span class="o">.</span><span class="n">resource</span>
                        <span class="ow">and</span> <span class="n">thumbnail_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="p">):</span>
                        <span class="n">thumbnail_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">thumbnail_of</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Thumbnail link </span><span class="si">%r</span><span class="s2"> cannot be marked as a thumbnail of </span><span class="si">%r</span><span class="s2"> because it has no Representation, probably due to a missing media type.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">link</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Thumbnail link </span><span class="si">%r</span><span class="s2"> does not have the thumbnail link relation! Not acceptable as a thumbnail of </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">link</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Apply all measurements to the primary identifier</span>
        <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">:</span>
            <span class="n">work_requires_full_recalculation</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">add_measurement</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">measurement</span><span class="o">.</span><span class="n">quantity_measured</span><span class="p">,</span>
                <span class="n">measurement</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">measurement</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                <span class="n">measurement</span><span class="o">.</span><span class="n">taken_at</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">:</span>
            <span class="c1"># This may be a situation like the NYT best-seller list where</span>
            <span class="c1"># we know the display name of the author but weren&#39;t able</span>
            <span class="c1"># to normalize that name.</span>
            <span class="n">primary_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_author</span>
            <span class="k">if</span> <span class="n">primary_author</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;In the absence of Contributor objects, setting Edition author name to </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">primary_author</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span>
                    <span class="n">primary_author</span><span class="o">.</span><span class="n">display_name</span>
                <span class="p">)</span>
                <span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="o">=</span> <span class="n">primary_author</span><span class="o">.</span><span class="n">sort_name</span>
                <span class="n">edition</span><span class="o">.</span><span class="n">display_author</span> <span class="o">=</span> <span class="n">primary_author</span><span class="o">.</span><span class="n">display_name</span>
                <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The Metadata object may include a CirculationData object which</span>
        <span class="c1"># contains information about availability such as open-access</span>
        <span class="c1"># links. Make sure</span>
        <span class="c1"># that that Collection has a LicensePool for this book and that</span>
        <span class="c1"># its information is up-to-date.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

        <span class="c1"># obtains a presentation_edition for the title, which will later be used to get a mirror link.</span>
        <span class="n">has_image</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_obj</span> <span class="o">=</span> <span class="n">link_objects</span><span class="p">[</span><span class="n">link</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span> <span class="ow">and</span> <span class="n">has_image</span><span class="p">:</span>
                <span class="c1"># This is a thumbnail but we also have a full-sized image link,</span>
                <span class="c1"># so we don&#39;t need to separately mirror the thumbnail.</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">mirrors</span><span class="p">:</span>
                <span class="c1"># We need to mirror this resource. If it&#39;s an image, a</span>
                <span class="c1"># thumbnail may be provided as a side effect.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mirror_link</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">:</span>
                <span class="c1"># We don&#39;t need to mirror this image, but we do need</span>
                <span class="c1"># to make sure that its thumbnail exists locally and</span>
                <span class="c1"># is associated with the original image.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_thumbnail</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">)</span>

        <span class="c1"># Make sure the work we just did shows up. This needs to happen after mirroring</span>
        <span class="c1"># so mirror urls are available.</span>
        <span class="n">made_changes</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span>
            <span class="n">policy</span><span class="o">=</span><span class="n">replace</span><span class="o">.</span><span class="n">presentation_calculation_policy</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">made_changes</span><span class="p">:</span>
            <span class="n">work_requires_new_presentation_edition</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The metadata wrangler doesn&#39;t need information from these data sources.</span>
        <span class="c1"># We don&#39;t need to send it information it originally provided, and</span>
        <span class="c1"># Overdrive makes metadata accessible to everyone without buying licenses</span>
        <span class="c1"># for the book, so the metadata wrangler can obtain it directly from</span>
        <span class="c1"># Overdrive.</span>
        <span class="c1"># TODO: Remove Bibliotheca and Axis 360 from this list.</span>
        <span class="n">METADATA_UPLOAD_BLACKLIST</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">METADATA_WRANGLER</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">OVERDRIVE</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">work_requires_new_presentation_edition</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">data_source</span><span class="o">.</span><span class="n">integration_client</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">METADATA_UPLOAD_BLACKLIST</span><span class="p">):</span>
            <span class="c1"># Create a transient failure CoverageRecord for this edition</span>
            <span class="c1"># so it will be processed by the MetadataUploadCoverageProvider.</span>
            <span class="n">internal_processing</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">INTERNAL_PROCESSING</span><span class="p">)</span>

            <span class="c1"># If there&#39;s already a CoverageRecord, don&#39;t change it to transient failure.</span>
            <span class="c1"># TODO: Once the metadata wrangler can handle it, we&#39;d like to re-sync the</span>
            <span class="c1"># metadata every time there&#39;s a change. For now,</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">internal_processing</span><span class="p">,</span>
                                       <span class="n">operation</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">METADATA_UPLOAD_OPERATION</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="p">:</span>
                <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">internal_processing</span><span class="p">,</span>
                                       <span class="n">operation</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">METADATA_UPLOAD_OPERATION</span><span class="p">,</span>
                                       <span class="n">status</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">TRANSIENT_FAILURE</span><span class="p">)</span>

        <span class="c1"># Update the coverage record for this edition and data</span>
        <span class="c1"># source. We omit the collection information, even if we know</span>
        <span class="c1"># which collection this is, because we only changed metadata.</span>
        <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="n">edition</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source_last_updated</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">work_requires_full_recalculation</span> <span class="ow">or</span> <span class="n">work_requires_new_presentation_edition</span><span class="p">:</span>
            <span class="c1"># If there is a Work associated with the Edition&#39;s primary</span>
            <span class="c1"># identifier, mark it for recalculation.</span>

            <span class="c1"># Any LicensePool will do here, since all LicensePools for</span>
            <span class="c1"># a given Identifier have the same Work.</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span>
                <span class="n">on_multiple</span><span class="o">=</span><span class="s1">&#39;interchangeable&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
                <span class="n">work</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span>
                <span class="k">if</span> <span class="n">work_requires_full_recalculation</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">needs_full_presentation_recalculation</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">needs_new_presentation_edition</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">edition</span><span class="p">,</span> <span class="n">work_requires_new_presentation_edition</span></div>


<div class="viewcode-block" id="Metadata.make_thumbnail"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.make_thumbnail">[docs]</a>    <span class="k">def</span> <span class="nf">make_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure a Hyperlink representing an image is connected</span>
<span class="sd">        to its thumbnail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">thumbnail</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thumbnail</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">thumbnail</span><span class="o">.</span><span class="n">href</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span><span class="p">:</span>
            <span class="c1"># The image serves as its own thumbnail. This is a</span>
            <span class="c1"># hacky way to represent this in the database.</span>
            <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="p">:</span>
                <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">MAX_THUMBNAIL_HEIGHT</span>
            <span class="k">return</span> <span class="n">link_obj</span>

        <span class="c1"># The thumbnail and image are different. Make sure there&#39;s a</span>
        <span class="c1"># separate link to the thumbnail.</span>
        <span class="n">thumbnail_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">href</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">thumbnail</span><span class="o">.</span><span class="n">content</span>
        <span class="p">)</span>
        <span class="c1"># And make sure the thumbnail knows it&#39;s a thumbnail of the main</span>
        <span class="c1"># image.</span>
        <span class="k">if</span> <span class="n">thumbnail_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="p">:</span>
            <span class="n">thumbnail_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">thumbnail_of</span> <span class="o">=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span>
        <span class="k">return</span> <span class="n">thumbnail_obj</span></div>


<div class="viewcode-block" id="Metadata.update_contributions"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.update_contributions">[docs]</a>    <span class="k">def</span> <span class="nf">update_contributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">metadata_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">contributors_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">old_contributors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_contributors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span><span class="p">:</span>
            <span class="c1"># we&#39;ve chosen to append new contributors, which exist</span>
            <span class="c1"># this means the edition&#39;s contributor list will, indeed, change</span>
            <span class="n">contributors_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">replace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span><span class="p">:</span>
            <span class="c1"># Remove any old Contributions from this data source --</span>
            <span class="c1"># we&#39;re about to add a new set</span>
            <span class="n">surviving_contributions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
                <span class="n">old_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>
            <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span> <span class="o">=</span> <span class="n">surviving_contributions</span>

        <span class="k">for</span> <span class="n">contributor_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributors</span><span class="p">:</span>
            <span class="n">contributor_data</span><span class="o">.</span><span class="n">find_sort_name</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">metadata_client</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">contributor_data</span><span class="o">.</span><span class="n">sort_name</span>
                <span class="ow">or</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">lc</span>
                <span class="ow">or</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">viaf</span><span class="p">):</span>
                <span class="n">contributor</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">contributor_data</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span>
                    <span class="n">roles</span><span class="o">=</span><span class="n">contributor_data</span><span class="o">.</span><span class="n">roles</span><span class="p">,</span>
                    <span class="n">lc</span><span class="o">=</span><span class="n">contributor_data</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span>
                    <span class="n">viaf</span><span class="o">=</span><span class="n">contributor_data</span><span class="o">.</span><span class="n">viaf</span>
                <span class="p">)</span>
                <span class="n">new_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">display_name</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">biography</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">biography</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">biography</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">aliases</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">lc</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">lc</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">viaf</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">viaf</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">viaf</span>
                <span class="k">if</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">wikipedia_name</span><span class="p">:</span>
                    <span class="n">contributor</span><span class="o">.</span><span class="n">wikipedia_name</span> <span class="o">=</span> <span class="n">contributor_data</span><span class="o">.</span><span class="n">wikipedia_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Not registering </span><span class="si">%s</span><span class="s2"> because no sort name, LC, or VIAF&quot;</span><span class="p">,</span>
                    <span class="n">contributor_data</span><span class="o">.</span><span class="n">display_name</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">old_contributors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_contributors</span><span class="p">):</span>
            <span class="n">contributors_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">contributors_changed</span></div>


<div class="viewcode-block" id="Metadata.filter_recommendations"><a class="viewcode-back" href="../../core.html#core.metadata_layer.Metadata.filter_recommendations">[docs]</a>    <span class="k">def</span> <span class="nf">filter_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filters out recommended identifiers that don&#39;t exist in the db.</span>
<span class="sd">        Any IdentifierData objects will be replaced with Identifiers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">by_type</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
            <span class="n">by_type</span><span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">identifiers</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">by_type</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">existing_identifiers</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span>\
                <span class="nb">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="nb">type</span><span class="p">)</span><span class="o">.</span>\
                <span class="nb">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifiers</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span> <span class="o">+=</span> <span class="n">existing_identifiers</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">identifier_data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CSVFormatError"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CSVFormatError">[docs]</a><span class="k">class</span> <span class="nc">CSVFormatError</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="CSVMetadataImporter"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CSVMetadataImporter">[docs]</a><span class="k">class</span> <span class="nc">CSVMetadataImporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Turn a CSV file into a list of Metadata objects.&quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CSV metadata importer&quot;</span><span class="p">)</span>

    <span class="n">IDENTIFIER_PRECEDENCE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">,</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">OVERDRIVE_ID</span><span class="p">,</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">THREEM_ID</span><span class="p">,</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span>
    <span class="p">]</span>

    <span class="n">DEFAULT_IDENTIFIER_FIELD_NAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">OVERDRIVE_ID</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;overdrive id&quot;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">THREEM_ID</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;3m id&quot;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;axis 360 id&quot;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
        <span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;isbn&quot;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># When classifications are imported from a CSV file, we treat </span>
    <span class="c1"># them as though they came from a trusted distributor.</span>
    <span class="n">DEFAULT_SUBJECT_FIELD_NAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">TAG</span><span class="p">,</span> <span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span><span class="p">),</span>
        <span class="s1">&#39;age&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">AGE_RANGE</span><span class="p">,</span> <span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span><span class="p">),</span>
        <span class="s1">&#39;audience&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">FREEFORM_AUDIENCE</span><span class="p">,</span>
                      <span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data_source_name</span><span class="p">,</span>
            <span class="n">title_field</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="n">language_field</span><span class="o">=</span><span class="s1">&#39;language&#39;</span><span class="p">,</span>
            <span class="n">default_language</span><span class="o">=</span><span class="s1">&#39;eng&#39;</span><span class="p">,</span>
            <span class="n">medium_field</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">,</span>
            <span class="n">default_medium</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">,</span>
            <span class="n">series_field</span><span class="o">=</span><span class="s1">&#39;series&#39;</span><span class="p">,</span>
            <span class="n">publisher_field</span><span class="o">=</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span>
            <span class="n">imprint_field</span><span class="o">=</span><span class="s1">&#39;imprint&#39;</span><span class="p">,</span>
            <span class="n">issued_field</span><span class="o">=</span><span class="s1">&#39;issued&#39;</span><span class="p">,</span>
            <span class="n">published_field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published&#39;</span><span class="p">,</span> <span class="s1">&#39;publication year&#39;</span><span class="p">],</span>
            <span class="n">identifier_fields</span><span class="o">=</span><span class="n">DEFAULT_IDENTIFIER_FIELD_NAMES</span><span class="p">,</span>
            <span class="n">subject_fields</span><span class="o">=</span><span class="n">DEFAULT_SUBJECT_FIELD_NAMES</span><span class="p">,</span>
            <span class="n">sort_author_field</span><span class="o">=</span><span class="s1">&#39;file author as&#39;</span><span class="p">,</span>
            <span class="n">display_author_field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;display author as&#39;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">data_source_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title_field</span> <span class="o">=</span> <span class="n">title_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_field</span><span class="o">=</span><span class="n">language_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_language</span><span class="o">=</span><span class="n">default_language</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_field</span> <span class="o">=</span> <span class="n">medium_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_medium</span> <span class="o">=</span> <span class="n">default_medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_field</span> <span class="o">=</span> <span class="n">series_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_field</span> <span class="o">=</span> <span class="n">publisher_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imprint_field</span> <span class="o">=</span> <span class="n">imprint_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">issued_field</span> <span class="o">=</span> <span class="n">issued_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">published_field</span> <span class="o">=</span> <span class="n">published_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_fields</span> <span class="o">=</span> <span class="n">identifier_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject_fields</span> <span class="o">=</span> <span class="n">subject_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_author_field</span> <span class="o">=</span> <span class="n">sort_author_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_author_field</span> <span class="o">=</span> <span class="n">display_author_field</span>

<div class="viewcode-block" id="CSVMetadataImporter.to_metadata"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CSVMetadataImporter.to_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">to_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictreader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn the CSV file in `dictreader` into a sequence of Metadata.</span>

<span class="sd">        :yield: A sequence of Metadata objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">dictreader</span><span class="o">.</span><span class="n">fieldnames</span>

        <span class="c1"># Make sure this CSV file has some way of identifying books.</span>
        <span class="n">found_identifier_field</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">possibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">found_identifier_field</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_identifier_field</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CSVFormatError</span><span class="p">(</span>
                <span class="s2">&quot;Could not find a primary identifier field. Possibilities: </span><span class="si">%r</span><span class="s2">. Actualities: </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">possibilities</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictreader</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_to_metadata</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="CSVMetadataImporter.row_to_metadata"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CSVMetadataImporter.row_to_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">row_to_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title_field</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_language</span><span class="p">)</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_medium</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">medium</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">medium_to_additional_type</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Ignored unrecognized medium </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">medium</span><span class="p">)</span>
            <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_field</span><span class="p">)</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher_field</span><span class="p">)</span>
        <span class="n">imprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imprint_field</span><span class="p">)</span>
        <span class="n">issued</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">issued_field</span><span class="p">)</span>
        <span class="n">published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">published_field</span><span class="p">)</span>

        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># TODO: This is annoying and could use some work.</span>
        <span class="k">for</span> <span class="n">identifier_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_PRECEDENCE</span><span class="p">:</span>
            <span class="n">correct_type</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">target_type</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">field_name</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">identifier_type</span><span class="p">:</span>
                    <span class="n">correct_type</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_type</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
                        <span class="n">identifier_type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
                    <span class="p">)</span>
                    <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_identifier</span><span class="p">:</span>
                        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">identifier</span>

        <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">(</span><span class="n">subject_type</span><span class="p">,</span> <span class="n">weight</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SubjectData</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">subject_type</span><span class="p">,</span>
                        <span class="n">identifier</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">contributors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sort_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_author_field</span><span class="p">)</span>
        <span class="n">display_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_author_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_author</span> <span class="ow">or</span> <span class="n">display_author</span><span class="p">:</span>
            <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ContributorData</span><span class="p">(</span>
                    <span class="n">sort_name</span><span class="o">=</span><span class="n">sort_author</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_author</span><span class="p">,</span>
                    <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">imprint</span><span class="o">=</span><span class="n">imprint</span><span class="p">,</span>
            <span class="n">issued</span><span class="o">=</span><span class="n">issued</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="n">published</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
            <span class="n">contributors</span><span class="o">=</span><span class="n">contributors</span>
        <span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">csv_row</span> <span class="o">=</span> <span class="n">row</span>
        <span class="k">return</span> <span class="n">metadata</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identifier_field_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All potential field names that would identify an identifier.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">identifier_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_PRECEDENCE</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">identifier_type</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_names</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">field_name</span>

<div class="viewcode-block" id="CSVMetadataImporter.list_field"><a class="viewcode-back" href="../../core.html#core.metadata_layer.CSVMetadataImporter.list_field">[docs]</a>    <span class="k">def</span> <span class="nf">list_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a string into a list by splitting on commas.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a value from one of the given fields and ensure it comes in as</span>
<span class="sd">        Unicode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a value from the given field and ensure it comes in as</span>
<span class="sd">        Unicode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_date_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to parse a field as a date.&quot;&quot;&quot;</span>
        <span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">to_utc</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not parse date &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="MARCExtractor"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MARCExtractor">[docs]</a><span class="k">class</span> <span class="nc">MARCExtractor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Transform a MARC file into a list of Metadata objects.</span>

<span class="sd">    This is not totally general, but it&#39;s a good start.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Common things found in a MARC record after the name of the author</span>
    <span class="c1"># which we sould like to remove.</span>
    <span class="n">END_OF_AUTHOR_NAME_RES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;,\s+[0-9]+-&quot;</span><span class="p">),</span> <span class="c1"># Birth year</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;,\s+active &quot;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;,\s+graf,&quot;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;,\s+author.&quot;</span><span class="p">),</span>
    <span class="p">]</span>

<div class="viewcode-block" id="MARCExtractor.name_cleanup"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MARCExtractor.name_cleanup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">name_cleanup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Turn &#39;Dante Alighieri,   1265-1321, author.&#39;</span>
        <span class="c1"># into &#39;Dante Alighieri&#39;.</span>
        <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">END_OF_AUTHOR_NAME_RES</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
                <span class="k">break</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_tidy</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span></div>

<div class="viewcode-block" id="MARCExtractor.parse_year"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MARCExtractor.parse_year">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_year</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a publication year that may not be in the right format.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y.&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MARCExtractor.parse"><a class="viewcode-back" href="../../core.html#core.metadata_layer.MARCExtractor.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_medium_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">MARCReader</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">metadata_records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39; /&#39;</span><span class="p">):</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39; /&#39;</span><span class="p">)]</span>
            <span class="n">issued_year</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_year</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">pubyear</span><span class="p">())</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">publisher</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">publisher</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">notes</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">summary_link</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span>
                    <span class="n">media_type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">TEXT_PLAIN</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary_link</span><span class="p">)</span>

            <span class="n">isbn</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;020&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">isbn</span>
            <span class="p">)</span>

            <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubjectData</span><span class="p">(</span>
                <span class="n">Classifier</span><span class="o">.</span><span class="n">FAST</span><span class="p">,</span>
                <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">subjects</span><span class="p">()]</span>

            <span class="n">author</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">author</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">author</span><span class="p">:</span>
                <span class="n">author</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name_cleanup</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="n">author_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">author</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">author_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Anonymous&#39;</span><span class="p">]</span>
            <span class="n">contributors</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ContributorData</span><span class="p">(</span>
                    <span class="n">sort_name</span><span class="o">=</span><span class="n">author</span><span class="p">,</span>
                    <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">author_names</span>
            <span class="p">]</span>

            <span class="n">metadata_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Metadata</span><span class="p">(</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">data_source_name</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="s1">&#39;eng&#39;</span><span class="p">,</span>
                <span class="n">medium</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">issued</span><span class="o">=</span><span class="n">issued_year</span><span class="p">,</span>
                <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
                <span class="n">subjects</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
                <span class="n">contributors</span><span class="o">=</span><span class="n">contributors</span><span class="p">,</span>
                <span class="n">links</span><span class="o">=</span><span class="n">links</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">metadata_records</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>