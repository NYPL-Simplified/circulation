
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.model.collection &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.model.collection</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1"># Collection, CollectionIdentifier, CollectionMissing</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">exists</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Table</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">UniqueConstraint</span><span class="p">,</span>
    <span class="n">Boolean</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">backref</span><span class="p">,</span>
    <span class="n">contains_eager</span><span class="p">,</span>
    <span class="n">joinedload</span><span class="p">,</span>
    <span class="n">mapper</span><span class="p">,</span>
    <span class="n">relationship</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="n">NoResultFound</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.configuration</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">BaseConfigurationStorage</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">EditionConstants</span>
<span class="kn">from</span> <span class="nn">.coverage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CoverageRecord</span><span class="p">,</span>
    <span class="n">WorkCoverageRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.datasource</span> <span class="kn">import</span> <span class="n">DataSource</span>
<span class="kn">from</span> <span class="nn">.edition</span> <span class="kn">import</span> <span class="n">Edition</span>
<span class="kn">from</span> <span class="nn">.hasfulltablecache</span> <span class="kn">import</span> <span class="n">HasFullTableCache</span>
<span class="kn">from</span> <span class="nn">.identifier</span> <span class="kn">import</span> <span class="n">Identifier</span>
<span class="kn">from</span> <span class="nn">.integrationclient</span> <span class="kn">import</span> <span class="n">IntegrationClient</span>
<span class="kn">from</span> <span class="nn">.library</span> <span class="kn">import</span> <span class="n">Library</span>
<span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.work</span> <span class="kn">import</span> <span class="n">Work</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">create</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..util.string_helpers</span> <span class="kn">import</span> <span class="n">base64</span>

<div class="viewcode-block" id="Collection"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection">[docs]</a><span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">HasFullTableCache</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A Collection is a set of LicensePools obtained through some mechanism.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;collections&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">DATA_SOURCE_NAME_SETTING</span> <span class="o">=</span> <span class="s1">&#39;data_source&#39;</span>

    <span class="c1"># For use in forms that edit Collections.</span>
    <span class="n">EXTERNAL_ACCOUNT_ID_KEY</span> <span class="o">=</span> <span class="s1">&#39;external_account_id&#39;</span>

    <span class="c1"># How does the provider of this collection distinguish it from</span>
    <span class="c1"># other collections it provides? On the other side this is usually</span>
    <span class="c1"># called a &quot;library ID&quot;.</span>
    <span class="n">external_account_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># How do we connect to the provider of this collection? Any url,</span>
    <span class="c1"># authentication information, or additional configuration goes</span>
    <span class="c1"># into the external integration, as does the &#39;protocol&#39;, which</span>
    <span class="c1"># designates the integration technique we will use to actually get</span>
    <span class="c1"># the metadata and licenses. Each Collection has a distinct</span>
    <span class="c1"># ExternalIntegration.</span>
    <span class="n">external_integration_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;externalintegrations.id&#39;</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A Collection may specialize some other Collection. For instance,</span>
    <span class="c1"># an Overdrive Advantage collection is a specialization of an</span>
    <span class="c1"># ordinary Overdrive collection. It uses the same access key and</span>
    <span class="c1"># secret as the Overdrive collection, but it has a distinct</span>
    <span class="c1"># external_account_id.</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;collections.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># When deleting a collection, this flag is set to True so that the deletion</span>
    <span class="c1"># script can take care of deleting it in the background. This is</span>
    <span class="c1"># useful for deleting large collections which can timeout when deleting.</span>
    <span class="n">marked_for_deletion</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># A collection may have many child collections. For example,</span>
    <span class="c1"># An Overdrive collection may have many children corresponding</span>
    <span class="c1"># to Overdrive Advantage collections.</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Collection&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">remote_side</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">]),</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># A Collection can provide books to many Libraries.</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Library&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections_libraries</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collections&quot;</span>
    <span class="p">)</span>

    <span class="c1"># A Collection can include many LicensePools.</span>
    <span class="n">licensepools</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LicensePool&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span>
    <span class="p">)</span>

    <span class="c1"># A Collection can have many associated Credentials.</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Credential&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">)</span>

    <span class="c1"># A Collection can be monitored by many Monitors, each of which</span>
    <span class="c1"># will have its own Timestamp.</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collection&quot;</span><span class="p">)</span>

    <span class="n">catalog</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Identifier&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections_identifiers</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collections&quot;</span>
    <span class="p">)</span>

    <span class="c1"># A Collection can be associated with multiple CoverageRecords</span>
    <span class="c1"># for Identifiers in its catalog.</span>
    <span class="n">coverage_records</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CoverageRecord&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
    <span class="p">)</span>

    <span class="c1"># A collection may be associated with one or more custom lists.</span>
    <span class="c1"># When a new license pool is added to the collection, it will</span>
    <span class="c1"># also be added to the list. Admins can remove items from the</span>
    <span class="c1"># the list and they won&#39;t be added back, so the list doesn&#39;t</span>
    <span class="c1"># necessarily match the collection.</span>
    <span class="n">customlists</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CustomList&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections_customlists</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;collections&quot;</span>
    <span class="p">)</span>

    <span class="n">_cache</span> <span class="o">=</span> <span class="n">HasFullTableCache</span><span class="o">.</span><span class="n">RESET</span>
    <span class="n">_id_cache</span> <span class="o">=</span> <span class="n">HasFullTableCache</span><span class="o">.</span><span class="n">RESET</span>

    <span class="c1"># Most data sources offer different catalogs to different</span>
    <span class="c1"># libraries.  Data sources in this list offer the same catalog to</span>
    <span class="c1"># every library.</span>
    <span class="n">GLOBAL_COLLECTION_DATA_SOURCES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DataSource</span><span class="o">.</span><span class="n">ENKI</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Collection &quot;</span><span class="si">%s</span><span class="s1">&quot;/&quot;</span><span class="si">%s</span><span class="s1">&quot; ID=</span><span class="si">%d</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Collection.cache_key"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.cache_key">[docs]</a>    <span class="k">def</span> <span class="nf">cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span></div>

<div class="viewcode-block" id="Collection.by_name_and_protocol"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.by_name_and_protocol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_name_and_protocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create a Collection with the given name and the given</span>
<span class="sd">        protocol.</span>

<span class="sd">        This method uses the full-table cache if possible.</span>

<span class="sd">        :return: A 2-tuple (collection, is_new)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">lookup_hook</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_by_name_and_protocol</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">by_cache_key</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">lookup_hook</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_by_name_and_protocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create a Collection with the given name and the given</span>
<span class="sd">        protocol.</span>

<span class="sd">        We can&#39;t use get_one_or_create because the protocol is kept in</span>
<span class="sd">        a separate database object, (an ExternalIntegration).</span>

<span class="sd">        :return: A 2-tuple (collection, is_new)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">cache_key</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">by_protocol</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">NoResultFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Make a new Collection.</span>
            <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">:</span>
                <span class="c1"># The collection already exists, it just uses a different</span>
                <span class="c1"># protocol than the one we asked about.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Collection &quot;</span><span class="si">%s</span><span class="s1">&quot; does not use protocol &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span>
            <span class="p">)</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span>
        <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span>

<div class="viewcode-block" id="Collection.by_protocol"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.by_protocol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_protocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query collections that get their licenses through the given protocol.</span>

<span class="sd">        Collections marked for deletion are not included.</span>

<span class="sd">        :param protocol: Protocol to use. If this is None, all</span>
<span class="sd">            Collections will be returned except those marked for deletion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protocol</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="p">,</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">Collection</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">goal</span><span class="o">==</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_GOAL</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">protocol</span><span class="o">==</span><span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">marked_for_deletion</span><span class="o">==</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">qu</span></div>

<div class="viewcode-block" id="Collection.by_datasource"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.by_datasource">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_datasource</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query collections that are associated with the given DataSource.</span>

<span class="sd">        Collections marked for deletion are not included.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">):</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">name</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">external_integration_id</span><span class="o">==</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">key</span><span class="o">==</span><span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">marked_for_deletion</span><span class="o">==</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What protocol do we need to use to get licenses for this</span>
<span class="sd">        collection?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span>

    <span class="nd">@protocol</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_protocol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the protocol in use by this Collection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">new_protocol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Proposed new protocol (</span><span class="si">%s</span><span class="s2">) contradicts parent collection&#39;s protocol (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">new_protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">protocol</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">new_protocol</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">new_protocol</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">primary_identifier_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Identify if should try to use another identifier than &lt;id&gt; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">primary_identifier_source</span>

    <span class="nd">@primary_identifier_source</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">primary_identifier_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_primary_identifier_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Modify the primary identifier source in use by this Collection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">primary_identifier_source</span> <span class="o">=</span> <span class="n">new_primary_identifier_source</span>

    <span class="c1"># For collections that can control the duration of the loans they</span>
    <span class="c1"># create, the durations are stored in these settings and new loans are</span>
    <span class="c1"># expected to be created using these settings. For collections</span>
    <span class="c1"># where loan duration is negotiated out-of-bounds, all loans are</span>
    <span class="c1"># _assumed_ to have these durations unless we hear otherwise from</span>
    <span class="c1"># the server.</span>
    <span class="n">AUDIOBOOK_LOAN_DURATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;audio_loan_duration&#39;</span>
    <span class="n">EBOOK_LOAN_DURATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;ebook_loan_duration&#39;</span>
    <span class="n">STANDARD_DEFAULT_LOAN_PERIOD</span> <span class="o">=</span> <span class="mi">21</span>

<div class="viewcode-block" id="Collection.default_loan_period"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.default_loan_period">[docs]</a>    <span class="k">def</span> <span class="nf">default_loan_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">EditionConstants</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Until we hear otherwise from the license provider, we assume</span>
<span class="sd">        that someone who borrows a non-open-access item from this</span>
<span class="sd">        collection has it for this number of days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_loan_period_setting</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">medium</span><span class="p">)</span><span class="o">.</span><span class="n">int_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_DEFAULT_LOAN_PERIOD</span></div>

<div class="viewcode-block" id="Collection.default_loan_period_setting"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.default_loan_period_setting">[docs]</a>    <span class="k">def</span> <span class="nf">default_loan_period_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">EditionConstants</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Until we hear otherwise from the license provider, we assume</span>
<span class="sd">        that someone who borrows a non-open-access item from this</span>
<span class="sd">        collection has it for this number of days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">medium</span> <span class="o">==</span> <span class="n">EditionConstants</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUDIOBOOK_LOAN_DURATION_KEY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EBOOK_LOAN_DURATION_KEY</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">Library</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">IntegrationClient</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

    <span class="n">DEFAULT_RESERVATION_PERIOD_KEY</span> <span class="o">=</span> <span class="s1">&#39;default_reservation_period&#39;</span>
    <span class="n">STANDARD_DEFAULT_RESERVATION_PERIOD</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">default_reservation_period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Until we hear otherwise from the license provider, we assume</span>
<span class="sd">        that someone who puts an item on hold has this many days to</span>
<span class="sd">        check it out before it goes to the next person in line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_RESERVATION_PERIOD_KEY</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">int_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_DEFAULT_RESERVATION_PERIOD</span>
        <span class="p">)</span>

    <span class="nd">@default_reservation_period</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_reservation_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_RESERVATION_PERIOD_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>

    <span class="c1"># When you import an OPDS feed, you may know the intended audience of the works (e.g. children or researchers),</span>
    <span class="c1"># even though the OPDS feed may not contain that information.</span>
    <span class="c1"># It should be possible to configure a collection with a default audience,</span>
    <span class="c1"># so that books imported from the OPDS feed end up with the right audience.</span>
    <span class="n">DEFAULT_AUDIENCE_KEY</span> <span class="o">=</span> <span class="s1">&#39;default_audience&#39;</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">default_audience</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default audience set up for this collection.</span>

<span class="sd">        :return: Default audience</span>
<span class="sd">        :rtype: Optional[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_AUDIENCE_KEY</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">setting</span><span class="o">.</span><span class="n">value_or_default</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@default_audience</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_audience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the default audience for this collection.</span>

<span class="sd">        :param new_value: New default audience</span>
<span class="sd">        :type new_value: Optional[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_AUDIENCE_KEY</span><span class="p">)</span>

        <span class="n">setting</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.create_external_integration"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.create_external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">create_external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an ExternalIntegration for this Collection.</span>

<span class="sd">        To be used immediately after creating a new Collection,</span>
<span class="sd">        e.g. in by_name_and_protocol, from_metadata_identifier, and</span>
<span class="sd">        various test methods that create mock Collections.</span>

<span class="sd">        If an external integration already exists, return it instead</span>
<span class="sd">        of creating another one.</span>

<span class="sd">        :param protocol: The protocol known to be in use when getting</span>
<span class="sd">            licenses for this collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_GOAL</span>
        <span class="n">external_integration</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Located ExternalIntegration, but its protocol (</span><span class="si">%s</span><span class="s2">) does not match desired protocol (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">external_integration</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">protocol</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span> <span class="o">=</span> <span class="n">external_integration</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">external_integration</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the external integration for this Collection, assuming</span>
<span class="sd">        it already exists.</span>

<span class="sd">        This is generally a safe assumption since by_name_and_protocol and</span>
<span class="sd">        from_metadata_identifier both create ExternalIntegrations for the</span>
<span class="sd">        Collections they create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t enforce this on the database level because it is</span>
        <span class="c1"># legitimate for a newly created Collection to have no</span>
        <span class="c1"># ExternalIntegration. But by the time it&#39;s being used for real,</span>
        <span class="c1"># it needs to have one.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No known external integration for collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_integration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unique_account_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identifier that uniquely represents this Collection of works&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_COLLECTION_DATA_SOURCES</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
            <span class="c1"># Every top-level collection from this data source has the</span>
            <span class="c1"># same catalog. Treat them all as one collection named</span>
            <span class="c1"># after the data source.</span>
            <span class="n">unique_account_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique_account_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_account_id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_account_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unique account identifier not set&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">unique_account_id</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">unique_account_id</span>
        <span class="k">return</span> <span class="n">unique_account_id</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the data source associated with this Collection.</span>

<span class="sd">        Bibliographic metadata obtained through the collection</span>
<span class="sd">        protocol is recorded as coming from this data source. A</span>
<span class="sd">        LicensePool inserted into this collection will be associated</span>
<span class="sd">        with this data source, unless its bibliographic metadata</span>
<span class="sd">        indicates some other data source.</span>

<span class="sd">        For most Collections, the integration protocol sets the data</span>
<span class="sd">        source.  For collections that use the OPDS import protocol,</span>
<span class="sd">        the data source is a Collection-specific setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">DATA_SOURCE_FOR_LICENSE_PROTOCOL</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span>
            <span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_source</span>

    <span class="nd">@data_source</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">):</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Only set a DataSource for Collections that don&#39;t have an</span>
        <span class="c1"># implied source.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">DATA_SOURCE_FOR_LICENSE_PROTOCOL</span><span class="p">:</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
            <span class="n">setting</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">parent</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">collection</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identifier based on collection details that uniquely represents</span>
<span class="sd">        this Collection on the metadata wrangler. This identifier is</span>
<span class="sd">        composed of the Collection protocol and account identifier.</span>

<span class="sd">        A circulation manager provides a Collection&#39;s metadata</span>
<span class="sd">        identifier as part of collection registration. The metadata</span>
<span class="sd">        wrangler creates a corresponding Collection on its side,</span>
<span class="sd">        *named after* the metadata identifier -- regardless of the name</span>
<span class="sd">        of that collection on the circulation manager side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_account_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span><span class="p">:</span>
            <span class="c1"># Remove ending / from OPDS url that could duplicate the collection</span>
            <span class="c1"># on the Metadata Wrangler.</span>
            <span class="k">while</span> <span class="n">account_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">account_id</span> <span class="o">=</span> <span class="n">account_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">encode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span>
        <span class="n">account_id</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>

        <span class="n">metadata_identifier</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">account_id</span>
        <span class="k">return</span> <span class="n">encode</span><span class="p">(</span><span class="n">metadata_identifier</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.disassociate_library"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.disassociate_library">[docs]</a>    <span class="k">def</span> <span class="nf">disassociate_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disassociate a Library from this Collection and delete any relevant</span>
<span class="sd">        ConfigurationSettings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">library</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="c1"># No-op.</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">libraries</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">ConfigurationSetting</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">library</span><span class="o">==</span><span class="n">library</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">external_integration</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span>
        <span class="p">)</span>
        <span class="n">qu</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_decode_metadata_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">metadata_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invert the metadata_identifier property.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No metadata identifier provided.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">decode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">metadata_identifier</span><span class="p">)</span>
            <span class="n">encoded_details</span>  <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">[</span><span class="n">protocol</span><span class="p">,</span> <span class="n">account_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">decode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">encoded_details</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Metadata identifier &#39;</span><span class="si">%s</span><span class="s2">&#39; is invalid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metadata_identifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">account_id</span>

<div class="viewcode-block" id="Collection.from_metadata_identifier"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.from_metadata_identifier">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_metadata_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">metadata_identifier</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds or creates a Collection on the metadata wrangler, based</span>
<span class="sd">        on its unique metadata_identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decode the metadata identifier into a protocol and an</span>
        <span class="c1"># account ID. If the metadata identifier is invalid, this</span>
        <span class="c1"># will raise an exception.</span>
        <span class="n">protocol</span><span class="p">,</span> <span class="n">account_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_decode_metadata_identifier</span><span class="p">(</span><span class="n">metadata_identifier</span><span class="p">)</span>

        <span class="c1"># Now that we know the metadata identifier is valid, try to</span>
        <span class="c1"># look up a collection named after it.</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">metadata_identifier</span><span class="p">)</span>
        <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="c1"># Create a collection named after the metadata</span>
            <span class="c1"># identifier. Give it an ExternalIntegration with the</span>
            <span class="c1"># corresponding protocol, and set its data source and</span>
            <span class="c1"># external_account_id.</span>
            <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">metadata_identifier</span>
            <span class="p">)</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span><span class="p">:</span>
            <span class="c1"># For OPDS Import collections only, we store the URL to</span>
            <span class="c1"># the OPDS feed (the &quot;account ID&quot;) and the data source.</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span> <span class="o">=</span> <span class="n">account_id</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">):</span>
                <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>

        <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pools_with_no_delivery_mechanisms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all LicensePools in this Collection that have no delivery</span>
<span class="sd">        mechanisms whatsoever.</span>

<span class="sd">        :return: A query object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">with_no_delivery_mechanisms</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">collection</span><span class="o">==</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.explain"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_secrets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a series of human-readable strings to explain a collection&#39;s</span>
<span class="sd">        settings.</span>

<span class="sd">        :param include_secrets: For security reasons,</span>
<span class="sd">           sensitive settings such as passwords are not displayed by default.</span>

<span class="sd">        :return: A list of explanatory strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Name: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Parent: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span>
        <span class="k">if</span> <span class="n">integration</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Protocol: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">integration</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Used by library: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_account_id</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;External account ID: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_account_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">include_secrets</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setting</span><span class="o">.</span><span class="n">is_secret</span><span class="p">)</span> <span class="ow">and</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Setting &quot;</span><span class="si">%s</span><span class="s1">&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="Collection.catalog_identifier"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.catalog_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">catalog_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts an identifier into a catalog&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_identifiers</span><span class="p">([</span><span class="n">identifier</span><span class="p">])</span></div>

<div class="viewcode-block" id="Collection.catalog_identifiers"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.catalog_identifiers">[docs]</a>    <span class="k">def</span> <span class="nf">catalog_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts identifiers into the catalog&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="c1"># Nothing to do.</span>
            <span class="k">return</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">already_in_catalog</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">CollectionIdentifier</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CollectionIdentifier</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
             <span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">new_catalog_entries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">collection_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">identifier_id</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_in_catalog</span>
        <span class="p">]</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">bulk_insert_mappings</span><span class="p">(</span><span class="n">CollectionIdentifier</span><span class="p">,</span> <span class="n">new_catalog_entries</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Collection.unresolved_catalog"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.unresolved_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">unresolved_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a query with all identifiers in a Collection&#39;s catalog that</span>
<span class="sd">        have unsuccessfully attempted resolution. This method is used on the</span>
<span class="sd">        metadata wrangler.</span>

<span class="sd">        :return: a sqlalchemy.Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coverage_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="n">is_not_resolved</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span>
            <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">operation</span><span class="o">==</span><span class="n">operation</span><span class="p">,</span>
            <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="n">coverage_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">status</span><span class="o">!=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">work</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">is_not_resolved</span><span class="p">,</span> <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="kc">None</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="Collection.licensepools_with_works_updated_since"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.licensepools_with_works_updated_since">[docs]</a>    <span class="k">def</span> <span class="nf">licensepools_with_works_updated_since</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds all LicensePools in a collection&#39;s catalog whose Works&#39; OPDS</span>
<span class="sd">        entries have been updated since the timestamp. Used by the</span>
<span class="sd">        metadata wrangler.</span>

<span class="sd">        :param _db: A database connection,</span>
<span class="sd">        :param timestamp: A datetime.timestamp object</span>

<span class="sd">        :return: a Query that yields LicensePools. The Work and</span>
<span class="sd">           Identifier associated with each LicensePool have been</span>
<span class="sd">           pre-loaded, giving the caller all the information</span>
<span class="sd">           necessary to create full OPDS entries for the works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opds_operation</span> <span class="o">=</span> <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">GENERATE_OPDS_OPERATION</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">LicensePool</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">work</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">CollectionIdentifier</span><span class="p">,</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">CollectionIdentifier</span><span class="o">.</span><span class="n">identifier_id</span>
        <span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">operation</span><span class="o">==</span><span class="n">opds_operation</span><span class="p">,</span>
            <span class="n">CollectionIdentifier</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">contains_eager</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">work</span><span class="p">),</span>
            <span class="n">contains_eager</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">timestamp</span>
            <span class="p">)</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div>

<div class="viewcode-block" id="Collection.isbns_updated_since"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.isbns_updated_since">[docs]</a>    <span class="k">def</span> <span class="nf">isbns_updated_since</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds all ISBNs in a collection&#39;s catalog that have been updated</span>
<span class="sd">           since the timestamp but don&#39;t have a Work to show for it. Used in</span>
<span class="sd">           the metadata wrangler.</span>

<span class="sd">           :return: a Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isbns</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;latest&#39;</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">status</span><span class="o">==</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">enable_eagerloads</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">isbns</span> <span class="o">=</span> <span class="n">isbns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">isbns</span></div>

<div class="viewcode-block" id="Collection.restrict_to_ready_deliverable_works"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.restrict_to_ready_deliverable_works">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">restrict_to_ready_deliverable_works</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">collection_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_suppressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">allow_holds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restrict a query to show only presentation-ready works present in</span>
<span class="sd">        an appropriate collection which the default client can</span>
<span class="sd">        fulfill.</span>

<span class="sd">        Note that this assumes the query has an active join against</span>
<span class="sd">        LicensePool and Edition.</span>

<span class="sd">        :param query: The query to restrict.</span>

<span class="sd">        :param show_suppressed: Include titles that have nothing but</span>
<span class="sd">            suppressed LicensePools.</span>

<span class="sd">        :param collection_ids: Only include titles in the given</span>
<span class="sd">            collections.</span>

<span class="sd">        :param allow_holds: If false, pools with no available copies</span>
<span class="sd">            will be hidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Only find presentation-ready works.</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">presentation_ready</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Only find books that have some kind of DeliveryMechanism.</span>
        <span class="n">LPDM</span> <span class="o">=</span> <span class="n">LicensePoolDeliveryMechanism</span>
        <span class="n">exists_clause</span> <span class="o">=</span> <span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="n">LPDM</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">==</span><span class="n">LPDM</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">exists_clause</span><span class="p">)</span>

        <span class="c1"># Some sources of audiobooks may be excluded because the</span>
        <span class="c1"># server can&#39;t fulfill them or the expected client can&#39;t play</span>
        <span class="c1"># them.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">session</span>
        <span class="n">excluded</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">excluded_audio_data_sources</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">excluded</span><span class="p">:</span>
            <span class="n">audio_excluded_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">excluded</span>
            <span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">medium</span> <span class="o">!=</span> <span class="n">EditionConstants</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span><span class="p">,</span>
                    <span class="o">~</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">audio_excluded_ids</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># Only find books with unsuppressed LicensePools.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_suppressed</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">suppressed</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Only find books with available licenses or books from self-hosted collections using MirrorUploader</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Only find books in an appropriate collection.</span>
        <span class="k">if</span> <span class="n">collection_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">collection_ids</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># If we don&#39;t allow holds, hide any books with no available copies.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_holds</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="Collection.delete"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.Collection.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a collection.</span>

<span class="sd">        Collections can have hundreds of thousands of</span>
<span class="sd">        LicensePools. This deletes a collection gradually in a way</span>
<span class="sd">        that can be confined to the background and survive interruption.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">marked_for_deletion</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Cannot delete </span><span class="si">%s</span><span class="s2">: it is not marked for deletion.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Disassociate all libraries from this collection.</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disassociate_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># Delete all the license pools. This should be the only part</span>
        <span class="c1"># of the application where LicensePools are permanently</span>
        <span class="c1"># deleted.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pool</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">licensepools</span><span class="p">):</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">work</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
                <span class="n">work</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">search_index</span><span class="p">)</span>

        <span class="c1"># Delete the ExternalIntegration associated with this</span>
        <span class="c1"># Collection, assuming it wasn&#39;t deleted already.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="p">:</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration</span><span class="p">)</span>

        <span class="c1"># Now delete the Collection itself.</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>


<span class="n">collections_libraries</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;collections_libraries&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
     <span class="n">Column</span><span class="p">(</span>
         <span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;collections.id&#39;</span><span class="p">),</span>
         <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
     <span class="p">),</span>
     <span class="n">Column</span><span class="p">(</span>
         <span class="s1">&#39;library_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;libraries.id&#39;</span><span class="p">),</span>
         <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
     <span class="p">),</span>
     <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;library_id&#39;</span><span class="p">),</span>
 <span class="p">)</span>


<span class="n">collections_identifiers</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;collections_identifiers&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;collections.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;identifier_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;identifiers.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier_id&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Create an ORM model for the collections_identifiers join table</span>
<span class="c1"># so it can be used in a bulk_insert_mappings call.</span>
<div class="viewcode-block" id="CollectionIdentifier"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.CollectionIdentifier">[docs]</a><span class="k">class</span> <span class="nc">CollectionIdentifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="CollectionMissing"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.CollectionMissing">[docs]</a><span class="k">class</span> <span class="nc">CollectionMissing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An operation was attempted that can only happen within the context</span>
<span class="sd">    of a Collection, but there was no Collection available.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

<span class="n">mapper</span><span class="p">(</span>
    <span class="n">CollectionIdentifier</span><span class="p">,</span> <span class="n">collections_identifiers</span><span class="p">,</span>
    <span class="n">primary_key</span><span class="o">=</span><span class="p">(</span>
        <span class="n">collections_identifiers</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">collection_id</span><span class="p">,</span>
        <span class="n">collections_identifiers</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">identifier_id</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">collections_customlists</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;collections_customlists&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;collections.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;customlist_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;customlists.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;collection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customlist_id&#39;</span><span class="p">),</span>
<span class="p">)</span>

<div class="viewcode-block" id="HasExternalIntegrationPerCollection"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.HasExternalIntegrationPerCollection">[docs]</a><span class="k">class</span> <span class="nc">HasExternalIntegrationPerCollection</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interface allowing to get access to an external integration&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HasExternalIntegrationPerCollection.collection_external_integration"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.HasExternalIntegrationPerCollection.collection_external_integration">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">collection_external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an external integration associated with the collection</span>

<span class="sd">        :param collection: Collection</span>
<span class="sd">        :type collection: core.model.Collection</span>

<span class="sd">        :return: External integration associated with the collection</span>
<span class="sd">        :rtype: core.model.configuration.ExternalIntegration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CollectionConfigurationStorage"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.CollectionConfigurationStorage">[docs]</a><span class="k">class</span> <span class="nc">CollectionConfigurationStorage</span><span class="p">(</span><span class="n">BaseConfigurationStorage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serializes and deserializes values as library&#39;s configuration settings&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_integration_association</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a new instance of ConfigurationStorage class</span>

<span class="sd">        :param external_integration_association: Association with an external integtation</span>
<span class="sd">        :type external_integration_association: HasExternalIntegrationPerCollection</span>

<span class="sd">        :param collection: Collection object</span>
<span class="sd">        :type collection: Collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integration_owner</span> <span class="o">=</span> <span class="n">external_integration_association</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>

<div class="viewcode-block" id="CollectionConfigurationStorage.save"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.CollectionConfigurationStorage.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">setting_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the value as as a new configuration setting</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :param setting_name: Name of the library&#39;s configuration setting</span>
<span class="sd">        :type setting_name: string</span>

<span class="sd">        :param value: Value to be saved</span>
<span class="sd">        :type value: Any</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span><span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integration_owner</span><span class="o">.</span><span class="n">collection_external_integration</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_externalintegration</span><span class="p">(</span>
            <span class="n">setting_name</span><span class="p">,</span>
            <span class="n">integration</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="CollectionConfigurationStorage.load"><a class="viewcode-back" href="../../../core.model.html#core.model.collection.CollectionConfigurationStorage.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">setting_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads and returns the library&#39;s configuration setting</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :param setting_name: Name of the library&#39;s configuration setting</span>
<span class="sd">        :type setting_name: string</span>

<span class="sd">        :return: Any</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span><span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integration_owner</span><span class="o">.</span><span class="n">collection_external_integration</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_externalintegration</span><span class="p">(</span>
            <span class="n">setting_name</span><span class="p">,</span>
            <span class="n">integration</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="n">value</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../model.html">core.model</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>