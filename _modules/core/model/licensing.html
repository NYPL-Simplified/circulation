
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.model.licensing &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.model.licensing</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1"># PolicyException LicensePool, LicensePoolDeliveryMechanism, DeliveryMechanism,</span>
<span class="c1"># RightsStatus</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">Index</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">UniqueConstraint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.functions</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">.circulationevent</span> <span class="kn">import</span> <span class="n">CirculationEvent</span>
<span class="kn">from</span> <span class="nn">.complaint</span> <span class="kn">import</span> <span class="n">Complaint</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">DataSourceConstants</span><span class="p">,</span> <span class="n">EditionConstants</span><span class="p">,</span> <span class="n">LinkRelations</span><span class="p">,</span> <span class="n">MediaTypes</span>
<span class="kn">from</span> <span class="nn">.hasfulltablecache</span> <span class="kn">import</span> <span class="n">HasFullTableCache</span>
<span class="kn">from</span> <span class="nn">.patron</span> <span class="kn">import</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">Patron</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="n">flush</span><span class="p">,</span> <span class="n">get_one</span><span class="p">,</span> <span class="n">get_one_or_create</span>
<span class="kn">from</span> <span class="nn">..util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="PolicyException"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.PolicyException">[docs]</a><span class="k">class</span> <span class="nc">PolicyException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="License"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.License">[docs]</a><span class="k">class</span> <span class="nc">License</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A single license for a work from a given source.</span>

<span class="sd">    TODO: This currently assumes all licenses for a pool have the same</span>
<span class="sd">    delivery mechanisms, which may not always be true.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;licenses&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">identifier</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">checkout_url</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">status_url</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">expires</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">concurrent_checkouts</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="c1"># A License belongs to one LicensePool.</span>
    <span class="n">license_pool_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;licensepools.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One License can have many Loans.</span>
    <span class="n">loans</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Loan&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;license&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;license_pool_id&#39;</span><span class="p">),</span>
    <span class="p">)</span>

<div class="viewcode-block" id="License.loan_to"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.License.loan_to">[docs]</a>    <span class="k">def</span> <span class="nf">loan_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_client</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">loan</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">loan_to</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">loan</span><span class="p">,</span> <span class="n">is_new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_perpetual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_time_limited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_loan_limited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="LicensePool"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool">[docs]</a><span class="k">class</span> <span class="nc">LicensePool</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pool of undifferentiated licenses for a work from a given source.&quot;&quot;&quot;</span>

    <span class="n">UNLIMITED_ACCESS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;licensepools&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A LicensePool may be associated with a Work. (If it&#39;s not, no one</span>
    <span class="c1"># can check it out.)</span>
    <span class="n">work_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;works.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Each LicensePool is associated with one DataSource and one</span>
    <span class="c1"># Identifier.</span>
    <span class="n">data_source_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;datasources.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">identifier_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;identifiers.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Each LicensePool belongs to one Collection.</span>
    <span class="n">collection_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;collections.id&#39;</span><span class="p">),</span>
                           <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Each LicensePool has an Edition which contains the metadata used</span>
    <span class="c1"># to describe this book.</span>
    <span class="n">presentation_edition_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;editions.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If the source provides information about individual licenses, the</span>
    <span class="c1"># LicensePool may have many Licenses.</span>
    <span class="n">licenses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;license_pool&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># One LicensePool can have many Loans.</span>
    <span class="n">loans</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Loan&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;license_pool&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># One LicensePool can have many Holds.</span>
    <span class="n">holds</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Hold&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;license_pool&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># One LicensePool can have many CirculationEvents</span>
    <span class="n">circulation_events</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CirculationEvent&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;license_pool&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># One LicensePool can be associated with many Complaints.</span>
    <span class="n">complaints</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Complaint&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;license_pool&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># The date this LicensePool was first created in our db</span>
    <span class="c1"># (the date we first discovered that ​we had that book in ​our collection).</span>
    <span class="n">availability_time</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A LicensePool may be superceded by some other LicensePool</span>
    <span class="c1"># associated with the same Work. This may happen if it&#39;s an</span>
    <span class="c1"># open-access LicensePool and a better-quality version of the same</span>
    <span class="c1"># book is available from another Open-Access source.</span>
    <span class="n">superceded</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># A LicensePool that seemingly looks fine may be manually suppressed</span>
    <span class="c1"># to be temporarily or permanently removed from the collection.</span>
    <span class="n">suppressed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A textual description of a problem with this license pool</span>
    <span class="c1"># that caused us to suppress it.</span>
    <span class="n">license_exception</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">open_access</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">last_checked</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">licenses_available</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">licenses_reserved</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Set to True for collections imported using MirrorUploaded</span>
    <span class="n">self_hosted</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This lets us cache the work of figuring out the best open access</span>
    <span class="c1"># link for this LicensePool.</span>
    <span class="n">_open_access_download_url</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;open_access_download_url&quot;</span><span class="p">)</span>

    <span class="c1"># A Collection can not have more than one LicensePool for a given</span>
    <span class="c1"># Identifier from a given DataSource.</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;identifier_id&#39;</span><span class="p">,</span> <span class="s1">&#39;data_source_id&#39;</span><span class="p">,</span> <span class="s1">&#39;collection_id&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">delivery_mechanisms</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LicensePoolDeliveryMechanism&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(LicensePool.data_source_id==LicensePoolDeliveryMechanism.data_source_id, LicensePool.identifier_id==LicensePoolDeliveryMechanism.identifier_id)&quot;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="p">(</span><span class="n">data_source_id</span><span class="p">,</span> <span class="n">identifier_id</span><span class="p">),</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;unknown identifier&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;LicensePool #</span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">: owned=</span><span class="si">%d</span><span class="s2"> available=</span><span class="si">%d</span><span class="s2"> reserved=</span><span class="si">%d</span><span class="s2"> holds=</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span>
        <span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">unlimited_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a Boolean value indicating whether this LicensePool allows unlimited access.</span>
<span class="sd">        For example, in the case of LCP books without explicit licensing information</span>

<span class="sd">        :return: Boolean value indicating whether this LicensePool allows unlimited access</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNLIMITED_ACCESS</span>

    <span class="nd">@unlimited_access</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">unlimited_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets value of unlimited_access property.</span>
<span class="sd">        If you set it to False, license_owned and license_available will be reset to 0</span>

<span class="sd">        :param value: Boolean value indicating whether this LicensePool allows unlimited access</span>
<span class="sd">        :type value: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNLIMITED_ACCESS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNLIMITED_ACCESS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="LicensePool.for_foreign_id"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.for_foreign_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">for_foreign_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">foreign_id_type</span><span class="p">,</span> <span class="n">foreign_id</span><span class="p">,</span>
                       <span class="n">rights_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create a LicensePool for the given foreign ID.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.collection</span> <span class="kn">import</span> <span class="n">CollectionMissing</span>
        <span class="kn">from</span> <span class="nn">.datasource</span> <span class="kn">import</span> <span class="n">DataSource</span>
        <span class="kn">from</span> <span class="nn">.identifier</span> <span class="kn">import</span> <span class="n">Identifier</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CollectionMissing</span><span class="p">()</span>

        <span class="c1"># Get the DataSource.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>

        <span class="c1"># The type of the foreign ID must be the primary identifier</span>
        <span class="c1"># type for the data source.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data_source</span><span class="o">.</span><span class="n">primary_identifier_type</span> <span class="ow">and</span>
            <span class="n">foreign_id_type</span> <span class="o">!=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">primary_identifier_type</span>
            <span class="ow">and</span> <span class="n">foreign_id_type</span> <span class="o">!=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">DEPRECATED_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_source</span><span class="o">.</span><span class="n">primary_identifier_type</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;License pools for data source &#39;</span><span class="si">%s</span><span class="s2">&#39; are keyed to &quot;</span>
                <span class="s2">&quot;identifier type &#39;</span><span class="si">%s</span><span class="s2">&#39; (not &#39;</span><span class="si">%s</span><span class="s2">&#39;, which was provided)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_source</span><span class="o">.</span><span class="n">primary_identifier_type</span><span class="p">,</span>
                    <span class="n">foreign_id_type</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Get the Identifier.</span>
        <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">foreign_id_type</span><span class="p">,</span> <span class="n">foreign_id</span>
            <span class="p">)</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                  <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rights_status</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;rights_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rights_status</span>

        <span class="c1"># Get the LicensePool that corresponds to the</span>
        <span class="c1"># DataSource/Identifier/Collection.</span>
        <span class="k">if</span> <span class="n">autocreate</span><span class="p">:</span>
            <span class="n">license_pool</span><span class="p">,</span> <span class="n">was_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">license_pool</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">was_new</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">was_new</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">availability_time</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">availability_time</span> <span class="o">=</span> <span class="n">now</span>

        <span class="k">if</span> <span class="n">was_new</span><span class="p">:</span>
            <span class="c1"># Set the LicensePool&#39;s initial values to indicate</span>
            <span class="c1"># that we don&#39;t actually know how many copies we own.</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">was_new</span></div>

<div class="viewcode-block" id="LicensePool.with_no_work"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.with_no_work">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_no_work</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find LicensePools that have no corresponding Work.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.work</span> <span class="kn">import</span> <span class="n">Work</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

<div class="viewcode-block" id="LicensePool.with_no_delivery_mechanisms"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.with_no_delivery_mechanisms">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_no_delivery_mechanisms</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find LicensePools that have no delivery mechanisms.</span>

<span class="sd">        :return: A query object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="kc">None</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deliverable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This LicensePool can actually be delivered to patrons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_access</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">default_client_can_fulfill</span>
                <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LicensePool.with_complaint"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.with_complaint">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_complaint</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return query for LicensePools that have at least one Complaint.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.collection</span> <span class="kn">import</span> <span class="n">Collection</span>
        <span class="kn">from</span> <span class="nn">.library</span> <span class="kn">import</span> <span class="n">Library</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">subquery</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;complaint_count&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">Collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">Library</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">library</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">complaints</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">resolved</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Complaint</span><span class="o">.</span><span class="n">resolved</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">resolved</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Complaint</span><span class="o">.</span><span class="n">resolved</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">join</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">order_by</span><span class="p">(</span><span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">complaint_count</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span>\
            <span class="n">add_columns</span><span class="p">(</span><span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">complaint_count</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">open_access_source_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What priority does this LicensePool&#39;s DataSource have in</span>
<span class="sd">        our list of open-access content sources?</span>
<span class="sd">        e.g. GITenberg books are prefered over Gutenberg books,</span>
<span class="sd">        because there&#39;s a defined process for fixing errors and they</span>
<span class="sd">        are more likely to have good cover art.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">OPEN_ACCESS_SOURCE_PRIORITY</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># The source of this download is not mentioned in our</span>
            <span class="c1"># priority list. Treat it as the lowest priority.</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">priority</span>

<div class="viewcode-block" id="LicensePool.better_open_access_pool_than"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.better_open_access_pool_than">[docs]</a>    <span class="k">def</span> <span class="nf">better_open_access_pool_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">champion</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Is this open-access pool generally known for better-quality</span>
<span class="sd">        download files than the passed-in pool?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A license pool with no identifier shouldn&#39;t happen, but it</span>
        <span class="c1"># definitely shouldn&#39;t be considered.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># A non-open-access license pool is not eligible for consideration.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># At this point we have a LicensePool that is at least</span>
        <span class="c1"># better than nothing.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">champion</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># A suppressed license pool should never be used unless there is</span>
        <span class="c1"># no alternative.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># If the previous champion is suppressed but we have a license pool</span>
        <span class="c1"># that&#39;s not, it&#39;s definitely better.</span>
        <span class="k">if</span> <span class="n">champion</span><span class="o">.</span><span class="n">suppressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">challenger_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_open_access_link</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">challenger_resource</span><span class="p">:</span>
            <span class="c1"># This LicensePool is supposedly open-access but we don&#39;t</span>
            <span class="c1"># actually know where the book is. It will be chosen only</span>
            <span class="c1"># if there is no alternative.</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">champion_priority</span> <span class="o">=</span> <span class="n">champion</span><span class="o">.</span><span class="n">open_access_source_priority</span>
        <span class="n">challenger_priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access_source_priority</span>

        <span class="k">if</span> <span class="n">challenger_priority</span> <span class="o">&gt;</span> <span class="n">champion_priority</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">challenger_priority</span> <span class="o">&lt;</span> <span class="n">champion_priority</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span>
            <span class="ow">and</span> <span class="n">champion</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
            <span class="c1"># These two LicensePools are both from Gutenberg, and</span>
            <span class="c1"># normally this wouldn&#39;t matter, but higher Gutenberg</span>
            <span class="c1"># numbers beat lower Gutenberg numbers.</span>
            <span class="n">champion_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">champion</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">challenger_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">challenger_id</span> <span class="o">&gt;</span> <span class="n">champion_id</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Gutenberg </span><span class="si">%d</span><span class="s2"> beats Gutenberg </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">challenger_id</span><span class="p">,</span> <span class="n">champion_id</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LicensePool.set_open_access_status"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.set_open_access_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_open_access_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set .open_access based on whether there is currently</span>
<span class="sd">        an open-access LicensePoolDeliveryMechanism for this LicensePool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span>
        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dm</span><span class="o">.</span><span class="n">is_open_access</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LicensePool.set_presentation_edition"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.set_presentation_edition">[docs]</a>    <span class="k">def</span> <span class="nf">set_presentation_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equivalent_editions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create or update the presentation Edition for this LicensePool.</span>
<span class="sd">        The presentation Edition is made of metadata from all Editions</span>
<span class="sd">        associated with the LicensePool&#39;s identifier.</span>
<span class="sd">        :param equivalent_editions: An optional list of Edition objects</span>
<span class="sd">        that don&#39;t share this LicensePool&#39;s identifier but are associated</span>
<span class="sd">        with its equivalent identifiers in some way. This option is used</span>
<span class="sd">        to create Works on the Metadata Wrangler.</span>
<span class="sd">        :return: A boolean explaining whether any of the presentation</span>
<span class="sd">        information associated with this LicensePool actually changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.edition</span> <span class="kn">import</span> <span class="n">Edition</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">old_presentation_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">editions</span> <span class="o">=</span> <span class="n">equivalent_editions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">editions</span><span class="p">:</span>
            <span class="n">editions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">primarily_identifies</span>
        <span class="n">all_editions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">sort_by_priority</span><span class="p">(</span><span class="n">editions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>

        <span class="c1"># Note: We can do a cleaner solution, if we refactor to not use metadata&#39;s</span>
        <span class="c1"># methods to update editions.  For now, we&#39;re choosing to go with the below approach.</span>
        <span class="kn">from</span> <span class="nn">..metadata_layer</span> <span class="kn">import</span> <span class="n">IdentifierData</span><span class="p">,</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">ReplacementPolicy</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_editions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># There&#39;s only one edition associated with this</span>
            <span class="c1"># LicensePool. Use it as the presentation edition rather</span>
            <span class="c1"># than creating an identical composite.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="o">=</span> <span class="n">all_editions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edition_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span><span class="n">data_source</span><span class="o">=</span><span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">PRESENTATION_EDITION</span><span class="p">,</span> <span class="n">primary_identifier</span><span class="o">=</span><span class="n">edition_identifier</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">all_editions</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">PRESENTATION_EDITION</span><span class="p">):</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Metadata</span><span class="o">.</span><span class="n">from_edition</span><span class="p">(</span><span class="n">edition</span><span class="p">))</span>

            <span class="c1"># Note: Since this is a presentation edition it does not have a</span>
            <span class="c1"># license data source, even if one of the editions it was</span>
            <span class="c1"># created from does have a license data source.</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">_license_data_source</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">license_data_source_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">edition</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">edition</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

            <span class="n">policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="o">.</span><span class="n">from_metadata_source</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">,</span> <span class="n">edition_core_changed</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">edition</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">policy</span>
            <span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="n">changed</span> <span class="ow">or</span> <span class="n">edition_core_changed</span>

        <span class="n">presentation_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="n">changed</span> <span class="ow">or</span> <span class="n">presentation_changed</span>

        <span class="c1"># if the license pool is associated with a work, and the work currently has no presentation edition,</span>
        <span class="c1"># then do a courtesy call to the work, and tell it about the presentation edition.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="o">!=</span> <span class="n">old_presentation_edition</span>
            <span class="ow">or</span> <span class="n">changed</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LicensePool.add_link"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.add_link">[docs]</a>    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rights_status_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rights_explanation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">original_resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transformation_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a link between this LicensePool and a Resource.</span>

<span class="sd">        :param rel: The relationship between this LicensePool and the resource</span>
<span class="sd">            on the other end of the link.</span>
<span class="sd">        :param href: The URI of the resource on the other end of the link.</span>
<span class="sd">        :param media_type: Media type of the representation associated</span>
<span class="sd">            with the resource.</span>
<span class="sd">        :param content: Content of the representation associated with the</span>
<span class="sd">            resource.</span>
<span class="sd">        :param content_path: Path (relative to DATA_DIRECTORY) of the</span>
<span class="sd">            representation associated with the resource.</span>
<span class="sd">        :param rights_status_uri: The URI of the RightsStatus for this resource.</span>
<span class="sd">        :param rights_explanation: A free text explanation of why the RightsStatus</span>
<span class="sd">            applies.</span>
<span class="sd">        :param original_resource: Another resource that this resource was derived from.</span>
<span class="sd">        :param transformation_settings: The settings used to transform the original</span>
<span class="sd">            resource into this resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
            <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">content_path</span><span class="p">,</span>
            <span class="n">rights_status_uri</span><span class="p">,</span> <span class="n">rights_explanation</span><span class="p">,</span> <span class="n">original_resource</span><span class="p">,</span>
            <span class="n">transformation_settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="LicensePool.needs_update"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.needs_update">[docs]</a>    <span class="k">def</span> <span class="nf">needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is it time to update the circulation info for this license pool?&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span><span class="p">:</span>
            <span class="c1"># This pool has never had its circulation info checked.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">maximum_stale_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;circulation_refresh_rate_seconds&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maximum_stale_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This pool never needs to have its circulation info checked.</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span>
        <span class="k">return</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">maximum_stale_time</span></div>

<div class="viewcode-block" id="LicensePool.update_availability"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.update_availability">[docs]</a>    <span class="k">def</span> <span class="nf">update_availability</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">new_licenses_owned</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="p">,</span>
            <span class="n">new_licenses_reserved</span><span class="p">,</span> <span class="n">new_patrons_in_hold_queue</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_of</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the LicensePool with new availability information.</span>
<span class="sd">        Log the implied changes with the analytics provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changes_made</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_of</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">as_of</span> <span class="o">==</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">NO_DATE</span><span class="p">:</span>
            <span class="c1"># The caller explicitly does not want</span>
            <span class="c1"># LicensePool.last_checked to be updated.</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">old_licenses_owned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span>
        <span class="n">old_licenses_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span>
        <span class="n">old_licenses_reserved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span>
        <span class="n">old_patrons_in_hold_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span>

        <span class="k">for</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">more_event</span><span class="p">,</span> <span class="n">fewer_event</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span><span class="p">,</span>  <span class="n">new_patrons_in_hold_queue</span><span class="p">,</span>
                 <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_HOLD_PLACE</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_HOLD_RELEASE</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="p">,</span>
                 <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKIN</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKOUT</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span><span class="p">,</span> <span class="n">new_licenses_reserved</span><span class="p">,</span>
                 <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_AVAILABILITY_NOTIFY</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">,</span> <span class="n">new_licenses_owned</span><span class="p">,</span>
                 <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_ADD</span><span class="p">,</span>
                 <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_REMOVE</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">old_value</span> <span class="o">==</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">changes_made</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">old_value</span> <span class="o">&lt;</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="n">event_name</span> <span class="o">=</span> <span class="n">more_event</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event_name</span> <span class="o">=</span> <span class="n">fewer_event</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_name</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">collect_analytics_event</span><span class="p">(</span>
                <span class="n">analytics</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">as_of</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span>
            <span class="p">)</span>

        <span class="c1"># Update the license pool with the latest information.</span>
        <span class="n">any_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_licenses_owned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">new_licenses_owned</span>
            <span class="n">any_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_licenses_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="n">new_licenses_available</span>
            <span class="n">any_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_licenses_reserved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="o">=</span> <span class="n">new_licenses_reserved</span>
            <span class="n">any_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_patrons_in_hold_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">new_patrons_in_hold_queue</span>
            <span class="n">any_data</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">and</span> <span class="p">(</span><span class="n">any_data</span> <span class="ow">or</span> <span class="n">changes_made</span><span class="p">):</span>
            <span class="c1"># Sometimes update_availability is called with no actual</span>
            <span class="c1"># numbers, but that&#39;s not the case this time. We got</span>
            <span class="c1"># numbers and they may have even changed our view of the</span>
            <span class="c1"># LicensePool.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span> <span class="o">=</span> <span class="n">as_of</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="n">as_of</span>

        <span class="k">if</span> <span class="n">changes_made</span><span class="p">:</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation_changelog</span><span class="p">(</span>
                <span class="n">old_licenses_owned</span><span class="p">,</span> <span class="n">old_licenses_available</span><span class="p">,</span>
                <span class="n">old_licenses_reserved</span><span class="p">,</span> <span class="n">old_patrons_in_hold_queue</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">changes_made</span></div>

<div class="viewcode-block" id="LicensePool.collect_analytics_event"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.collect_analytics_event">[docs]</a>    <span class="k">def</span> <span class="nf">collect_analytics_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytics</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">as_of</span><span class="p">,</span>
                                <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analytics</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="n">analytics</span><span class="o">.</span><span class="n">collect_event</span><span class="p">(</span>
                <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">as_of</span><span class="p">,</span>
                <span class="n">old_value</span><span class="o">=</span><span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="o">=</span><span class="n">new_value</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LicensePool.update_availability_from_delta"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.update_availability_from_delta">[docs]</a>    <span class="k">def</span> <span class="nf">update_availability_from_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event_date</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call update_availability based on a single change seen in the</span>
<span class="sd">        distributor data, rather than a complete snapshot of</span>
<span class="sd">        distributor information as of a certain time.</span>
<span class="sd">        This information is unlikely to be completely accurate, but it</span>
<span class="sd">        should suffice until more accurate information can be</span>
<span class="sd">        obtained.</span>
<span class="sd">        No CirculationEvent is created until `update_availability` is</span>
<span class="sd">        called.</span>
<span class="sd">        Events must be processed in chronological order. Any event</span>
<span class="sd">        that happened than `LicensePool.last_checked` is ignored, and</span>
<span class="sd">        calling this method will update `LicensePool.last_checked` to</span>
<span class="sd">        the time of the event.</span>
<span class="sd">        :param event_type: A CirculationEvent constant representing the</span>
<span class="sd">        type of change that was seen.</span>
<span class="sd">        :param event_date: A datetime corresponding to when the</span>
<span class="sd">        change was seen.</span>
<span class="sd">        :param delta: The magnitude of the change that was seen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">event_date</span> <span class="o">!=</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">NO_DATE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span> <span class="ow">and</span> <span class="n">event_date</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span><span class="p">:</span>
            <span class="c1"># This is an old event and its effect on availability has</span>
            <span class="c1"># already been taken into account.</span>
            <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked</span> <span class="ow">and</span> <span class="n">event_date</span> <span class="o">==</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">NO_DATE</span><span class="p">:</span>
            <span class="c1"># We have a history for this LicensePool and we don&#39;t know</span>
            <span class="c1"># where this event fits into that history. Ignore the</span>
            <span class="c1"># event.</span>
            <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="p">(</span><span class="n">new_licenses_owned</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="p">,</span>
             <span class="n">new_licenses_reserved</span><span class="p">,</span>
             <span class="n">new_patrons_in_hold_queue</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_change_from_one_event</span><span class="p">(</span>
                 <span class="n">event_type</span><span class="p">,</span> <span class="n">delta</span>
             <span class="p">)</span>

            <span class="n">changes_made</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_availability</span><span class="p">(</span>
                <span class="n">new_licenses_owned</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="p">,</span>
                <span class="n">new_licenses_reserved</span><span class="p">,</span> <span class="n">new_patrons_in_hold_queue</span><span class="p">,</span>
                <span class="n">analytics</span><span class="o">=</span><span class="n">analytics</span><span class="p">,</span> <span class="n">as_of</span><span class="o">=</span><span class="n">event_date</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">changes_made</span><span class="p">:</span>
            <span class="c1"># Even if the event was ignored or didn&#39;t actually change</span>
            <span class="c1"># availability, we want to record receipt of the event</span>
            <span class="c1"># in the analytics.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_analytics_event</span><span class="p">(</span>
                <span class="n">analytics</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event_date</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_calculate_change_from_one_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="n">new_licenses_owned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span>
        <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span>
        <span class="n">new_licenses_reserved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span>
        <span class="n">new_patrons_in_hold_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span>

        <span class="k">def</span> <span class="nf">deduct</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="c1"># It&#39;s impossible for any of these numbers to be</span>
            <span class="c1"># negative.</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">CE</span> <span class="o">=</span> <span class="n">CirculationEvent</span>
        <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_HOLD_PLACE</span><span class="p">:</span>
            <span class="n">new_patrons_in_hold_queue</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="k">if</span> <span class="n">new_licenses_available</span><span class="p">:</span>
                <span class="c1"># If someone has put a book on hold, it must not be</span>
                <span class="c1"># immediately available.</span>
                <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_HOLD_RELEASE</span><span class="p">:</span>
            <span class="n">new_patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">deduct</span><span class="p">(</span><span class="n">new_patrons_in_hold_queue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKIN</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_licenses_available</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># When there are patrons in the hold queue, checking</span>
                <span class="c1"># in a single book does not make new licenses</span>
                <span class="c1"># available.  Checking in more books than there are</span>
                <span class="c1"># patrons in the hold queue _does_ make books</span>
                <span class="c1"># available.  However, in neither case do patrons</span>
                <span class="c1"># leave the hold queue. That will happen in the near</span>
                <span class="c1"># future as DISTRIBUTOR_AVAILABILITY_NOTIFICATION events</span>
                <span class="c1"># are sent out.</span>
                <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">new_patrons_in_hold_queue</span><span class="p">:</span>
                    <span class="n">new_licenses_available</span> <span class="o">+=</span> <span class="p">(</span><span class="n">delta</span><span class="o">-</span><span class="n">new_patrons_in_hold_queue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKOUT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_licenses_available</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># The only way to borrow books while there are no</span>
                <span class="c1"># licenses available is to borrow reserved copies.</span>
                <span class="n">new_licenses_reserved</span> <span class="o">=</span> <span class="n">deduct</span><span class="p">(</span><span class="n">new_licenses_reserved</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We don&#39;t know whether this checkout came from</span>
                <span class="c1"># licenses available or from a lingering reserved</span>
                <span class="c1"># copy, but in most cases it came from licenses</span>
                <span class="c1"># available.</span>
                <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="n">deduct</span><span class="p">(</span><span class="n">new_licenses_available</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_ADD</span><span class="p">:</span>
            <span class="n">new_licenses_owned</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="c1"># Newly added licenses start out as available, unless there</span>
            <span class="c1"># are patrons in the holds queue.</span>
            <span class="k">if</span> <span class="n">new_patrons_in_hold_queue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_licenses_available</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_REMOVE</span><span class="p">:</span>
            <span class="n">new_licenses_owned</span> <span class="o">=</span> <span class="n">deduct</span><span class="p">(</span><span class="n">new_licenses_owned</span><span class="p">)</span>
            <span class="c1"># We can&#39;t say whether or not the removed licenses should</span>
            <span class="c1"># be deducted from the list of available licenses, because they</span>
            <span class="c1"># might already be checked out.</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CE</span><span class="o">.</span><span class="n">DISTRIBUTOR_AVAILABILITY_NOTIFY</span><span class="p">:</span>
            <span class="n">new_patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">deduct</span><span class="p">(</span><span class="n">new_patrons_in_hold_queue</span><span class="p">)</span>
            <span class="n">new_licenses_reserved</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">if</span> <span class="n">new_licenses_owned</span> <span class="o">&lt;</span> <span class="n">new_licenses_available</span><span class="p">:</span>
            <span class="c1"># It&#39;s impossible to have more licenses available than</span>
            <span class="c1"># owned. We don&#39;t know whether this means there are some</span>
            <span class="c1"># extra licenses we never heard about, or whether some</span>
            <span class="c1"># licenses expired without us being notified, but the</span>
            <span class="c1"># latter is more likely.</span>
            <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="n">new_licenses_owned</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">new_licenses_owned</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="p">,</span>
                <span class="n">new_licenses_reserved</span><span class="p">,</span> <span class="n">new_patrons_in_hold_queue</span><span class="p">)</span>

<div class="viewcode-block" id="LicensePool.circulation_changelog"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.circulation_changelog">[docs]</a>    <span class="k">def</span> <span class="nf">circulation_changelog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_licenses_owned</span><span class="p">,</span> <span class="n">old_licenses_available</span><span class="p">,</span>
                              <span class="n">old_licenses_reserved</span><span class="p">,</span> <span class="n">old_patrons_in_hold_queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a log message describing a change to the circulation.</span>
<span class="sd">        :return: a 2-tuple (message, args) suitable for passing into</span>
<span class="sd">        logging.info or a similar method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;CHANGED &#39;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="n">identifier_template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="n">identifier_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier_template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="n">identifier_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">edition</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1"> (&#39;</span> <span class="o">+</span> <span class="n">identifier_template</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
                         <span class="n">edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="s2">&quot;[NO TITLE]&quot;</span><span class="p">,</span>
                         <span class="n">edition</span><span class="o">.</span><span class="n">author</span> <span class="ow">or</span> <span class="s2">&quot;[NO AUTHOR]&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">identifier_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="n">identifier_template</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">identifier_args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_part</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old_value</span> <span class="o">!=</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">string</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">])</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">=&gt;</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="n">args</span>

        <span class="n">message</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">_part</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;OWN&quot;</span><span class="p">,</span> <span class="n">old_licenses_owned</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses_owned</span>
        <span class="p">)</span>

        <span class="n">message</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">_part</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;AVAIL&quot;</span><span class="p">,</span> <span class="n">old_licenses_available</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_available</span>
        <span class="p">)</span>

        <span class="n">message</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">_part</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;RSRV&quot;</span><span class="p">,</span> <span class="n">old_licenses_reserved</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">licenses_reserved</span>
        <span class="p">)</span>

        <span class="n">message</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span><span class="n">_part</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;HOLD&quot;</span><span class="p">,</span> <span class="n">old_patrons_in_hold_queue</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="LicensePool.loan_to"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.loan_to">[docs]</a>    <span class="k">def</span> <span class="nf">loan_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_client</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fulfillment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span> <span class="ow">or</span> <span class="n">utc_now</span><span class="p">(),</span>
                      <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="n">loan</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">create_method_kwargs</span><span class="o">=</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="c1"># This action creates uncertainty about what the patron&#39;s</span>
                <span class="c1"># loan activity actually is. We&#39;ll need to sync with the</span>
                <span class="c1"># vendor APIs.</span>
                <span class="n">patron_or_client</span><span class="o">.</span><span class="n">last_loan_activity_sync</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An IntegrationClient can have multiple loans, so this always creates</span>
            <span class="c1"># a new loan rather than returning an existing loan.</span>
            <span class="n">loan</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">integration_client</span><span class="o">=</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">create_method_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fulfillment</span><span class="p">:</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">fulfillment</span> <span class="o">=</span> <span class="n">fulfillment</span>
        <span class="k">if</span> <span class="n">external_identifier</span><span class="p">:</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span>
        <span class="k">return</span> <span class="n">loan</span><span class="p">,</span> <span class="n">is_new</span></div>

<div class="viewcode-block" id="LicensePool.on_hold_to"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.on_hold_to">[docs]</a>    <span class="k">def</span> <span class="nf">on_hold_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_client</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">Patron</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">patron_or_client</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">allow_holds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PolicyException</span><span class="p">(</span><span class="s2">&quot;Holds are disabled for this library.&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="n">hold</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
            <span class="c1"># This action creates uncertainty about what the patron&#39;s</span>
            <span class="c1"># loan activity actually is. We&#39;ll need to sync with the</span>
            <span class="c1"># vendor APIs.</span>
            <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
                <span class="n">patron_or_client</span><span class="o">.</span><span class="n">last_loan_activity_sync</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An IntegrationClient can have multiple holds, so this always creates</span>
            <span class="c1"># a new hold rather than returning an existing loan.</span>
            <span class="n">hold</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">integration_client</span><span class="o">=</span><span class="n">patron_or_client</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">hold</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">external_identifier</span><span class="p">:</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">external_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span>
        <span class="k">return</span> <span class="n">hold</span><span class="p">,</span> <span class="n">new</span></div>

<div class="viewcode-block" id="LicensePool.best_available_license"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.best_available_license">[docs]</a>    <span class="k">def</span> <span class="nf">best_available_license</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the next license that should be lent out for this pool.</span>

<span class="sd">        Time-limited licenses and perpetual licenses are the best. It doesn&#39;t matter which</span>
<span class="sd">        is used first, unless a time-limited license would expire within the loan period, in</span>
<span class="sd">        which case it&#39;s better to loan the time-limited license so the perpetual one is still</span>
<span class="sd">        available. We can handle this by always loaning the time-limited one first, followed</span>
<span class="sd">        by perpetual. If there is more than one time-limited license, it&#39;s better to use the one</span>
<span class="sd">        expiring soonest.</span>

<span class="sd">        If no time-limited or perpetual licenses are available, the next best is a loan-limited</span>
<span class="sd">        license. We should choose the license with the most remaining loans, so that we&#39;ll</span>
<span class="sd">        maximize the number of concurrent checkouts available in the future.</span>

<span class="sd">        The worst option would be pay-per-use, but we don&#39;t yet support any distributors that</span>
<span class="sd">        offer that model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">license</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">licenses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">license</span><span class="o">.</span><span class="n">is_expired</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">active_loan_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">license</span><span class="o">.</span><span class="n">loans</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">end</span> <span class="ow">or</span> <span class="n">l</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">active_loan_count</span> <span class="o">&gt;=</span> <span class="n">license</span><span class="o">.</span><span class="n">concurrent_checkouts</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">best</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">license</span><span class="o">.</span><span class="n">is_time_limited</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best</span><span class="o">.</span><span class="n">is_time_limited</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">license</span><span class="o">.</span><span class="n">is_time_limited</span> <span class="ow">and</span> <span class="n">best</span><span class="o">.</span><span class="n">is_time_limited</span> <span class="ow">and</span> <span class="n">license</span><span class="o">.</span><span class="n">expires</span> <span class="o">&lt;</span> <span class="n">best</span><span class="o">.</span><span class="n">expires</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">license</span><span class="o">.</span><span class="n">is_perpetual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best</span><span class="o">.</span><span class="n">is_time_limited</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">license</span><span class="o">.</span><span class="n">is_loan_limited</span> <span class="ow">and</span> <span class="n">best</span><span class="o">.</span><span class="n">is_loan_limited</span> <span class="ow">and</span> <span class="n">license</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">&gt;</span> <span class="n">best</span><span class="o">.</span><span class="n">remaining_checkouts</span><span class="p">)</span>
                <span class="p">):</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">license</span>

        <span class="k">return</span> <span class="n">best</span></div>

<div class="viewcode-block" id="LicensePool.consolidate_works"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.consolidate_works">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">consolidate_works</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign a (possibly new) Work to every unassigned LicensePool.&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lps</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">with_no_work</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Assigning Works to </span><span class="si">%d</span><span class="s2"> LicensePools with no Work.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lps</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">unassigned</span> <span class="ow">in</span> <span class="n">lps</span><span class="p">:</span>
            <span class="n">etext</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">unassigned</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">etext</span><span class="p">:</span>
                <span class="c1"># We could not create a work for this LicensePool,</span>
                <span class="c1"># most likely because it does not yet have any</span>
                <span class="c1"># associated Edition.</span>
                <span class="k">continue</span>
            <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;When consolidating works, created </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">etext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span> <span class="o">%</span> <span class="n">batch_size</span><span class="p">:</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="LicensePool.calculate_work"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.calculate_work">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_work</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">known_edition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">even_if_no_title</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create a Work for this LicensePool.</span>
<span class="sd">        A pool that is not open-access will always have its own</span>
<span class="sd">        Work. Open-access LicensePools will be grouped together with</span>
<span class="sd">        other open-access LicensePools based on the permanent work ID</span>
<span class="sd">        of the LicensePool&#39;s presentation edition.</span>
<span class="sd">        :param even_if_no_title: Ordinarily this method will refuse to</span>
<span class="sd">        create a Work for a LicensePool whose Edition has no title.</span>
<span class="sd">        However, in components that don&#39;t present information directly</span>
<span class="sd">        to readers, it&#39;s sometimes useful to create a Work even if the</span>
<span class="sd">        title is unknown. In that case, pass in even_if_no_title=True</span>
<span class="sd">        and the Work will be created.</span>
<span class="sd">        TODO: I think known_edition is mostly useless. We should</span>
<span class="sd">        either remove it or replace it with a boolean that stops us</span>
<span class="sd">        from calling set_presentation_edition() and assumes we&#39;ve</span>
<span class="sd">        already done that work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.work</span> <span class="kn">import</span> <span class="n">Work</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="c1"># A LicensePool with no Identifier should never have a Work.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">known_edition</span><span class="p">:</span>
            <span class="n">presentation_edition</span> <span class="o">=</span> <span class="n">known_edition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">()</span>
            <span class="n">presentation_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="k">if</span> <span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">is_presentation_for</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Alleged presentation edition is not the presentation edition for the license pool for which work is being calculated!&quot;</span>
                <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating work for </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">presentation_edition</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">presentation_edition</span><span class="p">:</span>
            <span class="c1"># We don&#39;t have any information about the identifier</span>
            <span class="c1"># associated with this LicensePool, so we can&#39;t create a work.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NO EDITION for </span><span class="si">%s</span><span class="s2">, cowardly refusing to create work.&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

            <span class="c1"># If there was a work associated with this LicensePool,</span>
            <span class="c1"># it was by mistake. Remove it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
            <span class="n">presentation_edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">even_if_no_title</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Edition </span><span class="si">%r</span><span class="s2"> has no title but has a Work assigned. This will not stand.&quot;</span><span class="p">,</span> <span class="n">presentation_edition</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Edition </span><span class="si">%r</span><span class="s2"> has no title and it will not get a Work.&quot;</span><span class="p">,</span> <span class="n">presentation_edition</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">presentation_edition</span><span class="o">.</span><span class="n">calculate_permanent_work_id</span><span class="p">()</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">licensepools_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span> <span class="ow">and</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">:</span>
            <span class="c1"># This is an open-access book. Use the Work for all</span>
            <span class="c1"># open-access books associated with this book&#39;s permanent</span>
            <span class="c1"># work ID.</span>
            <span class="c1">#</span>
            <span class="c1"># If the dataset is in an inconsistent state, calling</span>
            <span class="c1"># Work.open_access_for_permanent_work_id may result in works being</span>
            <span class="c1"># merged.</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">open_access_for_permanent_work_id</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">,</span>
                <span class="n">presentation_edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">language</span>
            <span class="p">)</span>

            <span class="c1"># Run a sanity check to make sure every LicensePool</span>
            <span class="c1"># associated with this Work actually belongs there. This</span>
            <span class="c1"># may result in new Works being created.</span>
            <span class="c1">#</span>
            <span class="c1"># This could go into Work.for_permanent_work_id, but that</span>
            <span class="c1"># could conceivably lead to an infinite loop, or at least</span>
            <span class="c1"># a very long recursive call, so I&#39;ve put it here.</span>
            <span class="n">work</span><span class="o">.</span><span class="n">make_exclusive_open_access_for_permanent_work_id</span><span class="p">(</span>
                <span class="n">presentation_edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">,</span>
                <span class="n">presentation_edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
                <span class="n">presentation_edition</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>
            <span class="n">licensepools_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># All LicensePools with a given Identifier must share a work.</span>
        <span class="n">existing_works</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">work</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_works</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;LicensePools for </span><span class="si">%r</span><span class="s2"> have more than one Work between them. Removing them all and starting over.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">:</span>
                <span class="n">lp</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">lp</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
                    <span class="n">lp</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There is a consensus Work for this Identifier.</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_works</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
            <span class="c1"># This pool is already associated with a Work. Use that</span>
            <span class="c1"># Work.</span>
            <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span>
        <span class="k">elif</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
            <span class="c1"># This pool&#39;s presentation edition is already associated with</span>
            <span class="c1"># a Work. Use that Work.</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>

        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="c1"># There is already a Work associated with this LicensePool,</span>
            <span class="c1"># but we need to run a sanity check because occasionally</span>
            <span class="c1"># LicensePools get mis-grouped due to bugs.</span>
            <span class="c1">#</span>
            <span class="c1"># A commercially-licensed book should have a Work to</span>
            <span class="c1"># itself. All other LicensePools need to be kicked out and</span>
            <span class="c1"># associated with some other work.</span>
            <span class="c1">#</span>
            <span class="c1"># This won&#39;t cause an infinite recursion because we&#39;re</span>
            <span class="c1"># setting pool.work to None before calling</span>
            <span class="c1"># pool.calculate_work(), and the recursive call only</span>
            <span class="c1"># happens if self.work is set.</span>
            <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_access</span> <span class="ow">and</span> <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">):</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">(</span>
                        <span class="n">exclude_search</span><span class="o">=</span><span class="n">exclude_search</span><span class="p">,</span>
                        <span class="n">even_if_no_title</span><span class="o">=</span><span class="n">even_if_no_title</span>
                    <span class="p">)</span>
                    <span class="n">licensepools_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There is no better choice than creating a brand new Work.</span>
            <span class="n">is_new</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Creating a new work for </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span>
            <span class="p">)</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">()</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
            <span class="n">flush</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
            <span class="n">licensepools_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Associate this LicensePool and its Edition with the work we</span>
        <span class="c1"># chose or created.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">licensepools_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Recalculate the display information for the Work. Either the</span>
        <span class="c1"># associated LicensePools have changed, which may have caused</span>
        <span class="c1"># the Work&#39;s presentation Edition to change, or</span>
        <span class="c1"># the caller has reason to believe that the presentation Edition</span>
        <span class="c1"># is changing for some other reason.</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">exclude_search</span><span class="o">=</span><span class="n">exclude_search</span><span class="p">)</span>

        <span class="c1"># Ensure that all LicensePools with this Identifier share</span>
        <span class="c1"># the same Work. (We may have wiped out their .work earlier</span>
        <span class="c1"># in this method.)</span>
        <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">:</span>
            <span class="n">lp</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created a new work: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>

        <span class="c1"># All done!</span>
        <span class="k">return</span> <span class="n">work</span><span class="p">,</span> <span class="n">is_new</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">open_access_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield all open-access Resources for this LicensePool.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.identifier</span> <span class="kn">import</span> <span class="n">Identifier</span>
        <span class="n">open_access</span> <span class="o">=</span> <span class="n">LinkRelations</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">resources_for_identifier_ids</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">open_access</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">resource</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">open_access_download_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias for best_open_access_link.</span>
<span class="sd">        If _open_access_download_url is currently None, this will set</span>
<span class="sd">        to a good value if possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_open_access_link</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_open_access_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the best open-access link for this LicensePool.</span>
<span class="sd">        Cache it so that the next access will be faster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_access_download_url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_open_access_resource</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">public_url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_access_download_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_access_download_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_open_access_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the best open-access Resource currently provided by this</span>
<span class="sd">        LicensePool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span> <span class="ow">and</span>
                     <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">and</span>
                     <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">media_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">SUPPORTED_BOOK_MEDIA_TYPES</span><span class="p">]):</span>
                <span class="c1"># This representation is not in a media type we</span>
                <span class="c1"># support. We can&#39;t serve it, so we won&#39;t consider it.</span>
                <span class="k">continue</span>

            <span class="n">data_source_priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_access_source_priority</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">best</span> <span class="ow">or</span> <span class="n">data_source_priority</span> <span class="o">&gt;</span> <span class="n">best_priority</span><span class="p">:</span>
                <span class="c1"># Something is better than nothing.</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">resource</span>
                <span class="n">best_priority</span> <span class="o">=</span> <span class="n">data_source_priority</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">best</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span>
                <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span>
                <span class="ow">and</span> <span class="s1">&#39;noimages&#39;</span> <span class="ow">in</span> <span class="n">best</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">public_url</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;noimages&#39;</span> <span class="ow">in</span> <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">public_url</span><span class="p">):</span>
                <span class="c1"># A Project Gutenberg-ism: an epub without &#39;noimages&#39;</span>
                <span class="c1"># in the filename is better than an epub with</span>
                <span class="c1"># &#39;noimages&#39; in the filename.</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">resource</span>
                <span class="n">best_priority</span> <span class="o">=</span> <span class="n">data_source_priority</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">best</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_license_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the best available licensing link for the work associated</span>
<span class="sd">        with this LicensePool.</span>
<span class="sd">        # TODO: This needs work and may not be necessary anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">best_open_access_link</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">link</span>

        <span class="c1"># Either this work is not open-access, or there was no epub</span>
        <span class="c1"># link associated with it.</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">edition</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">best_open_access_link</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pool</span><span class="p">,</span> <span class="n">link</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span>

<div class="viewcode-block" id="LicensePool.set_delivery_mechanism"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePool.set_delivery_mechanism">[docs]</a>    <span class="k">def</span> <span class="nf">set_delivery_mechanism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that this LicensePool (and any other LicensePools for the same</span>
<span class="sd">        book) have a LicensePoolDeliveryMechanism for this media type,</span>
<span class="sd">        DRM scheme, rights status, and resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div></div>

<span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ix_licensepools_data_source_id_identifier_id_collection_id&quot;</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="LicensePoolDeliveryMechanism"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePoolDeliveryMechanism">[docs]</a><span class="k">class</span> <span class="nc">LicensePoolDeliveryMechanism</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A mechanism for delivering a specific book from a specific</span>
<span class="sd">    distributor.</span>
<span class="sd">    It&#39;s presumed that all LicensePools for a given DataSource and</span>
<span class="sd">    Identifier have the same set of LicensePoolDeliveryMechanisms.</span>
<span class="sd">    This is mostly an association class between DataSource, Identifier and</span>
<span class="sd">    DeliveryMechanism, but it also may incorporate a specific Resource</span>
<span class="sd">    (i.e. a static link to a downloadable file) which explains exactly</span>
<span class="sd">    where to go for delivery.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;licensepooldeliveries&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data_source_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;datasources.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">identifier_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;identifiers.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">delivery_mechanism_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;deliverymechanisms.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">resource_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;resources.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One LicensePoolDeliveryMechanism may fulfill many Loans.</span>
    <span class="n">fulfills</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Loan&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;fulfillment&quot;</span><span class="p">)</span>

    <span class="c1"># One LicensePoolDeliveryMechanism may be associated with one RightsStatus.</span>
    <span class="n">rightsstatus_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;rightsstatus.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="LicensePoolDeliveryMechanism.set"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePoolDeliveryMechanism.set">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register the fact that a distributor makes a title available in a</span>
<span class="sd">        certain format.</span>

<span class="sd">        :param data_source: A DataSource identifying the distributor.</span>
<span class="sd">        :param identifier: An Identifier identifying the title.</span>
<span class="sd">        :param content_type: The title is available in this media type.</span>
<span class="sd">        :param drm_scheme: Access to the title is confounded by this</span>
<span class="sd">            DRM scheme.</span>
<span class="sd">        :param rights_uri: A URI representing the public&#39;s rights to the</span>
<span class="sd">            title.</span>
<span class="sd">        :param resource: A Resource representing the book itself in</span>
<span class="sd">            a freely redistributable form.</span>
<span class="sd">        :param autocommit: Commit the database session immediately if</span>
<span class="sd">            anything changes in the database. If you&#39;re already inside</span>
<span class="sd">            a nested transaction, pass in False here to avoid</span>
<span class="sd">            committing prematurely, but understand that if a</span>
<span class="sd">            LicensePool&#39;s open-access status changes as a result of</span>
<span class="sd">            calling this method, the change may not be properly</span>
<span class="sd">            reflected in LicensePool.open_access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
        <span class="n">delivery_mechanism</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span>
        <span class="p">)</span>
        <span class="n">rights_status</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">)</span>
        <span class="n">lpdm</span><span class="p">,</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">delivery_mechanism</span><span class="o">=</span><span class="n">delivery_mechanism</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span> <span class="ow">or</span> <span class="n">rights_status</span><span class="o">.</span><span class="n">uri</span> <span class="o">!=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
            <span class="c1"># We have better information available about the</span>
            <span class="c1"># rights status of this delivery mechanism.</span>
            <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span> <span class="o">=</span> <span class="n">rights_status</span>
            <span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
            <span class="c1"># TODO: We need to explicitly commit here so that</span>
            <span class="c1"># LicensePool.delivery_mechanisms gets updated. It would be</span>
            <span class="c1"># better if we didn&#39;t have to do this, but I haven&#39;t been able</span>
            <span class="c1"># to get LicensePool.delivery_mechanisms to notice that it&#39;s</span>
            <span class="c1"># out of date.</span>
            <span class="k">if</span> <span class="n">autocommit</span><span class="p">:</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1"># Creating or modifying a LPDM might change the open-access status</span>
            <span class="c1"># of all LicensePools for that DataSource/Identifier.</span>
            <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">set_open_access_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lpdm</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_open_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this an open-access delivery mechanism?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rights_status</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rights_status</span><span class="o">.</span><span class="n">uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">)</span>

<div class="viewcode-block" id="LicensePoolDeliveryMechanism.compatible_with"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePoolDeliveryMechanism.compatible_with">[docs]</a>    <span class="k">def</span> <span class="nf">compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can a single loan be fulfilled with both this</span>
<span class="sd">        LicensePoolDeliveryMechanism and the given one?</span>

<span class="sd">        :param other: A LicensePoolDeliveryMechanism.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c1"># They two LicensePoolDeliveryMechanisms are the same object.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># The two LicensePoolDeliveryMechanisms must be different ways</span>
        <span class="c1"># of getting the same book from the same source.</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">identifier_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">data_source_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">delivery_mechanism_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_mechanism_id</span><span class="p">:</span>
            <span class="c1"># We have two LicensePoolDeliveryMechanisms for the same</span>
            <span class="c1"># underlying delivery mechanism. This can happen when an</span>
            <span class="c1"># open-access book gets its content mirrored to two</span>
            <span class="c1"># different places.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If the DeliveryMechanisms themselves are compatible, then the</span>
        <span class="c1"># LicensePoolDeliveryMechanisms are compatible.</span>
        <span class="c1">#</span>
        <span class="c1"># In practice, this means that either the two</span>
        <span class="c1"># DeliveryMechanisms are the same or that one of them is a</span>
        <span class="c1"># streaming mechanism.</span>
        <span class="n">open_access_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open_access</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_open_access</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="n">delivery_mechanism</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">compatible_with</span><span class="p">(</span>
                <span class="n">other</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">,</span> <span class="n">open_access_rules</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LicensePoolDeliveryMechanism.delete"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePoolDeliveryMechanism.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a LicensePoolDeliveryMechanism.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># TODO: We need to explicitly commit here so that</span>
        <span class="c1"># LicensePool.delivery_mechanisms gets updated. It would be</span>
        <span class="c1"># better if we didn&#39;t have to do this, but I haven&#39;t been able</span>
        <span class="c1"># to get LicensePool.delivery_mechanisms to notice that it&#39;s</span>
        <span class="c1"># out of date.</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># The deletion of a LicensePoolDeliveryMechanism might affect</span>
        <span class="c1"># the open-access status of its associated LicensePools.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">set_open_access_status</span><span class="p">()</span></div>

<div class="viewcode-block" id="LicensePoolDeliveryMechanism.set_rights_status"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.LicensePoolDeliveryMechanism.set_rights_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_rights_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rights_status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="c1"># A change to a LicensePoolDeliveryMechanism&#39;s rights status</span>
        <span class="c1"># might affect the open-access status of its associated</span>
        <span class="c1"># LicensePools.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">set_open_access_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">status</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">license_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all LicensePools for this LicensePoolDeliveryMechanism.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">&quot;&lt;LicensePoolDeliveryMechanism: data_source=</span><span class="si">{0}</span><span class="s2">, identifier=</span><span class="si">{1}</span><span class="s2">, mechanism=</span><span class="si">{2}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;data_source_id&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier_id&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;delivery_mechanism_id&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_id&#39;</span><span class="p">),</span>
    <span class="p">)</span></div>

<span class="c1"># The uniqueness constraint doesn&#39;t enforce uniqueness when one of the</span>
<span class="c1"># fields is null, and one of these fields -- resource_id -- is</span>
<span class="c1"># _usually_ null. So we also need a unique partial index to properly</span>
<span class="c1"># enforce the constraint.</span>
<span class="n">Index</span><span class="p">(</span>
    <span class="s1">&#39;ix_licensepooldeliveries_unique_when_no_resource&#39;</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">delivery_mechanism_id</span><span class="p">,</span>
    <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">postgresql_where</span><span class="o">=</span><span class="p">(</span><span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">resource_id</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="DeliveryMechanism"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.DeliveryMechanism">[docs]</a><span class="k">class</span> <span class="nc">DeliveryMechanism</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">HasFullTableCache</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A technique for delivering a book to a patron.</span>
<span class="sd">    There are two parts to this: a DRM scheme and a content</span>
<span class="sd">    type. Either may be identified with a MIME media type</span>
<span class="sd">    (e.g. &quot;application/vnd.adobe.adept+xml&quot; or &quot;application/epub+zip&quot;) or an</span>
<span class="sd">    informal name (&quot;Kindle via Amazon&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">KINDLE_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Kindle via Amazon&quot;</span>
    <span class="n">NOOK_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Nook via B&amp;N&quot;</span>
    <span class="n">STREAMING_TEXT_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Streaming Text&quot;</span>
    <span class="n">STREAMING_AUDIO_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Streaming Audio&quot;</span>
    <span class="n">STREAMING_VIDEO_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;Streaming Video&quot;</span>

    <span class="n">NO_DRM</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ADOBE_DRM</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.adobe.adept+xml&quot;</span>
    <span class="n">FINDAWAY_DRM</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.librarysimplified.findaway.license+json&quot;</span>
    <span class="n">AXISNOW_DRM</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.librarysimplified.axisnow+json&quot;</span>
    <span class="n">KINDLE_DRM</span> <span class="o">=</span> <span class="s2">&quot;Kindle DRM&quot;</span>
    <span class="n">NOOK_DRM</span> <span class="o">=</span> <span class="s2">&quot;Nook DRM&quot;</span>
    <span class="n">STREAMING_DRM</span> <span class="o">=</span> <span class="s2">&quot;Streaming&quot;</span>
    <span class="n">LCP_DRM</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.readium.lcp.license.v1.0+json&quot;</span>

    <span class="c1"># This represents the DRM system used by the app called &#39;Overdrive&#39;</span>
    <span class="c1"># and associated with the application/x-od-media media type.</span>
    <span class="n">OVERDRIVE_DRM</span> <span class="o">=</span> <span class="s2">&quot;Overdrive DRM&quot;</span>

    <span class="c1"># This represents the DRM system used by the app called &#39;Libby&#39; and</span>
    <span class="c1"># associated with the</span>
    <span class="c1"># application/vnd.overdrive.circulation.api+json media type and</span>
    <span class="c1"># its profiles.</span>
    <span class="n">LIBBY_DRM</span> <span class="o">=</span> <span class="s2">&quot;Libby DRM&quot;</span>

    <span class="n">KNOWN_DRM_TYPES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ADOBE_DRM</span><span class="p">,</span> <span class="n">FINDAWAY_DRM</span><span class="p">,</span> <span class="n">AXISNOW_DRM</span><span class="p">,</span> <span class="n">KINDLE_DRM</span><span class="p">,</span> <span class="n">NOOK_DRM</span><span class="p">,</span> <span class="n">STREAMING_DRM</span><span class="p">,</span> <span class="n">LCP_DRM</span><span class="p">,</span> <span class="n">OVERDRIVE_DRM</span><span class="p">,</span> <span class="n">LIBBY_DRM</span>
    <span class="p">}</span>

    <span class="n">BEARER_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.librarysimplified.bearer-token+json&quot;</span>
    <span class="n">FEEDBOOKS_AUDIOBOOK_DRM</span> <span class="o">=</span> <span class="s2">&quot;http://www.feedbooks.com/audiobooks/access-restriction&quot;</span>

    <span class="n">FEEDBOOKS_AUDIOBOOK_PROFILE</span> <span class="o">=</span> <span class="s1">&#39;;profile=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">FEEDBOOKS_AUDIOBOOK_DRM</span>
    <span class="n">STREAMING_PROFILE</span> <span class="o">=</span> <span class="s1">&#39;;profile=&quot;http://librarysimplified.org/terms/profiles/streaming-media&quot;&#39;</span>
    <span class="n">MEDIA_TYPES_FOR_STREAMING</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">STREAMING_TEXT_CONTENT_TYPE</span><span class="p">:</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">TEXT_HTML_MEDIA_TYPE</span><span class="p">,</span>
        <span class="n">STREAMING_AUDIO_CONTENT_TYPE</span><span class="p">:</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">TEXT_HTML_MEDIA_TYPE</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;deliverymechanisms&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="c1"># Can the Library Simplified client fulfill a book with this</span>
    <span class="c1"># content type and this DRM scheme?</span>
    <span class="n">default_client_can_fulfill</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># These are the media type/DRM scheme combos known to be supported</span>
    <span class="c1"># by the default Library Simplified client.</span>
    <span class="c1">#</span>
    <span class="c1"># This is primarily used when deciding which books can be imported</span>
    <span class="c1"># from an OPDS For Distributors collection.</span>
    <span class="n">default_client_can_fulfill_lookup</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="c1"># EPUB books</span>
        <span class="p">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">NO_DRM</span><span class="p">),</span>
        <span class="p">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">ADOBE_DRM</span><span class="p">),</span>

        <span class="c1"># PDF books</span>
        <span class="p">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span><span class="p">,</span> <span class="n">NO_DRM</span><span class="p">),</span>

        <span class="c1"># Various audiobook formats</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">FINDAWAY_DRM</span><span class="p">),</span>
        <span class="p">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">,</span> <span class="n">NO_DRM</span><span class="p">),</span>

        <span class="p">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="n">OVERDRIVE_AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">,</span> <span class="n">LIBBY_DRM</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="c1"># If the default client supports a given media type with no DRM,</span>
    <span class="c1"># we can infer that the client _also_ supports that media type via</span>
    <span class="c1"># bearer token exchange.</span>
    <span class="k">for</span> <span class="n">_media_type</span><span class="p">,</span> <span class="n">_drm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">default_client_can_fulfill_lookup</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_media_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_drm</span> <span class="o">==</span> <span class="n">NO_DRM</span><span class="p">:</span>
            <span class="n">default_client_can_fulfill_lookup</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="p">(</span><span class="n">_media_type</span><span class="p">,</span> <span class="n">BEARER_TOKEN</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">license_pool_delivery_mechanisms</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LicensePoolDeliveryMechanism&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;delivery_mechanism&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_cache</span> <span class="o">=</span> <span class="n">HasFullTableCache</span><span class="o">.</span><span class="n">RESET</span>
    <span class="n">_id_cache</span> <span class="o">=</span> <span class="n">HasFullTableCache</span><span class="o">.</span><span class="n">RESET</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="s1">&#39;drm_scheme&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">:</span>
            <span class="n">drm_scheme</span> <span class="o">=</span> <span class="s2">&quot;DRM-free&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drm_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">)</span>

<div class="viewcode-block" id="DeliveryMechanism.cache_key"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.DeliveryMechanism.cache_key">[docs]</a>    <span class="k">def</span> <span class="nf">cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_can_fulfill</span><span class="p">:</span>
            <span class="n">fulfillable</span> <span class="o">=</span> <span class="s2">&quot;fulfillable&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fulfillable</span> <span class="o">=</span> <span class="s2">&quot;not fulfillable&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;&lt;Delivery mechanism: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fulfillable</span>
        <span class="p">)</span>

<div class="viewcode-block" id="DeliveryMechanism.lookup"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.DeliveryMechanism.lookup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">lookup_hook</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
                <span class="n">drm_scheme</span><span class="o">=</span><span class="n">drm_scheme</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">by_cache_key</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">),</span> <span class="n">lookup_hook</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">implicit_medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What would be a good setting for EditionConstants.MEDIUM for an edition</span>
<span class="sd">        available through this DeliveryMechanism?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">MediaTypes</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span>
                <span class="n">MediaTypes</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span><span class="p">,</span>
                <span class="s2">&quot;Kindle via Amazon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Streaming Text&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">EditionConstants</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;Streaming Video&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;video/&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">EditionConstants</span><span class="o">.</span><span class="n">VIDEO_MEDIUM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DeliveryMechanism.is_media_type"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.DeliveryMechanism.is_media_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_media_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="s2">&quot;Does this string look like a media type?&quot;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span>
                   <span class="p">[</span><span class="s1">&#39;vnd.&#39;</span><span class="p">,</span> <span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MEDIA_TYPES_FOR_STREAMING</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drm_scheme_media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the media type for this delivery mechanism&#39;s</span>
<span class="sd">        DRM scheme, assuming it&#39;s represented that way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_media_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_type_media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the media type for this delivery mechanism&#39;s</span>
<span class="sd">        content type, assuming it&#39;s represented as a media type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_media_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FEEDBOOKS_AUDIOBOOK_DRM</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">FEEDBOOKS_AUDIOBOOK_PROFILE</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span>

        <span class="n">media_type_for_streaming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEDIA_TYPES_FOR_STREAMING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">media_type_for_streaming</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">media_type_for_streaming</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">STREAMING_PROFILE</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DeliveryMechanism.compatible_with"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.DeliveryMechanism.compatible_with">[docs]</a>    <span class="k">def</span> <span class="nf">compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">open_access_rules</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can a single loan be fulfilled with both this delivery mechanism</span>
<span class="sd">        and the given one?</span>

<span class="sd">        :param other: A DeliveryMechanism</span>
<span class="sd">        :param open_access: If this is True, the rules for open-access</span>
<span class="sd">            fulfillment will be applied. If not, the stricted rules</span>
<span class="sd">            for commercial fulfillment will be applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c1"># The two DeliveryMechanisms are the same.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Streaming delivery mechanisms can be used even when a</span>
        <span class="c1"># license pool is locked into a non-streaming delivery</span>
        <span class="c1"># mechanism.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># For an open-access book, loans are not locked to delivery</span>
        <span class="c1"># mechanisms, so as long as neither delivery mechanism has</span>
        <span class="c1"># DRM, they&#39;re compatible.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">open_access_rules</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_scheme</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_DRM</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">drm_scheme</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># For non-open-access books, locking a license pool to a</span>
        <span class="c1"># non-streaming delivery mechanism prohibits the use of any</span>
        <span class="c1"># other non-streaming delivery mechanism.</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>

<span class="c1"># The uniqueness constraint doesn&#39;t enforce uniqueness when one of the</span>
<span class="c1"># fields is null, and one of these fields -- drm_scheme -- is</span>
<span class="c1"># frequently null. So we also need a unique partial index to properly</span>
<span class="c1"># enforce the constraint.</span>
<span class="n">Index</span><span class="p">(</span>
    <span class="s1">&#39;ix_deliverymechanisms_unique_when_no_drm&#39;</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
    <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">postgresql_where</span><span class="o">=</span><span class="p">(</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">drm_scheme</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="RightsStatus"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.RightsStatus">[docs]</a><span class="k">class</span> <span class="nc">RightsStatus</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;The terms under which a book has been made available to the general</span>
<span class="sd">    public.</span>
<span class="sd">    This will normally be &#39;in copyright&#39;, or &#39;public domain&#39;, or a</span>
<span class="sd">    Creative Commons license.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Currently in copyright.</span>
    <span class="n">IN_COPYRIGHT</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/rights-status/in-copyright&quot;</span>

    <span class="c1"># Public domain in the USA.</span>
    <span class="n">PUBLIC_DOMAIN_USA</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/rights-status/public-domain-usa&quot;</span>

    <span class="c1"># Public domain in some unknown territory</span>
    <span class="n">PUBLIC_DOMAIN_UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/rights-status/public-domain-unknown&quot;</span>

    <span class="c1"># Creative Commons Public Domain Dedication (No rights reserved)</span>
    <span class="n">CC0</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/publicdomain/zero/1.0/&quot;</span>

    <span class="c1"># Creative Commons Attribution (CC BY)</span>
    <span class="n">CC_BY</span> <span class="o">=</span> <span class="s2">&quot;http://creativecommons.org/licenses/by/4.0/&quot;</span>

    <span class="c1"># Creative Commons Attribution-ShareAlike (CC BY-SA)</span>
    <span class="n">CC_BY_SA</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/licenses/by-sa/4.0&quot;</span>

    <span class="c1"># Creative Commons Attribution-NoDerivs (CC BY-ND)</span>
    <span class="n">CC_BY_ND</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/licenses/by-nd/4.0&quot;</span>

    <span class="c1"># Creative Commons Attribution-NonCommercial (CC BY-NC)</span>
    <span class="n">CC_BY_NC</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/licenses/by-nc/4.0&quot;</span>

    <span class="c1"># Creative Commons Attribution-NonCommercial-ShareAlike (CC BY-NC-SA)</span>
    <span class="n">CC_BY_NC_SA</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/licenses/by-nc-sa/4.0&quot;</span>

    <span class="c1"># Creative Commons Attribution-NonCommercial-NoDerivs (CC BY-NC-ND)</span>
    <span class="n">CC_BY_NC_ND</span> <span class="o">=</span> <span class="s2">&quot;https://creativecommons.org/licenses/by-nc-nd/4.0&quot;</span>

    <span class="c1"># Open access download but no explicit license</span>
    <span class="n">GENERIC_OPEN_ACCESS</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/rights-status/generic-open-access&quot;</span>

    <span class="c1"># Unknown copyright status.</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/rights-status/unknown&quot;</span>

    <span class="n">OPEN_ACCESS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PUBLIC_DOMAIN_USA</span><span class="p">,</span>
        <span class="n">CC0</span><span class="p">,</span>
        <span class="n">CC_BY</span><span class="p">,</span>
        <span class="n">CC_BY_SA</span><span class="p">,</span>
        <span class="n">CC_BY_ND</span><span class="p">,</span>
        <span class="n">CC_BY_NC</span><span class="p">,</span>
        <span class="n">CC_BY_NC_SA</span><span class="p">,</span>
        <span class="n">CC_BY_NC_ND</span><span class="p">,</span>
        <span class="n">GENERIC_OPEN_ACCESS</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># These open access rights allow derivative works to be created, but may</span>
    <span class="c1"># require attribution or prohibit commercial use.</span>
    <span class="n">ALLOWS_DERIVATIVES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PUBLIC_DOMAIN_USA</span><span class="p">,</span>
        <span class="n">CC0</span><span class="p">,</span>
        <span class="n">CC_BY</span><span class="p">,</span>
        <span class="n">CC_BY_SA</span><span class="p">,</span>
        <span class="n">CC_BY_NC</span><span class="p">,</span>
        <span class="n">CC_BY_NC_SA</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">NAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">IN_COPYRIGHT</span><span class="p">:</span> <span class="s2">&quot;In Copyright&quot;</span><span class="p">,</span>
        <span class="n">PUBLIC_DOMAIN_USA</span><span class="p">:</span> <span class="s2">&quot;Public domain in the USA&quot;</span><span class="p">,</span>
        <span class="n">CC0</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Public Domain Dedication (CC0)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution (CC BY)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY_SA</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution-ShareAlike (CC BY-SA)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY_ND</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution-NoDerivs (CC BY-ND)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY_NC</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution-NonCommercial (CC BY-NC)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY_NC_SA</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution-NonCommercial-ShareAlike (CC BY-NC-SA)&quot;</span><span class="p">,</span>
        <span class="n">CC_BY_NC_ND</span><span class="p">:</span> <span class="s2">&quot;Creative Commons Attribution-NonCommercial-NoDerivs (CC BY-NC-ND)&quot;</span><span class="p">,</span>
        <span class="n">GENERIC_OPEN_ACCESS</span><span class="p">:</span> <span class="s2">&quot;Open access with no specific license&quot;</span><span class="p">,</span>
        <span class="n">UNKNOWN</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">DATA_SOURCE_DEFAULT_RIGHTS_STATUS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">:</span> <span class="n">PUBLIC_DOMAIN_USA</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">PLYMPTON</span><span class="p">:</span> <span class="n">CC_BY_NC</span><span class="p">,</span>
        <span class="c1"># workaround for opds-imported license pools with &#39;content server&#39; as data source</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">OA_CONTENT_SERVER</span> <span class="p">:</span> <span class="n">GENERIC_OPEN_ACCESS</span><span class="p">,</span>

        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">OVERDRIVE</span><span class="p">:</span> <span class="n">IN_COPYRIGHT</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">:</span> <span class="n">IN_COPYRIGHT</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">:</span> <span class="n">IN_COPYRIGHT</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;rightsstatus&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A URI unique to the license. This may be a URL (e.g. Creative</span>
    <span class="c1"># Commons)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Human-readable name of the license.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One RightsStatus may apply to many LicensePoolDeliveryMechanisms.</span>
    <span class="n">licensepooldeliverymechanisms</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;LicensePoolDeliveryMechanism&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;rights_status&quot;</span><span class="p">)</span>

    <span class="c1"># One RightsStatus may apply to many Resources.</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Resource&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;rights_status&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RightsStatus.lookup"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.RightsStatus.lookup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">NAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">create_method_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">RightsStatus</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="n">create_method_kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="RightsStatus.rights_uri_from_string"><a class="viewcode-back" href="../../../core.model.html#core.model.licensing.RightsStatus.rights_uri_from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rights_uri_from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rights</span><span class="p">):</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">rights</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;public domain in the usa.&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">PUBLIC_DOMAIN_USA</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;public domain in the united states.&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">PUBLIC_DOMAIN_USA</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;pd-us&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">PUBLIC_DOMAIN_USA</span>
        <span class="k">elif</span> <span class="n">rights</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;public domain&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">PUBLIC_DOMAIN_UNKNOWN</span>
        <span class="k">elif</span> <span class="n">rights</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;copyrighted.&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc0&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC0</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by-sa&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY_SA</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by-nd&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY_ND</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by-nc&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY_NC</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by-nc-sa&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY_NC_SA</span>
        <span class="k">elif</span> <span class="n">rights</span> <span class="o">==</span> <span class="s1">&#39;cc by-nc-nd&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">CC_BY_NC_ND</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">rights</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
              <span class="ow">or</span> <span class="n">rights</span> <span class="o">==</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">UNKNOWN</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../model.html">core.model</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>