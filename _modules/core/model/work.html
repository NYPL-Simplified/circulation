
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.model.work &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.model.work</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1"># WorkGenre, Work</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Enum</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Numeric</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">INT4RANGE</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.associationproxy</span> <span class="kn">import</span> <span class="n">association_proxy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">contains_eager</span><span class="p">,</span>
    <span class="n">relationship</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
    <span class="n">select</span><span class="p">,</span>
    <span class="n">join</span><span class="p">,</span>
    <span class="n">literal_column</span><span class="p">,</span>
    <span class="n">case</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.functions</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataSourceConstants</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.contributor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Contribution</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.coverage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CoverageRecord</span><span class="p">,</span>
    <span class="n">WorkCoverageRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.datasource</span> <span class="kn">import</span> <span class="n">DataSource</span>
<span class="kn">from</span> <span class="nn">.edition</span> <span class="kn">import</span> <span class="n">Edition</span>
<span class="kn">from</span> <span class="nn">.identifier</span> <span class="kn">import</span> <span class="n">Identifier</span>
<span class="kn">from</span> <span class="nn">.measurement</span> <span class="kn">import</span> <span class="n">Measurement</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">flush</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">numericrange_to_string</span><span class="p">,</span>
    <span class="n">numericrange_to_tuple</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">tuple_to_numericrange</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..classifier</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Classifier</span><span class="p">,</span>
    <span class="n">WorkClassifier</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">CannotLoadConfiguration</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>
<span class="kn">from</span> <span class="nn">..util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="WorkGenre"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.WorkGenre">[docs]</a><span class="k">class</span> <span class="nc">WorkGenre</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An assignment of a genre to a work.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;workgenres&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">genre_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;genres.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">work_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;works.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">affinity</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="WorkGenre.from_genre"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.WorkGenre.from_genre">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">genre</span><span class="p">):</span>
        <span class="n">wg</span> <span class="o">=</span> <span class="n">WorkGenre</span><span class="p">()</span>
        <span class="n">wg</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="n">genre</span>
        <span class="k">return</span> <span class="n">wg</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d%%</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span></div>


<div class="viewcode-block" id="Work"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work">[docs]</a><span class="k">class</span> <span class="nc">Work</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">APPEALS_URI</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/appeals/&quot;</span>

    <span class="n">CHARACTER_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Character&quot;</span>
    <span class="n">LANGUAGE_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Language&quot;</span>
    <span class="n">SETTING_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Setting&quot;</span>
    <span class="n">STORY_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Story&quot;</span>
    <span class="n">UNKNOWN_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="n">NOT_APPLICABLE_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;Not Applicable&quot;</span>
    <span class="n">NO_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

    <span class="n">CURRENTLY_AVAILABLE</span> <span class="o">=</span> <span class="s2">&quot;currently_available&quot;</span>
    <span class="n">ALL</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

    <span class="c1"># If no quality data is available for a work, it will be assigned</span>
    <span class="c1"># a default quality based on where we got it.</span>
    <span class="c1">#</span>
    <span class="c1"># The assumption is that a librarian would not have ordered a book</span>
    <span class="c1"># if it didn&#39;t meet a minimum level of quality.</span>
    <span class="c1">#</span>
    <span class="c1"># For data sources where librarians tend to order big packages of</span>
    <span class="c1"># books instead of selecting individual titles, the default</span>
    <span class="c1"># quality is lower. For data sources where there is no curation at</span>
    <span class="c1"># all, the default quality is zero.</span>
    <span class="c1">#</span>
    <span class="c1"># If there is absolutely no way to get quality data for a curated</span>
    <span class="c1"># data source, each work is assigned the minimum level of quality</span>
    <span class="c1"># necessary to show up in featured feeds.</span>
    <span class="n">default_quality_by_data_source</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">OVERDRIVE</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">BIBLIOTHECA</span> <span class="p">:</span> <span class="mf">0.65</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">STANDARD_EBOOKS</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">UNGLUE_IT</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
        <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">PLYMPTON</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;works&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One Work may have copies scattered across many LicensePools.</span>
    <span class="n">license_pools</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;LicensePool&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;work&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>

    <span class="c1"># A Work takes its presentation metadata from a single Edition.</span>
    <span class="c1"># But this Edition is a composite of provider, metadata wrangler, admin interface, etc.-derived Editions.</span>
    <span class="n">presentation_edition_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;editions.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># One Work may have many associated WorkCoverageRecords.</span>
    <span class="n">coverage_records</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;WorkCoverageRecord&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;work&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span>
    <span class="p">)</span>

    <span class="c1"># One Work may be associated with many CustomListEntries.</span>
    <span class="c1"># However, a CustomListEntry may lose its Work without</span>
    <span class="c1"># ceasing to exist.</span>
    <span class="n">custom_list_entries</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;CustomListEntry&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;work&#39;</span><span class="p">)</span>

    <span class="c1"># One Work may have multiple CachedFeeds, and if a CachedFeed</span>
    <span class="c1"># loses its Work, it ceases to exist.</span>
    <span class="n">cached_feeds</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;CachedFeed&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;work&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span>
    <span class="p">)</span>

    <span class="c1"># One Work may participate in many WorkGenre assignments.</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s1">&#39;work_genres&#39;</span><span class="p">,</span> <span class="s1">&#39;genre&#39;</span><span class="p">,</span>
                               <span class="n">creator</span><span class="o">=</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">from_genre</span><span class="p">)</span>
    <span class="n">work_genres</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;WorkGenre&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;work&quot;</span><span class="p">,</span>
                               <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">)</span>
    <span class="n">audience</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target_age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">INT4RANGE</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fiction</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">summary_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span>
            <span class="s1">&#39;resources.id&#39;</span><span class="p">,</span> <span class="n">use_alter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fk_works_summary_id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># This gives us a convenient place to store a cleaned-up version of</span>
    <span class="c1"># the content of the summary Resource.</span>
    <span class="n">summary_text</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="c1"># The overall suitability of this work for unsolicited</span>
    <span class="c1"># presentation to a patron. This is a calculated value taking both</span>
    <span class="c1"># rating and popularity into account.</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Numeric</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The overall rating given to this work.</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The overall current popularity of this work.</span>
    <span class="n">popularity</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">appeal_type</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="n">CHARACTER_APPEAL</span><span class="p">,</span> <span class="n">LANGUAGE_APPEAL</span><span class="p">,</span> <span class="n">SETTING_APPEAL</span><span class="p">,</span>
                       <span class="n">STORY_APPEAL</span><span class="p">,</span> <span class="n">NOT_APPLICABLE_APPEAL</span><span class="p">,</span> <span class="n">NO_APPEAL</span><span class="p">,</span>
                       <span class="n">UNKNOWN_APPEAL</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;appeal&quot;</span><span class="p">)</span>

    <span class="n">primary_appeal</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">appeal_type</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">secondary_appeal</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">appeal_type</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">appeal_character</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">appeal_language</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">appeal_setting</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">appeal_story</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The last time the availability or metadata changed for this Work.</span>
    <span class="n">last_update_time</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># This is set to True once all metadata and availability</span>
    <span class="c1"># information has been obtained for this Work. Until this is True,</span>
    <span class="c1"># the work will not show up in feeds.</span>
    <span class="n">presentation_ready</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># This is the last time we tried to make this work presentation ready.</span>
    <span class="n">presentation_ready_attempt</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># This is the error that occured while trying to make this Work</span>
    <span class="c1"># presentation ready. Until this is cleared, no further attempt</span>
    <span class="c1"># will be made to make the Work presentation ready.</span>
    <span class="n">presentation_ready_exception</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A precalculated OPDS entry containing all metadata about this</span>
    <span class="c1"># work that would be relevant to display to a library patron.</span>
    <span class="n">simple_opds_entry</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># A precalculated OPDS entry containing all metadata about this</span>
    <span class="c1"># work that would be relevant to display in a machine-to-machine</span>
    <span class="c1"># integration context.</span>
    <span class="n">verbose_opds_entry</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># A precalculated MARC record containing metadata about this</span>
    <span class="c1"># work that would be relevant to display in a library&#39;s public</span>
    <span class="c1"># catalog.</span>
    <span class="n">marc_record</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># These fields are potentially large and can be deferred if you</span>
    <span class="c1"># don&#39;t need all the data in a Work.</span>
    <span class="n">LARGE_FIELDS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;simple_opds_entry&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose_opds_entry&#39;</span><span class="p">,</span> <span class="s1">&#39;marc_record&#39;</span><span class="p">,</span>
        <span class="s1">&#39;summary_text&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sort_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">sort_title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">subtitle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">series</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">series_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">series_position</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">author</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">author</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sort_author</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">author</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">language</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">language</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">language_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">language_code</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">publisher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">publisher</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">imprint</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cover_full_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">cover_full_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cover_thumbnail_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">cover_thumbnail_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target_age_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numericrange_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_open_access_license</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">open_access</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">complaints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">complaints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="p">[</span><span class="n">complaints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">complaints</span><span class="p">)</span> <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">complaints</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Work #</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot; (by </span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1"> lang=</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> lp)&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Work.missing_coverage_from"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.missing_coverage_from">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">missing_coverage_from</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_as_covered</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">count_as_missing_before</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find Works which have no WorkCoverageRecord for the given</span>
<span class="sd">        `operation`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">work_id</span><span class="p">,</span>
                      <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">operation</span><span class="o">==</span><span class="n">operation</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">WorkCoverageRecord</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">not_covered</span><span class="p">(</span>
            <span class="n">count_as_covered</span><span class="p">,</span> <span class="n">count_as_missing_before</span>
        <span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q2</span></div>

<div class="viewcode-block" id="Work.for_unchecked_subjects"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.for_unchecked_subjects">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">for_unchecked_subjects</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Classification</span><span class="p">,</span>
            <span class="n">Subject</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>
        <span class="sd">&quot;&quot;&quot;Find all Works whose LicensePools have an Identifier that</span>
<span class="sd">        is classified under an unchecked Subject.</span>
<span class="sd">        This is a good indicator that the Work needs to be</span>
<span class="sd">        reclassified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">classifications</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">Classification</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">checked</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_potential_open_access_works_for_permanent_work_id</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all Works that might be suitable for use as the</span>
<span class="sd">        canonical open-access Work for the given `pwid`, `medium`,</span>
<span class="sd">        and `language`.</span>
<span class="sd">        :return: A 2-tuple (pools, counts_by_work). `pools` is a set</span>
<span class="sd">        containing all affected LicensePools; `counts_by_work is a</span>
<span class="sd">        Counter tallying the number of affected LicensePools</span>
<span class="sd">        associated with a given work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="o">==</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="o">==</span><span class="n">pwid</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="o">==</span><span class="n">medium</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">language</span><span class="o">==</span><span class="n">language</span>
            <span class="p">)</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">qu</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Build the Counter of Works that are eligible to represent</span>
        <span class="c1"># this pwid/medium/language combination.</span>
        <span class="n">affected_licensepools_for_work</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">work</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lp</span><span class="o">.</span><span class="n">work</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">affected_licensepools_for_work</span><span class="p">[</span><span class="n">lp</span><span class="o">.</span><span class="n">work</span><span class="p">]:</span>
                <span class="c1"># We already got this information earlier in the loop.</span>
                <span class="k">continue</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="k">if</span> <span class="n">pe</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">pe</span><span class="o">.</span><span class="n">language</span> <span class="o">!=</span> <span class="n">language</span> <span class="ow">or</span> <span class="n">pe</span><span class="o">.</span><span class="n">medium</span> <span class="o">!=</span> <span class="n">medium</span>
                    <span class="ow">or</span> <span class="n">pe</span><span class="o">.</span><span class="n">permanent_work_id</span> <span class="o">!=</span> <span class="n">pwid</span>
            <span class="p">):</span>
                <span class="c1"># This Work&#39;s presentation edition doesn&#39;t match</span>
                <span class="c1"># this LicensePool&#39;s presentation edition.</span>
                <span class="c1"># It would be better to create a brand new Work and</span>
                <span class="c1"># remove this LicensePool from its current Work.</span>
                <span class="k">continue</span>
            <span class="n">affected_licensepools_for_work</span><span class="p">[</span><span class="n">lp</span><span class="o">.</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pools</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">work</span> <span class="o">==</span> <span class="n">lp</span><span class="o">.</span><span class="n">work</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pools</span><span class="p">,</span> <span class="n">affected_licensepools_for_work</span>

<div class="viewcode-block" id="Work.open_access_for_permanent_work_id"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.open_access_for_permanent_work_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">open_access_for_permanent_work_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create the Work encompassing all open-access LicensePools</span>
<span class="sd">        whose presentation Editions have the given permanent work ID,</span>
<span class="sd">        the given medium, and the given language.</span>
<span class="sd">        This may result in the consolidation or splitting of Works, if</span>
<span class="sd">        a book&#39;s permanent work ID has changed without</span>
<span class="sd">        calculate_work() being called, or if the data is in an</span>
<span class="sd">        inconsistent state for any other reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">licensepools</span><span class="p">,</span> <span class="n">licensepools_for_work</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_potential_open_access_works_for_permanent_work_id</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">licensepools</span><span class="p">:</span>
            <span class="c1"># There is no work for this PWID/medium/language combination</span>
            <span class="c1"># because no LicensePools offer it.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_new</span>

        <span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">licensepools_for_work</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># None of these LicensePools have a Work. Create a new one.</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">()</span>
            <span class="n">is_new</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Pick the Work with the most LicensePools.</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">licensepools_for_work</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># In the simple case, there will only be the one Work.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">licensepools_for_work</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># But in this case, for whatever reason (probably bad</span>
                <span class="c1"># data caused by a bug) there&#39;s more than one</span>
                <span class="c1"># Work. Merge the other Works into the one we chose</span>
                <span class="c1"># earlier.  (This is why we chose the work with the</span>
                <span class="c1"># most LicensePools--it minimizes the disruption</span>
                <span class="c1"># here.)</span>

                <span class="c1"># First, make sure this Work is the exclusive</span>
                <span class="c1"># open-access work for its permanent work ID.</span>
                <span class="c1"># Otherwise the merge may fail.</span>
                <span class="n">work</span><span class="o">.</span><span class="n">make_exclusive_open_access_for_permanent_work_id</span><span class="p">(</span>
                    <span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">needs_merge</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">licensepools_for_work</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">needs_merge</span> <span class="o">!=</span> <span class="n">work</span><span class="p">:</span>

                        <span class="c1"># Make sure that Work we&#39;re about to merge has</span>
                        <span class="c1"># nothing but LicensePools whose permanent</span>
                        <span class="c1"># work ID matches the permanent work ID of the</span>
                        <span class="c1"># Work we&#39;re about to merge into.</span>
                        <span class="n">needs_merge</span><span class="o">.</span><span class="n">make_exclusive_open_access_for_permanent_work_id</span><span class="p">(</span><span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
                        <span class="n">needs_merge</span><span class="o">.</span><span class="n">merge_into</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="c1"># At this point we have one, and only one, Work for this</span>
        <span class="c1"># permanent work ID. Assign it to every LicensePool whose</span>
        <span class="c1"># presentation Edition has that permanent work ID/medium/language</span>
        <span class="c1"># combination.</span>
        <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">licensepools</span><span class="p">:</span>
            <span class="n">lp</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>
        <span class="k">return</span> <span class="n">work</span><span class="p">,</span> <span class="n">is_new</span></div>

<div class="viewcode-block" id="Work.make_exclusive_open_access_for_permanent_work_id"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.make_exclusive_open_access_for_permanent_work_id">[docs]</a>    <span class="k">def</span> <span class="nf">make_exclusive_open_access_for_permanent_work_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwid</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that every open-access LicensePool associated with this Work</span>
<span class="sd">        has the given PWID and medium. Any non-open-access</span>
<span class="sd">        LicensePool, and any LicensePool with a different PWID or a</span>
<span class="sd">        different medium, is kicked out and assigned to a different</span>
<span class="sd">        Work. LicensePools with no presentation edition or no PWID</span>
<span class="sd">        are kicked out.</span>
<span class="sd">        In most cases this Work will be the _only_ work for this PWID,</span>
<span class="sd">        but inside open_access_for_permanent_work_id this is called as</span>
<span class="sd">        a preparatory step for merging two Works, and after the call</span>
<span class="sd">        (but before the merge) there may be two Works for a given PWID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">):</span>
            <span class="n">other_work</span> <span class="o">=</span> <span class="n">is_new</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                <span class="c1"># This needs to have its own Work--we don&#39;t mix</span>
                <span class="c1"># open-access and commercial versions of the same book.</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">other_work</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
                <span class="c1"># A LicensePool with no presentation edition</span>
                <span class="c1"># cannot have an associated Work.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;LicensePool </span><span class="si">%r</span><span class="s2"> has no presentation edition, setting .work to None.&quot;</span><span class="p">,</span>
                    <span class="n">pool</span>
                <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span>
                <span class="n">this_pwid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">permanent_work_id</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">this_pwid</span><span class="p">:</span>
                    <span class="c1"># A LicensePool with no permanent work ID</span>
                    <span class="c1"># cannot have an associated Work.</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Presentation edition for LicensePool </span><span class="si">%r</span><span class="s2"> has no PWID, setting .work to None.&quot;</span><span class="p">,</span>
                        <span class="n">pool</span>
                    <span class="p">)</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">this_pwid</span> <span class="o">!=</span> <span class="n">pwid</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">medium</span> <span class="o">!=</span> <span class="n">medium</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">language</span> <span class="o">!=</span> <span class="n">language</span><span class="p">:</span>
                    <span class="c1"># This LicensePool should not belong to this Work.</span>
                    <span class="c1"># Make sure it gets its own Work, creating a new one</span>
                    <span class="c1"># if necessary.</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">other_work</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">open_access_for_permanent_work_id</span><span class="p">(</span>
                        <span class="n">_db</span><span class="p">,</span> <span class="n">this_pwid</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">language</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">other_work</span> <span class="ow">and</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="n">other_work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pwids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of permanent work IDs associated with this Work.</span>
<span class="sd">        There should only be one permanent work ID associated with a</span>
<span class="sd">        given work, but if there is more than one, this will find all</span>
<span class="sd">        of them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="ow">and</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">:</span>
                <span class="n">pwids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pwids</span>

<div class="viewcode-block" id="Work.merge_into"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.merge_into">[docs]</a>    <span class="k">def</span> <span class="nf">merge_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge this Work into another Work and delete it.&quot;&quot;&quot;</span>

        <span class="c1"># Neither the source nor the destination work may have any</span>
        <span class="c1"># non-open-access LicensePools.</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other_work</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

                        <span class="s2">&quot;Refusing to merge </span><span class="si">%r</span><span class="s2"> into </span><span class="si">%r</span><span class="s2"> because it would put an open-access LicensePool into the same work as a non-open-access LicensePool.&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_work</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="n">my_pwids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwids</span>
        <span class="n">other_pwids</span> <span class="o">=</span> <span class="n">other_work</span><span class="o">.</span><span class="n">pwids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">my_pwids</span> <span class="o">==</span> <span class="n">other_pwids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Refusing to merge </span><span class="si">%r</span><span class="s2"> into </span><span class="si">%r</span><span class="s2"> because permanent work IDs don&#39;t match: </span><span class="si">%s</span><span class="s2"> vs. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">other_work</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">my_pwids</span><span class="p">)),</span>
                    <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">other_pwids</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Every LicensePool associated with this work becomes</span>
        <span class="c1"># associated instead with the other work.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="n">other_work</span><span class="o">.</span><span class="n">license_pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

        <span class="c1"># All WorkGenres and WorkCoverageRecords for this Work are</span>
        <span class="c1"># deleted. (WorkGenres are deleted via cascade.)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">:</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">other_work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span></div>

<div class="viewcode-block" id="Work.set_summary"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.set_summary">[docs]</a>    <span class="k">def</span> <span class="nf">set_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="c1"># TODO: clean up the content</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">unicode_content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">SUMMARY_OPERATION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.with_genre"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.with_genre">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">genre</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all Works classified under the given genre.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="n">Genre</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">genre</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">genre</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WorkGenre</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">genre</span><span class="o">==</span><span class="n">genre</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.with_no_genres"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.with_no_genres">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_no_genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify a query so it finds only Works that are not classified under</span>
<span class="sd">        any genre.&quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">work_genres</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">contains_eager</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">work_genres</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">genre</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="Work.from_identifiers"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.from_identifiers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_identifiers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">base_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns all of the works that have one or more license_pools</span>
<span class="sd">        associated with either an identifier in the given list or an</span>
<span class="sd">        identifier considered equivalent to one of those listed.</span>

<span class="sd">        :param policy: A PresentationCalculationPolicy, used to</span>
<span class="sd">           determine how far to go when looking for equivalent</span>
<span class="sd">           Identifiers. By default, this method will be very strict</span>
<span class="sd">           about equivalencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>
        <span class="n">identifier_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_query</span><span class="p">:</span>
            <span class="c1"># A raw base query that makes no accommodations for works that are</span>
            <span class="c1"># suppressed or otherwise undeliverable.</span>
            <span class="n">base_query</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
                <span class="n">equivalent_identifier_levels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">equivalent_identifier_threshold</span><span class="o">=</span><span class="mf">0.999</span>
            <span class="p">)</span>

        <span class="n">identifier_ids_subquery</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">recursively_equivalent_identifier_ids_query</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">identifier_ids_subquery</span> <span class="o">=</span> <span class="n">identifier_ids_subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids</span><span class="p">))</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids_subquery</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="Work.reject_covers"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.reject_covers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reject_covers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">works_or_identifiers</span><span class="p">,</span>
                        <span class="n">search_index_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suppresses the currently visible covers of a number of Works&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>
        <span class="kn">from</span> <span class="nn">.resource</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Resource</span><span class="p">,</span>
            <span class="n">Hyperlink</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">works</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">works_or_identifiers</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">works</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="c1"># This assumes that everything in the provided list is the</span>
            <span class="c1"># same class: either Work or Identifier.</span>
            <span class="n">works</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_identifiers</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">works_or_identifiers</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">work_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">works</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">works</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Suppressing cover for </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">works</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Supressing covers for </span><span class="si">%i</span><span class="s2"> Works&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">works</span><span class="p">))</span>

        <span class="n">cover_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
            <span class="c1"># Create a list of the URLs of the works&#39; active cover images.</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="k">if</span> <span class="n">edition</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">:</span>
                    <span class="n">cover_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">:</span>
                    <span class="n">cover_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cover_urls</span><span class="p">:</span>
            <span class="c1"># All of the target Works have already had their</span>
            <span class="c1"># covers suppressed. Nothing to see here.</span>
            <span class="k">return</span>

        <span class="n">covers</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Resource</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">cover_urls</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">work_ids</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">editions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cover</span> <span class="ow">in</span> <span class="n">covers</span><span class="p">:</span>
            <span class="c1"># Record a downvote that will dismiss the Resource.</span>
            <span class="n">cover</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cover</span><span class="o">.</span><span class="n">cover_editions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">editions</span> <span class="o">+=</span> <span class="n">cover</span><span class="o">.</span><span class="n">cover_editions</span>
        <span class="n">flush</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="n">editions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">editions</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">editions</span><span class="p">:</span>
            <span class="c1"># More Editions and Works have been impacted by this cover</span>
            <span class="c1"># suppression.</span>
            <span class="n">works</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ed</span><span class="o">.</span><span class="n">work</span> <span class="k">for</span> <span class="n">ed</span> <span class="ow">in</span> <span class="n">editions</span> <span class="k">if</span> <span class="n">ed</span><span class="o">.</span><span class="n">work</span><span class="p">]</span>
            <span class="n">editions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ed</span> <span class="k">for</span> <span class="n">ed</span> <span class="ow">in</span> <span class="n">editions</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ed</span><span class="o">.</span><span class="n">work</span><span class="p">]</span>

        <span class="c1"># Remove the cover from the Work and its Edition and reset</span>
        <span class="c1"># cached OPDS entries.</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="o">.</span><span class="n">reset_cover</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span>
                <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="n">search_index_client</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
            <span class="n">edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Work.reject_cover"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.reject_cover">[docs]</a>    <span class="k">def</span> <span class="nf">reject_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suppresses the current cover of the Work&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_covers</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">search_index_client</span><span class="o">=</span><span class="n">search_index_client</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.all_editions"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.all_editions">[docs]</a>    <span class="k">def</span> <span class="nf">all_editions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All Editions identified by an Identifier equivalent to</span>
<span class="sd">        the identifiers of this Work&#39;s license pools.</span>

<span class="sd">        :param policy: A PresentationCalculationPolicy, used to</span>
<span class="sd">           determine how far to go when looking for equivalent</span>
<span class="sd">           Identifiers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">identifier_ids_subquery</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">recursively_equivalent_identifier_ids_query</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span>
        <span class="p">)</span>
        <span class="n">identifier_ids_subquery</span> <span class="o">=</span> <span class="n">identifier_ids_subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids_subquery</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_direct_identifier_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Identifier IDs associated with one of this</span>
<span class="sd">        Work&#39;s LicensePools.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">lp</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span>
            <span class="k">if</span> <span class="n">lp</span><span class="o">.</span><span class="n">identifier</span>
        <span class="p">]</span>

<div class="viewcode-block" id="Work.all_identifier_ids"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.all_identifier_ids">[docs]</a>    <span class="k">def</span> <span class="nf">all_identifier_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Identifier IDs associated with this Work.</span>

<span class="sd">        :param policy: A `PresentationCalculationPolicy`.</span>
<span class="sd">        :return: A set containing all Identifier IDs associated</span>
<span class="sd">             with this Work (as per the rules set down in `policy`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Get a dict that maps identifier ids to lists of their equivalents.</span>
        <span class="n">equivalent_lists</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">recursively_equivalent_identifier_ids</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_identifier_ids</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span>
        <span class="p">)</span>

        <span class="n">all_identifier_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">equivs</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">equivalent_lists</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">all_identifier_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">equivs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_identifier_ids</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">language_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A single 2-letter language code for display purposes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span>
        <span class="k">if</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">three_to_two</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">three_to_two</span><span class="p">[</span><span class="n">language</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">language</span>

<div class="viewcode-block" id="Work.age_appropriate_for_patron"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.age_appropriate_for_patron">[docs]</a>    <span class="k">def</span> <span class="nf">age_appropriate_for_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this Work age-appropriate for the given Patron?</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :return: A boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">patron</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">patron</span><span class="o">.</span><span class="n">work_is_age_appropriate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.set_presentation_edition"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.set_presentation_edition">[docs]</a>    <span class="k">def</span> <span class="nf">set_presentation_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_presentation_edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets presentation edition and lets owned pools and editions know.</span>
<span class="sd">            Raises exception if edition to set to is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># only bother if something changed, or if were explicitly told to</span>
        <span class="c1"># set (useful for setting to None)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_presentation_edition</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Trying to set presentation_edition to None on Work [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="o">=</span> <span class="n">new_presentation_edition</span>

        <span class="c1"># if the edition is the presentation edition for any license</span>
        <span class="c1"># pools, let them know they have a Work.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">is_presentation_for</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Work.calculate_presentation_edition"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.calculate_presentation_edition">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_presentation_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Which of this Work&#39;s Editions should be used as the default?</span>
<span class="sd">        First, every LicensePool associated with this work must have</span>
<span class="sd">        its presentation edition set.</span>
<span class="sd">        Then, we go through the pools, see which has the best presentation edition,</span>
<span class="sd">        and make it our presentation edition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span> <span class="ow">or</span> <span class="n">PresentationCalculationPolicy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="o">.</span><span class="n">choose_edition</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">changed</span>

        <span class="c1"># For each owned edition, see if its LicensePool was superceded or suppressed</span>
        <span class="c1"># if yes, the edition is unlikely to be the best.</span>
        <span class="c1"># An open access pool may be &quot;superceded&quot;, if there&#39;s a better-quality</span>
        <span class="c1"># open-access pool available.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mark_licensepools_as_superceded</span><span class="p">()</span>
        <span class="n">edition_metadata_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">old_presentation_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="n">new_presentation_edition</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="c1"># a superceded pool&#39;s composite edition is not good enough</span>
            <span class="c1"># Note:  making the assumption here that we won&#39;t have a situation</span>
            <span class="c1"># where we marked all of the work&#39;s pools as superceded or suppressed.</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span> <span class="ow">or</span> <span class="n">pool</span><span class="o">.</span><span class="n">suppressed</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># make sure the pool has most up-to-date idea of its presentation edition,</span>
            <span class="c1"># and then ask what it is.</span>
            <span class="n">pool_edition_changed</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">()</span>
            <span class="n">edition_metadata_changed</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">edition_metadata_changed</span> <span class="ow">or</span>
                <span class="n">pool_edition_changed</span>
            <span class="p">)</span>
            <span class="n">potential_presentation_edition</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span>

            <span class="c1"># We currently have no real way to choose between</span>
            <span class="c1"># competing presentation editions. But it doesn&#39;t matter much</span>
            <span class="c1"># because in the current system there should never be more</span>
            <span class="c1"># than one non-superceded license pool per Work.</span>
            <span class="c1">#</span>
            <span class="c1"># So basically we pick the first available edition and</span>
            <span class="c1"># make it the presentation edition.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">new_presentation_edition</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">potential_presentation_edition</span> <span class="ow">is</span> <span class="n">old_presentation_edition</span> <span class="ow">and</span> <span class="n">old_presentation_edition</span><span class="p">)):</span>
                <span class="c1"># We would prefer not to change the Work&#39;s presentation</span>
                <span class="c1"># edition unnecessarily, so if the current presentation</span>
                <span class="c1"># edition is still an option, choose it.</span>
                <span class="n">new_presentation_edition</span> <span class="o">=</span> <span class="n">potential_presentation_edition</span>

        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="o">!=</span> <span class="n">new_presentation_edition</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new_presentation_edition</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># did we find a pool whose presentation edition was better than the work&#39;s?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">(</span><span class="n">new_presentation_edition</span><span class="p">)</span>

        <span class="c1"># tell everyone else we tried to set work&#39;s presentation edition</span>
        <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">CHOOSE_EDITION_OPERATION</span>
        <span class="p">)</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">edition_metadata_changed</span> <span class="ow">or</span>
            <span class="n">old_presentation_edition</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">changed</span></div>

    <span class="k">def</span> <span class="nf">_get_default_audience</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default audience.</span>

<span class="sd">        :return: Default audience</span>
<span class="sd">        :rtype: Optional[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">license_pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">default_audience</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">default_audience</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Work.calculate_presentation"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.calculate_presentation">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_presentation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_audience</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a Work ready to show to patrons.</span>
<span class="sd">        Call calculate_presentation_edition() to find the best-quality presentation edition</span>
<span class="sd">        that could represent this work.</span>
<span class="sd">        Then determine the following information, global to the work:</span>
<span class="sd">        * Subject-matter classifications for the work.</span>
<span class="sd">        * Whether or not the work is fiction.</span>
<span class="sd">        * The intended audience for the work.</span>
<span class="sd">        * The best available summary for the work.</span>
<span class="sd">        * The overall popularity of the work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">default_audience</span><span class="p">:</span>
            <span class="n">default_audience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_audience</span><span class="p">()</span>

        <span class="c1"># Gather information up front so we can see if anything</span>
        <span class="c1"># actually changed.</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">edition_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">classification_changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span> <span class="ow">or</span> <span class="n">PresentationCalculationPolicy</span><span class="p">()</span>

        <span class="n">edition_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_presentation_edition</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="c1"># Without a presentation edition, we can&#39;t calculate presentation</span>
            <span class="c1"># for the work.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">choose_cover</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">set_edition_metadata</span><span class="p">:</span>
            <span class="n">cover_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
            <span class="n">edition_changed</span> <span class="o">=</span> <span class="n">edition_changed</span> <span class="ow">or</span> <span class="n">cover_changed</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>
        <span class="n">summary_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality</span>

        <span class="c1"># If we find a cover or description that comes direct from a</span>
        <span class="c1"># license source, it may short-circuit the process of finding</span>
        <span class="c1"># a good cover or description.</span>
        <span class="n">licensed_data_sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="c1"># Descriptions from Gutenberg are useless, so we</span>
            <span class="c1"># specifically exclude it from being a privileged data</span>
            <span class="c1"># source.</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">:</span>
                <span class="n">licensed_data_sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">classify</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">choose_summary</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">calculate_quality</span><span class="p">:</span>
            <span class="c1"># Find all related IDs that might have associated descriptions,</span>
            <span class="c1"># classifications, or measurements.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="n">direct_identifier_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_identifier_ids</span>
            <span class="n">all_identifier_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_identifier_ids</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Don&#39;t bother.</span>
            <span class="n">direct_identifier_ids</span> <span class="o">=</span> <span class="n">all_identifier_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">classify</span><span class="p">:</span>
            <span class="n">classification_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_genres</span><span class="p">(</span>
                <span class="n">all_identifier_ids</span><span class="p">,</span>
                <span class="n">default_fiction</span><span class="o">=</span><span class="n">default_fiction</span><span class="p">,</span>
                <span class="n">default_audience</span><span class="o">=</span><span class="n">default_audience</span>
            <span class="p">)</span>
            <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">CLASSIFY_OPERATION</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">choose_summary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_choose_summary</span><span class="p">(</span>
                <span class="n">direct_identifier_ids</span><span class="p">,</span> <span class="n">all_identifier_ids</span><span class="p">,</span>
                <span class="n">licensed_data_sources</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">calculate_quality</span><span class="p">:</span>
            <span class="c1"># In the absense of other data, we will make a rough</span>
            <span class="c1"># judgement as to the quality of a book based on the</span>
            <span class="c1"># license source. Commercial data sources have higher</span>
            <span class="c1"># default quality, because it&#39;s presumed that a librarian</span>
            <span class="c1"># put some work into deciding which books to buy.</span>
            <span class="n">default_quality</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">licensed_data_sources</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_quality_by_data_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">default_quality</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="n">default_quality</span><span class="p">:</span>
                    <span class="n">default_quality</span> <span class="o">=</span> <span class="n">q</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">default_quality</span><span class="p">:</span>
                <span class="c1"># if we still haven&#39;t found anything of a quality measurement,</span>
                <span class="c1"># then at least make it an integer zero, not none.</span>
                <span class="n">default_quality</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_quality</span><span class="p">(</span>
                <span class="n">all_identifier_ids</span><span class="p">,</span> <span class="n">default_quality</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">new_summary_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_summary_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_summary_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_text</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">edition_changed</span> <span class="ow">or</span>
            <span class="n">classification_changed</span> <span class="ow">or</span>
            <span class="n">summary</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="ow">or</span>
            <span class="n">summary_text</span> <span class="o">!=</span> <span class="n">new_summary_text</span> <span class="ow">or</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">quality</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quality</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="c1"># last_update_time tracks the last time the data actually</span>
            <span class="c1"># changed, not the last time we checked whether or not to</span>
            <span class="c1"># change it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">changed</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">regenerate_opds_entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_opds_entries</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">changed</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">regenerate_marc_record</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_marc_record</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="ow">or</span> <span class="n">policy</span><span class="o">.</span><span class="n">update_search_index</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude_search</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_index_needs_updating</span><span class="p">()</span>

        <span class="c1"># Now that everything&#39;s calculated, print it out.</span>
        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="s2">&quot;changed&quot;</span>
                <span class="n">representation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detailed_representation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: maybe change changed to a boolean, and return it as method result</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>
                <span class="n">representation</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Presentation </span><span class="si">%s</span><span class="s2"> for work: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">representation</span><span class="p">)</span>

        <span class="c1"># We want works to be presentation-ready as soon as possible,</span>
        <span class="c1"># unless they are missing crucial information like language or</span>
        <span class="c1"># title.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_presentation_ready_based_on_content</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_choose_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">direct_identifier_ids</span><span class="p">,</span> <span class="n">all_identifier_ids</span><span class="p">,</span>
        <span class="n">licensed_data_sources</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method for choosing a summary as part of presentation</span>
<span class="sd">        calculation.</span>

<span class="sd">        Summaries closer to a LicensePool, or from a more trusted source</span>
<span class="sd">        will be preferred.</span>

<span class="sd">        :param direct_identifier_ids: All IDs of Identifiers of LicensePools</span>
<span class="sd">            directly associated with this Work. Summaries associated with</span>
<span class="sd">            these IDs will be preferred. In the real world, this will happen</span>
<span class="sd">            almost all the time.</span>

<span class="sd">        :param all_identifier_ids: All IDs of Identifiers of</span>
<span class="sd">            LicensePools associated (directly or indirectly) with this</span>
<span class="sd">            Work. Summaries associated with these IDs will be</span>
<span class="sd">            used only if none are found from direct_identifier_ids.</span>

<span class="sd">        :param licensed_data_sources: A list of DataSources that should be</span>
<span class="sd">            given priority -- either because they provided the books or because</span>
<span class="sd">            they are trusted sources such as library staff.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">staff_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">DataSourceConstants</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span>
        <span class="p">)</span>
        <span class="n">data_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">staff_data_source</span><span class="p">,</span> <span class="n">licensed_data_sources</span><span class="p">]</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">id_set</span> <span class="ow">in</span> <span class="p">(</span><span class="n">direct_identifier_ids</span><span class="p">,</span> <span class="n">all_identifier_ids</span><span class="p">):</span>
            <span class="n">summary</span><span class="p">,</span> <span class="n">summaries</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">evaluate_summary_quality</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">id_set</span><span class="p">,</span> <span class="n">data_sources</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                <span class="c1"># We found a summary.</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detailed_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A description of this work more detailed than repr()&quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (by </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; language=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; quality=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">:</span>
            <span class="n">primary_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; primary id=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">primary_identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span><span class="p">:</span>
            <span class="n">fiction</span> <span class="o">=</span> <span class="s2">&quot;Fiction&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">fiction</span> <span class="o">=</span> <span class="s2">&quot;Nonfiction&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fiction</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="n">target_age</span> <span class="o">=</span> <span class="s2">&quot; age=&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_age</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%(fiction)s</span><span class="s2"> a=</span><span class="si">%(audience)s%(target_age)r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">fiction</span><span class="o">=</span><span class="n">fiction</span><span class="p">,</span>
                     <span class="n">audience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span> <span class="n">target_age</span><span class="o">=</span><span class="n">target_age</span><span class="p">)))</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">wg</span><span class="p">)</span> <span class="k">for</span> <span class="n">wg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_genres</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Full cover: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_full_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; No full cover.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Cover thumbnail: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_thumbnail_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; No thumbnail cover.&quot;</span><span class="p">)</span>

        <span class="n">downloads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">expect_downloads</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                <span class="n">expect_downloads</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span> <span class="ow">and</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">final_url</span><span class="p">:</span>
                    <span class="n">downloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">downloads</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Open-access downloads:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">downloads</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">final_url</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">expect_downloads</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Expected open-access downloads but found none.&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_ensure</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">representation</span><span class="p">:</span>
            <span class="n">snippet</span> <span class="o">=</span> <span class="n">_ensure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">content</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="s2">&quot; Description (</span><span class="si">%.2f</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">quality</span><span class="p">,</span> <span class="n">snippet</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">_ensure</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<div class="viewcode-block" id="Work.calculate_opds_entries"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.calculate_opds_entries">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_opds_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..opds</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">AcquisitionFeed</span><span class="p">,</span>
            <span class="n">Annotator</span><span class="p">,</span>
            <span class="n">VerboseAnnotator</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">simple</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">single_entry</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">Annotator</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">single_entry</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">VerboseAnnotator</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">GENERATE_OPDS_OPERATION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.calculate_marc_record"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.calculate_marc_record">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_marc_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..marc</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Annotator</span><span class="p">,</span>
            <span class="n">MARCExporter</span>
        <span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">MARCExporter</span><span class="o">.</span><span class="n">create_record</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="n">Annotator</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">GENERATE_MARC_OPERATION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.active_license_pool"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.active_license_pool">[docs]</a>    <span class="k">def</span> <span class="nf">active_license_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The active license pool is the one that *would* be</span>
        <span class="c1"># associated with a loan, were a loan to be issued right</span>
        <span class="c1"># now.</span>
        <span class="n">active_license_pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">superceded</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">best_open_access_link</span><span class="p">:</span>
                    <span class="n">active_license_pool</span> <span class="o">=</span> <span class="n">p</span>
                    <span class="c1"># We have an unlimited source for this book.</span>
                    <span class="c1"># There&#39;s no need to keep looking.</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">unlimited_access</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">:</span>
                <span class="n">active_license_pool</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">elif</span> <span class="n">edition</span> <span class="ow">and</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">active_license_pool</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">active_license_pool</span></div>

    <span class="k">def</span> <span class="nf">_reset_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put this work&#39;s WorkCoverageRecord for the given `operation`</span>
<span class="sd">        into the REGISTERED state.</span>

<span class="sd">        This is useful for erasing the record of work that was done,</span>
<span class="sd">        so that automated scripts know the work needs to be done</span>
<span class="sd">        again.</span>

<span class="sd">        :return: A WorkCoverageRecord.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">record</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">REGISTERED</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

<div class="viewcode-block" id="Work.external_index_needs_updating"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.external_index_needs_updating">[docs]</a>    <span class="k">def</span> <span class="nf">external_index_needs_updating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark this work as needing to have its search document reindexed.</span>
<span class="sd">        This is a more efficient alternative to reindexing immediately,</span>
<span class="sd">        since these WorkCoverageRecords are handled in large batches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_coverage</span><span class="p">(</span>
            <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">UPDATE_SEARCH_INDEX_OPERATION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.update_external_index"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.update_external_index">[docs]</a>    <span class="k">def</span> <span class="nf">update_external_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">add_coverage_record</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a WorkCoverageRecord so that this work&#39;s</span>
<span class="sd">        entry in the search index can be modified or deleted.</span>
<span class="sd">        This method is deprecated -- call</span>
<span class="sd">        external_index_needs_updating() instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_index_needs_updating</span><span class="p">()</span></div>

<div class="viewcode-block" id="Work.needs_full_presentation_recalculation"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.needs_full_presentation_recalculation">[docs]</a>    <span class="k">def</span> <span class="nf">needs_full_presentation_recalculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark this work as needing to have its presentation completely</span>
<span class="sd">        recalculated.</span>

<span class="sd">        This shifts the time spent recalculating presentation to a</span>
<span class="sd">        script dedicated to this purpose, rather than a script that</span>
<span class="sd">        interacts with APIs. It&#39;s also more efficient, since a work</span>
<span class="sd">        might be flagged multiple times before we actually get around</span>
<span class="sd">        to recalculating the presentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_coverage</span><span class="p">(</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">CLASSIFY_OPERATION</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.needs_new_presentation_edition"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.needs_new_presentation_edition">[docs]</a>    <span class="k">def</span> <span class="nf">needs_new_presentation_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark this work as needing to have its presentation edition</span>
<span class="sd">        regenerated. This is significantly less work than</span>
<span class="sd">        calling needs_full_presentation_recalculation, but it will</span>
<span class="sd">        not update a Work&#39;s quality score, summary, or genre classification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_coverage</span><span class="p">(</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">CHOOSE_EDITION_OPERATION</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.set_presentation_ready"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.set_presentation_ready">[docs]</a>    <span class="k">def</span> <span class="nf">set_presentation_ready</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_search</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set this work as presentation-ready, no matter what.</span>

<span class="sd">        This assumes that we know the work has the minimal information</span>
<span class="sd">        necessary to be found with typical queries and that patrons</span>
<span class="sd">        will be able to understand what work we&#39;re talking about.</span>

<span class="sd">        In most cases you should call set_presentation_ready_based_on_content</span>
<span class="sd">        instead, which runs those checks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">as_of</span> <span class="o">=</span> <span class="n">as_of</span> <span class="ow">or</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presentation_ready</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presentation_ready_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presentation_ready_attempt</span> <span class="o">=</span> <span class="n">as_of</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_search</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_index_needs_updating</span><span class="p">()</span></div>

<div class="viewcode-block" id="Work.set_presentation_ready_based_on_content"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.set_presentation_ready_based_on_content">[docs]</a>    <span class="k">def</span> <span class="nf">set_presentation_ready_based_on_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set this work as presentation ready, if it appears to</span>
<span class="sd">        be ready based on its data.</span>

<span class="sd">        Presentation ready means the book is ready to be shown to</span>
<span class="sd">        patrons and (pending availability) checked out. It doesn&#39;t</span>
<span class="sd">        necessarily mean the presentation is complete.</span>

<span class="sd">        The absolute minimum data necessary is a title, a language,</span>
<span class="sd">        and a medium. We don&#39;t need a cover or an author -- we can</span>
<span class="sd">        fill in that info later if it exists.</span>

<span class="sd">        TODO: search_index_client is redundant here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">medium</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presentation_ready</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># The next time the search index WorkCoverageRecords are</span>
            <span class="c1"># processed, this work will be removed from the search</span>
            <span class="c1"># index.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_index_needs_updating</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Work is not presentation ready: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_presentation_ready</span><span class="p">(</span><span class="n">search_index_client</span><span class="o">=</span><span class="n">search_index_client</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.calculate_quality"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.calculate_quality">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_ids</span><span class="p">,</span> <span class="n">default_quality</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Relevant Measurements are direct measurements of popularity</span>
        <span class="c1"># and quality, plus any quantity that might be mapppable to the 0..1</span>
        <span class="c1"># range -- ratings, and measurements with an associated percentile</span>
        <span class="c1"># score.</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
            <span class="n">Measurement</span><span class="o">.</span><span class="n">POPULARITY</span><span class="p">,</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">QUALITY</span><span class="p">,</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">RATING</span>
        <span class="p">])</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">quantities</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Measurement</span><span class="o">.</span><span class="n">PERCENTILE_SCALES</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Measurement</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Measurement</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Measurement</span><span class="o">.</span><span class="n">is_most_recent</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Measurement</span><span class="o">.</span><span class="n">quantity_measured</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">quantities</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">overall_quality</span><span class="p">(</span>
            <span class="n">measurements</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_quality</span><span class="p">)</span>
        <span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">WorkCoverageRecord</span><span class="o">.</span><span class="n">QUALITY_OPERATION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Work.assign_genres"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.assign_genres">[docs]</a>    <span class="k">def</span> <span class="nf">assign_genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_ids</span><span class="p">,</span> <span class="n">default_fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_audience</span><span class="o">=</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set classification information for this work based on the</span>
<span class="sd">        subquery to get equivalent identifiers.</span>
<span class="sd">        :return: A boolean explaining whether or not any data actually</span>
<span class="sd">        changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">WorkClassifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">old_fiction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span>
        <span class="n">old_audience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience</span>
        <span class="n">old_target_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">classifications</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">classifications_for_identifier_ids</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_ids</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">classification</span> <span class="ow">in</span> <span class="n">classifications</span><span class="p">:</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>

        <span class="p">(</span><span class="n">genre_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span>
         <span class="n">target_age</span><span class="p">)</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">default_fiction</span><span class="o">=</span><span class="n">default_fiction</span><span class="p">,</span>
                                           <span class="n">default_audience</span><span class="o">=</span><span class="n">default_audience</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span> <span class="o">=</span> <span class="n">tuple_to_numericrange</span><span class="p">(</span><span class="n">target_age</span><span class="p">)</span>

        <span class="n">workgenres</span><span class="p">,</span> <span class="n">workgenres_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_genres_from_weights</span><span class="p">(</span>
            <span class="n">genre_weights</span>
        <span class="p">)</span>

        <span class="n">classification_changed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">workgenres_changed</span> <span class="ow">or</span>
            <span class="n">old_fiction</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="ow">or</span>
            <span class="n">old_audience</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience</span> <span class="ow">or</span>
            <span class="n">numericrange_to_tuple</span><span class="p">(</span><span class="n">old_target_age</span><span class="p">)</span> <span class="o">!=</span> <span class="n">target_age</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">classification_changed</span></div>

<div class="viewcode-block" id="Work.assign_genres_from_weights"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.assign_genres_from_weights">[docs]</a>    <span class="k">def</span> <span class="nf">assign_genres_from_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genre_weights</span><span class="p">):</span>
        <span class="c1"># Assign WorkGenre objects to the remainder.</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="n">Genre</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">total_genre_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">genre_weights</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">workgenres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_workgenres</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">WorkGenre</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">work</span><span class="o">==</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">by_genre</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">wg</span> <span class="ow">in</span> <span class="n">current_workgenres</span><span class="p">:</span>
            <span class="n">by_genre</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">genre</span><span class="p">]</span> <span class="o">=</span> <span class="n">wg</span>
        <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">genre_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">affinity</span> <span class="o">=</span> <span class="n">score</span> <span class="o">/</span> <span class="n">total_genre_weight</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Genre</span><span class="p">):</span>
                <span class="n">g</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">by_genre</span><span class="p">:</span>
                <span class="n">wg</span> <span class="o">=</span> <span class="n">by_genre</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">del</span> <span class="n">by_genre</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wg</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">WorkGenre</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">genre</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_new</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">affinity</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">affinity</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">wg</span><span class="o">.</span><span class="n">affinity</span> <span class="o">=</span> <span class="n">affinity</span>
            <span class="n">workgenres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wg</span><span class="p">)</span>

        <span class="c1"># Any WorkGenre objects left over represent genres the Work</span>
        <span class="c1"># was once classified under, but is no longer. Delete them.</span>
        <span class="k">for</span> <span class="n">wg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">by_genre</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">wg</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># ensure that work_genres is up to date without having to read from database again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_genres</span> <span class="o">=</span> <span class="n">workgenres</span>

        <span class="k">return</span> <span class="n">workgenres</span><span class="p">,</span> <span class="n">changed</span></div>


<div class="viewcode-block" id="Work.assign_appeals"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.assign_appeals">[docs]</a>    <span class="k">def</span> <span class="nf">assign_appeals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">story</span><span class="p">,</span>
                       <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign the given appeals to the corresponding database fields,</span>
<span class="sd">        as well as calculating the primary and secondary appeal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appeal_character</span> <span class="o">=</span> <span class="n">character</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appeal_language</span> <span class="o">=</span> <span class="n">language</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appeal_setting</span> <span class="o">=</span> <span class="n">setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appeal_story</span> <span class="o">=</span> <span class="n">story</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="n">c</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CHARACTER_APPEAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">character</span>
        <span class="n">c</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LANGUAGE_APPEAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">language</span>
        <span class="n">c</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SETTING_APPEAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting</span>
        <span class="n">c</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">STORY_APPEAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">story</span>
        <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">primary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_appeal</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_appeal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_APPEAL</span>

        <span class="k">if</span> <span class="n">secondary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_appeal</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_appeal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_APPEAL</span></div>

    <span class="c1"># This can be used in func.to_char to convert a SQL datetime into a string</span>
    <span class="c1"># that Elasticsearch can parse as a date.</span>
    <span class="n">ELASTICSEARCH_TIME_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;YYYY-MM-DD&quot;T&quot;HH24:MI:SS&quot;.&quot;MS&#39;</span>

<div class="viewcode-block" id="Work.to_search_documents"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.to_search_documents">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">to_search_documents</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate search documents for these Works.</span>
<span class="sd">        This is done by constructing an extremely complicated</span>
<span class="sd">        SQL query. The code is ugly, but it&#39;s about 100 times</span>
<span class="sd">        faster than using python to create documents for</span>
<span class="sd">        each work individually. When working on the search</span>
<span class="sd">        index, it&#39;s very important for this to be fast.</span>

<span class="sd">        :param policy: A PresentationCalculationPolicy to use when</span>
<span class="sd">           deciding how deep to go to find Identifiers equivalent to</span>
<span class="sd">           these works.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">works</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">works</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># If this is a batch of search documents, postgres needs extra working</span>
        <span class="c1"># memory to process the query quickly.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">works</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;set work_mem=&#39;200MB&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># This query gets relevant columns from Work and Edition for the Works we&#39;re</span>
        <span class="c1"># interested in. The work_id, edition_id, and identifier_id columns are used</span>
        <span class="c1"># by other subqueries to filter, and the remaining columns are used directly</span>
        <span class="c1"># to create the json document.</span>
        <span class="n">works_alias</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;work_id&#39;</span><span class="p">),</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;edition_id&#39;</span><span class="p">),</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;identifier_id&#39;</span><span class="p">),</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">series</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">series_position</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">imprint</span><span class="p">,</span>
             <span class="n">Edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">fiction</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">summary_text</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">quality</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">popularity</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">presentation_ready</span><span class="p">,</span>
             <span class="n">Work</span><span class="o">.</span><span class="n">presentation_edition_id</span><span class="p">,</span>
             <span class="n">func</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                 <span class="s2">&quot;EPOCH&quot;</span><span class="p">,</span>
                 <span class="n">Work</span><span class="o">.</span><span class="n">last_update_time</span><span class="p">,</span>
             <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;last_update_time&#39;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">((</span><span class="n">w</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">works</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span>
                <span class="n">Work</span><span class="p">,</span> <span class="n">Edition</span><span class="p">,</span>
                <span class="n">Work</span><span class="o">.</span><span class="n">presentation_edition_id</span><span class="o">==</span><span class="n">Edition</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;works_alias&#39;</span><span class="p">)</span>

        <span class="n">work_id_column</span> <span class="o">=</span> <span class="n">literal_column</span><span class="p">(</span>
            <span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="n">work_presentation_edition_id_column</span> <span class="o">=</span> <span class="n">literal_column</span><span class="p">(</span>
            <span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">presentation_edition_id</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="n">work_quality_column</span> <span class="o">=</span> <span class="n">literal_column</span><span class="p">(</span>
            <span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quality</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">query_to_json</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert the results of a query to a JSON object.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">row_to_json</span><span class="p">(</span><span class="n">literal_column</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">name</span><span class="p">))]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">query_to_json_array</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert the results of a query into a JSON array.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">array_to_json</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">.</span><span class="n">array_agg</span><span class="p">(</span>
                        <span class="n">func</span><span class="o">.</span><span class="n">row_to_json</span><span class="p">(</span>
                            <span class="n">literal_column</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="p">)))]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># This subquery gets Collection IDs for collections</span>
        <span class="c1"># that own more than zero licenses for this book.</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Genre</span><span class="p">,</span>
            <span class="n">Subject</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.customlist</span> <span class="kn">import</span> <span class="n">CustomListEntry</span>
        <span class="kn">from</span> <span class="nn">.licensing</span> <span class="kn">import</span> <span class="n">LicensePool</span>

        <span class="c1"># We need information about LicensePools for a few reasons:</span>
        <span class="c1">#</span>
        <span class="c1"># * We always want to filter out Works that are not available</span>
        <span class="c1">#   in any of the collections associated with a given library</span>
        <span class="c1">#   -- either because no licenses are owned, because the</span>
        <span class="c1">#   LicensePools are suppressed, or (TODO) because there are no</span>
        <span class="c1">#   delivery mechanisms.</span>
        <span class="c1"># * A patron may want to sort a list of books by availability</span>
        <span class="c1">#   date.</span>
        <span class="c1"># * A patron may want to show only books currently available,</span>
        <span class="c1">#   or only open-access books.</span>
        <span class="c1">#</span>
        <span class="c1"># Whenever LicensePool.open_access is changed, or</span>
        <span class="c1"># licenses_available moves to zero or away from zero, the</span>
        <span class="c1"># LicensePool signals that its Work needs reindexing.</span>
        <span class="c1">#</span>
        <span class="c1"># The work quality field is stored in the main document, but</span>
        <span class="c1"># it&#39;s also stored here, so that we can apply a nested filter</span>
        <span class="c1"># that combines quality with other fields found only in the subdocument.</span>

        <span class="k">def</span> <span class="nf">explicit_bool</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="c1"># Ensure we always generate True/False instead of</span>
            <span class="c1"># True/None. Elasticsearch can&#39;t filter on null values.</span>
            <span class="k">return</span> <span class="n">case</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span> <span class="kc">True</span><span class="p">)],</span> <span class="n">else_</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="n">licensepools</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;licensepool_id&#39;</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;data_source_id&#39;</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;collection_id&#39;</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;open_access&#39;</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">suppressed</span><span class="p">,</span>

                <span class="n">explicit_bool</span><span class="p">(</span>
                    <span class="s1">&#39;available&#39;</span><span class="p">,</span>
                    <span class="n">or_</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span><span class="p">,</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">,</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">explicit_bool</span><span class="p">(</span>
                    <span class="s1">&#39;licensed&#39;</span><span class="p">,</span>
                    <span class="n">or_</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span><span class="p">,</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">,</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">work_quality_column</span><span class="p">,</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
                <span class="n">func</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                    <span class="s2">&quot;EPOCH&quot;</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">availability_time</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;availability_time&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="n">work_id_column</span><span class="p">,</span>
                <span class="n">work_presentation_edition_id_column</span><span class="o">==</span><span class="n">Edition</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;licensepools_subquery&quot;</span><span class="p">)</span>
        <span class="n">licensepools_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">licensepools</span><span class="p">)</span>

        <span class="c1"># This subquery gets CustomList IDs for all lists</span>
        <span class="c1"># that contain the work.</span>
        <span class="c1">#</span>
        <span class="c1"># We also keep track of whether the work is featured on each</span>
        <span class="c1"># list. This is used when determining which works should be</span>
        <span class="c1"># featured for a lane based on CustomLists.</span>
        <span class="c1">#</span>
        <span class="c1"># And we keep track of the first time the work appears on the list.</span>
        <span class="c1"># This is used when generating a crawlable feed for the customlist,</span>
        <span class="c1"># which is ordered by a work&#39;s first appearance on the list.</span>
        <span class="n">customlists</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">list_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;list_id&#39;</span><span class="p">),</span>
                <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">featured</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;featured&#39;</span><span class="p">),</span>
                <span class="n">func</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                    <span class="s2">&quot;EPOCH&quot;</span><span class="p">,</span>
                    <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">first_appearance</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;first_appearance&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="n">work_id_column</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;listentries_subquery&quot;</span><span class="p">)</span>
        <span class="n">customlists_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">customlists</span><span class="p">)</span>

        <span class="c1"># This subquery gets Contributors, filtered on edition_id.</span>
        <span class="n">contributors</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span>
             <span class="n">Contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
             <span class="n">Contributor</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span>
             <span class="n">Contributor</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span>
             <span class="n">Contributor</span><span class="o">.</span><span class="n">viaf</span><span class="p">,</span>
             <span class="n">Contribution</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">Contribution</span><span class="o">.</span><span class="n">edition_id</span><span class="o">==</span><span class="n">literal_column</span><span class="p">(</span><span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">edition_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span>
                <span class="n">Contributor</span><span class="p">,</span> <span class="n">Contribution</span><span class="p">,</span>
                <span class="n">Contributor</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">Contribution</span><span class="o">.</span><span class="n">contributor_id</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;contributors_subquery&quot;</span><span class="p">)</span>
        <span class="n">contributors_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">contributors</span><span class="p">)</span>

        <span class="c1"># Use a subquery to get recursively equivalent Identifiers</span>
        <span class="c1"># for the Edition&#39;s primary_identifier_id.</span>
        <span class="c1">#</span>
        <span class="c1"># NOTE: we don&#39;t reliably reindex works when this information</span>
        <span class="c1"># changes, but it&#39;s not critical that this information be</span>
        <span class="c1"># totally up to date -- we only use it for subject searches</span>
        <span class="c1"># and recommendations. The index is completely rebuilt once a</span>
        <span class="c1"># day, and that&#39;s good enough.</span>
        <span class="n">equivalent_identifiers</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">recursively_equivalent_identifier_ids_query</span><span class="p">(</span>
            <span class="n">literal_column</span><span class="p">(</span>
                <span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">.</span><span class="n">name</span>
            <span class="p">),</span>
            <span class="n">policy</span><span class="o">=</span><span class="n">policy</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;equivalent_identifiers_subquery&quot;</span><span class="p">)</span>

        <span class="n">identifiers</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">),</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">equivalent_identifiers</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;identifier_subquery&quot;</span><span class="p">)</span>
        <span class="n">identifiers_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>

        <span class="c1"># Map our constants for Subject type to their URIs.</span>
        <span class="n">scheme_column</span> <span class="o">=</span> <span class="n">case</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">Subject</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">key</span><span class="p">,</span> <span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">uri_lookup</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
        <span class="p">)</span>

        <span class="c1"># If the Subject has a name, use that, otherwise use the Subject&#39;s identifier.</span>
        <span class="c1"># Also, 3M&#39;s classifications have slashes, e.g. &quot;FICTION/Adventure&quot;. Make sure</span>
        <span class="c1"># we get separated words for search.</span>
        <span class="n">term_column</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">case</span><span class="p">([(</span><span class="n">Subject</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Subject</span><span class="o">.</span><span class="n">name</span><span class="p">)],</span> <span class="n">else_</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">),</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="c1"># Normalize by dividing each weight by the sum of the weights for that Identifier&#39;s Classifications.</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="n">Classification</span>
        <span class="n">weight_column</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span><span class="o">.</span><span class="n">over</span><span class="p">()</span>

        <span class="c1"># The subquery for Subjects, with those three columns. The labels will become keys in json objects.</span>
        <span class="n">subjects</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span><span class="n">scheme_column</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;scheme&#39;</span><span class="p">),</span>
             <span class="n">term_column</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">),</span>
             <span class="n">weight_column</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="c1"># Only include Subjects with terms that are useful for search.</span>
            <span class="n">and_</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">TYPES_FOR_SEARCH</span><span class="p">),</span>
                 <span class="n">term_column</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
            <span class="n">scheme_column</span><span class="p">,</span> <span class="n">term_column</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">Classification</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">equivalent_identifiers</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">Classification</span><span class="p">,</span> <span class="n">Subject</span><span class="p">,</span> <span class="n">Classification</span><span class="o">.</span><span class="n">subject_id</span><span class="o">==</span><span class="n">Subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;subjects_subquery&quot;</span><span class="p">)</span>
        <span class="n">subjects_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>


        <span class="c1"># Subquery for genres.</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="c1"># All Genres have the same scheme - the simplified genre URI.</span>
            <span class="p">[</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;scheme&#39;</span><span class="p">),</span>
             <span class="n">Genre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">Genre</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">),</span>
             <span class="n">WorkGenre</span><span class="o">.</span><span class="n">affinity</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">WorkGenre</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="n">literal_column</span><span class="p">(</span><span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">WorkGenre</span><span class="p">,</span> <span class="n">Genre</span><span class="p">,</span> <span class="n">WorkGenre</span><span class="o">.</span><span class="n">genre_id</span><span class="o">==</span><span class="n">Genre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;genres_subquery&quot;</span><span class="p">)</span>
        <span class="n">genres_json</span> <span class="o">=</span> <span class="n">query_to_json_array</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>

        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age_query</span><span class="p">(</span>
            <span class="n">literal_column</span><span class="p">(</span><span class="n">works_alias</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;target_age_subquery&#39;</span><span class="p">)</span>
        <span class="n">target_age_json</span> <span class="o">=</span> <span class="n">query_to_json</span><span class="p">(</span><span class="n">target_age</span><span class="p">)</span>

        <span class="c1"># Now, create a query that brings together everything we need for the final</span>
        <span class="c1"># search document.</span>
        <span class="n">search_data</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span><span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">),</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;work_id&quot;</span><span class="p">),</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">series</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">series_position</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">sort_author</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">imprint</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">presentation_ready</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">last_update_time</span><span class="p">,</span>

             <span class="c1"># Convert true/false to &quot;Fiction&quot;/&quot;Nonfiction&quot;.</span>
             <span class="n">case</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fiction</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;&#39;Fiction&#39;&quot;</span><span class="p">))],</span>
                    <span class="n">else_</span><span class="o">=</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;&#39;Nonfiction&#39;&quot;</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;fiction&quot;</span><span class="p">),</span>

             <span class="c1"># Replace &quot;Young Adult&quot; with &quot;YoungAdult&quot; and &quot;Adults Only&quot; with &quot;AdultsOnly&quot;.</span>
             <span class="n">func</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;audience&#39;</span><span class="p">),</span>

             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">summary_text</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">),</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quality</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span>
             <span class="n">works_alias</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">popularity</span><span class="p">,</span>

             <span class="c1"># Here are all the subqueries.</span>
             <span class="n">licensepools_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;licensepools&quot;</span><span class="p">),</span>
             <span class="n">customlists_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;customlists&quot;</span><span class="p">),</span>
             <span class="n">contributors_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;contributors&quot;</span><span class="p">),</span>
             <span class="n">identifiers_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;identifiers&quot;</span><span class="p">),</span>
             <span class="n">subjects_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;classifications&quot;</span><span class="p">),</span>
             <span class="n">genres_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">),</span>
             <span class="n">target_age_json</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;target_age&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
            <span class="n">works_alias</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;search_data_subquery&quot;</span><span class="p">)</span>

        <span class="c1"># Finally, convert everything to json.</span>
        <span class="n">search_json</span> <span class="o">=</span> <span class="n">query_to_json</span><span class="p">(</span><span class="n">search_data</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">search_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span></div>

<div class="viewcode-block" id="Work.target_age_query"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.target_age_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foreign_work_id_field</span><span class="p">):</span>
        <span class="c1"># If the upper limit of the target age is inclusive, we leave</span>
        <span class="c1"># it alone. Otherwise, we subtract one to make it inclusive.</span>
        <span class="n">upper_field</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">target_age</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">case</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">func</span><span class="o">.</span><span class="n">upper_inc</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">target_age</span><span class="p">),</span> <span class="n">upper_field</span><span class="p">)],</span>
            <span class="n">else_</span><span class="o">=</span><span class="n">upper_field</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>

        <span class="c1"># If the lower limit of the target age is inclusive, we leave</span>
        <span class="c1"># it alone. Otherwise, we add one to make it inclusive.</span>
        <span class="n">lower_field</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">target_age</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">case</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">func</span><span class="o">.</span><span class="n">lower_inc</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">target_age</span><span class="p">),</span> <span class="n">lower_field</span><span class="p">)],</span>
            <span class="n">else_</span><span class="o">=</span><span class="n">lower_field</span><span class="o">+</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

        <span class="c1"># Subquery for target age. This has to be a subquery so it can</span>
        <span class="c1"># become a nested object in the final json.</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
            <span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">foreign_work_id_field</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">target_age</span></div>

<div class="viewcode-block" id="Work.to_search_document"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.to_search_document">[docs]</a>    <span class="k">def</span> <span class="nf">to_search_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a search document for this Work.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Work</span><span class="o">.</span><span class="n">to_search_documents</span><span class="p">([</span><span class="bp">self</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Work.mark_licensepools_as_superceded"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.mark_licensepools_as_superceded">[docs]</a>    <span class="k">def</span> <span class="nf">mark_licensepools_as_superceded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure that all but the single best open-access LicensePool for</span>
<span class="sd">        this Work are superceded. A non-open-access LicensePool should</span>
<span class="sd">        never be superceded, and this method will mark them as</span>
<span class="sd">        un-superceded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">champion_open_access_license_pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">better_open_access_pool_than</span><span class="p">(</span><span class="n">champion_open_access_license_pool</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">champion_open_access_license_pool</span><span class="p">:</span>
                    <span class="n">champion_open_access_license_pool</span><span class="o">.</span><span class="n">superceded</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">champion_open_access_license_pool</span> <span class="o">=</span> <span class="n">pool</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Work.restrict_to_custom_lists_from_data_source"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.restrict_to_custom_lists_from_data_source">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">restrict_to_custom_lists_from_data_source</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">base_query</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">on_list_as_of</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotate a query that joins Work against Edition to match only</span>
<span class="sd">        Works that are on a custom list from the given data source.&quot;&quot;&quot;</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="n">CustomList</span><span class="o">.</span><span class="n">data_source</span><span class="o">==</span><span class="n">data_source</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_restrict_to_customlist_subquery_condition</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">base_query</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">on_list_as_of</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.restrict_to_custom_lists"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.restrict_to_custom_lists">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">restrict_to_custom_lists</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">base_query</span><span class="p">,</span> <span class="n">custom_lists</span><span class="p">,</span> <span class="n">on_list_as_of</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotate a query that joins Work against Edition to match only</span>
<span class="sd">        Works that are on one of the given custom lists.&quot;&quot;&quot;</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="n">CustomList</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">custom_lists</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_restrict_to_customlist_subquery_condition</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">base_query</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">on_list_as_of</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_restrict_to_customlist_subquery_condition</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">base_query</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">on_list_as_of</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotate a query that joins Work against Edition to match only</span>
<span class="sd">        Works that are on a custom list from the given data source.&quot;&quot;&quot;</span>
        <span class="c1"># Find works that are on a list that meets the given condition.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">custom_list_entries</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">customlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on_list_as_of</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">most_recent_appearance</span> <span class="o">&gt;=</span> <span class="n">on_list_as_of</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span>

<div class="viewcode-block" id="Work.classifications_with_genre"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.classifications_with_genre">[docs]</a>    <span class="k">def</span> <span class="nf">classifications_with_genre</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Classification</span><span class="p">,</span>
            <span class="n">Subject</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classification</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Subject</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">identifier_id</span> <span class="o">==</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">genre_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span></div>

<div class="viewcode-block" id="Work.top_genre"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.top_genre">[docs]</a>    <span class="k">def</span> <span class="nf">top_genre</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.classification</span> <span class="kn">import</span> <span class="n">Genre</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">genre</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Genre</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WorkGenre</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">WorkGenre</span><span class="o">.</span><span class="n">affinity</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span> \
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">genre</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">genre</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Work.delete"><a class="viewcode-back" href="../../../core.model.html#core.model.resource.Work.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the work from both the DB and search index.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">search_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">..external_search</span> <span class="kn">import</span> <span class="n">ExternalSearchIndex</span>
                <span class="n">search_index</span> <span class="o">=</span> <span class="n">ExternalSearchIndex</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># No search index is configured. This is fine -- just skip that part.</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">search_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">search_index</span><span class="o">.</span><span class="n">remove_work</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../model.html">core.model</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>