
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.opds_import &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.opds_import</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">feedparser</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">quote</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">CannotLoadConfiguration</span><span class="p">,</span> <span class="n">IntegrationException</span>
<span class="kn">from</span> <span class="nn">.coverage</span> <span class="kn">import</span> <span class="n">CoverageFailure</span>
<span class="kn">from</span> <span class="nn">.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">ContributorData</span><span class="p">,</span>
    <span class="n">IdentifierData</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">MeasurementData</span><span class="p">,</span>
    <span class="n">Metadata</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">SubjectData</span><span class="p">,</span>
    <span class="n">TimestampData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.mirror</span> <span class="kn">import</span> <span class="n">MirrorUploader</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">CoverageRecord</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">Equivalency</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Measurement</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">.monitor</span> <span class="kn">import</span> <span class="n">CollectionMonitor</span>
<span class="kn">from</span> <span class="nn">.selftest</span> <span class="kn">import</span> <span class="n">HasSelfTests</span><span class="p">,</span> <span class="n">SelfTestResult</span>
<span class="kn">from</span> <span class="nn">.classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">.util.http</span> <span class="kn">import</span> <span class="n">HTTP</span><span class="p">,</span> <span class="n">BadResponseException</span>
<span class="kn">from</span> <span class="nn">.util.opds_writer</span> <span class="kn">import</span> <span class="n">OPDSFeed</span><span class="p">,</span> <span class="n">OPDSMessage</span>
<span class="kn">from</span> <span class="nn">.util.string_helpers</span> <span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="nn">.util.xmlparser</span> <span class="kn">import</span> <span class="n">XMLParser</span>
<span class="kn">from</span> <span class="nn">.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">datetime_utc</span><span class="p">,</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="parse_identifier"><a class="viewcode-back" href="../../core.html#core.opds_import.parse_identifier">[docs]</a><span class="k">def</span> <span class="nf">parse_identifier</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the identifier and return an Identifier object representing it.</span>

<span class="sd">    :param db: Database session</span>
<span class="sd">    :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">    :param identifier: String containing the identifier</span>
<span class="sd">    :type identifier: str</span>

<span class="sd">    :return: Identifier object</span>
<span class="sd">    :rtype: core.model.identifier.Identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">identifier</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">identifier</span></div>


<div class="viewcode-block" id="AccessNotAuthenticated"><a class="viewcode-back" href="../../core.html#core.opds_import.AccessNotAuthenticated">[docs]</a><span class="k">class</span> <span class="nc">AccessNotAuthenticated</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;No authentication is configured for this service&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SimplifiedOPDSLookup"><a class="viewcode-back" href="../../core.html#core.opds_import.SimplifiedOPDSLookup">[docs]</a><span class="k">class</span> <span class="nc">SimplifiedOPDSLookup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tiny integration class for the Simplified &#39;lookup&#39; protocol.&quot;&quot;&quot;</span>

    <span class="n">LOOKUP_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;lookup&quot;</span>

<div class="viewcode-block" id="SimplifiedOPDSLookup.check_content_type"><a class="viewcode-back" href="../../core.html#core.opds_import.SimplifiedOPDSLookup.check_content_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check_content_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">!=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="s2">&quot;Wrong media type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content_type</span><span class="p">,</span>
                <span class="n">response</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SimplifiedOPDSLookup.from_protocol"><a class="viewcode-back" href="../../core.html#core.opds_import.SimplifiedOPDSLookup.from_protocol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_protocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span>
                      <span class="n">goal</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_GOAL</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">integration</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lookup_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOOKUP_ENDPOINT</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request. This method is overridden in the mock class.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;2xx&#39;</span><span class="p">,</span> <span class="s1">&#39;3xx&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">get_with_timeout</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SimplifiedOPDSLookup.urn_args"><a class="viewcode-back" href="../../core.html#core.opds_import.SimplifiedOPDSLookup.urn_args">[docs]</a>    <span class="k">def</span> <span class="nf">urn_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s2">&quot;urn=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">urn</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimplifiedOPDSLookup.lookup"><a class="viewcode-back" href="../../core.html#core.opds_import.SimplifiedOPDSLookup.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve an OPDS feed with metadata for the given identifiers.&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urn_args</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_endpoint</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">args</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lookup URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MetadataWranglerOPDSLookup"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup">[docs]</a><span class="k">class</span> <span class="nc">MetadataWranglerOPDSLookup</span><span class="p">(</span><span class="n">SimplifiedOPDSLookup</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>

    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_WRANGLER</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Simplified Metadata Wrangler&quot;</span><span class="p">)</span>
    <span class="n">CARDINALITY</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">),</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;http://metadata.librarysimplified.org/&quot;</span><span class="p">,</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">SITEWIDE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">ADD_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>
    <span class="n">ADD_WITH_METADATA_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;add_with_metadata&#39;</span>
    <span class="n">METADATA_NEEDED_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;metadata_needed&#39;</span>
    <span class="n">REMOVE_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;remove&#39;</span>
    <span class="n">UPDATES_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;updates&#39;</span>
    <span class="n">CANONICALIZE_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;canonical-author-name&#39;</span>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.from_config"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_WRANGLER</span><span class="p">,</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_GOAL</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;No ExternalIntegration found for the Metadata Wrangler.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler improperly configured.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">shared_secret</span><span class="o">=</span><span class="n">integration</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.external_integration"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.external_integration">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_WRANGLER</span><span class="p">,</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_GOAL</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">lookup_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run self-tests on every eligible Collection.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param lookup_class: Pass in a mock class to instantiate that</span>
<span class="sd">           class as needed instead of MetadataWranglerOPDSLookup.</span>
<span class="sd">        :return: A dictionary mapping Collection objects to lists of</span>
<span class="sd">           SelfTestResult objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">lookup_class</span> <span class="ow">or</span> <span class="n">MetadataWranglerOPDSLookup</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Find all eligible Collections on the system, instantiate a</span>
        <span class="c1"># _new_ MetadataWranglerOPDSLookup for each, and call</span>
        <span class="c1"># its _run_collection_self_tests method.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metadata_identifier</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">metadata_identifier</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup_class</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lookup</span><span class="o">.</span><span class="n">_run_collection_self_tests</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">_run_collection_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the self-test suite on the Collection associated with this</span>
<span class="sd">        MetadataWranglerOPDSLookup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">metadata_identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">metadata_identifier</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This collection has no metadata identifier. It&#39;s</span>
            <span class="c1"># probably a &quot;Manual intervention&quot; collection. It cannot</span>
            <span class="c1"># interact with the metadata wrangler and there&#39;s no need</span>
            <span class="c1"># to test it.</span>
            <span class="k">return</span>

        <span class="c1"># Check various endpoints that yield OPDS feeds.</span>
        <span class="n">one_day_ago</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Metadata updates in last 24 hours&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">,</span> <span class="p">[</span><span class="n">one_day_ago</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="s2">&quot;Titles where we could (but haven&#39;t) provide information to the metadata wrangler&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata_needed</span><span class="p">,</span> <span class="p">[]</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feed_self_test</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_feed_self_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a feed from the metadata wrangler and</span>
<span class="sd">        turn it into a SelfTestResult.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">SelfTestResult</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>

        <span class="c1"># If the server returns a 500 error we don&#39;t want to raise an</span>
        <span class="c1"># exception -- we want to record it as part of the test</span>
        <span class="c1"># result.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">xx&#39;</span> <span class="o">%</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)])</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_feed_response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># We&#39;re all done.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_annotate_feed_response</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse an OPDS feed and annotate a SelfTestResult with some</span>
<span class="sd">        information about it:</span>

<span class="sd">        * How the feed was requested.</span>
<span class="sd">        * What the response code was.</span>
<span class="sd">        * The number of items on the first page.</span>
<span class="sd">        * The title of each item on the page, if any.</span>
<span class="sd">        * The total number of items in the feed, if available.</span>

<span class="sd">        :param result: A SelfTestResult object.</span>
<span class="sd">        :param response: A requests Response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Request URL: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Request authorization: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Status code: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">total_results</span> <span class="o">=</span> <span class="n">feed</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opensearch_totalresults&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Total identifiers registered with this collection: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">total_results</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Entries on this page: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">feed</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">feed</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">shared_secret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetadataWranglerOPDSLookup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_secret</span> <span class="o">=</span> <span class="n">shared_secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_secret</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authorization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_secret</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;Authorization&#39;</span> <span class="p">:</span> <span class="n">token</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lookup_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOOKUP_ENDPOINT</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">metadata_identifier</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOOKUP_ENDPOINT</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MetadataWranglerOPDSLookup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request. This method is overridden in the mock class.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;2xx&#39;</span><span class="p">,</span> <span class="s1">&#39;3xx&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">post_with_timeout</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.add_args"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.add_args">[docs]</a>    <span class="k">def</span> <span class="nf">add_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">arg_string</span><span class="p">):</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">joiner</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="c1"># This URL already has an argument (namely: data_source), so</span>
            <span class="c1"># append the new arguments.</span>
            <span class="n">joiner</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="k">return</span> <span class="n">url</span> <span class="o">+</span> <span class="n">joiner</span> <span class="o">+</span> <span class="n">arg_string</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.get_collection_url"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.get_collection_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_collection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessNotAuthenticated</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler access not authenticated.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Collection provided.&quot;</span><span class="p">)</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span><span class="p">:</span>
            <span class="c1"># Open access OPDS_IMPORT collections need to send a DataSource to</span>
            <span class="c1"># allow OPDS lookups on the Metadata Wrangler.</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;?data_source=&#39;</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">metadata_identifier</span>
            <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">endpoint</span> <span class="o">+</span> <span class="n">data_source</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.add"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add items to an authenticated Metadata Wrangler Collection&quot;&quot;&quot;</span>
        <span class="n">add_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADD_ENDPOINT</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urn_args</span><span class="p">(</span><span class="n">identifiers</span><span class="p">))</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler Collection Addition URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.add_with_metadata"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.add_with_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a feed of items with metadata to an authenticated Metadata Wrangler Collection.&quot;&quot;&quot;</span>
        <span class="n">add_with_metadata_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADD_WITH_METADATA_ENDPOINT</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">add_with_metadata_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feed</span><span class="p">))</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.metadata_needed"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.metadata_needed">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a feed of items that need additional metadata to be processed</span>
<span class="sd">        by the Metadata Wrangler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata_needed_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_url</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">METADATA_NEEDED_ENDPOINT</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">metadata_needed_url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.remove"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove items from an authenticated Metadata Wrangler Collection&quot;&quot;&quot;</span>
        <span class="n">remove_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REMOVE_ENDPOINT</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="n">remove_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urn_args</span><span class="p">(</span><span class="n">identifiers</span><span class="p">))</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler Collection Removal URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.updates"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.updates">[docs]</a>    <span class="k">def</span> <span class="nf">updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_update_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve updated items from an authenticated Metadata</span>
<span class="sd">        Wrangler Collection</span>

<span class="sd">        :param last_update_time: DateTime representing the last time</span>
<span class="sd">            an update was fetched. May be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATES_ENDPOINT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_update_time</span><span class="p">:</span>
            <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">last_update_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;last_update_time=&#39;</span><span class="o">+</span><span class="n">formatted_time</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler Collection Updates URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataWranglerOPDSLookup.canonicalize_author_name"><a class="viewcode-back" href="../../core.html#core.opds_import.MetadataWranglerOPDSLookup.canonicalize_author_name">[docs]</a>    <span class="k">def</span> <span class="nf">canonicalize_author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">working_display_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to find the canonical name for the author of a book.</span>

<span class="sd">        :param identifier: an ISBN-type Identifier.</span>

<span class="sd">        :param working_display_name: The display name of the author</span>
<span class="sd">            (i.e. the name format human being used as opposed to the name</span>
<span class="sd">            that goes into library records).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;display_name=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">quote</span><span class="p">(</span><span class="n">working_display_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot;&amp;urn=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">CANONICALIZE_ENDPOINT</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">args</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GET </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MockSimplifiedOPDSLookup"><a class="viewcode-back" href="../../core.html#core.opds_import.MockSimplifiedOPDSLookup">[docs]</a><span class="k">class</span> <span class="nc">MockSimplifiedOPDSLookup</span><span class="p">(</span><span class="n">SimplifiedOPDSLookup</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockSimplifiedOPDSLookup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="MockSimplifiedOPDSLookup.queue_response"><a class="viewcode-back" href="../../core.html#core.opds_import.MockSimplifiedOPDSLookup.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.testing</span> <span class="kn">import</span> <span class="n">MockRequestsResponse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MockMetadataWranglerOPDSLookup"><a class="viewcode-back" href="../../core.html#core.opds_import.MockMetadataWranglerOPDSLookup">[docs]</a><span class="k">class</span> <span class="nc">MockMetadataWranglerOPDSLookup</span><span class="p">(</span><span class="n">MockSimplifiedOPDSLookup</span><span class="p">,</span> <span class="n">MetadataWranglerOPDSLookup</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="OPDSXMLParser"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSXMLParser">[docs]</a><span class="k">class</span> <span class="nc">OPDSXMLParser</span><span class="p">(</span><span class="n">XMLParser</span><span class="p">):</span>

    <span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;simplified&quot;</span><span class="p">:</span> <span class="s2">&quot;http://librarysimplified.org/terms/&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;app&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://www.w3.org/2007/app&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;dcterms&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://purl.org/dc/terms/&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;dc&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://purl.org/dc/elements/1.1/&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;opds&quot;</span><span class="p">:</span> <span class="s2">&quot;http://opds-spec.org/2010/catalog&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;schema&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://schema.org/&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;atom&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://www.w3.org/2005/Atom&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;drm&quot;</span><span class="p">:</span> <span class="s2">&quot;http://librarysimplified.org/terms/drm&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="OPDSImporter"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter">[docs]</a><span class="k">class</span> <span class="nc">OPDSImporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Imports editions and license pools from an OPDS feed.</span>
<span class="sd">    Creates Edition, LicensePool and Work rows in the database, if those</span>
<span class="sd">    don&#39;t already exist.</span>

<span class="sd">    Should be used when a circulation server asks for data from</span>
<span class="sd">    our internal content server, and also when our content server asks for data</span>
<span class="sd">    from external content servers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">COULD_NOT_CREATE_LICENSE_POOL</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;No existing license pool for this identifier and no way of creating one.&quot;</span><span class="p">)</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Import books from a publicly-accessible OPDS feed.&quot;</span><span class="p">)</span>

    <span class="n">NO_DEFAULT_AUDIENCE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># These settings are used by all OPDS-derived import methods.</span>
    <span class="n">BASE_SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Data source name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">DEFAULT_AUDIENCE_KEY</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Default audience&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;If the vendor does not specify the target audience for their books, &quot;</span>
                <span class="s2">&quot;assume the books have this target audience.&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;narrow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
               <span class="p">{</span>
                   <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NO_DEFAULT_AUDIENCE</span><span class="p">,</span>
                   <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No default audience&quot;</span><span class="p">)</span>
               <span class="p">}</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="p">{</span>
                   <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">audience</span><span class="p">,</span>
                   <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">audience</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">audience</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">NO_DEFAULT_AUDIENCE</span><span class="p">,</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># These settings are used by &#39;regular&#39; OPDS but not by OPDS For</span>
    <span class="c1"># Distributors, which has its own way of doing authentication.</span>
    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">BASE_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Username&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;If HTTP Basic authentication is required to access the OPDS feed (it usually isn&#39;t), enter the username here.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;If HTTP Basic authentication is required to access the OPDS feed (it usually isn&#39;t), enter the password here.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">CUSTOM_ACCEPT_HEADER</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Custom accept header&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Some servers expect an accept header to decide which file to send. You can use */* if the server doesn&#39;t expect anything.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                <span class="s2">&quot;application/atom+xml;q=0.9&quot;</span><span class="p">,</span>
                <span class="s2">&quot;application/xml;q=0.8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*/*;q=0.1&quot;</span><span class="p">,</span>
            <span class="p">])</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PRIMARY_IDENTIFIER_SOURCE</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Identifer&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Which book identifier to use as ID.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
               <span class="p">{</span>
                   <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;(Default) Use &lt;id&gt;&quot;</span><span class="p">)</span>
               <span class="p">},</span>
               <span class="p">{</span>
                   <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">DCTERMS_IDENTIFIER</span><span class="p">,</span>
                   <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Use &lt;dcterms:identifier&gt; first, if not exist use &lt;id&gt;&quot;</span><span class="p">)</span>
               <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># Subclasses of OPDSImporter may define a different parser class that&#39;s</span>
    <span class="c1"># a subclass of OPDSXMLParser. For example, a subclass may want to use</span>
    <span class="c1"># tags from an additional namespace.</span>
    <span class="n">PARSER_CLASS</span> <span class="o">=</span> <span class="n">OPDSXMLParser</span>

    <span class="c1"># Subclasses of OPDSImporter may define a list of status codes</span>
    <span class="c1"># that should be treated as indicating success, rather than failure,</span>
    <span class="c1"># when they show up in &lt;simplified:message&gt; tags.</span>
    <span class="n">SUCCESS_STATUS_CODES</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">identifier_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">http_get</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">metadata_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content_modifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">map_from_collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:param collection: LicensePools created by this OPDS import</span>
<span class="sd">        will be associated with the given Collection. If this is None,</span>
<span class="sd">        no LicensePools will be created -- only Editions.</span>

<span class="sd">        :param data_source_name: Name of the source of this OPDS feed.</span>
<span class="sd">        All Editions created by this import will be associated with</span>
<span class="sd">        this DataSource. If there is no DataSource with this name, one</span>
<span class="sd">        will be created. NOTE: If `collection` is provided, its</span>
<span class="sd">        .data_source will take precedence over any value provided</span>
<span class="sd">        here. This is only for use when you are importing OPDS</span>
<span class="sd">        metadata without any particular Collection in mind.</span>

<span class="sd">        :param mirrors: A dictionary of different MirrorUploader objects for</span>
<span class="sd">        different purposes.</span>

<span class="sd">        :param http_get: Use this method to make an HTTP GET request. This</span>
<span class="sd">        can be replaced with a stub method for testing purposes.</span>

<span class="sd">        :param metadata_client: A SimplifiedOPDSLookup object that is used</span>
<span class="sd">        to fill in missing metadata.</span>

<span class="sd">        :param content_modifier: A function that may modify-in-place</span>
<span class="sd">        representations (such as images and EPUB documents) as they</span>
<span class="sd">        come in from the network.</span>

<span class="sd">        :param map_from_collection</span>

<span class="sd">        :param mirrors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;OPDS Importer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">collection</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_source_name</span><span class="p">:</span>
            <span class="c1"># Use the Collection data_source for OPDS import.</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">data_source</span>
            <span class="k">if</span> <span class="n">data_source</span><span class="p">:</span>
                <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot perform an OPDS import on a Collection that has no associated DataSource!&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the given data_source or default to the Metadata</span>
            <span class="c1"># Wrangler.</span>
            <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">data_source_name</span> <span class="ow">or</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">METADATA_WRANGLER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">data_source_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span> <span class="o">=</span> <span class="n">identifier_mapping</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_client</span> <span class="o">=</span> <span class="n">metadata_client</span> <span class="ow">or</span> <span class="n">MetadataWranglerOPDSLookup</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CannotLoadConfiguration</span><span class="p">:</span>
            <span class="c1"># The Metadata Wrangler isn&#39;t configured, but we can import without it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Metadata Wrangler integration couldn&#39;t be loaded, importing without it.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check to see if a mirror for each purpose was passed in.</span>
        <span class="c1"># If not, then attempt to create one.</span>
        <span class="n">covers_mirror</span> <span class="o">=</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">mirrors</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">books_mirror</span> <span class="o">=</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">mirrors</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">covers_mirror</span><span class="p">:</span>
                <span class="c1"># If this Collection is configured to mirror the assets it</span>
                <span class="c1"># discovers, this will create a MirrorUploader for that</span>
                <span class="c1"># Collection for its purpose. Otherwise, this will return None.</span>
                <span class="n">covers_mirror</span> <span class="o">=</span> <span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span>
                    <span class="n">collection</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">books_mirror</span><span class="p">:</span>
                <span class="n">books_mirror</span> <span class="o">=</span> <span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span>
                    <span class="n">collection</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_source</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">primary_identifier_source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">covers_mirror</span><span class="o">=</span><span class="n">covers_mirror</span><span class="p">,</span> <span class="n">books_mirror</span><span class="o">=</span><span class="n">books_mirror</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_modifier</span> <span class="o">=</span> <span class="n">content_modifier</span>

        <span class="c1"># In general, we are cautious when mirroring resources so that</span>
        <span class="c1"># we don&#39;t, e.g. accidentally get our IP banned from</span>
        <span class="c1"># gutenberg.org.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_get</span> <span class="o">=</span> <span class="n">http_get</span> <span class="ow">or</span> <span class="n">Representation</span><span class="o">.</span><span class="n">cautious_http_get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_from_collection</span> <span class="o">=</span> <span class="n">map_from_collection</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an associated Collection object</span>

<span class="sd">        :return: Associated Collection object</span>
<span class="sd">        :rtype: Optional[core.model.collection.Collection]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up or create a DataSource object representing the</span>
<span class="sd">        source of this OPDS feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offers_licenses</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">offers_licenses</span> <span class="o">=</span> <span class="n">offers_licenses</span>
        <span class="p">)</span>

<div class="viewcode-block" id="OPDSImporter.assert_importable_content"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.assert_importable_content">[docs]</a>    <span class="k">def</span> <span class="nf">assert_importable_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="n">max_get_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise an exception if the given feed contains nothing that can,</span>
<span class="sd">        even theoretically, be turned into a LicensePool.</span>

<span class="sd">        By default, this means the feed must link to open-access content</span>
<span class="sd">        that can actually be retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_feed_data</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">)</span>
        <span class="n">get_attempts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Find an open-access link, and try to GET it just to make</span>
        <span class="c1"># sure OPDS feed isn&#39;t hiding non-open-access stuff behind an</span>
        <span class="c1"># open-access link.</span>
        <span class="c1">#</span>
        <span class="c1"># To avoid taking forever or antagonizing API providers, we&#39;ll</span>
        <span class="c1"># give up after `max_get_attempts` failures.</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_access_links</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">href</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open_access_link</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">success</span>
            <span class="n">get_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">get_attempts</span> <span class="o">&gt;=</span> <span class="n">max_get_attempts</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Was unable to GET supposedly open-access content such as </span><span class="si">%s</span><span class="s2"> (tried </span><span class="si">%s</span><span class="s2"> times)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span> <span class="n">get_attempts</span>
                <span class="p">)</span>
                <span class="n">explanation</span> <span class="o">=</span> <span class="s2">&quot;This might be an OPDS For Distributors feed, or it might require different authentication credentials.&quot;</span>
                <span class="k">raise</span> <span class="n">IntegrationException</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">explanation</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">IntegrationException</span><span class="p">(</span>
            <span class="s2">&quot;No open-access links were found in the OPDS feed.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;This might be an OPDS for Distributors feed.&quot;</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_open_access_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all open-access links in a list of Metadata objects.</span>

<span class="sd">        :param metadatas: A list of Metadata objects.</span>
<span class="sd">        :yield: A sequence of `LinkData` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metadatas</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">circulation</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">link</span>

    <span class="k">def</span> <span class="nf">_is_open_access_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is `url` really an open-access link?</span>

<span class="sd">        That is, can we make a normal GET request and get something</span>
<span class="sd">        that looks like a book?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Accept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">10</span><span class="p">:</span>
            <span class="c1"># We could also check the media types, but this is good</span>
            <span class="c1"># enough for now.</span>
            <span class="k">return</span> <span class="s2">&quot;Found a book-like thing at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Supposedly open-access link </span><span class="si">%s</span><span class="s2"> didn&#39;t give us a book. Status=</span><span class="si">%s</span><span class="s2">, body length=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the identifier and return an Identifier object representing it.</span>

<span class="sd">        :param identifier: String containing the identifier</span>
<span class="sd">        :type identifier: str</span>

<span class="sd">        :return: Identifier object</span>
<span class="sd">        :rtype: Identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

<div class="viewcode-block" id="OPDSImporter.import_from_feed"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.import_from_feed">[docs]</a>    <span class="k">def</span> <span class="nf">import_from_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Keep track of editions that were imported. Pools and works</span>
        <span class="c1"># for those editions may be looked up or created.</span>
        <span class="n">imported_editions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">works</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># CoverageFailures that note business logic errors and non-success download statuses</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If parsing the overall feed throws an exception, we should address that before</span>
        <span class="c1"># moving on. Let the exception propagate.</span>
        <span class="n">metadata_objs</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_feed_data</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">)</span>
        <span class="c1"># make editions.  if have problem, make sure associated pool and work aren&#39;t created.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_objs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># key is identifier.urn here</span>

            <span class="c1"># If there&#39;s a status message about this item, don&#39;t try to import it.</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create an edition. This will also create a pool if there&#39;s circulation data.</span>
                <span class="n">edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_edition_from_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">edition</span><span class="p">:</span>
                    <span class="n">imported_editions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">edition</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Rather than scratch the whole import, treat this as a failure that only applies</span>
                <span class="c1"># to this item.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error importing an OPDS item&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
                <span class="n">failure</span> <span class="o">=</span> <span class="n">CoverageFailure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">failures</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>
                <span class="c1"># clean up any edition might have created</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">imported_editions</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">imported_editions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># Move on to the next item, don&#39;t create a work.</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pool</span><span class="p">,</span> <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_work_for_edition</span><span class="p">(</span><span class="n">edition</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">pools</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span>
                <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                    <span class="n">works</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">work</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
                <span class="n">failure</span> <span class="o">=</span> <span class="n">CoverageFailure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">failures</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">imported_editions</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">pools</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">works</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">failures</span></div>

<div class="viewcode-block" id="OPDSImporter.import_edition_from_metadata"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.import_edition_from_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">import_edition_from_metadata</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; For the passed-in Metadata object, see if can find or create an Edition</span>
<span class="sd">            in the database. Also create a LicensePool if the Metadata has</span>
<span class="sd">            CirculationData in it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Locate or create an Edition for this book.</span>
        <span class="n">edition</span><span class="p">,</span> <span class="n">is_new_edition</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">edition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">link_content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">even_if_not_apparently_updated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span><span class="p">,</span>
            <span class="n">content_modifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">content_modifier</span><span class="p">,</span>
            <span class="n">http_get</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">http_get</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">edition</span><span class="o">=</span><span class="n">edition</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">metadata_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_client</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">policy</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">edition</span></div>

<div class="viewcode-block" id="OPDSImporter.update_work_for_edition"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.update_work_for_edition">[docs]</a>    <span class="k">def</span> <span class="nf">update_work_for_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If possible, ensure that there is a presentation-ready Work for the</span>
<span class="sd">        given edition&#39;s primary identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Find a LicensePool for the primary identifier. Any LicensePool will</span>
        <span class="c1"># do--the collection doesn&#39;t have to match, since all</span>
        <span class="c1"># LicensePools for a given identifier have the same Work.</span>
        <span class="c1">#</span>
        <span class="c1"># If we have CirculationData, a pool was created when we</span>
        <span class="c1"># imported the edition. If there was already a pool from a</span>
        <span class="c1"># different data source or a different collection, that&#39;s fine</span>
        <span class="c1"># too.</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">on_multiple</span><span class="o">=</span><span class="s1">&#39;interchangeable&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">presentation_ready</span><span class="p">:</span>
                <span class="c1"># There is no presentation-ready Work for this</span>
                <span class="c1"># LicensePool. Try to create one.</span>
                <span class="n">work</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There is a presentation-ready Work for this LicensePool.</span>
                <span class="c1"># Use it.</span>
                <span class="n">work</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">work</span>

        <span class="c1"># If a presentation-ready Work already exists, there&#39;s no</span>
        <span class="c1"># rush. We might have new metadata that will change the Work&#39;s</span>
        <span class="c1"># presentation, but when we called Metadata.apply() the work</span>
        <span class="c1"># was set up to have its presentation recalculated in the</span>
        <span class="c1"># background, and that&#39;s good enough.</span>
        <span class="k">return</span> <span class="n">pool</span><span class="p">,</span> <span class="n">work</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_next_links"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_next_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_next_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">feed</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">]</span>
        <span class="n">next_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">feed</span> <span class="ow">and</span> <span class="s1">&#39;links&#39;</span> <span class="ow">in</span> <span class="n">feed</span><span class="p">:</span>
            <span class="n">next_links</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">feed</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;next&#39;</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">next_links</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_last_update_dates"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_last_update_dates">[docs]</a>    <span class="k">def</span> <span class="nf">extract_last_update_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">parsed_feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parsed_feed</span> <span class="o">=</span> <span class="n">feed</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update_date_for_feedparser_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">parsed_feed</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dates</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="OPDSImporter.build_identifier_mapping"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.build_identifier_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">build_identifier_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_urns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses the given Collection and a list of URNs to reverse</span>
<span class="sd">        engineer an identifier mapping.</span>

<span class="sd">        NOTE: It would be better if .identifier_mapping weren&#39;t</span>
<span class="sd">        instance data, since a single OPDSImporter might import</span>
<span class="sd">        multiple pages of a feed. However, the code as written should</span>
<span class="sd">        work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">identifiers_by_urn</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urns</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">external_urns</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">external_identifiers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">identifiers_by_urn</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">internal_identifier</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">internal_identifier</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">inbound_equivalencies</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">internal_identifier</span><span class="p">,</span> <span class="n">Equivalency</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">external_identifiers</span><span class="p">]),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">external_identifier</span><span class="p">,</span> <span class="n">internal_identifier</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">external_identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">internal_identifier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span> <span class="o">=</span> <span class="n">mapping</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_feed_data"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_feed_data">[docs]</a>    <span class="k">def</span> <span class="nf">extract_feed_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an OPDS feed into lists of Metadata and CirculationData objects,</span>
<span class="sd">        with associated messages and next_links.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
        <span class="n">fp_metadata</span><span class="p">,</span> <span class="n">fp_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_data_from_feedparser</span><span class="p">(</span><span class="n">feed</span><span class="o">=</span><span class="n">feed</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span>
        <span class="c1"># gets: medium, measurements, links, contributors, etc.</span>
        <span class="n">xml_data_meta</span><span class="p">,</span> <span class="n">xml_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_metadata_from_elementtree</span><span class="p">(</span>
            <span class="n">feed</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="n">feed_url</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">http_get</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_from_collection</span><span class="p">:</span>
            <span class="c1"># Build the identifier_mapping based on the Collection.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_identifier_mapping</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fp_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fp_failures</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c1"># translate the id in failures to identifier.urn</span>
        <span class="n">identified_failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">urn</span><span class="p">,</span> <span class="n">failure</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fp_failures</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">xml_failures</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_failure</span><span class="p">(</span><span class="n">urn</span><span class="p">,</span> <span class="n">failure</span><span class="p">)</span>
            <span class="n">identified_failures</span><span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="c1"># Use one loop for both, since the id will be the same for both dictionaries.</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">circulationdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">m_data_dict</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fp_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">xml_data_dict</span> <span class="o">=</span> <span class="n">xml_data_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">external_identifier</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_identifier_source</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">DCTERMS_IDENTIFIER</span><span class="p">:</span>
                <span class="c1"># If it should use &lt;dcterms:identifier&gt; as the primary identifier, it must use the</span>
                <span class="c1"># first value from the dcterms identifier, that came from the metadata as an</span>
                <span class="c1"># IdentifierData object and it must be validated as a foreign_id before be used</span>
                <span class="c1"># as and external_identifier.</span>
                <span class="n">dcterms_ids</span> <span class="o">=</span> <span class="n">xml_data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dcterms_identifiers&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dcterms_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">external_identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">dcterms_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">dcterms_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">identifier</span>
                    <span class="p">)</span>
                    <span class="c1"># the external identifier will be add later, so it must be removed at this point</span>
                    <span class="n">new_identifiers</span> <span class="o">=</span> <span class="n">dcterms_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># Id must be in the identifiers with lower weight.</span>
                    <span class="n">id_type</span><span class="p">,</span> <span class="n">id_identifier</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">type_and_identifier_for_urn</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                    <span class="n">id_weight</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">new_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IdentifierData</span><span class="p">(</span><span class="n">id_type</span><span class="p">,</span> <span class="n">id_identifier</span><span class="p">,</span> <span class="n">id_weight</span><span class="p">))</span>
                    <span class="n">xml_data_dict</span><span class="p">[</span><span class="s1">&#39;identifiers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_identifiers</span>

            <span class="k">if</span> <span class="n">external_identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">external_identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span><span class="p">:</span>
                <span class="n">internal_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">external_identifier</span><span class="p">,</span> <span class="n">external_identifier</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">internal_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span>

            <span class="c1"># Don&#39;t process this item if there was already an error</span>
            <span class="k">if</span> <span class="n">internal_identifier</span><span class="o">.</span><span class="n">urn</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">identified_failures</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">continue</span>

            <span class="n">identifier_obj</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>

            <span class="c1"># form the Metadata object</span>
            <span class="n">combined_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">m_data_dict</span><span class="p">,</span> <span class="n">xml_data_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">combined_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_source&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combined_meta</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span>

            <span class="n">combined_meta</span><span class="p">[</span><span class="s1">&#39;primary_identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier_obj</span>

            <span class="n">metadata</span><span class="p">[</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span><span class="o">**</span><span class="n">combined_meta</span><span class="p">)</span>

            <span class="c1"># Form the CirculationData that would correspond to this Metadata,</span>
            <span class="c1"># assuming there is a Collection to hold the LicensePool that</span>
            <span class="c1"># would result.</span>
            <span class="n">c_data_dict</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
                <span class="n">c_circulation_dict</span> <span class="o">=</span> <span class="n">m_data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;circulation&#39;</span><span class="p">)</span>
                <span class="n">xml_circulation_dict</span> <span class="o">=</span> <span class="n">xml_data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;circulation&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">c_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">c_circulation_dict</span><span class="p">,</span> <span class="n">xml_circulation_dict</span><span class="p">)</span>

            <span class="c1"># Unless there&#39;s something useful in c_data_dict, we&#39;re</span>
            <span class="c1"># not going to put anything under metadata.circulation,</span>
            <span class="c1"># and any partial data that got added to</span>
            <span class="c1"># metadata.circulation is going to be removed.</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">]</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">c_data_dict</span><span class="p">:</span>
                <span class="n">circ_links_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># extract just the links to pass to CirculationData constructor</span>
                <span class="k">if</span> <span class="s1">&#39;links&#39;</span> <span class="ow">in</span> <span class="n">xml_data_dict</span><span class="p">:</span>
                    <span class="n">circ_links_dict</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xml_data_dict</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span>
                <span class="n">combined_circ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">c_data_dict</span><span class="p">,</span> <span class="n">circ_links_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">combined_circ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_source&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">combined_circ</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span>

                <span class="n">combined_circ</span><span class="p">[</span><span class="s1">&#39;primary_identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier_obj</span>
                <span class="n">circulation</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span><span class="o">**</span><span class="n">combined_circ</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_add_format_data</span><span class="p">(</span><span class="n">circulation</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">circulation</span><span class="o">.</span><span class="n">formats</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">internal_identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">]</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the CirculationData has no formats, it</span>
                    <span class="c1"># doesn&#39;t really offer any way to actually get the</span>
                    <span class="c1"># book, and we don&#39;t want to create a</span>
                    <span class="c1"># LicensePool. All the circulation data is</span>
                    <span class="c1"># useless.</span>
                    <span class="c1">#</span>
                    <span class="c1"># TODO: This will need to be revisited when we add</span>
                    <span class="c1"># ODL support.</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">identified_failures</span></div>

<div class="viewcode-block" id="OPDSImporter.handle_failure"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.handle_failure">[docs]</a>    <span class="k">def</span> <span class="nf">handle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urn</span><span class="p">,</span> <span class="n">failure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a URN and a failure message that came in through</span>
<span class="sd">        an OPDS feed into an Identifier and a CoverageFailure object.</span>

<span class="sd">        The Identifier may not be the one designated by `urn` (if it&#39;s</span>
<span class="sd">        found in self.identifier_mapping) and the &#39;failure&#39; may turn out not</span>
<span class="sd">        to be a CoverageFailure at all -- if it&#39;s an Identifier, that means</span>
<span class="sd">        that what a normal OPDSImporter would consider &#39;failure&#39; is</span>
<span class="sd">        considered success.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">external_identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">urn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span><span class="p">:</span>
            <span class="c1"># The identifier found in the OPDS feed is different from</span>
            <span class="c1"># the identifier we want to export.</span>
            <span class="n">internal_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">external_identifier</span><span class="p">,</span> <span class="n">external_identifier</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">internal_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
            <span class="c1"># The OPDSImporter does not actually consider this a</span>
            <span class="c1"># failure. Signal success by returning the internal</span>
            <span class="c1"># identifier as the &#39;failure&#39; object.</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">internal_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This really is a failure. Associate the internal</span>
            <span class="c1"># identifier with the CoverageFailure object.</span>
            <span class="n">failure</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">internal_identifier</span>
        <span class="k">return</span> <span class="n">internal_identifier</span><span class="p">,</span> <span class="n">failure</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_add_format_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">circulation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subclasses that specialize OPDS Import can implement this</span>
<span class="sd">        method to add formats to a CirculationData object with</span>
<span class="sd">        information that allows a patron to actually get a book</span>
<span class="sd">        that&#39;s not open access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="OPDSImporter.combine"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.combine">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine two dictionaries that can be used as keyword arguments to</span>
<span class="sd">        the Metadata constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="p">:</span>
                <span class="c1"># There is no value from d1. Even if the d2 value</span>
                <span class="c1"># is None, we want to set it.</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># d1 provided a value, and d2 provided a value other</span>
                <span class="c1"># than None.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># The values are lists. Merge them.</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># The values are dicts. Merge them by with</span>
                    <span class="c1"># a recursive combine() call.</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Overwrite d1&#39;s value with d2&#39;s value.</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># d1 provided a value and d2 provided None.  Do</span>
                <span class="c1"># nothing.</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">new_dict</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_data_from_feedparser"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_data_from_feedparser">[docs]</a>    <span class="k">def</span> <span class="nf">extract_data_from_feedparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">data_source</span><span class="p">):</span>
        <span class="n">feedparser_parsed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feedparser_parsed</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detail_for_feedparser_entry</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="n">entry</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
                    <span class="n">failures</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">detail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># That&#39;s bad. Can&#39;t make an item-specific error message, but write to</span>
                <span class="c1"># log that something very wrong happened.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tried to parse an element without a valid identifier.  feed=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">feed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">failures</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_metadata_from_elementtree"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_metadata_from_elementtree">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_metadata_from_elementtree</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the OPDS as XML and extract all author and subject</span>
<span class="sd">        information, as well as ratings and medium.</span>

<span class="sd">        All the stuff that Feedparser can&#39;t handle so we have to use lxml.</span>

<span class="sd">        :return: a dictionary mapping IDs to dictionaries. The inner</span>
<span class="sd">            dictionary can be used as keyword arguments to the Metadata</span>
<span class="sd">            constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PARSER_CLASS</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="c1"># Some OPDS feeds (eg Standard Ebooks) contain relative urls,</span>
        <span class="c1"># so we need the feed&#39;s self URL to extract links. If none was</span>
        <span class="c1"># passed in, we still might be able to guess.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: Section 2 of RFC 4287 says we should check xml:base</span>
        <span class="c1"># for this, so if anyone actually uses that we&#39;ll get around</span>
        <span class="c1"># to checking it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feed_url</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;link&#39;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
            <span class="n">self_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rel&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">self_links</span><span class="p">:</span>
                <span class="n">feed_url</span> <span class="o">=</span> <span class="n">self_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># First, turn Simplified &lt;message&gt; tags into CoverageFailure</span>
        <span class="c1"># objects.</span>
        <span class="k">for</span> <span class="n">failure</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">coveragefailures_from_messages</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">root</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                <span class="c1"># The Simplified &lt;message&gt; tag does not actually</span>
                <span class="c1"># represent a failure -- it was turned into an</span>
                <span class="c1"># Identifier instead of a CoverageFailure.</span>
                <span class="n">urn</span> <span class="o">=</span> <span class="n">failure</span><span class="o">.</span><span class="n">urn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">urn</span> <span class="o">=</span> <span class="n">failure</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">urn</span>
            <span class="n">failures</span><span class="p">[</span><span class="n">urn</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="c1"># Then turn Atom &lt;entry&gt; tags into Metadata objects.</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;/atom:feed/atom:entry&#39;</span><span class="p">):</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">failure</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">detail_for_elementtree_entry</span><span class="p">(</span>
                <span class="n">parser</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">do_get</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
                    <span class="n">failures</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>
                <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">detail</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">failures</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_datetime</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">datetime_utc</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>

<div class="viewcode-block" id="OPDSImporter.last_update_date_for_feedparser_entry"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.last_update_date_for_feedparser_entry">[docs]</a>    <span class="k">def</span> <span class="nf">last_update_date_for_feedparser_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetime</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;updated_parsed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">updated</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.data_detail_for_feedparser_entry"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.data_detail_for_feedparser_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">data_detail_for_feedparser_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">data_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an entry dictionary created by feedparser into dictionaries of data</span>
<span class="sd">        that can be used as keyword arguments to the Metadata and CirculationData constructors.</span>

<span class="sd">        :return: A 3-tuple (identifier, kwargs for Metadata constructor, failure)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># At this point we can assume that we successfully got some</span>
        <span class="c1"># metadata, and possibly a link to the actual book.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs_meta</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_data_detail_for_feedparser_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">kwargs_meta</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
            <span class="n">identifier_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">CoverageFailure</span><span class="p">(</span>
                <span class="n">identifier_obj</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">data_source</span><span class="p">,</span>
                <span class="n">transient</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">identifier</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">failure</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_data_detail_for_feedparser_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">metadata_data_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method that extracts metadata and circulation data from a feedparser</span>
<span class="sd">        entry. This method can be overridden in tests to check that callers handle things</span>
<span class="sd">        properly when it throws an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">NO_TITLE</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_alternativeheadline&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Generally speaking, a data source will provide either</span>
        <span class="c1"># metadata (e.g. the Simplified metadata wrangler) or both</span>
        <span class="c1"># metadata and circulation data (e.g. a publisher&#39;s ODL feed).</span>
        <span class="c1">#</span>
        <span class="c1"># However there is at least one case (the Simplified</span>
        <span class="c1"># open-access content server) where one server provides</span>
        <span class="c1"># circulation data from a _different_ data source</span>
        <span class="c1"># (e.g. Project Gutenberg).</span>
        <span class="c1">#</span>
        <span class="c1"># In this case we want the data source of the LicensePool to</span>
        <span class="c1"># be Project Gutenberg, but the data source of the pool&#39;s</span>
        <span class="c1"># presentation to be the open-access content server.</span>
        <span class="c1">#</span>
        <span class="c1"># The open-access content server uses a</span>
        <span class="c1"># &lt;bibframe:distribution&gt; tag to keep track of which data</span>
        <span class="c1"># source provides the circulation data.</span>
        <span class="n">circulation_data_source</span> <span class="o">=</span> <span class="n">metadata_data_source</span>
        <span class="n">circulation_data_source_tag</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bibframe_distribution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">circulation_data_source_tag</span><span class="p">:</span>
            <span class="n">circulation_data_source_name</span> <span class="o">=</span> <span class="n">circulation_data_source_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;bibframe:providername&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">circulation_data_source_name</span><span class="p">:</span>
                <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">metadata_data_source</span><span class="p">)</span>
                <span class="c1"># We know this data source offers licenses because</span>
                <span class="c1"># that&#39;s what the &lt;bibframe:distribution&gt; is there</span>
                <span class="c1"># to say.</span>
                <span class="n">circulation_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">circulation_data_source_name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">offers_licenses</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">circulation_data_source</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Unrecognized circulation data source: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">circulation_data_source_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="n">last_opds_update</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_datetime</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;updated_parsed&#39;</span><span class="p">)</span>

        <span class="n">publisher</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">publisher</span><span class="p">:</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dcterms_publisher&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">language</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dcterms_language&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">summary_to_linkdata</span><span class="p">(</span><span class="n">detail</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">detail</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_link_data</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span>
                <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">content</span>
            <span class="p">)</span>

        <span class="n">summary_detail</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary_detail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">summary_to_linkdata</span><span class="p">(</span><span class="n">summary_detail</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">content_detail</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">summary_to_linkdata</span><span class="p">(</span><span class="n">content_detail</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

        <span class="n">rights_uri</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rights_uri_from_feedparser_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="n">kwargs_meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span>
            <span class="c1"># refers to when was updated in opds feed, not our db</span>
            <span class="n">data_source_last_updated</span><span class="o">=</span><span class="n">last_opds_update</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Although we always provide the CirculationData, it will only</span>
        <span class="c1"># be used if the OPDSImporter has a Collection to hold the</span>
        <span class="c1"># LicensePool that will result from importing it.</span>
        <span class="n">kwargs_circ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">circulation_data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">links</span><span class="p">),</span>
            <span class="n">default_rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kwargs_meta</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs_circ</span>
        <span class="k">return</span> <span class="n">kwargs_meta</span>

<div class="viewcode-block" id="OPDSImporter.rights_uri"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.rights_uri">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rights_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rights_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the URI that best encapsulates the rights status of</span>
<span class="sd">        the downloads associated with this book.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">rights_uri_from_string</span><span class="p">(</span><span class="n">rights_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.rights_uri_from_feedparser_entry"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.rights_uri_from_feedparser_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rights_uri_from_feedparser_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a rights URI from a parsed feedparser entry.</span>

<span class="sd">        :return: A rights URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rights&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">(</span><span class="n">rights</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.rights_uri_from_entry_tag"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.rights_uri_from_entry_tag">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rights_uri_from_entry_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a rights string from an lxml &lt;entry&gt; tag.</span>

<span class="sd">        :return: A rights URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PARSER_CLASS</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;rights&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">(</span><span class="n">rights</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_messages"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_messages">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_messages</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">feed_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract &lt;simplified:message&gt; tags from an OPDS feed and convert</span>
<span class="sd">        them into OPDSMessage objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/atom:feed/simplified:message&#39;</span>
        <span class="k">for</span> <span class="n">message_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">feed_tag</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

            <span class="c1"># First thing to do is determine which Identifier we&#39;re</span>
            <span class="c1"># talking about.</span>
            <span class="n">identifier_tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">message_tag</span><span class="p">,</span> <span class="s1">&#39;atom:id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">identifier_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">urn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">urn</span> <span class="o">=</span> <span class="n">identifier_tag</span><span class="o">.</span><span class="n">text</span>

            <span class="c1"># What status code is associated with the message?</span>
            <span class="n">status_code_tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">message_tag</span><span class="p">,</span> <span class="s1">&#39;simplified:status_code&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status_code_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code_tag</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># What is the human-readable message?</span>
            <span class="n">description_tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">message_tag</span><span class="p">,</span> <span class="s1">&#39;schema:description&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">description_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description_tag</span><span class="o">.</span><span class="n">text</span>

            <span class="k">yield</span> <span class="n">OPDSMessage</span><span class="p">(</span><span class="n">urn</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.coveragefailures_from_messages"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.coveragefailures_from_messages">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">coveragefailures_from_messages</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">feed_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract CoverageFailure objects from a parsed OPDS document. This</span>
<span class="sd">        allows us to determine the fate of books which could not</span>
<span class="sd">        become &lt;entry&gt; tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_messages</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">feed_tag</span><span class="p">):</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">coveragefailure_from_message</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">failure</span></div>

<div class="viewcode-block" id="OPDSImporter.coveragefailure_from_message"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.coveragefailure_from_message">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">coveragefailure_from_message</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a &lt;simplified:message&gt; tag into a CoverageFailure.&quot;&quot;&quot;</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>

        <span class="c1"># First thing to do is determine which Identifier we&#39;re</span>
        <span class="c1"># talking about. If we can&#39;t do that, we can&#39;t create a</span>
        <span class="c1"># CoverageFailure object.</span>
        <span class="n">urn</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">urn</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">urn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="c1"># We can&#39;t associate this message with any particular</span>
            <span class="c1"># Identifier so we can&#39;t turn it into a CoverageFailure.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">SUCCESS_STATUS_CODES</span>
            <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SUCCESS_STATUS_CODES</span><span class="p">):</span>
            <span class="c1"># This message is telling us that nothing went wrong. It</span>
            <span class="c1"># should be treated as a success.</span>
            <span class="k">return</span> <span class="n">identifier</span>

        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># By default, we treat a message with a 200 status code</span>
            <span class="c1"># as though nothing had been returned at all.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">message</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">status_code</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status_code</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="s1">&#39;No detail provided.&#39;</span>

        <span class="c1"># All these CoverageFailures are transient because ATM we can</span>
        <span class="c1"># only assume that the server will eventually have the data.</span>
        <span class="k">return</span> <span class="n">CoverageFailure</span><span class="p">(</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.detail_for_elementtree_entry"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.detail_for_elementtree_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detail_for_elementtree_entry</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Turn an &lt;atom:entry&gt; tag into a dictionary of metadata that can be</span>
<span class="sd">        used as keyword arguments to the Metadata contructor.</span>

<span class="sd">        :return: A 2-tuple (identifier, kwargs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;atom:id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">identifier</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="c1"># This &lt;entry&gt; tag doesn&#39;t identify a book so we</span>
            <span class="c1"># can&#39;t derive any information from it.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">text</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_detail_for_elementtree_entry</span><span class="p">(</span>
                <span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">do_get</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
            <span class="n">identifier_obj</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">CoverageFailure</span><span class="p">(</span>
                <span class="n">identifier_obj</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">data_source</span><span class="p">,</span>
                <span class="n">transient</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">identifier</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">failure</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_detail_for_elementtree_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method that extracts metadata and circulation data from an elementtree</span>
<span class="sd">        entry. This method can be overridden in tests to check that callers handle things</span>
<span class="sd">        properly when it throws an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We will fill this dictionary with all the information</span>
        <span class="c1"># we can find.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">alternate_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">id_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s2">&quot;dcterms:identifier&quot;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_identifier</span><span class="p">(</span><span class="n">id_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">alternate_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dcterms_identifiers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alternate_identifiers</span>

        <span class="c1"># If exist another identifer, add here</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;identifiers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dcterms_identifiers&#39;</span><span class="p">]</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">author_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;atom:author&#39;</span><span class="p">):</span>
            <span class="n">contributor</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_contributor</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">author_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contributor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">extract_subject</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">category_tag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">category_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;atom:category&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">ratings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rating_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;schema:Rating&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_measurement</span><span class="p">(</span><span class="n">rating_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;measurements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span>
        <span class="n">rights_uri</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rights_uri_from_entry_tag</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">consolidate_links</span><span class="p">([</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">extract_link</span><span class="p">(</span><span class="n">link_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">link_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;atom:link&#39;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">derived_medium</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_medium_from_links</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_medium</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="n">derived_medium</span><span class="p">)</span>

        <span class="n">series_tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;schema:Series&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">series_tag</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;series_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract_series</span><span class="p">(</span><span class="n">series_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">issued_tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;dcterms:issued&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">issued_tag</span><span class="p">:</span>
            <span class="n">date_string</span> <span class="o">=</span> <span class="n">issued_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="c1"># By default, the date for strings that only have a year will</span>
            <span class="c1"># be set to January 1 rather than the current date.</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">datetime_utc</span><span class="p">(</span><span class="n">utc_now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;published&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># This entry had an issued tag, but it was in a format we couldn&#39;t parse.</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="OPDSImporter.get_medium_from_links"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.get_medium_from_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_medium_from_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get medium if derivable from information in an acquisition link.&quot;&quot;&quot;</span>
        <span class="n">derived</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://opds-spec.org/acquisition/&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">derived</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">medium_from_media_type</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">derived</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">derived</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_identifier"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_identifier">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a &lt;dcterms:identifier&gt; tag into an IdentifierData object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">type_and_identifier_for_urn</span><span class="p">(</span><span class="n">identifier_tag</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">IdentifierData</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_medium"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_medium">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_medium</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive a value for Edition.medium from schema:additionalType or</span>
<span class="sd">        from a &lt;dcterms:format&gt; subtag.</span>

<span class="sd">        :param entry_tag: A &lt;atom:entry&gt; tag.</span>
<span class="sd">        :param default: The value to use if nothing is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

        <span class="n">medium</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">additional_type</span> <span class="o">=</span> <span class="n">entry_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}additionalType&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">additional_type</span><span class="p">:</span>
            <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">additional_type_to_medium</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">additional_type</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">medium</span><span class="p">:</span>
            <span class="n">format_tag</span> <span class="o">=</span> <span class="n">entry_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;{http://purl.org/dc/terms/}format&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">format_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">media_type</span> <span class="o">=</span> <span class="n">format_tag</span><span class="o">.</span><span class="n">text</span>
                <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">medium_from_media_type</span><span class="p">(</span><span class="n">media_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">medium</span> <span class="ow">or</span> <span class="n">default</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_contributor"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_contributor">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_contributor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">author_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an &lt;atom:author&gt; tag into a ContributorData object.&quot;&quot;&quot;</span>
        <span class="n">subtag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">text_of_optional_subtag</span>
        <span class="n">sort_name</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">author_tag</span><span class="p">,</span> <span class="s1">&#39;simplified:sort_name&#39;</span><span class="p">)</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">author_tag</span><span class="p">,</span> <span class="s1">&#39;atom:name&#39;</span><span class="p">)</span>
        <span class="n">family_name</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">author_tag</span><span class="p">,</span> <span class="s2">&quot;simplified:family_name&quot;</span><span class="p">)</span>
        <span class="n">wikipedia_name</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">author_tag</span><span class="p">,</span> <span class="s2">&quot;simplified:wikipedia_name&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: we need a way of conveying roles. I believe Bibframe</span>
        <span class="c1"># has the answer.</span>

        <span class="c1"># TODO: Also collect VIAF and LC numbers if present.  This</span>
        <span class="c1"># requires parsing the URIs. Only the metadata wrangler will</span>
        <span class="c1"># provide this information.</span>

        <span class="n">viaf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sort_name</span> <span class="ow">or</span> <span class="n">display_name</span> <span class="ow">or</span> <span class="n">viaf</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ContributorData</span><span class="p">(</span>
                <span class="n">sort_name</span><span class="o">=</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
                <span class="n">family_name</span><span class="o">=</span><span class="n">family_name</span><span class="p">,</span>
                <span class="n">wikipedia_name</span><span class="o">=</span><span class="n">wikipedia_name</span><span class="p">,</span>
                <span class="n">roles</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Refusing to create ContributorData for contributor with no sort name, display name, or VIAF.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_subject"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_subject">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_subject</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">category_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an &lt;atom:category&gt; tag into a SubjectData object.&quot;&quot;&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">category_tag</span><span class="o">.</span><span class="n">attrib</span>

        <span class="c1"># Retrieve the type of this subject - FAST, Dewey Decimal,</span>
        <span class="c1"># etc.</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scheme&#39;</span><span class="p">)</span>
        <span class="n">subject_type</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">by_uri</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subject_type</span><span class="p">:</span>
            <span class="c1"># We can&#39;t represent this subject because we don&#39;t</span>
            <span class="c1"># know its scheme. Just treat it as a tag.</span>
            <span class="n">subject_type</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">TAG</span>

        <span class="c1"># Retrieve the term (e.g. &quot;827&quot;) and human-readable name</span>
        <span class="c1"># (e.g. &quot;English Satire &amp; Humor&quot;) for this subject.</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="n">default_weight</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}ratingValue&#39;</span><span class="p">,</span> <span class="n">default_weight</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">default_weight</span>

        <span class="k">return</span> <span class="n">SubjectData</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">subject_type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">term</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_link"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_link">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_link</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">link_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entry_rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a &lt;link&gt; tag into a LinkData object.</span>

<span class="sd">        :param feed_url: The URL to the enclosing feed, for use in resolving</span>
<span class="sd">            relative links.</span>

<span class="sd">        :param entry_rights_uri: A URI describing the rights advertised</span>
<span class="sd">            in the entry. Unless this specific link says otherwise, we</span>
<span class="sd">            will assume that the representation on the other end of the link</span>
<span class="sd">            if made available on these terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rel&#39;</span><span class="p">)</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rel</span><span class="p">:</span>
            <span class="c1"># The link exists but has no destination, or no specified</span>
            <span class="c1"># relationship to the entry.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}rights&#39;</span> <span class="o">%</span> <span class="n">OPDSXMLParser</span><span class="o">.</span><span class="n">NAMESPACES</span><span class="p">[</span><span class="s2">&quot;dcterms&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rights</span><span class="p">:</span>
            <span class="c1"># Rights associated with the link override rights</span>
            <span class="c1"># associated with the entry.</span>
            <span class="n">rights_uri</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rights_uri</span><span class="p">(</span><span class="n">rights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rights_uri</span> <span class="o">=</span> <span class="n">entry_rights_uri</span>
        <span class="k">if</span> <span class="n">feed_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">href</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
            <span class="c1"># This link is relative, so we need to get the absolute url</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">feed_url</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_link_data</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.make_link_data"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.make_link_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_link_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rights_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hook method for creating a LinkData object.</span>

<span class="sd">        Intended to be overridden in subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LinkData</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">,</span>
                        <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImporter.consolidate_links"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.consolidate_links">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">consolidate_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to match up links with their thumbnails.</span>

<span class="sd">        If link n is an image and link n+1 is a thumbnail, then the</span>
<span class="sd">        thumbnail is assumed to be the thumbnail of the image.</span>

<span class="sd">        Similarly if link n is a thumbnail and link n+1 is an image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Strip out any links that didn&#39;t get turned into LinkData objects</span>
        <span class="c1"># due to missing `href` or whatever.</span>
        <span class="n">new_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># Make a new list of links from that list, to iterate over --</span>
        <span class="c1"># we&#39;ll be modifying new_links in place so we can&#39;t iterate</span>
        <span class="c1"># over it.</span>
        <span class="n">links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_links</span><span class="p">)</span>

        <span class="n">next_link_already_handled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">,</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">):</span>
                <span class="c1"># This is not any kind of image. Ignore it.</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">next_link_already_handled</span><span class="p">:</span>
                <span class="c1"># This link and the previous link were part of an</span>
                <span class="c1"># image-thumbnail pair.</span>
                <span class="n">next_link_already_handled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># This is the last link. Since there is no next link</span>
                <span class="c1"># there&#39;s nothing to do here.</span>
                <span class="k">continue</span>

            <span class="c1"># Peek at the next link.</span>
            <span class="n">next_link</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span>
                <span class="ow">and</span> <span class="n">next_link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">):</span>
                <span class="c1"># This link is a thumbnail and the next link is</span>
                <span class="c1"># (presumably) the corresponding image.</span>
                <span class="n">thumbnail_link</span> <span class="o">=</span> <span class="n">link</span>
                <span class="n">image_link</span> <span class="o">=</span> <span class="n">next_link</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span>
                  <span class="ow">and</span> <span class="n">next_link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">):</span>
                <span class="n">thumbnail_link</span> <span class="o">=</span> <span class="n">next_link</span>
                <span class="n">image_link</span> <span class="o">=</span> <span class="n">link</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This link and the next link do not form an</span>
                <span class="c1"># image-thumbnail pair. Do nothing.</span>
                <span class="k">continue</span>

            <span class="n">image_link</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">thumbnail_link</span>
            <span class="n">new_links</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thumbnail_link</span><span class="p">)</span>
            <span class="n">next_link_already_handled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">new_links</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_measurement"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_measurement">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_measurement</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rating_tag</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">rating_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}additionalType&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">rating_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}ratingValue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">rating_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org}ratingValue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">RATING</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">MeasurementData</span><span class="p">(</span>
                <span class="n">quantity_measured</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OPDSImporter.extract_series"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImporter.extract_series">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_series</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">series_tag</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">series_tag</span><span class="o">.</span><span class="n">attrib</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">series_position</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://schema.org/}position&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series_name</span><span class="p">,</span> <span class="n">series_position</span></div></div>


<div class="viewcode-block" id="OPDSImportMonitor"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">OPDSImportMonitor</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Periodically monitor a Collection&#39;s OPDS archive feed and import</span>
<span class="sd">    every title it mentions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;OPDS Import Monitor&quot;</span>

    <span class="c1"># The first time this Monitor is invoked we want to get the</span>
    <span class="c1"># entire OPDS feed.</span>
    <span class="n">DEFAULT_START_TIME</span> <span class="o">=</span> <span class="n">CollectionMonitor</span><span class="o">.</span><span class="n">NEVER</span>

    <span class="c1"># The protocol this Monitor works with. Subclasses that</span>
    <span class="c1"># specialize OPDS import should override this.</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span>
                 <span class="n">force_reimport</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">import_class_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;OPDSImportMonitor can only be run in the context of a Collection.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROTOCOL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection </span><span class="si">%s</span><span class="s2"> is configured for protocol </span><span class="si">%s</span><span class="s2">, not </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROTOCOL</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_source</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection </span><span class="si">%s</span><span class="s2"> has no associated data source.&quot;</span> <span class="o">%</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opds_url</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_reimport</span> <span class="o">=</span> <span class="n">force_reimport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_accept_header</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">custom_accept_header</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">importer</span> <span class="o">=</span> <span class="n">import_class</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="o">**</span><span class="n">import_class_kwargs</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPDSImportMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="OPDSImportMonitor.external_integration"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
                       <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the first page of the OPDS feed&quot;&quot;&quot;</span>
        <span class="n">first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Retrieve the first page of the OPDS feed (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">follow_one_link</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">first_page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_page</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># We got a page, but does it have anything the importer can</span>
        <span class="c1"># turn into a Work?</span>
        <span class="c1">#</span>
        <span class="c1"># By default, this means it must contain an open-access link.</span>
        <span class="n">next_links</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">first_page</span><span class="o">.</span><span class="n">result</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Checking for importable content&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">assert_importable_content</span><span class="p">,</span>
            <span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the sort of HTTP request that&#39;s normal for an OPDS feed.</span>

<span class="sd">        Long timeout, raise error on anything but 2xx or 3xx.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2xx&#39;</span><span class="p">,</span> <span class="s1">&#39;3xx&#39;</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">get_with_timeout</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">_get_accept_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
            <span class="s2">&quot;application/atom+xml;q=0.9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;application/xml;q=0.8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;*/*;q=0.1&quot;</span><span class="p">,</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="k">if</span> <span class="n">headers</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basic </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_accept_header</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_accept_header</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;Accept&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_accept_header</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">headers</span>

    <span class="k">def</span> <span class="nf">_parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the publication&#39;s identifier from its metadata.</span>

<span class="sd">        :param identifier: String containing the identifier</span>
<span class="sd">        :type identifier: str</span>

<span class="sd">        :return: Identifier object</span>
<span class="sd">        :rtype: Identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

<div class="viewcode-block" id="OPDSImportMonitor.opds_url"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.opds_url">[docs]</a>    <span class="k">def</span> <span class="nf">opds_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the OPDS import URL for the given collection.</span>

<span class="sd">        By default, this URL is stored as the external account ID, but</span>
<span class="sd">        subclasses may override this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span></div>

<div class="viewcode-block" id="OPDSImportMonitor.data_source"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.data_source">[docs]</a>    <span class="k">def</span> <span class="nf">data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the data source name for the given collection.</span>

<span class="sd">        By default, this URL is stored as a setting on the collection, but</span>
<span class="sd">        subclasses may hard-code it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span></div>

<div class="viewcode-block" id="OPDSImportMonitor.feed_contains_new_data"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.feed_contains_new_data">[docs]</a>    <span class="k">def</span> <span class="nf">feed_contains_new_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the given feed contain any entries that haven&#39;t been imported</span>
<span class="sd">        yet?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_reimport</span><span class="p">:</span>
            <span class="c1"># We don&#39;t even need to check. Always treat the feed as</span>
            <span class="c1"># though it contained new data.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># For every item in the last page of the feed, check when that</span>
        <span class="c1"># item was last updated.</span>
        <span class="n">last_update_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">extract_last_update_dates</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>

        <span class="n">new_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">remote_updated</span> <span class="ow">in</span> <span class="n">last_update_dates</span><span class="p">:</span>

            <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="c1"># Maybe this is new, maybe not, but we can&#39;t associate</span>
                <span class="c1"># the information with an Identifier, so we can&#39;t do</span>
                <span class="c1"># anything about it.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Ignoring </span><span class="si">%s</span><span class="s2"> because unable to turn into an Identifier.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_needs_import</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">remote_updated</span><span class="p">):</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">new_data</span></div>

<div class="viewcode-block" id="OPDSImportMonitor.identifier_needs_import"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.identifier_needs_import">[docs]</a>    <span class="k">def</span> <span class="nf">identifier_needs_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">last_updated_remote</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the remote side have new information about this Identifier?</span>

<span class="sd">        :param identifier: An Identifier.</span>
<span class="sd">        :param last_update_remote: The last time the remote side updated</span>
<span class="sd">            the OPDS entry for this Identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">IMPORT_OPERATION</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
            <span class="c1"># We have no record of importing this Identifier. Import</span>
            <span class="c1"># it now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Counting </span><span class="si">%s</span><span class="s2"> as new because it has no CoverageRecord.&quot;</span><span class="p">,</span>
                <span class="n">identifier</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If there was a transient failure last time we tried to</span>
        <span class="c1"># import this book, try again regardless of whether the</span>
        <span class="c1"># feed has changed.</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">TRANSIENT_FAILURE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Counting </span><span class="si">%s</span><span class="s2"> as new because previous attempt resulted in transient failure: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">exception</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If our last attempt was a success or a persistent</span>
        <span class="c1"># failure, we only want to import again if something</span>
        <span class="c1"># changed since then.</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
            <span class="c1"># We&#39;ve imported this entry before, so don&#39;t import it</span>
            <span class="c1"># again unless it&#39;s changed.</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_updated_remote</span><span class="p">:</span>
                <span class="c1"># The remote isn&#39;t telling us whether the entry</span>
                <span class="c1"># has been updated. Import it again to be safe.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Counting </span><span class="si">%s</span><span class="s2"> as new because remote has no information about when it was updated.&quot;</span><span class="p">,</span>
                    <span class="n">identifier</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">last_updated_remote</span> <span class="o">&gt;=</span> <span class="n">record</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
                <span class="c1"># This book has been updated.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Counting </span><span class="si">%s</span><span class="s2"> as new because its coverage date is </span><span class="si">%s</span><span class="s2"> and remote has </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">last_updated_remote</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_verify_media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="c1"># Make sure we got an OPDS feed, and not an error page that was</span>
        <span class="c1"># sent with a 200 status code.</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">media_type</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">x</span> <span class="ow">in</span> <span class="n">media_type</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ATOM_LIKE_TYPES</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Expected Atom feed, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">media_type</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">debug_message</span><span class="o">=</span><span class="n">feed</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span>
            <span class="p">)</span>

<div class="viewcode-block" id="OPDSImportMonitor.follow_one_link"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.follow_one_link">[docs]</a>    <span class="k">def</span> <span class="nf">follow_one_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download a representation of a URL and extract the useful</span>
<span class="sd">        information.</span>

<span class="sd">        :return: A 2-tuple (next_links, feed). `next_links` is a list of</span>
<span class="sd">            additional links that need to be followed. `feed` is the content</span>
<span class="sd">            that needs to be imported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Following next link: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">get</span> <span class="o">=</span> <span class="n">do_get</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span>
        <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">feed</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_media_type</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>

        <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_contains_new_data</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_data</span><span class="p">:</span>
            <span class="c1"># There&#39;s something new on this page, so we need to check</span>
            <span class="c1"># the next page as well.</span>
            <span class="n">next_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">extract_next_links</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">next_links</span><span class="p">,</span> <span class="n">feed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There&#39;s nothing new, so we don&#39;t need to import this</span>
            <span class="c1"># feed or check the next page.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No new data.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OPDSImportMonitor.import_one_feed"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.import_one_feed">[docs]</a>    <span class="k">def</span> <span class="nf">import_one_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import every book mentioned in an OPDS feed.&quot;&quot;&quot;</span>

        <span class="c1"># Because we are importing into a Collection, we will immediately</span>
        <span class="c1"># mark a book as presentation-ready if possible.</span>
        <span class="n">imported_editions</span><span class="p">,</span> <span class="n">pools</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">import_from_feed</span><span class="p">(</span>
            <span class="n">feed</span><span class="p">,</span>
            <span class="n">feed_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opds_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create CoverageRecords for the successful imports.</span>
        <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">imported_editions</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">add_for</span><span class="p">(</span>
                <span class="n">edition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
                <span class="n">CoverageRecord</span><span class="o">.</span><span class="n">IMPORT_OPERATION</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">SUCCESS</span>
            <span class="p">)</span>

        <span class="c1"># Create CoverageRecords for the failures.</span>
        <span class="k">for</span> <span class="n">urn</span><span class="p">,</span> <span class="n">failure</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">failure</span><span class="o">.</span><span class="n">to_coverage_record</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">IMPORT_OPERATION</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">imported_editions</span><span class="p">,</span> <span class="n">failures</span></div>

    <span class="k">def</span> <span class="nf">_get_feeds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">]</span>
        <span class="n">seen_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

        <span class="c1"># First, follow the feed&#39;s next links until we reach a page with</span>
        <span class="c1"># nothing new. If any link raises an exception, nothing will be imported.</span>

        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">new_queue</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">seen_links</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">next_links</span><span class="p">,</span> <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_one_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">new_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">next_links</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">feed</span><span class="p">:</span>
                    <span class="n">feeds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">link</span><span class="p">,</span> <span class="n">feed</span><span class="p">))</span>
                <span class="n">seen_links</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

            <span class="n">queue</span> <span class="o">=</span> <span class="n">new_queue</span>

        <span class="c1"># Start importing at the end. If something fails, it will be easier to</span>
        <span class="c1"># pick up where we left off.</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">feeds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feeds</span>

<div class="viewcode-block" id="OPDSImportMonitor.run_once"><a class="viewcode-back" href="../../core.html#core.opds_import.OPDSImportMonitor.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_ignore</span><span class="p">):</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeds</span><span class="p">()</span>
        <span class="n">total_imported</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_failures</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">link</span><span class="p">,</span> <span class="n">feed</span> <span class="ow">in</span> <span class="n">feeds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Importing next feed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
            <span class="n">imported_editions</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_one_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
            <span class="n">total_imported</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imported_editions</span><span class="p">)</span>
            <span class="n">total_failures</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">achievements</span> <span class="o">=</span> <span class="s2">&quot;Items imported: </span><span class="si">%d</span><span class="s2">. Failures: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">total_imported</span><span class="p">,</span> <span class="n">total_failures</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">achievements</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>