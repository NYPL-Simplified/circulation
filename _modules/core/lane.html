
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>core.lane &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.lane</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">NumericRange</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">case</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
    <span class="n">not_</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Table</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">text</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.associationproxy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">association_proxy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">hybrid_property</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">aliased</span><span class="p">,</span>
    <span class="n">backref</span><span class="p">,</span>
    <span class="n">contains_eager</span><span class="p">,</span>
    <span class="n">defer</span><span class="p">,</span>
    <span class="n">joinedload</span><span class="p">,</span>
    <span class="n">lazyload</span><span class="p">,</span>
    <span class="n">relationship</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">literal</span>
<span class="kn">import</span> <span class="nn">elasticsearch</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">event</span><span class="p">,</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">UniqueConstraint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ARRAY</span><span class="p">,</span>
    <span class="n">INT4RANGE</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">classifier</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">.classifier</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Classifier</span><span class="p">,</span>
    <span class="n">GenreData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.entrypoint</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EntryPoint</span><span class="p">,</span>
    <span class="n">EverythingEntryPoint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">directly_modified</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">numericrange_to_tuple</span><span class="p">,</span>
    <span class="n">site_configuration_has_changed</span><span class="p">,</span>
    <span class="n">tuple_to_numericrange</span><span class="p">,</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">CachedFeed</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">CustomListEntry</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">Genre</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">WorkGenre</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.model.constants</span> <span class="kn">import</span> <span class="n">EditionConstants</span>
<span class="kn">from</span> <span class="nn">.facets</span> <span class="kn">import</span> <span class="n">FacetConstants</span>
<span class="kn">from</span> <span class="nn">.problem_details</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">fast_query_count</span><span class="p">,</span>
    <span class="n">LanguageCodes</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.problem_detail</span> <span class="kn">import</span> <span class="n">ProblemDetail</span>
<span class="kn">from</span> <span class="nn">.util.accept_language</span> <span class="kn">import</span> <span class="n">parse_accept_language</span>
<span class="kn">from</span> <span class="nn">.util.opds_writer</span> <span class="kn">import</span> <span class="n">OPDSFeed</span>
<span class="kn">from</span> <span class="nn">.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="BaseFacets"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets">[docs]</a><span class="k">class</span> <span class="nc">BaseFacets</span><span class="p">(</span><span class="n">FacetConstants</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic faceting class that doesn&#39;t modify a search filter at all.</span>

<span class="sd">    This is intended solely for use as a base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If the use of a certain faceting object has implications for the</span>
    <span class="c1"># type of feed (the way FeaturedFacets always implies a &#39;groups&#39; feed),</span>
    <span class="c1"># set the type of feed here. This will override any CACHED_FEED_TYPE</span>
    <span class="c1"># associated with the WorkList.</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># By default, faceting objects have no opinion on how long the feeds</span>
    <span class="c1"># generated using them should be cached.</span>
    <span class="n">max_cache_age</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaseFacets.items"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yields a 2-tuple for every active facet setting.</span>

<span class="sd">        These tuples are used to generate URLs that can identify</span>
<span class="sd">        specific facet settings, and to distinguish between CachedFeed</span>
<span class="sd">        objects that represent the same feed with different facet</span>
<span class="sd">        settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This faceting object&#39;s opinion on whether feeds should be cached.</span>

<span class="sd">        :return: A boolean, or None for &#39;no opinion&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A query string fragment that propagates all active facet</span>
<span class="sd">        settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">facet_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield a list of 4-tuples</span>
<span class="sd">        (facet group, facet value, new Facets object, selected)</span>
<span class="sd">        for use in building OPDS facets.</span>

<span class="sd">        This does not include the &#39;entry point&#39; facet group,</span>
<span class="sd">        which must be handled separately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="BaseFacets.selectable_entrypoints"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets.selectable_entrypoints">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">selectable_entrypoints</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ignore all entry points, even if the WorkList supports them.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="BaseFacets.modify_search_filter"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify an external_search.Filter object to filter out works</span>
<span class="sd">        excluded by the business logic of this faceting class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="BaseFacets.modify_database_query"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets.modify_database_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If necessary, modify a database query so that resulting</span>
<span class="sd">        items conform the constraints of this faceting object.</span>

<span class="sd">        The default behavior is to not modify the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qu</span></div>

<div class="viewcode-block" id="BaseFacets.scoring_functions"><a class="viewcode-back" href="../../core.html#core.lane.BaseFacets.scoring_functions">[docs]</a>    <span class="k">def</span> <span class="nf">scoring_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a list of ScoringFunction objects that modify how</span>
<span class="sd">        works in the given WorkList should be ordered.</span>

<span class="sd">        Most subclasses will not use this because they order</span>
<span class="sd">        works using the &#39;order&#39; feature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>


<div class="viewcode-block" id="FacetsWithEntryPoint"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint">[docs]</a><span class="k">class</span> <span class="nc">FacetsWithEntryPoint</span><span class="p">(</span><span class="n">BaseFacets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic Facets class that knows how to filter a query based on a</span>
<span class="sd">    selected EntryPoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">max_cache_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param entrypoint: An EntryPoint (optional).</span>
<span class="sd">        :param entrypoint_is_default: If this is True, then `entrypoint`</span>
<span class="sd">            is a default value and was not determined by a user&#39;s</span>
<span class="sd">            explicit choice.</span>
<span class="sd">        :param max_cache_age: Any feeds generated by this faceting object</span>
<span class="sd">            will be cached for this amount of time. The default is to have</span>
<span class="sd">            no opinion and let the Worklist manage this.</span>
<span class="sd">        :param kwargs: Other arguments may be supplied based on user</span>
<span class="sd">            input, but the default implementation is to ignore them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span> <span class="o">=</span> <span class="n">entrypoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint_is_default</span> <span class="o">=</span> <span class="n">entrypoint_is_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span> <span class="o">=</span> <span class="n">max_cache_age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="FacetsWithEntryPoint.selectable_entrypoints"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.selectable_entrypoints">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">selectable_entrypoints</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Which EntryPoints can be selected for these facets on this</span>
<span class="sd">        WorkList?</span>

<span class="sd">        In most cases, there are no selectable EntryPoints; this generally</span>
<span class="sd">        happens only at the top level.</span>

<span class="sd">        By default, this is completely determined by the WorkList.</span>
<span class="sd">        See SearchFacets for an example that changes this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">worklist</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">worklist</span><span class="o">.</span><span class="n">entrypoints</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.navigate"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.navigate">[docs]</a>    <span class="k">def</span> <span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a very similar FacetsWithEntryPoint that points to</span>
<span class="sd">        a different EntryPoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">max_cache_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">constructor_kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.from_request"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">facet_config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
            <span class="n">default_entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a faceting object from an HTTP request.</span>

<span class="sd">        :param facet_config: A Library (or mock of one) that knows</span>
<span class="sd">           which subset of the available facets are configured.</span>

<span class="sd">        :param get_argument: A callable that takes one argument and</span>
<span class="sd">           retrieves (or pretends to retrieve) a query string</span>
<span class="sd">           parameter of that name from an incoming HTTP request.</span>

<span class="sd">        :param get_header: A callable that takes one argument and</span>
<span class="sd">           retrieves (or pretends to retrieve) an HTTP header</span>
<span class="sd">           of that name from an incoming HTTP request.</span>

<span class="sd">        :param worklist: A WorkList associated with the current request,</span>
<span class="sd">           if any.</span>

<span class="sd">        :param default_entrypoint: Select this EntryPoint if the</span>
<span class="sd">           incoming request does not specify an enabled EntryPoint.</span>
<span class="sd">           If this is None, the first enabled EntryPoint will be used</span>
<span class="sd">           as the default.</span>

<span class="sd">        :param extra_kwargs: A dictionary of keyword arguments to pass</span>
<span class="sd">           into the constructor when a faceting object is instantiated.</span>

<span class="sd">        :return: A FacetsWithEntryPoint, or a ProblemDetail if there&#39;s</span>
<span class="sd">            a problem with the input from the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_request</span><span class="p">(</span>
            <span class="n">facet_config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
            <span class="n">default_entrypoint</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_request</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">facet_config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
            <span class="n">default_entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a faceting object from an HTTP request.</span>

<span class="sd">        Subclasses of FacetsWithEntryPoint can override `from_request`,</span>
<span class="sd">        but call this method to load the EntryPoint and actually</span>
<span class="sd">        instantiate the faceting class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entrypoint_name</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">ENTRY_POINT_FACET_GROUP_NAME</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">valid_entrypoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">selectable_entrypoints</span><span class="p">(</span><span class="n">facet_config</span><span class="p">))</span>
        <span class="n">entrypoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_entrypoint</span><span class="p">(</span>
            <span class="n">entrypoint_name</span><span class="p">,</span> <span class="n">valid_entrypoints</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_entrypoint</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">entrypoint</span>
        <span class="n">entrypoint</span><span class="p">,</span> <span class="n">is_default</span> <span class="o">=</span> <span class="n">entrypoint</span>

        <span class="n">max_cache_age</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">MAX_CACHE_AGE_NAME</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">max_cache_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_max_cache_age</span><span class="p">(</span><span class="n">max_cache_age</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_cache_age</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">max_cache_age</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="n">is_default</span><span class="p">,</span>
            <span class="n">max_cache_age</span><span class="o">=</span><span class="n">max_cache_age</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FacetsWithEntryPoint.load_entrypoint"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.load_entrypoint">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_entrypoint</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">valid_entrypoints</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up an EntryPoint by name, assuming it&#39;s valid in the</span>
<span class="sd">        given WorkList.</span>

<span class="sd">        :param valid_entrypoints: The EntryPoints that might be</span>
<span class="sd">            valid. This is probably not the value of</span>
<span class="sd">            WorkList.selectable_entrypoints, because an EntryPoint</span>
<span class="sd">            selected in a WorkList remains valid (but not selectable) for</span>
<span class="sd">            all of its children.</span>

<span class="sd">        :param default: A class to use as the default EntryPoint if</span>
<span class="sd">            none is specified. If no default is specified, the first</span>
<span class="sd">            enabled EntryPoint will be used.</span>

<span class="sd">        :return: A 2-tuple (EntryPoint class, is_default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_entrypoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">valid_entrypoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">BY_INTERNAL_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ep</span> <span class="ow">or</span> <span class="n">ep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_entrypoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ep</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.load_max_cache_age"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.load_max_cache_age">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_max_cache_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a value for the MAX_CACHE_AGE_NAME parameter to a value</span>
<span class="sd">        that CachedFeed will understand.</span>

<span class="sd">        :param value: A string.</span>
<span class="sd">        :return: For now, either CachedFeed.IGNORE_CACHE or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># At the moment, the only acceptable value that can be set</span>
        <span class="c1"># through the web is zero -- i.e. don&#39;t use the cache at</span>
        <span class="c1"># all. We can&#39;t give web clients fine-grained control over</span>
        <span class="c1"># the internal workings of our cache; the most we can do</span>
        <span class="c1"># is give them the opportunity to opt out.</span>
        <span class="c1">#</span>
        <span class="c1"># Thus, any nonzero value will be ignored.</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">IGNORE_CACHE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.items"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yields a 2-tuple for every active facet setting.</span>

<span class="sd">        In this class that just means the entrypoint and any max_cache_age.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENTRY_POINT_FACET_GROUP_NAME</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">INTERNAL_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">CACHE_FOREVER</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span> <span class="o">==</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">IGNORE_CACHE</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_CACHE_AGE_NAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.modify_search_filter"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the given external_search.Filter object</span>
<span class="sd">        so that it reflects this set of facets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">modify_search_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="FacetsWithEntryPoint.modify_database_query"><a class="viewcode-back" href="../../core.html#core.lane.FacetsWithEntryPoint.modify_database_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the given database query so that it reflects this set of</span>
<span class="sd">        facets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div></div>


<div class="viewcode-block" id="Facets"><a class="viewcode-back" href="../../core.html#core.lane.Facets">[docs]</a><span class="k">class</span> <span class="nc">Facets</span><span class="p">(</span><span class="n">FacetsWithEntryPoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A full-fledged facet class that supports complex navigation between</span>
<span class="sd">    multiple facet groups.</span>

<span class="sd">    Despite the generic name, this is only used in &#39;page&#39; type OPDS</span>
<span class="sd">    feeds that list all the works in some WorkList.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ORDER_BY_RELEVANCE</span> <span class="o">=</span> <span class="s2">&quot;relevance&quot;</span>

<div class="viewcode-block" id="Facets.default"><a class="viewcode-back" href="../../core.html#core.lane.Facets.default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="n">availability</span><span class="p">,</span>
                   <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="Facets.available_facets"><a class="viewcode-back" href="../../core.html#core.lane.Facets.available_facets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available_facets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Which facets are enabled for the given facet group?</span>

<span class="sd">        You can override this to forcible enable or disable facets</span>
<span class="sd">        that might not be enabled in library configuration, but you</span>
<span class="sd">        can&#39;t make up totally new facets.</span>

<span class="sd">        TODO: This sytem would make more sense if you _could_ make up</span>
<span class="sd">        totally new facets, maybe because each facet was represented</span>
<span class="sd">        as a policy object rather than a key to code implemented</span>
<span class="sd">        elsewhere in this class. Right now this method implies more</span>
<span class="sd">        flexibility than actually exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span><span class="n">facet_group_name</span><span class="p">)</span>

        <span class="c1"># &quot;The default facet isn&#39;t available&quot; makes no sense. If the</span>
        <span class="c1"># default facet is not in the available list for any reason,</span>
        <span class="c1"># add it to the beginning of the list. This makes other code</span>
        <span class="c1"># elsewhere easier to write.</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">default</span><span class="p">]</span> <span class="o">+</span> <span class="n">available</span>
        <span class="k">return</span> <span class="n">available</span></div>

<div class="viewcode-block" id="Facets.default_facet"><a class="viewcode-back" href="../../core.html#core.lane.Facets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default value for the given facet group.</span>

<span class="sd">        The default value must be one of the values returned by available_facets() above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">facet_group_name</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_values_from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
        <span class="n">order_facets</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">order_facets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_INPUT</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know how to order a feed by &#39;</span><span class="si">%(order)s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                <span class="mi">400</span>
            <span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
        <span class="n">availability_facets</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">availability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">availability</span> <span class="ow">in</span> <span class="n">availability_facets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_INPUT</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;I don&#39;t understand the availability term &#39;</span><span class="si">%(availability)s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="n">availability</span><span class="p">),</span>
                <span class="mi">400</span>
            <span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
        <span class="n">collection_facets</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collection_facets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_INPUT</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;I don&#39;t understand what &#39;</span><span class="si">%(collection)s</span><span class="s2">&#39; refers to.&quot;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">),</span>
                <span class="mi">400</span>
            <span class="p">)</span>

        <span class="n">enabled</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span> <span class="p">:</span> <span class="n">order_facets</span><span class="p">,</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span> <span class="p">:</span> <span class="n">availability_facets</span><span class="p">,</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span> <span class="p">:</span> <span class="n">collection_facets</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="n">availability</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">enabled_facets</span><span class="o">=</span><span class="n">enabled</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Facets.from_request"><a class="viewcode-back" href="../../core.html#core.lane.Facets.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
                     <span class="n">default_entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a faceting object from an HTTP request.&quot;&quot;&quot;</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_values_from_request</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">values</span>
        <span class="n">extra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">library</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_request</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
                                 <span class="n">default_entrypoint</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">availability</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
                 <span class="n">order_ascending</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabled_facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: This is not a Collection object; it&#39;s a value for</span>
<span class="sd">        the &#39;collection&#39; facet, e.g. &#39;main&#39; or &#39;featured&#39;.</span>

<span class="sd">        :param entrypoint: An EntryPoint class. The &#39;entry point&#39;</span>
<span class="sd">        facet group is configured on a per-WorkList basis rather than</span>
<span class="sd">        a per-library basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Facets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">entrypoint</span><span class="p">,</span> <span class="n">entrypoint_is_default</span><span class="p">,</span> <span class="o">**</span><span class="n">constructor_kwargs</span>
        <span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="n">availability</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order_ascending</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_DESCENDING_BY_DEFAULT</span><span class="p">:</span>
                <span class="n">order_ascending</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_DESCENDING</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order_ascending</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_ASCENDING</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">availability</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span> <span class="ow">and</span> <span class="p">(</span><span class="n">library</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">library</span><span class="o">.</span><span class="n">allow_holds</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_NOW</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">))):</span>
            <span class="c1"># Under normal circumstances we would show all works, but</span>
            <span class="c1"># library configuration says to hide books that aren&#39;t</span>
            <span class="c1"># available.</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_NOW</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">library</span> <span class="o">=</span> <span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">=</span> <span class="n">availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="k">if</span> <span class="n">order_ascending</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_ASCENDING</span><span class="p">:</span>
            <span class="n">order_ascending</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">order_ascending</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_DESCENDING</span><span class="p">:</span>
            <span class="n">order_ascending</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_ascending</span> <span class="o">=</span> <span class="n">order_ascending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facets_enabled_at_init</span> <span class="o">=</span> <span class="n">enabled_facets</span>

<div class="viewcode-block" id="Facets.navigate"><a class="viewcode-back" href="../../core.html#core.lane.Facets.navigate">[docs]</a>    <span class="k">def</span> <span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a slightly different Facets object from this one.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">availability</span><span class="o">=</span><span class="n">availability</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">enabled_facets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facets_enabled_at_init</span><span class="p">,</span>
            <span class="n">entrypoint</span><span class="o">=</span><span class="p">(</span><span class="n">entrypoint</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">),</span>
            <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">max_cache_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Facets.items"><a class="viewcode-back" href="../../core.html#core.lane.Facets.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Facets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enabled_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield a 3-tuple of lists (order, availability, collection)</span>
<span class="sd">        representing facet values enabled via initialization or configuration</span>

<span class="sd">        The &#39;entry point&#39; facet group is handled separately, since it</span>
<span class="sd">        is not always used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets_enabled_at_init</span><span class="p">:</span>
            <span class="c1"># When this Facets object was initialized, a list of enabled</span>
            <span class="c1"># facets was passed. We&#39;ll only work with those facets.</span>
            <span class="n">facet_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">facet_type</span> <span class="ow">in</span> <span class="n">facet_types</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets_enabled_at_init</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">facet_type</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span>
            <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">,</span>
                <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">,</span>
                <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">facet_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield a list of 4-tuples</span>
<span class="sd">        (facet group, facet value, new Facets object, selected)</span>
<span class="sd">        for use in building OPDS facets.</span>

<span class="sd">        This does not yield anything for the &#39;entry point&#39; facet group,</span>
<span class="sd">        which must be handled separately.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">order_facets</span><span class="p">,</span> <span class="n">availability_facets</span><span class="p">,</span> <span class="n">collection_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_facets</span>

        <span class="k">def</span> <span class="nf">dy</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">new_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">current_value</span><span class="o">==</span><span class="n">new_value</span><span class="p">)</span>

        <span class="c1"># First, the order facets.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_facets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">order_facets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dy</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>

        <span class="c1"># Next, the availability facets.</span>
        <span class="k">def</span> <span class="nf">dy</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">availability</span><span class="o">=</span><span class="n">new_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">new_value</span><span class="o">==</span><span class="n">current_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availability_facets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">availability_facets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dy</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>

        <span class="c1"># Next, the collection facets.</span>
        <span class="k">def</span> <span class="nf">dy</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="n">new_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">new_value</span><span class="o">==</span><span class="n">current_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection_facets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">collection_facets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dy</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>

<div class="viewcode-block" id="Facets.modify_search_filter"><a class="viewcode-back" href="../../core.html#core.lane.Facets.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the given external_search.Filter object</span>
<span class="sd">        so that it reflects the settings of this Facets object.</span>

<span class="sd">        This is the Elasticsearch equivalent of apply(). However, the</span>
<span class="sd">        Elasticsearch implementation of (e.g.) the meaning of the</span>
<span class="sd">        different availabilty statuses is kept in Filter.build().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Facets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">modify_search_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">:</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">minimum_featured_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">minimum_featured_quality</span>

        <span class="nb">filter</span><span class="o">.</span><span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">subcollection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>

        <span class="c1"># No order and relevance order both signify the default and,</span>
        <span class="c1"># thus, either should leave `filter.order` unset.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_BY_RELEVANCE</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SORT_ORDER_TO_ELASTICSEARCH_FIELD_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
                <span class="nb">filter</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
                <span class="nb">filter</span><span class="o">.</span><span class="n">order_ascending</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_ascending</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized sort order: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span></div>

<div class="viewcode-block" id="Facets.modify_database_query"><a class="viewcode-back" href="../../core.html#core.lane.Facets.modify_database_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restrict a query against Work+LicensePool+Edition so that it</span>
<span class="sd">        matches only works that fit the criteria of this Faceting object.</span>

<span class="sd">        Sort order facet cannot be handled in this method, but can be</span>
<span class="sd">        handled in subclasses that override this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Apply any superclass criteria</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Facets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="n">available_now</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span><span class="p">,</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_NOW</span><span class="p">:</span>
            <span class="n">availability_clause</span> <span class="o">=</span> <span class="n">available_now</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">:</span>
            <span class="n">availability_clause</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">self_hosted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">unlimited_access</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_OPEN_ACCESS</span><span class="p">:</span>
            <span class="c1"># TODO: self-hosted content could be allowed here</span>
            <span class="c1"># depending on what exactly the wording is.</span>
            <span class="n">availability_clause</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_NOT_NOW</span><span class="p">:</span>
            <span class="c1"># The book must be licensed but currently unavailable.</span>
            <span class="n">availability_clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span>
                <span class="n">not_</span><span class="p">(</span><span class="n">available_now</span><span class="p">),</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">availability_clause</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">:</span>
            <span class="c1"># Include everything.</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_FEATURED</span><span class="p">:</span>
            <span class="c1"># Exclude books with a quality of less than the library&#39;s</span>
            <span class="c1"># minimum featured quality.</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Work</span><span class="o">.</span><span class="n">quality</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">minimum_featured_quality</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">qu</span></div></div>


<div class="viewcode-block" id="DefaultSortOrderFacets"><a class="viewcode-back" href="../../core.html#core.lane.DefaultSortOrderFacets">[docs]</a><span class="k">class</span> <span class="nc">DefaultSortOrderFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A faceting object that changes the default sort order.</span>

<span class="sd">    Subclasses must set DEFAULT_SORT_ORDER</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DefaultSortOrderFacets.available_facets"><a class="viewcode-back" href="../../core.html#core.lane.DefaultSortOrderFacets.available_facets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available_facets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure the default sort order is the first item</span>
<span class="sd">        in the list of available sort orders.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DefaultSortOrderFacets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span>
                <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span>
            <span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span><span class="n">facet_group_name</span><span class="p">)</span>

        <span class="c1"># Promote the default sort order to the front of the list,</span>
        <span class="c1"># adding it if necessary.</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_SORT_ORDER</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">default</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="n">order</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">+</span> <span class="n">default</span></div>

<div class="viewcode-block" id="DefaultSortOrderFacets.default_facet"><a class="viewcode-back" href="../../core.html#core.lane.DefaultSortOrderFacets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_SORT_ORDER</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DefaultSortOrderFacets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="DatabaseBackedFacets"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedFacets">[docs]</a><span class="k">class</span> <span class="nc">DatabaseBackedFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generic faceting object designed for managing queries against the</span>
<span class="sd">    database. (Other faceting objects are designed for managing</span>
<span class="sd">    Elasticsearch searches.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Of the sort orders in Facets, these are the only available ones</span>
    <span class="c1"># -- they map directly onto a field of one of the tables we&#39;re</span>
    <span class="c1"># querying.</span>
    <span class="n">ORDER_FACET_TO_DATABASE_FIELD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">FacetConstants</span><span class="o">.</span><span class="n">ORDER_WORK_ID</span> <span class="p">:</span> <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">FacetConstants</span><span class="o">.</span><span class="n">ORDER_TITLE</span> <span class="p">:</span> <span class="n">Edition</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span>
        <span class="n">FacetConstants</span><span class="o">.</span><span class="n">ORDER_AUTHOR</span> <span class="p">:</span> <span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">,</span>
        <span class="n">FacetConstants</span><span class="o">.</span><span class="n">ORDER_LAST_UPDATE</span> <span class="p">:</span> <span class="n">Work</span><span class="o">.</span><span class="n">last_update_time</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DatabaseBackedFacets.available_facets"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedFacets.available_facets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available_facets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exclude search orders not available through database queries.&quot;&quot;&quot;</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span><span class="n">facet_group_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">standard</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">order</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">standard</span>
                <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_TO_DATABASE_FIELD</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseBackedFacets.default_facet"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedFacets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exclude search orders not available through database queries.&quot;&quot;&quot;</span>
        <span class="n">standard_default</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseBackedFacets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">standard_default</span>
        <span class="k">if</span> <span class="n">standard_default</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_TO_DATABASE_FIELD</span><span class="p">:</span>
            <span class="c1"># This default sort order is supported.</span>
            <span class="k">return</span> <span class="n">standard_default</span>

        <span class="c1"># The default sort order is not supported. Just pick the first</span>
        <span class="c1"># enabled sort order.</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span><span class="n">facet_group_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_TO_DATABASE_FIELD</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>

        <span class="c1"># None of the enabled sort orders are usable. Order by work ID.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_WORK_ID</span></div>

<div class="viewcode-block" id="DatabaseBackedFacets.order_by"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedFacets.order_by">[docs]</a>    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given these Facets, create a complete ORDER BY clause for queries</span>
<span class="sd">        against WorkModelWithGenre.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_sort_order</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">,</span> <span class="n">Edition</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span> <span class="n">Work</span><span class="o">.</span><span class="n">id</span>
        <span class="p">]</span>

        <span class="n">primary_order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_FACET_TO_DATABASE_FIELD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">primary_order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Promote the field designated by the sort facet to the top of</span>
            <span class="c1"># the order-by list.</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_order_by</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">default_sort_order</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
                    <span class="n">order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the default sort order</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="n">default_sort_order</span>

        <span class="c1"># order_ascending applies only to the first field in the sort order.</span>
        <span class="c1"># Everything else is ordered ascending.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_ascending</span><span class="p">:</span>
            <span class="n">order_by_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_by_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">return</span> <span class="n">order_by_sorted</span><span class="p">,</span> <span class="n">order_by</span></div>

<div class="viewcode-block" id="DatabaseBackedFacets.modify_database_query"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedFacets.modify_database_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restrict a query so that it matches only works</span>
<span class="sd">        that fit the criteria of this faceting object. Ensure</span>
<span class="sd">        query is appropriately ordered and made distinct.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Filter by facet criteria</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseBackedFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="c1"># Set the ORDER BY clause.</span>
        <span class="n">order_by</span><span class="p">,</span> <span class="n">order_distinct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_by</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="o">*</span><span class="n">order_distinct</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div></div>


<div class="viewcode-block" id="FeaturedFacets"><a class="viewcode-back" href="../../core.html#core.lane.FeaturedFacets">[docs]</a><span class="k">class</span> <span class="nc">FeaturedFacets</span><span class="p">(</span><span class="n">FacetsWithEntryPoint</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A simple faceting object that configures a query so that the &#39;most</span>
<span class="sd">    featurable&#39; items are at the front.</span>

<span class="sd">    This is mainly a convenient thing to pass into</span>
<span class="sd">    AcquisitionFeed.groups().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This Facets class is used exclusively for grouped feeds.</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">GROUPS_TYPE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_featured_quality</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up an object that finds featured books in a given</span>
<span class="sd">        WorkList.</span>

<span class="sd">        :param kwargs: Other arguments may be supplied based on user</span>
<span class="sd">            input, but the default implementation is to ignore them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FeaturedFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_featured_quality</span> <span class="o">=</span> <span class="n">minimum_featured_quality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span>

<div class="viewcode-block" id="FeaturedFacets.default"><a class="viewcode-back" href="../../core.html#core.lane.FeaturedFacets.default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Library</span><span class="p">):</span>
                <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">library</span>

        <span class="k">if</span> <span class="n">library</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">minimum_featured_quality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">DEFAULT_MINIMUM_FEATURED_QUALITY</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">quality</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeaturedFacets.navigate"><a class="viewcode-back" href="../../core.html#core.lane.FeaturedFacets.navigate">[docs]</a>    <span class="k">def</span> <span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_featured_quality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a slightly different FeaturedFacets object based on this</span>
<span class="sd">        one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">minimum_featured_quality</span> <span class="o">=</span> <span class="n">minimum_featured_quality</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_featured_quality</span>
        <span class="n">entrypoint</span> <span class="o">=</span> <span class="n">entrypoint</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">minimum_featured_quality</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">max_cache_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cache_age</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeaturedFacets.modify_search_filter"><a class="viewcode-back" href="../../core.html#core.lane.FeaturedFacets.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FeaturedFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">modify_search_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">minimum_featured_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_featured_quality</span></div>

<div class="viewcode-block" id="FeaturedFacets.scoring_functions"><a class="viewcode-back" href="../../core.html#core.lane.FeaturedFacets.scoring_functions">[docs]</a>    <span class="k">def</span> <span class="nf">scoring_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate scoring functions that weight works randomly, but</span>
<span class="sd">        with &#39;more featurable&#39; works tending to be at the top.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span><span class="o">.</span><span class="n">featurability_scoring_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SearchFacets"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets">[docs]</a><span class="k">class</span> <span class="nc">SearchFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Facets object designed to filter search results.</span>

<span class="sd">    Most search result filtering is handled by WorkList, but this</span>
<span class="sd">    allows someone to, e.g., search a multi-lingual WorkList in their</span>
<span class="sd">    preferred language.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If search results are to be ordered by some field other than</span>
    <span class="c1"># score, we need a cutoff point so that marginal matches don&#39;t get</span>
    <span class="c1"># top billing just because they&#39;re first alphabetically. This is</span>
    <span class="c1"># the default cutoff point, determined empirically.</span>
    <span class="n">DEFAULT_MIN_SCORE</span> <span class="o">=</span> <span class="mi">500</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;languages&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">media</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Our default_facets implementation will fill in values for</span>
        <span class="c1"># the facet groups defined by the Facets class. This</span>
        <span class="c1"># eliminates the need to explicitly specify a library, since</span>
        <span class="c1"># the library is mainly used to determine these defaults --</span>
        <span class="c1"># SearchFacets itself doesn&#39;t need one. However, in real</span>
        <span class="c1"># usage, a Library will be provided via</span>
        <span class="c1"># SearchFacets.from_request.</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;availability&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_BY_RELEVANCE</span><span class="p">):</span>
            <span class="c1"># Search results are ordered by score, so there is no</span>
            <span class="c1"># need for a score cutoff.</span>
            <span class="n">default_min_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_min_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MIN_SCORE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_score&#39;</span><span class="p">,</span> <span class="n">default_min_score</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SearchFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">media</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">ALL_MEDIUM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">media</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_list</span><span class="p">(</span><span class="n">media</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_argument</span> <span class="o">=</span> <span class="n">media</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_list</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span>

<div class="viewcode-block" id="SearchFacets.default_facet"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ignore</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default facet settings for SearchFacets are hard-coded.</span>

<span class="sd">        By default, we will search the full collection and all</span>
<span class="sd">        availabilities, and order by match quality rather than any</span>
<span class="sd">        bibliographic field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COLLECTION_FULL</span>

        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span>

        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ORDER_BY_RELEVANCE</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure x is a list of values, if there is a value at all.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>

<div class="viewcode-block" id="SearchFacets.from_request"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span>
                     <span class="n">default_entrypoint</span><span class="o">=</span><span class="n">EverythingEntryPoint</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_values_from_request</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">values</span>
        <span class="n">extra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">library</span>
        <span class="c1"># Searches against a WorkList will use the union of the</span>
        <span class="c1"># languages allowed by the WorkList and the languages found in</span>
        <span class="c1"># the client&#39;s Accept-Language header.</span>
        <span class="n">language_header</span> <span class="o">=</span> <span class="n">get_header</span><span class="p">(</span><span class="s2">&quot;Accept-Language&quot;</span><span class="p">)</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">languages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">language_header</span><span class="p">:</span>
                <span class="n">languages</span> <span class="o">=</span> <span class="n">parse_accept_language</span><span class="p">(</span><span class="n">language_header</span><span class="p">)</span>
                <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">]</span>
                <span class="n">languages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">LanguageCodes</span><span class="o">.</span><span class="n">iso_639_2_for_locale</span><span class="p">,</span> <span class="n">languages</span><span class="p">))</span>
                <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">languages</span> <span class="k">if</span> <span class="n">l</span><span class="p">]</span>
            <span class="n">languages</span> <span class="o">=</span> <span class="n">languages</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="c1"># The client can request a minimum score for search results.</span>
        <span class="n">min_score</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;min_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">min_score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_score</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">min_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">min_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;min_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_score</span>

        <span class="c1"># The client can request an additional restriction on</span>
        <span class="c1"># the media types to be returned by searches.</span>

        <span class="n">media</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;media&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">media</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">EditionConstants</span><span class="o">.</span><span class="n">KNOWN_MEDIA</span><span class="p">:</span>
            <span class="n">media</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">media</span>
        <span class="n">languageQuery</span> <span class="o">=</span> <span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Currently, the only value passed to the language query from the client is</span>
        <span class="c1"># `all`. This will remove the default browser&#39;s Accept-Language header value</span>
        <span class="c1"># in the search request.</span>
        <span class="k">if</span> <span class="n">languageQuery</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span> <span class="p">:</span>
            <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">languages</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_request</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">get_argument</span><span class="p">,</span> <span class="n">get_header</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">default_entrypoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">extra</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SearchFacets.selectable_entrypoints"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.selectable_entrypoints">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">selectable_entrypoints</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the WorkList has more than one facet, an &#39;everything&#39; facet</span>
<span class="sd">        is added for search purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">worklist</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">entrypoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">worklist</span><span class="o">.</span><span class="n">entrypoints</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entrypoints</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entrypoints</span>
        <span class="k">if</span> <span class="n">EverythingEntryPoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="n">entrypoints</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EverythingEntryPoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entrypoints</span></div>

<div class="viewcode-block" id="SearchFacets.modify_search_filter"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the given external_search.Filter object</span>
<span class="sd">        so that it reflects this SearchFacets object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SearchFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">modify_search_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">filter</span><span class="o">.</span><span class="n">min_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The user wants search results to be ordered by one of</span>
            <span class="c1"># the data fields, not the match score; and no overriding</span>
            <span class="c1"># score cutoff has been provided yet. Use ours.</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span>

        <span class="c1"># The incoming &#39;media&#39; argument takes precedence over any</span>
        <span class="c1"># media restriction defined by the WorkList or the EntryPoint.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">ALL_MEDIUM</span><span class="p">:</span>
            <span class="c1"># Clear any preexisting media restrictions.</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span>

        <span class="c1"># The languages matched by the filter are the union of the</span>
        <span class="c1"># languages allowed by the WorkList (which were set to</span>
        <span class="c1"># filter.languages upon instantiation) and the languages</span>
        <span class="c1"># mentioned in the the user&#39;s Accept-Language header (which</span>
        <span class="c1"># were stuck into the SearchFacets object when _it_ was</span>
        <span class="c1"># instantiated).</span>
        <span class="c1">#</span>
        <span class="c1"># We don&#39;t rely solely on the WorkList languages because at</span>
        <span class="c1"># the moment it&#39;s hard for people who don&#39;t read the dominant</span>
        <span class="c1"># language of the circulation manager to find the right place</span>
        <span class="c1"># to search.</span>
        <span class="c1">#</span>
        <span class="c1"># We don&#39;t rely solely on the SearchFacets languages because a</span>
        <span class="c1"># lot of people read in languages other than the one they&#39;ve</span>
        <span class="c1"># set for their device UI.</span>
        <span class="n">all_languages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">language_list</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">,</span> <span class="nb">filter</span><span class="o">.</span><span class="n">languages</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_list</span><span class="p">(</span><span class="n">language_list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">all_languages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_languages</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SearchFacets.items"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yields a 2-tuple for every active facet setting.</span>

<span class="sd">        This means the EntryPoint (handled by the superclass)</span>
<span class="sd">        as well as possible settings for &#39;media&#39; and &quot;min_score&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">SearchFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_argument</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s2">&quot;media&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_argument</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;min_score&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_score</span><span class="p">))</span></div>

<div class="viewcode-block" id="SearchFacets.navigate"><a class="viewcode-back" href="../../core.html#core.lane.SearchFacets.navigate">[docs]</a>    <span class="k">def</span> <span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">min_score</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_score&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span><span class="p">)</span>
        <span class="n">new_facets</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SearchFacets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new_facets</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">min_score</span>
        <span class="k">return</span> <span class="n">new_facets</span></div></div>

<div class="viewcode-block" id="Pagination"><a class="viewcode-back" href="../../core.html#core.lane.Pagination">[docs]</a><span class="k">class</span> <span class="nc">Pagination</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">DEFAULT_SIZE</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">DEFAULT_SEARCH_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">DEFAULT_FEATURED_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">DEFAULT_CRAWLABLE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

<div class="viewcode-block" id="Pagination.default"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pagination</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_SIZE</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">DEFAULT_SIZE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param offset: Start pulling entries from the query at this index.</span>
<span class="sd">        :param size: Pull no more than this number of entries from the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_page_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_has_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SIZE</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_int_from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">,</span> <span class="n">make_detail</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to get and parse an integer value from</span>
<span class="sd">        a URL query argument in a Flask request.</span>

<span class="sd">        :param key: Name of the argument.</span>
<span class="sd">        :param get_arg: A function which when called with (key, default)</span>
<span class="sd">           returns the value of the query argument.</span>
<span class="sd">        :pass make_detail: A function, called with the value</span>
<span class="sd">           obtained from the request, which returns the detail</span>
<span class="sd">           information that should be included in a problem detail</span>
<span class="sd">           document if the input isn&#39;t convertable to an integer.</span>
<span class="sd">        :param default: Use this value if none is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">as_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_INPUT</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">make_detail</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">as_int</span>

<div class="viewcode-block" id="Pagination.size_from_request"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.size_from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">size_from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">make_detail</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">size</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid page size: </span><span class="si">%(size)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_int_from_request</span><span class="p">(</span>
            <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">,</span> <span class="n">make_detail</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_SIZE</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">size</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MAX_SIZE</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pagination.from_request"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">,</span> <span class="n">default_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a Pagination object from a Flask request.&quot;&quot;&quot;</span>
        <span class="n">default_size</span> <span class="o">=</span> <span class="n">default_size</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_SIZE</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">size_from_request</span><span class="p">(</span><span class="n">get_arg</span><span class="p">,</span> <span class="n">default_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">size</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_int_from_request</span><span class="p">(</span>
            <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">offset</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid offset: </span><span class="si">%(offset)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">),</span>
            <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pagination.items"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="k">return</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pagination</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Pagination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">previous_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">previous_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">previous_offset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">previous_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pagination</span><span class="p">(</span><span class="n">previous_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns boolean reporting whether pagination is done for a query</span>

<span class="sd">        Either `total_size` or `this_page_size` must be set for this</span>
<span class="sd">        method to be accurate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We know the total size of the result set, so we know</span>
            <span class="c1"># whether or not there are more results.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We know the number of items on the current page. If this</span>
            <span class="c1"># page was empty, we can assume there is no next page; if</span>
            <span class="c1"># not, we can assume there is a next page. This is a little</span>
            <span class="c1"># more conservative than checking whether we have a &#39;full&#39;</span>
            <span class="c1"># page.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_page_size</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># We don&#39;t know anything about this result set, so assume there is</span>
        <span class="c1"># a next page.</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Pagination.modify_database_query"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.modify_database_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the given database query with OFFSET and LIMIT.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qu</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pagination.modify_search_query"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.modify_search_query">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify a Search object so that it retrieves only a single &#39;page&#39;</span>
<span class="sd">        of results.</span>

<span class="sd">        :return: A Search object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">search</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">]</span></div>

<div class="viewcode-block" id="Pagination.page_loaded"><a class="viewcode-back" href="../../core.html#core.lane.Pagination.page_loaded">[docs]</a>    <span class="k">def</span> <span class="nf">page_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An actual page of results has been fetched. Keep any internal state</span>
<span class="sd">        that would be useful to know when reasoning about earlier or</span>
<span class="sd">        later pages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_page_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_has_loaded</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="WorkList"><a class="viewcode-back" href="../../core.html#core.lane.WorkList">[docs]</a><span class="k">class</span> <span class="nc">WorkList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object that can obtain a list of Work objects for use</span>
<span class="sd">    in generating an OPDS feed.</span>

<span class="sd">    By default, these Work objects come from a search index.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The default maximum cache time of a feed derived from a WorkList</span>
    <span class="c1"># is the default cache time for any OPDS feed.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DEFAULT_MAX_AGE</span>

    <span class="c1"># If a certain type of Worklist should always have its OPDS feeds</span>
    <span class="c1"># cached under a specific type, define that type as</span>
    <span class="c1"># CACHED_FEED_TYPE.</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># By default, a WorkList is always visible.</span>
    <span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># By default, a WorkList does not draw from CustomLists</span>
    <span class="n">uses_customlists</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="WorkList.max_cache_age"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.max_cache_age">[docs]</a>    <span class="k">def</span> <span class="nf">max_cache_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine how long a feed for this WorkList should be cached</span>
<span class="sd">        internally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CACHE_AGE</span></div>

<div class="viewcode-block" id="WorkList.top_level_for_library"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.top_level_for_library">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">top_level_for_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a WorkList representing this library&#39;s collection</span>
<span class="sd">        as a whole.</span>

<span class="sd">        If no top-level visible lanes are configured, the WorkList</span>
<span class="sd">        will be configured to show every book in the collection.</span>

<span class="sd">        If a single top-level Lane is configured, it will returned as</span>
<span class="sd">        the WorkList.</span>

<span class="sd">        Otherwise, a WorkList containing the visible top-level lanes</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load all of this Library&#39;s visible top-level Lane objects</span>
        <span class="c1"># from the database.</span>
        <span class="n">top_level_lanes</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Lane</span><span class="o">.</span><span class="n">library</span><span class="o">==</span><span class="n">library</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Lane</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="kc">None</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Lane</span><span class="o">.</span><span class="n">_visible</span><span class="o">==</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">Lane</span><span class="o">.</span><span class="n">priority</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_level_lanes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># The site configuration includes a single top-level lane;</span>
            <span class="c1"># this can stand in for the library on its own.</span>
            <span class="k">return</span> <span class="n">top_level_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># This WorkList contains every title available to this library</span>
        <span class="c1"># in one of the media supported by the default client.</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">TopLevelWorkList</span><span class="p">()</span>

        <span class="n">wl</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="n">top_level_lanes</span><span class="p">,</span>
            <span class="n">media</span><span class="o">=</span><span class="n">Edition</span><span class="o">.</span><span class="n">FULFILLABLE_MEDIA</span><span class="p">,</span> <span class="n">entrypoints</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">entrypoints</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">wl</span></div>

<div class="viewcode-block" id="WorkList.initialize"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">audiences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">customlists</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_datasource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">list_seen_in_previous_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">children</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entrypoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">license_datasource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">target_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize with basic data.</span>

<span class="sd">        This is not a constructor, to avoid conflicts with `Lane`, an</span>
<span class="sd">        ORM object that subclasses this object but does not use this</span>
<span class="sd">        initialization code.</span>

<span class="sd">        :param library: Only Works available in this Library will be</span>
<span class="sd">            included in lists.</span>

<span class="sd">        :param display_name: Name to display for this WorkList in the</span>
<span class="sd">            user interface.</span>

<span class="sd">        :param genres: Only Works classified under one of these Genres</span>
<span class="sd">            will be included in lists.</span>

<span class="sd">        :param audiences: Only Works classified under one of these audiences</span>
<span class="sd">            will be included in lists.</span>

<span class="sd">        :param languages: Only Works in one of these languages will be</span>
<span class="sd">            included in lists.</span>

<span class="sd">        :param media: Only Works in one of these media will be included</span>
<span class="sd">            in lists.</span>

<span class="sd">        :param fiction: Only Works with this fiction status will be included</span>
<span class="sd">            in lists.</span>

<span class="sd">        :param target_age: Only Works targeted at readers in this age range</span>
<span class="sd">            will be included in lists.</span>

<span class="sd">        :param license_datasource: Only Works with a LicensePool from this</span>
<span class="sd">            DataSource will be included in lists.</span>

<span class="sd">        :param customlists: Only Works included on one of these CustomLists</span>
<span class="sd">            will be included in lists.</span>

<span class="sd">        :param list_datasource: Only Works included on a CustomList</span>
<span class="sd">            associated with this DataSource will be included in</span>
<span class="sd">            lists. This overrides any specific CustomLists provided in</span>
<span class="sd">            `customlists`.</span>

<span class="sd">        :param list_seen_in_previous_days: Only Works that were added</span>
<span class="sd">            to a matching CustomList within this number of days will be</span>
<span class="sd">            included in lists.</span>

<span class="sd">        :param children: This WorkList has children, which are also</span>
<span class="sd">            WorkLists.</span>

<span class="sd">        :param priority: A number indicating where this WorkList should</span>
<span class="sd">            show up in relation to its siblings when it is the child of</span>
<span class="sd">            some other WorkList.</span>

<span class="sd">        :param entrypoints: A list of EntryPoint classes representing</span>
<span class="sd">            different ways of slicing up this WorkList.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">library</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">all_collections</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span>
        <span class="k">if</span> <span class="n">genres</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genre_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genre_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span> <span class="o">=</span> <span class="n">audiences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">media</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="o">=</span> <span class="n">fiction</span>

        <span class="k">if</span> <span class="n">license_datasource</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">license_datasource_id</span> <span class="o">=</span> <span class="n">license_datasource</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">license_datasource_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If a specific set of CustomLists was passed in, store their IDs.</span>
        <span class="c1">#</span>
        <span class="c1"># If a custom list DataSource was passed in, gather the IDs for</span>
        <span class="c1"># every CustomList associated with that DataSource, and store</span>
        <span class="c1"># those IDs.</span>
        <span class="c1">#</span>
        <span class="c1"># Either way, WorkList starts out with a specific list of IDs,</span>
        <span class="c1"># which simplifies the WorkList code in a way that isn&#39;t</span>
        <span class="c1"># available to Lane.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">list_datasource</span><span class="p">:</span>
            <span class="n">customlists</span> <span class="o">=</span> <span class="n">list_datasource</span><span class="o">.</span><span class="n">custom_lists</span>

            <span class="c1"># We do also store the CustomList ID, which is used as an</span>
            <span class="c1"># optimization in customlist_filter_clauses().</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource_id</span> <span class="o">=</span> <span class="n">list_datasource</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># The custom list IDs are stored in _customlist_ids, for</span>
        <span class="c1"># compatibility with Lane.</span>
        <span class="k">if</span> <span class="n">customlists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">customlists</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_seen_in_previous_days</span> <span class="o">=</span> <span class="n">list_seen_in_previous_days</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="o">=</span> <span class="n">fiction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span> <span class="o">=</span> <span class="n">target_age</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entrypoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entrypoints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entrypoints</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="WorkList.append_child"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.append_child">[docs]</a>    <span class="k">def</span> <span class="nf">append_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one child to the list of children in this WorkList.</span>

<span class="sd">        This hook method can be overridden to modify the child&#39;s</span>
<span class="sd">        configuration so as to make it fit with what the parent is</span>
<span class="sd">        offering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">customlist_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the custom list IDs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_customlists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the works() implementation for this WorkList look for works on</span>
<span class="sd">        CustomLists?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="WorkList.get_library"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.get_library">[docs]</a>    <span class="k">def</span> <span class="nf">get_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the Library object associated with this WorkList.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Library</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkList.get_customlists"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.get_customlists">[docs]</a>    <span class="k">def</span> <span class="nf">get_customlists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get customlists associated with the Worklist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_customlist_ids&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CustomList</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CustomList</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name_for_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The display name to use when referring to the set of all books in</span>
<span class="sd">        this WorkList, as opposed to the WorkList itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;All </span><span class="si">%(worklist)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">visible_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A WorkList&#39;s children can be used to create a grouped acquisition</span>
<span class="sd">        feed for that WorkList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">visible</span><span class="p">],</span>
            <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_visible_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lane</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A WorkList has no parent. This method is defined for compatibility</span>
<span class="sd">        with Lane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WorkLists have no parentage. This method is defined for compatibility</span>
<span class="sd">        with Lane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="WorkList.is_self_or_descendant"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.is_self_or_descendant">[docs]</a>    <span class="k">def</span> <span class="nf">is_self_or_descendant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this WorkList the given WorkList or one of its descendants?</span>

<span class="sd">        :param ancestor: A WorkList.</span>
<span class="sd">        :return: A boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentage</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="o">==</span> <span class="n">ancestor</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inherit_parent_restrictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Since a WorkList has no parent, it cannot inherit any restrictions</span>
<span class="sd">        from its parent. This method is defined for compatibility</span>
<span class="sd">        with Lane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The portion of the WorkList hierarchy that culminates in this</span>
<span class="sd">        WorkList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentage</span><span class="p">)))</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

<div class="viewcode-block" id="WorkList.inherited_value"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.inherited_value">[docs]</a>    <span class="k">def</span> <span class="nf">inherited_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to find this WorkList&#39;s value for the given key (e.g. &#39;fiction&#39;</span>
<span class="sd">        or &#39;audiences&#39;).</span>

<span class="sd">        If it&#39;s not set, try to inherit a value from the WorkList&#39;s</span>
<span class="sd">        parent. This only works if this WorkList has a parent and is</span>
<span class="sd">        configured to inherit values from its parent.</span>

<span class="sd">        Note that inheritance works differently for genre_ids and</span>
<span class="sd">        customlist_ids -- use inherited_values() for that.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">return</span> <span class="n">parent</span><span class="o">.</span><span class="n">inherited_value</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkList.inherited_values"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.inherited_values">[docs]</a>    <span class="k">def</span> <span class="nf">inherited_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the values for the given key (e.g. &#39;genre_ids&#39; or</span>
<span class="sd">        &#39;customlist_ids&#39;) imposed by this WorkList and its parentage.</span>

<span class="sd">        This is for values like .genre_ids and .customlist_ids, where</span>
<span class="sd">        each member of the WorkList hierarchy can impose a restriction</span>
<span class="sd">        on query results, and the effects of the restrictions are</span>
<span class="sd">        additive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span>
        <span class="k">for</span> <span class="n">wl</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A human-readable identifier for this WorkList that</span>
<span class="sd">        captures its position within the heirarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_parentage</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># This WorkList is associated with a specific library.</span>
            <span class="c1"># incorporate the library&#39;s name to distinguish between it</span>
            <span class="c1"># and other lanes in the same position in another library.</span>
            <span class="n">full_parentage</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; / &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_parentage</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">language_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string identifying the languages used in this WorkList.</span>
<span class="sd">        This will usually be in the form of &#39;eng,spa&#39; (English and Spanish).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">audience_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translates audiences list into url-safe string&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audiences</span> <span class="ow">and</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">)):</span>
            <span class="c1"># There are audiences and they&#39;re not the default</span>
            <span class="c1"># &quot;any audience&quot;, so add them to the URL.</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="p">[</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">)]</span>
            <span class="n">key</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">audiences</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unique_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string key that uniquely describes this WorkList within</span>
<span class="sd">        its Library.</span>

<span class="sd">        This is used when caching feeds for this WorkList. For Lanes,</span>
<span class="sd">        the lane_id is used instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_key</span>
        <span class="p">)</span>

<div class="viewcode-block" id="WorkList.accessible_to"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.accessible_to">[docs]</a>    <span class="k">def</span> <span class="nf">accessible_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;As a matter of library policy, is the given `Patron` allowed</span>
<span class="sd">        to access this `WorkList`?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="p">:</span>
            <span class="c1"># We have no lanes that are private, per se, so if there</span>
            <span class="c1"># is no active patron, every lane is accessible.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patron</span><span class="o">.</span><span class="n">library</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">):</span>
            <span class="c1"># You can&#39;t access a WorkList from another library.</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">has_root_lanes</span><span class="p">:</span>
            <span class="c1"># The patron&#39;s library has no root lanes, so it&#39;s not necessary</span>
            <span class="c1"># to run the somewhat expensive check for a patron&#39;s root lane.</span>
            <span class="c1"># All lanes are accessible to all patrons.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Get the patron&#39;s root lane, if any.</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">root_lane</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="c1"># A patron with no root lane can access every one of the</span>
            <span class="c1"># library&#39;s WorkLists.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># A WorkList is only accessible if the audiences and target age</span>
        <span class="c1"># of the WorkList are fully compatible with that of the</span>
        <span class="c1"># patron&#39;s root lane.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">work_audience</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">:</span>
                <span class="c1"># work_audience represents a type of book that _might_</span>
                <span class="c1"># show up in this WorkList.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="o">.</span><span class="n">work_is_age_appropriate</span><span class="p">(</span><span class="n">work_audience</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="p">):</span>
                    <span class="c1"># Books of this type would not be appropriate to show to</span>
                    <span class="c1"># this patron, so the lane itself is not accessible.</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WorkList.overview_facets"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.overview_facets">[docs]</a>    <span class="k">def</span> <span class="nf">overview_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a generic FeaturedFacets to some other faceting object,</span>
<span class="sd">        suitable for showing an overview of this WorkList in a grouped</span>
<span class="sd">        feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">facets</span></div>

<div class="viewcode-block" id="WorkList.groups"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.groups">[docs]</a>    <span class="k">def</span> <span class="nf">groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">include_sublanes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a list of samples from each child of this WorkList.  This</span>
<span class="sd">        can be used to create a grouped acquisition feed for the WorkList.</span>

<span class="sd">        :param pagination: A Pagination object which may affect how many</span>
<span class="sd">            works each child of this WorkList may contribute.</span>
<span class="sd">        :param facets: A FeaturedFacets object that may restrict the works on view.</span>
<span class="sd">        :param search_engine: An ExternalSearchIndex to use when</span>
<span class="sd">            asking for the featured works in a given WorkList.</span>
<span class="sd">        :param debug: A debug argument passed into `search_engine` when</span>
<span class="sd">            running the search.</span>
<span class="sd">        :yield: A sequence of (Work, WorkList) 2-tuples, with each</span>
<span class="sd">            WorkList representing the child WorkList in which the Work is</span>
<span class="sd">            found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_sublanes</span><span class="p">:</span>
            <span class="c1"># We only need to find featured works for this lane,</span>
            <span class="c1"># not this lane plus its sublanes.</span>
            <span class="n">adapted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overview_facets</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">adapted</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">work</span><span class="p">,</span> <span class="bp">self</span>
            <span class="k">return</span>

        <span class="c1"># This is a list rather than a dict because we want to</span>
        <span class="c1"># preserve the ordering of the children.</span>
        <span class="n">relevant_lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relevant_children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># We use an explicit check for Lane.visible here, instead of</span>
        <span class="c1"># iterating over self.visible_children, because Lane.visible only</span>
        <span class="c1"># works when the Lane is merged into a database session.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
                <span class="c1"># Children that turn out to be Lanes go into</span>
                <span class="c1"># relevant_lanes. Their Works will be obtained from</span>
                <span class="c1"># the search index.</span>
                <span class="n">relevant_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="c1"># Both Lanes and WorkLists go into relevant_children.</span>
            <span class="c1"># This controls the yield order for Works.</span>
            <span class="n">relevant_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="c1"># _groups_for_lanes will run a query to pull featured works</span>
        <span class="c1"># for any children that are Lanes, and call groups()</span>
        <span class="c1"># recursively for any children that are not.</span>
        <span class="k">for</span> <span class="n">work</span><span class="p">,</span> <span class="n">worklist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups_for_lanes</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">relevant_children</span><span class="p">,</span> <span class="n">relevant_lanes</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
            <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">work</span><span class="p">,</span> <span class="n">worklist</span></div>

<div class="viewcode-block" id="WorkList.works"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.works">[docs]</a>    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Use a search engine to obtain Work or Work-like objects that belong</span>
<span class="sd">        in this WorkList.</span>

<span class="sd">        Compare DatabaseBackedWorkList.works_from_database, which uses</span>
<span class="sd">        a database query to obtain the same Work objects.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param facets: A Facets object which may put additional</span>
<span class="sd">           constraints on WorkList membership.</span>
<span class="sd">        :param pagination: A Pagination object indicating which part of</span>
<span class="sd">           the WorkList the caller is looking at, and/or a limit on the</span>
<span class="sd">           number of works to fetch.</span>
<span class="sd">        :param kwargs: Different implementations may fetch the</span>
<span class="sd">           list of works from different sources and may need different</span>
<span class="sd">           keyword arguments.</span>
<span class="sd">        :return: A list of Work or Work-like objects, or a database query</span>
<span class="sd">            that generates such a list when executed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Filter</span><span class="p">,</span>
            <span class="n">ExternalSearchIndex</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">search_engine</span> <span class="o">=</span> <span class="n">search_engine</span> <span class="ow">or</span> <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">search_engine</span><span class="o">.</span><span class="n">query_works</span><span class="p">(</span>
            <span class="n">query_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works_for_hits</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkList.filter"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to instantiate a Filter object for this WorkList.</span>

<span class="sd">        Using this ensures that modify_search_filter_hook() is always</span>
<span class="sd">        called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="n">Filter</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">from_worklist</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_search_filter_hook</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The Filter was modified in place, rather than a new</span>
            <span class="c1"># Filter being returned.</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="nb">filter</span>
        <span class="k">return</span> <span class="n">modified</span></div>

<div class="viewcode-block" id="WorkList.modify_search_filter_hook"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.modify_search_filter_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A hook method allowing subclasses to modify a Filter</span>
<span class="sd">        object that&#39;s about to find all the works in this WorkList.</span>

<span class="sd">        This can avoid the need for complex subclasses of Facets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="WorkList.works_for_hits"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.works_for_hits">[docs]</a>    <span class="k">def</span> <span class="nf">works_for_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a list of search results into Work objects.</span>

<span class="sd">        This works by calling works_for_resultsets() on a list</span>
<span class="sd">        containing a single list of search results.</span>

<span class="sd">        :param _db: A database connection</span>
<span class="sd">        :param hits: A list of Hit objects from ElasticSearch.</span>
<span class="sd">        :return: A list of Work or (if the search results include</span>
<span class="sd">            script fields), WorkSearchResult objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">[</span><span class="n">results</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">works_for_resultsets</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="p">[</span><span class="n">hits</span><span class="p">],</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="WorkList.works_for_resultsets"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.works_for_resultsets">[docs]</a>    <span class="k">def</span> <span class="nf">works_for_resultsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">resultsets</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a list of lists of Hit objects into a list</span>
<span class="sd">        of lists of Work objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Filter</span><span class="p">,</span>
            <span class="n">WorkSearchResult</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">has_script_fields</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">work_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">resultset</span> <span class="ow">in</span> <span class="n">resultsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">work_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">work_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">has_script_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># We don&#39;t know whether any script fields were</span>
                    <span class="c1"># included, and now we&#39;re in a position to find</span>
                    <span class="c1"># out.</span>
                    <span class="n">has_script_fields</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Filter</span><span class="o">.</span><span class="n">KNOWN_SCRIPT_FIELDS</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_script_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This can only happen when there are no results. The code</span>
            <span class="c1"># will work even if has_script_fields is None, but just to</span>
            <span class="c1"># be safe.</span>
            <span class="n">has_script_fields</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># The simplest way to turn Hits into Works is to create a</span>
        <span class="c1"># DatabaseBackedWorkList that fetches those specific Works</span>
        <span class="c1"># while applying the general availability filters.</span>
        <span class="c1">#</span>
        <span class="c1"># If facets were passed in, then they are used to further</span>
        <span class="c1"># filter the list.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: There&#39;s a lot of room for improvement here, but</span>
        <span class="c1"># performance isn&#39;t a big concern -- it&#39;s just ugly.</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">SpecificWorkList</span><span class="p">(</span><span class="n">work_ids</span><span class="p">)</span>
        <span class="n">wl</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">))</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">wl</span><span class="o">.</span><span class="n">works_from_database</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">all_works</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Create a list of lists with the same membership as the original</span>
        <span class="c1"># `resultsets`, but with Hit objects replaced with Work objects.</span>
        <span class="n">work_by_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">all_works</span><span class="p">:</span>
            <span class="n">work_by_id</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>

        <span class="n">work_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">resultset</span> <span class="ow">in</span> <span class="n">resultsets</span><span class="p">:</span>
            <span class="n">works</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">work_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">works</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hit</span><span class="o">.</span><span class="n">work_id</span> <span class="ow">in</span> <span class="n">work_by_id</span><span class="p">:</span>
                    <span class="n">work</span> <span class="o">=</span> <span class="n">work_by_id</span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">work_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">has_script_fields</span><span class="p">:</span>
                        <span class="c1"># Wrap the Work objects in WorkSearchResult so the</span>
                        <span class="c1"># data from script fields isn&#39;t lost.</span>
                        <span class="n">work</span> <span class="o">=</span> <span class="n">WorkSearchResult</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">hit</span><span class="p">)</span>
                    <span class="n">works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Obtained </span><span class="si">%s</span><span class="s2">xWork in </span><span class="si">%.2f</span><span class="s2">sec&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_works</span><span class="p">),</span> <span class="n">b</span><span class="o">-</span><span class="n">a</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">work_lists</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">search_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;By default, a WorkList is searchable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="WorkList.search"><a class="viewcode-back" href="../../core.html#core.lane.WorkList.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">search_client</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find works in this WorkList that match a search query.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param query: Search for this string.</span>
<span class="sd">        :param search_client: An ExternalSearchIndex object.</span>
<span class="sd">        :param pagination: A Pagination object.</span>
<span class="sd">        :param facets: A faceting object, probably a SearchFacets.</span>
<span class="sd">        :param debug: Pass in True to see a summary of results returned</span>
<span class="sd">            from the search index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search_client</span><span class="p">:</span>
            <span class="c1"># We have no way of actually doing a search. Return nothing.</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pagination</span><span class="p">:</span>
            <span class="n">pagination</span> <span class="o">=</span> <span class="n">Pagination</span><span class="p">(</span>
                <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Pagination</span><span class="o">.</span><span class="n">DEFAULT_SEARCH_SIZE</span>
            <span class="p">)</span>

        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="n">search_client</span><span class="o">.</span><span class="n">query_works</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">debug</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">elasticsearch</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ElasticsearchException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Problem communicating with ElasticSearch. Returning empty list of search results.&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">works_for_hits</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">hits</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>

    <span class="k">def</span> <span class="nf">_groups_for_lanes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">relevant_lanes</span><span class="p">,</span> <span class="n">queryable_lanes</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span>
        <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask the search engine for groups of featurable works in the</span>
<span class="sd">        given lanes. Fill in gaps as necessary.</span>

<span class="sd">        :param pagination: An optional Pagination object which will be</span>
<span class="sd">           used to paginate each group individually. Note that this</span>
<span class="sd">           means Pagination.page_loaded() method will be called once</span>
<span class="sd">           for each group.</span>
<span class="sd">        :param facets: A FeaturedFacets object.</span>

<span class="sd">        :param search_engine: An ExternalSearchIndex to use when</span>
<span class="sd">           asking for the featured works in a given WorkList.</span>
<span class="sd">        :param debug: A debug argument passed into `search_engine` when</span>
<span class="sd">           running the search.</span>
<span class="sd">        :yield: A sequence of (Work, WorkList) 2-tuples, with each</span>
<span class="sd">            WorkList representing the child WorkList in which the Work is</span>
<span class="sd">            found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pagination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No pagination object was provided. Our target size is</span>
            <span class="c1"># the featured lane size, but we&#39;ll ask for a few extra</span>
            <span class="c1"># works for each lane, to reduce the risk that we end up</span>
            <span class="c1"># reusing a book in two different lanes.</span>
            <span class="n">target_size</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">featured_lane_size</span>

            <span class="c1"># We ask for a few extra works for each lane, to reduce the</span>
            <span class="c1"># risk that we&#39;ll end up reusing a book in two different</span>
            <span class="c1"># lanes.</span>
            <span class="n">ask_for_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">target_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="mf">1.10</span><span class="p">))</span>
            <span class="n">pagination</span> <span class="o">=</span> <span class="n">Pagination</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">ask_for_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_size</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">size</span>

        <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="n">ExternalSearchIndex</span>
        <span class="n">search_engine</span> <span class="o">=</span> <span class="n">search_engine</span> <span class="ow">or</span> <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">parent_lane</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_lane</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">queryable_lane_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">queryable_lanes</span><span class="p">)</span>
        <span class="n">works_and_lanes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_featured_works_with_lanes</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">queryable_lanes</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
                <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_done_with_lane</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Called when we&#39;re done with a Lane, either because</span>
<span class="sd">            the lane changes or we&#39;ve reached the end of the list.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Did we get enough items?</span>
            <span class="n">num_missing</span> <span class="o">=</span> <span class="n">target_size</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">by_lane</span><span class="p">[</span><span class="n">lane</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num_missing</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">might_need_to_reuse</span><span class="p">:</span>
                <span class="c1"># No, we need to use some works we used in a</span>
                <span class="c1"># previous lane to fill out this lane. Stick</span>
                <span class="c1"># them at the end.</span>
                <span class="n">by_lane</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">might_need_to_reuse</span><span class="o">.</span><span class="n">values</span><span class="p">())[:</span><span class="n">num_missing</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="n">used_works</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">by_lane</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">working_lane</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">might_need_to_reuse</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">work</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">works_and_lanes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lane</span> <span class="o">!=</span> <span class="n">working_lane</span><span class="p">:</span>
                <span class="c1"># Either we&#39;re done with the old lane, or we&#39;re just</span>
                <span class="c1"># starting and there was no old lane.</span>
                <span class="k">if</span> <span class="n">working_lane</span><span class="p">:</span>
                    <span class="n">_done_with_lane</span><span class="p">(</span><span class="n">working_lane</span><span class="p">)</span>
                <span class="n">working_lane</span> <span class="o">=</span> <span class="n">lane</span>
                <span class="n">used_works_this_lane</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">might_need_to_reuse</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">by_lane</span><span class="p">[</span><span class="n">lane</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">target_size</span><span class="p">:</span>
                <span class="c1"># We&#39;ve already filled this lane.</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">used_works</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_works_this_lane</span><span class="p">:</span>
                    <span class="c1"># We already used this work in another lane, but we</span>
                    <span class="c1"># might need to use it again to fill out this lane.</span>
                    <span class="n">might_need_to_reuse</span><span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">work</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">by_lane</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="n">used_works</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">used_works_this_lane</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Close out the last lane encountered.</span>
        <span class="n">_done_with_lane</span><span class="p">(</span><span class="n">working_lane</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">relevant_lanes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">queryable_lane_set</span><span class="p">:</span>
                <span class="c1"># We found results for this lane through the main query.</span>
                <span class="c1"># Yield those results.</span>
                <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">by_lane</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We didn&#39;t try to use the main query to find results</span>
                <span class="c1"># for this lane because we knew the results, if there</span>
                <span class="c1"># were any, wouldn&#39;t be representative. This is most</span>
                <span class="c1"># likely because this &#39;lane&#39; is a WorkList and not a</span>
                <span class="c1"># Lane at all. Do a whole separate query and plug it</span>
                <span class="c1"># in at this point.</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">include_sublanes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_featured_works_with_lanes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find a sequence of works that can be used to</span>
<span class="sd">        populate this lane&#39;s grouped acquisition feed.</span>

<span class="sd">        :param lanes: Classify Work objects</span>
<span class="sd">            as belonging to one of these WorkLists (presumably sublanes</span>
<span class="sd">            of `self`).</span>
<span class="sd">        :param facets: A faceting object, presumably a FeaturedFacets</span>
<span class="sd">        :param pagination: A Pagination object explaining how many</span>
<span class="sd">            items to ask for. In most cases this should be slightly more than</span>
<span class="sd">            the number of items you actually want, so that you have some</span>
<span class="sd">            slack to remove duplicates across multiple lanes.</span>
<span class="sd">        :param search_engine: An ExternalSearchIndex to use when</span>
<span class="sd">           asking for the featured works in a given WorkList.</span>
<span class="sd">        :param debug: A debug argument passed into `search_engine` when</span>
<span class="sd">           running the search.</span>

<span class="sd">        :yield: A sequence of (Work, Lane) 2-tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="c1"># We can&#39;t run this query at all.</span>
            <span class="k">return</span>

        <span class="c1"># Ask the search engine for works from every lane we&#39;re given.</span>

        <span class="c1"># NOTE: At the moment, every WorkList in the system can be</span>
        <span class="c1"># generated using an Elasticsearch query. That is, there are</span>
        <span class="c1"># no subclasses of the DatabaseExclusiveWorkList class defined</span>
        <span class="c1"># in circulation/api/lanes.py. If that ever changes, we&#39;ll</span>
        <span class="c1"># need to change this code.</span>
        <span class="c1">#</span>
        <span class="c1"># The simplest change would probably be to return a dictionary</span>
        <span class="c1"># mapping WorkList to Works and let the caller figure out the</span>
        <span class="c1"># ordering. In fact, we could start doing that now.</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="n">overview_facets</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">overview_facets</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="n">Filter</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">from_worklist</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">overview_facets</span><span class="p">)</span>
            <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="p">))</span>
        <span class="n">resultsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">search_engine</span><span class="o">.</span><span class="n">query_works_multi</span><span class="p">(</span><span class="n">queries</span><span class="p">))</span>
        <span class="n">works</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">works_for_resultsets</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">resultsets</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lanes</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">works</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">work</span><span class="p">,</span> <span class="n">lane</span></div>


<div class="viewcode-block" id="HierarchyWorkList"><a class="viewcode-back" href="../../core.html#core.lane.HierarchyWorkList">[docs]</a><span class="k">class</span> <span class="nc">HierarchyWorkList</span><span class="p">(</span><span class="n">WorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList representing part of a hierarchical view of a a</span>
<span class="sd">    library&#39;s collection. (As opposed to a non-hierarchical view such</span>
<span class="sd">    as search results or &quot;books by author X&quot;.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HierarchyWorkList.accessible_to"><a class="viewcode-back" href="../../core.html#core.lane.HierarchyWorkList.accessible_to">[docs]</a>    <span class="k">def</span> <span class="nf">accessible_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;As a matter of library policy, is the given `Patron` allowed</span>
<span class="sd">        to access this `WorkList`?</span>

<span class="sd">        Most of the logic is inherited from `WorkList`, but there&#39;s also</span>
<span class="sd">        a restriction based on the site hierarchy.</span>

<span class="sd">        :param patron: A Patron</span>
<span class="sd">        :return: A boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># All the rules of WorkList apply.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">super</span><span class="p">(</span><span class="n">HierarchyWorkList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">accessible_to</span><span class="p">(</span><span class="n">patron</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">patron</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">root_lane</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">root_lane</span>
        <span class="k">if</span> <span class="n">root_lane</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_self_or_descendant</span><span class="p">(</span><span class="n">root_lane</span><span class="p">):</span>
            <span class="c1"># In addition, a HierarchyWorkList that&#39;s not in</span>
            <span class="c1"># scope of the patron&#39;s root lane is not accessible,</span>
            <span class="c1"># period. Even if all of the books in the WorkList are</span>
            <span class="c1"># age-appropriate, it&#39;s in a different part of the</span>
            <span class="c1"># navigational structure and navigating to it is not</span>
            <span class="c1"># allowed.</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="TopLevelWorkList"><a class="viewcode-back" href="../../core.html#core.lane.TopLevelWorkList">[docs]</a><span class="k">class</span> <span class="nc">TopLevelWorkList</span><span class="p">(</span><span class="n">HierarchyWorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A special WorkList representing the top-level view of</span>
<span class="sd">    a library&#39;s collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="DatabaseBackedWorkList"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList">[docs]</a><span class="k">class</span> <span class="nc">DatabaseBackedWorkList</span><span class="p">(</span><span class="n">WorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList that can get its works from the database in addition to</span>
<span class="sd">    (or possibly instead of) the search index.</span>

<span class="sd">    Even when works _are_ obtained through the search index, a</span>
<span class="sd">    DatabaseBackedWorkList is then created to look up the Work objects</span>
<span class="sd">    for use in an OPDS feed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DatabaseBackedWorkList.works_from_database"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.works_from_database">[docs]</a>    <span class="k">def</span> <span class="nf">works_from_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a query against the `works` table that finds Work objects</span>
<span class="sd">        corresponding to all the Works that belong in this WorkList.</span>

<span class="sd">        The apply_filters() implementation defines which Works qualify</span>
<span class="sd">        for membership in a WorkList of this type.</span>

<span class="sd">        This tends to be slower than WorkList.works, but not all</span>
<span class="sd">        lanes can be generated through search engine queries.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param facets: A faceting object, which may place additional</span>
<span class="sd">           constraints on WorkList membership.</span>
<span class="sd">        :param pagination: A Pagination object indicating which part of</span>
<span class="sd">           the WorkList the caller is looking at.</span>
<span class="sd">        :param kwargs: Ignored -- only included for compatibility with works().</span>
<span class="sd">        :return: A Query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_query</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># In general, we only show books that are present in one of</span>
        <span class="c1"># the WorkList&#39;s collections and ready to be delivered to</span>
        <span class="c1"># patrons.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_show_ready_deliverable_works</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="c1"># Apply to the database the bibliographic restrictions with</span>
        <span class="c1"># which this WorkList was initialized -- genre, audience, and</span>
        <span class="c1"># whatnot.</span>
        <span class="n">qu</span><span class="p">,</span> <span class="n">bibliographic_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_filter_clauses</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bibliographic_clauses</span><span class="p">:</span>
            <span class="n">bibliographic_clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">bibliographic_clauses</span><span class="p">)</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">bibliographic_clause</span><span class="p">)</span>

        <span class="c1"># Allow the faceting object to modify the database query.</span>
        <span class="k">if</span> <span class="n">facets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="c1"># Allow a subclass to modify the database query.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_database_query_hook</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qu</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># This query must always be made distinct, since a Work</span>
            <span class="c1"># can have more than one LicensePool. If no one else has</span>
            <span class="c1"># taken the opportunity to make it distinct (e.g. the</span>
            <span class="c1"># faceting object, while setting sort order), we&#39;ll make</span>
            <span class="c1"># it distinct based on work ID.</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Allow the pagination object to modify the database query.</span>
        <span class="k">if</span> <span class="n">pagination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">modify_database_query</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qu</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.base_query"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.base_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">base_query</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a query that contains the joins set up as necessary to</span>
<span class="sd">        create OPDS feeds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">Work</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">superceded</span><span class="o">==</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Apply optimizations.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_modify_loading</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_defer_unused_fields</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_modify_loading</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optimize a query for use in generating OPDS feeds, by modifying</span>
<span class="sd">        which related objects get pulled from the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Avoid eager loading of objects that are already being loaded.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">contains_eager</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">),</span>
            <span class="n">contains_eager</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">license_pool_name</span> <span class="o">=</span> <span class="s1">&#39;license_pools&#39;</span>

        <span class="c1"># Load some objects that wouldn&#39;t normally be loaded, but</span>
        <span class="c1"># which are necessary when generating OPDS feeds.</span>

        <span class="c1"># TODO: Strictly speaking, these joinedload calls are</span>
        <span class="c1"># only needed by the circulation manager. This code could</span>
        <span class="c1"># be moved to circulation and everyone else who uses this</span>
        <span class="c1"># would be a little faster. (But right now there is no one</span>
        <span class="c1"># else who uses this.)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="c1"># These speed up the process of generating acquisition links.</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="n">license_pool_name</span><span class="p">,</span> <span class="s2">&quot;delivery_mechanisms&quot;</span><span class="p">),</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="n">license_pool_name</span><span class="p">,</span> <span class="s2">&quot;delivery_mechanisms&quot;</span><span class="p">,</span> <span class="s2">&quot;delivery_mechanism&quot;</span><span class="p">),</span>

            <span class="n">joinedload</span><span class="p">(</span><span class="n">license_pool_name</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">),</span>

            <span class="c1"># These speed up the process of generating the open-access link</span>
            <span class="c1"># for open-access works.</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="n">license_pool_name</span><span class="p">,</span> <span class="s2">&quot;delivery_mechanisms&quot;</span><span class="p">,</span> <span class="s2">&quot;resource&quot;</span><span class="p">),</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="n">license_pool_name</span><span class="p">,</span> <span class="s2">&quot;delivery_mechanisms&quot;</span><span class="p">,</span> <span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;representation&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span>

<div class="viewcode-block" id="DatabaseBackedWorkList.only_show_ready_deliverable_works"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.only_show_ready_deliverable_works">[docs]</a>    <span class="k">def</span> <span class="nf">only_show_ready_deliverable_works</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">show_suppressed</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restrict a query to show only presentation-ready works present in</span>
<span class="sd">        an appropriate collection which the default client can</span>
<span class="sd">        fulfill.</span>

<span class="sd">        Note that this assumes the query has an active join against</span>
<span class="sd">        LicensePool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Collection</span><span class="o">.</span><span class="n">restrict_to_ready_deliverable_works</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">show_suppressed</span><span class="o">=</span><span class="n">show_suppressed</span><span class="p">,</span>
            <span class="n">collection_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_ids</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_defer_unused_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Some applications use the simple OPDS entry and some</span>
<span class="sd">        applications use the verbose. Whichever one we don&#39;t need,</span>
<span class="sd">        we can stop from even being sent over from the</span>
<span class="sd">        database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">DEFAULT_OPDS_FORMAT</span> <span class="o">==</span> <span class="s2">&quot;simple_opds_entry&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">defer</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">verbose_opds_entry</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">defer</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">simple_opds_entry</span><span class="p">))</span>

<div class="viewcode-block" id="DatabaseBackedWorkList.bibliographic_filter_clauses"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.bibliographic_filter_clauses">[docs]</a>    <span class="k">def</span> <span class="nf">bibliographic_filter_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a SQLAlchemy filter that excludes books whose bibliographic</span>
<span class="sd">        metadata doesn&#39;t match what we&#39;re looking for.</span>

<span class="sd">        query is either `qu`, or a new query that has been modified to</span>
<span class="sd">        join against additional tables.</span>

<span class="sd">        :return: A 2-tuple (query, clauses).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Audience language, and genre restrictions are allowed on all</span>
        <span class="c1"># WorkLists. (So are collection restrictions, but those are</span>
        <span class="c1"># applied by only_show_ready_deliverable_works().</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_filter_clauses</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">language</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">medium</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">fiction</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">fiction</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_datasource_id</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">license_datasource_id</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_ids</span><span class="p">:</span>
            <span class="n">qu</span><span class="p">,</span> <span class="n">clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_filter_clause</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlist_ids</span><span class="p">:</span>
            <span class="n">qu</span><span class="p">,</span> <span class="n">customlist_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlist_filter_clauses</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">customlist_clauses</span><span class="p">)</span>

        <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_range_filter_clauses</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span><span class="p">:</span>
            <span class="c1"># In addition to the other any other restrictions, books</span>
            <span class="c1"># will show up here only if they would also show up in the</span>
            <span class="c1"># parent WorkList.</span>
            <span class="n">qu</span><span class="p">,</span> <span class="n">parent_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bibliographic_filter_clauses</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_clauses</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parent_clauses</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qu</span><span class="p">,</span> <span class="n">clauses</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.audience_filter_clauses"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.audience_filter_clauses">[docs]</a>    <span class="k">def</span> <span class="nf">audience_filter_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a SQLAlchemy filter that excludes books whose intended</span>
<span class="sd">        audience doesn&#39;t match what we&#39;re looking for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Work</span><span class="o">.</span><span class="n">audience</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">)]</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.customlist_filter_clauses"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.customlist_filter_clauses">[docs]</a>    <span class="k">def</span> <span class="nf">customlist_filter_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a filter clause that only books that are on one of the</span>
<span class="sd">        CustomLists allowed by Lane configuration.</span>

<span class="sd">        :return: A 3-tuple (query, clauses).</span>

<span class="sd">        `query` is the same query as `qu`, possibly extended with</span>
<span class="sd">        additional table joins.</span>

<span class="sd">        `clauses` is a list of SQLAlchemy statements for use in a</span>
<span class="sd">        filter() or case() statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_customlists</span><span class="p">:</span>
            <span class="c1"># This lane does not require that books be on any particular</span>
            <span class="c1"># CustomList.</span>
            <span class="k">return</span> <span class="n">qu</span><span class="p">,</span> <span class="p">[]</span>

        <span class="c1"># We will be joining against CustomListEntry at least</span>
        <span class="c1"># once. For a lane derived from the intersection of two or</span>
        <span class="c1"># more custom lists, we may be joining CustomListEntry</span>
        <span class="c1"># multiple times. To avoid confusion, we make a new alias for</span>
        <span class="c1"># the table every time.</span>
        <span class="n">a_entry</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">CustomListEntry</span><span class="p">)</span>

        <span class="n">clause</span> <span class="o">=</span> <span class="n">a_entry</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a_entry</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>

        <span class="c1"># Actually build the restriction clauses.</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">customlist_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource_id</span><span class="p">:</span>
            <span class="c1"># Use a subquery to obtain the CustomList IDs of all</span>
            <span class="c1"># CustomLists from this DataSource. This is significantly</span>
            <span class="c1"># simpler than adding a join against CustomList.</span>
            <span class="n">customlist_ids</span> <span class="o">=</span> <span class="n">Select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">CustomList</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                <span class="n">CustomList</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">list_datasource_id</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">customlist_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlist_ids</span>
        <span class="k">if</span> <span class="n">customlist_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_entry</span><span class="o">.</span><span class="n">list_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">customlist_ids</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_seen_in_previous_days</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_seen_in_previous_days</span>
            <span class="p">)</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_entry</span><span class="o">.</span><span class="n">most_recent_appearance</span> <span class="o">&gt;=</span><span class="n">cutoff</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qu</span><span class="p">,</span> <span class="n">clauses</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.genre_filter_clause"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.genre_filter_clause">[docs]</a>    <span class="k">def</span> <span class="nf">genre_filter_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="n">wg</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">WorkGenre</span><span class="p">)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wg</span><span class="p">,</span> <span class="n">wg</span><span class="o">.</span><span class="n">work_id</span><span class="o">==</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span><span class="p">,</span> <span class="n">wg</span><span class="o">.</span><span class="n">genre_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre_ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.age_range_filter_clauses"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.age_range_filter_clauses">[docs]</a>    <span class="k">def</span> <span class="nf">age_range_filter_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a clause that filters out all books not classified as</span>
<span class="sd">        suitable for this DatabaseBackedWorkList&#39;s age range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># self.target_age will be a NumericRange for Lanes and a tuple for</span>
        <span class="c1"># most other WorkLists. Make sure it&#39;s always a NumericRange.</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_age</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">target_age</span> <span class="o">=</span> <span class="n">tuple_to_numericrange</span><span class="p">(</span><span class="n">target_age</span><span class="p">)</span>

        <span class="n">audiences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">adult_audiences</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">audiences</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">adult_audiences</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="c1"># Books for adults don&#39;t have target ages. If we&#39;re</span>
            <span class="c1"># including books for adults, either due to the audience</span>
            <span class="c1"># setting or the target age setting, allow the target age</span>
            <span class="c1"># to be empty.</span>
            <span class="n">audience_has_no_target_age</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">target_age</span> <span class="o">==</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audience_has_no_target_age</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># The lane&#39;s target age is an inclusive NumericRange --</span>
        <span class="c1"># set_target_age makes sure of that. The work&#39;s target age</span>
        <span class="c1"># must overlap that of the lane.</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Work</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">target_age</span><span class="p">),</span>
                <span class="n">audience_has_no_target_age</span>
            <span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseBackedWorkList.modify_database_query_hook"><a class="viewcode-back" href="../../core.html#core.lane.DatabaseBackedWorkList.modify_database_query_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A hook method allowing subclasses to modify a database query</span>
<span class="sd">        that&#39;s about to find all the works in this WorkList.</span>

<span class="sd">        This can avoid the need for complex subclasses of</span>
<span class="sd">        DatabaseBackedFacets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qu</span></div></div>


<div class="viewcode-block" id="SpecificWorkList"><a class="viewcode-back" href="../../core.html#core.lane.SpecificWorkList">[docs]</a><span class="k">class</span> <span class="nc">SpecificWorkList</span><span class="p">(</span><span class="n">DatabaseBackedWorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList that only finds specific works, identified by ID.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_ids</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpecificWorkList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_ids</span> <span class="o">=</span> <span class="n">work_ids</span>

<div class="viewcode-block" id="SpecificWorkList.modify_database_query_hook"><a class="viewcode-back" href="../../core.html#core.lane.SpecificWorkList.modify_database_query_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_database_query_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">qu</span><span class="p">):</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_ids</span><span class="p">),</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_ids</span><span class="p">),</span> <span class="c1"># Query optimization</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div></div>


<div class="viewcode-block" id="LaneGenre"><a class="viewcode-back" href="../../core.html#core.lane.LaneGenre">[docs]</a><span class="k">class</span> <span class="nc">LaneGenre</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Relationship object between Lane and Genre.&quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;lanes_genres&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lane_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;lanes.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">genre_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;genres.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># An inclusive relationship means that books classified under the</span>
    <span class="c1"># genre are included in the lane. An exclusive relationship means</span>
    <span class="c1"># that books classified under the genre are excluded, even if they</span>
    <span class="c1"># would otherwise be included.</span>
    <span class="n">inclusive</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># By default, this relationship applies not only to the genre</span>
    <span class="c1"># itself but to all of its subgenres. Setting recursive=false</span>
    <span class="c1"># means that only the genre itself is affected.</span>
    <span class="n">recursive</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;lane_id&#39;</span><span class="p">,</span> <span class="s1">&#39;genre_id&#39;</span><span class="p">),</span>
    <span class="p">)</span>

<div class="viewcode-block" id="LaneGenre.from_genre"><a class="viewcode-back" href="../../core.html#core.lane.LaneGenre.from_genre">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">genre</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used in the Lane.genres association proxy.&quot;&quot;&quot;</span>
        <span class="n">lg</span> <span class="o">=</span> <span class="n">LaneGenre</span><span class="p">()</span>
        <span class="n">lg</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="n">genre</span>
        <span class="k">return</span> <span class="n">lg</span></div></div>

<span class="n">Genre</span><span class="o">.</span><span class="n">lane_genres</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
    <span class="s2">&quot;LaneGenre&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">LaneGenre</span><span class="o">.</span><span class="n">genre_id</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;genre&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="Lane"><a class="viewcode-back" href="../../core.html#core.lane.Lane">[docs]</a><span class="k">class</span> <span class="nc">Lane</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">DatabaseBackedWorkList</span><span class="p">,</span> <span class="n">HierarchyWorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList that draws its search criteria from a row in a</span>
<span class="sd">    database table.</span>

<span class="sd">    A Lane corresponds roughly to a section in a branch library or</span>
<span class="sd">    bookstore. Lanes are the primary means by which patrons discover</span>
<span class="sd">    books.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The set of Works in a standard Lane is cacheable for twenty</span>
    <span class="c1"># minutes. Note that this only applies to paginated feeds --</span>
    <span class="c1"># grouped feeds are cached indefinitely.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="mi">60</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;lanes&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">library_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;libraries.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;lanes.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># How many titles are in this lane? This is periodically</span>
    <span class="c1"># calculated and cached.</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># How many titles are in this lane when viewed through a specific</span>
    <span class="c1"># entry point? This is periodically calculated and cached.</span>
    <span class="n">size_by_entrypoint</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A lane may have one parent lane and many sublanes.</span>
    <span class="n">sublanes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Lane&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">remote_side</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="c1"># A lane may have multiple associated LaneGenres. For most lanes,</span>
    <span class="c1"># this is how the contents of the lanes are defined.</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s1">&#39;lane_genres&#39;</span><span class="p">,</span> <span class="s1">&#39;genre&#39;</span><span class="p">,</span>
                               <span class="n">creator</span><span class="o">=</span><span class="n">LaneGenre</span><span class="o">.</span><span class="n">from_genre</span><span class="p">)</span>
    <span class="n">lane_genres</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LaneGenre&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;LaneGenre.lane_id&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;lane&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span>
    <span class="p">)</span>

    <span class="c1"># display_name is the name of the lane as shown to patrons.  It&#39;s</span>
    <span class="c1"># okay for this to be duplicated within a library, but it&#39;s not</span>
    <span class="c1"># okay to have two lanes with the same parent and the same display</span>
    <span class="c1"># name -- that would be confusing.</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="c1"># True = Fiction only</span>
    <span class="c1"># False = Nonfiction only</span>
    <span class="c1"># null = Both fiction and nonfiction</span>
    <span class="c1">#</span>
    <span class="c1"># This may interact with lane_genres, for genres such as Humor</span>
    <span class="c1"># which can apply to either fiction or nonfiction.</span>
    <span class="n">fiction</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A lane may be restricted to works classified for specific audiences</span>
    <span class="c1"># (e.g. only Young Adult works).</span>
    <span class="n">_audiences</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">Unicode</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;audiences&#39;</span><span class="p">)</span>

    <span class="c1"># A lane may further be restricted to works classified as suitable</span>
    <span class="c1"># for a specific age range.</span>
    <span class="n">_target_age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">INT4RANGE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;target_age&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A lane may be restricted to works available in certain languages.</span>
    <span class="n">languages</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">Unicode</span><span class="p">))</span>

    <span class="c1"># A lane may be restricted to works in certain media (e.g. only</span>
    <span class="c1"># audiobooks).</span>
    <span class="n">media</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">Unicode</span><span class="p">))</span>

    <span class="c1"># TODO: At some point it may be possible to restrict a lane to certain</span>
    <span class="c1"># formats (e.g. only electronic materials or only codices).</span>

    <span class="c1"># Only books licensed through this DataSource will be shown.</span>
    <span class="n">license_datasource_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;datasources.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Only books on one or more CustomLists obtained from this</span>
    <span class="c1"># DataSource will be shown.</span>
    <span class="n">_list_datasource_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;datasources.id&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Only the books on these specific CustomLists will be shown.</span>
    <span class="n">customlists</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CustomList&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">lanes_customlists</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;lane&quot;</span>
    <span class="p">)</span>

    <span class="c1"># This has no effect unless list_datasource_id or</span>
    <span class="c1"># list_identifier_id is also set. If this is set, then a book will</span>
    <span class="c1"># only be shown if it has a CustomListEntry on an appropriate list</span>
    <span class="c1"># where `most_recent_appearance` is within this number of days. If</span>
    <span class="c1"># the number is zero, then the lane contains _every_ book with a</span>
    <span class="c1"># CustomListEntry associated with an appropriate list.</span>
    <span class="n">list_seen_in_previous_days</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If this is set to True, then a book will show up in a lane only</span>
    <span class="c1"># if it would _also_ show up in its parent lane.</span>
    <span class="n">inherit_parent_restrictions</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Patrons whose external type is in this list will be sent to this</span>
    <span class="c1"># lane when they ask for the root lane.</span>
    <span class="c1">#</span>
    <span class="c1"># This is almost never necessary.</span>
    <span class="n">root_for_patron_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">Unicode</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># A grouped feed for a Lane contains a swim lane from each</span>
    <span class="c1"># sublane, plus a swim lane at the bottom for the Lane itself. In</span>
    <span class="c1"># some cases that final swim lane should not be shown. This</span>
    <span class="c1"># generally happens because a) the sublanes are so varied that no</span>
    <span class="c1"># one would want to see a big list containing everything, and b)</span>
    <span class="c1"># the sublanes are exhaustive of the Lane&#39;s content, so there&#39;s</span>
    <span class="c1"># nothing new to be seen by going into that big list.</span>
    <span class="n">include_self_in_grouped_feed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span>
        <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># Only a visible lane will show up in the user interface.  The</span>
    <span class="c1"># admin interface can see all the lanes, visible or not.</span>
    <span class="n">_visible</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;visible&quot;</span><span class="p">)</span>

    <span class="c1"># A Lane may have many CachedFeeds.</span>
    <span class="n">cachedfeeds</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CachedFeed&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;lane&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># A Lane may have many CachedMARCFiles.</span>
    <span class="n">cachedmarcfiles</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;CachedMARCFile&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;lane&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;display_name&#39;</span><span class="p">),</span>
    <span class="p">)</span>

<div class="viewcode-block" id="Lane.get_library"><a class="viewcode-back" href="../../core.html#core.lane.Lane.get_library">[docs]</a>    <span class="k">def</span> <span class="nf">get_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For compatibility with WorkList.get_library().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">list_datasource_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublanes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">visible_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublanes</span> <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">visible</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield the parent, grandparent, etc. of this Lane.</span>

<span class="sd">        The Lane may be inside one or more non-Lane WorkLists, but those</span>
<span class="sd">        WorkLists are not counted in the parentage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This lane&#39;s parent was disconnected from its database session,</span>
            <span class="c1"># probably when an app server started up.</span>
            <span class="c1"># Reattach it to the database session used by this lane.</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">parent</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">grandparent</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">parentage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grandparent</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lane parentage loop detected&quot;</span><span class="p">)</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">grandparent</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">grandparent</span>

<div class="viewcode-block" id="Lane.is_self_or_descendant"><a class="viewcode-back" href="../../core.html#core.lane.Lane.is_self_or_descendant">[docs]</a>    <span class="k">def</span> <span class="nf">is_self_or_descendant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this WorkList the given WorkList or one of its descendants?</span>

<span class="sd">        :param ancestor: A WorkList.</span>
<span class="sd">        :return: A boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">is_self_or_descendant</span><span class="p">(</span><span class="n">ancestor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># A TopLevelWorkList won&#39;t show up in a Lane&#39;s parentage,</span>
        <span class="c1"># because it&#39;s not a Lane, but if they share the same library</span>
        <span class="c1"># it can be presumed to be the lane&#39;s ultimate ancestor.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">TopLevelWorkList</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="o">==</span><span class="n">ancestor</span><span class="o">.</span><span class="n">library_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;How deep is this lane in this site&#39;s hierarchy?</span>
<span class="sd">        i.e. how many times do we have to follow .parent before we get None?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentage</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entrypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lanes cannot currently have EntryPoints.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">visible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">visible</span><span class="p">)</span>

    <span class="nd">@visible</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">visible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of this lane to be used in URLs.</span>

<span class="sd">        Since most aspects of the lane can change through administrative</span>
<span class="sd">        action, we use the internal database ID of the lane in URLs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">audiences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audiences</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="nd">@audiences</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">audiences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The `audiences` field cannot be set to a value that</span>
<span class="sd">        contradicts the current value to the `target_age` field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audiences</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_age</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audiences</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot modify Lane.audiences when Lane.target_age is set!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_audiences</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_age</span>

    <span class="nd">@target_age</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setting .target_age will lock .audiences to appropriate values.</span>

<span class="sd">        If you set target_age to 16-18, you&#39;re saying that the audiences</span>
<span class="sd">        are [Young Adult, Adult].</span>

<span class="sd">        If you set target_age 12-15, you&#39;re saying that the audiences are</span>
<span class="sd">        [Young Adult, Children].</span>

<span class="sd">        If you set target age 0-2, you&#39;re saying that the audiences are</span>
<span class="sd">        [Children].</span>

<span class="sd">        In no case is the &quot;Adults Only&quot; audience allowed, since target</span>
<span class="sd">        age only makes sense in lanes intended for minors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_age</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="n">audiences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tuple_to_numericrange</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span> <span class="o">&gt;=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="c1"># Adults are adults and there&#39;s no point in tracking</span>
            <span class="c1"># precise age gradations for them.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tuple_to_numericrange</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span> <span class="o">&gt;=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tuple_to_numericrange</span><span class="p">(</span>
                <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_age</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span> <span class="o">&gt;=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="n">audiences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">YOUNG_ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="n">audiences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span> <span class="o">&gt;=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">YOUNG_ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="n">audiences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_audiences</span> <span class="o">=</span> <span class="n">audiences</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">list_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource</span>

    <span class="nd">@list_datasource</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">list_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setting .list_datasource to a non-null value wipes out any specific</span>
<span class="sd">        CustomLists previously associated with this Lane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customlists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_customlist_ids&#39;</span><span class="p">):</span>
                <span class="c1"># The next time someone asks for .customlist_ids,</span>
                <span class="c1"># the list will be refreshed.</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span>

        <span class="c1"># TODO: It&#39;s not clear to me why it&#39;s necessary to set these two</span>
        <span class="c1"># values separately.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource_id</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">list_datasource_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_datasource_id</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_customlists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the works() implementation for this Lane look for works on</span>
<span class="sd">        CustomLists?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlists</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uses_customlists</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Lane.max_cache_age"><a class="viewcode-back" href="../../core.html#core.lane.Lane.max_cache_age">[docs]</a>    <span class="k">def</span> <span class="nf">max_cache_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine how long a feed for this WorkList should be cached</span>
<span class="sd">        internally.</span>

<span class="sd">        :param type: The type of feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">GROUPS_TYPE</span><span class="p">:</span>
            <span class="c1"># Generating grouped feeds on the fly for Lanes is not incredibly</span>
            <span class="c1"># expensive, but it&#39;s slow enough that we prefer to regenerate</span>
            <span class="c1"># them in the background (using force_refresh=True) rather</span>
            <span class="c1"># than while someone is waiting for an HTTP response.</span>
            <span class="k">return</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">CACHE_FOREVER</span>

        <span class="c1"># Other than that, we have no opinion -- use the default.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">max_cache_age</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lane.update_size"><a class="viewcode-back" href="../../core.html#core.lane.Lane.update_size">[docs]</a>    <span class="k">def</span> <span class="nf">update_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the stored estimate of the number of Works in this Lane.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="n">ExternalSearchIndex</span>
        <span class="n">search_engine</span> <span class="o">=</span> <span class="n">search_engine</span> <span class="ow">or</span> <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># Do the estimate for every known entry point.</span>
        <span class="n">by_entrypoint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entrypoint</span> <span class="ow">in</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">ENTRY_POINTS</span><span class="p">:</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="n">DatabaseBackedFacets</span><span class="p">(</span>
                <span class="n">library</span><span class="p">,</span> <span class="n">FacetConstants</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">,</span>
                <span class="n">FacetConstants</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">FacetConstants</span><span class="o">.</span><span class="n">ORDER_WORK_ID</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span>
            <span class="p">)</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
            <span class="n">by_entrypoint</span><span class="p">[</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">URI</span><span class="p">]</span> <span class="o">=</span> <span class="n">search_engine</span><span class="o">.</span><span class="n">count_works</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_by_entrypoint</span> <span class="o">=</span> <span class="n">by_entrypoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">by_entrypoint</span><span class="p">[</span><span class="n">EverythingEntryPoint</span><span class="o">.</span><span class="n">URI</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">genre_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the database ID of every Genre such that a Work classified in</span>
<span class="sd">        that Genre should be in this Lane.</span>

<span class="sd">        :return: A list of genre IDs, or None if this Lane does not</span>
<span class="sd">            consider genres at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_genre_ids&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genre_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_genre_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genre_ids</span>

    <span class="k">def</span> <span class="nf">_gather_genre_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method that does the work of `genre_ids`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_genres</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">included_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">excluded_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lanegenre</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_genres</span><span class="p">:</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">lanegenre</span><span class="o">.</span><span class="n">genre</span>
            <span class="k">if</span> <span class="n">lanegenre</span><span class="o">.</span><span class="n">inclusive</span><span class="p">:</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">included_ids</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">excluded_ids</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">genre</span><span class="o">.</span><span class="n">default_fiction</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span> <span class="o">!=</span> <span class="n">genre</span><span class="o">.</span><span class="n">default_fiction</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Lane </span><span class="si">%s</span><span class="s2"> has a genre </span><span class="si">%s</span><span class="s2"> that does not match its fiction restriction.&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_identifier</span><span class="p">,</span> <span class="n">genre</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">genre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lanegenre</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subgenre</span> <span class="ow">in</span> <span class="n">genre</span><span class="o">.</span><span class="n">subgenres</span><span class="p">:</span>
                    <span class="n">bucket</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subgenre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">included_ids</span><span class="p">:</span>
            <span class="c1"># No genres have been explicitly included, so this lane</span>
            <span class="c1"># includes all genres that aren&#39;t excluded.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">included_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">genre</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Genre</span><span class="p">)])</span>
        <span class="n">genre_ids</span> <span class="o">=</span> <span class="n">included_ids</span> <span class="o">-</span> <span class="n">excluded_ids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">genre_ids</span><span class="p">:</span>
            <span class="c1"># This can happen if you create a lane where &#39;Epic</span>
            <span class="c1"># Fantasy&#39; is included but &#39;Fantasy&#39; and its subgenres are</span>
            <span class="c1"># excluded.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Lane </span><span class="si">%s</span><span class="s2"> has a self-negating set of genre IDs.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_identifier</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">genre_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">customlist_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the database ID of every CustomList such that a Work filed</span>
<span class="sd">        in that List should be in this Lane.</span>

<span class="sd">        :return: A list of CustomList IDs, possibly empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_customlist_ids&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_customlist_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customlist_ids</span>

    <span class="k">def</span> <span class="nf">_gather_customlist_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method that does the work of `customlist_ids`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource</span><span class="p">:</span>
            <span class="c1"># Find the ID of every CustomList from a certain</span>
            <span class="c1"># DataSource.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">CustomList</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                <span class="n">CustomList</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">list_datasource</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Find the IDs of some specific CustomLists.</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlists</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_datasource</span><span class="p">:</span>
                <span class="c1"># We are restricted to all lists from a given data</span>
                <span class="c1"># source, and there are no such lists, so we want to</span>
                <span class="c1"># exclude everything.</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There is no custom list restriction at all.</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ids</span>

<div class="viewcode-block" id="Lane.affected_by_customlist"><a class="viewcode-back" href="../../core.html#core.lane.Lane.affected_by_customlist">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">affected_by_customlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all Lanes whose membership is partially derived</span>
<span class="sd">        from the membership of the given CustomList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">customlist</span><span class="p">)</span>

        <span class="c1"># Either the data source must match, or there must be a specific link</span>
        <span class="c1"># between the Lane and the CustomList.</span>
        <span class="n">data_source_matches</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Lane</span><span class="o">.</span><span class="n">_list_datasource_id</span><span class="o">==</span><span class="n">customlist</span><span class="o">.</span><span class="n">data_source_id</span>
        <span class="p">)</span>
        <span class="n">specific_link</span> <span class="o">=</span> <span class="n">CustomList</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">customlist</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span><span class="n">data_source_matches</span><span class="p">,</span> <span class="n">specific_link</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Lane.add_genre"><a class="viewcode-back" href="../../core.html#core.lane.Lane.add_genre">[docs]</a>    <span class="k">def</span> <span class="nf">add_genre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genre</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new LaneGenre for the given genre and</span>
<span class="sd">        associate it with this Lane.</span>

<span class="sd">        Mainly used in tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">genre</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">genre</span><span class="p">)</span>
        <span class="n">lanegenre</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">LaneGenre</span><span class="p">,</span> <span class="n">lane</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">genre</span><span class="o">=</span><span class="n">genre</span>
        <span class="p">)</span>
        <span class="n">lanegenre</span><span class="o">.</span><span class="n">inclusive</span><span class="o">=</span><span class="n">inclusive</span>
        <span class="n">lanegenre</span><span class="o">.</span><span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genre_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_genre_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lanegenre</span><span class="p">,</span> <span class="n">is_new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">search_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the WorkList that should be searched when someone</span>
<span class="sd">        initiates a search from this Lane.&quot;&quot;&quot;</span>

        <span class="c1"># See if this Lane is the root lane for a patron type, or has an</span>
        <span class="c1"># ancestor that&#39;s the root lane for a patron type. If so, search</span>
        <span class="c1"># that Lane.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_for_patron_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">root_for_patron_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parent</span>

        <span class="c1"># Otherwise, we want to use the lane&#39;s languages, media, and</span>
        <span class="c1"># juvenile audiences in search.</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span>
        <span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span>
        <span class="n">audiences</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span> <span class="ow">or</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span>

        <span class="c1"># If there are too many languages or audiences, the description</span>
        <span class="c1"># could get too long to be useful, so we&#39;ll leave them out.</span>
        <span class="c1"># Media isn&#39;t part of the description yet.</span>

        <span class="n">display_name_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">languages</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">display_name_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LanguageCodes</span><span class="o">.</span><span class="n">name_for_languageset</span><span class="p">(</span><span class="n">languages</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">audiences</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audiences</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">display_name_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">audiences</span><span class="p">))</span>

        <span class="n">display_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">display_name_parts</span><span class="p">)</span>

        <span class="n">wl</span> <span class="o">=</span> <span class="n">WorkList</span><span class="p">()</span>
        <span class="n">wl</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
                      <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="n">audiences</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wl</span>

    <span class="k">def</span> <span class="nf">_size_for_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;How big is this lane under the given `Facets` object?</span>

<span class="sd">        :param facets: A Facets object.</span>
<span class="sd">        :return: An int.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default to the total size of the lane.</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="n">entrypoint_name</span> <span class="o">=</span> <span class="n">EverythingEntryPoint</span><span class="o">.</span><span class="n">URI</span>
        <span class="k">if</span> <span class="n">facets</span> <span class="ow">and</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">:</span>
            <span class="n">entrypoint_name</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">URI</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_by_entrypoint</span>
            <span class="ow">and</span> <span class="n">entrypoint_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_by_entrypoint</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_by_entrypoint</span><span class="p">[</span><span class="n">entrypoint_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">size</span>

<div class="viewcode-block" id="Lane.groups"><a class="viewcode-back" href="../../core.html#core.lane.Lane.groups">[docs]</a>    <span class="k">def</span> <span class="nf">groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">include_sublanes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">search_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of (Work, Lane) 2-tuples</span>
<span class="sd">        describing a sequence of featured items for this lane and</span>
<span class="sd">        (optionally) its children.</span>

<span class="sd">        :param pagination: A Pagination object which may affect how many</span>
<span class="sd">            works each child of this WorkList may contribute.</span>
<span class="sd">        :param facets: A FeaturedFacets object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">target_size</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">featured_lane_size</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_self_in_grouped_feed</span><span class="p">:</span>
            <span class="n">relevant_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relevant_lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">include_sublanes</span><span class="p">:</span>
            <span class="c1"># The child lanes go first.</span>
            <span class="n">relevant_lanes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_children</span><span class="p">)</span> <span class="o">+</span> <span class="n">relevant_lanes</span>

        <span class="c1"># We can use a single query to build the featured feeds for</span>
        <span class="c1"># this lane, as well as any of its sublanes that inherit this</span>
        <span class="c1"># lane&#39;s restrictions. Lanes that don&#39;t inherit this lane&#39;s</span>
        <span class="c1"># restrictions will need to be handled in a separate call to</span>
        <span class="c1"># groups().</span>
        <span class="n">queryable_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">relevant_lanes</span>
                           <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups_for_lanes</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">relevant_lanes</span><span class="p">,</span> <span class="n">queryable_lanes</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
            <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">search_engine</span><span class="o">=</span><span class="n">search_engine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Lane.search"><a class="viewcode-back" href="../../core.html#core.lane.Lane.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">search_client</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find works in this lane that also match a search query.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param query_string: Search for this string.</span>
<span class="sd">        :param search_client: An ExternalSearchIndex object.</span>
<span class="sd">        :param pagination: A Pagination object.</span>
<span class="sd">        :param facets: A faceting object, probably a SearchFacets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">search_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_target</span>

        <span class="k">if</span> <span class="n">search_target</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># The actual implementation happens in WorkList.</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Searches in this Lane actually go against some other WorkList.</span>
            <span class="c1"># Tell that object to run the search.</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">search_target</span><span class="o">.</span><span class="n">search</span>

        <span class="k">return</span> <span class="n">m</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">search_client</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span>
                 <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lane.explain"><a class="viewcode-back" href="../../core.html#core.lane.Lane.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a series of human-readable strings to explain a lane&#39;s settings.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Library: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Parent ID: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Priority: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Display name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div></div>

<span class="n">Library</span><span class="o">.</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Lane&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">Lane</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span><span class="p">)</span>
<span class="n">DataSource</span><span class="o">.</span><span class="n">list_lanes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Lane&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;_list_datasource&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">Lane</span><span class="o">.</span><span class="n">_list_datasource_id</span><span class="p">)</span>
<span class="n">DataSource</span><span class="o">.</span><span class="n">license_lanes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Lane&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;license_datasource&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">Lane</span><span class="o">.</span><span class="n">license_datasource_id</span><span class="p">)</span>


<span class="n">lanes_customlists</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;lanes_customlists&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lane_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;lanes.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;customlist_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;customlists.id&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;lane_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customlist_id&#39;</span><span class="p">),</span>
<span class="p">)</span>

<div class="viewcode-block" id="configuration_relevant_lifecycle_event"><a class="viewcode-back" href="../../core.html#core.lane.configuration_relevant_lifecycle_event">[docs]</a><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="s1">&#39;after_insert&#39;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="s1">&#39;after_delete&#39;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">LaneGenre</span><span class="p">,</span> <span class="s1">&#39;after_insert&#39;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">LaneGenre</span><span class="p">,</span> <span class="s1">&#39;after_delete&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">configuration_relevant_lifecycle_event</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="configuration_relevant_update"><a class="viewcode-back" href="../../core.html#core.lane.configuration_relevant_update">[docs]</a><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="s1">&#39;after_update&#39;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">LaneGenre</span><span class="p">,</span> <span class="s1">&#39;after_update&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">configuration_relevant_update</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">directly_modified</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># Some elements of Lane configuration are stored in the</span>
        <span class="c1"># corresponding Library objects for performance reasons.</span>

        <span class="c1"># Remove this information whenever the Lane configuration</span>
        <span class="c1"># changes. This will force it to be recalculated.</span>
        <span class="n">Library</span><span class="o">.</span><span class="n">_has_root_lane_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>