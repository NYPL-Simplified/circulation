
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.classifier &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.classifier</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>

<span class="c1"># If the genre classification does not match the fiction classification, throw</span>
<span class="c1"># away the genre classifications.</span>
<span class="c1">#</span>
<span class="c1"># E.g. &quot;Investigations -- nonfiction&quot; maps to Mystery, but Mystery</span>
<span class="c1"># conflicts with Nonfiction.</span>

<span class="c1"># SQL to find commonly used DDC classifications</span>
<span class="c1"># select count(editions.id) as c, subjects.identifier from editions join identifiers on workrecords.primary_identifier_id=workidentifiers.id join classifications on workidentifiers.id=classifications.work_identifier_id join subjects on classifications.subject_id=subjects.id where subjects.type = &#39;DDC&#39; and not subjects.identifier like &#39;8%&#39; group by subjects.identifier order by c desc;</span>

<span class="c1"># SQL to find commonly used classifications not assigned to a genre</span>
<span class="c1"># select count(identifiers.id) as c, subjects.type, substr(subjects.identifier, 0, 20) as i, substr(subjects.name, 0, 20) as n from workidentifiers join classifications on workidentifiers.id=classifications.work_identifier_id join subjects on classifications.subject_id=subjects.id where subjects.genre_id is null and subjects.fiction is null group by subjects.type, i, n order by c desc;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Counter</span><span class="p">,</span>
    <span class="n">defaultdict</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">and_</span>

<span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">resource_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">)</span>

<span class="n">NO_VALUE</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
<span class="n">NO_NUMBER</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="ClassifierConstants"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.ClassifierConstants">[docs]</a><span class="k">class</span> <span class="nc">ClassifierConstants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">DDC</span> <span class="o">=</span> <span class="s2">&quot;DDC&quot;</span>
    <span class="n">LCC</span> <span class="o">=</span> <span class="s2">&quot;LCC&quot;</span>
    <span class="n">LCSH</span> <span class="o">=</span> <span class="s2">&quot;LCSH&quot;</span>
    <span class="n">FAST</span> <span class="o">=</span> <span class="s2">&quot;FAST&quot;</span>
    <span class="n">OVERDRIVE</span> <span class="o">=</span> <span class="s2">&quot;Overdrive&quot;</span>
    <span class="n">RBDIGITAL</span> <span class="o">=</span> <span class="s2">&quot;RBdigital&quot;</span>
    <span class="n">BISAC</span> <span class="o">=</span> <span class="s2">&quot;BISAC&quot;</span>
    <span class="n">BIC</span> <span class="o">=</span> <span class="s2">&quot;BIC&quot;</span>
    <span class="n">TAG</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span>   <span class="c1"># Folksonomic tags.</span>

    <span class="c1"># Appeal controlled vocabulary developed by NYPL</span>
    <span class="n">NYPL_APPEAL</span> <span class="o">=</span> <span class="s2">&quot;NYPL Appeal&quot;</span>

    <span class="n">GRADE_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;Grade level&quot;</span> <span class="c1"># &quot;1-2&quot;, &quot;Grade 4&quot;, &quot;Kindergarten&quot;, etc.</span>
    <span class="n">AGE_RANGE</span> <span class="o">=</span> <span class="s2">&quot;schema:typicalAgeRange&quot;</span> <span class="c1"># &quot;0-2&quot;, etc.</span>
    <span class="n">AXIS_360_AUDIENCE</span> <span class="o">=</span> <span class="s2">&quot;Axis 360 Audience&quot;</span>
    <span class="n">RBDIGITAL_AUDIENCE</span> <span class="o">=</span> <span class="s2">&quot;RBdigital Audience&quot;</span>

    <span class="c1"># We know this says something about the audience but we&#39;re not sure what.</span>
    <span class="c1"># Could be any of the values from GRADE_LEVEL or AGE_RANGE, plus</span>
    <span class="c1"># &quot;YA&quot;, &quot;Adult&quot;, etc.</span>
    <span class="n">FREEFORM_AUDIENCE</span> <span class="o">=</span> <span class="s2">&quot;schema:audience&quot;</span>

    <span class="n">GUTENBERG_BOOKSHELF</span> <span class="o">=</span> <span class="s2">&quot;gutenberg:bookshelf&quot;</span>
    <span class="n">TOPIC</span> <span class="o">=</span> <span class="s2">&quot;schema:Topic&quot;</span>
    <span class="n">PLACE</span> <span class="o">=</span> <span class="s2">&quot;schema:Place&quot;</span>
    <span class="n">PERSON</span> <span class="o">=</span> <span class="s2">&quot;schema:Person&quot;</span>
    <span class="n">ORGANIZATION</span> <span class="o">=</span> <span class="s2">&quot;schema:Organization&quot;</span>
    <span class="n">LEXILE_SCORE</span> <span class="o">=</span> <span class="s2">&quot;Lexile&quot;</span>
    <span class="n">ATOS_SCORE</span> <span class="o">=</span> <span class="s2">&quot;ATOS&quot;</span>
    <span class="n">INTEREST_LEVEL</span> <span class="o">=</span> <span class="s2">&quot;Interest Level&quot;</span>

    <span class="n">AUDIENCE_ADULT</span> <span class="o">=</span> <span class="s2">&quot;Adult&quot;</span>
    <span class="n">AUDIENCE_ADULTS_ONLY</span> <span class="o">=</span> <span class="s2">&quot;Adults Only&quot;</span>
    <span class="n">AUDIENCE_YOUNG_ADULT</span> <span class="o">=</span> <span class="s2">&quot;Young Adult&quot;</span>
    <span class="n">AUDIENCE_CHILDREN</span> <span class="o">=</span> <span class="s2">&quot;Children&quot;</span>
    <span class="n">AUDIENCE_ALL_AGES</span> <span class="o">=</span> <span class="s2">&quot;All Ages&quot;</span>
    <span class="n">AUDIENCE_RESEARCH</span> <span class="o">=</span> <span class="s2">&quot;Research&quot;</span>

    <span class="c1"># A book for a child younger than 14 is a children&#39;s book.</span>
    <span class="c1"># A book for a child 14 or older is a young adult book.</span>
    <span class="n">YOUNG_ADULT_AGE_CUTOFF</span> <span class="o">=</span> <span class="mi">14</span>

    <span class="n">ADULT_AGE_CUTOFF</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="c1"># &quot;All ages&quot; actually means &quot;all ages with reading fluency&quot;.</span>
    <span class="n">ALL_AGES_AGE_CUTOFF</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="n">AUDIENCES_YOUNG_CHILDREN</span> <span class="o">=</span> <span class="p">[</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span> <span class="n">AUDIENCE_ALL_AGES</span><span class="p">]</span>
    <span class="n">AUDIENCES_JUVENILE</span> <span class="o">=</span> <span class="n">AUDIENCES_YOUNG_CHILDREN</span> <span class="o">+</span> <span class="p">[</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">]</span>
    <span class="n">AUDIENCES_ADULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span> <span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">,</span> <span class="n">AUDIENCE_ALL_AGES</span><span class="p">]</span>
    <span class="n">AUDIENCES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span> <span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">,</span> <span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
                     <span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span> <span class="n">AUDIENCE_ALL_AGES</span><span class="p">,</span> <span class="n">AUDIENCE_RESEARCH</span><span class="p">])</span>

    <span class="n">SIMPLIFIED_GENRE</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/genres/Simplified/&quot;</span>
    <span class="n">SIMPLIFIED_FICTION_STATUS</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/fiction/&quot;</span></div>

<div class="viewcode-block" id="Classifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier">[docs]</a><span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">ClassifierConstants</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn an external classification into an internal genre, an</span>
<span class="sd">    audience, an age level, and a fiction status.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AUDIENCES_NO_RESEARCH</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ClassifierConstants</span><span class="o">.</span><span class="n">AUDIENCES</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">ClassifierConstants</span><span class="o">.</span><span class="n">AUDIENCE_RESEARCH</span>
    <span class="p">]</span>

    <span class="n">classifiers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="Classifier.range_tuple"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.range_tuple">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">range_tuple</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a pair of ages into a tuple that represents an age range.</span>
<span class="sd">        This may be turned into an inclusive postgres NumericRange later,</span>
<span class="sd">        but this code should not depend on postgres.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Just in case the upper and lower ranges are mixed up,</span>
        <span class="c1"># and no prior code caught this, un-mix them.</span>
        <span class="k">if</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">upper</span> <span class="ow">and</span> <span class="n">lower</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">:</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.lookup"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.lookup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up a classifier for a classification scheme.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">classifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.name_for"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.name_for">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">name_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up a human-readable name for the given identifier.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Classifier.classify"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.classify">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to determine genre, audience, target age, and fiction status</span>
<span class="sd">        for the given Subject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">scrub_identifier_and_name</span><span class="p">(</span>
            <span class="n">subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="n">fiction</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_fiction</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">audience</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">audience</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_age</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_target_age_for_audience</span><span class="p">(</span><span class="n">audience</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">genre</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span> <span class="n">audience</span><span class="p">),</span>
                <span class="n">audience</span><span class="p">,</span>
                <span class="n">target_age</span><span class="p">,</span>
                <span class="n">fiction</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.scrub_identifier_and_name"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.scrub_identifier_and_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scrub_identifier_and_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare identifier and name from within a call to classify().&quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">scrub_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># scrub_identifier returned a canonical value for name as</span>
            <span class="c1"># well. Use it in preference to any name associated with</span>
            <span class="c1"># the subject.</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">scrub_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Classifier.scrub_identifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.scrub_identifier">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scrub_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare an identifier from within a call to classify().</span>

<span class="sd">        This may involve data normalization, conversion to lowercase,</span>
<span class="sd">        etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Lowercased</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.scrub_name"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.scrub_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scrub_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare a name from within a call to classify().&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Lowercased</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Classifier.genre"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.genre">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audience</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this identifier associated with a particular Genre?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Classifier.genre_match"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.genre_match">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">genre_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this query string match a particular Genre, and which part</span>
<span class="sd">        of the query matches?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Classifier.is_fiction"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.is_fiction">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_fiction</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this identifier+name particularly indicative of fiction?</span>
<span class="sd">        How about nonfiction?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;nonfiction&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;fiction&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Classifier.audience"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.audience">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What does this identifier+name say about the audience for</span>
<span class="sd">        this book?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;juvenile&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span>
        <span class="k">elif</span> <span class="s1">&#39;young adult&#39;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;YA&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">original</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Classifier.audience_match"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.audience_match">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this query string match a particular Audience, and which</span>
<span class="sd">        part of the query matches?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.target_age"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.target_age">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For children&#39;s books, what does this identifier+name say</span>
<span class="sd">        about the target age for this book?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.default_target_age_for_audience"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.default_target_age_for_audience">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_target_age_for_audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">audience</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default target age for a given audience.</span>

<span class="sd">        We don&#39;t know what age range a children&#39;s book is appropriate</span>
<span class="sd">        for, but we can make a decent guess for a YA book, for an</span>
<span class="sd">        &#39;Adult&#39; book it&#39;s pretty clear, and for an &#39;Adults Only&#39; book</span>
<span class="sd">        it&#39;s very clear.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">audience</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Classifier.default_audience_for_target_age"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.default_audience_for_target_age">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_audience_for_target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">range</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="nb">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lower</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">upper</span><span class="p">:</span>
            <span class="c1"># You could interpret this as &#39;all ages&#39; but it&#39;s more</span>
            <span class="c1"># likely the data is simply missing.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lower</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">upper</span> <span class="o">&gt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span><span class="p">:</span>
                <span class="c1"># e.g. &quot;up to 20 years&quot;, though this doesn&#39;t</span>
                <span class="c1"># really make sense.</span>
                <span class="c1">#</span>
                <span class="c1"># The &#39;all ages&#39; interpretation is more plausible here</span>
                <span class="c1"># but it&#39;s still more likely that this is simply a</span>
                <span class="c1"># book for grown-ups and no lower bound was provided.</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>
            <span class="k">elif</span> <span class="n">upper</span> <span class="o">&gt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">YOUNG_ADULT_AGE_CUTOFF</span><span class="p">:</span>
                <span class="c1"># e.g. &quot;up to 15 years&quot;</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># e.g. &quot;up to 14 years&quot;</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span>

        <span class="c1"># At this point we can assume that lower is not None.</span>
        <span class="k">if</span> <span class="n">lower</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>
        <span class="k">elif</span> <span class="n">lower</span> <span class="o">&gt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">YOUNG_ADULT_AGE_CUTOFF</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">elif</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ALL_AGES_AGE_CUTOFF</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">upper</span> <span class="o">&gt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ADULT_AGE_CUTOFF</span>
        <span class="p">):</span>
            <span class="c1"># e.g. &quot;for children ages 7-77&quot;. The &#39;all ages&#39; reading</span>
            <span class="c1"># is here the most plausible.</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span>
        <span class="k">elif</span> <span class="n">lower</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">upper</span> <span class="ow">or</span> <span class="n">upper</span> <span class="o">&gt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">YOUNG_ADULT_AGE_CUTOFF</span><span class="p">):</span>
            <span class="c1"># Although we treat &quot;Young Adult&quot; as starting at 14, many</span>
            <span class="c1"># outside sources treat it as starting at 12. As such we</span>
            <span class="c1"># treat &quot;12 and up&quot; or &quot;12-14&quot; as an indicator of a Young</span>
            <span class="c1"># Adult audience, with a target age that overlaps what we</span>
            <span class="c1"># consider a Children audience.</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span></div>

<div class="viewcode-block" id="Classifier.and_up"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Classifier.and_up">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">and_up</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">young</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encapsulates the logic of what &quot;[x] and up&quot; actually means.</span>

<span class="sd">        Given the lower end of an age range, tries to determine the</span>
<span class="sd">        upper end of the range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">young</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">keyword</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                 <span class="p">(</span><span class="s2">&quot;and up&quot;</span><span class="p">,</span> <span class="s2">&quot;and up.&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;+.&quot;</span><span class="p">)</span>
             <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">young</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">young</span>
        <span class="k">elif</span> <span class="n">young</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
            <span class="c1"># &quot;12 and up&quot;, &quot;14 and up&quot;, etc.  are</span>
            <span class="c1"># generally intended to cover the entire</span>
            <span class="c1"># YA span.</span>
            <span class="n">old</span> <span class="o">=</span> <span class="mi">17</span>
        <span class="k">elif</span> <span class="n">young</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="c1"># &quot;8 and up&quot; means something like &quot;8-12&quot;</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">young</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Whereas &quot;3 and up&quot; really means more</span>
            <span class="c1"># like &quot;3 to 5&quot;.</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">young</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">old</span></div></div>

<span class="k">class</span> <span class="nc">GradeLevelClassifier</span><span class="p">(</span><span class="n">Classifier</span><span class="p">):</span>
    <span class="c1"># How old a kid is when they start grade N in the US.</span>
    <span class="n">american_grade_to_age</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Preschool: 3-4 years</span>
        <span class="s1">&#39;preschool&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;pre-school&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;p&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;pk&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>

        <span class="c1"># Easy readers</span>
        <span class="s1">&#39;kindergarten&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;k&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;0&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;first&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s1">&#39;1&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s1">&#39;second&#39;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s1">&#39;2&#39;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>

        <span class="c1"># Chapter Books</span>
        <span class="s1">&#39;third&#39;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;3&#39;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;fourth&#39;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;4&#39;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;fifth&#39;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;5&#39;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;sixth&#39;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s1">&#39;6&#39;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s1">&#39;7&#39;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s1">&#39;8&#39;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>

        <span class="c1"># YA</span>
        <span class="s1">&#39;9&#39;</span> <span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
        <span class="s1">&#39;10&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;11&#39;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s1">&#39;12&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Regular expressions that match common ways of expressing grade</span>
    <span class="c1"># levels.</span>
    <span class="n">grade_res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;grades? ([kp0-9]+) to ([kp0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;grades? ([kp0-9]+) ?-? ?([kp0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gr\.? ([kp0-9]+) ?-? ?([kp0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;grades?: ([kp0-9]+) to ([kp0-9]+)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;grades?: ([kp0-9]+) ?-? ?([kp0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gr\.? ([kp0-9]+)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([0-9]+)[tnsr][hdt] grade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([a-z]+) grade&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;\b(kindergarten|preschool)\b&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>

    <span class="n">generic_grade_res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([kp0-9]+) ?- ?([0-9]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([kp0-9]+) ?to ?([0-9]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([0-9]+)\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([kp])\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_audience_for_target_age</span><span class="p">(</span><span class="n">target_age</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_grade_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">identifier</span> <span class="ow">and</span> <span class="s2">&quot;education&quot;</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="s1">&#39;education&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1"># This is a book about teaching, e.g. fifth grade.</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">identifier</span> <span class="ow">and</span> <span class="s1">&#39;grader&#39;</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="s1">&#39;grader&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1"># This is a book about, e.g. fifth graders.</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_explicit_grade_marker</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">grade_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">grade_res</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">generic_grade_res</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">gr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">young</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">gr</span>

                    <span class="c1"># Strip leading zeros</span>
                    <span class="k">if</span> <span class="n">young</span> <span class="ow">and</span> <span class="n">young</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">):</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="n">young</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">and</span> <span class="n">old</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">):</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>

                    <span class="n">young</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">american_grade_to_age</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">young</span><span class="p">)</span>
                    <span class="n">old</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">american_grade_to_age</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">young</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">young</span><span class="p">:</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">young</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old</span><span class="p">:</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">and_up</span><span class="p">(</span><span class="n">young</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">young</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="n">young</span>
                    <span class="k">if</span> <span class="n">young</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="n">old</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">and</span> <span class="n">young</span> <span class="ow">and</span>  <span class="n">old</span> <span class="o">&lt;</span> <span class="n">young</span><span class="p">:</span>
                        <span class="n">young</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="p">,</span> <span class="n">young</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="n">young</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grade_words</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">require_explicit_grade_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_age</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">grade_res</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">grade_words</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">target_age</span><span class="p">,</span> <span class="n">grade_words</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InterestLevelClassifier</span><span class="p">(</span><span class="n">Classifier</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lg&#39;</span><span class="p">,</span> <span class="s1">&#39;mg+&#39;</span><span class="p">,</span> <span class="s1">&#39;mg&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;ug&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;lg&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mg+&#39;</span><span class="p">,</span> <span class="s1">&#39;mg&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;ug&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">AgeClassifier</span><span class="p">(</span><span class="n">Classifier</span><span class="p">):</span>
    <span class="c1"># Regular expressions that match common ways of expressing ages.</span>
    <span class="n">age_res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;age ([0-9]+) ?-? ?([0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age: ([0-9]+) ?-? ?([0-9]+)?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age: ([0-9]+) to ([0-9]+)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ages ([0-9]+) ?- ?([0-9]+)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([0-9]+) ?- ?([0-9]+) years?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([0-9]+) years?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ages ([0-9]+)+&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([0-9]+) and up&quot;</span><span class="p">,</span>
            <span class="s2">&quot;([0-9]+) years? and up&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>

    <span class="n">generic_age_res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;([0-9]+) ?- ?([0-9]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([0-9]+)\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">baby_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^baby ?- ?([0-9]+) year&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_audience_for_target_age</span><span class="p">(</span><span class="n">target_age</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">require_explicit_age_marker</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">age_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">age_res</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">generic_age_res</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">baby_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="c1"># This is for babies.</span>
                <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">groups</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">young</span> <span class="o">=</span> <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">old</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">and_up</span><span class="p">(</span><span class="n">young</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">young</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="n">young</span>
                    <span class="k">if</span> <span class="n">young</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="n">old</span>
                    <span class="k">if</span> <span class="n">old</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                        <span class="c1"># This is not an age at all.</span>
                        <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">young</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                        <span class="c1"># This is not an age at all.</span>
                        <span class="n">young</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">young</span> <span class="o">&gt;</span> <span class="n">old</span><span class="p">:</span>
                        <span class="n">young</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="p">,</span> <span class="n">young</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="n">young</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">age_words</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">require_explicit_age_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_age</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">age_res</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">age_words</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">target_age</span><span class="p">,</span> <span class="n">age_words</span><span class="p">)</span>


<span class="c1"># This is the large-scale structure of our classification system.</span>
<span class="c1">#</span>
<span class="c1"># If the name of a genre is a string, it&#39;s the name of the genre</span>
<span class="c1"># and there are no subgenres.</span>
<span class="c1">#</span>
<span class="c1"># If the name of a genre is a dictionary, the &#39;name&#39; argument is the</span>
<span class="c1"># name of the genre, and the &#39;subgenres&#39; argument is the list of the</span>
<span class="c1"># subgenres.</span>

<span class="n">COMICS_AND_GRAPHIC_NOVELS</span> <span class="o">=</span> <span class="s2">&quot;Comics &amp; Graphic Novels&quot;</span>

<span class="n">fiction_genres</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Classics&quot;</span><span class="p">,</span>
    <span class="n">COMICS_AND_GRAPHIC_NOVELS</span><span class="p">,</span>
    <span class="s2">&quot;Drama&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Erotica&quot;</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Epic Fantasy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Historical Fantasy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Urban Fantasy&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Folklore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Historical Fiction&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Horror&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Gothic Horror&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ghost Stories&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Vampires&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Werewolves&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Occult Horror&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Humorous Fiction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Literary Fiction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LGBTQ Fiction&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mystery&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Crime &amp; Detective Stories&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hard-Boiled Mystery&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Police Procedural&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cozy Mystery&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Historical Mystery&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Paranormal Mystery&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Women Detectives&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Poetry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Religious Fiction&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Romance&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Contemporary Romance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gothic Romance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Historical Romance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Paranormal Romance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Western Romance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Romantic Suspense&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Science Fiction&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Dystopian SF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Space Opera&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cyberpunk&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Military SF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Alternative History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Steampunk&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Romantic SF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Media Tie-in SF&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Short Stories&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Suspense/Thriller&quot;</span><span class="p">,</span>
        <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;Historical Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Espionage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Supernatural Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Medical Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Political Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Psychological Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Technothriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Legal Thriller&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Military Thriller&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">),</span>
    <span class="s2">&quot;Urban Fiction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Westerns&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Women&#39;s Fiction&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">nonfiction_genres</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Art &amp; Design&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Architecture&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Art&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Art Criticism &amp; Theory&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Art History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Design&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fashion&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Photography&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Biography &amp; Memoir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Education&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Personal Finance &amp; Business&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Business&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Economics&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Management &amp; Leadership&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Personal Finance &amp; Investing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Real Estate&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parenting &amp; Family&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Family &amp; Relationships&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Parenting&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Food &amp; Health&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Bartending &amp; Cocktails&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cooking&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Health &amp; Diet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Vegetarian &amp; Vegan&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;History&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;African History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ancient History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Asian History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Civil War History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;European History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Latin American History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Medieval History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Middle East History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Military History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Modern History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Renaissance &amp; Early Modern History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;United States History&quot;</span><span class="p">,</span>
        <span class="s2">&quot;World History&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Hobbies &amp; Home&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Antiques &amp; Collectibles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Crafts &amp; Hobbies&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gardening&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;House &amp; Home&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pets&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Humorous Nonfiction&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Entertainment&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Film &amp; TV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Music&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Performing Arts&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Life Strategies&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Literary Criticism&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Periodicals&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Philosophy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Political Science&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Reference &amp; Study Aids&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Dictionaries&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Foreign Language Study&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Law&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Study Aids&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Religion &amp; Spirituality&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Body, Mind &amp; Spirit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Buddhism&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Christianity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hinduism&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Islam&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Judaism&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Science &amp; Technology&quot;</span><span class="p">,</span> <span class="n">subgenres</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Computers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mathematics&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Medical&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Nature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Psychology&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Science&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Social Sciences&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Technology&quot;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="s2">&quot;Self-Help&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sports&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Travel&quot;</span><span class="p">,</span>
    <span class="s2">&quot;True Crime&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="GenreData"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.GenreData">[docs]</a><span class="k">class</span> <span class="nc">GenreData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_fiction</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audience_restriction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fiction</span> <span class="o">=</span> <span class="n">is_fiction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subgenres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audience_restriction</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">audience_restriction</span> <span class="o">=</span> <span class="p">[</span><span class="n">audience_restriction</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audience_restriction</span> <span class="o">=</span> <span class="n">audience_restriction</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;GenreData: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">self_and_subgenres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_subgenres</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">child</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_subgenres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgenres</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subgenre</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">self_and_subgenres</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">subgenre</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>

<div class="viewcode-block" id="GenreData.has_subgenre"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.GenreData.has_subgenre">[docs]</a>    <span class="k">def</span> <span class="nf">has_subgenre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subgenre</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgenres</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">subgenre</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">has_subgenre</span><span class="p">(</span><span class="n">subgenre</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variable_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, &amp; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &amp; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GenreData.populate"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.GenreData.populate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">fiction_source</span><span class="p">,</span> <span class="n">nonfiction_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a GenreData object for every genre and subgenre in the given</span>
<span class="sd">        list of fiction and nonfiction genres.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">default_fiction</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">fiction_source</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="n">nonfiction_source</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">subgenres</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">audience_restriction</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">fiction</span> <span class="o">=</span> <span class="n">default_fiction</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">subgenres</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subgenres&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">audience_restriction</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;audience_restriction&#39;</span><span class="p">)</span>
                    <span class="n">fiction</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fiction&#39;</span><span class="p">,</span> <span class="n">default_fiction</span><span class="p">)</span>

                <span class="bp">cls</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span>
                    <span class="n">namespace</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">subgenres</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="n">audience_restriction</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenreData.add_genre"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.GenreData.add_genre">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">subgenres</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span>
                  <span class="n">parent</span><span class="p">,</span> <span class="n">audience_restriction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a GenreData object. Add it to a dictionary and a namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">default_fiction</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">default_fiction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">default_audience</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">default_fiction</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">is_fiction</span>
            <span class="n">default_audience</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">audience_restriction</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">subgenres</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subgenres&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">fiction</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fiction&#39;</span><span class="p">,</span> <span class="n">default_fiction</span><span class="p">)</span>
            <span class="n">audience_restriction</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;audience&#39;</span><span class="p">,</span> <span class="n">default_audience</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate genre name! </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Create the GenreData object.</span>
        <span class="n">genre_data</span> <span class="o">=</span> <span class="n">GenreData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">audience_restriction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">subgenres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_data</span><span class="p">)</span>

        <span class="c1"># Add the genre to the given dictionary, keyed on name.</span>
        <span class="n">genres</span><span class="p">[</span><span class="n">genre_data</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">genre_data</span>

        <span class="c1"># Convert the name to a Python-safe variable name,</span>
        <span class="c1"># and add it to the given namespace.</span>
        <span class="n">namespace</span><span class="p">[</span><span class="n">genre_data</span><span class="o">.</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">genre_data</span>

        <span class="c1"># Do the same for subgenres.</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subgenres</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="p">[],</span> <span class="n">fiction</span><span class="p">,</span>
                          <span class="n">genre_data</span><span class="p">,</span> <span class="n">audience_restriction</span><span class="p">)</span></div></div>

<span class="n">genres</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">GenreData</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="n">genres</span><span class="p">,</span> <span class="n">fiction_genres</span><span class="p">,</span> <span class="n">nonfiction_genres</span><span class="p">)</span>

<div class="viewcode-block" id="Lowercased"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Lowercased">[docs]</a><span class="k">class</span> <span class="nc">Lowercased</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lowercased string that remembers its original value.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Lowercased</span><span class="p">):</span>
            <span class="c1"># Nothing to do.</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">o</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Lowercased</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">o</span>

<div class="viewcode-block" id="Lowercased.scrub_identifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.Lowercased.scrub_identifier">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scrub_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">identifier</span></div></div>

<div class="viewcode-block" id="AgeOrGradeClassifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.AgeOrGradeClassifier">[docs]</a><span class="k">class</span> <span class="nc">AgeOrGradeClassifier</span><span class="p">(</span><span class="n">Classifier</span><span class="p">):</span>

<div class="viewcode-block" id="AgeOrGradeClassifier.audience"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.AgeOrGradeClassifier.audience">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">audience</span> <span class="o">=</span> <span class="n">AgeClassifier</span><span class="o">.</span><span class="n">audience</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audience</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">GradeLevelClassifier</span><span class="o">.</span><span class="n">audience</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">audience</span></div>

<div class="viewcode-block" id="AgeOrGradeClassifier.target_age"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.AgeOrGradeClassifier.target_age">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This tag might contain a grade level, an age in years, or nothing.</span>
<span class="sd">        We will try both a grade level and an age in years, but we</span>
<span class="sd">        will require that the tag indicate what&#39;s being measured. A</span>
<span class="sd">        tag like &quot;9-12&quot; will not match anything because we don&#39;t know if it&#39;s</span>
<span class="sd">        age 9-12 or grade 9-12.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">AgeClassifier</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">age</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">GradeLevelClassifier</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">age</span></div></div>

<div class="viewcode-block" id="FreeformAudienceClassifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.FreeformAudienceClassifier">[docs]</a><span class="k">class</span> <span class="nc">FreeformAudienceClassifier</span><span class="p">(</span><span class="n">AgeOrGradeClassifier</span><span class="p">):</span>
    <span class="c1"># NOTE: In practice, subjects like &quot;books for all ages&quot; tend to be</span>
    <span class="c1"># more like advertising slogans than reliable indicators of an</span>
    <span class="c1"># ALL_AGES audience. So the only subject of this type we handle is</span>
    <span class="c1"># the literal string &quot;all ages&quot;, as it would appear, e.g., in the</span>
    <span class="c1"># output of the metadata wrangler.</span>

<div class="viewcode-block" id="FreeformAudienceClassifier.audience"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.FreeformAudienceClassifier.audience">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="s1">&#39;pre-adolescent&#39;</span><span class="p">,</span> <span class="s1">&#39;beginning reader&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;young adult&#39;</span><span class="p">,</span> <span class="s1">&#39;ya&#39;</span><span class="p">,</span> <span class="s1">&#39;teenagers&#39;</span><span class="p">,</span> <span class="s1">&#39;adolescent&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;early adolescents&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;adult&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;adults only&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;all ages&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span>
        <span class="k">elif</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;research&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AUDIENCE_RESEARCH</span>
        <span class="k">return</span> <span class="n">AgeOrGradeClassifier</span><span class="o">.</span><span class="n">audience</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FreeformAudienceClassifier.target_age"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.FreeformAudienceClassifier.target_age">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;beginning reader&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;pre-adolescent&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;early adolescents&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s1">&#39;all ages&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">ALL_AGES_AGE_CUTOFF</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="n">strict_age</span> <span class="o">=</span> <span class="n">AgeClassifier</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strict_age</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">strict_age</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">strict_age</span>

        <span class="n">strict_grade</span> <span class="o">=</span> <span class="n">GradeLevelClassifier</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strict_grade</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">strict_grade</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">strict_grade</span>

        <span class="c1"># Default to assuming it&#39;s an unmarked age.</span>
        <span class="k">return</span> <span class="n">AgeClassifier</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WorkClassifier"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier">[docs]</a><span class="k">class</span> <span class="nc">WorkClassifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Boil down a bunch of Classification objects into a few values.&quot;&quot;&quot;</span>

    <span class="c1"># TODO: This needs a lot of additions.</span>
    <span class="n">genre_publishers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Harlequin&quot;</span> <span class="p">:</span> <span class="n">Romance</span><span class="p">,</span>
        <span class="s2">&quot;Pocket Books/Star Trek&quot;</span> <span class="p">:</span> <span class="n">Media_Tie_in_SF</span><span class="p">,</span>
        <span class="s2">&quot;Kensington&quot;</span> <span class="p">:</span> <span class="n">Urban_Fiction</span><span class="p">,</span>
        <span class="s2">&quot;Fodor&#39;s Travel Publications&quot;</span> <span class="p">:</span> <span class="n">Travel</span><span class="p">,</span>
        <span class="s2">&quot;Marvel Entertainment, LLC&quot;</span> <span class="p">:</span> <span class="n">Comics_Graphic_Novels</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">genre_imprints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Harlequin Intrigue&quot;</span> <span class="p">:</span> <span class="n">Romantic_Suspense</span><span class="p">,</span>
        <span class="s2">&quot;Love Inspired Suspense&quot;</span> <span class="p">:</span> <span class="n">Romantic_Suspense</span><span class="p">,</span>
        <span class="s2">&quot;Harlequin Historical&quot;</span> <span class="p">:</span> <span class="n">Historical_Romance</span><span class="p">,</span>
        <span class="s2">&quot;Harlequin Historical Undone&quot;</span> <span class="p">:</span> <span class="n">Historical_Romance</span><span class="p">,</span>
        <span class="s2">&quot;Frommers&quot;</span> <span class="p">:</span> <span class="n">Travel</span><span class="p">,</span>
        <span class="s2">&quot;LucasBooks&quot;</span><span class="p">:</span> <span class="n">Media_Tie_in_SF</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">audience_imprints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Harlequin Teen&quot;</span> <span class="p">:</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
        <span class="s2">&quot;HarperTeen&quot;</span> <span class="p">:</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
        <span class="s2">&quot;Open Road Media Teen &amp; Tween&quot;</span> <span class="p">:</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
        <span class="s2">&quot;Rosen Young Adult&quot;</span> <span class="p">:</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">not_adult_publishers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s2">&quot;Scholastic Inc.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Random House Children&#39;s Books&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Little, Brown Books for Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Penguin Young Readers Group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hachette Children&#39;s Books&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Nickelodeon Publishing&quot;</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="n">not_adult_imprints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s2">&quot;Scholastic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Scholastic Paperbacks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Random House Books for Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HMH Books for Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Knopf Books for Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Delacorte Books for Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Open Road Media Young Readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Macmillan Young Listeners&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Bloomsbury Childrens&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NYR Children&#39;s Collection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Bloomsbury USA Childrens&quot;</span><span class="p">,</span>
        <span class="s2">&quot;National Geographic Children&#39;s Books&quot;</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="n">fiction_imprints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;Del Rey&quot;</span><span class="p">])</span>
    <span class="n">nonfiction_imprints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;Harlequin Nonfiction&quot;</span><span class="p">])</span>

    <span class="n">nonfiction_publishers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;Wiley&quot;</span><span class="p">])</span>
    <span class="n">fiction_publishers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">test_session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">test_session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genre_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direct_from_license_source</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_classifications</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Classifier (workid=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_genres</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_fiction_status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_audience</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_target_age</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Keep track of whether we&#39;ve seen one of Overdrive&#39;s generic</span>
        <span class="c1"># &quot;Juvenile&quot; classifications, as well as its more specific</span>
        <span class="c1"># subsets like &quot;Picture Books&quot; and &quot;Beginning Readers&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_generic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_with_target_age</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="WorkClassifier.add"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classification</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare a single Classification for consideration.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..model</span> <span class="kn">import</span> <span class="n">DataSource</span><span class="p">,</span> <span class="n">Subject</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">DataSource</span><span class="p">,</span> <span class="n">Subject</span>

        <span class="c1"># We only consider a given classification once from a given</span>
        <span class="c1"># data source.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">classification</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_classifications</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_classifications</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>

        <span class="c1"># Make sure the Subject is ready to be used in calculations.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">checked</span><span class="p">:</span> <span class="c1"># or self.debug</span>
            <span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">assign_to_genre</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">classification</span><span class="o">.</span><span class="n">comes_from_license_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">direct_from_license_source</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">describes_format</span><span class="p">:</span>
                <span class="c1"># TODO: This is a bit of a hack.</span>
                <span class="c1">#</span>
                <span class="c1"># Only accept a classification having to do with</span>
                <span class="c1"># format (e.g. &#39;comic books&#39;) if that classification</span>
                <span class="c1"># comes direct from the license source. Otherwise it&#39;s</span>
                <span class="c1"># really easy for a graphic adaptation of a novel to</span>
                <span class="c1"># get mixed up with the original novel, whereupon the</span>
                <span class="c1"># original book is classified as a graphic novel.</span>
                <span class="k">return</span>

        <span class="c1"># Put the weight of the classification behind various</span>
        <span class="c1"># considerations.</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">scaled_weight</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">subject</span>
        <span class="n">from_staff</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span>

        <span class="c1"># if classification is genre or NONE from staff, ignore all non-staff genres</span>
        <span class="n">is_genre</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">genre</span> <span class="o">!=</span> <span class="kc">None</span>
        <span class="n">is_none</span> <span class="o">=</span> <span class="p">(</span><span class="n">from_staff</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">SimplifiedGenreClassifier</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_genre</span> <span class="ow">or</span> <span class="n">is_none</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_staff</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_genres</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">from_staff</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_genres</span><span class="p">:</span>
                <span class="c1"># first encounter with staff genre, so throw out existing genre weights</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_genres</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">genre_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_genre</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weigh_genre</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">genre</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

        <span class="c1"># if staff classification is fiction or nonfiction, ignore all other fictions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_fiction_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">from_staff</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_FICTION_STATUS</span><span class="p">:</span>
                <span class="c1"># encountering first staff fiction status,</span>
                <span class="c1"># so throw out existing fiction weights</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_fiction_status</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="n">subject</span><span class="o">.</span><span class="n">fiction</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="c1"># if staff classification is about audience, ignore all other audience classifications</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_audience</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">from_staff</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">FREEFORM_AUDIENCE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_audience</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">subject</span><span class="o">.</span><span class="n">audience</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">classification</span><span class="o">.</span><span class="n">generic_juvenile_audience</span><span class="p">:</span>
                    <span class="c1"># We have a generic &#39;juvenile&#39; classification. The</span>
                    <span class="c1"># audience might say &#39;Children&#39; or it might say &#39;Young</span>
                    <span class="c1"># Adult&#39; but we don&#39;t actually know which it is.</span>
                    <span class="c1">#</span>
                    <span class="c1"># We&#39;re going to split the difference, with a slight</span>
                    <span class="c1"># preference for YA, to bias against showing</span>
                    <span class="c1"># age-inappropriate material to children. To</span>
                    <span class="c1"># counterbalance the fact that we&#39;re splitting up the</span>
                    <span class="c1"># weight this way, we&#39;re also going to treat this</span>
                    <span class="c1"># classification as evidence _against_ an &#39;adult&#39;</span>
                    <span class="c1"># classification.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">audience</span> <span class="ow">in</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_ADULT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">audience</span> <span class="o">!=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span><span class="p">:</span>
                            <span class="c1"># &#39;All Ages&#39; is considered an adult audience,</span>
                            <span class="c1"># but a generic &#39;juvenile&#39; classification</span>
                            <span class="c1"># is not evidence against it.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">audience</span><span class="p">]</span> <span class="o">-=</span> <span class="n">weight</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">subject</span><span class="o">.</span><span class="n">audience</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_target_age</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">from_staff</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">AGE_RANGE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_target_age</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="p">:</span>
                <span class="c1"># Figure out how reliable this classification really is as</span>
                <span class="c1"># an indicator of a target age.</span>
                <span class="n">scaled_weight</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">weight_as_indicator_of_target_age</span>
                <span class="n">target_min</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">lower</span>
                <span class="n">target_max</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper</span>
                <span class="k">if</span> <span class="n">target_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">lower_inc</span><span class="p">:</span>
                        <span class="n">target_min</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="p">[</span><span class="n">target_min</span><span class="p">]</span> <span class="o">+=</span> <span class="n">scaled_weight</span>
                <span class="k">if</span> <span class="n">target_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper_inc</span><span class="p">:</span>
                        <span class="n">target_max</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="p">[</span><span class="n">target_max</span><span class="p">]</span> <span class="o">+=</span> <span class="n">scaled_weight</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_audience</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_target_age</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;Overdrive&#39;</span> <span class="ow">and</span> <span class="n">subject</span><span class="o">.</span><span class="n">audience</span><span class="o">==</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">lower</span> <span class="ow">or</span> <span class="n">subject</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper</span>
                <span class="p">):</span>
                    <span class="c1"># This is a juvenile classification like &quot;Picture</span>
                    <span class="c1"># Books&quot; which implies a target age.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_with_target_age</span> <span class="o">=</span> <span class="n">classification</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This is a generic juvenile classification like</span>
                    <span class="c1"># &quot;Juvenile Fiction&quot;.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_generic</span> <span class="o">=</span> <span class="n">classification</span></div>

<div class="viewcode-block" id="WorkClassifier.weigh_metadata"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.weigh_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">weigh_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the weights according to the given Work&#39;s metadata.</span>

<span class="sd">        Use work metadata to simulate classifications.</span>

<span class="sd">        This is basic stuff, like: Harlequin tends to publish</span>
<span class="sd">        romances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Star Trek:&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span>
            <span class="ow">or</span> <span class="s1">&#39;Star Wars:&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span>
            <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Jedi&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">imprint</span><span class="o">==</span><span class="s1">&#39;Del Rey&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weigh_genre</span><span class="p">(</span><span class="n">Media_Tie_in_SF</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">publisher</span>
        <span class="n">imprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">imprint</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonfiction_imprints</span>
            <span class="ow">or</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonfiction_publishers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">imprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_imprints</span>
              <span class="ow">or</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_publishers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">imprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_imprints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weigh_genre</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre_imprints</span><span class="p">[</span><span class="n">imprint</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_publishers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weigh_genre</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre_publishers</span><span class="p">[</span><span class="n">publisher</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_imprints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">audience_imprints</span><span class="p">[</span><span class="n">imprint</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">publisher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_adult_publishers</span>
              <span class="ow">or</span> <span class="n">imprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_adult_imprints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">audience</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span>
                             <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">audience</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">100</span></div>

<div class="viewcode-block" id="WorkClassifier.prepare_to_classify"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.prepare_to_classify">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_to_classify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called the first time classify() is called. Does miscellaneous</span>
<span class="sd">        one-time prep work that requires all data to be in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weigh_metadata</span><span class="p">()</span>

        <span class="n">explicitly_indicated_audiences</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span>
            <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">)</span>
        <span class="n">audiences_from_license_source</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">audience</span>
             <span class="k">for</span> <span class="n">classification</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_from_license_source</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_from_license_source</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_staff_audience</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">audience</span> <span class="ow">in</span> <span class="n">explicitly_indicated_audiences</span>
                <span class="k">for</span> <span class="n">audience</span> <span class="ow">in</span> <span class="n">audiences_from_license_source</span>
        <span class="p">)):</span>
            <span class="c1"># If this was erotica, or a book for children or young</span>
            <span class="c1"># adults, the distributor would have given some indication</span>
            <span class="c1"># of that fact. In the absense of any such indication, we</span>
            <span class="c1"># can assume very strongly that this is a regular old book</span>
            <span class="c1"># for adults.</span>
            <span class="c1">#</span>
            <span class="c1"># 3M is terrible at distinguishing between childrens&#39;</span>
            <span class="c1"># books and YA books, but books for adults can be</span>
            <span class="c1"># distinguished by their _lack_ of childrens/YA</span>
            <span class="c1"># classifications.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">500</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_generic</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_with_target_age</span><span class="p">):</span>
            <span class="c1"># This book is classified under &#39;Juvenile Fiction&#39; but not</span>
            <span class="c1"># under &#39;Picture Books&#39; or &#39;Beginning Readers&#39;. The</span>
            <span class="c1"># implicit target age here is 9-12 (the portion of</span>
            <span class="c1"># Overdrive&#39;s &#39;juvenile&#39; age range not covered by &#39;Picture</span>
            <span class="c1"># Books&#39; or &#39;Beginning Readers&#39;.</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overdrive_juvenile_generic</span><span class="o">.</span><span class="n">weight_as_indicator_of_target_age</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WorkClassifier.classify"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.classify">[docs]</a>    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_audience</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Do a little prep work.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_to_classify</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifications</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> (via </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>

        <span class="c1"># Actually figure out the classifications</span>
        <span class="n">fiction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction</span><span class="p">(</span><span class="n">default_fiction</span><span class="o">=</span><span class="n">default_fiction</span><span class="p">)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="p">(</span><span class="n">fiction</span><span class="p">)</span>
        <span class="n">audience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="n">default_audience</span><span class="o">=</span><span class="n">default_audience</span><span class="p">)</span>
        <span class="n">target_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age</span><span class="p">(</span><span class="n">audience</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fiction weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Genre weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_weights</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Audience weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">genres</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span> <span class="n">audience</span><span class="p">,</span> <span class="n">target_age</span></div>

<div class="viewcode-block" id="WorkClassifier.fiction"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.fiction">[docs]</a>    <span class="k">def</span> <span class="nf">fiction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is it more likely this is a fiction or nonfiction book?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">:</span>
            <span class="c1"># We have absolutely no idea one way or the other, and it</span>
            <span class="c1"># would be irresponsible to guess.</span>
            <span class="k">return</span> <span class="n">default_fiction</span>
        <span class="n">is_fiction</span> <span class="o">=</span> <span class="n">default_fiction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="kc">False</span><span class="p">]:</span>
            <span class="n">is_fiction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiction_weights</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">is_fiction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">is_fiction</span></div>

<div class="viewcode-block" id="WorkClassifier.audience"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.audience">[docs]</a>    <span class="k">def</span> <span class="nf">audience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">default_audience</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What&#39;s the most likely audience for this book?</span>
<span class="sd">        :param default_audience: To avoid embarassing situations we will</span>
<span class="sd">        classify works as being intended for adults absent convincing</span>
<span class="sd">        evidence to the contrary. In some situations (like the metadata</span>
<span class="sd">        wrangler), it&#39;s better to state that we have no information, so</span>
<span class="sd">        default_audience can be set to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If we determined that Erotica was a significant enough</span>
        <span class="c1"># component of the classification to count as a genre, the</span>
        <span class="c1"># audience will always be &#39;Adults Only&#39;, even if the audience</span>
        <span class="c1"># weights would indicate something else.</span>
        <span class="k">if</span> <span class="n">Erotica</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_weights</span><span class="p">:</span>
            <span class="c1"># We have absolutely no idea, and it would be</span>
            <span class="c1"># irresponsible to guess.</span>
            <span class="k">return</span> <span class="n">default_audience</span>

        <span class="n">children_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ya_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">adult_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">adults_only_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">all_ages_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">research_weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_RESEARCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">total_adult_weight</span> <span class="o">=</span> <span class="n">adult_weight</span> <span class="o">+</span> <span class="n">adults_only_weight</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">audience</span> <span class="o">=</span> <span class="n">default_audience</span>

        <span class="c1"># A book will be classified as a young adult or childrens&#39;</span>
        <span class="c1"># book when the weight of that audience is more than twice the</span>
        <span class="c1"># combined weight of the &#39;adult&#39; and &#39;adults only&#39; audiences.</span>
        <span class="c1"># If that combined weight is zero, then any amount of evidence</span>
        <span class="c1"># is sufficient.</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">total_adult_weight</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="c1"># If both the &#39;children&#39; weight and the &#39;YA&#39; weight pass the</span>
        <span class="c1"># threshold, we go with the one that weighs more.</span>
        <span class="c1"># If the &#39;children&#39; weight passes the threshold on its own</span>
        <span class="c1"># we go with &#39;children&#39;.</span>
        <span class="n">total_juvenile_weight</span> <span class="o">=</span> <span class="n">children_weight</span> <span class="o">+</span> <span class="n">ya_weight</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">research_weight</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">total_adult_weight</span> <span class="o">+</span> <span class="n">all_ages_weight</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">research_weight</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">total_juvenile_weight</span> <span class="o">+</span> <span class="n">all_ages_weight</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">research_weight</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_RESEARCH</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">all_ages_weight</span> <span class="o">&gt;</span> <span class="n">total_adult_weight</span> <span class="ow">and</span>
            <span class="n">all_ages_weight</span> <span class="o">&gt;</span> <span class="n">total_juvenile_weight</span><span class="p">):</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span>
        <span class="k">elif</span> <span class="n">children_weight</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">children_weight</span> <span class="o">&gt;</span> <span class="n">ya_weight</span><span class="p">:</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span>
        <span class="k">elif</span> <span class="n">ya_weight</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">elif</span> <span class="n">total_juvenile_weight</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Neither weight passes the threshold on its own, but</span>
            <span class="c1"># combined they do pass the threshold. Go with</span>
            <span class="c1"># &#39;Young Adult&#39; to be safe.</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="k">elif</span> <span class="n">total_adult_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>

        <span class="c1"># If the &#39;adults only&#39; weight is more than 1/4 of the total adult</span>
        <span class="c1"># weight, classify as &#39;adults only&#39; to be safe.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: This has not been calibrated.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">audience</span><span class="o">==</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>
            <span class="ow">and</span> <span class="n">adults_only_weight</span> <span class="o">&gt;</span> <span class="n">total_adult_weight</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span>

        <span class="k">return</span> <span class="n">audience</span></div>

<div class="viewcode-block" id="WorkClassifier.top_tier_values"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.top_tier_values">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">top_tier_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a Counter mapping values to their frequency of occurance,</span>
<span class="sd">        return all values that are as common as the most common value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_frequency</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">top_tier</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">age</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">top_frequency</span><span class="p">:</span>
                <span class="n">top_frequency</span> <span class="o">=</span> <span class="n">freq</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">!=</span> <span class="n">top_frequency</span><span class="p">:</span>
                <span class="c1"># We&#39;ve run out of candidates</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This candidate occurs with the maximum frequency.</span>
                <span class="n">top_tier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_tier</span></div>

<div class="viewcode-block" id="WorkClassifier.target_age"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.target_age">[docs]</a>    <span class="k">def</span> <span class="nf">target_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audience</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive a target age from the gathered data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">audience</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span>
        <span class="p">):</span>
            <span class="c1"># This is not a children&#39;s or YA book. Assertions about</span>
            <span class="c1"># target age are irrelevant and the default value rules.</span>
            <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">default_target_age_for_audience</span><span class="p">(</span><span class="n">audience</span><span class="p">)</span>

        <span class="c1"># Only consider the most reliable classifications.</span>

        <span class="c1"># Try to reach consensus on the lower and upper bounds of the</span>
        <span class="c1"># age range.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Possible target age minima:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Possible target age maxima:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="n">target_age_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_age_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="p">:</span>
            <span class="c1"># Find the youngest age in the top tier of values.</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_tier_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_age_lower_weights</span><span class="p">)</span>
            <span class="n">target_age_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="p">:</span>
            <span class="c1"># Find the oldest age in the top tier of values.</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_tier_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_age_upper_weights</span><span class="p">)</span>
            <span class="n">target_age_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_age_min</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target_age_max</span><span class="p">:</span>
            <span class="c1"># We found no opinions about target age. Use the default.</span>
            <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">default_target_age_for_audience</span><span class="p">(</span><span class="n">audience</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target_age_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_age_min</span> <span class="o">=</span> <span class="n">target_age_max</span>

        <span class="k">if</span> <span class="n">target_age_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_age_max</span> <span class="o">=</span> <span class="n">target_age_min</span>

        <span class="c1"># Err on the side of setting the minimum age too high.</span>
        <span class="k">if</span> <span class="n">target_age_min</span> <span class="o">&gt;</span> <span class="n">target_age_max</span><span class="p">:</span>
            <span class="n">target_age_max</span> <span class="o">=</span> <span class="n">target_age_min</span>
        <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">range_tuple</span><span class="p">(</span><span class="n">target_age_min</span><span class="p">,</span> <span class="n">target_age_max</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkClassifier.genres"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.genres">[docs]</a>    <span class="k">def</span> <span class="nf">genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fiction</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Consolidate genres and apply a low-pass filter.&quot;&quot;&quot;</span>
        <span class="c1"># Remove any genres whose fiction status is inconsistent with the</span>
        <span class="c1"># (independently determined) fiction status of the book.</span>
        <span class="c1">#</span>
        <span class="c1"># It doesn&#39;t matter if a book is classified as &#39;science</span>
        <span class="c1"># fiction&#39; 100 times; if we know it&#39;s nonfiction, it can&#39;t be</span>
        <span class="c1"># science fiction. (It&#39;s probably a history of science fiction</span>
        <span class="c1"># or something.)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre_weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">genres</span><span class="p">:</span>
            <span class="c1"># We have absolutely no idea, and it would be</span>
            <span class="c1"># irresponsible to guess.</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># If we have a fiction determination, that lets us eliminate</span>
            <span class="c1"># possible genres that conflict with that determination.</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: If we don&#39;t have a fiction determination, the</span>
            <span class="c1"># genres we end up with may help us make one.</span>
            <span class="k">if</span> <span class="n">fiction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">genre</span><span class="o">.</span><span class="n">default_fiction</span> <span class="o">!=</span> <span class="n">fiction</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">genres</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span>

        <span class="c1"># Consolidate parent genres into their heaviest subgenre.</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolidate_genre_weights</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="c1"># Strip out the stragglers.</span>
        <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">affinity</span> <span class="o">=</span> <span class="n">score</span> <span class="o">/</span> <span class="n">total_weight</span>
            <span class="k">if</span> <span class="n">affinity</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="n">total_weight</span> <span class="o">-=</span> <span class="n">score</span>
                <span class="k">del</span> <span class="n">genres</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">genres</span></div>

<div class="viewcode-block" id="WorkClassifier.weigh_genre"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.weigh_genre">[docs]</a>    <span class="k">def</span> <span class="nf">weigh_genre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genre_data</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A helper method that ensure we always use database Genre</span>
<span class="sd">        objects, not GenreData objects, when weighting genres.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..model</span> <span class="kn">import</span> <span class="n">Genre</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">Genre</span>
        <span class="n">genre</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">genre_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genre_weights</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span></div>

<div class="viewcode-block" id="WorkClassifier.consolidate_genre_weights"><a class="viewcode-back" href="../../core.classifier.html#core.classifier.WorkClassifier.consolidate_genre_weights">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">consolidate_genre_weights</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">subgenre_swallows_parent_at</span><span class="o">=</span><span class="mf">0.03</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If a genre and its subgenres both show up, examine the subgenre</span>
<span class="sd">        with the highest weight. If its weight exceeds a certain</span>
<span class="sd">        proportion of the weight of the parent genre, assign the</span>
<span class="sd">        parent&#39;s weight to the subgenre and remove the parent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;Before consolidation:&quot;)</span>
        <span class="c1">#for genre, weight in weights.items():</span>
        <span class="c1">#    print(&quot;&quot;, genre, weight)</span>

        <span class="c1"># Convert Genre objects to GenreData.</span>
        <span class="n">consolidated</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">genre</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">GenreData</span><span class="p">):</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">genres</span><span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">consolidated</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="n">heaviest_child</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">genre</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">consolidated</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">genre</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">consolidated</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">heaviest_child</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="n">heaviest_child</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">heaviest_child</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        <span class="c1">#print(&quot;Heaviest child:&quot;)</span>
        <span class="c1">#for parent, (genre, weight) in heaviest_child.items():</span>
        <span class="c1">#    print(&quot;&quot;, parent, genre, weight)</span>
        <span class="n">made_it</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">made_it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">heaviest_child</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">genre</span><span class="p">:</span> <span class="n">genre</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">parent_weight</span> <span class="o">=</span> <span class="n">consolidated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">subgenre_swallows_parent_at</span> <span class="o">*</span> <span class="n">parent_weight</span><span class="p">):</span>
                    <span class="n">consolidated</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parent_weight</span>
                    <span class="k">del</span> <span class="n">consolidated</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">heaviest_child</span><span class="p">:</span>
                            <span class="n">heaviest_child</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">consolidated</span><span class="p">[</span><span class="n">child</span><span class="p">])</span>
                            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                        <span class="c1"># We changed the dict, so we need to restart</span>
                        <span class="c1"># the iteration.</span>
                        <span class="k">break</span>
            <span class="c1"># We made it all the way through the dict without changing it.</span>
            <span class="n">made_it</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#print(&quot;Final heaviest child:&quot;)</span>
        <span class="c1">#for parent, (genre, weight) in heaviest_child.items():</span>
        <span class="c1">#    print(&quot;&quot;, parent, genre, weight)</span>
        <span class="c1">#print(&quot;After consolidation:&quot;)</span>
        <span class="c1">#for genre, weight in consolidated.items():</span>
        <span class="c1">#    print(&quot;&quot;, genre, weight)</span>
        <span class="k">return</span> <span class="n">consolidated</span></div></div>

<span class="c1"># Make a dictionary of classification schemes to classifiers.</span>

<span class="n">Classifier</span><span class="o">.</span><span class="n">classifiers</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">FREEFORM_AUDIENCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">FreeformAudienceClassifier</span>
<span class="n">Classifier</span><span class="o">.</span><span class="n">classifiers</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AXIS_360_AUDIENCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgeOrGradeClassifier</span>

<span class="c1"># Finally, import classifiers described in submodules.</span>
<span class="kn">from</span> <span class="nn">.age</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GradeLevelClassifier</span><span class="p">,</span>
    <span class="n">InterestLevelClassifier</span><span class="p">,</span>
    <span class="n">AgeClassifier</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.bisac</span> <span class="kn">import</span> <span class="n">BISACClassifier</span>
<span class="kn">from</span> <span class="nn">.rbdigital</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RBDigitalAudienceClassifier</span><span class="p">,</span>
    <span class="n">RBDigitalSubjectClassifier</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.ddc</span> <span class="kn">import</span> <span class="n">DeweyDecimalClassifier</span>
<span class="kn">from</span> <span class="nn">.lcc</span> <span class="kn">import</span> <span class="n">LCCClassifier</span>
<span class="kn">from</span> <span class="nn">.gutenberg</span> <span class="kn">import</span> <span class="n">GutenbergBookshelfClassifier</span>
<span class="kn">from</span> <span class="nn">.bic</span> <span class="kn">import</span> <span class="n">BICClassifier</span>
<span class="kn">from</span> <span class="nn">.simplified</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SimplifiedFictionClassifier</span><span class="p">,</span>
    <span class="n">SimplifiedGenreClassifier</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.overdrive</span> <span class="kn">import</span> <span class="n">OverdriveClassifier</span>
<span class="kn">from</span> <span class="nn">.keyword</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">KeywordBasedClassifier</span><span class="p">,</span>
    <span class="n">LCSHClassifier</span><span class="p">,</span>
    <span class="n">FASTClassifier</span><span class="p">,</span>
    <span class="n">TAGClassifier</span><span class="p">,</span>
    <span class="n">Eg</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>