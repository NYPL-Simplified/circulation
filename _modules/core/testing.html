
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>core.testing &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.testing</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">datetime</span><span class="p">,</span>
    <span class="n">timedelta</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">set_trace</span><span class="p">,</span>
    <span class="n">eq_</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># TODO PYTHON3</span>
<span class="c1"># from psycopg2.errors import UndefinedTable</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="k">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">ProgrammingError</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="n">Configuration</span>

<span class="kn">from</span> <span class="nn">lane</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Lane</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">model.constants</span> <span class="k">import</span> <span class="n">MediaTypes</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Base</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">SessionManager</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">create</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CoverageRecord</span><span class="p">,</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Complaint</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DelegatedPatronIdentifier</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Genre</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">IntegrationClient</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">License</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">Resource</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">WorkCoverageRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">model.configuration</span> <span class="k">import</span> <span class="n">ExternalIntegrationLink</span>

<span class="kn">from</span> <span class="nn">classifier</span> <span class="k">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">coverage</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BibliographicCoverageProvider</span><span class="p">,</span>
    <span class="n">CollectionCoverageProvider</span><span class="p">,</span>
    <span class="n">IdentifierCoverageProvider</span><span class="p">,</span>
    <span class="n">CoverageFailure</span><span class="p">,</span>
    <span class="n">WorkCoverageProvider</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">external_search</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">MockExternalSearchIndex</span><span class="p">,</span>
    <span class="n">ExternalSearchIndex</span><span class="p">,</span>
    <span class="n">SearchIndexCoverageProvider</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">log</span> <span class="k">import</span> <span class="n">LogConfiguration</span>
<span class="kn">import</span> <span class="nn">external_search</span>
<span class="kn">import</span> <span class="nn">mock</span>
<span class="kn">import</span> <span class="nn">inspect</span>


<div class="viewcode-block" id="package_setup"><a class="viewcode-back" href="../../core.html#core.testing.package_setup">[docs]</a><span class="k">def</span> <span class="nf">package_setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Make sure the application starts in a pristine state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This will make sure we always connect to the test database.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>

    <span class="c1"># This will make sure we always connect to the test database.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>

    <span class="c1"># Ensure that the log configuration starts in a known state.</span>
    <span class="n">LogConfiguration</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Drop any existing schema. It will be recreated when</span>
    <span class="c1"># SessionManager.initialize() runs.</span>
    <span class="c1">#</span>
    <span class="c1"># Base.metadata.drop_all(connection) doesn&#39;t work here, so we</span>
    <span class="c1"># approximate by dropping every item individually.</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">SessionManager</span><span class="o">.</span><span class="n">engine</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">sorted_tables</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;mv_&#39;</span><span class="p">):</span>
            <span class="c1"># TODO: This can be removed soon. We don&#39;t create</span>
            <span class="c1"># materialized views anymore, but they&#39;ll still hang</span>
            <span class="c1"># around for a while in test databases and need to be</span>
            <span class="c1"># deleted.</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="s2">&quot;drop materialized view </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ProgrammingError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO PYTHON3</span>
            <span class="c1"># if isinstance(e.orig, UndefinedTable):</span>
            <span class="k">if</span> <span class="s1">&#39;does not exist&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                <span class="c1"># This is the first time running these tests</span>
                <span class="c1"># on this server, and the tables don&#39;t exist yet.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="package_teardown"><a class="viewcode-back" href="../../core.html#core.testing.package_teardown">[docs]</a><span class="k">def</span> <span class="nf">package_teardown</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;TESTING&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseTest"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest">[docs]</a><span class="k">class</span> <span class="nc">DatabaseTest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DatabaseTest.get_database_connection"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.get_database_connection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_database_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">database_url</span><span class="p">()</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">SessionManager</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">connection</span></div>

<div class="viewcode-block" id="DatabaseTest.setup_class"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.setup_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Initialize a temporary data directory.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_database_connection</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">old_data_dir</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">data_directory</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">Configuration</span><span class="o">.</span><span class="n">DATA_DIRECTORY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span>

        <span class="c1"># Avoid CannotLoadConfiguration errors related to CDN integrations.</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">Configuration</span><span class="o">.</span><span class="n">INTEGRATIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">INTEGRATIONS</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">Configuration</span><span class="o">.</span><span class="n">INTEGRATIONS</span><span class="p">][</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">CDN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="DatabaseTest.teardown_class"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.teardown_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">teardown_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Destroy the database connection and engine.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing temporary directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cowardly refusing to remove &#39;temporary&#39; directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_data_dir</span><span class="p">)</span>

        <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">Configuration</span><span class="o">.</span><span class="n">DATA_DIRECTORY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">old_data_dir</span></div>

<div class="viewcode-block" id="DatabaseTest.setup"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_search</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Create a new connection to the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

        <span class="c1"># Start with a high number so it won&#39;t interfere with tests that search for an age or grade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">2000</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isbns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;9780674368279&quot;</span><span class="p">,</span> <span class="s2">&quot;0636920028468&quot;</span><span class="p">,</span> <span class="s2">&quot;9781936460236&quot;</span><span class="p">,</span> <span class="s2">&quot;9780316075978&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">mock_search</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">external_search</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.ExternalSearchIndex&quot;</span><span class="p">,</span> <span class="n">MockExternalSearchIndex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_mock</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_mock</span> <span class="o">=</span> <span class="kc">None</span></div>

        <span class="c1"># TODO:  keeping this for now, but need to fix it bc it hits _isbn,</span>
        <span class="c1"># which pops an isbn off the list and messes tests up.  so exclude</span>
        <span class="c1"># _ functions from participating.</span>
        <span class="c1"># also attempt to stop nosetest showing docstrings instead of function names.</span>
        <span class="c1">#for name, obj in inspect.getmembers(self):</span>
        <span class="c1">#    if inspect.isfunction(obj) and obj.__name__.startswith(&#39;test_&#39;):</span>
        <span class="c1">#        obj.__doc__ = None</span>


<div class="viewcode-block" id="DatabaseTest.teardown"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Close the session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Roll back all database changes that happened during this</span>
        <span class="c1"># test, whether in the session that was just closed or some</span>
        <span class="c1"># other session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="c1"># Remove any database objects cached in the model classes but</span>
        <span class="c1"># associated with the now-rolled-back session.</span>
        <span class="n">Collection</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">DataSource</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">Genre</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>
        <span class="n">Library</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>

        <span class="c1"># Also roll back any record of those changes in the</span>
        <span class="c1"># Configuration instance.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">Configuration</span><span class="o">.</span><span class="n">SITE_CONFIGURATION_LAST_UPDATE</span><span class="p">,</span>
                <span class="n">Configuration</span><span class="o">.</span><span class="n">LAST_CHECKED_FOR_SITE_CONFIGURATION_UPDATE</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">:</span>
                <span class="k">del</span><span class="p">(</span><span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_mock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_mock</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="DatabaseTest.time_eq"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.time_eq">[docs]</a>    <span class="k">def</span> <span class="nf">time_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="s2">&quot;Assert that two times are *approximately* the same -- within 2 seconds.&quot;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">a</span><span class="o">-</span><span class="n">b</span>
        <span class="n">total_seconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Delta was too large: </span><span class="si">%.2f</span><span class="s2"> seconds.&quot;</span> <span class="o">%</span> <span class="n">total_seconds</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseTest.shortDescription"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.shortDescription">[docs]</a>    <span class="k">def</span> <span class="nf">shortDescription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Stop nosetests displaying docstrings instead of class names when verbosity level &gt;= 2.</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_isbn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isbns</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;http://foo.com/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>

    <span class="k">def</span> <span class="nf">_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">external_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">library</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_library</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Patron</span><span class="p">,</span> <span class="n">external_identifier</span><span class="o">=</span><span class="n">external_identifier</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="n">library</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_contributor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">sort_name</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Contributor</span><span class="p">,</span> <span class="n">sort_name</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="o">=</span><span class="n">Identifier</span><span class="o">.</span><span class="n">GUTENBERG_ID</span><span class="p">,</span> <span class="n">foreign_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">foreign_id</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">foreign_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="k">return</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="nb">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">,</span>
                 <span class="n">identifier_type</span><span class="o">=</span><span class="n">Identifier</span><span class="o">.</span><span class="n">GUTENBERG_ID</span><span class="p">,</span>
                 <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;eng&quot;</span><span class="p">,</span> <span class="n">authors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publicationDate</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">identifier_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="nb">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span>
        <span class="k">if</span> <span class="n">authors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">authors</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">authors</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">primary_author_name</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">contributor</span> <span class="o">=</span> <span class="n">wr</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">primary_author_name</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span><span class="p">)</span>
            <span class="c1"># add_contributor assumes authors[0] is a sort_name,</span>
            <span class="c1"># but it may be a display name. If so, set that field as well.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">and</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">primary_author_name</span><span class="p">:</span>
                <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">primary_author_name</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">primary_author_name</span>

        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">author</span><span class="p">),</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publicationDate</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">publicationDate</span>

        <span class="k">if</span> <span class="n">with_license_pool</span> <span class="ow">or</span> <span class="n">with_open_access_download</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_licensepool</span><span class="p">(</span>
                <span class="n">wr</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="n">data_source_name</span><span class="p">,</span>
                <span class="n">with_open_access_download</span><span class="o">=</span><span class="n">with_open_access_download</span><span class="p">,</span>
                <span class="n">collection</span><span class="o">=</span><span class="n">collection</span>
            <span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">wr</span><span class="p">,</span> <span class="n">pool</span>
        <span class="k">return</span> <span class="n">wr</span>

    <span class="k">def</span> <span class="nf">_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">audience</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">presentation_edition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Work.</span>

<span class="sd">        For performance reasons, this method does not generate OPDS</span>
<span class="sd">        entries or calculate a presentation edition for the new</span>
<span class="sd">        Work. Tests that rely on this information being present</span>
<span class="sd">        should call _slow_work() instead, which takes more care to present</span>
<span class="sd">        the sort of Work that would be created in a real environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">with_open_access_download</span><span class="p">:</span>
            <span class="n">with_license_pool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="ow">or</span> <span class="s2">&quot;eng&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span><span class="p">)</span>
        <span class="n">audience</span> <span class="o">=</span> <span class="n">audience</span> <span class="ow">or</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULT</span>
        <span class="k">if</span> <span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_source_name</span><span class="p">:</span>
            <span class="c1"># TODO: This is necessary because Gutenberg&#39;s childrens books</span>
            <span class="c1"># get filtered out at the moment.</span>
            <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">OVERDRIVE</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">data_source_name</span><span class="p">:</span>
            <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span>
        <span class="k">if</span> <span class="n">fiction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fiction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_edition</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">presentation_edition</span><span class="p">:</span>
            <span class="n">new_edition</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">presentation_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                <span class="n">authors</span><span class="o">=</span><span class="n">authors</span><span class="p">,</span>
                <span class="n">with_license_pool</span><span class="o">=</span><span class="n">with_license_pool</span><span class="p">,</span>
                <span class="n">with_open_access_download</span><span class="o">=</span><span class="n">with_open_access_download</span><span class="p">,</span>
                <span class="n">data_source_name</span><span class="o">=</span><span class="n">data_source_name</span><span class="p">,</span>
                <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
                <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">with_license_pool</span><span class="p">:</span>
                <span class="n">presentation_edition</span><span class="p">,</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">presentation_edition</span>
                <span class="k">if</span> <span class="n">with_open_access_download</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pools</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pools</span> <span class="o">=</span> <span class="n">presentation_edition</span><span class="o">.</span><span class="n">license_pools</span>
        <span class="n">work</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Work</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">audience</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span>
                <span class="n">fiction</span><span class="o">=</span><span class="n">fiction</span><span class="p">,</span>
                <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">genre</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">Genre</span><span class="p">):</span>
                <span class="n">genre</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">genre</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">genres</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span><span class="p">]</span>
        <span class="n">work</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">(</span><span class="n">presentation_edition</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pools</span><span class="p">:</span>
            <span class="c1"># make sure the pool&#39;s presentation_edition is set,</span>
            <span class="c1"># bc loan tests assume that.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">set_presentation_edition</span><span class="p">()</span>

            <span class="c1"># This is probably going to be used in an OPDS feed, so</span>
            <span class="c1"># fake that the work is presentation ready.</span>
            <span class="n">work</span><span class="o">.</span><span class="n">presentation_ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">work</span><span class="o">.</span><span class="n">calculate_opds_entries</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>

    <span class="k">def</span> <span class="nf">_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inherit_parent_restrictions</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">library</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_library</span>
        <span class="n">lane</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">fiction</span><span class="o">=</span><span class="n">fiction</span><span class="p">,</span>
            <span class="n">inherit_parent_restrictions</span><span class="o">=</span><span class="n">inherit_parent_restrictions</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">sublanes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">genres</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">genres</span> <span class="o">=</span> <span class="p">[</span><span class="n">genres</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">genre</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">genre</span><span class="p">)</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">languages</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">languages</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">languages</span><span class="p">]</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">languages</span>
        <span class="k">return</span> <span class="n">lane</span>

    <span class="k">def</span> <span class="nf">_slow_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a work that closely resembles one that might be found in the</span>
<span class="sd">        wild.</span>

<span class="sd">        This is significantly slower than _work() but more reliable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_work</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation_edition</span><span class="p">()</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_opds_entries</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">work</span>

    <span class="k">def</span> <span class="nf">_add_generic_delivery_mechanism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Give a license pool a generic non-open-access delivery mechanism.&quot;&quot;&quot;</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
        <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span>
        <span class="k">return</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">,</span>
            <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coverage_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">coverage_source</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="n">record</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CoverageRecord</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">coverage_source</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                <span class="n">exception</span><span class="o">=</span><span class="n">exception</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">_work_coverage_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">status</span><span class="o">=</span><span class="n">CoverageRecord</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">):</span>
        <span class="n">record</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">WorkCoverageRecord</span><span class="p">,</span>
            <span class="n">work</span><span class="o">=</span><span class="n">work</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">_licensepool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">open_access</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">,</span>
                     <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">set_edition_as_presentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edition</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span><span class="n">data_source_name</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_collection</span>
        <span class="n">pool</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">open_access</span><span class="o">=</span><span class="n">open_access</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">availability_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">set_edition_as_presentation</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span> <span class="o">=</span> <span class="n">edition</span>

        <span class="k">if</span> <span class="n">with_open_access_download</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://foo.com/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
            <span class="n">link</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">media_type</span>
            <span class="p">)</span>

            <span class="c1"># Add a DeliveryMechanism for this download</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">set_delivery_mechanism</span><span class="p">(</span>
                <span class="n">media_type</span><span class="p">,</span>
                <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">,</span>
                <span class="n">RightsStatus</span><span class="o">.</span><span class="n">GENERIC_OPEN_ACCESS</span><span class="p">,</span>
                <span class="n">link</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">representation</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_representation</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="s2">&quot;Dummy content&quot;</span><span class="p">,</span> <span class="n">mirrored</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">link</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">representation</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Add a DeliveryMechanism for this licensepool</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">set_delivery_mechanism</span><span class="p">(</span>
                <span class="n">MediaTypes</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span>
                <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span><span class="p">,</span>
                <span class="n">RightsStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span>
                <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">pool</span>

    <span class="k">def</span> <span class="nf">_license</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkout_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remaining_checkouts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concurrent_checkouts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">checkout_url</span> <span class="o">=</span> <span class="n">checkout_url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">status_url</span> <span class="o">=</span> <span class="n">status_url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">license</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">License</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
            <span class="n">checkout_url</span><span class="o">=</span><span class="n">checkout_url</span><span class="p">,</span>
            <span class="n">status_url</span><span class="o">=</span><span class="n">status_url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
            <span class="n">remaining_checkouts</span><span class="o">=</span><span class="n">remaining_checkouts</span><span class="p">,</span>
            <span class="n">concurrent_checkouts</span><span class="o">=</span><span class="n">concurrent_checkouts</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">license</span>

    <span class="k">def</span> <span class="nf">_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">mirrored</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&quot;http://foo.com/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="nb">repr</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Representation</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="nb">repr</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
        <span class="k">if</span> <span class="n">media_type</span> <span class="ow">and</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
            <span class="nb">repr</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="nb">repr</span><span class="o">.</span><span class="n">fetched_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mirrored</span><span class="p">:</span>
                <span class="nb">repr</span><span class="o">.</span><span class="n">mirror_url</span> <span class="o">=</span> <span class="s2">&quot;http://foo.com/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
                <span class="nb">repr</span><span class="o">.</span><span class="n">mirrored_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">,</span> <span class="n">is_new</span>

    <span class="k">def</span> <span class="nf">_customlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foreign_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">NYT</span><span class="p">,</span> <span class="n">num_entries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">entries_exist_as_works</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="n">foreign_identifier</span> <span class="o">=</span> <span class="n">foreign_identifier</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">customlist</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">created</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">updated</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_str</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">foreign_identifier</span><span class="o">=</span><span class="n">foreign_identifier</span>
        <span class="p">)</span>

        <span class="n">editions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_entries</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entries_exist_as_works</span><span class="p">:</span>
                <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_work</span><span class="p">(</span><span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Item </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="o">=</span><span class="s2">&quot;Permanent work ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
            <span class="n">customlist</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span>
                <span class="n">edition</span><span class="p">,</span> <span class="s2">&quot;Annotation </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">first_appearance</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
            <span class="n">editions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edition</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">customlist</span><span class="p">,</span> <span class="n">editions</span>

    <span class="k">def</span> <span class="nf">_complaint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">complaint</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Complaint</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">license_pool</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">,</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">detail</span><span class="p">,</span>
            <span class="n">resolved</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">complaint</span>

    <span class="k">def</span> <span class="nf">_credential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">patron</span> <span class="o">=</span> <span class="n">patron</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patron</span><span class="p">()</span>
        <span class="n">credential</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Credential</span><span class="o">.</span><span class="n">persistent_token_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">patron</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">credential</span>

    <span class="k">def</span> <span class="nf">_external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">libraries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="n">integration</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">libraries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">libraries</span><span class="p">]</span>

            <span class="c1"># Try to find an existing integration for one of the given</span>
            <span class="c1"># libraries.</span>
            <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                <span class="n">integration</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">libraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">integration</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
                <span class="c1"># Otherwise, create a brand new integration specifically</span>
                <span class="c1"># for the library.</span>
                <span class="n">integration</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="p">(</span>
                    <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">integration</span><span class="o">.</span><span class="n">libraries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">libraries</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">set_setting</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">integration</span>
    
    <span class="k">def</span> <span class="nf">_external_integration_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">other_integration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;covers_mirror&quot;</span><span class="p">):</span>

        <span class="n">integration</span> <span class="o">=</span> <span class="n">integration</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_integration</span><span class="p">(</span><span class="s2">&quot;some protocol&quot;</span><span class="p">)</span>
        <span class="n">other_integration</span> <span class="o">=</span> <span class="n">other_integration</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_integration</span><span class="p">(</span><span class="s2">&quot;some other protocol&quot;</span><span class="p">)</span>

        <span class="n">library_id</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">library</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">external_integration_link</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="p">,</span>
            <span class="n">library_id</span><span class="o">=</span><span class="n">library_id</span><span class="p">,</span>
            <span class="n">external_integration_id</span><span class="o">=</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">other_integration_id</span><span class="o">=</span><span class="n">other_integration</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">purpose</span><span class="o">=</span><span class="n">purpose</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">external_integration_link</span>

    <span class="k">def</span> <span class="nf">_delegated_patron_identifier</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">library_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patron_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">DelegatedPatronIdentifier</span><span class="o">.</span><span class="n">ADOBE_ACCOUNT_ID</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a sample DelegatedPatronIdentifier&quot;&quot;&quot;</span>
        <span class="n">library_uri</span> <span class="o">=</span> <span class="n">library_uri</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>
        <span class="n">patron_identifier</span> <span class="o">=</span> <span class="n">patron_identifier</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
            <span class="n">make_id</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
            <span class="k">def</span> <span class="nf">make_id</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">identifier</span>
        <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">DelegatedPatronIdentifier</span><span class="o">.</span><span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">library_uri</span><span class="p">,</span> <span class="n">patron_identifier</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span>
            <span class="n">make_id</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">patron</span>

    <span class="k">def</span> <span class="nf">_sample_ecosystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates an ecosystem of some sample work, pool, edition, and author</span>
<span class="sd">        objects that all know each other.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make some authors</span>
        <span class="p">[</span><span class="n">bob</span><span class="p">],</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;Bitshifter, Bob&quot;</span><span class="p">)</span>
        <span class="n">bob</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">bob</span><span class="o">.</span><span class="n">default_names</span><span class="p">()</span>
        <span class="p">[</span><span class="n">alice</span><span class="p">],</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;Adder, Alice&quot;</span><span class="p">)</span>
        <span class="n">alice</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span> <span class="n">alice</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="n">default_names</span><span class="p">()</span>

        <span class="n">edition_std_ebooks</span><span class="p">,</span> <span class="n">pool_std_ebooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span><span class="n">DataSource</span><span class="o">.</span><span class="n">STANDARD_EBOOKS</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">URI</span><span class="p">,</span>
            <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">authors</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">edition_std_ebooks</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The Standard Ebooks Title&quot;</span>
        <span class="n">edition_std_ebooks</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The Standard Ebooks Subtitle&quot;</span>
        <span class="n">edition_std_ebooks</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">)</span>

        <span class="n">edition_git</span><span class="p">,</span> <span class="n">pool_git</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span><span class="n">DataSource</span><span class="o">.</span><span class="n">PROJECT_GITENBERG</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">GUTENBERG_ID</span><span class="p">,</span>
            <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">authors</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">edition_git</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The GItenberg Title&quot;</span>
        <span class="n">edition_git</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The GItenberg Subtitle&quot;</span>
        <span class="n">edition_git</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">)</span>
        <span class="n">edition_git</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">)</span>

        <span class="n">edition_gut</span><span class="p">,</span> <span class="n">pool_gut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edition</span><span class="p">(</span><span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">GUTENBERG_ID</span><span class="p">,</span>
            <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_open_access_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">authors</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">edition_gut</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The GUtenberg Title&quot;</span>
        <span class="n">edition_gut</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;The GUtenberg Subtitle&quot;</span>
        <span class="n">edition_gut</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_work</span><span class="p">(</span><span class="n">presentation_edition</span><span class="o">=</span><span class="n">edition_git</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool_gut</span><span class="p">,</span> <span class="n">pool_std_ebooks</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">pool_std_ebooks</span><span class="p">,</span> <span class="n">pool_git</span><span class="p">,</span> <span class="n">pool_gut</span><span class="p">,</span>
            <span class="n">edition_std_ebooks</span><span class="p">,</span> <span class="n">edition_git</span><span class="p">,</span> <span class="n">edition_gut</span><span class="p">,</span> <span class="n">alice</span><span class="p">,</span> <span class="n">bob</span><span class="p">)</span>


<div class="viewcode-block" id="DatabaseTest.print_database_instance"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.print_database_instance">[docs]</a>    <span class="k">def</span> <span class="nf">print_database_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the class method that examines the current state of the database model</span>
<span class="sd">        (whether it&#39;s been committed or not).</span>

<span class="sd">        NOTE: If you set_trace, and hit &quot;continue&quot;, you&#39;ll start seeing console output right</span>
<span class="sd">        away, without waiting for the whole test to run and the standard output section to display.</span>
<span class="sd">        You can also use nosetest --nocapture.</span>

<span class="sd">        I use::</span>

<span class="sd">            def test_name(self):</span>
<span class="sd">                [code...]</span>
<span class="sd">                set_trace()</span>
<span class="sd">                self.print_database_instance()  # TODO: remove before prod</span>
<span class="sd">                [code...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;TESTING&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="c1"># we are on production, abort, abort!</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Forgot to remove call to testing.py:DatabaseTest.print_database_instance() before pushing to production.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">print_database_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="DatabaseTest.print_database_class"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.print_database_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_database_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints to the console the entire contents of the database, as the unit test sees it.</span>
<span class="sd">        Exists because unit tests don&#39;t persist db information, they create a memory</span>
<span class="sd">        representation of the db state, and then roll the unit test-derived transactions back.</span>
<span class="sd">        So we cannot see what&#39;s going on by going into postgres and running selects.</span>
<span class="sd">        This is the in-test alternative to going into postgres.</span>

<span class="sd">        Can be called from model and metadata classes as well as tests.</span>

<span class="sd">        NOTE: The purpose of this method is for debugging.</span>
<span class="sd">        Be careful of leaving it in code and potentially outputting</span>
<span class="sd">        vast tracts of data into your output stream on production.</span>

<span class="sd">        Call like this::</span>

<span class="sd">            set_trace()</span>
<span class="sd">            from testing import (l=</span>
<span class="sd">                DatabaseTest,</span>
<span class="sd">            )</span>
<span class="sd">            _db = Session.object_session(self)</span>
<span class="sd">            DatabaseTest.print_database_class(_db)</span>

<span class="sd">            TODO: remove before prod</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;TESTING&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="c1"># we are on production, abort, abort!</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Forgot to remove call to testing.py:DatabaseTest.print_database_class() before pushing to production.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">works</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">license_pools</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">editions</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">data_sources</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DataSource</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">representations</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Representation</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">works</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO Work found&quot;</span>
        <span class="k">for</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">works</span><span class="p">):</span>
            <span class="c1"># pipe character at end of line helps see whitespace issues</span>
            <span class="nb">print</span> <span class="s2">&quot;Work[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wCount</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    NO Work.LicensePool found&quot;</span>
            <span class="k">for</span> <span class="n">lpCount</span><span class="p">,</span> <span class="n">license_pool</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    Work.LicensePool[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lpCount</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">)</span>

            <span class="nb">print</span> <span class="s2">&quot;    Work.presentation_edition=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>

        <span class="nb">print</span> <span class="s2">&quot;__________________________________________________________________</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">identifiers</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO Identifier found&quot;</span>
        <span class="k">for</span> <span class="n">iCount</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">identifiers</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;Identifier[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iCount</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;    Identifier.licensed_through=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span>

        <span class="nb">print</span> <span class="s2">&quot;__________________________________________________________________</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">license_pools</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO LicensePool found&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">license_pool</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">license_pools</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;LicensePool[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.work_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">work_id</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.data_source_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">data_source_id</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.identifier_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier_id</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.presentation_edition_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">presentation_edition_id</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.superceded=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">superceded</span>
            <span class="nb">print</span> <span class="s2">&quot;    LicensePool.suppressed=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">suppressed</span>

        <span class="nb">print</span> <span class="s2">&quot;__________________________________________________________________</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">editions</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO Edition found&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">edition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">editions</span><span class="p">):</span>
            <span class="c1"># pipe character at end of line helps see whitespace issues</span>
            <span class="nb">print</span> <span class="s2">&quot;Edition[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">edition</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;    Edition.primary_identifier_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier_id</span>
            <span class="nb">print</span> <span class="s2">&quot;    Edition.permanent_work_id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">permanent_work_id</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    Edition.data_source.id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">id</span>
                <span class="nb">print</span> <span class="s2">&quot;    Edition.data_source.name=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;    No Edition.data_source.&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">license_pool</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    Edition.license_pool.id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;    No Edition.license_pool.&quot;</span>

            <span class="nb">print</span> <span class="s2">&quot;    Edition.title=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span>
            <span class="nb">print</span> <span class="s2">&quot;    Edition.author=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">author</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">edition</span><span class="o">.</span><span class="n">author_contributors</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    NO Edition.author_contributor found&quot;</span>
            <span class="k">for</span> <span class="n">acCount</span><span class="p">,</span> <span class="n">author_contributor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">author_contributors</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;    Edition.author_contributor[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acCount</span><span class="p">,</span> <span class="n">author_contributor</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;__________________________________________________________________</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">data_sources</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO DataSource found&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">data_source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_sources</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;DataSource[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">id</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.name=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.offers_licenses=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">offers_licenses</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.editions=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">editions</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.license_pools=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">license_pools</span>
            <span class="nb">print</span> <span class="s2">&quot;    DataSource.links=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="o">.</span><span class="n">links</span>

        <span class="nb">print</span> <span class="s2">&quot;__________________________________________________________________</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">representations</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;NO Representation found&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">representation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">representations</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;Representation[</span><span class="si">%s</span><span class="s2">]=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">representation</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;    Representation.id=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">id</span>
            <span class="nb">print</span> <span class="s2">&quot;    Representation.url=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">url</span>
            <span class="nb">print</span> <span class="s2">&quot;    Representation.mirror_url=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_url</span>
            <span class="nb">print</span> <span class="s2">&quot;    Representation.fetch_exception=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">fetch_exception</span>
            <span class="nb">print</span> <span class="s2">&quot;    Representation.mirror_exception=</span><span class="si">%s</span><span class="s2">|&quot;</span> <span class="o">%</span> <span class="n">representation</span><span class="o">.</span><span class="n">mirror_exception</span>

        <span class="k">return</span></div>


    <span class="k">def</span> <span class="nf">_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">short_name</span> <span class="o">=</span> <span class="n">short_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">library</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">library</span>

    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span><span class="p">,</span>
                    <span class="n">external_account_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span> <span class="o">=</span> <span class="n">external_account_id</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_GOAL</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

        <span class="k">if</span> <span class="n">data_source_name</span><span class="p">:</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source_name</span>
        <span class="k">return</span> <span class="n">collection</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_default_library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A Library that will only be created once throughout a given test.</span>

<span class="sd">        By default, the `_default_collection` will be associated with</span>
<span class="sd">        the default library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_default__library&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default__library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default__library</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_default_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A Collection that will only be created once throughout</span>
<span class="sd">        a given test.</span>

<span class="sd">        For most tests there&#39;s no need to create a different</span>
<span class="sd">        Collection for every LicensePool. Using</span>
<span class="sd">        self._default_collection instead of calling self.collection()</span>
<span class="sd">        saves time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_default__collection&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default__collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_library</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default__collection</span>

<div class="viewcode-block" id="DatabaseTest.make_default_library"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.make_default_library">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_default_library</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that the default library exists in the given database.</span>

<span class="sd">        This can be called by code intended for use in testing but not actually</span>
<span class="sd">        within a DatabaseTest subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">uuid</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
            <span class="p">),</span> <span class="n">short_name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span>
        <span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Default Collection&quot;</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_GOAL</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">library</span></div>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Faketown Public Library&quot;</span><span class="p">):</span>
        <span class="n">source</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_integration_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shared_secret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">shared_secret</span> <span class="ow">or</span> <span class="sa">u</span><span class="s2">&quot;secret&quot;</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">IntegrationClient</span><span class="p">,</span> <span class="n">shared_secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Subject</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Classification</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="DatabaseTest.sample_cover_path"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.sample_cover_path">[docs]</a>    <span class="k">def</span> <span class="nf">sample_cover_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path to the sample cover with the given filename.&quot;&quot;&quot;</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">resource_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;covers&quot;</span><span class="p">)</span>
        <span class="n">sample_cover_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resource_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample_cover_path</span></div>

<div class="viewcode-block" id="DatabaseTest.sample_cover_representation"><a class="viewcode-back" href="../../core.html#core.testing.DatabaseTest.sample_cover_representation">[docs]</a>    <span class="k">def</span> <span class="nf">sample_cover_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A Representation of the sample cover with the given filename.&quot;&quot;&quot;</span>
        <span class="n">sample_cover_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_cover_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_representation</span><span class="p">(</span>
            <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">sample_cover_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="SearchClientForTesting"><a class="viewcode-back" href="../../core.html#core.testing.SearchClientForTesting">[docs]</a><span class="k">class</span> <span class="nc">SearchClientForTesting</span><span class="p">(</span><span class="n">ExternalSearchIndex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When creating an index, limit it to a single shard and disable</span>
<span class="sd">    replicas.</span>

<span class="sd">    This makes search results more predictable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchClientForTesting.setup_index"><a class="viewcode-back" href="../../core.html#core.testing.SearchClientForTesting.setup_index">[docs]</a>    <span class="k">def</span> <span class="nf">setup_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SearchClientForTesting</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup_index</span><span class="p">(</span>
            <span class="n">new_index</span><span class="p">,</span> <span class="n">number_of_shards</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_replicas</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="ExternalSearchTest"><a class="viewcode-back" href="../../core.html#core.testing.ExternalSearchTest">[docs]</a><span class="k">class</span> <span class="nc">ExternalSearchTest</span><span class="p">(</span><span class="n">DatabaseTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    These tests require elasticsearch to be running locally. If it&#39;s not, or there&#39;s</span>
<span class="sd">    an error creating the index, the tests will pass without doing anything.</span>

<span class="sd">    Tests for elasticsearch are useful for ensuring that we haven&#39;t accidentally broken</span>
<span class="sd">    a type of search by changing analyzers or queries, but search needs to be tested manually</span>
<span class="sd">    to ensure that it works well overall, with a realistic index.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExternalSearchTest.setup"><a class="viewcode-back" href="../../core.html#core.testing.ExternalSearchTest.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExternalSearchTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">mock_search</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Track the indexes created so they can be torn down at the</span>
        <span class="c1"># end of the test.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_integration</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">ELASTICSEARCH</span><span class="p">,</span>
            <span class="n">goal</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">SEARCH_GOAL</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;http://localhost:9200&#39;</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="p">{</span>
                <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">WORKS_INDEX_PREFIX_KEY</span> <span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;test_index&#39;</span><span class="p">,</span>
                <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">TEST_SEARCH_TERM_KEY</span> <span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;test_search_term&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="n">SearchClientForTesting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to set up elasticsearch index, search tests will be skipped.&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ExternalSearchTest.setup_index"><a class="viewcode-back" href="../../core.html#core.testing.ExternalSearchTest.setup_index">[docs]</a>    <span class="k">def</span> <span class="nf">setup_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_index</span><span class="p">):</span>
        <span class="s2">&quot;Create an index and register it to be destroyed during teardown.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">setup_index</span><span class="p">(</span><span class="n">new_index</span><span class="o">=</span><span class="n">new_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExternalSearchTest.teardown"><a class="viewcode-back" href="../../core.html#core.testing.ExternalSearchTest.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">:</span>
            <span class="c1"># Delete the works_index, which is almost always created.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">works_index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">works_index</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="mi">404</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1"># Delete any other indexes created over the course of the test.</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="mi">404</span><span class="p">])</span>
            <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExternalSearchTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExternalSearchTest.default_work"><a class="viewcode-back" href="../../core.html#core.testing.ExternalSearchTest.default_work">[docs]</a>    <span class="k">def</span> <span class="nf">default_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience method to create a work with a license pool</span>
<span class="sd">        in the default collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_work</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">with_license_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_presentation_ready</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">work</span></div></div>


<div class="viewcode-block" id="EndToEndSearchTest"><a class="viewcode-back" href="../../core.html#core.testing.EndToEndSearchTest">[docs]</a><span class="k">class</span> <span class="nc">EndToEndSearchTest</span><span class="p">(</span><span class="n">ExternalSearchTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclasses of this class set up real works in a real</span>
<span class="sd">    search index and run searches against it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EndToEndSearchTest.setup"><a class="viewcode-back" href="../../core.html#core.testing.EndToEndSearchTest.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EndToEndSearchTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

        <span class="c1"># Create some works.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">:</span>
            <span class="c1"># No search index is configured -- nothing to do.</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_works</span><span class="p">()</span>

        <span class="c1"># Add all the works created in the setup to the search index.</span>
        <span class="n">SearchIndexCoverageProvider</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">search_index_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run_once_and_update_timestamp</span><span class="p">()</span>

        <span class="c1"># Sleep to give the index time to catch up.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="EndToEndSearchTest.populate_works"><a class="viewcode-back" href="../../core.html#core.testing.EndToEndSearchTest.populate_works">[docs]</a>    <span class="k">def</span> <span class="nf">populate_works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_assert_works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">should_be_ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Verify that two lists of works are the same.&quot;</span>

        <span class="c1"># Get the titles of the works that were actually returned, to</span>
        <span class="c1"># make comparisons easier.</span>
        <span class="n">actual_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">actual_titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
            <span class="n">actual_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">actual_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">expect_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">expect_titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">expect</span><span class="p">:</span>
            <span class="n">expect_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">expect_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># We compare IDs rather than objects because the Works may</span>
        <span class="c1"># actually be WorkSearchResults.</span>
        <span class="n">expect_compare</span> <span class="o">=</span> <span class="n">expect_ids</span>
        <span class="n">actual_compare</span> <span class="o">=</span> <span class="n">actual_ids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_be_ordered</span><span class="p">:</span>
            <span class="n">expect_compare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expect_compare</span><span class="p">)</span>
            <span class="n">actual_compare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">actual_compare</span><span class="p">)</span>

        <span class="n">eq_</span><span class="p">(</span>
            <span class="n">expect_compare</span><span class="p">,</span> <span class="n">actual_compare</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> did not find </span><span class="si">%d</span><span class="s2"> works</span><span class="se">\n</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">).</span><span class="se">\n</span><span class="s2">Instead found </span><span class="si">%d</span><span class="se">\n</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">description</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">expect</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">expect_ids</span><span class="p">)),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expect_titles</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">actual_ids</span><span class="p">)),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actual_titles</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expect_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">query_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to call query_works() and verify that it</span>
<span class="sd">        returns certain work IDs.</span>

<span class="sd">        :param ordered: If this is True (the default), then the</span>
<span class="sd">        assertion will only succeed if the search results come in in</span>
<span class="sd">        the exact order specified in `works`. If this is False, then</span>
<span class="sd">        those exact results must come up, but their order is not</span>
<span class="sd">        what&#39;s being tested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expect</span><span class="p">,</span> <span class="n">Work</span><span class="p">):</span>
            <span class="n">expect</span> <span class="o">=</span> <span class="p">[</span><span class="n">expect</span><span class="p">]</span>
        <span class="n">should_be_ordered</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ordered&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">query_works</span><span class="p">(</span>
            <span class="n">query_string</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">query_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_hits</span><span class="p">(</span>
            <span class="n">expect</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">query_args</span><span class="p">,</span> <span class="n">should_be_ordered</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expect_results_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function to call query_works_multi() and verify that it</span>
<span class="sd">        returns certain work IDs.</span>

<span class="sd">        :param expect: A list of lists of Works that you expect</span>
<span class="sd">            to get back from each query in `queries`.</span>
<span class="sd">        :param queries: A list of (query string, Filter, Pagination)</span>
<span class="sd">            3-tuples.</span>
<span class="sd">        :param ordered: If this is True (the default), then the</span>
<span class="sd">           assertion will only succeed if the search results come in</span>
<span class="sd">           in the exact order specified in `works`. If this is False,</span>
<span class="sd">           then those exact results must come up, but their order is</span>
<span class="sd">           not what&#39;s being tested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">should_be_ordered</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ordered&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">query_works_multi</span><span class="p">(</span>
                <span class="n">queries</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expect_one_query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expect</span><span class="p">):</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="n">resultset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">query_args</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compare_hits</span><span class="p">(</span>
                <span class="n">expect_one_query</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">query_args</span><span class="p">,</span>
                <span class="n">should_be_ordered</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">query_args</span><span class="p">,</span>
                      <span class="n">should_be_ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">query_string</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span> <span class="o">=</span> <span class="n">query_args</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">work_id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">results</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">should_be_ordered</span><span class="p">:</span>
            <span class="c1"># Put the Work objects in the same order as the IDs returned</span>
            <span class="c1"># in `results`.</span>
            <span class="n">works_by_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
                <span class="n">works_by_id</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">works_by_id</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">works_by_id</span>
            <span class="p">]</span>

        <span class="n">query_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">pagination</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_works</span><span class="p">(</span><span class="n">query_args</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">should_be_ordered</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_string</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pagination</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># Only a filter was provided -- this means if we pass the</span>
            <span class="c1"># filter into count_works() we&#39;ll get all the results we</span>
            <span class="c1"># got from query_works(). Take the opportunity to verify</span>
            <span class="c1"># that count_works() gives the right answer.</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">count_works</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
            <span class="n">eq_</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expect</span><span class="p">))</span></div>


<div class="viewcode-block" id="MockCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.MockCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">MockCoverageProvider</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin class for mock CoverageProviders that defines common constants.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Generic mock CoverageProvider&quot;</span>

    <span class="c1"># Whenever a CoverageRecord is created, the data_source of that</span>
    <span class="c1"># record will be Project Gutenberg.</span>
    <span class="n">DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">GUTENBERG</span>

    <span class="c1"># For testing purposes, this CoverageProvider will try to cover</span>
    <span class="c1"># every identifier in the database.</span>
    <span class="n">INPUT_IDENTIFIER_TYPES</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># This CoverageProvider can work with any Collection that supports</span>
    <span class="c1"># the OPDS import protocol (e.g. DatabaseTest._default_collection).</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span></div>


<div class="viewcode-block" id="InstrumentedCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.InstrumentedCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">InstrumentedCoverageProvider</span><span class="p">(</span><span class="n">MockCoverageProvider</span><span class="p">,</span>
                                   <span class="n">IdentifierCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CoverageProvider that keeps track of every item it tried</span>
<span class="sd">    to cover.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="InstrumentedCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.InstrumentedCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span></div></div>


<div class="viewcode-block" id="InstrumentedWorkCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.InstrumentedWorkCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">InstrumentedWorkCoverageProvider</span><span class="p">(</span><span class="n">MockCoverageProvider</span><span class="p">,</span>
                                       <span class="n">WorkCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkCoverageProvider that keeps track of every item it tried</span>
<span class="sd">    to cover.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InstrumentedWorkCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="InstrumentedWorkCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.InstrumentedWorkCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span></div></div>

<div class="viewcode-block" id="AlwaysSuccessfulCollectionCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulCollectionCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">AlwaysSuccessfulCollectionCoverageProvider</span><span class="p">(</span><span class="n">MockCoverageProvider</span><span class="p">,</span>
                                                 <span class="n">CollectionCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CollectionCoverageProvider that does nothing and always succeeds.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Always successful (collection)&quot;</span>

<div class="viewcode-block" id="AlwaysSuccessfulCollectionCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulCollectionCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span></div></div>


<div class="viewcode-block" id="AlwaysSuccessfulCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">AlwaysSuccessfulCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CoverageProvider that does nothing and always succeeds.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Always successful&quot;</span></div>

<div class="viewcode-block" id="AlwaysSuccessfulWorkCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulWorkCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">AlwaysSuccessfulWorkCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedWorkCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkCoverageProvider that does nothing and always succeeds.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Always successful (works)&quot;</span></div>


<div class="viewcode-block" id="AlwaysSuccessfulBibliographicCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulBibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">AlwaysSuccessfulBibliographicCoverageProvider</span><span class="p">(</span>
        <span class="n">MockCoverageProvider</span><span class="p">,</span> <span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A BibliographicCoverageProvider that does nothing and is always</span>
<span class="sd">    successful.</span>

<span class="sd">    Note that this only works if you&#39;ve put a working Edition and</span>
<span class="sd">    LicensePool in place beforehand. Otherwise the process will fail</span>
<span class="sd">    during handle_success().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Always successful (bibliographic)&quot;</span>

<div class="viewcode-block" id="AlwaysSuccessfulBibliographicCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.AlwaysSuccessfulBibliographicCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">identifier</span></div></div>


<div class="viewcode-block" id="NeverSuccessfulCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">NeverSuccessfulCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CoverageProvider that does nothing and always fails.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Never successful&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NeverSuccessfulCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transient</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transient&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

<div class="viewcode-block" id="NeverSuccessfulCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;What did you expect?&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transient</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="NeverSuccessfulWorkCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulWorkCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">NeverSuccessfulWorkCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedWorkCoverageProvider</span><span class="p">):</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Never successful (works)&quot;</span>
<div class="viewcode-block" id="NeverSuccessfulWorkCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulWorkCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;What did you expect?&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="NeverSuccessfulBibliographicCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulBibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">NeverSuccessfulBibliographicCoverageProvider</span><span class="p">(</span>
        <span class="n">MockCoverageProvider</span><span class="p">,</span> <span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulates a BibliographicCoverageProvider that&#39;s never successful.&quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Never successful (bibliographic)&quot;</span>

<div class="viewcode-block" id="NeverSuccessfulBibliographicCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.NeverSuccessfulBibliographicCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;Bitter failure&quot;</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BrokenCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.BrokenCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">BrokenCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">):</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Broken&quot;</span>
<div class="viewcode-block" id="BrokenCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.BrokenCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I&#39;m too broken to even return a CoverageFailure.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BrokenBibliographicCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.BrokenBibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">BrokenBibliographicCoverageProvider</span><span class="p">(</span>
        <span class="n">BrokenCoverageProvider</span><span class="p">,</span> <span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Broken (bibliographic)&quot;</span></div>


<div class="viewcode-block" id="TransientFailureCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.TransientFailureCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">TransientFailureCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">):</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Never successful (transient)&quot;</span>
<div class="viewcode-block" id="TransientFailureCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.TransientFailureCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;Oops!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TransientFailureWorkCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.TransientFailureWorkCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">TransientFailureWorkCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedWorkCoverageProvider</span><span class="p">):</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Never successful (transient, works)&quot;</span>
<div class="viewcode-block" id="TransientFailureWorkCoverageProvider.process_item"><a class="viewcode-back" href="../../core.html#core.testing.TransientFailureWorkCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;Oops!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TaskIgnoringCoverageProvider"><a class="viewcode-back" href="../../core.html#core.testing.TaskIgnoringCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">TaskIgnoringCoverageProvider</span><span class="p">(</span><span class="n">InstrumentedCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A coverage provider that ignores all work given to it.&quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;I ignore all work.&quot;</span>
<div class="viewcode-block" id="TaskIgnoringCoverageProvider.process_batch"><a class="viewcode-back" href="../../core.html#core.testing.TaskIgnoringCoverageProvider.process_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>

<div class="viewcode-block" id="DummyCanonicalizeLookupResponse"><a class="viewcode-back" href="../../core.html#core.testing.DummyCanonicalizeLookupResponse">[docs]</a><span class="k">class</span> <span class="nc">DummyCanonicalizeLookupResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="DummyCanonicalizeLookupResponse.success"><a class="viewcode-back" href="../../core.html#core.testing.DummyCanonicalizeLookupResponse.success">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">r</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span> <span class="p">}</span>
        <span class="n">r</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="DummyCanonicalizeLookupResponse.failure"><a class="viewcode-back" href="../../core.html#core.testing.DummyCanonicalizeLookupResponse.failure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">failure</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="k">return</span> <span class="n">r</span></div></div>

<div class="viewcode-block" id="DummyMetadataClient"><a class="viewcode-back" href="../../core.html#core.testing.DummyMetadataClient">[docs]</a><span class="k">class</span> <span class="nc">DummyMetadataClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="DummyMetadataClient.canonicalize_author_name"><a class="viewcode-back" href="../../core.html#core.testing.DummyMetadataClient.canonicalize_author_name">[docs]</a>    <span class="k">def</span> <span class="nf">canonicalize_author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_identifier</span><span class="p">,</span> <span class="n">display_author</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">display_author</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DummyCanonicalizeLookupResponse</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="n">display_author</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DummyCanonicalizeLookupResponse</span><span class="o">.</span><span class="n">failure</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="DummyHTTPClient"><a class="viewcode-back" href="../../core.html#core.testing.DummyHTTPClient">[docs]</a><span class="k">class</span> <span class="nc">DummyHTTPClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DummyHTTPClient.queue_response"><a class="viewcode-back" href="../../core.html#core.testing.DummyHTTPClient.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
                       <span class="n">other_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queue a response of the type produced by</span>
<span class="sd">        Representation.simple_http_get.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">media_type</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">media_type</span>
        <span class="k">if</span> <span class="n">other_headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">response_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span></div>

<div class="viewcode-block" id="DummyHTTPClient.queue_requests_response"><a class="viewcode-back" href="../../core.html#core.testing.DummyHTTPClient.queue_requests_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_requests_response</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
            <span class="n">other_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queue a response of the type produced by HTTP.get_with_timeout.&quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">other_headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">media_type</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">media_type</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">response_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="DummyHTTPClient.do_get"><a class="viewcode-back" href="../../core.html#core.testing.DummyHTTPClient.do_get">[docs]</a>    <span class="k">def</span> <span class="nf">do_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="DummyHTTPClient.do_post"><a class="viewcode-back" href="../../core.html#core.testing.DummyHTTPClient.do_post">[docs]</a>    <span class="k">def</span> <span class="nf">do_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">wargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MockRequestsResponse"><a class="viewcode-back" href="../../core.html#core.testing.MockRequestsResponse">[docs]</a><span class="k">class</span> <span class="nc">MockRequestsResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A mock object that simulates an HTTP response from the</span>
<span class="sd">    `requests` library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&quot;http://url/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>

<div class="viewcode-block" id="MockRequestsResponse.json"><a class="viewcode-back" href="../../core.html#core.testing.MockRequestsResponse.json">[docs]</a>    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="c1"># The queued content might be a JSON string or it might</span>
        <span class="c1"># just be the object you&#39;d get from loading a JSON string.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>

<div class="viewcode-block" id="MockRequestsResponse.raise_for_status"><a class="viewcode-back" href="../../core.html#core.testing.MockRequestsResponse.raise_for_status">[docs]</a>    <span class="k">def</span> <span class="nf">raise_for_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Null implementation of raise_for_status, a method</span>
<span class="sd">        implemented by real requests Response objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>