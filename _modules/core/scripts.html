
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.scripts &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for core.scripts</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">exists</span><span class="p">,</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">text</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">ProgrammingError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoResultFound</span><span class="p">,</span>
    <span class="n">MultipleResultsFound</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">CannotLoadConfiguration</span>
<span class="kn">from</span> <span class="nn">.coverage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionCoverageProviderJob</span><span class="p">,</span>
    <span class="n">CoverageProviderProgress</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.external_search</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExternalSearchIndex</span><span class="p">,</span>
    <span class="n">Filter</span><span class="p">,</span>
    <span class="n">SearchIndexCoverageProvider</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.lane</span> <span class="kn">import</span> <span class="n">Lane</span>
<span class="kn">from</span> <span class="nn">.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">MetaToModelUtility</span><span class="p">,</span>
    <span class="n">TimestampData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.mirror</span> <span class="kn">import</span> <span class="n">MirrorUploader</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">production_session</span><span class="p">,</span>
    <span class="n">BaseCoverageRecord</span><span class="p">,</span>
    <span class="n">CachedFeed</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Complaint</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">SessionManager</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Timestamp</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">WorkCoverageRecord</span><span class="p">,</span>
    <span class="n">site_configuration_has_changed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">.monitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionMonitor</span><span class="p">,</span>
    <span class="n">ReaperMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.opds_import</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSImportMonitor</span><span class="p">,</span>
    <span class="n">OPDSImporter</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">fast_query_count</span>
<span class="kn">from</span> <span class="nn">.util.personal_names</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">contributor_name_match_ratio</span><span class="p">,</span>
    <span class="n">display_name_to_sort_name</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.worker_pools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatabasePool</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">strptime_utc</span><span class="p">,</span> <span class="n">to_utc</span><span class="p">,</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="Script"><a class="viewcode-back" href="../../core.html#core.scripts.Script">[docs]</a><span class="k">class</span> <span class="nc">Script</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_session&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">production_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">script_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or guess the name of the script.</span>

<span class="sd">        This is either the .name of the Script object or the name of</span>
<span class="sd">        the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_log&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">data_directory</span><span class="p">()</span>

<div class="viewcode-block" id="Script.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.Script.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Script.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.Script.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Script.parse_time"><a class="viewcode-back" href="../../core.html#core.scripts.Script.parse_time">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">time_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to pass the given string as a time.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_string</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hours</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; %H:%M:%S&#39;</span><span class="p">):</span>
                <span class="n">full_format</span> <span class="o">=</span> <span class="nb">format</span> <span class="o">+</span> <span class="n">hours</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed</span> <span class="o">=</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="n">full_format</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">parsed</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not parse time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">time_string</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Basic constructor.</span>

<span class="sd">        :_db: A database session to be used instead of</span>
<span class="sd">        creating a new one. Useful in tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">_db</span>

<div class="viewcode-block" id="Script.run"><a class="viewcode-back" href="../../core.html#core.scripts.Script.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_configuration</span><span class="p">()</span>
        <span class="n">DataSource</span><span class="o">.</span><span class="n">well_known_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_run</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp_data</span><span class="p">,</span> <span class="n">TimestampData</span><span class="p">):</span>
                <span class="c1"># Ignore any nonstandard return value from do_run().</span>
                <span class="n">timestamp_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamp</span><span class="p">(</span><span class="n">timestamp_data</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Fatal exception while running script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span>
            <span class="n">stack_trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamp</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">stack_trace</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Script.load_configuration"><a class="viewcode-back" href="../../core.html#core.scripts.Script.load_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">cdns_loaded_from_database</span><span class="p">():</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span></div>

<div class="viewcode-block" id="Script.update_timestamp"><a class="viewcode-back" href="../../core.html#core.scripts.Script.update_timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">update_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp_data</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;By default scripts have no timestamp of their own.</span>

<span class="sd">        Most scripts either work through Monitors or CoverageProviders,</span>
<span class="sd">        which have their own logic for creating timestamps, or they</span>
<span class="sd">        are designed to be run interactively from the command-line, so</span>
<span class="sd">        facts about when they last ran are not relevant.</span>

<span class="sd">        :param start_time: The time the script started running.</span>
<span class="sd">        :param exception: A stack trace for the exception, if any,</span>
<span class="sd">           that stopped the script from running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="TimestampScript"><a class="viewcode-back" href="../../core.html#core.scripts.TimestampScript">[docs]</a><span class="k">class</span> <span class="nc">TimestampScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script that automatically records a timestamp whenever it runs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_collection</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TimestampScript.update_timestamp"><a class="viewcode-back" href="../../core.html#core.scripts.TimestampScript.update_timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">update_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the appropriate Timestamp for this script.</span>

<span class="sd">        :param timestamp_data: A TimestampData representing what the script</span>
<span class="sd">          itself thinks its timestamp should look like. Data will be filled in</span>
<span class="sd">          where it is missing, but it will not be modified if present.</span>

<span class="sd">        :param start: The time at which this script believes the</span>
<span class="sd">          service started running. The script itself may change this</span>
<span class="sd">          value for its own purposes.</span>

<span class="sd">        :param exception: The exception with which this script</span>
<span class="sd">          believes the service stopped running. The script itself may</span>
<span class="sd">          change this value for its own purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timestamp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp_data</span> <span class="o">=</span> <span class="n">TimestampData</span><span class="p">()</span>
        <span class="n">timestamp_data</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="p">,</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">SCRIPT_TYPE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_collection</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exception</span>
        <span class="p">)</span>
        <span class="n">timestamp_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="RunMonitorScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunMonitorScript">[docs]</a><span class="k">class</span> <span class="nc">RunMonitorScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunMonitorScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="n">CollectionMonitor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor</span> <span class="o">=</span> <span class="n">monitor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">monitor</span><span class="p">):</span>
                <span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">service_name</span>

<div class="viewcode-block" id="RunMonitorScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.RunMonitorScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Running a CollectionMonitor by delegating to RunCollectionMonitorScript. &quot;</span>
                <span class="s2">&quot;It would be better if you used RunCollectionMonitorScript directly.&quot;</span>
            <span class="p">)</span>
            <span class="n">RunCollectionMonitorScript</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_monitor_kwargs</span>
            <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RunMultipleMonitorsScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunMultipleMonitorsScript">[docs]</a><span class="k">class</span> <span class="nc">RunMultipleMonitorsScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a number of monitors in sequence.</span>

<span class="sd">    Currently the Monitors are run one at a time. It should be</span>
<span class="sd">    possible to take a command-line argument that runs all the</span>
<span class="sd">    Monitors in batches, each in its own thread. Unfortunately, it&#39;s</span>
<span class="sd">    tough to know in a given situation that this won&#39;t overload the</span>
<span class="sd">    system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param kwargs: Keyword arguments to pass into the `monitors` method</span>
<span class="sd">            when building the Monitor objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunMultipleMonitorsScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="RunMultipleMonitorsScript.monitors"><a class="viewcode-back" href="../../core.html#core.scripts.RunMultipleMonitorsScript.monitors">[docs]</a>    <span class="k">def</span> <span class="nf">monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all the Monitors that need to be run.</span>

<span class="sd">        :return: A list of Monitor objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMultipleMonitorsScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.RunMultipleMonitorsScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># This is bad, but not so bad that we should give up trying</span>
                <span class="c1"># to run the other Monitors.</span>
                <span class="k">if</span> <span class="n">monitor</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
                    <span class="n">collection_name</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">collection_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Error running monitor </span><span class="si">%s</span><span class="s2"> for collection </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span></div></div>


<div class="viewcode-block" id="RunReaperMonitorsScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunReaperMonitorsScript">[docs]</a><span class="k">class</span> <span class="nc">RunReaperMonitorsScript</span><span class="p">(</span><span class="n">RunMultipleMonitorsScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run all the monitors found in ReaperMonitor.REGISTRY&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Run all reaper monitors&quot;</span>

<div class="viewcode-block" id="RunReaperMonitorsScript.monitors"><a class="viewcode-back" href="../../core.html#core.scripts.RunReaperMonitorsScript.monitors">[docs]</a>    <span class="k">def</span> <span class="nf">monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">ReaperMonitor</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="RunCoverageProvidersScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProvidersScript">[docs]</a><span class="k">class</span> <span class="nc">RunCoverageProvidersScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alternate between multiple coverage providers.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunCoverageProvidersScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<div class="viewcode-block" id="RunCoverageProvidersScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProvidersScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">providers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">providers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No CoverageProviders to run.&#39;</span><span class="p">)</span>

        <span class="n">progress</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">providers</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">providers</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">provider</span><span class="o">.</span><span class="n">service_name</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">provider_progress</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">run_once_and_update_timestamp</span><span class="p">()</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">provider_progress</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Error in </span><span class="si">%r</span><span class="s2">, moving on to next CoverageProvider.&quot;</span><span class="p">,</span>
                        <span class="n">provider</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Completed </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">provider</span><span class="o">.</span><span class="n">service_name</span><span class="p">)</span>
                <span class="n">providers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">progress</span></div></div>


<div class="viewcode-block" id="RunCollectionCoverageProviderScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunCollectionCoverageProviderScript">[docs]</a><span class="k">class</span> <span class="nc">RunCollectionCoverageProviderScript</span><span class="p">(</span><span class="n">RunCoverageProvidersScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the same CoverageProvider code for all Collections that</span>
<span class="sd">    get their licenses from the appropriate place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_class</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">provider_class</span><span class="p">:</span>
            <span class="n">providers</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_providers</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">provider_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunCollectionCoverageProviderScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="RunCollectionCoverageProviderScript.get_providers"><a class="viewcode-back" href="../../core.html#core.scripts.RunCollectionCoverageProviderScript.get_providers">[docs]</a>    <span class="k">def</span> <span class="nf">get_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">provider_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">provider_class</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="RunThreadedCollectionCoverageProviderScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunThreadedCollectionCoverageProviderScript">[docs]</a><span class="k">class</span> <span class="nc">RunThreadedCollectionCoverageProviderScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run coverage providers in multiple threads.&quot;&quot;&quot;</span>

    <span class="n">DEFAULT_WORKER_SIZE</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_class</span><span class="p">,</span> <span class="n">worker_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">provider_kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunThreadedCollectionCoverageProviderScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_size</span> <span class="o">=</span> <span class="n">worker_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_WORKER_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span> <span class="o">=</span> <span class="n">SessionManager</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># Use a database from the factory.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_db</span><span class="p">:</span>
            <span class="c1"># Close the new, autogenerated database session.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span> <span class="o">=</span> <span class="n">provider_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_kwargs</span> <span class="o">=</span> <span class="n">provider_kwargs</span>

<div class="viewcode-block" id="RunThreadedCollectionCoverageProviderScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.RunThreadedCollectionCoverageProviderScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs a CollectionCoverageProvider with multiple threads and</span>
<span class="sd">        updates the timestamp accordingly.</span>

<span class="sd">        :param pool: A DatabasePool (or other) object for use in testing</span>
<span class="sd">            environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span><span class="o">.</span><span class="n">collections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_kwargs</span><span class="p">)</span>
            <span class="k">with</span> <span class="p">(</span>
                <span class="n">pool</span> <span class="ow">or</span> <span class="n">DatabasePool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">job_queue</span><span class="p">:</span>
                <span class="n">query_size</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_query_and_batch_sizes</span><span class="p">(</span>
                    <span class="n">provider</span>
                <span class="p">)</span>
                <span class="c1"># Without a commit, the query to count which items need</span>
                <span class="c1"># coverage hangs in the database, blocking the threads.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># TODO: We create a separate &#39;progress&#39; object</span>
                <span class="c1"># for each job, and each will overwrite the timestamp</span>
                <span class="c1"># value as its complets. It woudl be better if all the</span>
                <span class="c1"># jobs could share a single &#39;progress&#39; object.</span>
                <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">query_size</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">CoverageProviderProgress</span><span class="p">(</span>
                        <span class="n">start</span><span class="o">=</span><span class="n">utc_now</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">CollectionCoverageProviderJob</span><span class="p">(</span>
                        <span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_kwargs</span>
                    <span class="p">)</span>
                    <span class="n">job_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunThreadedCollectionCoverageProviderScript.get_query_and_batch_sizes"><a class="viewcode-back" href="../../core.html#core.scripts.RunThreadedCollectionCoverageProviderScript.get_query_and_batch_sizes">[docs]</a>    <span class="k">def</span> <span class="nf">get_query_and_batch_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">items_that_need_coverage</span><span class="p">(</span>
            <span class="n">count_as_covered</span><span class="o">=</span><span class="n">BaseCoverageRecord</span><span class="o">.</span><span class="n">DEFAULT_COUNT_AS_COVERED</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fast_query_count</span><span class="p">(</span><span class="n">qu</span><span class="p">),</span> <span class="n">provider</span><span class="o">.</span><span class="n">batch_size</span></div></div>


<div class="viewcode-block" id="RunWorkCoverageProviderScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunWorkCoverageProviderScript">[docs]</a><span class="k">class</span> <span class="nc">RunWorkCoverageProviderScript</span><span class="p">(</span><span class="n">RunCollectionCoverageProviderScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a WorkCoverageProvider on every relevant Work in the system.&quot;&quot;&quot;</span>

    <span class="c1"># This class overrides RunCollectionCoverageProviderScript just to</span>
    <span class="c1"># take advantage of the constructor; it doesn&#39;t actually use the</span>
    <span class="c1"># concept of &#39;collections&#39; at all.</span>

<div class="viewcode-block" id="RunWorkCoverageProviderScript.get_providers"><a class="viewcode-back" href="../../core.html#core.scripts.RunWorkCoverageProviderScript.get_providers">[docs]</a>    <span class="k">def</span> <span class="nf">get_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">provider_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">provider_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span></div></div>


<div class="viewcode-block" id="InputScript"><a class="viewcode-back" href="../../core.html#core.scripts.InputScript">[docs]</a><span class="k">class</span> <span class="nc">InputScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
<div class="viewcode-block" id="InputScript.read_stdin_lines"><a class="viewcode-back" href="../../core.html#core.scripts.InputScript.read_stdin_lines">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read_stdin_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read lines from a (possibly mocked, possibly empty) standard input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="c1"># A file has been redirected into standard input. Grab its</span>
            <span class="c1"># lines.</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stdin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lines</span></div></div>


<div class="viewcode-block" id="IdentifierInputScript"><a class="viewcode-back" href="../../core.html#core.scripts.IdentifierInputScript">[docs]</a><span class="k">class</span> <span class="nc">IdentifierInputScript</span><span class="p">(</span><span class="n">InputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script that takes identifiers as command line inputs.&quot;&quot;&quot;</span>

    <span class="n">DATABASE_ID</span> <span class="o">=</span> <span class="s2">&quot;Database ID&quot;</span>

<div class="viewcode-block" id="IdentifierInputScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.IdentifierInputScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                           <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_stdin_lines</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">look_up_identifiers</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifierInputScript.look_up_identifiers"><a class="viewcode-back" href="../../core.html#core.scripts.IdentifierInputScript.look_up_identifiers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">look_up_identifiers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">stdin_identifier_strings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn identifiers as specified on the command line into</span>
<span class="sd">        real database Identifier objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifier_data_source</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifier_data_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_db</span> <span class="ow">and</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">:</span>
            <span class="c1"># We can also call parse_identifier_list.</span>
            <span class="n">identifier_strings</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifier_strings</span>
            <span class="k">if</span> <span class="n">stdin_identifier_strings</span><span class="p">:</span>
                <span class="n">identifier_strings</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">identifier_strings</span> <span class="o">+</span> <span class="n">stdin_identifier_strings</span>
                <span class="p">)</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_identifier_list</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span>
                <span class="n">identifier_strings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The script can call parse_identifier_list later if it</span>
            <span class="c1"># wants to.</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="IdentifierInputScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.IdentifierInputScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--identifier-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process identifiers of this type. If IDENTIFIER is not specified, all identifiers of this type will be processed. To name identifiers by their database ID, use --identifier-type=&quot;Database ID&quot;&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--identifier-data-source&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process only identifiers which have a LicensePool associated with this DataSource&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;identifier_strings&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A specific identifier to process.&#39;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;IDENTIFIER&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="IdentifierInputScript.parse_identifier_list"><a class="viewcode-back" href="../../core.html#core.scripts.IdentifierInputScript.parse_identifier_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_identifier_list</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a list of identifiers into a list of Identifier objects.</span>

<span class="sd">        The list of arguments is probably derived from a command-line</span>
<span class="sd">        parser such as the one defined in</span>
<span class="sd">        IdentifierInputScript.arg_parser().</span>

<span class="sd">        This makes it easy to identify specific identifiers on the</span>
<span class="sd">        command line. Examples:</span>

<span class="sd">        1 2</span>

<span class="sd">        a b c</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No identifier type specified! Use &#39;--identifier-type=</span><span class="se">\&quot;</span><span class="s2">Database ID</span><span class="se">\&quot;</span><span class="s2">&#39; to name identifiers by database ID.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_source</span><span class="p">:</span>
                <span class="n">identifiers</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">)</span><span class="o">.</span>\
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">identifier_type</span><span class="p">,</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source</span><span class="o">==</span><span class="n">data_source</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">identifiers</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATABASE_ID</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># We&#39;ll print out a warning later.</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
                    <span class="n">identifier</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="n">autocreate</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not load identifier </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">arg</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">identifiers</span></div></div>


<div class="viewcode-block" id="LibraryInputScript"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript">[docs]</a><span class="k">class</span> <span class="nc">LibraryInputScript</span><span class="p">(</span><span class="n">InputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script that operates on one or more Libraries.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LibraryInputScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">look_up_libraries</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryInputScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">multiple_libraries</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">library_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">short_name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">))</span>
        <span class="n">library_names</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;libraries&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of a specific library to process. Libraries on this system: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">library_names</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;SHORT_NAME&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">multiple_libraries</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="LibraryInputScript.look_up_libraries"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.look_up_libraries">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">look_up_libraries</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn library names as specified on the command line into real</span>
<span class="sd">        Library objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_db</span><span class="p">:</span>
            <span class="n">library_strings</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span>
            <span class="k">if</span> <span class="n">library_strings</span><span class="p">:</span>
                <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_library_list</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">library_strings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No libraries are specified. We will be processing</span>
                <span class="c1"># every library.</span>
                <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Database is not active yet. The script can call</span>
            <span class="c1"># parse_library_list later if it wants to.</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="LibraryInputScript.parse_library_list"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.parse_library_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_library_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a list of library short names into a list of Library objects.</span>

<span class="sd">        The list of arguments is probably derived from a command-line</span>
<span class="sd">        parser such as the one defined in</span>
<span class="sd">        LibraryInputScript.arg_parser().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">Library</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">library</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="n">MultipleResultsFound</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">library</span><span class="p">:</span>
                    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not find library </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">arg</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">libraries</span></div>

<div class="viewcode-block" id="LibraryInputScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_libraries</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryInputScript.process_libraries"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.process_libraries">[docs]</a>    <span class="k">def</span> <span class="nf">process_libraries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libraries</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryInputScript.process_library"><a class="viewcode-back" href="../../core.html#core.scripts.LibraryInputScript.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="PatronInputScript"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript">[docs]</a><span class="k">class</span> <span class="nc">PatronInputScript</span><span class="p">(</span><span class="n">LibraryInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script that operates on one or more Patrons.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PatronInputScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                           <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdin</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_stdin_lines</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PatronInputScript</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">look_up_libraries</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">look_up_patrons</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronInputScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PatronInputScript</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">multiple_libraries</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;identifiers&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A specific patron identifier to process.&#39;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;IDENTIFIER&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="PatronInputScript.look_up_patrons"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.look_up_patrons">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">look_up_patrons</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">stdin_patron_strings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn patron identifiers as specified on the command line into real</span>
<span class="sd">        Patron objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_db</span><span class="p">:</span>
            <span class="n">patron_strings</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">identifiers</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stdin_patron_strings</span><span class="p">:</span>
                <span class="n">patron_strings</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">patron_strings</span> <span class="o">+</span> <span class="n">stdin_patron_strings</span>
                <span class="p">)</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">patrons</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_patron_list</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">patron_strings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Database is not active yet. The script can call</span>
            <span class="c1"># parse_patron_list later if it wants to.</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">patrons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="PatronInputScript.parse_patron_list"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.parse_patron_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_patron_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a list of patron identifiers into a list of Patron objects.</span>

<span class="sd">        The list of arguments is probably derived from a command-line</span>
<span class="sd">        parser such as the one defined in</span>
<span class="sd">        PatronInputScript.arg_parser().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">patrons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">Patron</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                          <span class="n">Patron</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">patron</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Patron</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="n">arg</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span><span class="o">==</span><span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="n">MultipleResultsFound</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">patron</span><span class="p">:</span>
                    <span class="n">patrons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not find patron </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">arg</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">patrons</span></div>

<div class="viewcode-block" id="PatronInputScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_patrons</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">patrons</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronInputScript.process_patrons"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.process_patrons">[docs]</a>    <span class="k">def</span> <span class="nf">process_patrons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patrons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">patron</span> <span class="ow">in</span> <span class="n">patrons</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_patron</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronInputScript.process_patron"><a class="viewcode-back" href="../../core.html#core.scripts.PatronInputScript.process_patron">[docs]</a>    <span class="k">def</span> <span class="nf">process_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="LaneSweeperScript"><a class="viewcode-back" href="../../core.html#core.scripts.LaneSweeperScript">[docs]</a><span class="k">class</span> <span class="nc">LaneSweeperScript</span><span class="p">(</span><span class="n">LibraryInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do something to each lane in a library.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LaneSweeperScript.process_library"><a class="viewcode-back" href="../../core.html#core.scripts.LaneSweeperScript.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.lane</span> <span class="kn">import</span> <span class="n">WorkList</span>
        <span class="n">top_level</span> <span class="o">=</span> <span class="n">WorkList</span><span class="o">.</span><span class="n">top_level_for_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_level</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">new_queue</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_process_lane</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_lane</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sublane</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">new_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublane</span><span class="p">)</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">new_queue</span></div>

<div class="viewcode-block" id="LaneSweeperScript.should_process_lane"><a class="viewcode-back" href="../../core.html#core.scripts.LaneSweeperScript.should_process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LaneSweeperScript.process_lane"><a class="viewcode-back" href="../../core.html#core.scripts.LaneSweeperScript.process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="CustomListSweeperScript"><a class="viewcode-back" href="../../core.html#core.scripts.CustomListSweeperScript">[docs]</a><span class="k">class</span> <span class="nc">CustomListSweeperScript</span><span class="p">(</span><span class="n">LibraryInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do something to each custom list in a library.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomListSweeperScript.process_library"><a class="viewcode-back" href="../../core.html#core.scripts.CustomListSweeperScript.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CustomList</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CustomList</span><span class="o">.</span><span class="n">library_id</span><span class="o">==</span><span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_custom_list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="CustomListSweeperScript.process_custom_list"><a class="viewcode-back" href="../../core.html#core.scripts.CustomListSweeperScript.process_custom_list">[docs]</a>    <span class="k">def</span> <span class="nf">process_custom_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_list</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="SubjectInputScript"><a class="viewcode-back" href="../../core.html#core.scripts.SubjectInputScript">[docs]</a><span class="k">class</span> <span class="nc">SubjectInputScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script whose command line filters the set of Subjects.</span>

<span class="sd">    :return: a 2-tuple (subject type, subject filter) that can be</span>
<span class="sd">        passed into the SubjectSweepMonitor constructor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SubjectInputScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.SubjectInputScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subject-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process subjects of this type&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subject-filter&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process subjects whose names or identifiers match this substring&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div></div>


<div class="viewcode-block" id="RunCoverageProviderScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProviderScript">[docs]</a><span class="k">class</span> <span class="nc">RunCoverageProviderScript</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a single coverage provider.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunCoverageProviderScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProviderScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">IdentifierInputScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--cutoff-time&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Update existing coverage records if they were originally created after this time.&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="RunCoverageProviderScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProviderScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                           <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_stdin_lines</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">look_up_identifiers</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">cutoff_time</span><span class="p">:</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">cutoff_time</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">cutoff_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">provider_args</span><span class="p">,</span> <span class="o">**</span><span class="n">provider_kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">RunCoverageProviderScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">identifier_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_types</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_types</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">identifiers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">provider</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_additional_command_line_arguments</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">provider_kwargs</span><span class="p">)</span>

            <span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">provider_args</span><span class="p">,</span>
                <span class="n">cutoff_time</span><span class="o">=</span><span class="n">parsed_args</span><span class="o">.</span><span class="n">cutoff_time</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">service_name</span>


<div class="viewcode-block" id="RunCoverageProviderScript.extract_additional_command_line_arguments"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProviderScript.extract_additional_command_line_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">extract_additional_command_line_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A hook method for subclasses.</span>

<span class="sd">        Turns command-line arguments into additional keyword arguments</span>
<span class="sd">        to the CoverageProvider constructor.</span>

<span class="sd">        By default, pass in a value used only by CoverageProvider</span>
<span class="sd">        (as opposed to WorkCoverageProvider).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;input_identifiers&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="RunCoverageProviderScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.RunCoverageProviderScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">run_on_specific_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="ShowLibrariesScript"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLibrariesScript">[docs]</a><span class="k">class</span> <span class="nc">ShowLibrariesScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information about the libraries on a server.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;List the libraries on this server.&quot;</span>
<div class="viewcode-block" id="ShowLibrariesScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLibrariesScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--short-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only display information for the library with the given short name&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--show-secrets&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print out secrets associated with the library.&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ShowLibrariesScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLibrariesScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">:</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">short_name</span>
            <span class="p">)</span>
            <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">library</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">libraries</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Library</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No libraries found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">library</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
                        <span class="n">include_secrets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">show_secrets</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConfigurationSettingScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigurationSettingScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationSettingScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a command-line setting option into a key-value pair.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">setting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Incorrect format for setting: &quot;</span><span class="si">%s</span><span class="s1">&quot;. Should be &quot;key=value&quot;&#39;</span>
                <span class="o">%</span> <span class="n">setting</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigurationSettingScript.add_setting_argument"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigurationSettingScript.add_setting_argument">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_setting_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">help</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify an ArgumentParser to indicate that the script takes</span>
<span class="sd">        command-line settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--setting&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigurationSettingScript.apply_settings"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigurationSettingScript.apply_settings">[docs]</a>    <span class="k">def</span> <span class="nf">apply_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Treat `settings` as a list of command-line argument settings,</span>
<span class="sd">        and apply each one to `obj`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_setting</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="ConfigureSiteScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureSiteScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigureSiteScript</span><span class="p">(</span><span class="n">ConfigurationSettingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View or update site-wide configuration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">Configuration</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigureSiteScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>


<div class="viewcode-block" id="ConfigureSiteScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureSiteScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--show-secrets&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Include secrets when displaying site settings.&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">add_setting_argument</span><span class="p">(</span>
            <span class="n">parser</span><span class="p">,</span>
            <span class="s1">&#39;Set a site-wide setting, such as default_nongrouped_feed_max_age. Format: --setting=&quot;default_nongrouped_feed_max_age=1200&quot;&#39;</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--force&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set a site-wide setting even if the key isn&#39;t a known setting.&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ConfigureSiteScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureSiteScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">setting</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">setting</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_setting</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SITEWIDE_SETTINGS</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a known site-wide setting. Use --force to set it anyway.&quot;</span>
                        <span class="o">%</span> <span class="n">key</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">include_secrets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">show_secrets</span>
            <span class="p">))</span>
        <span class="p">)</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="ConfigureLibraryScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLibraryScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigureLibraryScript</span><span class="p">(</span><span class="n">ConfigurationSettingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a library or change its settings.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Change a library&#39;s settings&quot;</span>

<div class="viewcode-block" id="ConfigureLibraryScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLibraryScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Official name of the library&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--short-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Short name of the library&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">add_setting_argument</span><span class="p">(</span>
            <span class="n">parser</span><span class="p">,</span>
            <span class="s1">&#39;Set a per-library setting, such as terms-of-service. Format: --setting=&quot;terms-of-service=https://example.library/tos&quot;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ConfigureLibraryScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLibraryScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You must identify the library by its short name.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Are we talking about an existing library?</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="c1"># Currently there can only be one library, and one already exists.</span>
            <span class="p">[</span><span class="n">library</span><span class="p">]</span> <span class="o">=</span> <span class="n">libraries</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span> <span class="ow">and</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not locate library &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No existing library. Make one.</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">uuid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="n">short_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">library</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span><span class="p">:</span>
            <span class="n">library</span><span class="o">.</span><span class="n">short_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">short_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">setting</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Configuration settings stored.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">explain</span><span class="p">()))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ShowCollectionsScript"><a class="viewcode-back" href="../../core.html#core.scripts.ShowCollectionsScript">[docs]</a><span class="k">class</span> <span class="nc">ShowCollectionsScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information about the collections on a server.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;List the collections on this server.&quot;</span>
<div class="viewcode-block" id="ShowCollectionsScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ShowCollectionsScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only display information for the collection with the given name&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--show-secrets&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display secret values such as passwords.&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ShowCollectionsScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ShowCollectionsScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
                <span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;Could not locate collection by name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="n">collections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No collections found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">include_secrets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">show_secrets</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ShowIntegrationsScript"><a class="viewcode-back" href="../../core.html#core.scripts.ShowIntegrationsScript">[docs]</a><span class="k">class</span> <span class="nc">ShowIntegrationsScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information about the external integrations on a server.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;List the external integrations on this server.&quot;</span>
<div class="viewcode-block" id="ShowIntegrationsScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ShowIntegrationsScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only display information for the integration with the given name or ID&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--show-secrets&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display secret values such as passwords.&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ShowIntegrationsScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ShowIntegrationsScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
            <span class="n">integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
                <span class="n">integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">integration</span><span class="p">:</span>
                <span class="n">integrations</span> <span class="o">=</span> <span class="p">[</span><span class="n">integration</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;Could not locate integration by name or ID: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">args</span>
                <span class="p">)</span>
                <span class="n">integrations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">integrations</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">integrations</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No integrations found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">integration</span> <span class="ow">in</span> <span class="n">integrations</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">integration</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">include_secrets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">show_secrets</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConfigureCollectionScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureCollectionScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigureCollectionScript</span><span class="p">(</span><span class="n">ConfigurationSettingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a collection or change its settings.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Change a collection&#39;s settings&quot;</span>

<div class="viewcode-block" id="ConfigureCollectionScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureCollectionScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ConfigureCollectionScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureCollectionScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the collection&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--protocol&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Protocol to use to get the licenses. Possible values: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LICENSE_PROTOCOLS</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--external-account-id&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The ID of this collection according to the license source. Sometimes called a &quot;library ID&quot;.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--url&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run the acquisition protocol against this URL.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--username&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this username to authenticate with the license protocol. Sometimes called a &quot;key&quot;.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--password&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this password to authenticate with the license protocol. Sometimes called a &quot;secret&quot;.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">add_setting_argument</span><span class="p">(</span>
            <span class="n">parser</span><span class="p">,</span>
            <span class="s1">&#39;Set a protocol-specific setting on the collection, such as Overdrive</span><span class="se">\&#39;</span><span class="s1">s &quot;website_id&quot;. Format: --setting=&quot;website_id=89&quot;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">library_names</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_library_names</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">library_names</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s1">&#39;--library&#39;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Associate this collection with the given library. Possible libraries: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">library_names</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_library_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string that lists known library names.&quot;&quot;&quot;</span>
        <span class="n">library_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">short_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">library_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="ConfigureCollectionScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureCollectionScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>

        <span class="c1"># Find or create the collection</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Collection</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">protocol</span><span class="p">:</span>
                <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_name_and_protocol</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We didn&#39;t find a Collection, and we don&#39;t have a protocol,</span>
                <span class="c1"># so we can&#39;t create a new Collection.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;No collection called &quot;</span><span class="si">%s</span><span class="s1">&quot;. You can create it, but you must specify a protocol.&#39;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span>
        <span class="k">if</span> <span class="n">protocol</span><span class="p">:</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">external_account_id</span><span class="p">:</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">external_account_id</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">username</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">setting</span><span class="p">,</span> <span class="n">integration</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">library</span><span class="p">:</span>
                <span class="n">library</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="p">:</span>
                    <span class="n">library_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_library_names</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;No such library: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">name</span>
                    <span class="k">if</span> <span class="n">library_names</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; I only know about: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library_names</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">collection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                    <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Configuration settings stored.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">explain</span><span class="p">()))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConfigureIntegrationScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureIntegrationScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigureIntegrationScript</span><span class="p">(</span><span class="n">ConfigurationSettingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a integration or change its settings.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Create a site-wide integration or change an integration&#39;s settings&quot;</span>

<div class="viewcode-block" id="ConfigureIntegrationScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureIntegrationScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ConfigureIntegrationScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureIntegrationScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the integration&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--id&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;ID of the integration, if it has no name&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--protocol&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Protocol used by the integration.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--goal&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Goal of the integration&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">add_setting_argument</span><span class="p">(</span>
            <span class="n">parser</span><span class="p">,</span>
            <span class="s1">&#39;Set a configuration value on the integration. Format: --setting=&quot;key=value&quot;&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or create the ExternalIntegration referred to.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">protocol</span> <span class="ow">and</span> <span class="n">goal</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;An integration must by identified by either ID, name, or the combination of protocol and goal.&quot;</span>
            <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="nb">id</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No integration with ID </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">protocol</span> <span class="ow">and</span> <span class="n">goal</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;No integration with name &quot;</span><span class="si">%s</span><span class="s1">&quot;. To create it, you must also provide protocol and goal.&#39;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span> <span class="ow">and</span> <span class="p">(</span><span class="n">protocol</span> <span class="ow">and</span> <span class="n">goal</span><span class="p">):</span>
            <span class="n">integration</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">integration</span>

<div class="viewcode-block" id="ConfigureIntegrationScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureIntegrationScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>

        <span class="c1"># Find or create the integration</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">id</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">goal</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integration</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">setting</span><span class="p">,</span> <span class="n">integration</span><span class="p">)</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Configuration settings stored.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">explain</span><span class="p">()))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ShowLanesScript"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLanesScript">[docs]</a><span class="k">class</span> <span class="nc">ShowLanesScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information about the lanes on a server.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;List the lanes on this server.&quot;</span>
<div class="viewcode-block" id="ShowLanesScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLanesScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--id&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only display information for the lane with the given ID&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ShowLanesScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ShowLanesScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">id</span>
            <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lane</span><span class="p">:</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;Could not locate lane with id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">id</span>
                <span class="p">)</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lanes</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No lanes found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">lane</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ConfigureLaneScript"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLaneScript">[docs]</a><span class="k">class</span> <span class="nc">ConfigureLaneScript</span><span class="p">(</span><span class="n">ConfigurationSettingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a lane or change its settings.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Change a lane&#39;s settings&quot;</span>

<div class="viewcode-block" id="ConfigureLaneScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLaneScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ConfigureLaneScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLaneScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--id&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;ID of the lane, if editing an existing lane.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--library-short-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Short name of the library for this lane. Possible values: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_library_names</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--parent-id&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ID of this lane&#39;s parent lane&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--priority&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The lane&#39;s priority&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--display-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The lane name that will be displayed to patrons.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_library_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string that lists known library names.&quot;&quot;&quot;</span>
        <span class="n">library_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">short_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">library_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="ConfigureLaneScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ConfigureLaneScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>

        <span class="c1"># Find or create the lane</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">id</span>
        <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">library_short_name</span><span class="p">:</span>
                <span class="n">library</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">library_short_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such library: </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">library_short_name</span><span class="p">)</span>
                <span class="n">lane</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Library short name is required to create a new lane.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">parent_id</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">priority</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">site_configuration_has_changed</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Lane settings stored.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">explain</span><span class="p">()))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="AddClassificationScript"><a class="viewcode-back" href="../../core.html#core.scripts.AddClassificationScript">[docs]</a><span class="k">class</span> <span class="nc">AddClassificationScript</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Add a classification to an identifier&quot;</span>

<div class="viewcode-block" id="AddClassificationScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.AddClassificationScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">IdentifierInputScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subject-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The type of the subject to add to each identifier.&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subject-identifier&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The identifier of the subject to add to each identifier.&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subject-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the subject to add to each identifier.&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--data-source&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The data source to use when classifying.&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">MANUAL</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--weight&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The weight to use when classifying.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">1000</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--create-subject&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add the subject to the database if it doesn&#39;t already exist&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
            <span class="n">const</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AddClassificationScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">identifier_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">identifiers</span>
        <span class="n">subject_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">subject_type</span>
        <span class="n">subject_identifier</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">subject_identifier</span>
        <span class="n">subject_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">subject_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subject_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">subject_identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either subject-name or subject-identifier must be provided.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">subject_type</span><span class="p">,</span> <span class="n">subject_identifier</span><span class="p">,</span> <span class="n">subject_name</span><span class="p">,</span>
            <span class="n">autocreate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">create_subject</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AddClassificationScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.AddClassificationScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
            <span class="n">choose_edition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">set_edition_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">classify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">choose_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">calculate_quality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">choose_cover</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">update_search_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
                <span class="n">identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
                <span class="p">)</span>
                <span class="n">work</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">work</span>
                <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not locate subject, doing nothing.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WorkProcessingScript"><a class="viewcode-back" href="../../core.html#core.scripts.WorkProcessingScript">[docs]</a><span class="k">class</span> <span class="nc">WorkProcessingScript</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Work processing script&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkProcessingScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">identifier_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">identifier_data_source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_identifier_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">identifier_strings</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>

<div class="viewcode-block" id="WorkProcessingScript.make_query"><a class="viewcode-back" href="../../core.html#core.scripts.WorkProcessingScript.make_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_query</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifiers</span> <span class="ow">or</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Restricted to </span><span class="si">%d</span><span class="s1"> specific identifiers.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Restricted to identifiers from DataSource &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="n">data_source</span>
                <span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source</span><span class="o">==</span><span class="n">source</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Restricted to identifier type &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">identifier_type</span>
                <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">identifier_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Processing </span><span class="si">%d</span><span class="s2"> works.&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkProcessingScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.WorkProcessingScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">works</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">works</span><span class="p">:</span>
            <span class="n">works</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkProcessingScript.process_work"><a class="viewcode-back" href="../../core.html#core.scripts.WorkProcessingScript.process_work">[docs]</a>    <span class="k">def</span> <span class="nf">process_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="WorkConsolidationScript"><a class="viewcode-back" href="../../core.html#core.scripts.WorkConsolidationScript">[docs]</a><span class="k">class</span> <span class="nc">WorkConsolidationScript</span><span class="p">(</span><span class="n">WorkProcessingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an Identifier, make sure all the LicensePools for that</span>
<span class="sd">    Identifier are in Works that follow these rules:</span>

<span class="sd">    a) For a given permanent work ID, there may be at most one Work</span>
<span class="sd">    containing open-access LicensePools.</span>

<span class="sd">    b) Each non-open-access LicensePool has its own individual Work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Work consolidation script&quot;</span>

<div class="viewcode-block" id="WorkConsolidationScript.make_query"><a class="viewcode-back" href="../../core.html#core.scripts.WorkConsolidationScript.make_query">[docs]</a>    <span class="k">def</span> <span class="nf">make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># We actually process LicensePools, not Works.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">identifier_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">qu</span></div>

<div class="viewcode-block" id="WorkConsolidationScript.process_work"><a class="viewcode-back" href="../../core.html#core.scripts.WorkConsolidationScript.process_work">[docs]</a>    <span class="k">def</span> <span class="nf">process_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="c1"># We call it &#39;work&#39; for signature compatibility with the superclass,</span>
        <span class="c1"># but it&#39;s actually a LicensePool.</span>
        <span class="n">licensepool</span> <span class="o">=</span> <span class="n">work</span>
        <span class="n">licensepool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span></div>

<div class="viewcode-block" id="WorkConsolidationScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.WorkConsolidationScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkConsolidationScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">do_run</span><span class="p">()</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Deleting </span><span class="si">%d</span><span class="s2"> Works that have no LicensePools.&quot;</span> <span class="o">%</span> <span class="n">qu</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="WorkPresentationScript"><a class="viewcode-back" href="../../core.html#core.scripts.WorkPresentationScript">[docs]</a><span class="k">class</span> <span class="nc">WorkPresentationScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">,</span> <span class="n">WorkProcessingScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the presentation for Work objects.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Recalculate the presentation for works that need it.&quot;</span>

    <span class="c1"># Do a complete recalculation of the presentation.</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">()</span>

<div class="viewcode-block" id="WorkPresentationScript.process_work"><a class="viewcode-back" href="../../core.html#core.scripts.WorkPresentationScript.process_work">[docs]</a>    <span class="k">def</span> <span class="nf">process_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WorkClassificationScript"><a class="viewcode-back" href="../../core.html#core.scripts.WorkClassificationScript">[docs]</a><span class="k">class</span> <span class="nc">WorkClassificationScript</span><span class="p">(</span><span class="n">WorkPresentationScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recalculate the classification--and nothing else--for Work objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Recalculate the classification for works that need it.&quot;&quot;&quot;</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
        <span class="n">choose_edition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_edition_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">classify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">choose_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">calculate_quality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">choose_cover</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">update_search_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ReclassifyWorksForUncheckedSubjectsScript"><a class="viewcode-back" href="../../core.html#core.scripts.ReclassifyWorksForUncheckedSubjectsScript">[docs]</a><span class="k">class</span> <span class="nc">ReclassifyWorksForUncheckedSubjectsScript</span><span class="p">(</span><span class="n">WorkClassificationScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reclassify all Works whose current classifications appear to</span>
<span class="sd">    depend on Subjects in the &#39;unchecked&#39; state.</span>

<span class="sd">    This generally means that some migration script reset those</span>
<span class="sd">    Subjects because the rules for processing them changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Reclassify works that use unchecked subjects.&quot;&quot;&quot;</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="n">WorkClassificationScript</span><span class="o">.</span><span class="n">policy</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">Work</span><span class="o">.</span><span class="n">for_unchecked_subjects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span></div>


<div class="viewcode-block" id="WorkOPDSScript"><a class="viewcode-back" href="../../core.html#core.scripts.WorkOPDSScript">[docs]</a><span class="k">class</span> <span class="nc">WorkOPDSScript</span><span class="p">(</span><span class="n">WorkPresentationScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recalculate the OPDS entries, MARC record, and search index entries</span>
<span class="sd">    for Work objects.</span>

<span class="sd">    This is intended to verify that a problem has already been resolved and just</span>
<span class="sd">    needs to be propagated to these three &#39;caches&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Recalculate OPDS entries, MARC record, and search index entries for works that need it.&quot;</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
        <span class="n">choose_edition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_edition_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">classify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">choose_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">calculate_quality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">choose_cover</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">update_search_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="CustomListManagementScript"><a class="viewcode-back" href="../../core.html#core.scripts.CustomListManagementScript">[docs]</a><span class="k">class</span> <span class="nc">CustomListManagementScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maintain a CustomList whose membership is determined by a</span>
<span class="sd">    MembershipManager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager_class</span><span class="p">,</span>
                 <span class="n">data_source_name</span><span class="p">,</span> <span class="n">list_identifier</span><span class="p">,</span> <span class="n">list_name</span><span class="p">,</span>
                 <span class="n">primary_language</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">manager_kwargs</span>
             <span class="p">):</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_list</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span>
            <span class="n">data_source_id</span><span class="o">=</span><span class="n">data_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">foreign_identifier</span><span class="o">=</span><span class="n">list_identifier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_list</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">=</span> <span class="n">primary_language</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_list</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">membership_manager</span> <span class="o">=</span> <span class="n">manager_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_list</span><span class="p">,</span> <span class="o">**</span><span class="n">manager_kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CustomListManagementScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.CustomListManagementScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">membership_manager</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CollectionType"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionType">[docs]</a><span class="k">class</span> <span class="nc">CollectionType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">OPEN_ACCESS</span> <span class="o">=</span> <span class="s1">&#39;OPEN_ACCESS&#39;</span>
    <span class="n">PROTECTED_ACCESS</span> <span class="o">=</span> <span class="s1">&#39;PROTECTED_ACCESS&#39;</span>
    <span class="n">LCP</span> <span class="o">=</span> <span class="s1">&#39;LCP&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="CollectionInputScript"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionInputScript">[docs]</a><span class="k">class</span> <span class="nc">CollectionInputScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script that takes collection names as command line inputs.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CollectionInputScript.parse_command_line"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionInputScript.parse_command_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">look_up_collections</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CollectionInputScript.look_up_collections"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionInputScript.look_up_collections">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">look_up_collections</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn collection names as specified on the command line into</span>
<span class="sd">        real database Collection objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collection_names</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown collection: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="CollectionInputScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionInputScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--collection&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Collection to use&#39;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;collection_names&#39;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--collection-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Collection type. Valid values are: OPEN_ACCESS (default), PROTECTED_ACCESS.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">CollectionType</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CollectionType</span><span class="p">),</span>
            <span class="n">default</span><span class="o">=</span><span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div></div>


<div class="viewcode-block" id="CollectionArgumentsScript"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionArgumentsScript">[docs]</a><span class="k">class</span> <span class="nc">CollectionArgumentsScript</span><span class="p">(</span><span class="n">CollectionInputScript</span><span class="p">):</span>

<div class="viewcode-block" id="CollectionArgumentsScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.CollectionArgumentsScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;collection_names&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;One or more collection names.&#39;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div></div>


<div class="viewcode-block" id="RunCollectionMonitorScript"><a class="viewcode-back" href="../../core.html#core.scripts.RunCollectionMonitorScript">[docs]</a><span class="k">class</span> <span class="nc">RunCollectionMonitorScript</span><span class="p">(</span><span class="n">RunMultipleMonitorsScript</span><span class="p">,</span> <span class="n">CollectionArgumentsScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a CollectionMonitor on every Collection that comes through a</span>
<span class="sd">    certain protocol.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_class</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param monitor_class: A class object that derives from</span>
<span class="sd">            CollectionMonitor.</span>
<span class="sd">        :type monitor_class: CollectionMonitor</span>

<span class="sd">        :param cmd_args: Optional command line arguments. These will be</span>
<span class="sd">            passed on to the command line parser.</span>
<span class="sd">        :type cmd_args: Optional[List[str]]</span>

<span class="sd">        :param kwargs: Keyword arguments to pass into the `monitor_class`</span>
<span class="sd">            constructor each time it&#39;s called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunCollectionMonitorScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_class</span> <span class="o">=</span> <span class="n">monitor_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_class</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">))</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;collection_names&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

<div class="viewcode-block" id="RunCollectionMonitorScript.monitors"><a class="viewcode-back" href="../../core.html#core.scripts.RunCollectionMonitorScript.monitors">[docs]</a>    <span class="k">def</span> <span class="nf">monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_class</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OPDSImportScript"><a class="viewcode-back" href="../../core.html#core.scripts.OPDSImportScript">[docs]</a><span class="k">class</span> <span class="nc">OPDSImportScript</span><span class="p">(</span><span class="n">CollectionInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import all books from the OPDS feed associated with a collection.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Import all books from the OPDS feed associated with a collection.&quot;</span>

    <span class="n">IMPORTER_CLASS</span> <span class="o">=</span> <span class="n">OPDSImporter</span>
    <span class="n">MONITOR_CLASS</span> <span class="o">=</span> <span class="n">OPDSImportMonitor</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">OPDS_IMPORT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">importer_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">monitor_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPDSImportScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importer_class</span> <span class="o">=</span> <span class="n">importer_class</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORTER_CLASS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_class</span> <span class="o">=</span> <span class="n">monitor_class</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">MONITOR_CLASS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROTOCOL</span>

<div class="viewcode-block" id="OPDSImportScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.OPDSImportScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">CollectionInputScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--force&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Import the feed from scratch, even if it seems like it was already imported.&#39;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="OPDSImportScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.OPDSImportScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collections</span> <span class="ow">or</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_monitor</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">parsed</span><span class="o">.</span><span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSImportScript.run_monitor"><a class="viewcode-back" href="../../core.html#core.scripts.OPDSImportScript.run_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">run_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">importer_class</span><span class="p">,</span>
            <span class="n">force_reimport</span><span class="o">=</span><span class="n">force</span>
        <span class="p">)</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MirrorResourcesScript"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript">[docs]</a><span class="k">class</span> <span class="nc">MirrorResourcesScript</span><span class="p">(</span><span class="n">CollectionInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure that all mirrorable resources in a collection have</span>
<span class="sd">    in fact been mirrored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This object contains the actual logic of mirroring.</span>
    <span class="n">MIRROR_UTILITY</span> <span class="o">=</span> <span class="n">MetaToModelUtility</span><span class="p">()</span>

<div class="viewcode-block" id="MirrorResourcesScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collections</span>
        <span class="n">collection_type</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collection_type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="p">:</span>
            <span class="c1"># Assume they mean all collections.</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># But only process collections that have an associated MirrorUploader.</span>
        <span class="k">for</span> <span class="n">collection</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections_with_uploader</span><span class="p">(</span><span class="n">collections</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span></div>

<div class="viewcode-block" id="MirrorResourcesScript.collections_with_uploader"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.collections_with_uploader">[docs]</a>    <span class="k">def</span> <span class="nf">collections_with_uploader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="n">collection_type</span><span class="o">=</span><span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter out collections that have no MirrorUploader.</span>

<span class="sd">        :yield: 2-tuples (Collection, ReplacementPolicy). The</span>
<span class="sd">            ReplacementPolicy is the appropriate one for this script</span>
<span class="sd">            to use for that Collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">covers</span> <span class="o">=</span> <span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span>
                <span class="n">collection</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span>
            <span class="p">)</span>
            <span class="n">books_mirror_type</span> <span class="o">=</span> \
                <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span> \
                <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span> \
                <span class="k">else</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">PROTECTED_ACCESS_BOOKS</span>
            <span class="n">books</span> <span class="o">=</span> <span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span>
                <span class="n">collection</span><span class="p">,</span>
                <span class="n">books_mirror_type</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">covers</span> <span class="ow">or</span> <span class="n">books</span><span class="p">:</span>
                <span class="n">mirrors</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">:</span> <span class="n">covers</span><span class="p">,</span>
                    <span class="n">books_mirror_type</span><span class="p">:</span> <span class="n">books</span>
                <span class="p">}</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span><span class="p">(</span><span class="n">mirrors</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">collection</span><span class="p">,</span> <span class="n">policy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Skipping </span><span class="si">%r</span><span class="s2"> as it has no MirrorUploader.&quot;</span><span class="p">,</span> <span class="n">collection</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="MirrorResourcesScript.replacement_policy"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.replacement_policy">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">replacement_policy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a ReplacementPolicy for this script that uses the</span>
<span class="sd">        given mirrors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="n">mirrors</span><span class="p">,</span> <span class="n">link_content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">even_if_not_apparently_updated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">http_get</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">cautious_http_get</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MirrorResourcesScript.process_collection"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.process_collection">[docs]</a>    <span class="k">def</span> <span class="nf">process_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">unmirrored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure every mirrorable resource in this collection has</span>
<span class="sd">        been mirrored.</span>

<span class="sd">        :param unmirrored: A replacement for Hyperlink.unmirrored,</span>
<span class="sd">            for use in tests.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unmirrored</span> <span class="o">=</span> <span class="n">unmirrored</span> <span class="ow">or</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">unmirrored</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">unmirrored</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="MirrorResourcesScript.derive_rights_status"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.derive_rights_status">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">derive_rights_status</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a best guess about the rights status for the given</span>
<span class="sd">        resource.</span>

<span class="sd">        This relies on the information having been available at one point,</span>
<span class="sd">        but having been stored in the database at a slight remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rights_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
            <span class="n">lpdm</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">as_delivery_mechanism_for</span><span class="p">(</span><span class="n">license_pool</span><span class="p">)</span>
            <span class="c1"># When this Resource was associated with this LicensePool,</span>
            <span class="c1"># the rights information was recorded in its</span>
            <span class="c1"># LicensePoolDeliveryMechanism.</span>
            <span class="k">if</span> <span class="n">lpdm</span><span class="p">:</span>
                <span class="n">rights_status</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rights_status</span><span class="p">:</span>
            <span class="c1"># We could not find a LicensePoolDeliveryMechanism for</span>
            <span class="c1"># this particular resource, but if every</span>
            <span class="c1"># LicensePoolDeliveryMechanism has the same rights</span>
            <span class="c1"># status, we can assume it&#39;s that one.</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span>
                <span class="n">x</span><span class="o">.</span><span class="n">rights_status</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span>
            <span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">statuses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="p">[</span><span class="n">rights_status</span><span class="p">]</span> <span class="o">=</span> <span class="n">statuses</span>
        <span class="k">if</span> <span class="n">rights_status</span><span class="p">:</span>
            <span class="n">rights_status</span> <span class="o">=</span> <span class="n">rights_status</span><span class="o">.</span><span class="n">uri</span>
        <span class="k">return</span> <span class="n">rights_status</span></div>

<div class="viewcode-block" id="MirrorResourcesScript.process_item"><a class="viewcode-back" href="../../core.html#core.scripts.MirrorResourcesScript.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">link_obj</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the URL that needs to be mirrored and (for books)</span>
<span class="sd">        the rationale that lets us mirror that URL. Then mirror it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">license_pool</span><span class="p">:</span>
            <span class="c1"># This shouldn&#39;t happen.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Could not find LicensePool for </span><span class="si">%r</span><span class="s2">, skipping it rather than mirroring something we shouldn&#39;t.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">resource</span>

        <span class="k">if</span> <span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span><span class="p">:</span>
            <span class="n">rights_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_rights_status</span><span class="p">(</span><span class="n">license_pool</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rights_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not unambiguously determine rights status for </span><span class="si">%r</span><span class="s2">, skipping.&quot;</span><span class="p">,</span> <span class="n">link_obj</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For resources like book covers, the rights status is</span>
            <span class="c1"># irrelevant -- we rely on fair use.</span>
            <span class="n">rights_status</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Mock up a LinkData that MetaToModelUtility can use to</span>
        <span class="c1"># mirror this link (or decide not to mirror it).</span>
        <span class="n">linkdata</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">link_obj</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_status</span>
        <span class="p">)</span>

        <span class="c1"># Mirror the link (or not).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MIRROR_UTILITY</span><span class="o">.</span><span class="n">mirror_link</span><span class="p">(</span>
            <span class="n">model_object</span><span class="o">=</span><span class="n">license_pool</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">link</span><span class="o">=</span><span class="n">linkdata</span><span class="p">,</span> <span class="n">link_obj</span><span class="o">=</span><span class="n">link_obj</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="DatabaseMigrationScript"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript">[docs]</a><span class="k">class</span> <span class="nc">DatabaseMigrationScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs new migrations.</span>

<span class="sd">    This script needs to execute without ever loading an ORM object,</span>
<span class="sd">    because the database might be in a state that&#39;s not compatible</span>
<span class="sd">    with the current ORM version.</span>

<span class="sd">    This is not a TimestampScript because it keeps separate Timestamps</span>
<span class="sd">    for the Python and the SQL migrations, and because Timestamps</span>
<span class="sd">    are ORM objects, which this script can&#39;t touch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Database Migration&quot;</span>
    <span class="n">PY_TIMESTAMP_SERVICE_NAME</span> <span class="o">=</span> <span class="n">SERVICE_NAME</span> <span class="o">+</span> <span class="s2">&quot; - Python&quot;</span>

    <span class="n">MIGRATION_WITH_COUNTER</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d</span><span class="si">{8}</span><span class="s2">-(\d+)-(.)+\.(py|sql)&quot;</span><span class="p">)</span>

    <span class="c1"># There are some SQL commands that can&#39;t be run inside a transaction.</span>
    <span class="n">TRANSACTIONLESS_COMMANDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alter type&#39;</span><span class="p">]</span>

    <span class="n">TRANSACTION_PER_STATEMENT</span> <span class="o">=</span> <span class="s1">&#39;SIMPLYE_MIGRATION_TRANSACTION_PER_STATEMENT&#39;</span>
    <span class="n">DO_NOT_EXECUTE</span> <span class="o">=</span> <span class="s1">&#39;SIMPLYE_MIGRATION_DO_NOT_EXECUTE&#39;</span>

<div class="viewcode-block" id="DatabaseMigrationScript.TimestampInfo"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.TimestampInfo">[docs]</a>    <span class="k">class</span> <span class="nc">TimestampInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act like a ORM Timestamp object, but with no database connection.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DatabaseMigrationScript.TimestampInfo.find"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.TimestampInfo.find">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Find or create an existing timestamp representing the last</span>
<span class="sd">            migration script that was run.</span>

<span class="sd">            :return: A TimestampInfo object or None</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># We need to be aware of schema changes to the timestamps</span>
            <span class="c1"># table itself, since this is a necessary prerequisite to</span>
            <span class="c1"># running the migration scripts that will make those</span>
            <span class="c1"># schema changes.</span>
            <span class="c1">#</span>
            <span class="c1"># 2.3.0 - &#39;timestamp&#39; field renamed to &#39;finish&#39;</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;SELECT finish, counter FROM timestamps WHERE service=:service LIMIT 1;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SELECT timestamp, counter FROM timestamps WHERE service=:service LIMIT 1;&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">_db</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">_db</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Yes, everything should be fine -- I was able to find a timestamp in the new schema.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># The database connection is now tainted; we must</span>
                    <span class="c1"># create a new one.</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Got a database error obtaining the timestamp for </span><span class="si">%s</span><span class="s2">. Hopefully the timestamps table itself must be migrated and this is all according to plan.&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                    <span class="p">)</span>
                    <span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">script</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">production_session</span><span class="p">(</span><span class="n">initialize_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>

            <span class="c1"># If _none_ of those worked, something is wrong on a</span>
            <span class="c1"># deeper level.</span>
            <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="c1"># Make sure there&#39;s a row for this service in the timestamps</span>
                <span class="c1"># table so that we can update it later.</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO timestamps (service) values (:service);&quot;</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="p">[(</span><span class="n">date</span><span class="p">,</span> <span class="n">counter</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">date</span><span class="p">:</span>
                <span class="c1"># This is an empty Timestamp created during a previous</span>
                <span class="c1"># TimestampInfo.find attempt. It shouldn&#39;t be returned or</span>
                <span class="c1"># worked with in any way.</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span></div>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">finish</span> <span class="o">=</span> <span class="n">Script</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">finish</span> <span class="o">=</span> <span class="n">to_utc</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">finish</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>

<div class="viewcode-block" id="DatabaseMigrationScript.TimestampInfo.save"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.TimestampInfo.save">[docs]</a>        <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.TimestampInfo.update"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.TimestampInfo.update">[docs]</a>        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">migration_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Saves a TimestampInfo object to the database.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Reset values locally.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">to_utc</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;UPDATE timestamps SET start=(:finish at time zone &#39;utc&#39;), finish=(:finish at time zone &#39;utc&#39;), counter=:counter&quot;</span>
                <span class="s2">&quot; where service=:service&quot;</span>
            <span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">finish</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
                <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Timestamp stamped at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">migration_name</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">migration_name</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="DatabaseMigrationScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--last-run-date&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;A date string representing the last migration file &#39;</span>
                  <span class="s1">&#39;run against your database, formatted as YYYY-MM-DD&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--last-run-counter&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;An optional digit representing the counter of the last &#39;</span>
                  <span class="s1">&#39;migration run against your database. Only necessary if &#39;</span>
                  <span class="s1">&#39;multiple migrations were created on the same date.&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--python-only&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Only run python migrations since the given timestamp or the&#39;</span>
                  <span class="s1">&#39;most recent python timestamp&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.migratable_files"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.migratable_files">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">migratable_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">extensions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter a list of files for migratable file extensions&quot;&quot;&quot;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
        <span class="n">migratable</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filelist</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extensions</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">sort_migrations</span><span class="p">(</span><span class="n">migratable</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.sort_migrations"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.sort_migrations">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sort_migrations</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">migrations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All Python migrations sort after all SQL migrations, since a Python</span>
<span class="sd">        migration requires an up-to-date database schema.</span>

<span class="sd">        Migrations with a counter digit sort after migrations without</span>
<span class="sd">        one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">compare_migrations</span><span class="p">(</span><span class="n">first</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Compares migrations according to ideal sorting order.</span>

<span class="sd">            - All Python migrations run after all SQL migrations.</span>
<span class="sd">            - Migrations are first ordered by timestamp (asc).</span>
<span class="sd">            - If two migrations have the same timestamp, any migrations</span>
<span class="sd">              without counters come before migrations with counters.</span>
<span class="sd">            - If two migrations with the same timestamp, have counters,</span>
<span class="sd">              migrations are sorted by counter (asc).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">first</span><span class="p">[:</span><span class="mi">8</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Both migrations have the same timestamp, so compare using</span>
            <span class="c1"># their counters (default to 0 if no counter is included)</span>
            <span class="n">first_count</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MIGRATION_WITH_COUNTER</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">first_count</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_count</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">key</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">migrations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">compare_migrations</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directories_by_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list containing the migration directory path for core</span>
<span class="sd">        and its container server, organized in priority order (core first)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">core</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;migration&#39;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">current_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;migration&#39;</span><span class="p">)</span>

        <span class="c1"># Core is listed first, since core makes changes to the core database</span>
        <span class="c1"># schema. Server migrations generally fix bugs or otherwise update</span>
        <span class="c1"># the data itself.</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">core</span><span class="p">,</span> <span class="n">server</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the appropriate target Timestamp service name for the</span>
<span class="sd">        timestamp, depending on the script parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PY_TIMESTAMP_SERVICE_NAME</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">overall_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a TimestampInfo object corresponding to the the overall or</span>
<span class="sd">        general &quot;Database Migration&quot; service.</span>

<span class="sd">        If there is no Timestamp or the Timestamp doesn&#39;t have a timestamp</span>
<span class="sd">        attribute, it returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimestampInfo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">python_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a TimestampInfo object corresponding to the python migration-</span>
<span class="sd">        specific &quot;Database Migration - Python&quot; Timestamp.</span>

<span class="sd">        If there is no Timestamp or the Timestamp hasn&#39;t been initialized with</span>
<span class="sd">        a timestamp attribute, it returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimestampInfo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PY_TIMESTAMP_SERVICE_NAME</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseMigrationScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_only</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DatabaseMigrationScript.load_configuration"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.load_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load configuration without accessing the database.&quot;&quot;&quot;</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use or create a database session.</span>
        <span class="k">if</span> <span class="n">test_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">test_db</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create a special database session that doesn&#39;t initialize</span>
            <span class="c1"># the ORM. As long as we only execute SQL and don&#39;t try to use</span>
            <span class="c1"># any ORM objects, we&#39;ll be fine.</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">database_url</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">SessionManager</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">initialize_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">python_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">python_only</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">python_only</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">last_run_date</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">last_run_date</span>
        <span class="n">last_run_counter</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">last_run_counter</span>
        <span class="k">if</span> <span class="n">last_run_date</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimestampInfo</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">last_run_date</span><span class="p">,</span> <span class="n">last_run_counter</span>
            <span class="p">)</span>
            <span class="c1"># Save the timestamp at this point. This will set back the clock</span>
            <span class="c1"># in the case that the input last_run_date/counter is before the</span>
            <span class="c1"># existing Timestamp.finish / Timestamp.counter.</span>
            <span class="c1">#</span>
            <span class="c1"># DatabaseMigrationScript.update_timestamps will no longer rewind</span>
            <span class="c1"># a Timestamp, so saving here is important.</span>
            <span class="n">timestamp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="c1"># No timestamp was given. Get the timestamp from the database.</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimestampInfo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="p">:</span>
            <span class="c1"># There&#39;s no timestamp in the database! Raise an error.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span>
                <span class="s2">&quot;NO TIMESTAMP FOUND. Either initialize your untouched database &quot;</span>
                <span class="s2">&quot;with the script `core/bin/initialize_database` OR run this &quot;</span>
                <span class="s2">&quot;script with a timestamp that indicates the last migration run &quot;</span>
                <span class="s2">&quot;against your existing-but-uninitialized database.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">migrations</span><span class="p">,</span> <span class="n">migrations_by_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_migration_files</span><span class="p">()</span>

        <span class="n">new_migrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_migrations</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">migrations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_migrations</span><span class="p">:</span>
            <span class="c1"># Log the new migrations.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> new migrations found.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_migrations</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">new_migrations</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">migration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">(</span>
                <span class="n">new_migrations</span><span class="p">,</span> <span class="n">migrations_by_dir</span><span class="p">,</span> <span class="n">timestamp</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No new migrations found. Your database is up-to-date.&quot;</span><span class="p">)</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.fetch_migration_files"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.fetch_migration_files">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_migration_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pulls migration files from the expected locations</span>

<span class="sd">        :return: a tuple with a list of migration filenames and a dictionary of</span>
<span class="sd">            those files separated by their absolute directory location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">migrations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">migrations_by_dir</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.py&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_only</span><span class="p">:</span>
            <span class="n">extensions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;.sql&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories_by_priority</span><span class="p">:</span>
            <span class="c1"># In the case of tests, the container server migration directory</span>
            <span class="c1"># may not exist.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="n">dir_migrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">migratable_files</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="n">extensions</span>
                <span class="p">)</span>
                <span class="n">migrations</span> <span class="o">+=</span> <span class="n">dir_migrations</span>
                <span class="n">migrations_by_dir</span><span class="p">[</span><span class="n">directory</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_migrations</span>

        <span class="k">return</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">migrations_by_dir</span></div>

<div class="viewcode-block" id="DatabaseMigrationScript.get_new_migrations"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.get_new_migrations">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_migrations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">migrations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of migration filenames, representing migrations</span>
<span class="sd">        created since the timestamp</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_run</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">finish</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">migrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_migrations</span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span>
        <span class="n">new_migrations</span> <span class="o">=</span> <span class="p">[</span><span class="n">migration</span> <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span>
                          <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">migration</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_run</span><span class="p">)]</span>

        <span class="c1"># Multiple migrations run on the same day have an additional digit</span>
        <span class="c1"># after the date and a dash, eg:</span>
        <span class="c1">#</span>
        <span class="c1">#     20150826-1-change_target_age_from_int_to_range.sql</span>
        <span class="c1">#</span>
        <span class="c1"># When that migration is run, the number will be saved to the</span>
        <span class="c1"># &#39;counter&#39; column of Timestamp, so we have to account for that.</span>
        <span class="n">start_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">later_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">start_found</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">later_found</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_migrations</span><span class="p">):</span>
            <span class="n">start_found</span><span class="p">,</span> <span class="n">later_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_matching_migration</span><span class="p">(</span>
                <span class="n">new_migrations</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">timestamp</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">later_found</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">new_migrations</span> <span class="o">=</span> <span class="n">new_migrations</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">new_migrations</span></div>

    <span class="k">def</span> <span class="nf">_is_matching_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration_file</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether a given migration filename matches a given</span>
<span class="sd">        timestamp or is after it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_after_timestamp</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">finish</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span>

        <span class="k">if</span> <span class="n">migration_file</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">timestamp_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">migration_file</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;</span><span class="n">timestamp_str</span><span class="p">:</span>
                <span class="n">is_after_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">counter</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIGRATION_WITH_COUNTER</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">migration_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">migration_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">migration_num</span><span class="o">==</span><span class="n">counter</span><span class="p">:</span>
                        <span class="n">is_match</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">migration_num</span> <span class="o">&gt;</span> <span class="n">counter</span><span class="p">:</span>
                        <span class="n">is_after_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">is_match</span><span class="p">,</span> <span class="n">is_after_timestamp</span>

<div class="viewcode-block" id="DatabaseMigrationScript.run_migrations"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.run_migrations">[docs]</a>    <span class="k">def</span> <span class="nf">run_migrations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">migrations_by_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run each migration, first by timestamp and then by directory</span>
<span class="sd">        priority.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">raise_error</span><span class="p">(</span><span class="n">migration_path</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> must be migrated manually.&quot;</span> <span class="o">%</span> <span class="n">migration_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="n">migrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_migrations</span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">migration_file</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories_by_priority</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">migration_file</span> <span class="ow">in</span> <span class="n">migrations_by_dir</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
                    <span class="n">full_migration_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">migration_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_migration</span><span class="p">(</span><span class="n">full_migration_path</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                        <span class="n">previous</span> <span class="o">=</span> <span class="n">migration_file</span>
                    <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">se</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">se</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                            <span class="n">raise_error</span><span class="p">(</span>
                                <span class="n">full_migration_path</span><span class="p">,</span>
                                <span class="s2">&quot;Migration raised error code &#39;</span><span class="si">%d</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">se</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                <span class="n">code</span><span class="o">=</span><span class="n">se</span><span class="o">.</span><span class="n">code</span>
                            <span class="p">)</span>

                        <span class="c1"># Sometimes a migration isn&#39;t relevant and it</span>
                        <span class="c1"># runs sys.exit() to carry on with things.</span>
                        <span class="c1"># This shouldn&#39;t end the migration script, though.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamps</span><span class="p">(</span><span class="n">migration_file</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">raise_error</span><span class="p">(</span><span class="n">full_migration_path</span><span class="p">,</span> <span class="s2">&quot;Migration has been halted.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All new migrations have been run.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration_path</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs a single SQL or Python migration file&quot;&quot;&quot;</span>

        <span class="n">migration_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">migration_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ok_to_execute</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">migration_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sql&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">migration_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">clause</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="n">transactionless</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRANSACTIONLESS_COMMANDS</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
                <span class="n">one_tx_per_statement</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TRANSACTION_PER_STATEMENT</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="n">ok_to_execute</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DO_NOT_EXECUTE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">ok_to_execute</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">transactionless</span><span class="p">:</span>
                        <span class="n">new_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_migration_without_transaction</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">one_tx_per_statement</span><span class="p">:</span>
                        <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_statements_from_sql_file</span><span class="p">(</span><span class="n">migration_path</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BEGIN;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">COMMIT;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># By wrapping the action in a transation, we can avoid</span>
                        <span class="c1"># rolling over errors and losing data in files</span>
                        <span class="c1"># with multiple interrelated SQL actions.</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;BEGIN;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">COMMIT;&#39;</span> <span class="o">%</span> <span class="n">sql</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">migration_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">migration_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">migration_path</span><span class="p">)</span>

        <span class="c1"># Update timestamp for the migration.</span>
        <span class="k">if</span> <span class="n">ok_to_execute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamps</span><span class="p">(</span><span class="n">migration_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_statements_from_sql_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From an SQL file, return a python list of the individual statements.</span>

<span class="sd">        Removes comment lines and extraneous whitespace at the start / end of</span>
<span class="sd">        statements, but that&#39;s about it. Use carefully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sql_file_lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">sql_commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sql_file_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_command</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">current_command</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_command</span> <span class="o">=</span> <span class="n">current_command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">current_command</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                <span class="n">sql_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_command</span><span class="p">)</span>
                <span class="n">current_command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">sql_commands</span>

    <span class="k">def</span> <span class="nf">_run_migration_without_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_statement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs a single SQL statement outside of a transaction.&quot;&quot;&quot;</span>
        <span class="c1"># Go back up to engine-level.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>

        <span class="c1"># Close the Session so it benefits from the changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Get each individual SQL command from the migration text.</span>
        <span class="c1">#</span>
        <span class="c1"># In the case of &#39;ALTER TYPE&#39; (at least), running commands</span>
        <span class="c1"># simultaneously raises psycopg2.InternalError ending with &#39;cannot be</span>
        <span class="c1"># executed from a fuction or multi-command string&#39;</span>
        <span class="n">sql_commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
                        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">sql_statement</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="c1"># Run each command in the sql statement right up against the</span>
        <span class="c1"># database: no transactions, no guardrails.</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">sql_commands</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">isolation_level</span><span class="o">=</span><span class="s1">&#39;AUTOCOMMIT&#39;</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

        <span class="c1"># Update the script&#39;s Session to a new one that has the changed schema</span>
        <span class="c1"># and other important info.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_configuration</span><span class="p">()</span>
        <span class="n">DataSource</span><span class="o">.</span><span class="n">well_known_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseMigrationScript.update_timestamps"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationScript.update_timestamps">[docs]</a>    <span class="k">def</span> <span class="nf">update_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates this service&#39;s timestamp to match a given migration&quot;&quot;&quot;</span>
        <span class="n">last_run_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span><span class="n">migration_file</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># When multiple migration files are created on the same date, an</span>
        <span class="c1"># additional number is added. This number is held in the &#39;counter&#39;</span>
        <span class="c1"># column of Timestamp.</span>
        <span class="c1"># (It&#39;s not ideal, but it avoids creating a new database table.)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIGRATION_WITH_COUNTER</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">migration_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">migration_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;py&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_timestamp</span><span class="p">:</span>
            <span class="c1"># This is a python migration. Update the python timestamp.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">python_timestamp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">last_run_date</span><span class="p">,</span>
                <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span> <span class="n">migration_name</span><span class="o">=</span><span class="n">migration_file</span>
            <span class="p">)</span>

        <span class="c1"># Nothing to update</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="o">.</span><span class="n">finish</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finish_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="o">.</span><span class="n">finish</span>
        <span class="c1"># The last script that ran had an earlier timestamp than the current script</span>
        <span class="k">if</span> <span class="n">finish_timestamp</span> <span class="o">&gt;</span> <span class="n">last_run_date</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># The dates of the scrips are the same so compare the counters</span>
        <span class="k">if</span> <span class="n">finish_timestamp</span><span class="o">==</span><span class="n">last_run_date</span><span class="p">:</span>
            <span class="c1"># The current script has no counter, so it&#39;s the same script that ran</span>
            <span class="c1"># or an earlier script that ran</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># The previous script has a higher counter</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">counter</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overall_timestamp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">last_run_date</span><span class="p">,</span>
            <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span> <span class="n">migration_name</span><span class="o">=</span><span class="n">migration_file</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="DatabaseMigrationInitializationScript"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationInitializationScript">[docs]</a><span class="k">class</span> <span class="nc">DatabaseMigrationInitializationScript</span><span class="p">(</span><span class="n">DatabaseMigrationScript</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Creates a timestamp to kickoff the regular use of</span>
<span class="sd">    DatabaseMigrationScript to manage migrations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DatabaseMigrationInitializationScript.arg_parser"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationInitializationScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseMigrationInitializationScript</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force reset the initialization, ignoring any existing timestamps.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="DatabaseMigrationInitializationScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.DatabaseMigrationInitializationScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">last_run_date</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">last_run_date</span>
        <span class="n">last_run_counter</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">last_run_counter</span>

        <span class="k">if</span> <span class="n">last_run_counter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_run_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Timestamp.counter must be reset alongside Timestamp.finish&quot;</span><span class="p">)</span>

        <span class="n">existing_timestamp</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_timestamp</span> <span class="ow">and</span> <span class="n">existing_timestamp</span><span class="o">.</span><span class="n">finish</span><span class="p">:</span>
            <span class="c1"># A Timestamp exists and it has a .finish, so it wasn&#39;t created</span>
            <span class="c1"># by TimestampInfo.find.</span>
            <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing </span><span class="si">%s</span><span class="s2"> timestamp: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">existing_timestamp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> timestamp already exists: </span><span class="si">%r</span><span class="s2">. Use --force to update.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">existing_timestamp</span><span class="p">))</span>

        <span class="c1"># Initialize the required timestamps with the Space Jam release date.</span>
        <span class="n">init_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span><span class="s1">&#39;1996-11-15&#39;</span><span class="p">)</span>
        <span class="n">overall_timestamp</span> <span class="o">=</span> <span class="n">existing_timestamp</span> <span class="ow">or</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">,</span>
            <span class="n">service_type</span><span class="o">=</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">SCRIPT_TYPE</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">init_timestamp</span>
        <span class="p">)</span>
        <span class="n">python_timestamp</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PY_TIMESTAMP_SERVICE_NAME</span><span class="p">,</span>
            <span class="n">service_type</span><span class="o">=</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">SCRIPT_TYPE</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">init_timestamp</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">last_run_date</span><span class="p">:</span>
            <span class="n">submitted_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span><span class="n">last_run_date</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">overall_timestamp</span><span class="p">,</span> <span class="n">python_timestamp</span><span class="p">):</span>
                <span class="n">timestamp</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">submitted_time</span>
                <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">last_run_counter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">migrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_migrations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_migration_files</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">py_migrations</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">migrations</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)]</span>
        <span class="n">sql_migrations</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">migrations</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sql&#39;</span><span class="p">)]</span>

        <span class="n">most_recent_sql_migration</span> <span class="o">=</span> <span class="n">sql_migrations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">most_recent_python_migration</span> <span class="o">=</span> <span class="n">py_migrations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamps</span><span class="p">(</span><span class="n">most_recent_sql_migration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_timestamps</span><span class="p">(</span><span class="n">most_recent_python_migration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CheckContributorNamesInDB"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB">[docs]</a><span class="k">class</span> <span class="nc">CheckContributorNamesInDB</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks that contributor sort_names are display_names in</span>
<span class="sd">    &quot;last name, comma, other names&quot; format.</span>

<span class="sd">    Read contributors edition by edition, so that can, if necessary,</span>
<span class="sd">    restrict db query by passed-in identifiers, and so can find associated</span>
<span class="sd">    license pools to register author complaints to.</span>

<span class="sd">    NOTE:  There&#39;s also CheckContributorNamesOnWeb in metadata,</span>
<span class="sd">    it&#39;s a child of this script.  Use it to check our knowledge against</span>
<span class="sd">    viaf, with the newer better sort_name selection and formatting.</span>

<span class="sd">    TODO: make sure don&#39;t start at beginning again when interrupt while batch job is running.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">COMPLAINT_SOURCE</span> <span class="o">=</span> <span class="s2">&quot;CheckContributorNamesInDB&quot;</span>
    <span class="n">COMPLAINT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/problem/wrong-author&quot;</span><span class="p">;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CheckContributorNamesInDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parsed_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span>
        <span class="p">)</span>


<div class="viewcode-block" id="CheckContributorNamesInDB.make_query"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.make_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifiers</span> <span class="ow">or</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">)</span>

        <span class="c1"># we only want to look at editions with license pools, in case we want to make a Complaint</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">is_presentation_for</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Restricted to </span><span class="si">%d</span><span class="s1"> specific identifiers.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Restricted to identifier type &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">identifier_type</span>
                <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">identifier_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Processing </span><span class="si">%d</span><span class="s2"> editions.&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="CheckContributorNamesInDB.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_args</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="p">)</span>

        <span class="n">editions</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;ContributorID|</span><span class="se">\t</span><span class="s2">SortName|</span><span class="se">\t</span><span class="s2">DisplayName|</span><span class="se">\t</span><span class="s2">ComputedSortName|</span><span class="se">\t</span><span class="s2">Resolution|</span><span class="se">\t</span><span class="s2">ComplaintSource&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">editions</span><span class="p">:</span>
            <span class="n">my_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">editions</span> <span class="o">=</span> <span class="n">my_query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_contribution_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">contribution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">batch_size</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="CheckContributorNamesInDB.process_contribution_local"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.process_contribution_local">[docs]</a>    <span class="k">def</span> <span class="nf">process_contribution_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">contribution</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contribution</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">contribution</span><span class="o">.</span><span class="n">edition</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">contributor</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>

        <span class="k">if</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span> <span class="ow">and</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
            <span class="n">computed_sort_name_local_new</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&quot;NFKD&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">display_name_to_sort_name</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">)))</span>
            <span class="c1"># Did HumanName parser produce a differet result from the plain comma replacement?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">computed_sort_name_local_new</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">error_message_detail</span> <span class="o">=</span> <span class="s2">&quot;Contributor[id=</span><span class="si">%s</span><span class="s2">].sort_name is oddly different from computed_sort_name, human intervention required.&quot;</span> <span class="o">%</span> <span class="n">contributor</span><span class="o">.</span><span class="n">id</span>

                <span class="c1"># computed names don&#39;t match.  by how much?  if it&#39;s a matter of a comma or a misplaced</span>
                <span class="c1"># suffix, we can fix without asking for human intervention.  if the names are very different,</span>
                <span class="c1"># there&#39;s a chance the sort and display names are different on purpose, s.a. when foreign names</span>
                <span class="c1"># are passed as translated into only one of the fields, or when the author has a popular pseudonym.</span>
                <span class="c1"># best ask a human.</span>

                <span class="c1"># if the relative lengths are off by more than a stray space or comma, ask a human</span>
                <span class="c1"># it probably means that a human metadata professional had added an explanation/expansion to the</span>
                <span class="c1"># sort_name, s.a. &quot;Bob A. Jones&quot; --&gt; &quot;Bob A. (Allan) Jones&quot;, and we&#39;d rather not replace this data</span>
                <span class="c1"># with the &quot;Jones, Bob A.&quot; that the auto-algorigthm would generate.</span>
                <span class="n">length_difference</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">computed_sort_name_local_new</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">length_difference</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_local_mismatch</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">contribution</span><span class="o">=</span><span class="n">contribution</span><span class="p">,</span>
                        <span class="n">computed_sort_name</span><span class="o">=</span><span class="n">computed_sort_name_local_new</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="o">=</span><span class="n">error_message_detail</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>

                <span class="n">match_ratio</span> <span class="o">=</span> <span class="n">contributor_name_match_ratio</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">computed_sort_name_local_new</span><span class="p">,</span> <span class="n">normalize_names</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">match_ratio</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">):</span>
                    <span class="c1"># ask a human.  this kind of score can happen when the sort_name is a transliteration of the display_name,</span>
                    <span class="c1"># and is non-trivial to fix.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_local_mismatch</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">contribution</span><span class="o">=</span><span class="n">contribution</span><span class="p">,</span>
                        <span class="n">computed_sort_name</span><span class="o">=</span><span class="n">computed_sort_name_local_new</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="o">=</span><span class="n">error_message_detail</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we can fix it!</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="s2">local_fix&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">computed_sort_name_local_new</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_contributor_sort_name</span><span class="p">(</span><span class="n">computed_sort_name_local_new</span><span class="p">,</span> <span class="n">contribution</span><span class="p">)</span></div>


<div class="viewcode-block" id="CheckContributorNamesInDB.set_contributor_sort_name"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.set_contributor_sort_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_contributor_sort_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sort_name</span><span class="p">,</span> <span class="n">contribution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the contributor.sort_name and associated edition.author_name to the passed-in value. &quot;&quot;&quot;</span>
        <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span> <span class="o">=</span> <span class="n">sort_name</span>

        <span class="c1"># also change edition.sort_author, if the author was primary</span>
        <span class="c1"># Note: I considered using contribution.edition.author_contributors, but</span>
        <span class="c1"># found that it&#39;s not impossible to have a messy dataset that doesn&#39;t work on.</span>
        <span class="c1"># For our purpose here, the following logic is cleaner-acting:</span>
        <span class="c1"># If this author appears as Primary Author anywhere on the edition, then change edition.sort_author.</span>
        <span class="n">edition_contributions</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">contributions</span>
        <span class="k">for</span> <span class="n">edition_contribution</span> <span class="ow">in</span> <span class="n">edition_contributions</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">edition_contribution</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">edition_contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="o">==</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">)):</span>
                <span class="n">contribution</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="o">=</span> <span class="n">sort_name</span></div>


<div class="viewcode-block" id="CheckContributorNamesInDB.process_local_mismatch"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.process_local_mismatch">[docs]</a>    <span class="k">def</span> <span class="nf">process_local_mismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">contribution</span><span class="p">,</span> <span class="n">computed_sort_name</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if a problem is to be investigated further or recorded as a Complaint,</span>
<span class="sd">        to be solved by a human.  In this class, it&#39;s always a complaint.  In the overridden</span>
<span class="sd">        method in the child class in metadata_wrangler code, we sometimes go do a web query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_problem</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">COMPLAINT_SOURCE</span><span class="p">,</span> <span class="n">contribution</span><span class="o">=</span><span class="n">contribution</span><span class="p">,</span>
            <span class="n">computed_sort_name</span><span class="o">=</span><span class="n">computed_sort_name</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="o">=</span><span class="n">error_message_detail</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span></div>


<div class="viewcode-block" id="CheckContributorNamesInDB.register_problem"><a class="viewcode-back" href="../../core.html#core.scripts.CheckContributorNamesInDB.register_problem">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_problem</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">contribution</span><span class="p">,</span> <span class="n">computed_sort_name</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a Complaint in the database, so a human can take a look at this Contributor&#39;s name</span>
<span class="sd">        and resolve whatever the complex issue that got us here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">contributor</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span>

        <span class="n">pools</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">is_presentation_for</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">complaint</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Complaint</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pools</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COMPLAINT_TYPE</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">error_message_detail</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">|</span><span class="se">\t</span><span class="s2">complain|</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">computed_sort_name</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># log and move on, don&#39;t stop run</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error registering complaint: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">contributor</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">success</span></div></div>






<div class="viewcode-block" id="Explain"><a class="viewcode-back" href="../../core.html#core.scripts.Explain">[docs]</a><span class="k">class</span> <span class="nc">Explain</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Explain everything known about a given work.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Explain everything known about a given work&quot;</span>

    <span class="c1"># Where to go to get best available metadata about a work.</span>
    <span class="n">METADATA_URL_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;http://metadata.librarysimplified.org/lookup?urn=</span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">TIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span>

<div class="viewcode-block" id="Explain.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">param_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">identifier_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param_args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">]</span>
        <span class="n">editions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">primary_identifier_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span></div>

<div class="viewcode-block" id="Explain.write"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a string to self.stdout.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="Explain.explain"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">presentation_calculation_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">medium</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="s1">&#39;Audio&#39;</span><span class="p">):</span>
            <span class="c1"># we haven&#39;t yet decided what to display for you</span>
            <span class="k">return</span>

        <span class="c1"># Tell about the Edition record.</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) according to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Permanent work ID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">permanent_work_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Metadata URL: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">METADATA_URL_TEMPLATE</span> <span class="o">%</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">urn</span><span class="p">))</span>

        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explain_identifier</span><span class="p">(</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Find all contributions, and tell about the contributors.</span>
        <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">explain_contribution</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>

        <span class="c1"># Tell about the LicensePool.</span>
        <span class="n">lps</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">license_pools</span>
        <span class="k">if</span> <span class="n">lps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">lps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">explain_license_pool</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; No associated license pools.&quot;</span><span class="p">)</span>

        <span class="c1"># Tell about the Work.</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">work</span>
        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; No associated work.&quot;</span><span class="p">)</span>

        <span class="c1"># Note:  Can change DB state.</span>
        <span class="k">if</span> <span class="n">work</span> <span class="ow">and</span> <span class="n">presentation_calculation_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! About to calculate presentation!&quot;</span><span class="p">)</span>
             <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">presentation_calculation_policy</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! All done!&quot;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">()</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After recalculating presentation:&quot;</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">explain_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span></div>


<div class="viewcode-block" id="Explain.explain_contribution"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_contribution">[docs]</a>    <span class="k">def</span> <span class="nf">explain_contribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contribution</span><span class="p">):</span>
        <span class="n">contributor_id</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">id</span>
        <span class="n">contributor_sort_name</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span>
        <span class="n">contributor_display_name</span> <span class="o">=</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Contributor[</span><span class="si">%s</span><span class="s2">]: contributor_sort_name=</span><span class="si">%s</span><span class="s2">, contributor_display_name=</span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contributor_id</span><span class="p">,</span> <span class="n">contributor_sort_name</span><span class="p">,</span> <span class="n">contributor_display_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Explain.explain_identifier"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">explain_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">strength</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">primary</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="s2">&quot;Primary identifier&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="s2">&quot;Identifier&quot;</span>
        <span class="k">if</span> <span class="n">primary</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> (q=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">strength</span><span class="p">))</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">classifications</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">classifications_for_identifier_ids</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">classification</span> <span class="ow">in</span> <span class="n">classifications</span><span class="p">:</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">subject</span>
            <span class="n">genre</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">genre</span>
            <span class="k">if</span> <span class="n">genre</span><span class="p">:</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">genre</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="s2">&quot;(!genre)&quot;</span>
            <span class="c1">#print(&quot;%s  %s says: %s/%s %s w=%s&quot; % (</span>
            <span class="c1">#    indent, classification.data_source.name,</span>
            <span class="c1">#    subject.identifier, subject.name, genre, classification.weight</span>
            <span class="c1">#))</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">equivalency</span> <span class="ow">in</span> <span class="n">identifier</span><span class="o">.</span><span class="n">equivalencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">equivalency</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">equivalency</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">equivalency</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain_identifier</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span>
                                    <span class="n">equivalency</span><span class="o">.</span><span class="n">strength</span><span class="p">,</span> <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">primary</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">coverage_records</span>
            <span class="k">if</span> <span class="n">crs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%d</span><span class="s2"> coverage records:&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">crs</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">explain_coverage_record</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Explain.explain_license_pool"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_license_pool">[docs]</a>    <span class="k">def</span> <span class="nf">explain_license_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Licensepool info:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Collection: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
            <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">library</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">libraries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Available to libraries: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libraries</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Not available to any libraries!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Not in any collection!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Delivery mechanisms:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
                <span class="n">dm</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span>
                <span class="k">if</span> <span class="n">dm</span><span class="o">.</span><span class="n">default_client_can_fulfill</span><span class="p">:</span>
                    <span class="n">fulfillable</span> <span class="o">=</span> <span class="s2">&quot;Fulfillable&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fulfillable</span> <span class="o">=</span> <span class="s2">&quot;Unfulfillable&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fulfillable</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">drm_scheme</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; No delivery mechanisms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> owned, </span><span class="si">%d</span><span class="s2"> available, </span><span class="si">%d</span><span class="s2"> holds, </span><span class="si">%d</span><span class="s2"> reserves&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_reserved</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="Explain.explain_work"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_work">[docs]</a>    <span class="k">def</span> <span class="nf">explain_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Work info:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Identifier of presentation edition: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; No presentation edition.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Fiction: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">fiction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Audience: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Target age: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">target_age</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> genres.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">genres</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">genres</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">genre</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; License pools:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="n">active</span> <span class="o">=</span> <span class="s2">&quot;SUPERCEDED&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">superceded</span><span class="p">:</span>
                <span class="n">active</span> <span class="o">=</span> <span class="s2">&quot;ACTIVE&quot;</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;!collection&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">collection</span><span class="p">))</span>
        <span class="n">wcrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">coverage_records</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wcrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> work coverage records&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">wcrs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">wcr</span> <span class="ow">in</span> <span class="n">wcrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">explain_work_coverage_record</span><span class="p">(</span><span class="n">wcr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Explain.explain_coverage_record"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_coverage_record">[docs]</a>    <span class="k">def</span> <span class="nf">explain_coverage_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explain_coverage_record</span><span class="p">(</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">exception</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Explain.explain_work_coverage_record"><a class="viewcode-back" href="../../core.html#core.scripts.Explain.explain_work_coverage_record">[docs]</a>    <span class="k">def</span> <span class="nf">explain_work_coverage_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explain_coverage_record</span><span class="p">(</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">exception</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_explain_coverage_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span>
                                 <span class="n">status</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TIME_FORMAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_source</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="s1">&#39; | &#39;</span> <span class="o">+</span> <span class="n">exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">timestamp</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">exception</span>
        <span class="p">))</span></div>


<div class="viewcode-block" id="WhereAreMyBooksScript"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript">[docs]</a><span class="k">class</span> <span class="nc">WhereAreMyBooksScript</span><span class="p">(</span><span class="n">CollectionInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to figure out why Works aren&#39;t showing up.</span>

<span class="sd">    This is a common problem on a new installation or when a new collection</span>
<span class="sd">    is being configured.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WhereAreMyBooksScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="n">search</span> <span class="ow">or</span> <span class="n">ExternalSearchIndex</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CannotLoadConfiguration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;Here&#39;s your problem: the search integration is missing or misconfigured.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="WhereAreMyBooksScript.out"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript.out">[docs]</a>    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="WhereAreMyBooksScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Check each library.</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;There are no libraries in the system -- that&#39;s a problem.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_cached_feeds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collections</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WhereAreMyBooksScript.check_library"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript.check_library">[docs]</a>    <span class="k">def</span> <span class="nf">check_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure a library is properly set up to show works.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;Checking library </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Make sure it has collections.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; This library has no collections -- that&#39;s a problem.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; Associated with collection </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Make sure it has lanes.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; This library has no lanes -- that&#39;s a problem.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; Associated with </span><span class="si">%s</span><span class="s2"> lanes.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">lanes</span><span class="p">))</span></div>

<div class="viewcode-block" id="WhereAreMyBooksScript.delete_cached_feeds"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript.delete_cached_feeds">[docs]</a>    <span class="k">def</span> <span class="nf">delete_cached_feeds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">page_feeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CachedFeed</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CachedFeed</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">GROUPS_TYPE</span>
        <span class="p">)</span>
        <span class="n">page_feeds_count</span> <span class="o">=</span> <span class="n">page_feeds</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> feeds in cachedfeeds table, not counting grouped feeds.&quot;</span><span class="p">,</span> <span class="n">page_feeds_count</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">page_feeds_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; Deleting them all.&quot;</span><span class="p">)</span>
            <span class="n">page_feeds</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="WhereAreMyBooksScript.explain_collection"><a class="viewcode-back" href="../../core.html#core.scripts.WhereAreMyBooksScript.explain_collection">[docs]</a>    <span class="k">def</span> <span class="nf">explain_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;Examining collection &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection</span><span class="o">==</span><span class="n">collection</span>
        <span class="p">)</span>

        <span class="n">ready</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">presentation_ready</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unready</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">presentation_ready</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ready_count</span> <span class="o">=</span> <span class="n">ready</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">unready_count</span> <span class="o">=</span> <span class="n">unready</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> presentation-ready works.&quot;</span><span class="p">,</span> <span class="n">ready_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> works not presentation-ready.&quot;</span><span class="p">,</span> <span class="n">unready_count</span><span class="p">)</span>

        <span class="c1"># Check if the works have delivery mechanisms.</span>
        <span class="n">LPDM</span> <span class="o">=</span> <span class="n">LicensePoolDeliveryMechanism</span>
        <span class="n">no_delivery_mechanisms</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="o">~</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">data_source_id</span><span class="o">==</span><span class="n">LPDM</span><span class="o">.</span><span class="n">data_source_id</span><span class="p">,</span>
                     <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span><span class="o">==</span><span class="n">LPDM</span><span class="o">.</span><span class="n">identifier_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">no_delivery_mechanisms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span>
                <span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> works are missing delivery mechanisms and won&#39;t show up.&quot;</span><span class="p">,</span>
                <span class="n">no_delivery_mechanisms</span>
            <span class="p">)</span>

        <span class="c1"># Check if the license pools are suppressed.</span>
        <span class="n">suppressed</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">suppressed</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">suppressed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span>
                <span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> works have suppressed LicensePools and won&#39;t show up.&quot;</span><span class="p">,</span>
                <span class="n">suppressed</span>
            <span class="p">)</span>

        <span class="c1"># Check if the pools have available licenses.</span>
        <span class="n">not_owned</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">not_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span>
                <span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> non-open-access works have no owned licenses and won&#39;t show up.&quot;</span><span class="p">,</span>
                <span class="n">not_owned</span>
            <span class="p">)</span>

        <span class="nb">filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="n">collection</span><span class="p">])</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">count_works</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span>
            <span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> works in the search index, expected around </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">ready_count</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="ListCollectionMetadataIdentifiersScript"><a class="viewcode-back" href="../../core.html#core.scripts.ListCollectionMetadataIdentifiersScript">[docs]</a><span class="k">class</span> <span class="nc">ListCollectionMetadataIdentifiersScript</span><span class="p">(</span><span class="n">CollectionInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List the metadata identifiers for Collections in the database.</span>

<span class="sd">    This script is helpful for accounting for and tracking collections on</span>
<span class="sd">    the metadata wrangler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ListCollectionMetadataIdentifiersScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<div class="viewcode-block" id="ListCollectionMetadataIdentifiersScript.run"><a class="viewcode-back" href="../../core.html#core.scripts.ListCollectionMetadataIdentifiersScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_run</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ListCollectionMetadataIdentifiersScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.ListCollectionMetadataIdentifiersScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">collection_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">collection_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">]</span>

        <span class="n">collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collection_ids</span><span class="p">:</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">collection_ids</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;COLLECTIONS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">metadata_identifier</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> =&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">metadata_identifier</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                <span class="c1"># Add a format line.</span>
                <span class="n">add_line</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_identifier&#39;</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">add_line</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">metadata_identifier</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%d</span><span class="s1"> collections found.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateLaneSizeScript"><a class="viewcode-back" href="../../core.html#core.scripts.UpdateLaneSizeScript">[docs]</a><span class="k">class</span> <span class="nc">UpdateLaneSizeScript</span><span class="p">(</span><span class="n">LaneSweeperScript</span><span class="p">):</span>

<div class="viewcode-block" id="UpdateLaneSizeScript.should_process_lane"><a class="viewcode-back" href="../../core.html#core.scripts.UpdateLaneSizeScript.should_process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We don&#39;t want to process generic WorkLists -- there&#39;s nowhere</span>
<span class="sd">        to store the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateLaneSizeScript.process_lane"><a class="viewcode-back" href="../../core.html#core.scripts.UpdateLaneSizeScript.process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the estimated size of a Lane.&quot;&quot;&quot;</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">update_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">full_identifier</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateCustomListSizeScript"><a class="viewcode-back" href="../../core.html#core.scripts.UpdateCustomListSizeScript">[docs]</a><span class="k">class</span> <span class="nc">UpdateCustomListSizeScript</span><span class="p">(</span><span class="n">CustomListSweeperScript</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateCustomListSizeScript.process_custom_list"><a class="viewcode-back" href="../../core.html#core.scripts.UpdateCustomListSizeScript.process_custom_list">[docs]</a>    <span class="k">def</span> <span class="nf">process_custom_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_list</span><span class="p">):</span>
        <span class="n">custom_list</span><span class="o">.</span><span class="n">update_size</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RemovesSearchCoverage"><a class="viewcode-back" href="../../core.html#core.scripts.RemovesSearchCoverage">[docs]</a><span class="k">class</span> <span class="nc">RemovesSearchCoverage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mix-in class for a script that might remove all coverage records</span>
<span class="sd">    for the search engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RemovesSearchCoverage.remove_search_coverage_records"><a class="viewcode-back" href="../../core.html#core.scripts.RemovesSearchCoverage.remove_search_coverage_records">[docs]</a>    <span class="k">def</span> <span class="nf">remove_search_coverage_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all search coverage records from the database.</span>

<span class="sd">        :return: The number of records deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wcr</span> <span class="o">=</span> <span class="n">WorkCoverageRecord</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="n">wcr</span><span class="o">.</span><span class="n">operation</span><span class="o">==</span><span class="n">wcr</span><span class="o">.</span><span class="n">UPDATE_SEARCH_INDEX_OPERATION</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">wcr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">wcr</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clause</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">count</span></div></div>


<div class="viewcode-block" id="RebuildSearchIndexScript"><a class="viewcode-back" href="../../core.html#core.scripts.RebuildSearchIndexScript">[docs]</a><span class="k">class</span> <span class="nc">RebuildSearchIndexScript</span><span class="p">(</span>
    <span class="n">RunWorkCoverageProviderScript</span><span class="p">,</span> <span class="n">RemovesSearchCoverage</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Completely delete the search index and recreate it.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search_index_client&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="n">search</span> <span class="ow">or</span> <span class="n">ExternalSearchIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RebuildSearchIndexScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">SearchIndexCoverageProvider</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RebuildSearchIndexScript.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.RebuildSearchIndexScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Calling setup_index will destroy the index and recreate it</span>
        <span class="c1"># empty.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">setup_index</span><span class="p">()</span>

        <span class="c1"># Remove all search coverage records so the</span>
        <span class="c1"># SearchIndexCoverageProvider will start from scratch.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_search_coverage_records</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted </span><span class="si">%d</span><span class="s2"> search coverage records.&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

        <span class="c1"># Now let the SearchIndexCoverageProvider do its thing.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RebuildSearchIndexScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">do_run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SearchIndexCoverageRemover"><a class="viewcode-back" href="../../core.html#core.scripts.SearchIndexCoverageRemover">[docs]</a><span class="k">class</span> <span class="nc">SearchIndexCoverageRemover</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">,</span> <span class="n">RemovesSearchCoverage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Script that removes search index coverage for all works.</span>

<span class="sd">    This guarantees the SearchIndexCoverageProvider will add</span>
<span class="sd">    fresh coverage for every Work the next time it runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SearchIndexCoverageRemover.do_run"><a class="viewcode-back" href="../../core.html#core.scripts.SearchIndexCoverageRemover.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_search_coverage_records</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span>
            <span class="n">achievements</span><span class="o">=</span><span class="s2">&quot;Coverage records deleted: </span><span class="si">%(deleted)d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">deleted</span><span class="o">=</span><span class="n">count</span>
            <span class="p">)</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="MockStdin"><a class="viewcode-back" href="../../core.html#core.scripts.MockStdin">[docs]</a><span class="k">class</span> <span class="nc">MockStdin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock a list of identifiers passed in on standard input.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>

<div class="viewcode-block" id="MockStdin.readlines"><a class="viewcode-back" href="../../core.html#core.scripts.MockStdin.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lines</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>