
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scripts &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for scripts</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime</span><span class="p">,</span>
    <span class="n">timedelta</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">or_</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">api.util.short_client_token</span> <span class="kn">import</span> <span class="n">ShortClientTokenUtility</span>
<span class="kn">from</span> <span class="nn">api.bibliotheca</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BibliothecaCirculationSweep</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">Configuration</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.controller</span> <span class="kn">import</span> <span class="n">CirculationManager</span>
<span class="kn">from</span> <span class="nn">api.lanes</span> <span class="kn">import</span> <span class="n">create_default_lanes</span>
<span class="kn">from</span> <span class="nn">api.local_analytics_exporter</span> <span class="kn">import</span> <span class="n">LocalAnalyticsExporter</span>
<span class="kn">from</span> <span class="nn">api.marc</span> <span class="kn">import</span> <span class="n">LibraryAnnotator</span> <span class="k">as</span> <span class="n">MARCLibraryAnnotator</span>
<span class="kn">from</span> <span class="nn">api.novelist</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoveListAPI</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.nyt</span> <span class="kn">import</span> <span class="n">NYTBestSellerAPI</span>
<span class="kn">from</span> <span class="nn">api.odl</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ODLImporter</span><span class="p">,</span>
    <span class="n">ODLImportMonitor</span><span class="p">,</span>
    <span class="n">SharedODLImporter</span><span class="p">,</span>
    <span class="n">SharedODLImportMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.onix</span> <span class="kn">import</span> <span class="n">ONIXExtractor</span>
<span class="kn">from</span> <span class="nn">api.opds_for_distributors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSForDistributorsImporter</span><span class="p">,</span>
    <span class="n">OPDSForDistributorsImportMonitor</span><span class="p">,</span>
    <span class="n">OPDSForDistributorsReaperMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.overdrive</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OverdriveAPI</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.entrypoint</span> <span class="kn">import</span> <span class="n">EntryPoint</span>
<span class="kn">from</span> <span class="nn">core.external_list</span> <span class="kn">import</span> <span class="n">CustomListFromCSV</span>
<span class="kn">from</span> <span class="nn">core.external_search</span> <span class="kn">import</span> <span class="n">ExternalSearchIndex</span>
<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="n">Lane</span>
<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Pagination</span><span class="p">,</span>
    <span class="n">Facets</span><span class="p">,</span>
    <span class="n">FeaturedFacets</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.marc</span> <span class="kn">import</span> <span class="n">MARCExporter</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="n">MARCExtractor</span>
<span class="kn">from</span> <span class="nn">core.mirror</span> <span class="kn">import</span> <span class="n">MirrorUploader</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CachedMARCFile</span><span class="p">,</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Contribution</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">Hold</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">SessionManager</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Timestamp</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">EditionConstants</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">core.opds</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AcquisitionFeed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.opds_import</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MetadataWranglerOPDSLookup</span><span class="p">,</span>
    <span class="n">OPDSImporter</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.scripts</span> <span class="kn">import</span> <span class="n">OPDSImportScript</span><span class="p">,</span> <span class="n">CollectionType</span>
<span class="kn">from</span> <span class="nn">core.scripts</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Script</span> <span class="k">as</span> <span class="n">CoreScript</span><span class="p">,</span>
    <span class="n">DatabaseMigrationInitializationScript</span><span class="p">,</span>
    <span class="n">IdentifierInputScript</span><span class="p">,</span>
    <span class="n">LaneSweeperScript</span><span class="p">,</span>
    <span class="n">LibraryInputScript</span><span class="p">,</span>
    <span class="n">PatronInputScript</span><span class="p">,</span>
    <span class="n">TimestampScript</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>
<span class="kn">from</span> <span class="nn">core.util.opds_writer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSFeed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>


<div class="viewcode-block" id="Script"><a class="viewcode-back" href="../scripts.html#scripts.Script">[docs]</a><span class="k">class</span> <span class="nc">Script</span><span class="p">(</span><span class="n">CoreScript</span><span class="p">):</span>
<div class="viewcode-block" id="Script.load_config"><a class="viewcode-back" href="../scripts.html#scripts.Script.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">:</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CreateWorksForIdentifiersScript"><a class="viewcode-back" href="../scripts.html#scripts.CreateWorksForIdentifiersScript">[docs]</a><span class="k">class</span> <span class="nc">CreateWorksForIdentifiersScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Do the bare minimum to associate each Identifier with an Edition</span>
<span class="sd">    with title and author, so that we can calculate a permanent work</span>
<span class="sd">    ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">Identifier</span><span class="o">.</span><span class="n">OVERDRIVE_ID</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">THREEM_ID</span><span class="p">,</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">GUTENBERG_ID</span><span class="p">]</span>
    <span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Create works for identifiers&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_web_app_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metadata_web_app_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">MetadataWranglerOPDSLookup</span><span class="p">(</span><span class="n">metadata_web_app_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">MetadataWranglerOPDSLookup</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="CreateWorksForIdentifiersScript.run"><a class="viewcode-back" href="../scripts.html#scripts.CreateWorksForIdentifiersScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># We will try to fill in Editions that are missing</span>
        <span class="c1"># title/author and as such have no permanent work ID.</span>
        <span class="c1">#</span>
        <span class="c1"># We will also try to create Editions for Identifiers that</span>
        <span class="c1"># have no Edition.</span>

        <span class="n">either_title_or_author_missing</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">edition_missing_title_or_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">primarily_identifies</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">either_title_or_author_missing</span><span class="p">)</span>

        <span class="n">no_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">primarily_identifies</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">descr</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">edition_missing_title_or_author</span><span class="p">,</span>
                 <span class="s2">&quot;identifiers whose edition is missing title or author&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">no_edition</span><span class="p">,</span> <span class="s2">&quot;identifiers with no edition&quot;</span><span class="p">)):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trying to fix </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">descr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BATCH_SIZE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="CreateWorksForIdentifiersScript.process_batch"><a class="viewcode-back" href="../scripts.html#scripts.CreateWorksForIdentifiersScript.process_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">!=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Wrong media type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content_type</span><span class="p">)</span>

        <span class="n">importer</span> <span class="o">=</span> <span class="n">OPDSImporter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="n">overwrite_rels</span><span class="o">=</span><span class="p">[</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">])</span>
        <span class="n">imported</span><span class="p">,</span> <span class="n">messages_by_id</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_from_feed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> successes, </span><span class="si">%d</span><span class="s2"> failures.&quot;</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">imported</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages_by_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="MetadataCalculationScript"><a class="viewcode-back" href="../scripts.html#scripts.MetadataCalculationScript">[docs]</a><span class="k">class</span> <span class="nc">MetadataCalculationScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Force calculate_presentation() to be called on some set of Editions.</span>

<span class="sd">    This assumes that the metadata is in already in the database and</span>
<span class="sd">    will fall into place if we just call</span>
<span class="sd">    Edition.calculate_presentation() and Edition.calculate_work() and</span>
<span class="sd">    Work.calculate_presentation().</span>

<span class="sd">    Most of these will be data repair scripts that do not need to be run</span>
<span class="sd">    regularly.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Metadata calculation script&quot;</span>

<div class="viewcode-block" id="MetadataCalculationScript.q"><a class="viewcode-back" href="../scripts.html#scripts.MetadataCalculationScript.q">[docs]</a>    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="MetadataCalculationScript.run"><a class="viewcode-back" href="../scripts.html#scripts.MetadataCalculationScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">()</span>
        <span class="n">search_index_client</span> <span class="o">=</span> <span class="n">ExternalSearchIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to repair metadata for </span><span class="si">%d</span><span class="s2"> works&quot;</span> <span class="o">%</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">also_created_work</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> successes, </span><span class="si">%d</span><span class="s2"> failures, </span><span class="si">%d</span><span class="s2"> new works.&quot;</span><span class="p">,</span>
                          <span class="n">success</span><span class="p">,</span> <span class="n">failure</span><span class="p">,</span> <span class="n">also_created_work</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">edition</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">edition</span><span class="o">.</span><span class="n">sort_author</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">work</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">(</span>
                    <span class="n">search_index_client</span><span class="o">=</span><span class="n">search_index_client</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                        <span class="n">also_created_work</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failure</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">checkpoint</span><span class="p">()</span>
        <span class="n">checkpoint</span><span class="p">()</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="FillInAuthorScript"><a class="viewcode-back" href="../scripts.html#scripts.FillInAuthorScript">[docs]</a><span class="k">class</span> <span class="nc">FillInAuthorScript</span><span class="p">(</span><span class="n">MetadataCalculationScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill in Edition.sort_author for Editions that have a list of</span>
<span class="sd">    Contributors, but no .sort_author.</span>

<span class="sd">    This is a data repair script that should not need to be run</span>
<span class="sd">    regularly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Fill in missing authors&quot;</span>

<div class="viewcode-block" id="FillInAuthorScript.q"><a class="viewcode-back" href="../scripts.html#scripts.FillInAuthorScript.q">[docs]</a>    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Contribution</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Edition</span><span class="o">.</span><span class="n">sort_author</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="UpdateStaffPicksScript"><a class="viewcode-back" href="../scripts.html#scripts.UpdateStaffPicksScript">[docs]</a><span class="k">class</span> <span class="nc">UpdateStaffPicksScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="n">DEFAULT_URL_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/</span><span class="si">%s</span><span class="s2">/export?format=csv&quot;</span>

<div class="viewcode-block" id="UpdateStaffPicksScript.run"><a class="viewcode-back" href="../scripts.html#scripts.UpdateStaffPicksScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="n">tag_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">Subject</span><span class="o">.</span><span class="n">NYPL_APPEAL</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">integ</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">integration</span><span class="p">(</span><span class="n">Configuration</span><span class="o">.</span><span class="n">STAFF_PICKS_INTEGRATION</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">integ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Configuration</span><span class="o">.</span><span class="n">LIST_FIELDS</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">importer</span> <span class="o">=</span> <span class="n">CustomListFromCSV</span><span class="p">(</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">,</span> <span class="n">CustomList</span><span class="o">.</span><span class="n">STAFF_PICKS_NAME</span><span class="p">,</span>
            <span class="o">**</span><span class="n">fields</span>
        <span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel-tab&#39;</span><span class="p">)</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">to_customlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Close existing database session and associated connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="UpdateStaffPicksScript.open"><a class="viewcode-back" href="../scripts.html#scripts.UpdateStaffPicksScript.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">integration_url</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">STAFF_PICKS_INTEGRATION</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_URL_TEMPLATE</span> <span class="o">%</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieving </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">representation</span><span class="p">,</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">browser_http_get</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">representation</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected status code </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="n">representation</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;text/csv&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected media type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="n">representation</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">representation</span><span class="o">.</span><span class="n">content</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CacheRepresentationPerLane"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane">[docs]</a><span class="k">class</span> <span class="nc">CacheRepresentationPerLane</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">,</span> <span class="n">LaneSweeperScript</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cache one representation per lane&quot;</span>

<div class="viewcode-block" id="CacheRepresentationPerLane.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">LaneSweeperScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--language&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process only lanes that include books in this language.&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--max-depth&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stop processing lanes once you reach this depth.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--min-depth&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Start processing lanes once you reach this depth.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param cmd_args: A mock set of command-line arguments, to use instead</span>
<span class="sd">           of looking at the actual command line.</span>
<span class="sd">        :param testing: If this method creates a CirculationManager object,</span>
<span class="sd">           this value will be passed in to its constructor as its value for</span>
<span class="sd">           `testing`.</span>
<span class="sd">        :param manager: A mock CirculationManager object, to use instead</span>
<span class="sd">           of creating a new one (creating a CirculationManager object is</span>
<span class="sd">           very time-consuming).</span>
<span class="sd">        :param *args: Positional arguments to pass to the superconstructor.</span>
<span class="sd">        :param **kwargs: Keyword arguments to pass to the superconstructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CacheRepresentationPerLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">CirculationManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="n">testing</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">api.app</span> <span class="kn">import</span> <span class="n">app</span>
        <span class="n">app</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">BASE_URL_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

<div class="viewcode-block" id="CacheRepresentationPerLane.parse_args"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.parse_args">[docs]</a>    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">string_to_alpha_3</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alpha</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignored unrecognized language code </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">min_depth</span>

        <span class="c1"># Return the parsed arguments in case a subclass needs to</span>
        <span class="c1"># process more args.</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.should_process_lane"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.should_process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">language_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
            <span class="c1"># We are considering lanes for every single language.</span>
            <span class="n">language_ok</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
            <span class="c1"># The lane has no language restrictions.</span>
            <span class="n">language_ok</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">languages</span><span class="p">:</span>
                <span class="n">language_ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">language_ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.cache_url"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.cache_url">[docs]</a>    <span class="k">def</span> <span class="nf">cache_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">languages</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.generate_representation"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.generate_representation">[docs]</a>    <span class="k">def</span> <span class="nf">generate_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="c1"># The generated document will probably be an OPDS acquisition</span>
    <span class="c1"># feed.</span>
    <span class="n">ACCEPT_HEADER</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span>

    <span class="n">cache_url_method</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CacheRepresentationPerLane.process_library"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CacheRepresentationPerLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Processed library </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%.2f</span><span class="s2">sec&quot;</span><span class="p">,</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">begin</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.process_lane"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a number of feeds for this lane.</span>
<span class="sd">        One feed will be generated for each combination of Facets and</span>
<span class="sd">        Pagination objects returned by facets() and pagination().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cached_feeds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">facets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pagination</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pagination</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
                <span class="n">extra_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
                    <span class="n">extra_description</span> <span class="o">+=</span> <span class="s2">&quot; Facets: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">facets</span><span class="o">.</span><span class="n">query_string</span>
                <span class="k">if</span> <span class="n">pagination</span><span class="p">:</span>
                    <span class="n">extra_description</span> <span class="o">+=</span> <span class="s2">&quot; Pagination: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">pagination</span><span class="o">.</span><span class="n">query_string</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Generating feed for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">full_identifier</span><span class="p">,</span>
                    <span class="n">extra_description</span>
                <span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_generate</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">feed</span><span class="p">:</span>
                    <span class="n">cached_feeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Took </span><span class="si">%.2f</span><span class="s2"> sec to make </span><span class="si">%d</span><span class="s2"> bytes.&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cached_feeds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached_feeds</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.facets"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.facets">[docs]</a>    <span class="k">def</span> <span class="nf">facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield a Facets object for each set of facets this</span>
<span class="sd">        script is expected to handle.</span>
<span class="sd">        :param lane: The lane under consideration. (Different lanes may have</span>
<span class="sd">        different available facets.)</span>
<span class="sd">        :yield: A sequence of Facets objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CacheRepresentationPerLane.pagination"><a class="viewcode-back" href="../scripts.html#scripts.CacheRepresentationPerLane.pagination">[docs]</a>    <span class="k">def</span> <span class="nf">pagination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield a Pagination object for each page of a feed this</span>
<span class="sd">        script is expected to handle.</span>
<span class="sd">        :param lane: The lane under consideration. (Different lanes may have</span>
<span class="sd">        different pagination rules.)</span>
<span class="sd">        :yield: A sequence of Pagination objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="CacheFacetListsPerLane"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane">[docs]</a><span class="k">class</span> <span class="nc">CacheFacetListsPerLane</span><span class="p">(</span><span class="n">CacheRepresentationPerLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cache the first two pages of every relevant facet list for this lane.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cache paginated OPDS feed for each lane&quot;</span>

<div class="viewcode-block" id="CacheFacetListsPerLane.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">CacheRepresentationPerLane</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">DEFAULT_ENABLED_FACETS</span><span class="p">[</span><span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">]</span>
        <span class="n">order_help</span> <span class="o">=</span> <span class="s1">&#39;Generate feeds for this ordering. Possible values: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--order&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">order_help</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>

        <span class="n">available</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">DEFAULT_ENABLED_FACETS</span><span class="p">[</span><span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">]</span>
        <span class="n">availability_help</span> <span class="o">=</span> <span class="s1">&#39;Generate feeds for this availability setting. Possible values: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--availability&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">availability_help</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>

        <span class="n">available</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">DEFAULT_ENABLED_FACETS</span><span class="p">[</span><span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span><span class="p">]</span>
        <span class="n">collection_help</span> <span class="o">=</span> <span class="s1">&#39;Generate feeds for this collection within each lane. Possible values: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--collection&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">collection_help</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>

        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">INTERNAL_NAME</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">ENTRY_POINTS</span><span class="p">]</span>
        <span class="n">entrypoint_help</span> <span class="o">=</span> <span class="s1">&#39;Generate feeds for this entry point within each lane. Possible values: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--entrypoint&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">entrypoint_help</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>

        <span class="n">default_pages</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--pages&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of pages to cache for each facet. Default: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">default_pages</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default_pages</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="CacheFacetListsPerLane.parse_args"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane.parse_args">[docs]</a>    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CacheFacetListsPerLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">availabilities</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrypoints</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">entrypoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="CacheFacetListsPerLane.facets"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane.facets">[docs]</a>    <span class="k">def</span> <span class="nf">facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This script covers a user-specified combination of facets, but it</span>
<span class="sd">        defaults to using every combination of available facets for</span>
<span class="sd">        the given lane with a certain sort order.</span>
<span class="sd">        This means every combination of availability, collection, and</span>
<span class="sd">        entry point.</span>
<span class="sd">        That&#39;s a whole lot of feeds, which is why this script isn&#39;t</span>
<span class="sd">        actually used -- by the time we generate all of then, they&#39;ve</span>
<span class="sd">        expired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">default_order</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span><span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">)</span>
        <span class="n">allowed_orders</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span><span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span><span class="p">)</span>
        <span class="n">chosen_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="ow">or</span> <span class="p">[</span><span class="n">default_order</span><span class="p">]</span>

        <span class="n">allowed_entrypoint_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">INTERNAL_NAME</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">entrypoints</span>
        <span class="p">]</span>
        <span class="n">default_entrypoint_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">allowed_entrypoint_names</span><span class="p">:</span>
            <span class="n">default_entrypoint_name</span> <span class="o">=</span> <span class="n">allowed_entrypoint_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">chosen_entrypoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoints</span> <span class="ow">or</span> <span class="n">allowed_entrypoint_names</span>

        <span class="n">default_availability</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">allowed_availabilities</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">chosen_availabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availabilities</span> <span class="ow">or</span> <span class="p">[</span><span class="n">default_availability</span><span class="p">]</span>

        <span class="n">default_collection</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">allowed_collections</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">enabled_facets</span><span class="p">(</span>
            <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span>
        <span class="p">)</span>
        <span class="n">chosen_collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span> <span class="ow">or</span> <span class="p">[</span><span class="n">default_collection</span><span class="p">]</span>

        <span class="n">top_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entrypoint_name</span> <span class="ow">in</span> <span class="n">chosen_entrypoints</span><span class="p">:</span>
            <span class="n">entrypoint</span> <span class="o">=</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">BY_INTERNAL_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entrypoint_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entrypoint</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring unknown entry point </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entrypoint_name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entrypoint_name</span> <span class="ow">in</span> <span class="n">allowed_entrypoint_names</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring disabled entry point </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entrypoint_name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">chosen_orders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_orders</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring unsupported ordering </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">order</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">availability</span> <span class="ow">in</span> <span class="n">chosen_availabilities</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">availability</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_availabilities</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring unsupported availability </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">availability</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">chosen_collections</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">collection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_collections</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring unsupported collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">collection</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">facets</span> <span class="o">=</span> <span class="n">Facets</span><span class="p">(</span>
                            <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                            <span class="n">availability</span><span class="o">=</span><span class="n">availability</span><span class="p">,</span>
                            <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">,</span>
                            <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="p">(</span>
                                <span class="n">top_level</span> <span class="ow">and</span>
                                <span class="n">entrypoint</span><span class="o">.</span><span class="n">INTERNAL_NAME</span> <span class="o">==</span> <span class="n">default_entrypoint_name</span>
                            <span class="p">),</span>
                            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">order_ascending</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="k">yield</span> <span class="n">facets</span></div>

<div class="viewcode-block" id="CacheFacetListsPerLane.pagination"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane.pagination">[docs]</a>    <span class="k">def</span> <span class="nf">pagination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This script covers a user-specified number of pages.&quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Pagination</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pagenum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">page</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">next_page</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="p">:</span>
                <span class="c1"># There aren&#39;t enough books to fill `self.pages`</span>
                <span class="c1"># pages. Stop working.</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="CacheFacetListsPerLane.do_generate"><a class="viewcode-back" href="../scripts.html#scripts.CacheFacetListsPerLane.do_generate">[docs]</a>    <span class="k">def</span> <span class="nf">do_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">feed_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">annotator</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">)</span>
        <span class="n">feed_class</span> <span class="o">=</span> <span class="n">feed_class</span> <span class="ow">or</span> <span class="n">AcquisitionFeed</span>
        <span class="k">return</span> <span class="n">feed_class</span><span class="o">.</span><span class="n">page</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="n">lane</span><span class="p">,</span>
            <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CacheOPDSGroupFeedPerLane"><a class="viewcode-back" href="../scripts.html#scripts.CacheOPDSGroupFeedPerLane">[docs]</a><span class="k">class</span> <span class="nc">CacheOPDSGroupFeedPerLane</span><span class="p">(</span><span class="n">CacheRepresentationPerLane</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cache OPDS grouped feed for each lane&quot;</span>

<div class="viewcode-block" id="CacheOPDSGroupFeedPerLane.should_process_lane"><a class="viewcode-back" href="../scripts.html#scripts.CacheOPDSGroupFeedPerLane.should_process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="c1"># OPDS grouped feeds are only generated for lanes that have sublanes.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CacheOPDSGroupFeedPerLane.do_generate"><a class="viewcode-back" href="../scripts.html#scripts.CacheOPDSGroupFeedPerLane.do_generate">[docs]</a>    <span class="k">def</span> <span class="nf">do_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">feed_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">annotator</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="n">feed_class</span> <span class="o">=</span> <span class="n">feed_class</span> <span class="ow">or</span> <span class="n">AcquisitionFeed</span>

        <span class="c1"># Since grouped feeds are only cached for lanes that have sublanes,</span>
        <span class="c1"># there&#39;s no need to consider the case of a lane with no sublanes,</span>
        <span class="c1"># unlike the corresponding code in OPDSFeedController.groups()</span>
        <span class="k">return</span> <span class="n">feed_class</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">worklist</span><span class="o">=</span><span class="n">lane</span><span class="p">,</span>
            <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CacheOPDSGroupFeedPerLane.facets"><a class="viewcode-back" href="../scripts.html#scripts.CacheOPDSGroupFeedPerLane.facets">[docs]</a>    <span class="k">def</span> <span class="nf">facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a Facets object for each of the library&#39;s enabled</span>
<span class="sd">        entrypoints.</span>
<span class="sd">        This is the only way grouped feeds are ever generated, so there is</span>
<span class="sd">        no way to override this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># If the WorkList has explicitly defined EntryPoints, we want to</span>
        <span class="c1"># create a grouped feed for each EntryPoint. Otherwise, we want</span>
        <span class="c1"># to create a single grouped feed with no particular EntryPoint.</span>
        <span class="c1">#</span>
        <span class="c1"># We use library.entrypoints instead of lane.entrypoints</span>
        <span class="c1"># because WorkList.entrypoints controls which entry points you</span>
        <span class="c1"># can *switch to* from a given WorkList. We&#39;re handling the</span>
        <span class="c1"># case where you switched further up the hierarchy and now</span>
        <span class="c1"># you&#39;re navigating downwards.</span>
        <span class="n">entrypoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">entrypoints</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">default_entrypoint</span> <span class="o">=</span> <span class="n">entrypoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entrypoint</span> <span class="ow">in</span> <span class="n">entrypoints</span><span class="p">:</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="n">FeaturedFacets</span><span class="p">(</span>
                <span class="n">minimum_featured_quality</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">minimum_featured_quality</span><span class="p">,</span>
                <span class="n">uses_customlists</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">uses_customlists</span><span class="p">,</span>
                <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">,</span>
                <span class="n">entrypoint_is_default</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">top_level</span> <span class="ow">and</span> <span class="n">entrypoint</span> <span class="ow">is</span> <span class="n">default_entrypoint</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">facets</span></div></div>

<div class="viewcode-block" id="CacheMARCFiles"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles">[docs]</a><span class="k">class</span> <span class="nc">CacheMARCFiles</span><span class="p">(</span><span class="n">LaneSweeperScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate and cache MARC files for each input library.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cache MARC files&quot;</span>

<div class="viewcode-block" id="CacheMARCFiles.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">LaneSweeperScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--max-depth&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stop processing lanes once you reach this depth.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--force&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Generate new MARC files even if MARC files have already been generated recently enough&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CacheMARCFiles</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>

<div class="viewcode-block" id="CacheMARCFiles.parse_args"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.parse_args">[docs]</a>    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">force</span>
        <span class="k">return</span> <span class="n">parsed</span></div>

<div class="viewcode-block" id="CacheMARCFiles.should_process_library"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.should_process_library">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">MARC_EXPORT</span><span class="p">,</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">CATALOG_GOAL</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">integration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="CacheMARCFiles.process_library"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_process_library</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CacheMARCFiles</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processed library </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="CacheMARCFiles.should_process_lane"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.should_process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">should_process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CacheMARCFiles.process_lane"><a class="viewcode-back" href="../scripts.html#scripts.CacheMARCFiles.process_lane">[docs]</a>    <span class="k">def</span> <span class="nf">process_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">exporter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Generate a MARC file for this lane, if one has not been generated recently enough.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">library</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="n">MARCLibraryAnnotator</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">exporter</span> <span class="o">=</span> <span class="n">exporter</span> <span class="ow">or</span> <span class="n">MARCExporter</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="n">update_frequency</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">MARCExporter</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">exporter</span><span class="o">.</span><span class="n">integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">int_value</span>
        <span class="k">if</span> <span class="n">update_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_frequency</span> <span class="o">=</span> <span class="n">MARCExporter</span><span class="o">.</span><span class="n">DEFAULT_UPDATE_FREQUENCY</span>

        <span class="n">last_update</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">files_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CachedMARCFile</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CachedMARCFile</span><span class="o">.</span><span class="n">library</span><span class="o">==</span><span class="n">library</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CachedMARCFile</span><span class="o">.</span><span class="n">lane</span><span class="o">==</span><span class="p">(</span><span class="n">lane</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">CachedMARCFile</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">files_q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_update</span> <span class="o">=</span> <span class="n">files_q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">end_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="ow">and</span> <span class="n">last_update</span> <span class="ow">and</span> <span class="p">(</span><span class="n">last_update</span> <span class="o">&gt;</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">update_frequency</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping lane </span><span class="si">%s</span><span class="s2"> because last update was less than </span><span class="si">%d</span><span class="s2"> days ago&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">update_frequency</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># To find the storage integration for the exporter, first find the</span>
        <span class="c1"># external integration link associated with the exporter&#39;s external</span>
        <span class="c1"># integration.</span>
        <span class="n">integration_link</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="p">,</span>
            <span class="n">external_integration_id</span><span class="o">=</span><span class="n">exporter</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">purpose</span><span class="o">=</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">MARC</span>
        <span class="p">)</span>
        <span class="c1"># Then use the &quot;other&quot; integration value to find the storage integration.</span>
        <span class="n">storage_integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">integration_link</span><span class="o">.</span><span class="n">other_integration_id</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">storage_integration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No storage External Integration was found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># First update the file with ALL the records.</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">records</span><span class="p">(</span>
            <span class="n">lane</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">storage_integration</span>
        <span class="p">)</span>

        <span class="c1"># Then create a new file with changes since the last update.</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">last_update</span><span class="p">:</span>
            <span class="c1"># Allow one day of overlap to ensure we don&#39;t miss anything due to script timing.</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">last_update</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">records</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">records</span><span class="p">(</span>
                <span class="n">lane</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">storage_integration</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="AdobeAccountIDResetScript"><a class="viewcode-back" href="../scripts.html#scripts.AdobeAccountIDResetScript">[docs]</a><span class="k">class</span> <span class="nc">AdobeAccountIDResetScript</span><span class="p">(</span><span class="n">PatronInputScript</span><span class="p">):</span>

<div class="viewcode-block" id="AdobeAccountIDResetScript.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.AdobeAccountIDResetScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AdobeAccountIDResetScript</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--delete&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Actually delete credentials as opposed to showing what would happen.&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="AdobeAccountIDResetScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.AdobeAccountIDResetScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">patrons</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">patrons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">delete</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;This is a dry run. Nothing will actually change in the database.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Run with --delete to change the database.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">patrons</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;This is not a drill.</span>
<span class="sd">Running this script will permanently disconnect %d patron(s) from their Adobe account IDs.</span>
<span class="sd">They will be unable to fulfill any existing loans that involve Adobe-encrypted files.</span>
<span class="sd">Sleeping for five seconds to give you a chance to back out.</span>
<span class="sd">You&#39;ll get another chance to back out before the database session is committed.&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">patrons</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_patrons</span><span class="p">(</span><span class="n">patrons</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All done. Sleeping for five seconds before committing.&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="AdobeAccountIDResetScript.process_patron"><a class="viewcode-back" href="../scripts.html#scripts.AdobeAccountIDResetScript.process_patron">[docs]</a>    <span class="k">def</span> <span class="nf">process_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all of a patron&#39;s Credentials that contain an Adobe account</span>
<span class="sd">        ID _or_ connect the patron to a DelegatedPatronIdentifier that</span>
<span class="sd">        contains an Adobe account ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Processing patron &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="ow">or</span> <span class="n">patron</span><span class="o">.</span><span class="n">username</span>
            <span class="ow">or</span> <span class="n">patron</span><span class="o">.</span><span class="n">external_identifier</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">credential</span> <span class="ow">in</span> <span class="n">ShortClientTokenUtility</span><span class="o">.</span><span class="n">adobe_relevant_credentials</span><span class="p">(</span><span class="n">patron</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39; Deleting &quot;</span><span class="si">%s</span><span class="s1">&quot; credential &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">credential</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">credential</span><span class="o">.</span><span class="n">credential</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">credential</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="AvailabilityRefreshScript"><a class="viewcode-back" href="../scripts.html#scripts.AvailabilityRefreshScript">[docs]</a><span class="k">class</span> <span class="nc">AvailabilityRefreshScript</span><span class="p">(</span><span class="n">IdentifierInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Refresh the availability information for a LicensePool, direct from the</span>
<span class="sd">    license source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AvailabilityRefreshScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.AvailabilityRefreshScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You must specify at least one identifier to refresh.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># We don&#39;t know exactly how big to make these batches, but 10 is</span>
        <span class="c1"># always safe.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_availability</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">size</span></div>

<div class="viewcode-block" id="AvailabilityRefreshScript.refresh_availability"><a class="viewcode-back" href="../scripts.html#scripts.AvailabilityRefreshScript.refresh_availability">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">Identifier</span><span class="o">.</span><span class="n">THREEM_ID</span><span class="p">:</span>
            <span class="n">sweeper</span> <span class="o">=</span> <span class="n">BibliothecaCirculationSweep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="n">sweeper</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">Identifier</span><span class="o">.</span><span class="n">OVERDRIVE_ID</span><span class="p">:</span>
            <span class="n">api</span> <span class="o">=</span> <span class="n">OverdriveAPI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
                <span class="n">api</span><span class="o">.</span><span class="n">update_licensepool</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">Axis360BibliographicCoverageProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot update coverage for </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LanguageListScript"><a class="viewcode-back" href="../scripts.html#scripts.LanguageListScript">[docs]</a><span class="k">class</span> <span class="nc">LanguageListScript</span><span class="p">(</span><span class="n">LibraryInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List all the languages with at least one non-open access work</span>
<span class="sd">    in the collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LanguageListScript.process_library"><a class="viewcode-back" href="../scripts.html#scripts.LanguageListScript.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanguageListScript.languages"><a class="viewcode-back" href="../scripts.html#scripts.LanguageListScript.languages">[docs]</a>    <span class="k">def</span> <span class="nf">languages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="s2">&quot;:yield: A list of output lines, one per language.&quot;</span>
        <span class="k">for</span> <span class="n">abbreviation</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">estimated_holdings_by_language</span><span class="p">(</span>
            <span class="n">include_open_access</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">name_for_languageset</span><span class="p">(</span><span class="n">abbreviation</span><span class="p">)</span>
            <span class="k">yield</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%i</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">abbreviation</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">display_name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CompileTranslationsScript"><a class="viewcode-back" href="../scripts.html#scripts.CompileTranslationsScript">[docs]</a><span class="k">class</span> <span class="nc">CompileTranslationsScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script to combine translation files for circulation, core</span>
<span class="sd">    and the admin interface, and compile the result to be used by the</span>
<span class="sd">    app. The combination step is necessary because Flask-Babel does not</span>
<span class="sd">    support multiple domains yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CompileTranslationsScript.run"><a class="viewcode-back" href="../scripts.html#scripts.CompileTranslationsScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">localization_languages</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;translations/</span><span class="si">%s</span><span class="s2">/LC_MESSAGES&quot;</span> <span class="o">%</span> <span class="n">language</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No translations for configured language </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">language</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm </span><span class="si">%(path)s</span><span class="s2">/messages.po&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">base_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">%(path)s</span><span class="s2">/*.po &gt; </span><span class="si">%(path)s</span><span class="s2">/messages.po&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">base_path</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pybabel compile -f -d translations&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InstanceInitializationScript"><a class="viewcode-back" href="../scripts.html#scripts.InstanceInitializationScript">[docs]</a><span class="k">class</span> <span class="nc">InstanceInitializationScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An idempotent script to initialize an instance of the Circulation Manager.</span>

<span class="sd">    This script is intended for use in servers, Docker containers, etc,</span>
<span class="sd">    when the Circulation Manager app is being installed. It initializes</span>
<span class="sd">    the database and sets an appropriate alias on the ElasticSearch index.</span>

<span class="sd">    Because it&#39;s currently run every time a container is started, it must</span>
<span class="sd">    remain idempotent.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Instance initialization&quot;</span>

    <span class="n">TEST_SQL</span> <span class="o">=</span> <span class="s2">&quot;select * from timestamps limit 1&quot;</span>

<div class="viewcode-block" id="InstanceInitializationScript.run"><a class="viewcode-back" href="../scripts.html#scripts.InstanceInitializationScript.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Create a special database session that doesn&#39;t initialize</span>
        <span class="c1"># the ORM -- this could be fatal if there are migration</span>
        <span class="c1"># scripts that haven&#39;t run yet.</span>
        <span class="c1">#</span>
        <span class="c1"># In fact, we don&#39;t even initialize the database schema,</span>
        <span class="c1"># because that&#39;s the thing we&#39;re trying to check for.</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">database_url</span><span class="p">()</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">SessionManager</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">initialize_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_schema</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We need to check for the existence of a known table --</span>
            <span class="c1"># this will demonstrate that this script has been run before --</span>
            <span class="c1"># but we don&#39;t need to actually look at what we get from the</span>
            <span class="c1"># database.</span>
            <span class="c1">#</span>
            <span class="c1"># Basically, if this succeeds, we can bail out and not run</span>
            <span class="c1"># the rest of the script.</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_SQL</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This did _not_ succeed, so the schema is probably not</span>
            <span class="c1"># initialized and we do need to run this script.. This</span>
            <span class="c1"># database session is useless now, but we&#39;ll create a new</span>
            <span class="c1"># one during the super() call, and use that one to do the</span>
            <span class="c1"># work.</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">InstanceInitializationScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I think this site has already been initialized; doing nothing.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInitializationScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.InstanceInitializationScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_search</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Creates a &quot;-current&quot; alias on the Elasticsearch client.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_search</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">search_client</span> <span class="o">=</span> <span class="n">ExternalSearchIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Elasticsearch isn&#39;t configured, so do nothing.</span>
                <span class="k">pass</span>

        <span class="c1"># Set a timestamp that represents the new database&#39;s version.</span>
        <span class="n">db_init_script</span> <span class="o">=</span> <span class="n">DatabaseMigrationInitializationScript</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">db_init_script</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">service_type</span><span class="o">=</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">SCRIPT_TYPE</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="c1"># No need to run the script. We already have a timestamp.</span>
            <span class="k">return</span>
        <span class="n">db_init_script</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="c1"># Create a secret key if one doesn&#39;t already exist.</span>
        <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide_secret</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">SECRET_KEY</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LoanReaperScript"><a class="viewcode-back" href="../scripts.html#scripts.LoanReaperScript">[docs]</a><span class="k">class</span> <span class="nc">LoanReaperScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove expired loans and holds whose owners have not yet synced</span>
<span class="sd">    with the loan providers.</span>

<span class="sd">    This stops the library from keeping a record of the final loans and</span>
<span class="sd">    holds of a patron who stopped using the circulation manager.</span>

<span class="sd">    If a loan or (more likely) hold is removed incorrectly, it will be</span>
<span class="sd">    restored the next time the patron syncs their loans feed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Remove expired loans and holds from local database&quot;</span>

<div class="viewcode-block" id="LoanReaperScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.LoanReaperScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>

        <span class="c1"># Reap loans and holds that we know have expired.</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">what</span> <span class="ow">in</span> <span class="p">((</span><span class="n">Loan</span><span class="p">,</span> <span class="s1">&#39;loans&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">Hold</span><span class="p">,</span> <span class="s1">&#39;holds&#39;</span><span class="p">)):</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reap</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="s2">&quot;expired </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">what</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">max_age</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">Loan</span><span class="p">,</span> <span class="s1">&#39;loans&#39;</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">Hold</span><span class="p">,</span> <span class="s1">&#39;holds&#39;</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)),</span>
        <span class="p">):</span>
            <span class="c1"># Reap loans and holds which have no end date and are very</span>
            <span class="c1"># old. It&#39;s very likely these loans and holds have expired</span>
            <span class="c1"># and we simply don&#39;t have the information.</span>
            <span class="n">older_than</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">max_age</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">older_than</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">False</span>
                    <span class="p">)</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> older than </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">what</span><span class="p">,</span> <span class="n">older_than</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reap</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span> <span class="n">explain</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_reap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qu</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete every database object that matches the given query.</span>

<span class="sd">        :param qu: The query that yields objects to delete.</span>
<span class="sd">        :param what: A human-readable explanation of what&#39;s being</span>
<span class="sd">                     deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reaping </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qu</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">what</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">counter</span> <span class="o">%</span> <span class="mi">100</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="DisappearingBookReportScript"><a class="viewcode-back" href="../scripts.html#scripts.DisappearingBookReportScript">[docs]</a><span class="k">class</span> <span class="nc">DisappearingBookReportScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Print a TSV-format report on books that used to be in the</span>
<span class="sd">    collection, or should be in the collection, but aren&#39;t.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DisappearingBookReportScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.DisappearingBookReportScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">suppressed</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                        <span class="n">LicensePool</span><span class="o">.</span><span class="n">availability_time</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Identifier&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Title&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Author&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;First seen&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Last seen (best guess)&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Current licenses owned&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Current licenses available&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Changes in number of licenses&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Changes in title availability&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_row</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span></div>

<div class="viewcode-block" id="DisappearingBookReportScript.investigate"><a class="viewcode-back" href="../scripts.html#scripts.DisappearingBookReportScript.investigate">[docs]</a>    <span class="k">def</span> <span class="nf">investigate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find when the given LicensePool might have disappeared from the</span>
<span class="sd">        collection.</span>

<span class="sd">        :param licensepool: A LicensePool.</span>

<span class="sd">        :return: a 3-tuple (last_seen, title_removal_events,</span>
<span class="sd">            license_removal_events).</span>

<span class="sd">        `last_seen` is the latest point at which we knew the book was</span>
<span class="sd">        circulating. If we never knew the book to be circulating, this</span>
<span class="sd">        is the first time we ever saw the LicensePool.</span>

<span class="sd">        `title_removal_events` is a query that returns CirculationEvents</span>
<span class="sd">        in which this LicensePool was removed from the remote collection.</span>

<span class="sd">        `license_removal_events` is a query that returns</span>
<span class="sd">        CirculationEvents in which LicensePool.licenses_owned went</span>
<span class="sd">        from having a positive number to being zero or a negative</span>
<span class="sd">        number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_activity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">most_recent_activity</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If we have absolutely no information about the book ever</span>
        <span class="c1"># circulating, we act like we lost track of the book</span>
        <span class="c1"># immediately after seeing it for the first time.</span>
        <span class="n">last_seen</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">availability_time</span>

        <span class="c1"># If there&#39;s a recorded loan or hold on the book, that can</span>
        <span class="c1"># push up the last time the book was known to be circulating.</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">licensepool</span><span class="o">.</span><span class="n">loans</span><span class="p">,</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">holds</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last_seen</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">last_seen</span><span class="p">:</span>
                    <span class="n">last_seen</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span>

        <span class="c1"># Now we look for relevant circulation events. First, an event</span>
        <span class="c1"># where the title was explicitly removed is pretty clearly</span>
        <span class="c1"># a &#39;last seen&#39;.</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CirculationEvent</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">license_pool</span><span class="o">==</span><span class="n">licensepool</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="n">title_removal_events</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_TITLE_REMOVE</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">title_removal_events</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">title_removal_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_seen</span> <span class="ow">or</span> <span class="n">candidate</span> <span class="o">&gt;</span> <span class="n">last_seen</span><span class="p">:</span>
                <span class="n">last_seen</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="c1"># Also look for an event where the title went from a nonzero</span>
        <span class="c1"># number of licenses to a zero number of licenses. That&#39;s a</span>
        <span class="c1"># good &#39;last seen&#39;.</span>
        <span class="n">license_removal_events</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_REMOVE</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">old_value</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">new_value</span><span class="o">&lt;=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">license_removal_events</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">license_removal_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_seen</span> <span class="ow">or</span> <span class="n">candidate</span> <span class="o">&gt;</span> <span class="n">last_seen</span><span class="p">:</span>
                <span class="n">last_seen</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="k">return</span> <span class="n">last_seen</span><span class="p">,</span> <span class="n">title_removal_events</span><span class="p">,</span> <span class="n">license_removal_events</span></div>

    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="DisappearingBookReportScript.explain"><a class="viewcode-back" href="../scripts.html#scripts.DisappearingBookReportScript.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">edition</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">presentation_edition</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">last_seen</span><span class="p">,</span> <span class="n">title_removal_events</span><span class="p">,</span> <span class="n">license_removal_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">investigate</span><span class="p">(</span>
            <span class="n">licensepool</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">edition</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">edition</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">author</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">availability_time</span><span class="p">:</span>
            <span class="n">first_seen</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">availability_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_seen</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_seen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_seen</span><span class="p">:</span>
            <span class="n">last_seen</span> <span class="o">=</span> <span class="n">last_seen</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_seen</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_seen</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">)</span>

        <span class="n">license_removals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">license_removal_events</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">→</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">),</span> <span class="n">event</span><span class="o">.</span><span class="n">old_value</span><span class="p">,</span>
                <span class="n">event</span><span class="o">.</span><span class="n">new_value</span>
            <span class="p">)</span>
            <span class="n">license_removals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">license_removals</span><span class="p">))</span>

        <span class="n">title_removals</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">title_removal_events</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title_removals</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="NYTBestSellerListsScript"><a class="viewcode-back" href="../scripts.html#scripts.NYTBestSellerListsScript">[docs]</a><span class="k">class</span> <span class="nc">NYTBestSellerListsScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Update New York Times best-seller lists&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_history</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NYTBestSellerListsScript</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_history</span> <span class="o">=</span> <span class="n">include_history</span>

<div class="viewcode-block" id="NYTBestSellerListsScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.NYTBestSellerListsScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">NYTBestSellerAPI</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">NYT</span><span class="p">)</span>
        <span class="c1"># For every best-seller list...</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">list_of_lists</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;list_name_encoded&#39;</span><span class="p">]):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;list_name_encoded&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Handling list </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">best_seller_list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">fill_in_history</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>

            <span class="c1"># Mirror the list to the database.</span>
            <span class="n">customlist</span> <span class="o">=</span> <span class="n">best</span><span class="o">.</span><span class="n">to_customlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Now </span><span class="si">%s</span><span class="s2"> entries in the list.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">customlist</span><span class="o">.</span><span class="n">entries</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="OPDSForDistributorsImportScript"><a class="viewcode-back" href="../scripts.html#scripts.OPDSForDistributorsImportScript">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsImportScript</span><span class="p">(</span><span class="n">OPDSImportScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import all books from the OPDS feed associated with a collection</span>
<span class="sd">    that requires authentication.&quot;&quot;&quot;</span>

    <span class="n">IMPORTER_CLASS</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImporter</span>
    <span class="n">MONITOR_CLASS</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImportMonitor</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImporter</span><span class="o">.</span><span class="n">NAME</span></div>

<div class="viewcode-block" id="OPDSForDistributorsReaperScript"><a class="viewcode-back" href="../scripts.html#scripts.OPDSForDistributorsReaperScript">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsReaperScript</span><span class="p">(</span><span class="n">OPDSImportScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get all books from the OPDS feed associated with a collection</span>
<span class="sd">    to find out if any have been removed.&quot;&quot;&quot;</span>

    <span class="n">IMPORTER_CLASS</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImporter</span>
    <span class="n">MONITOR_CLASS</span> <span class="o">=</span> <span class="n">OPDSForDistributorsReaperMonitor</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImporter</span><span class="o">.</span><span class="n">NAME</span></div>


<div class="viewcode-block" id="DirectoryImportScript"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript">[docs]</a><span class="k">class</span> <span class="nc">DirectoryImportScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import some books into a collection, based on a file containing</span>
<span class="sd">    metadata and directories containing ebook and cover files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Import new titles from a directory on disk&quot;</span>

<div class="viewcode-block" id="DirectoryImportScript.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--collection-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Titles will be imported into a collection with this name. The collection will be created if it does not already exist.&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--collection-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Collection type. Valid values are: OPEN_ACCESS (default), PROTECTED_ACCESS, LCP.&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">CollectionType</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CollectionType</span><span class="p">),</span>
            <span class="n">default</span><span class="o">=</span><span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--data-source-name&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;All data associated with this import activity will be recorded as originating with this data source. The data source will be created if it does not already exist.&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--metadata-file&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to a file containing MARC or ONIX 3.0 metadata for every title in the collection&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--metadata-format&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Format of the metadata file (&quot;marc&quot; or &quot;onix&quot;)&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;marc&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--cover-directory&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory containing a full-size cover image for every title in the collection.&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--ebook-directory&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory containing an EPUB or PDF file for every title in the collection.&#39;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="n">RightsStatus</span>
        <span class="n">rights_uris</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RS</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--rights-uri&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A URI explaining the rights status of the works being uploaded. Acceptable values: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rights_uris</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--dry-run&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show what would be imported, but don&#39;t actually do the import.&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--default-medium-type&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Default medium type used in the case when it</span><span class="se">\&#39;</span><span class="s1">s not explicitly specified in a metadata file. &#39;</span>
                 <span class="s1">&#39;Valid values are: </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EditionConstants</span><span class="o">.</span><span class="n">FULFILLABLE_MEDIA</span><span class="p">)),</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">EditionConstants</span><span class="o">.</span><span class="n">FULFILLABLE_MEDIA</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="DirectoryImportScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collection_name</span>
        <span class="n">collection_type</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">collection_type</span>
        <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">data_source_name</span>
        <span class="n">metadata_file</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">metadata_file</span>
        <span class="n">metadata_format</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">metadata_format</span>
        <span class="n">cover_directory</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">cover_directory</span>
        <span class="n">ebook_directory</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">ebook_directory</span>
        <span class="n">rights_uri</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">rights_uri</span>
        <span class="n">dry_run</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">dry_run</span>
        <span class="n">default_medium_type</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">default_medium_type</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_with_arguments</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">collection_type</span><span class="o">=</span><span class="n">collection_type</span><span class="p">,</span>
            <span class="n">data_source_name</span><span class="o">=</span><span class="n">data_source_name</span><span class="p">,</span>
            <span class="n">metadata_file</span><span class="o">=</span><span class="n">metadata_file</span><span class="p">,</span>
            <span class="n">metadata_format</span><span class="o">=</span><span class="n">metadata_format</span><span class="p">,</span>
            <span class="n">cover_directory</span><span class="o">=</span><span class="n">cover_directory</span><span class="p">,</span>
            <span class="n">ebook_directory</span><span class="o">=</span><span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
            <span class="n">default_medium_type</span><span class="o">=</span><span class="n">default_medium_type</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DirectoryImportScript.run_with_arguments"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.run_with_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">run_with_arguments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="p">,</span>
            <span class="n">collection_type</span><span class="p">,</span>
            <span class="n">data_source_name</span><span class="p">,</span>
            <span class="n">metadata_file</span><span class="p">,</span>
            <span class="n">metadata_format</span><span class="p">,</span>
            <span class="n">cover_directory</span><span class="p">,</span>
            <span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">rights_uri</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="p">,</span>
            <span class="n">default_medium_type</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;This is a dry run. No files will be uploaded and nothing will change in the database.&quot;</span>
            <span class="p">)</span>

        <span class="n">collection</span><span class="p">,</span> <span class="n">mirrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mirrors</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_collection</span> <span class="o">=</span> <span class="n">collection</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">mirrors</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">self_hosted_collection</span> <span class="o">=</span> <span class="n">collection_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">,</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">PROTECTED_ACCESS</span><span class="p">)</span>
        <span class="n">replacement_policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="o">.</span><span class="n">from_license_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">replacement_policy</span><span class="o">.</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">mirrors</span>
        <span class="n">metadata_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">(</span><span class="n">metadata_file</span><span class="p">,</span> <span class="n">metadata_format</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_medium_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_records</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">licensepool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_from_metadata</span><span class="p">(</span>
                <span class="n">collection</span><span class="p">,</span>
                <span class="n">collection_type</span><span class="p">,</span>
                <span class="n">metadata</span><span class="p">,</span>
                <span class="n">replacement_policy</span><span class="p">,</span>
                <span class="n">cover_directory</span><span class="p">,</span>
                <span class="n">ebook_directory</span><span class="p">,</span>
                <span class="n">rights_uri</span>
            <span class="p">)</span>

            <span class="n">licensepool</span><span class="o">.</span><span class="n">self_hosted</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">self_hosted_collection</span> <span class="k">else</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="DirectoryImportScript.load_collection"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.load_collection">[docs]</a>    <span class="k">def</span> <span class="nf">load_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locate a Collection with the given name.</span>

<span class="sd">        If the collection is found, it will be associated</span>
<span class="sd">        with the given data source and configured with existing</span>
<span class="sd">        covers and books mirror configurations.</span>

<span class="sd">        :param collection_name: Name of the Collection.</span>
<span class="sd">        :type collection_name: string</span>

<span class="sd">        :param collection_type: Type of the collection: open access/proteceted access.</span>
<span class="sd">        :type collection_name: CollectionType</span>

<span class="sd">        :param data_source_name: Associate this data source with</span>
<span class="sd">            the Collection if it does not already have a data source.</span>
<span class="sd">            A DataSource object will be created if necessary.</span>
<span class="sd">        :type data_source_name: string</span>

<span class="sd">        :return: A 2-tuple (Collection, list of MirrorUploader instances)</span>
<span class="sd">        :rtype: Tuple[core.model.collection.Collection, List[MirrorUploader]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_name_and_protocol</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">LCP</span> <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">LCP</span> <span class="k">else</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">MANUAL</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;An existing collection must be used and should be set up before running this script.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">mirrors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">covers_mirror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">books_mirror</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">,</span>
            <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span>
            <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
            <span class="k">else</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">PROTECTED_ACCESS_BOOKS</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">mirror_for_type</span> <span class="o">=</span> <span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mirror_for_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;An existing </span><span class="si">%s</span><span class="s2"> mirror integration should be assigned to the collection before running the script.&quot;</span> <span class="o">%</span> <span class="nb">type</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">mirrors</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mirror_for_type</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">offers_licenses</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">set_setting</span><span class="p">(</span>
            <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">,</span> <span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">mirrors</span></div>

<div class="viewcode-block" id="DirectoryImportScript.load_metadata"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.load_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_file</span><span class="p">,</span> <span class="n">metadata_format</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_medium_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a metadata file and convert the data into Metadata records.&quot;&quot;&quot;</span>
        <span class="n">metadata_records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s1">&#39;marc&#39;</span><span class="p">:</span>
            <span class="n">extractor</span> <span class="o">=</span> <span class="n">MARCExtractor</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s1">&#39;onix&#39;</span><span class="p">:</span>
            <span class="n">extractor</span> <span class="o">=</span> <span class="n">ONIXExtractor</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metadata_records</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extractor</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">data_source_name</span><span class="p">,</span> <span class="n">default_medium_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">metadata_records</span></div>

<div class="viewcode-block" id="DirectoryImportScript.work_from_metadata"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.work_from_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">work_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a Work instance from metadata</span>

<span class="sd">        :param collection: Target collection</span>
<span class="sd">        :type collection: core.model.collection.Collection</span>

<span class="sd">        :param collection_type: Collection&#39;s type: open access/protected access</span>
<span class="sd">        :type collection_type: CollectionType</span>

<span class="sd">        :param metadata: Book&#39;s metadata</span>
<span class="sd">        :type metadata: core.metadata_layer.Metadata</span>

<span class="sd">        :param policy: Replacement policy</span>
<span class="sd">        :type policy: ReplacementPolicy</span>

<span class="sd">        :return: A 2-tuple of (Work object, LicensePool object)</span>
<span class="sd">        :rtype: Tuple[core.model.work.Work, LicensePool]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_metadata</span><span class="p">(</span><span class="n">collection_type</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="p">:</span>
            <span class="c1"># We cannot actually provide access to the book so there</span>
            <span class="c1"># is no point in proceeding with the import.</span>
            <span class="k">return</span>

        <span class="n">edition</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">edition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">license_pools</span>
                  <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">collection</span> <span class="o">==</span> <span class="n">collection</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created new edition for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating existing edition for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="n">work</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">calculate_work</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_presentation_ready</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;FINALIZED </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">sort_author</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">work</span><span class="p">,</span> <span class="n">pool</span></div>

<div class="viewcode-block" id="DirectoryImportScript.annotate_metadata"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.annotate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_metadata</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">collection_type</span><span class="p">,</span>
            <span class="n">metadata</span><span class="p">,</span>
            <span class="n">policy</span><span class="p">,</span>
            <span class="n">cover_directory</span><span class="p">,</span>
            <span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">rights_uri</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a CirculationData and possibly an extra LinkData to `metadata`</span>

<span class="sd">        :param collection_type: Collection&#39;s type: open access/protected access</span>
<span class="sd">        :type collection_type: CollectionType</span>

<span class="sd">        :param metadata: Book&#39;s metadata</span>
<span class="sd">        :type metadata: core.metadata_layer.Metadata</span>

<span class="sd">        :param policy: Replacement policy</span>
<span class="sd">        :type policy: ReplacementPolicy</span>

<span class="sd">        :param cover_directory: Directory containing book covers</span>
<span class="sd">        :type cover_directory: string</span>

<span class="sd">        :param ebook_directory: Directory containing books</span>
<span class="sd">        :type ebook_directory: string</span>

<span class="sd">        :param rights_uri: URI explaining the rights status of the works being uploaded</span>
<span class="sd">        :type rights_uri: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">data_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">mirrors</span>

        <span class="n">circulation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_circulation_data</span><span class="p">(</span>
            <span class="n">collection_type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="p">,</span>
            <span class="n">data_source</span><span class="p">,</span>
            <span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">rights_uri</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">circulation_data</span><span class="p">:</span>
            <span class="c1"># There is no point in contining.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="p">:</span>
            <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">licenses_owned</span>
            <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">licenses_available</span>
            <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">licenses_reserved</span>
            <span class="n">circulation_data</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span>
            <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">licenses</span>

        <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulation_data</span>

        <span class="c1"># If a cover image is available, add it to the Metadata</span>
        <span class="c1"># as a link.</span>
        <span class="n">cover_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cover_directory</span><span class="p">:</span>
            <span class="n">cover_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cover_link</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">cover_directory</span><span class="p">,</span> <span class="n">mirrors</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">cover_link</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_link</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Proceeding with import even though </span><span class="si">%r</span><span class="s2"> has no cover.&quot;</span><span class="p">,</span>
                <span class="n">identifier</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DirectoryImportScript.load_circulation_data"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.load_circulation_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_circulation_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">collection_type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="p">,</span>
            <span class="n">data_source</span><span class="p">,</span>
            <span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="p">,</span>
            <span class="n">title</span><span class="p">,</span>
            <span class="n">rights_uri</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads an actual copy of a book from disk</span>

<span class="sd">        :param collection_type: Collection&#39;s type: open access/protected access</span>
<span class="sd">        :type collection_type: CollectionType</span>

<span class="sd">        :param identifier: Book&#39;s identifier</span>
<span class="sd">        :type identifier: core.model.identifier.Identifier,</span>

<span class="sd">        :param data_source: DataSource object</span>
<span class="sd">        :type data_source: DataSource</span>

<span class="sd">        :param ebook_directory: Directory containing books</span>
<span class="sd">        :type ebook_directory: string</span>

<span class="sd">        :param mirrors: Dictionary containing mirrors for books and their covers</span>
<span class="sd">        :type mirrors: Dict[string, MirrorUploader]</span>

<span class="sd">        :param title: Book&#39;s title</span>
<span class="sd">        :type title: string</span>

<span class="sd">        :param rights_uri: URI explaining the rights status of the works being uploaded</span>
<span class="sd">        :type rights_uri: string</span>

<span class="sd">        :return: A CirculationData that contains the book as an open-access</span>
<span class="sd">            download, or None if no such book can be found</span>
<span class="sd">        :rtype: CirculationData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ignore</span><span class="p">,</span> <span class="n">book_media_type</span><span class="p">,</span> <span class="n">book_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locate_file</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">ebook_directory</span><span class="p">,</span>
            <span class="n">Representation</span><span class="o">.</span><span class="n">COMMON_EBOOK_EXTENSIONS</span><span class="p">,</span>
            <span class="s2">&quot;ebook file&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">book_content</span><span class="p">:</span>
            <span class="c1"># We couldn&#39;t find an actual copy of the book, so there is</span>
            <span class="c1"># no point in proceeding.</span>
            <span class="k">return</span>

        <span class="n">book_mirror</span> <span class="o">=</span> <span class="n">mirrors</span><span class="p">[</span>
            <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS</span>
            <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span>
            <span class="k">else</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">PROTECTED_ACCESS_BOOKS</span>
        <span class="p">]</span> <span class="k">if</span> <span class="n">mirrors</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Use the S3 storage for books.</span>
        <span class="k">if</span> <span class="n">book_mirror</span><span class="p">:</span>
            <span class="n">book_url</span> <span class="o">=</span> <span class="n">book_mirror</span><span class="o">.</span><span class="n">book_url</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span>
                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">Representation</span><span class="o">.</span><span class="n">FILE_EXTENSIONS</span><span class="p">[</span><span class="n">book_media_type</span><span class="p">],</span>
                <span class="n">open_access</span><span class="o">=</span><span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">,</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is a dry run and we won&#39;t be mirroring anything.</span>
            <span class="n">book_url</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">Representation</span><span class="o">.</span><span class="n">FILE_EXTENSIONS</span><span class="p">[</span><span class="n">book_media_type</span><span class="p">]</span>

        <span class="n">book_link_rel</span> <span class="o">=</span> \
            <span class="n">Hyperlink</span><span class="o">.</span><span class="n">OPEN_ACCESS_DOWNLOAD</span> \
            <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">OPEN_ACCESS</span> \
            <span class="k">else</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">GENERIC_OPDS_ACQUISITION</span>
        <span class="n">book_link</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">book_link_rel</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="n">book_url</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">book_media_type</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">book_content</span>
        <span class="p">)</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FormatData</span><span class="p">(</span>
                <span class="n">content_type</span><span class="o">=</span><span class="n">book_media_type</span><span class="p">,</span>
                <span class="n">drm_scheme</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">LCP_DRM</span> <span class="k">if</span> <span class="n">collection_type</span> <span class="o">==</span> <span class="n">CollectionType</span><span class="o">.</span><span class="n">LCP</span> <span class="k">else</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="n">book_link</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">circulation_data</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="p">[</span><span class="n">book_link</span><span class="p">],</span>
            <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
            <span class="n">default_rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">circulation_data</span></div>

<div class="viewcode-block" id="DirectoryImportScript.load_cover_link"><a class="viewcode-back" href="../scripts.html#scripts.DirectoryImportScript.load_cover_link">[docs]</a>    <span class="k">def</span> <span class="nf">load_cover_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">cover_directory</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load an actual book cover from disk.</span>
<span class="sd">        </span>
<span class="sd">        :return: A LinkData containing a cover of the book, or None</span>
<span class="sd">            if no book cover can be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cover_filename</span><span class="p">,</span> <span class="n">cover_media_type</span><span class="p">,</span> <span class="n">cover_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locate_file</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">cover_directory</span><span class="p">,</span>
            <span class="n">Representation</span><span class="o">.</span><span class="n">COMMON_IMAGE_EXTENSIONS</span><span class="p">,</span> <span class="s2">&quot;cover image&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cover_content</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cover_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
            <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">Representation</span><span class="o">.</span><span class="n">FILE_EXTENSIONS</span><span class="p">[</span><span class="n">cover_media_type</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Use an S3 storage mirror for specifically for covers.</span>
        <span class="k">if</span> <span class="n">mirrors</span> <span class="ow">and</span> <span class="n">mirrors</span><span class="p">[</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">]:</span>
            <span class="n">cover_url</span> <span class="o">=</span> <span class="n">mirrors</span><span class="p">[</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">]</span><span class="o">.</span><span class="n">cover_image_url</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">cover_filename</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is a dry run and we won&#39;t be mirroring anything.</span>
            <span class="n">cover_url</span> <span class="o">=</span> <span class="n">cover_filename</span>

        <span class="n">cover_link</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="n">cover_url</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">cover_media_type</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">cover_content</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cover_link</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_locate_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">base_filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">extensions</span><span class="p">,</span>
                     <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">mock_filesystem_operations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find an acceptable file in the given directory.</span>

<span class="sd">        :param base_filename: A string to be used as the base of the filename.</span>

<span class="sd">        :param directory: Look for a file in this directory.</span>

<span class="sd">        :param extensions: Any of these extensions for the file is</span>
<span class="sd">        acceptable.</span>

<span class="sd">        :param file_type: Human-readable description of the type of</span>
<span class="sd">            file we&#39;re looking for. This is used only in a log warning if</span>
<span class="sd">            no file can be found.</span>

<span class="sd">        :param mock_filesystem_operations: A test may pass in a</span>
<span class="sd">            2-tuple of functions to replace os.path.exists and the &#39;open&#39;</span>
<span class="sd">            function.</span>

<span class="sd">        :return: A 3-tuple. (None, None, None) if no file can be</span>
<span class="sd">            found; otherwise (filename, media_type, contents).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mock_filesystem_operations</span><span class="p">:</span>
            <span class="n">exists_f</span><span class="p">,</span> <span class="n">open_f</span> <span class="o">=</span> <span class="n">mock_filesystem_operations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exists_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span>
            <span class="n">open_f</span> <span class="o">=</span> <span class="nb">open</span>

        <span class="n">success_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">extension</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">base_filename</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exists_f</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">MEDIA_TYPE_FOR_EXTENSION</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">with</span> <span class="n">open_f</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">filename</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="n">content</span>

        <span class="c1"># If we went through that whole loop without returning,</span>
        <span class="c1"># we have failed.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Could not find </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">. Looked in: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">file_type</span><span class="p">,</span> <span class="n">base_filename</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="LaneResetScript"><a class="viewcode-back" href="../scripts.html#scripts.LaneResetScript">[docs]</a><span class="k">class</span> <span class="nc">LaneResetScript</span><span class="p">(</span><span class="n">LibraryInputScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset a library&#39;s lanes based on language configuration or estimates</span>
<span class="sd">    of the library&#39;s current collection.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LaneResetScript.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.LaneResetScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">LibraryInputScript</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--reset&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Actually reset the lanes as opposed to showing what would happen.&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="LaneResetScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.LaneResetScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">reset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;This is a dry run. Nothing will actually change in the database.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Run with --reset to change the database.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">libraries</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;This is not a drill.</span>
<span class="sd">Running this script will permanently reset the lanes for %d libraries. Any lanes created from</span>
<span class="sd">custom lists will be deleted (though the lists themselves will be preserved).</span>
<span class="sd">Sleeping for five seconds to give you a chance to back out.</span>
<span class="sd">You&#39;ll get another chance to back out before the database session is committed.&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">libraries</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_libraries</span><span class="p">(</span><span class="n">libraries</span><span class="p">)</span>

        <span class="n">new_lane_output</span> <span class="o">=</span> <span class="s2">&quot;New Lane Configuration:&quot;</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="n">new_lane_output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Library &#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span>

            <span class="k">def</span> <span class="nf">print_lanes_for_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">library</span><span class="o">==</span><span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
                <span class="n">lane_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">:</span>
                    <span class="n">lane_output</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">parentage</span><span class="p">)))</span>  <span class="o">+</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">lane_output</span> <span class="o">+=</span> <span class="n">print_lanes_for_parent</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lane_output</span>

            <span class="n">new_lane_output</span> <span class="o">+=</span> <span class="n">print_lanes_for_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lane_output</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All done. Sleeping for five seconds before committing.&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="LaneResetScript.process_library"><a class="viewcode-back" href="../scripts.html#scripts.LaneResetScript.process_library">[docs]</a>    <span class="k">def</span> <span class="nf">process_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">create_default_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="NovelistSnapshotScript"><a class="viewcode-back" href="../scripts.html#scripts.NovelistSnapshotScript">[docs]</a><span class="k">class</span> <span class="nc">NovelistSnapshotScript</span><span class="p">(</span><span class="n">TimestampScript</span><span class="p">,</span> <span class="n">LibraryInputScript</span><span class="p">):</span>

<div class="viewcode-block" id="NovelistSnapshotScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.NovelistSnapshotScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api</span> <span class="o">=</span> <span class="n">NoveListAPI</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">api</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">put_items_novelist</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;NoveList API Response</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ODLImportScript"><a class="viewcode-back" href="../scripts.html#scripts.ODLImportScript">[docs]</a><span class="k">class</span> <span class="nc">ODLImportScript</span><span class="p">(</span><span class="n">OPDSImportScript</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import information from the feed associated</span>
<span class="sd">    with an ODL collection.&quot;&quot;&quot;</span>

    <span class="n">IMPORTER_CLASS</span> <span class="o">=</span> <span class="n">ODLImporter</span>
    <span class="n">MONITOR_CLASS</span> <span class="o">=</span> <span class="n">ODLImportMonitor</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ODLImporter</span><span class="o">.</span><span class="n">NAME</span></div>

<div class="viewcode-block" id="SharedODLImportScript"><a class="viewcode-back" href="../scripts.html#scripts.SharedODLImportScript">[docs]</a><span class="k">class</span> <span class="nc">SharedODLImportScript</span><span class="p">(</span><span class="n">OPDSImportScript</span><span class="p">):</span>
    <span class="n">IMPORTER_CLASS</span> <span class="o">=</span> <span class="n">SharedODLImporter</span>
    <span class="n">MONITOR_CLASS</span> <span class="o">=</span> <span class="n">SharedODLImportMonitor</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">SharedODLImporter</span><span class="o">.</span><span class="n">NAME</span></div>

<div class="viewcode-block" id="LocalAnalyticsExportScript"><a class="viewcode-back" href="../scripts.html#scripts.LocalAnalyticsExportScript">[docs]</a><span class="k">class</span> <span class="nc">LocalAnalyticsExportScript</span><span class="p">(</span><span class="n">Script</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Export circulation events for a date range to a CSV file.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LocalAnalyticsExportScript.arg_parser"><a class="viewcode-back" href="../scripts.html#scripts.LocalAnalyticsExportScript.arg_parser">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">arg_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--start&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Include circulation events that happened at or after this time.&quot;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--end&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Include circulation events that happened before this time.&quot;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="LocalAnalyticsExportScript.do_run"><a class="viewcode-back" href="../scripts.html#scripts.LocalAnalyticsExportScript.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exporter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">start</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">end</span>

        <span class="n">exporter</span> <span class="o">=</span> <span class="n">exporter</span> <span class="ow">or</span> <span class="n">LocalAnalyticsExporter</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exporter</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>