
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>dateutil.tz.tz &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dateutil.tz.tz</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module offers timezone implementations subclassing the abstract</span>
<span class="sd">:py:class:`datetime.tzinfo` type. There are classes to handle tzfile format</span>
<span class="sd">files (usually are in :file:`/etc/localtime`, :file:`/usr/share/zoneinfo`,</span>
<span class="sd">etc), TZ environment string (in all known formats), given ranges (with help</span>
<span class="sd">from relative deltas), local machine timezone, fixed offset timezone, and UTC</span>
<span class="sd">timezone.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">_thread</span>
<span class="kn">from</span> <span class="nn">._common</span> <span class="kn">import</span> <span class="n">tzname_in_python2</span><span class="p">,</span> <span class="n">_tzinfo</span>
<span class="kn">from</span> <span class="nn">._common</span> <span class="kn">import</span> <span class="n">tzrangebase</span><span class="p">,</span> <span class="n">enfold</span>
<span class="kn">from</span> <span class="nn">._common</span> <span class="kn">import</span> <span class="n">_validate_fromutc_inputs</span>

<span class="kn">from</span> <span class="nn">._factories</span> <span class="kn">import</span> <span class="n">_TzSingleton</span><span class="p">,</span> <span class="n">_TzOffsetFactory</span>
<span class="kn">from</span> <span class="nn">._factories</span> <span class="kn">import</span> <span class="n">_TzStrFactory</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.win</span> <span class="kn">import</span> <span class="n">tzwin</span><span class="p">,</span> <span class="n">tzwinlocal</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tzwin</span> <span class="o">=</span> <span class="n">tzwinlocal</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># For warning about rounding tzinfo</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="n">ZERO</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">EPOCH</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">EPOCHORDINAL</span> <span class="o">=</span> <span class="n">EPOCH</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">_TzSingleton</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">tzutc</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a tzinfo object that represents the UTC time zone.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; from datetime import *</span>
<span class="sd">        &gt;&gt;&gt; from dateutil.tz import *</span>

<span class="sd">        &gt;&gt;&gt; datetime.now()</span>
<span class="sd">        datetime.datetime(2003, 9, 27, 9, 40, 1, 521290)</span>

<span class="sd">        &gt;&gt;&gt; datetime.now(tzutc())</span>
<span class="sd">        datetime.datetime(2003, 9, 27, 12, 40, 12, 156379, tzinfo=tzutc())</span>

<span class="sd">        &gt;&gt;&gt; datetime.now(tzutc()).tzname()</span>
<span class="sd">        &#39;UTC&#39;</span>

<span class="sd">    .. versionchanged:: 2.7.0</span>
<span class="sd">        ``tzutc()`` is now a singleton, so the result of ``tzutc()`` will</span>
<span class="sd">        always return the same object.</span>

<span class="sd">        .. doctest::</span>

<span class="sd">            &gt;&gt;&gt; from dateutil.tz import tzutc, UTC</span>
<span class="sd">            &gt;&gt;&gt; tzutc() is tzutc()</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; tzutc() is UTC</span>
<span class="sd">            True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span>

    <span class="nd">@tzname_in_python2</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;UTC&quot;</span>

    <span class="k">def</span> <span class="nf">is_ambiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not the &quot;wall time&quot; of a given datetime is ambiguous in this</span>
<span class="sd">        zone.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            A :py:class:`datetime.datetime`, naive or time zone aware.</span>


<span class="sd">        :return:</span>
<span class="sd">            Returns ``True`` if ambiguous, ``False`` otherwise.</span>

<span class="sd">        .. versionadded:: 2.6.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@_validate_fromutc_inputs</span>
    <span class="k">def</span> <span class="nf">fromutc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fast track version of fromutc() returns the original ``dt`` object for</span>
<span class="sd">        any valid :py:class:`datetime.datetime` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dt</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">tzutc</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzutc</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_offset</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">))</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">()&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span>


<span class="c1">#: Convenience constant providing a :class:`tzutc()` instance</span>
<span class="c1">#:</span>
<span class="c1">#: .. versionadded:: 2.7.0</span>
<span class="n">UTC</span> <span class="o">=</span> <span class="n">tzutc</span><span class="p">()</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">_TzOffsetFactory</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">tzoffset</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple class for representing a fixed offset from UTC.</span>

<span class="sd">    :param name:</span>
<span class="sd">        The timezone name, to be returned when ``tzname()`` is called.</span>
<span class="sd">    :param offset:</span>
<span class="sd">        The time zone offset in seconds, or (since version 2.6.0, represented</span>
<span class="sd">        as a :py:class:`datetime.timedelta` object).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Allow a timedelta</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">_get_supported_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span>

    <span class="nd">@tzname_in_python2</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@_validate_fromutc_inputs</span>
    <span class="k">def</span> <span class="nf">fromutc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>

    <span class="k">def</span> <span class="nf">is_ambiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not the &quot;wall time&quot; of a given datetime is ambiguous in this</span>
<span class="sd">        zone.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            A :py:class:`datetime.datetime`, naive or time zone aware.</span>
<span class="sd">        :return:</span>
<span class="sd">            Returns ``True`` if ambiguous, ``False`` otherwise.</span>

<span class="sd">        .. versionadded:: 2.6.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_offset</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
                               <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span>


<span class="k">class</span> <span class="nc">tzlocal</span><span class="p">(</span><span class="n">_tzinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`tzinfo` subclass built around the ``time`` timezone functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">daylight</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">time</span><span class="o">.</span><span class="n">altzone</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dst_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dst_saved</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tznames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">tzname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

    <span class="nd">@tzname_in_python2</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tznames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">is_ambiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not the &quot;wall time&quot; of a given datetime is ambiguous in this</span>
<span class="sd">        zone.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            A :py:class:`datetime.datetime`, naive or time zone aware.</span>


<span class="sd">        :return:</span>
<span class="sd">            Returns ``True`` if ambiguous, ``False`` otherwise.</span>

<span class="sd">        .. versionadded:: 2.6.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">naive_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive_is_dst</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">naive_dst</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">naive_dst</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive_is_dst</span><span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_saved</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_naive_is_dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">_datetime_to_timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span><span class="o">.</span><span class="n">tm_isdst</span>

    <span class="k">def</span> <span class="nf">_isdst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fold_naive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># We can&#39;t use mktime here. It is unstable when deciding if</span>
        <span class="c1"># the hour near to a change is DST or not.</span>
        <span class="c1">#</span>
        <span class="c1"># timestamp = time.mktime((dt.year, dt.month, dt.day, dt.hour,</span>
        <span class="c1">#                         dt.minute, dt.second, dt.weekday(), 0, -1))</span>
        <span class="c1"># return time.localtime(timestamp).tm_isdst</span>
        <span class="c1">#</span>
        <span class="c1"># The code above yields the following result:</span>
        <span class="c1">#</span>
        <span class="c1"># &gt;&gt;&gt; import tz, datetime</span>
        <span class="c1"># &gt;&gt;&gt; t = tz.tzlocal()</span>
        <span class="c1"># &gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1"># &#39;BRDT&#39;</span>
        <span class="c1"># &gt;&gt;&gt; datetime.datetime(2003,2,16,0,tzinfo=t).tzname()</span>
        <span class="c1"># &#39;BRST&#39;</span>
        <span class="c1"># &gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1"># &#39;BRST&#39;</span>
        <span class="c1"># &gt;&gt;&gt; datetime.datetime(2003,2,15,22,tzinfo=t).tzname()</span>
        <span class="c1"># &#39;BRDT&#39;</span>
        <span class="c1"># &gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1"># &#39;BRDT&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># Here is a more stable implementation:</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for ambiguous times:</span>
        <span class="n">dstval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive_is_dst</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">fold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ambiguous</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">dstval</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzlocal</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_offset</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_offset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzutc</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tznames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="s1">&#39;GMT&#39;</span><span class="p">}</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasdst</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tznames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">()&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span>


<span class="k">class</span> <span class="nc">_ttinfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="s2">&quot;isdst&quot;</span><span class="p">,</span> <span class="s2">&quot;abbr&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;isstd&quot;</span><span class="p">,</span> <span class="s2">&quot;isgmt&quot;</span><span class="p">,</span> <span class="s2">&quot;dstoffset&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_ttinfo</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">delta</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isdst</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isdst</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isstd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isstd</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isgmt</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isgmt</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dstoffset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dstoffset</span><span class="p">)</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">_tzfile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lightweight class for holding the relevant transition and time zone</span>
<span class="sd">    information read from binary tzfiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trans_list&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_list_utc&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;ttinfo_list&#39;</span><span class="p">,</span>
             <span class="s1">&#39;ttinfo_std&#39;</span><span class="p">,</span> <span class="s1">&#39;ttinfo_dst&#39;</span><span class="p">,</span> <span class="s1">&#39;ttinfo_before&#39;</span><span class="p">,</span> <span class="s1">&#39;ttinfo_first&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">tzfile</span><span class="p">(</span><span class="n">_tzinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a ``tzinfo`` subclass that allows one to use the ``tzfile(5)``</span>
<span class="sd">    format timezone files to extract current and historical zone information.</span>

<span class="sd">    :param fileobj:</span>
<span class="sd">        This can be an opened file stream or a file name that the time zone</span>
<span class="sd">        information can be read from.</span>

<span class="sd">    :param filename:</span>
<span class="sd">        This is an optional parameter specifying the source of the time zone</span>
<span class="sd">        information in the event that ``fileobj`` is a file object. If omitted</span>
<span class="sd">        and ``fileobj`` is a file stream, this parameter will be set either to</span>
<span class="sd">        ``fileobj``&#39;s ``name`` attribute or to ``repr(fileobj)``.</span>

<span class="sd">    See `Sources for Time Zone and Daylight Saving Time Data</span>
<span class="sd">    &lt;https://data.iana.org/time-zones/tz-link.html&gt;`_ for more information.</span>
<span class="sd">    Time zone files can be compiled from the `IANA Time Zone database files</span>
<span class="sd">    &lt;https://www.iana.org/time-zones&gt;`_ with the `zic time zone compiler</span>
<span class="sd">    &lt;https://www.freebsd.org/cgi/man.cgi?query=zic&amp;sektion=8&gt;`_</span>

<span class="sd">    .. note::</span>

<span class="sd">        Only construct a ``tzfile`` directly if you have a specific timezone</span>
<span class="sd">        file on disk that you want to read into a Python ``tzinfo`` object.</span>
<span class="sd">        If you want to get a ``tzfile`` representing a specific IANA zone,</span>
<span class="sd">        (e.g. ``&#39;America/New_York&#39;``), you should call</span>
<span class="sd">        :func:`dateutil.tz.gettz` with the zone identifier.</span>


<span class="sd">    **Examples:**</span>

<span class="sd">    Using the US Eastern time zone as an example, we can see that a ``tzfile``</span>
<span class="sd">    provides time zone information for the standard Daylight Saving offsets:</span>

<span class="sd">    .. testsetup:: tzfile</span>

<span class="sd">        from dateutil.tz import gettz</span>
<span class="sd">        from datetime import datetime</span>

<span class="sd">    .. doctest:: tzfile</span>

<span class="sd">        &gt;&gt;&gt; NYC = gettz(&#39;America/New_York&#39;)</span>
<span class="sd">        &gt;&gt;&gt; NYC</span>
<span class="sd">        tzfile(&#39;/usr/share/zoneinfo/America/New_York&#39;)</span>

<span class="sd">        &gt;&gt;&gt; print(datetime(2016, 1, 3, tzinfo=NYC))     # EST</span>
<span class="sd">        2016-01-03 00:00:00-05:00</span>

<span class="sd">        &gt;&gt;&gt; print(datetime(2016, 7, 7, tzinfo=NYC))     # EDT</span>
<span class="sd">        2016-07-07 00:00:00-04:00</span>


<span class="sd">    The ``tzfile`` structure contains a fully history of the time zone,</span>
<span class="sd">    so historical dates will also have the right offsets. For example, before</span>
<span class="sd">    the adoption of the UTC standards, New York used local solar  mean time:</span>

<span class="sd">    .. doctest:: tzfile</span>

<span class="sd">       &gt;&gt;&gt; print(datetime(1901, 4, 12, tzinfo=NYC))    # LMT</span>
<span class="sd">       1901-04-12 00:00:00-04:56</span>

<span class="sd">    And during World War II, New York was on &quot;Eastern War Time&quot;, which was a</span>
<span class="sd">    state of permanent daylight saving time:</span>

<span class="sd">    .. doctest:: tzfile</span>

<span class="sd">        &gt;&gt;&gt; print(datetime(1944, 2, 7, tzinfo=NYC))    # EWT</span>
<span class="sd">        1944-02-07 00:00:00-04:00</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">tzfile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">file_opened_here</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">fileobj</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">file_opened_here</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_opened_here</span><span class="p">:</span>
                <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_nullcontext</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">fileobj</span> <span class="k">as</span> <span class="n">file_stream</span><span class="p">:</span>
                <span class="n">tzobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_tzfile</span><span class="p">(</span><span class="n">file_stream</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_tzdata</span><span class="p">(</span><span class="n">tzobj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_tzdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzobj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the time zone data of this object from a _tzfile object &quot;&quot;&quot;</span>
        <span class="c1"># Copy the relevant attributes over as private attributes</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_tzfile</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tzobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_read_tzfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_tzfile</span><span class="p">()</span>

        <span class="c1"># From tzfile(5):</span>
        <span class="c1">#</span>
        <span class="c1"># The time zone information files used by tzset(3)</span>
        <span class="c1"># begin with the magic characters &quot;TZif&quot; to identify</span>
        <span class="c1"># them as time zone information files, followed by</span>
        <span class="c1"># sixteen bytes reserved for future use, followed by</span>
        <span class="c1"># six four-byte values of type long, written in a</span>
        <span class="c1"># ``standard&#39;&#39; byte order (the high-order  byte</span>
        <span class="c1"># of the value is written first).</span>
        <span class="k">if</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;TZif&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;magic not found&quot;</span><span class="p">)</span>

        <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="c1"># The number of UTC/local indicators stored in the file.</span>
            <span class="n">ttisgmtcnt</span><span class="p">,</span>

            <span class="c1"># The number of standard/wall indicators stored in the file.</span>
            <span class="n">ttisstdcnt</span><span class="p">,</span>

            <span class="c1"># The number of leap seconds for which data is</span>
            <span class="c1"># stored in the file.</span>
            <span class="n">leapcnt</span><span class="p">,</span>

            <span class="c1"># The number of &quot;transition times&quot; for which data</span>
            <span class="c1"># is stored in the file.</span>
            <span class="n">timecnt</span><span class="p">,</span>

            <span class="c1"># The number of &quot;local time types&quot; for which data</span>
            <span class="c1"># is stored in the file (must not be zero).</span>
            <span class="n">typecnt</span><span class="p">,</span>

            <span class="c1"># The  number  of  characters  of &quot;time zone</span>
            <span class="c1"># abbreviation strings&quot; stored in the file.</span>
            <span class="n">charcnt</span><span class="p">,</span>

        <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;6l&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>

        <span class="c1"># The above header is followed by tzh_timecnt four-byte</span>
        <span class="c1"># values  of  type long,  sorted  in ascending order.</span>
        <span class="c1"># These values are written in ``standard&#39;&#39; byte order.</span>
        <span class="c1"># Each is used as a transition time (as  returned  by</span>
        <span class="c1"># time(2)) at which the rules for computing local time</span>
        <span class="c1"># change.</span>

        <span class="k">if</span> <span class="n">timecnt</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">l&quot;</span> <span class="o">%</span> <span class="n">timecnt</span><span class="p">,</span>
                                                    <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timecnt</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Next come tzh_timecnt one-byte values of type unsigned</span>
        <span class="c1"># char; each one tells which of the different types of</span>
        <span class="c1"># ``local time&#39;&#39; types described in the file is associated</span>
        <span class="c1"># with the same-indexed transition time. These values</span>
        <span class="c1"># serve as indices into an array of ttinfo structures that</span>
        <span class="c1"># appears next in the file.</span>

        <span class="k">if</span> <span class="n">timecnt</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">B&quot;</span> <span class="o">%</span> <span class="n">timecnt</span><span class="p">,</span>
                                          <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timecnt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Each ttinfo structure is written as a four-byte value</span>
        <span class="c1"># for tt_gmtoff  of  type long,  in  a  standard  byte</span>
        <span class="c1"># order, followed  by a one-byte value for tt_isdst</span>
        <span class="c1"># and a one-byte  value  for  tt_abbrind.   In  each</span>
        <span class="c1"># structure, tt_gmtoff  gives  the  number  of</span>
        <span class="c1"># seconds to be added to UTC, tt_isdst tells whether</span>
        <span class="c1"># tm_isdst should be set by  localtime(3),  and</span>
        <span class="c1"># tt_abbrind serves  as an index into the array of</span>
        <span class="c1"># time zone abbreviation characters that follow the</span>
        <span class="c1"># ttinfo structure(s) in the file.</span>

        <span class="n">ttinfo</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">typecnt</span><span class="p">):</span>
            <span class="n">ttinfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;lbb&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>

        <span class="n">abbr</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">charcnt</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="c1"># Then there are tzh_leapcnt pairs of four-byte</span>
        <span class="c1"># values, written in  standard byte  order;  the</span>
        <span class="c1"># first  value  of  each pair gives the time (as</span>
        <span class="c1"># returned by time(2)) at which a leap second</span>
        <span class="c1"># occurs;  the  second  gives the  total  number of</span>
        <span class="c1"># leap seconds to be applied after the given time.</span>
        <span class="c1"># The pairs of values are sorted in ascending order</span>
        <span class="c1"># by time.</span>

        <span class="c1"># Not used, for now (but seek for correct file position)</span>
        <span class="k">if</span> <span class="n">leapcnt</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">leapcnt</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

        <span class="c1"># Then there are tzh_ttisstdcnt standard/wall</span>
        <span class="c1"># indicators, each stored as a one-byte value;</span>
        <span class="c1"># they tell whether the transition times associated</span>
        <span class="c1"># with local time types were specified as standard</span>
        <span class="c1"># time or wall clock time, and are used when</span>
        <span class="c1"># a time zone file is used in handling POSIX-style</span>
        <span class="c1"># time zone environment variables.</span>

        <span class="k">if</span> <span class="n">ttisstdcnt</span><span class="p">:</span>
            <span class="n">isstd</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">b&quot;</span> <span class="o">%</span> <span class="n">ttisstdcnt</span><span class="p">,</span>
                                  <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ttisstdcnt</span><span class="p">))</span>

        <span class="c1"># Finally, there are tzh_ttisgmtcnt UTC/local</span>
        <span class="c1"># indicators, each stored as a one-byte value;</span>
        <span class="c1"># they tell whether the transition times associated</span>
        <span class="c1"># with local time types were specified as UTC or</span>
        <span class="c1"># local time, and are used when a time zone file</span>
        <span class="c1"># is used in handling POSIX-style time zone envi-</span>
        <span class="c1"># ronment variables.</span>

        <span class="k">if</span> <span class="n">ttisgmtcnt</span><span class="p">:</span>
            <span class="n">isgmt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">b&quot;</span> <span class="o">%</span> <span class="n">ttisgmtcnt</span><span class="p">,</span>
                                  <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ttisgmtcnt</span><span class="p">))</span>

        <span class="c1"># Build ttinfo list</span>
        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">typecnt</span><span class="p">):</span>
            <span class="n">gmtoff</span><span class="p">,</span> <span class="n">isdst</span><span class="p">,</span> <span class="n">abbrind</span> <span class="o">=</span> <span class="n">ttinfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">gmtoff</span> <span class="o">=</span> <span class="n">_get_supported_offset</span><span class="p">(</span><span class="n">gmtoff</span><span class="p">)</span>
            <span class="n">tti</span> <span class="o">=</span> <span class="n">_ttinfo</span><span class="p">()</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">gmtoff</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">dstoffset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">gmtoff</span><span class="p">)</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span> <span class="o">=</span> <span class="n">isdst</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">abbr</span> <span class="o">=</span> <span class="n">abbr</span><span class="p">[</span><span class="n">abbrind</span><span class="p">:</span><span class="n">abbr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">abbrind</span><span class="p">)]</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isstd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttisstdcnt</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">isstd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isgmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttisgmtcnt</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">isgmt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tti</span><span class="p">)</span>

        <span class="c1"># Replace ttinfo indexes for ttinfo objects.</span>
        <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span><span class="p">]</span>

        <span class="c1"># Set standard, dst, and before ttinfos. before will be</span>
        <span class="c1"># used when a given time is before any transitions,</span>
        <span class="c1"># and will be set to the first non-dst ttinfo, or to</span>
        <span class="c1"># the first dst, if all of them are dst.</span>
        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_before</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_first</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timecnt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">tti</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="o">=</span> <span class="n">tti</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span> <span class="ow">and</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span> <span class="o">=</span> <span class="n">tti</span>

                    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_std</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_dst</span>

                <span class="k">for</span> <span class="n">tti</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_before</span> <span class="o">=</span> <span class="n">tti</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_before</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ttinfo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Now fix transition times to become relative to wall time.</span>
        <span class="c1">#</span>
        <span class="c1"># I&#39;m not sure about this. In my tests, the tz source file</span>
        <span class="c1"># is setup to wall time, and in the binary file isstd and</span>
        <span class="c1"># isgmt are off, so it should be in wall time. OTOH, it&#39;s</span>
        <span class="c1"># always in gmt time. Let me know if you have comments</span>
        <span class="c1"># about this.</span>
        <span class="n">lastdst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lastoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lastdstoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lastbaseoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out</span><span class="o">.</span><span class="n">trans_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">tti</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">dstoffset</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">lastdst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">lastdst</span><span class="p">:</span>
                        <span class="n">dstoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">lastoffset</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dstoffset</span> <span class="ow">and</span> <span class="n">lastdstoffset</span><span class="p">:</span>
                        <span class="n">dstoffset</span> <span class="o">=</span> <span class="n">lastdstoffset</span>

                    <span class="n">tti</span><span class="o">.</span><span class="n">dstoffset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dstoffset</span><span class="p">)</span>
                    <span class="n">lastdstoffset</span> <span class="o">=</span> <span class="n">dstoffset</span>

            <span class="c1"># If a time zone changes its base offset during a DST transition,</span>
            <span class="c1"># then you need to adjust by the previous base offset to get the</span>
            <span class="c1"># transition time in local time. Otherwise you use the current</span>
            <span class="c1"># base offset. Ideally, I would have some mathematical proof of</span>
            <span class="c1"># why this is true, but I haven&#39;t really thought about it enough.</span>
            <span class="n">baseoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">dstoffset</span>
            <span class="n">adjustment</span> <span class="o">=</span> <span class="n">baseoffset</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lastbaseoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">baseoffset</span> <span class="o">!=</span> <span class="n">lastbaseoffset</span>
                    <span class="ow">and</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span> <span class="o">!=</span> <span class="n">lastdst</span><span class="p">):</span>
                <span class="c1"># The base DST has changed</span>
                <span class="n">adjustment</span> <span class="o">=</span> <span class="n">lastbaseoffset</span>

            <span class="n">lastdst</span> <span class="o">=</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span>
            <span class="n">lastoffset</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="n">lastbaseoffset</span> <span class="o">=</span> <span class="n">baseoffset</span>

            <span class="n">out</span><span class="o">.</span><span class="n">trans_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjustment</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">trans_idx</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">trans_list</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">trans_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">trans_list_utc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_find_last_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">in_utc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># If there&#39;s no list, there are no transitions to find</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">_datetime_to_timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Find where the timestamp fits in the transition list - if the</span>
        <span class="c1"># timestamp is a transition time, it&#39;s part of the &quot;after&quot; period.</span>
        <span class="n">trans_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list_utc</span> <span class="k">if</span> <span class="n">in_utc</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">trans_list</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># We want to know when the previous transition was, so subtract off 1</span>
        <span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_get_ttinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># For no list or after the last transition, default to _ttinfo_std</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span>

        <span class="c1"># If there is a list and the time is before it, return _ttinfo_before</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_before</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_find_ttinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_ambiguous_time</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ttinfo</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fromutc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ``tzfile`` implementation of :py:func:`datetime.tzinfo.fromutc`.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            A :py:class:`datetime.datetime` object.</span>

<span class="sd">        :raises TypeError:</span>
<span class="sd">            Raised if ``dt`` is not a :py:class:`datetime.datetime` object.</span>

<span class="sd">        :raises ValueError:</span>
<span class="sd">            Raised if this is called with a ``dt`` which does not have this</span>
<span class="sd">            ``tzinfo`` attached.</span>

<span class="sd">        :return:</span>
<span class="sd">            Returns a :py:class:`datetime.datetime` object representing the</span>
<span class="sd">            wall time in ``self``&#39;s time zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># These isinstance checks are in datetime.tzinfo, so we&#39;ll preserve</span>
        <span class="c1"># them, even if we don&#39;t care about duck typing.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;fromutc() requires a datetime argument&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dt.tzinfo is not self&quot;</span><span class="p">)</span>

        <span class="c1"># First treat UTC as wall time and get the transition we&#39;re in.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_last_transition</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">in_utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ttinfo</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">dt_out</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">tti</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

        <span class="n">fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ambiguous</span><span class="p">(</span><span class="n">dt_out</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">enfold</span><span class="p">(</span><span class="n">dt_out</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fold</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">is_ambiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not the &quot;wall time&quot; of a given datetime is ambiguous in this</span>
<span class="sd">        zone.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            A :py:class:`datetime.datetime`, naive or time zone aware.</span>


<span class="sd">        :return:</span>
<span class="sd">            Returns ``True`` if ambiguous, ``False`` otherwise.</span>

<span class="sd">        .. versionadded:: 2.6.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_last_transition</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Calculate the difference in offsets from current to previous</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">_datetime_to_timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ttinfo</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ttinfo</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span> <span class="o">-</span> <span class="n">tti</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>          <span class="c1"># Transition time</span>

        <span class="k">return</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">tt</span> <span class="o">+</span> <span class="n">od</span>

    <span class="k">def</span> <span class="nf">_resolve_ambiguous_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_last_transition</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># If we have no transitions, return the index</span>
        <span class="n">_fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idx</span>

        <span class="c1"># If it&#39;s ambiguous and we&#39;re in a fold, shift to a different index.</span>
        <span class="n">idx_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">_fold</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ambiguous</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">idx_offset</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">delta</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

        <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

        <span class="c1"># The documentation says that utcoffset()-dst() must</span>
        <span class="c1"># be constant for every dt.</span>
        <span class="k">return</span> <span class="n">tti</span><span class="o">.</span><span class="n">dstoffset</span>

    <span class="nd">@tzname_in_python2</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="ow">or</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">abbr</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzfile</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_trans_list</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">)</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce_ex__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">tzrange</span><span class="p">(</span><span class="n">tzrangebase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``tzrange`` object is a time zone specified by a set of offsets and</span>
<span class="sd">    abbreviations, equivalent to the way the ``TZ`` variable can be specified</span>
<span class="sd">    in POSIX-like systems, but using Python delta objects to specify DST</span>
<span class="sd">    start, end and offsets.</span>

<span class="sd">    :param stdabbr:</span>
<span class="sd">        The abbreviation for standard time (e.g. ``&#39;EST&#39;``).</span>

<span class="sd">    :param stdoffset:</span>
<span class="sd">        An integer or :class:`datetime.timedelta` object or equivalent</span>
<span class="sd">        specifying the base offset from UTC.</span>

<span class="sd">        If unspecified, +00:00 is used.</span>

<span class="sd">    :param dstabbr:</span>
<span class="sd">        The abbreviation for DST / &quot;Summer&quot; time (e.g. ``&#39;EDT&#39;``).</span>

<span class="sd">        If specified, with no other DST information, DST is assumed to occur</span>
<span class="sd">        and the default behavior or ``dstoffset``, ``start`` and ``end`` is</span>
<span class="sd">        used. If unspecified and no other DST information is specified, it</span>
<span class="sd">        is assumed that this zone has no DST.</span>

<span class="sd">        If this is unspecified and other DST information is *is* specified,</span>
<span class="sd">        DST occurs in the zone but the time zone abbreviation is left</span>
<span class="sd">        unchanged.</span>

<span class="sd">    :param dstoffset:</span>
<span class="sd">        A an integer or :class:`datetime.timedelta` object or equivalent</span>
<span class="sd">        specifying the UTC offset during DST. If unspecified and any other DST</span>
<span class="sd">        information is specified, it is assumed to be the STD offset +1 hour.</span>

<span class="sd">    :param start:</span>
<span class="sd">        A :class:`relativedelta.relativedelta` object or equivalent specifying</span>
<span class="sd">        the time and time of year that daylight savings time starts. To</span>
<span class="sd">        specify, for example, that DST starts at 2AM on the 2nd Sunday in</span>
<span class="sd">        March, pass:</span>

<span class="sd">            ``relativedelta(hours=2, month=3, day=1, weekday=SU(+2))``</span>

<span class="sd">        If unspecified and any other DST information is specified, the default</span>
<span class="sd">        value is 2 AM on the first Sunday in April.</span>

<span class="sd">    :param end:</span>
<span class="sd">        A :class:`relativedelta.relativedelta` object or equivalent</span>
<span class="sd">        representing the time and time of year that daylight savings time</span>
<span class="sd">        ends, with the same specification method as in ``start``. One note is</span>
<span class="sd">        that this should point to the first time in the *standard* zone, so if</span>
<span class="sd">        a transition occurs at 2AM in the DST zone and the clocks are set back</span>
<span class="sd">        1 hour to 1AM, set the ``hours`` parameter to +1.</span>


<span class="sd">    **Examples:**</span>

<span class="sd">    .. testsetup:: tzrange</span>

<span class="sd">        from dateutil.tz import tzrange, tzstr</span>

<span class="sd">    .. doctest:: tzrange</span>

<span class="sd">        &gt;&gt;&gt; tzstr(&#39;EST5EDT&#39;) == tzrange(&quot;EST&quot;, -18000, &quot;EDT&quot;)</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; from dateutil.relativedelta import *</span>
<span class="sd">        &gt;&gt;&gt; range1 = tzrange(&quot;EST&quot;, -18000, &quot;EDT&quot;)</span>
<span class="sd">        &gt;&gt;&gt; range2 = tzrange(&quot;EST&quot;, -18000, &quot;EDT&quot;, -14400,</span>
<span class="sd">        ...                  relativedelta(hours=+2, month=4, day=1,</span>
<span class="sd">        ...                                weekday=SU(+1)),</span>
<span class="sd">        ...                  relativedelta(hours=+1, month=10, day=31,</span>
<span class="sd">        ...                                weekday=SU(-1)))</span>
<span class="sd">        &gt;&gt;&gt; tzstr(&#39;EST5EDT&#39;) == range1 == range2</span>
<span class="sd">        True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdabbr</span><span class="p">,</span> <span class="n">stdoffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dstabbr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dstoffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">global</span> <span class="n">relativedelta</span>
        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">relativedelta</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="o">=</span> <span class="n">stdabbr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="o">=</span> <span class="n">dstabbr</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdoffset</span> <span class="o">=</span> <span class="n">stdoffset</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dstoffset</span> <span class="o">=</span> <span class="n">dstoffset</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">stdoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">stdoffset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">=</span> <span class="n">ZERO</span>

        <span class="k">if</span> <span class="n">dstoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dstoffset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dstabbr</span> <span class="ow">and</span> <span class="n">stdoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">ZERO</span>

        <span class="k">if</span> <span class="n">dstabbr</span> <span class="ow">and</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span>
                <span class="n">hours</span><span class="o">=+</span><span class="mi">2</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weekday</span><span class="o">=</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="n">start</span>

        <span class="k">if</span> <span class="n">dstabbr</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span>
                <span class="n">hours</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">weekday</span><span class="o">=</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="n">end</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dst_base_offset_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasdst</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a given year, get the DST on and off transition times, expressed</span>
<span class="sd">        always on the standard time side. For zones with no transitions, this</span>
<span class="sd">        function returns ``None``.</span>

<span class="sd">        :param year:</span>
<span class="sd">            The year whose transitions you would like to query.</span>

<span class="sd">        :return:</span>
<span class="sd">            Returns a :class:`tuple` of :class:`datetime.datetime` objects,</span>
<span class="sd">            ``(dston, dstoff)`` for zones with an annual DST transition, or</span>
<span class="sd">            ``None`` for fixed offset zones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">base_year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">base_year</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">base_year</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzrange</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_start_delta</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_end_delta</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_dst_base_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_base_offset_</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">_TzStrFactory</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">tzstr</span><span class="p">(</span><span class="n">tzrange</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ``tzstr`` objects are time zone objects specified by a time-zone string as</span>
<span class="sd">    it would be passed to a ``TZ`` variable on POSIX-style systems (see</span>
<span class="sd">    the `GNU C Library: TZ Variable`_ for more details).</span>

<span class="sd">    There is one notable exception, which is that POSIX-style time zones use an</span>
<span class="sd">    inverted offset format, so normally ``GMT+3`` would be parsed as an offset</span>
<span class="sd">    3 hours *behind* GMT. The ``tzstr`` time zone object will parse this as an</span>
<span class="sd">    offset 3 hours *ahead* of GMT. If you would like to maintain the POSIX</span>
<span class="sd">    behavior, pass a ``True`` value to ``posix_offset``.</span>

<span class="sd">    The :class:`tzrange` object provides the same functionality, but is</span>
<span class="sd">    specified using :class:`relativedelta.relativedelta` objects. rather than</span>
<span class="sd">    strings.</span>

<span class="sd">    :param s:</span>
<span class="sd">        A time zone string in ``TZ`` variable format. This can be a</span>
<span class="sd">        :class:`bytes` (2.x: :class:`str`), :class:`str` (2.x:</span>
<span class="sd">        :class:`unicode`) or a stream emitting unicode characters</span>
<span class="sd">        (e.g. :class:`StringIO`).</span>

<span class="sd">    :param posix_offset:</span>
<span class="sd">        Optional. If set to ``True``, interpret strings such as ``GMT+3`` or</span>
<span class="sd">        ``UTC+3`` as being 3 hours *behind* UTC rather than ahead, per the</span>
<span class="sd">        POSIX standard.</span>

<span class="sd">    .. caution::</span>

<span class="sd">        Prior to version 2.7.0, this function also supported time zones</span>
<span class="sd">        in the format:</span>

<span class="sd">            * ``EST5EDT,4,0,6,7200,10,0,26,7200,3600``</span>
<span class="sd">            * ``EST5EDT,4,1,0,7200,10,-1,0,7200,3600``</span>

<span class="sd">        This format is non-standard and has been deprecated; this function</span>
<span class="sd">        will raise a :class:`DeprecatedTZFormatWarning` until</span>
<span class="sd">        support is removed in a future version.</span>

<span class="sd">    .. _`GNU C Library: TZ Variable`:</span>
<span class="sd">        https://www.gnu.org/software/libc/manual/html_node/TZ-Variable.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">posix_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">_parser</span> <span class="k">as</span> <span class="n">parser</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_parsetz</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res</span><span class="o">.</span><span class="n">any_unused_tokens</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown string format&quot;</span><span class="p">)</span>

        <span class="c1"># Here we break the compatibility with the TZ variable handling.</span>
        <span class="c1"># GMT-3 actually *means* the timezone -3.</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">stdabbr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GMT&quot;</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">posix_offset</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">stdoffset</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># We must initialize it first, since _delta() needs</span>
        <span class="c1"># _std_offset and _dst_offset set. Use False in start/end</span>
        <span class="c1"># to avoid building it two times.</span>
        <span class="n">tzrange</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">stdabbr</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">stdoffset</span><span class="p">,</span>
                         <span class="n">res</span><span class="o">.</span><span class="n">dstabbr</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">dstoffset</span><span class="p">,</span>
                         <span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">dstabbr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">isend</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hasdst</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">isend</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">relativedelta</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">weekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">week</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">week</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">yday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;yearday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">yday</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">jyday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nlyearday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">jyday</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># Default is to start on first sunday of april, and end</span>
            <span class="c1"># on last sunday of october.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isend</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default is 2AM.</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7200</span>
        <span class="k">if</span> <span class="n">isend</span><span class="p">:</span>
            <span class="c1"># Convert to standard time, to follow the documented way</span>
            <span class="c1"># of working with the extra hour. See the documentation</span>
            <span class="c1"># of the tzinfo class.</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span>
        <span class="k">return</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_tzicalvtzcomp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzoffsetfrom</span><span class="p">,</span> <span class="n">tzoffsetto</span><span class="p">,</span> <span class="n">isdst</span><span class="p">,</span>
                 <span class="n">tzname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">tzoffsetfrom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetto</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">tzoffsetto</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetdiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetto</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetfrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isdst</span> <span class="o">=</span> <span class="n">isdst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzname</span> <span class="o">=</span> <span class="n">tzname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span> <span class="o">=</span> <span class="n">rrule</span>


<span class="k">class</span> <span class="nc">_tzicalvtz</span><span class="p">(</span><span class="n">_tzinfo</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzid</span><span class="p">,</span> <span class="n">comps</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_tzicalvtz</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tzid</span> <span class="o">=</span> <span class="n">tzid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span> <span class="o">=</span> <span class="n">comps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">allocate_lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_find_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">dt</span><span class="p">)))]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">lastcompdt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lastcomp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">:</span>
            <span class="n">compdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_compdt</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">compdt</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lastcompdt</span> <span class="ow">or</span> <span class="n">lastcompdt</span> <span class="o">&lt;</span> <span class="n">compdt</span><span class="p">):</span>
                <span class="n">lastcompdt</span> <span class="o">=</span> <span class="n">compdt</span>
                <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lastcomp</span><span class="p">:</span>
            <span class="c1"># RFC says nothing about what to do when a given</span>
            <span class="c1"># time is before the first onset date. We&#39;ll look for the</span>
            <span class="c1"># first standard component, or the first component, if</span>
            <span class="c1"># none is found.</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                    <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lastcomp</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lastcomp</span>

    <span class="k">def</span> <span class="nf">_find_compdt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">tzoffsetdiff</span> <span class="o">&lt;</span> <span class="n">ZERO</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">-=</span> <span class="n">comp</span><span class="o">.</span><span class="n">tzoffsetdiff</span>

        <span class="n">compdt</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">compdt</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">tzoffsetto</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">tzoffsetdiff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

    <span class="nd">@tzname_in_python2</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">tzname</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;tzicalvtz </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tzid</span><span class="p">)</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span>


<span class="k">class</span> <span class="nc">tzical</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is designed to parse an iCalendar-style ``VTIMEZONE`` structure</span>
<span class="sd">    as set out in `RFC 5545`_ Section 4.6.5 into one or more `tzinfo` objects.</span>

<span class="sd">    :param `fileobj`:</span>
<span class="sd">        A file or stream in iCalendar format, which should be UTF-8 encoded</span>
<span class="sd">        with CRLF endings.</span>

<span class="sd">    .. _`RFC 5545`: https://tools.ietf.org/html/rfc5545</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">rrule</span>
        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">rrule</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">fileobj</span>
            <span class="c1"># ical should be encoded in UTF-8 with CRLF</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">))</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_nullcontext</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">fileobj</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc</span><span class="p">(</span><span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the available time zones as a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a :py:class:`datetime.tzinfo` object by its ``tzid``.</span>

<span class="sd">        :param tzid:</span>
<span class="sd">            If there is exactly one time zone available, omitting ``tzid``</span>
<span class="sd">            or passing :py:const:`None` value returns it. Otherwise a valid</span>
<span class="sd">            key (which can be retrieved from :func:`keys`) is required.</span>

<span class="sd">        :raises ValueError:</span>
<span class="sd">            Raised if ``tzid`` is not specified but there are either more</span>
<span class="sd">            or fewer than 1 zone defined.</span>

<span class="sd">        :returns:</span>
<span class="sd">            Returns either a :py:class:`datetime.tzinfo` object representing</span>
<span class="sd">            the relevant time zone or :py:const:`None` if the ``tzid`` was</span>
<span class="sd">            not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tzid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no timezones defined&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;more than one timezone available&quot;</span><span class="p">)</span>
            <span class="n">tzid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tzid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty offset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="n">signal</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">:]))</span> <span class="o">*</span> <span class="n">signal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid offset: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_rfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty string&quot;</span><span class="p">)</span>

        <span class="c1"># Unfold</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tzid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invtz</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">comptype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">parms</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty property name&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">parms</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">invtz</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;DAYLIGHT&quot;</span><span class="p">):</span>
                        <span class="c1"># Process component</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown component: &quot;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">comptype</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">founddtstart</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tzoffsetto</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">rrulelines</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tzname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;VTIMEZONE&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comptype</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;component not closed: &quot;</span><span class="o">+</span><span class="n">comptype</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tzid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory TZID not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;at least one component is needed&quot;</span><span class="p">)</span>
                        <span class="c1"># Process vtimezone</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">[</span><span class="n">tzid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tzicalvtz</span><span class="p">(</span><span class="n">tzid</span><span class="p">,</span> <span class="n">comps</span><span class="p">)</span>
                        <span class="n">invtz</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">comptype</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">founddtstart</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory DTSTART not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tzoffsetfrom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;mandatory TZOFFSETFROM not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tzoffsetto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;mandatory TZOFFSETFROM not found&quot;</span><span class="p">)</span>
                        <span class="c1"># Process component</span>
                        <span class="n">rr</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">rrulelines</span><span class="p">:</span>
                            <span class="n">rr</span> <span class="o">=</span> <span class="n">rrule</span><span class="o">.</span><span class="n">rrulestr</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rrulelines</span><span class="p">),</span>
                                                <span class="n">compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">ignoretz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="n">_tzicalvtzcomp</span><span class="p">(</span><span class="n">tzoffsetfrom</span><span class="p">,</span> <span class="n">tzoffsetto</span><span class="p">,</span>
                                              <span class="p">(</span><span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;DAYLIGHT&quot;</span><span class="p">),</span>
                                              <span class="n">tzname</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span>
                        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                        <span class="n">comptype</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid component end: &quot;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">comptype</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;DTSTART&quot;</span><span class="p">:</span>
                        <span class="c1"># DTSTART in VTIMEZONE takes a subset of valid RRULE</span>
                        <span class="c1"># values under RFC 5545.</span>
                        <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">parm</span> <span class="o">!=</span> <span class="s1">&#39;VALUE=DATE-TIME&#39;</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unsupported DTSTART param in &#39;</span> <span class="o">+</span>
                                       <span class="s1">&#39;VTIMEZONE: &#39;</span> <span class="o">+</span> <span class="n">parm</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">rrulelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">founddtstart</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RRULE&quot;</span><span class="p">,</span> <span class="s2">&quot;RDATE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXRULE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXDATE&quot;</span><span class="p">):</span>
                        <span class="n">rrulelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZOFFSETFROM&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;unsupported </span><span class="si">%s</span><span class="s2"> parm: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_offset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZOFFSETTO&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;unsupported TZOFFSETTO parm: &quot;</span><span class="o">+</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzoffsetto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_offset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZNAME&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;unsupported TZNAME parm: &quot;</span><span class="o">+</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzname</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported property: &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZID&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;unsupported TZID parm: &quot;</span><span class="o">+</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzid</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;TZURL&quot;</span><span class="p">,</span> <span class="s2">&quot;LAST-MODIFIED&quot;</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported property: &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;VTIMEZONE&quot;</span><span class="p">:</span>
                <span class="n">tzid</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">invtz</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">))</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="n">TZFILES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/etc/localtime&quot;</span><span class="p">,</span> <span class="s2">&quot;localtime&quot;</span><span class="p">]</span>
    <span class="n">TZPATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/share/zoneinfo&quot;</span><span class="p">,</span>
               <span class="s2">&quot;/usr/lib/zoneinfo&quot;</span><span class="p">,</span>
               <span class="s2">&quot;/usr/share/lib/zoneinfo&quot;</span><span class="p">,</span>
               <span class="s2">&quot;/etc/zoneinfo&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TZFILES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TZPATHS</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">__get_gettz</span><span class="p">():</span>
    <span class="n">tzlocal_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">tzlocal</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">tzwinlocal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tzlocal_classes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tzwinlocal</span><span class="p">,)</span>

    <span class="k">class</span> <span class="nc">GettzFunc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a time zone object from a string representation</span>

<span class="sd">        This function is intended to retrieve the :py:class:`tzinfo` subclass</span>
<span class="sd">        that best represents the time zone that would be used if a POSIX</span>
<span class="sd">        `TZ variable`_ were set to the same value.</span>

<span class="sd">        If no argument or an empty string is passed to ``gettz``, local time</span>
<span class="sd">        is returned:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            &gt;&gt;&gt; gettz()</span>
<span class="sd">            tzfile(&#39;/etc/localtime&#39;)</span>

<span class="sd">        This function is also the preferred way to map IANA tz database keys</span>
<span class="sd">        to :class:`tzfile` objects:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            &gt;&gt;&gt; gettz(&#39;Pacific/Kiritimati&#39;)</span>
<span class="sd">            tzfile(&#39;/usr/share/zoneinfo/Pacific/Kiritimati&#39;)</span>

<span class="sd">        On Windows, the standard is extended to include the Windows-specific</span>
<span class="sd">        zone names provided by the operating system:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            &gt;&gt;&gt; gettz(&#39;Egypt Standard Time&#39;)</span>
<span class="sd">            tzwin(&#39;Egypt Standard Time&#39;)</span>

<span class="sd">        Passing a GNU ``TZ`` style string time zone specification returns a</span>
<span class="sd">        :class:`tzstr` object:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            &gt;&gt;&gt; gettz(&#39;AEST-10AEDT-11,M10.1.0/2,M4.1.0/3&#39;)</span>
<span class="sd">            tzstr(&#39;AEST-10AEDT-11,M10.1.0/2,M4.1.0/3&#39;)</span>

<span class="sd">        :param name:</span>
<span class="sd">            A time zone name (IANA, or, on Windows, Windows keys), location of</span>
<span class="sd">            a ``tzfile(5)`` zoneinfo file or ``TZ`` variable style time zone</span>
<span class="sd">            specifier. An empty string, no argument or ``None`` is interpreted</span>
<span class="sd">            as local time.</span>

<span class="sd">        :return:</span>
<span class="sd">            Returns an instance of one of ``dateutil``&#39;s :py:class:`tzinfo`</span>
<span class="sd">            subclasses.</span>

<span class="sd">        .. versionchanged:: 2.7.0</span>

<span class="sd">            After version 2.7.0, any two calls to ``gettz`` using the same</span>
<span class="sd">            input strings will return the same object:</span>

<span class="sd">            .. code-block:: python3</span>

<span class="sd">                &gt;&gt;&gt; tz.gettz(&#39;America/Chicago&#39;) is tz.gettz(&#39;America/Chicago&#39;)</span>
<span class="sd">                True</span>

<span class="sd">            In addition to improving performance, this ensures that</span>
<span class="sd">            `&quot;same zone&quot; semantics`_ are used for datetimes in the same zone.</span>


<span class="sd">        .. _`TZ variable`:</span>
<span class="sd">            https://www.gnu.org/software/libc/manual/html_node/TZ-Variable.html</span>

<span class="sd">        .. _`&quot;same zone&quot; semantics`:</span>
<span class="sd">            https://blog.ganssle.io/articles/2018/02/aware-datetime-arithmetic.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__instances</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache_size</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">allocate_lock</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocache</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">tzlocal_classes</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="c1"># tzlocal is slightly more complicated than the other</span>
                        <span class="c1"># time zone providers because it depends on environment</span>
                        <span class="c1"># at construction time, so don&#39;t cache that.</span>
                        <span class="c1">#</span>
                        <span class="c1"># We also cannot store weak references to None, so we</span>
                        <span class="c1"># will also not store that.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__instances</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># No need for strong caching, return immediately</span>
                        <span class="k">return</span> <span class="n">rv</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache_size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">def</span> <span class="nf">set_cache_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache_size</span> <span class="o">=</span> <span class="n">size</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cache_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__instances</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__strong_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">nocache</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;A non-cached version of gettz&quot;&quot;&quot;</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">TZFILES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">TZPATHS</span><span class="p">:</span>
                            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                            <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tz</span> <span class="o">=</span> <span class="n">tzlocal</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">new_msg</span> <span class="o">=</span> <span class="s2">&quot;gettz argument should be str, not bytes&quot;</span>
                        <span class="n">six</span><span class="o">.</span><span class="n">raise_from</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="n">new_msg</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">TZPATHS</span><span class="p">:</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                            <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                                <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">tzwin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tz</span> <span class="o">=</span> <span class="n">tzwin</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">WindowsError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
                                <span class="c1"># UnicodeEncodeError is for Python 2.7 compat</span>
                                <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tz</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">dateutil.zoneinfo</span> <span class="kn">import</span> <span class="n">get_zonefile_instance</span>
                            <span class="n">tz</span> <span class="o">=</span> <span class="n">get_zonefile_instance</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tz</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                                <span class="c1"># name is not a tzstr unless it has at least</span>
                                <span class="c1"># one offset. For short values of &quot;name&quot;, an</span>
                                <span class="c1"># explicit for loop seems to be the fastest way</span>
                                <span class="c1"># To determine if a string contains a digit</span>
                                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">tz</span> <span class="o">=</span> <span class="n">tzstr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GMT&quot;</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">):</span>
                                    <span class="n">tz</span> <span class="o">=</span> <span class="n">UTC</span>
                                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">time</span><span class="o">.</span><span class="n">tzname</span><span class="p">:</span>
                                    <span class="n">tz</span> <span class="o">=</span> <span class="n">tzlocal</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">tz</span>

    <span class="k">return</span> <span class="n">GettzFunc</span><span class="p">()</span>


<span class="n">gettz</span> <span class="o">=</span> <span class="n">__get_gettz</span><span class="p">()</span>
<span class="k">del</span> <span class="n">__get_gettz</span>


<span class="k">def</span> <span class="nf">datetime_exists</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a datetime and a time zone, determine whether or not a given datetime</span>
<span class="sd">    would fall in a gap.</span>

<span class="sd">    :param dt:</span>
<span class="sd">        A :class:`datetime.datetime` (whose time zone will be ignored if ``tz``</span>
<span class="sd">        is provided.)</span>

<span class="sd">    :param tz:</span>
<span class="sd">        A :class:`datetime.tzinfo` with support for the ``fold`` attribute. If</span>
<span class="sd">        ``None`` or not provided, the datetime&#39;s own time zone will be used.</span>

<span class="sd">    :return:</span>
<span class="sd">        Returns a boolean value whether or not the &quot;wall time&quot; exists in</span>
<span class="sd">        ``tz``.</span>

<span class="sd">    .. versionadded:: 2.7.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Datetime is naive and no time zone provided.&#39;</span><span class="p">)</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># This is essentially a test of whether or not the datetime can survive</span>
    <span class="c1"># a round trip to UTC.</span>
    <span class="n">dt_rt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>
    <span class="n">dt_rt</span> <span class="o">=</span> <span class="n">dt_rt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dt</span> <span class="o">==</span> <span class="n">dt_rt</span>


<span class="k">def</span> <span class="nf">datetime_ambiguous</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a datetime and a time zone, determine whether or not a given datetime</span>
<span class="sd">    is ambiguous (i.e if there are two times differentiated only by their DST</span>
<span class="sd">    status).</span>

<span class="sd">    :param dt:</span>
<span class="sd">        A :class:`datetime.datetime` (whose time zone will be ignored if ``tz``</span>
<span class="sd">        is provided.)</span>

<span class="sd">    :param tz:</span>
<span class="sd">        A :class:`datetime.tzinfo` with support for the ``fold`` attribute. If</span>
<span class="sd">        ``None`` or not provided, the datetime&#39;s own time zone will be used.</span>

<span class="sd">    :return:</span>
<span class="sd">        Returns a boolean value whether or not the &quot;wall time&quot; is ambiguous in</span>
<span class="sd">        ``tz``.</span>

<span class="sd">    .. versionadded:: 2.6.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Datetime is naive and no time zone provided.&#39;</span><span class="p">)</span>

        <span class="n">tz</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span>

    <span class="c1"># If a time zone defines its own &quot;is_ambiguous&quot; function, we&#39;ll use that.</span>
    <span class="n">is_ambiguous_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tz</span><span class="p">,</span> <span class="s1">&#39;is_ambiguous&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_ambiguous_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tz</span><span class="o">.</span><span class="n">is_ambiguous</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># If it doesn&#39;t come out and tell us it&#39;s ambiguous, we&#39;ll just check if</span>
    <span class="c1"># the fold attribute has any effect on this particular date and time.</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="p">)</span>
    <span class="n">wall_0</span> <span class="o">=</span> <span class="n">enfold</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">wall_1</span> <span class="o">=</span> <span class="n">enfold</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">same_offset</span> <span class="o">=</span> <span class="n">wall_0</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span> <span class="o">==</span> <span class="n">wall_1</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>
    <span class="n">same_dst</span> <span class="o">=</span> <span class="n">wall_0</span><span class="o">.</span><span class="n">dst</span><span class="p">()</span> <span class="o">==</span> <span class="n">wall_1</span><span class="o">.</span><span class="n">dst</span><span class="p">()</span>

    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">same_offset</span> <span class="ow">and</span> <span class="n">same_dst</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">resolve_imaginary</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a datetime that may be imaginary, return an existing datetime.</span>

<span class="sd">    This function assumes that an imaginary datetime represents what the</span>
<span class="sd">    wall time would be in a zone had the offset transition not occurred, so</span>
<span class="sd">    it will always fall forward by the transition&#39;s change in offset.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; from dateutil import tz</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; NYC = tz.gettz(&#39;America/New_York&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(tz.resolve_imaginary(datetime(2017, 3, 12, 2, 30, tzinfo=NYC)))</span>
<span class="sd">        2017-03-12 03:30:00-04:00</span>

<span class="sd">        &gt;&gt;&gt; KIR = tz.gettz(&#39;Pacific/Kiritimati&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(tz.resolve_imaginary(datetime(1995, 1, 1, 12, 30, tzinfo=KIR)))</span>
<span class="sd">        1995-01-02 12:30:00+14:00</span>

<span class="sd">    As a note, :func:`datetime.astimezone` is guaranteed to produce a valid,</span>
<span class="sd">    existing datetime, so a round-trip to and from UTC is sufficient to get</span>
<span class="sd">    an extant datetime, however, this generally &quot;falls back&quot; to an earlier time</span>
<span class="sd">    rather than falling forward to the STD side (though no guarantees are made</span>
<span class="sd">    about this behavior).</span>

<span class="sd">    :param dt:</span>
<span class="sd">        A :class:`datetime.datetime` which may or may not exist.</span>

<span class="sd">    :return:</span>
<span class="sd">        Returns an existing :class:`datetime.datetime`. If ``dt`` was not</span>
<span class="sd">        imaginary, the datetime returned is guaranteed to be the same object</span>
<span class="sd">        passed to the function.</span>

<span class="sd">    .. versionadded:: 2.7.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datetime_exists</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>

        <span class="n">curr_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">))</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>
        <span class="n">old_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">))</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>

        <span class="n">dt</span> <span class="o">+=</span> <span class="n">curr_offset</span> <span class="o">-</span> <span class="n">old_offset</span>

    <span class="k">return</span> <span class="n">dt</span>


<span class="k">def</span> <span class="nf">_datetime_to_timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a :class:`datetime.datetime` object to an epoch timestamp in</span>
<span class="sd">    seconds since January 1, 1970, ignoring the time zone.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-</span> <span class="n">EPOCH</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_get_supported_offset</span><span class="p">(</span><span class="n">second_offset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">second_offset</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_get_supported_offset</span><span class="p">(</span><span class="n">second_offset</span><span class="p">):</span>
        <span class="c1"># For python pre-3.6, round to full-minutes if that&#39;s not the case.</span>
        <span class="c1"># Python&#39;s datetime doesn&#39;t accept sub-minute timezones. Check</span>
        <span class="c1"># http://python.org/sf/1447945 or https://bugs.python.org/issue5288</span>
        <span class="c1"># for some information.</span>
        <span class="n">old_offset</span> <span class="o">=</span> <span class="n">second_offset</span>
        <span class="n">calculated_offset</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="p">((</span><span class="n">second_offset</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculated_offset</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Python 3.7 feature</span>
    <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">nullcontext</span> <span class="k">as</span> <span class="n">_nullcontext</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_nullcontext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for wrapping contexts so that they are passed through in a</span>
<span class="sd">        with statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

        <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

        <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">pass</span>

<span class="c1"># vim:ts=4:sw=4:et</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>