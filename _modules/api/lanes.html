
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.lanes &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.lanes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">import</span> <span class="nn">elasticsearch</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">core.classifier</span> <span class="k">as</span> <span class="nn">genres</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">Configuration</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.classifier</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Classifier</span><span class="p">,</span>
    <span class="n">fiction_genres</span><span class="p">,</span>
    <span class="n">nonfiction_genres</span><span class="p">,</span>
    <span class="n">GenreData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">classifier</span>

<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseFacets</span><span class="p">,</span>
    <span class="n">DatabaseBackedWorkList</span><span class="p">,</span>
    <span class="n">DefaultSortOrderFacets</span><span class="p">,</span>
    <span class="n">Facets</span><span class="p">,</span>
    <span class="n">FacetsWithEntryPoint</span><span class="p">,</span>
    <span class="n">Pagination</span><span class="p">,</span>
    <span class="n">Lane</span><span class="p">,</span>
    <span class="n">WorkList</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">create</span><span class="p">,</span>
    <span class="n">CachedFeed</span><span class="p">,</span>
    <span class="n">Contribution</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>
<span class="kn">from</span> <span class="nn">.novelist</span> <span class="kn">import</span> <span class="n">NoveListAPI</span>

<div class="viewcode-block" id="load_lanes"><a class="viewcode-back" href="../../api.html#api.lanes.load_lanes">[docs]</a><span class="k">def</span> <span class="nf">load_lanes</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a WorkList that reflects the current lane structure of the</span>
<span class="sd">    Library.</span>

<span class="sd">    If no top-level visible lanes are configured, the WorkList will be</span>
<span class="sd">    configured to show every book in the collection.</span>

<span class="sd">    If a single top-level Lane is configured, it will returned as the</span>
<span class="sd">    WorkList.</span>

<span class="sd">    Otherwise, a WorkList containing the visible top-level lanes is</span>
<span class="sd">    returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">top_level</span> <span class="o">=</span> <span class="n">WorkList</span><span class="o">.</span><span class="n">top_level_for_library</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>

    <span class="c1"># It&#39;s likely this WorkList will be used across sessions, so</span>
    <span class="c1"># expunge any data model objects from the database session.</span>
    <span class="c1">#</span>
    <span class="c1"># TODO: This is the cause of a lot of problems in the cached OPDS</span>
    <span class="c1"># feed generator. There, these Lanes are used in a normal database</span>
    <span class="c1"># session and we end up needing hacks to merge them back into the</span>
    <span class="c1"># session.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top_level</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
        <span class="n">to_expunge</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_level</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_expunge</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">top_level</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)]</span>
    <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">expunge</span><span class="p">,</span> <span class="n">to_expunge</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">top_level</span></div>


<span class="k">def</span> <span class="nf">_lane_configuration_from_collection_sizes</span><span class="p">(</span><span class="n">estimates</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort a library&#39;s collections into &#39;large&#39;, &#39;small&#39;, and &#39;tiny&#39;</span>
<span class="sd">    subcollections based on language.</span>

<span class="sd">    :param estimates: A Counter.</span>

<span class="sd">    :return: A 3-tuple (large, small, tiny). &#39;large&#39; will contain the</span>
<span class="sd">    collection with the largest language, and any languages with a</span>
<span class="sd">    collection more than 10% the size of the largest</span>
<span class="sd">    collection. &#39;small&#39; will contain any languages with a collection</span>
<span class="sd">    more than 1% the size of the largest collection, and &#39;tiny&#39; will</span>
<span class="sd">    contain all other languages represented in `estimates`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">estimates</span><span class="p">:</span>
        <span class="c1"># There are no holdings. Assume we have a large English</span>
        <span class="c1"># collection and nothing else.</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;eng&#39;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">large</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">small</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tiny</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="p">[(</span><span class="n">ignore</span><span class="p">,</span> <span class="n">largest</span><span class="p">)]</span> <span class="o">=</span> <span class="n">estimates</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">language</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">largest</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">large</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">largest</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">small</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tiny</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">large</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">tiny</span>


<div class="viewcode-block" id="create_default_lanes"><a class="viewcode-back" href="../../api.html#api.lanes.create_default_lanes">[docs]</a><span class="k">def</span> <span class="nf">create_default_lanes</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset the lanes for the given library to the default.</span>

<span class="sd">    The database will have the following top-level lanes for</span>
<span class="sd">    each large-collection:</span>
<span class="sd">    &#39;Adult Fiction&#39;, &#39;Adult Nonfiction&#39;, &#39;Young Adult Fiction&#39;,</span>
<span class="sd">    &#39;Young Adult Nonfiction&#39;, and &#39;Children&#39;.</span>
<span class="sd">    Each lane contains additional sublanes.</span>
<span class="sd">    If an NYT integration is configured, there will also be a</span>
<span class="sd">    &#39;Best Sellers&#39; top-level lane.</span>

<span class="sd">    If there are any small- or tiny-collection languages, the database</span>
<span class="sd">    will also have a top-level lane called &#39;World Languages&#39;. The</span>
<span class="sd">    &#39;World Languages&#39; lane will have a sublane for every small- and</span>
<span class="sd">    tiny-collection languages. The small-collection languages will</span>
<span class="sd">    have &quot;Adult Fiction&quot;, &quot;Adult Nonfiction&quot;, and &quot;Children/YA&quot;</span>
<span class="sd">    sublanes; the tiny-collection languages will not have any sublanes.</span>

<span class="sd">    If run on a Library that already has Lane configuration, this can</span>
<span class="sd">    be an extremely destructive method. All new Lanes will be visible</span>
<span class="sd">    and all Lanes based on CustomLists (but not the CustomLists</span>
<span class="sd">    themselves) will be destroyed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delete existing lanes.</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">library_id</span><span class="o">==</span><span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

    <span class="n">top_level_lanes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Hopefully this library is configured with explicit guidance as</span>
    <span class="c1"># to how the languages should be set up.</span>
    <span class="n">large</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">large_collection_languages</span><span class="p">(</span><span class="n">library</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">small</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">small_collection_languages</span><span class="p">(</span><span class="n">library</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">tiny</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">tiny_collection_languages</span><span class="p">(</span><span class="n">library</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="c1"># If there are no language configuration settings, we can estimate</span>
    <span class="c1"># the current collection size to determine the lanes.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">large</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">small</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tiny</span><span class="p">:</span>
        <span class="n">estimates</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">estimated_holdings_by_language</span><span class="p">()</span>
        <span class="n">large</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">tiny</span> <span class="o">=</span> <span class="n">_lane_configuration_from_collection_sizes</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">large</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">create_lanes_for_large_collection</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">)</span>

    <span class="n">create_world_languages_lane</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">tiny</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span></div>

<div class="viewcode-block" id="lane_from_genres"><a class="viewcode-back" href="../../api.html#api.lanes.lane_from_genres">[docs]</a><span class="k">def</span> <span class="nf">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">exclude_genres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn genre info into a Lane object.&quot;&quot;&quot;</span>

    <span class="n">genre_lane_instructions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Dystopian SF&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Dystopian&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Erotica&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">audiences</span><span class="o">=</span><span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ADULTS_ONLY</span><span class="p">]),</span>
        <span class="s2">&quot;Humorous Fiction&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Humor&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Media Tie-in SF&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Movie and TV Novelizations&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Suspense/Thriller&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Thriller&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Humorous Nonfiction&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Humor&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Political Science&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Politics &amp; Current Events&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Periodicals&quot;</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Create sublanes first.</span>
    <span class="n">sublanes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">sublane_priority</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">subgenre</span> <span class="ow">in</span> <span class="n">genre</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subgenres&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_from_genres</span><span class="p">(</span>
                        <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">subgenre</span><span class="p">],</span>
                        <span class="n">priority</span><span class="o">=</span><span class="n">sublane_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_args</span><span class="p">))</span>
                <span class="n">sublane_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Now that we have sublanes we don&#39;t care about subgenres anymore.</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
              <span class="k">else</span> <span class="n">genre</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">GenreData</span><span class="p">)</span>
              <span class="k">else</span> <span class="n">genre</span>
              <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">]</span>

    <span class="n">exclude_genres</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                      <span class="k">else</span> <span class="n">genre</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">GenreData</span><span class="p">)</span>
                      <span class="k">else</span> <span class="n">genre</span>
                      <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">exclude_genres</span> <span class="ow">or</span> <span class="p">[]]</span>

    <span class="n">fiction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">classifier</span><span class="o">.</span><span class="n">genres</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">genredata</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">genres</span><span class="p">[</span><span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genredata</span> <span class="o">=</span> <span class="n">GenreData</span><span class="p">(</span><span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">fiction</span> <span class="o">=</span> <span class="n">genredata</span><span class="o">.</span><span class="n">is_fiction</span>

        <span class="k">if</span> <span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">genre_lane_instructions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">instructions</span> <span class="o">=</span> <span class="n">genre_lane_instructions</span><span class="p">[</span><span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">display_name</span> <span class="ow">and</span> <span class="s2">&quot;display_name&quot;</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="n">display_name</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;audiences&quot;</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="n">audiences</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audiences&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;visible&quot;</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
                <span class="n">visible</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;visible&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">display_name</span><span class="p">:</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">genres</span><span class="p">))</span>

    <span class="n">lane</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library_id</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                          <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
                          <span class="n">fiction</span><span class="o">=</span><span class="n">fiction</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="n">audiences</span><span class="p">,</span>
                          <span class="n">sublanes</span><span class="o">=</span><span class="n">sublanes</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">lane</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="n">visible</span>
    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">exclude_genres</span><span class="p">:</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lane</span></div>

<div class="viewcode-block" id="create_lanes_for_large_collection"><a class="viewcode-back" href="../../api.html#api.lanes.create_lanes_for_large_collection">[docs]</a><span class="k">def</span> <span class="nf">create_lanes_for_large_collection</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">languages</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that the lanes appropriate to a large collection are all</span>
<span class="sd">    present.</span>

<span class="sd">    This means:</span>

<span class="sd">    * A &quot;%(language)s Adult Fiction&quot; lane containing sublanes for each fiction</span>
<span class="sd">        genre.</span>
<span class="sd">    * A &quot;%(language)s Adult Nonfiction&quot; lane containing sublanes for</span>
<span class="sd">        each nonfiction genre.</span>
<span class="sd">    * A &quot;%(language)s YA Fiction&quot; lane containing sublanes for the</span>
<span class="sd">        most popular YA fiction genres.</span>
<span class="sd">    * A &quot;%(language)s YA Nonfiction&quot; lane containing sublanes for the</span>
<span class="sd">        most popular YA fiction genres.</span>
<span class="sd">    * A &quot;%(language)s Children and Middle Grade&quot; lane containing</span>
<span class="sd">        sublanes for childrens&#39; books at different age levels.</span>

<span class="sd">    :param library: Newly created lanes will be associated with this</span>
<span class="sd">        library.</span>
<span class="sd">    :param languages: Newly created lanes will contain only books</span>
<span class="sd">        in these languages.</span>
<span class="sd">    :return: A list of top-level Lane objects.</span>

<span class="sd">    TODO: If there are multiple large collections, their top-level lanes do</span>
<span class="sd">    not have distinct display names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">languages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">languages</span><span class="p">]</span>

    <span class="n">ADULT</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_ADULT</span>
    <span class="n">YA</span> <span class="o">=</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">]</span>
    <span class="n">CHILDREN</span> <span class="o">=</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">]</span>

    <span class="n">common_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
        <span class="n">media</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">adult_common_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">common_args</span><span class="p">)</span>
    <span class="n">adult_common_args</span><span class="p">[</span><span class="s1">&#39;audiences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ADULT</span>

    <span class="n">include_best_sellers</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nyt_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">NYT</span><span class="p">)</span>
    <span class="n">nyt_integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
        <span class="n">goal</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">METADATA_GOAL</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">NYT</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nyt_integration</span><span class="p">:</span>
        <span class="n">include_best_sellers</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">sublanes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_args</span>
        <span class="p">)</span>
        <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_sellers</span><span class="p">)</span>


    <span class="n">adult_fiction_sublanes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">adult_fiction_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">adult_fiction_best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">adult_fiction_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">adult_common_args</span>
        <span class="p">)</span>
        <span class="n">adult_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">adult_fiction_best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">adult_fiction_sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adult_fiction_best_sellers</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">fiction_genres</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">genre_name</span> <span class="o">=</span> <span class="n">genre</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genre_name</span> <span class="o">=</span> <span class="n">genre</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">genre_lane</span> <span class="o">=</span> <span class="n">lane_from_genres</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genre</span><span class="p">],</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">adult_fiction_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">adult_common_args</span><span class="p">)</span>
        <span class="n">adult_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">adult_fiction_sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_lane</span><span class="p">)</span>

    <span class="n">adult_fiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Fiction&quot;</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="n">adult_fiction_sublanes</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">adult_common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adult_fiction</span><span class="p">)</span>

    <span class="n">adult_nonfiction_sublanes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">adult_nonfiction_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">adult_nonfiction_best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">adult_nonfiction_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">adult_common_args</span>
        <span class="p">)</span>
        <span class="n">adult_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">adult_nonfiction_best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">adult_nonfiction_sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adult_nonfiction_best_sellers</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">nonfiction_genres</span><span class="p">:</span>
        <span class="c1"># &quot;Life Strategies&quot; is a YA-specific genre that should not be</span>
        <span class="c1"># included in the Adult Nonfiction lane.</span>
        <span class="k">if</span> <span class="n">genre</span> <span class="o">!=</span> <span class="n">genres</span><span class="o">.</span><span class="n">Life_Strategies</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">genre_name</span> <span class="o">=</span> <span class="n">genre</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">genre_name</span> <span class="o">=</span> <span class="n">genre</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">genre_lane</span> <span class="o">=</span> <span class="n">lane_from_genres</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genre</span><span class="p">],</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">adult_nonfiction_priority</span><span class="p">,</span>
                <span class="o">**</span><span class="n">adult_common_args</span><span class="p">)</span>
            <span class="n">adult_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">adult_nonfiction_sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_lane</span><span class="p">)</span>

    <span class="n">adult_nonfiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Nonfiction&quot;</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="n">adult_nonfiction_sublanes</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">adult_common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adult_nonfiction</span><span class="p">)</span>

    <span class="n">ya_common_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">common_args</span><span class="p">)</span>
    <span class="n">ya_common_args</span><span class="p">[</span><span class="s1">&#39;audiences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YA</span>

    <span class="n">ya_fiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Young Adult Fiction&quot;</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">ya_common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ya_fiction</span><span class="p">)</span>

    <span class="n">ya_fiction_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">ya_fiction_best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">ya_common_args</span>
        <span class="p">)</span>
        <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ya_fiction_best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ya_fiction_best_sellers</span><span class="p">)</span>

    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Dystopian_SF</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Fantasy</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Comics_Graphic_Novels</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Literary_Fiction</span><span class="p">],</span>
                         <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Contemporary Fiction&quot;</span><span class="p">,</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">LGBTQ_Fiction</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Suspense_Thriller</span><span class="p">,</span> <span class="n">genres</span><span class="o">.</span><span class="n">Mystery</span><span class="p">],</span>
                         <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Mystery &amp; Thriller&quot;</span><span class="p">,</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Romance</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Science_Fiction</span><span class="p">],</span>
                         <span class="n">exclude_genres</span><span class="o">=</span><span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Dystopian_SF</span><span class="p">,</span> <span class="n">genres</span><span class="o">.</span><span class="n">Steampunk</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_fiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Steampunk</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_fiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_fiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ya_nonfiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Young Adult Nonfiction&quot;</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">ya_common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ya_nonfiction</span><span class="p">)</span>

    <span class="n">ya_nonfiction_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">ya_nonfiction_best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">ya_nonfiction_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">ya_common_args</span>
        <span class="p">)</span>
        <span class="n">ya_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ya_nonfiction_best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">ya_nonfiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ya_nonfiction_best_sellers</span><span class="p">)</span>

    <span class="n">ya_nonfiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Biography_Memoir</span><span class="p">],</span>
                         <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Biography&quot;</span><span class="p">,</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_nonfiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_nonfiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">History</span><span class="p">,</span> <span class="n">genres</span><span class="o">.</span><span class="n">Social_Sciences</span><span class="p">],</span>
                         <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;History &amp; Sociology&quot;</span><span class="p">,</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_nonfiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_nonfiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Life_Strategies</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_nonfiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ya_nonfiction</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">lane_from_genres</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="p">[</span><span class="n">genres</span><span class="o">.</span><span class="n">Religion_Spirituality</span><span class="p">],</span>
                         <span class="n">priority</span><span class="o">=</span><span class="n">ya_nonfiction_priority</span><span class="p">,</span> <span class="o">**</span><span class="n">ya_common_args</span><span class="p">))</span>
    <span class="n">ya_nonfiction_priority</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="n">children_common_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">common_args</span><span class="p">)</span>
    <span class="n">children_common_args</span><span class="p">[</span><span class="s1">&#39;audiences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CHILDREN</span>

    <span class="n">children</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Children and Middle Grade&quot;</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

    <span class="n">children_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">include_best_sellers</span><span class="p">:</span>
        <span class="n">children_best_sellers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Best Sellers&quot;</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
            <span class="o">**</span><span class="n">children_common_args</span>
        <span class="p">)</span>
        <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">children_best_sellers</span><span class="o">.</span><span class="n">list_datasource</span> <span class="o">=</span> <span class="n">nyt_data_source</span>
        <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_best_sellers</span><span class="p">)</span>

    <span class="n">picture_books</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Picture Books&quot;</span><span class="p">,</span>
        <span class="n">target_age</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">picture_books</span><span class="p">)</span>

    <span class="n">easy_readers</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Easy Readers&quot;</span><span class="p">,</span>
        <span class="n">target_age</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">easy_readers</span><span class="p">)</span>

    <span class="n">chapter_books</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Chapter Books&quot;</span><span class="p">,</span>
        <span class="n">target_age</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chapter_books</span><span class="p">)</span>

    <span class="n">children_poetry</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Poetry Books&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_poetry</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Poetry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_poetry</span><span class="p">)</span>

    <span class="n">children_folklore</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Folklore&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_folklore</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Folklore</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_folklore</span><span class="p">)</span>

    <span class="n">children_fantasy</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_fantasy</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Fantasy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_fantasy</span><span class="p">)</span>

    <span class="n">children_sf</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Science Fiction&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_sf</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Science_Fiction</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_sf</span><span class="p">)</span>

    <span class="n">realistic_fiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Realistic Fiction&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">realistic_fiction</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Literary_Fiction</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">realistic_fiction</span><span class="p">)</span>

    <span class="n">children_graphic_novels</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Comics &amp; Graphic Novels&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_graphic_novels</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Comics_Graphic_Novels</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_graphic_novels</span><span class="p">)</span>

    <span class="n">children_biography</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Biography&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_biography</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Biography_Memoir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_biography</span><span class="p">)</span>

    <span class="n">children_historical_fiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Historical Fiction&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">children_historical_fiction</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Historical_Fiction</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_historical_fiction</span><span class="p">)</span>

    <span class="n">informational</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Informational Books&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">children_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">children_common_args</span>
    <span class="p">)</span>
    <span class="n">children_priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">informational</span><span class="o">.</span><span class="n">add_genre</span><span class="p">(</span><span class="n">genres</span><span class="o">.</span><span class="n">Biography_Memoir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">children</span><span class="o">.</span><span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informational</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">priority</span></div>

<div class="viewcode-block" id="create_world_languages_lane"><a class="viewcode-back" href="../../api.html#api.lanes.create_world_languages_lane">[docs]</a><span class="k">def</span> <span class="nf">create_world_languages_lane</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">small_languages</span><span class="p">,</span> <span class="n">tiny_languages</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a lane called &#39;World Languages&#39; whose sublanes represent</span>
<span class="sd">    the non-large language collections available to this library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">small_languages</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tiny_languages</span><span class="p">:</span>
        <span class="c1"># All the languages on this system have large collections, so</span>
        <span class="c1"># there is no need for a &#39;World Languages&#39; lane.</span>
        <span class="k">return</span> <span class="n">priority</span>

    <span class="n">complete_language_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="p">(</span><span class="n">small_languages</span><span class="p">,</span> <span class="n">tiny_languages</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">languageset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">languageset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">complete_language_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">languageset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">complete_language_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">languageset</span><span class="p">)</span>


    <span class="n">world_languages</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;World Languages&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">complete_language_set</span><span class="p">,</span>
        <span class="n">media</span><span class="o">=</span><span class="p">[</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">],</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">language_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">small</span> <span class="ow">in</span> <span class="n">small_languages</span><span class="p">:</span>
        <span class="c1"># Create a lane (with sublanes) for each small collection.</span>
        <span class="n">language_priority</span> <span class="o">=</span> <span class="n">create_lane_for_small_collection</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">world_languages</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">language_priority</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">tiny</span> <span class="ow">in</span> <span class="n">tiny_languages</span><span class="p">:</span>
        <span class="c1"># Create a lane (no sublanes) for each tiny collection.</span>
        <span class="n">language_priority</span> <span class="o">=</span> <span class="n">create_lane_for_tiny_collection</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">world_languages</span><span class="p">,</span> <span class="n">tiny</span><span class="p">,</span> <span class="n">language_priority</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">priority</span></div>

<div class="viewcode-block" id="create_lane_for_small_collection"><a class="viewcode-back" href="../../api.html#api.lanes.create_lane_for_small_collection">[docs]</a><span class="k">def</span> <span class="nf">create_lane_for_small_collection</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">languages</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a lane (with sublanes) for a small collection based on language,</span>
<span class="sd">    if the language exists in the lookup table.</span>

<span class="sd">    :param parent: The parent of the new lane.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">languages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">languages</span><span class="p">]</span>

    <span class="n">ADULT</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_ADULT</span>
    <span class="n">YA_CHILDREN</span> <span class="o">=</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">,</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">]</span>

    <span class="n">common_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
        <span class="n">media</span><span class="o">=</span><span class="p">[</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">],</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">language_identifier</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">name_for_languageset</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Could not create a lane for small collection with languages </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">languages</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">sublane_priority</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">adult_fiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Fiction&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">audiences</span><span class="o">=</span><span class="n">ADULT</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">sublane_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">common_args</span>
    <span class="p">)</span>
    <span class="n">sublane_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">adult_nonfiction</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Nonfiction&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">audiences</span><span class="o">=</span><span class="n">ADULT</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">sublane_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">common_args</span>
    <span class="p">)</span>
    <span class="n">sublane_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ya_children</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Children &amp; Young Adult&quot;</span><span class="p">,</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">audiences</span><span class="o">=</span><span class="n">YA_CHILDREN</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">sublane_priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">common_args</span>
    <span class="p">)</span>
    <span class="n">sublane_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">lane</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="n">language_identifier</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="n">sublanes</span><span class="o">=</span><span class="p">[</span><span class="n">adult_fiction</span><span class="p">,</span> <span class="n">adult_nonfiction</span><span class="p">,</span> <span class="n">ya_children</span><span class="p">],</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="o">**</span><span class="n">common_args</span>
    <span class="p">)</span>
    <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">priority</span></div>

<div class="viewcode-block" id="create_lane_for_tiny_collection"><a class="viewcode-back" href="../../api.html#api.lanes.create_lane_for_tiny_collection">[docs]</a><span class="k">def</span> <span class="nf">create_lane_for_tiny_collection</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">languages</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a single lane for a tiny collection based on language,</span>
<span class="sd">    if the language exists in the lookup table.</span>

<span class="sd">    :param parent: The parent of the new lane.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">languages</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">languages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">languages</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">name_for_languageset</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Could not create a lane for tiny collection with languages </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">languages</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">language_lane</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
        <span class="n">display_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="n">genres</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">media</span><span class="o">=</span><span class="p">[</span><span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">],</span>
        <span class="n">fiction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">priority</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="DynamicLane"><a class="viewcode-back" href="../../api.html#api.lanes.DynamicLane">[docs]</a><span class="k">class</span> <span class="nc">DynamicLane</span><span class="p">(</span><span class="n">WorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList that&#39;s used to from an OPDS lane, but isn&#39;t a Lane</span>
<span class="sd">    in the database.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="DatabaseExclusiveWorkList"><a class="viewcode-back" href="../../api.html#api.lanes.DatabaseExclusiveWorkList">[docs]</a><span class="k">class</span> <span class="nc">DatabaseExclusiveWorkList</span><span class="p">(</span><span class="n">DatabaseBackedWorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A DatabaseBackedWorkList that can _only_ get Works through the database.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="DatabaseExclusiveWorkList.works"><a class="viewcode-back" href="../../api.html#api.lanes.DatabaseExclusiveWorkList.works">[docs]</a>    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works_from_database</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="WorkBasedLane"><a class="viewcode-back" href="../../api.html#api.lanes.WorkBasedLane">[docs]</a><span class="k">class</span> <span class="nc">WorkBasedLane</span><span class="p">(</span><span class="n">DynamicLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane that shows works related to one particular Work.&quot;&quot;&quot;</span>

    <span class="n">DISPLAY_NAME</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ROUTE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">children</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edition</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span>

        <span class="c1"># To avoid showing the same book in other languages, the value</span>
        <span class="c1"># of this lane&#39;s .languages is always derived from the</span>
        <span class="c1"># language of the work.  All children of this lane will be put</span>
        <span class="c1"># under a similar restriction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">language</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_language</span><span class="p">]</span>

        <span class="c1"># To avoid showing inappropriate material, the value of this</span>
        <span class="c1"># lane&#39;s .audiences setting is always derived from the</span>
        <span class="c1"># audience of the work. All children of this lane will be</span>
        <span class="c1"># under a similar restriction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_audience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">audience</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;audiences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences_list_from_source</span><span class="p">()</span>

        <span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISPLAY_NAME</span>

        <span class="n">children</span> <span class="o">=</span> <span class="n">children</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">WorkBasedLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="n">children</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE</span><span class="p">,</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="WorkBasedLane.audiences_list_from_source"><a class="viewcode-back" href="../../api.html#api.lanes.WorkBasedLane.audiences_list_from_source">[docs]</a>    <span class="k">def</span> <span class="nf">audiences_list_from_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_audience</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_audience</span> <span class="ow">in</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_ADULT</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_JUVENILE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">]</span></div>

<div class="viewcode-block" id="WorkBasedLane.append_child"><a class="viewcode-back" href="../../api.html#api.lanes.WorkBasedLane.append_child">[docs]</a>    <span class="k">def</span> <span class="nf">append_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add another Worklist as a child of this one and change its</span>
<span class="sd">        configuration to make sure its results fit in with this lane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkBasedLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span>
        <span class="n">worklist</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span>
        <span class="n">worklist</span><span class="o">.</span><span class="n">audiences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span></div>

<div class="viewcode-block" id="WorkBasedLane.accessible_to"><a class="viewcode-back" href="../../api.html#api.lanes.WorkBasedLane.accessible_to">[docs]</a>    <span class="k">def</span> <span class="nf">accessible_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In addition to the restrictions imposed by the superclass, a lane</span>
<span class="sd">        based on a specific Work is accessible to a Patron only if the</span>
<span class="sd">        Work itself is age-appropriate for the patron.</span>

<span class="sd">        :param patron: A Patron</span>
<span class="sd">        :return: A boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">superclass_ok</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">WorkBasedLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">accessible_to</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">superclass_ok</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">age_appropriate_for_patron</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="RecommendationLane"><a class="viewcode-back" href="../../api.html#api.lanes.RecommendationLane">[docs]</a><span class="k">class</span> <span class="nc">RecommendationLane</span><span class="p">(</span><span class="n">WorkBasedLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane of recommended Works based on a particular Work&quot;&quot;&quot;</span>

    <span class="n">DISPLAY_NAME</span> <span class="o">=</span> <span class="s2">&quot;Titles recommended by NoveList&quot;</span>
    <span class="n">ROUTE</span> <span class="o">=</span> <span class="s2">&quot;recommendations&quot;</span>

    <span class="c1"># Cache for 24 hours -- would ideally be much longer but availability</span>
    <span class="c1"># information goes stale.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">RECOMMENDATIONS_TYPE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">novelist_api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :raises: CannotLoadConfiguration if `novelist_api` is not provided</span>
<span class="sd">        and no Novelist integration is configured for this library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RecommendationLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">novelist_api</span> <span class="o">=</span> <span class="n">novelist_api</span> <span class="ow">or</span> <span class="n">NoveListAPI</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_recommendations</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="RecommendationLane.fetch_recommendations"><a class="viewcode-back" href="../../api.html#api.lanes.RecommendationLane.fetch_recommendations">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get identifiers of recommendations for this LicensePool&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">novelist_api</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">filter_recommendations</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">recommendations</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="RecommendationLane.overview_facets"><a class="viewcode-back" href="../../api.html#api.lanes.RecommendationLane.overview_facets">[docs]</a>    <span class="k">def</span> <span class="nf">overview_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a generic FeaturedFacets to some other faceting object,</span>
<span class="sd">        suitable for showing an overview of this WorkList in a grouped</span>
<span class="sd">        feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Since the purpose of the recommendation feed is to</span>
        <span class="c1"># suggest books that can be borrowed immediately, it would be</span>
        <span class="c1"># better to set availability=AVAILABLE_NOW. However, this feed</span>
        <span class="c1"># is cached for so long that we can&#39;t rely on the availability</span>
        <span class="c1"># information staying accurate. It would be especially bad if</span>
        <span class="c1"># people borrowed all of the recommendations that were</span>
        <span class="c1"># available at the time this feed was generated, and then</span>
        <span class="c1"># recommendations that were unavailable when the feed was</span>
        <span class="c1"># generated became available.</span>
        <span class="c1">#</span>
        <span class="c1"># For now, it&#39;s better to show all books and let people put</span>
        <span class="c1"># the unavailable ones on hold if they want.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: It would be better to order works in the same order</span>
        <span class="c1"># they come from the recommendation engine, since presumably</span>
        <span class="c1"># the best recommendations are in the front.</span>
        <span class="k">return</span> <span class="n">Facets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">collection</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">,</span>
            <span class="n">availability</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RecommendationLane.modify_search_filter_hook"><a class="viewcode-back" href="../../api.html#api.lanes.RecommendationLane.modify_search_filter_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find Works whose Identifiers include the ISBNs returned</span>
<span class="sd">        by an external recommendation engine.</span>

<span class="sd">        :param filter: A Filter object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
            <span class="c1"># There are no recommendations. The search should not even</span>
            <span class="c1"># be executed.</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">match_nothing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommendations</span>
        <span class="k">return</span> <span class="nb">filter</span></div></div>


<div class="viewcode-block" id="SeriesFacets"><a class="viewcode-back" href="../../api.html#api.lanes.SeriesFacets">[docs]</a><span class="k">class</span> <span class="nc">SeriesFacets</span><span class="p">(</span><span class="n">DefaultSortOrderFacets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list with a series restriction is ordered by series position by</span>
<span class="sd">    default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_SORT_ORDER</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_SERIES_POSITION</span></div>


<div class="viewcode-block" id="SeriesLane"><a class="viewcode-back" href="../../api.html#api.lanes.SeriesLane">[docs]</a><span class="k">class</span> <span class="nc">SeriesLane</span><span class="p">(</span><span class="n">DynamicLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane of Works in a particular series.&quot;&quot;&quot;</span>

    <span class="n">ROUTE</span> <span class="o">=</span> <span class="s1">&#39;series&#39;</span>
    <span class="c1"># Cache for 24 hours -- would ideally be longer but availability</span>
    <span class="c1"># information goes stale.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">SERIES_TYPE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">series_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SeriesLane can&#39;t be created without series&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SeriesLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">series_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series_name</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">WorkBasedLane</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">source_audience</span><span class="p">:</span>
                <span class="c1"># WorkBasedLane forces self.audiences to values</span>
                <span class="c1"># compatible with the work in the WorkBasedLane, but</span>
                <span class="c1"># that&#39;s not enough for us. We want to force</span>
                <span class="c1"># self.audiences to *the specific audience* of the</span>
                <span class="c1"># work in the WorkBasedLane. If we&#39;re looking at a YA</span>
                <span class="c1"># series, we don&#39;t want to see books in a children&#39;s</span>
                <span class="c1"># series with the same name, even if it would be</span>
                <span class="c1"># appropriate to show those books.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audiences</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">source_audience</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">series_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;languages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;audiences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audience_key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE</span><span class="p">,</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="SeriesLane.overview_facets"><a class="viewcode-back" href="../../api.html#api.lanes.SeriesLane.overview_facets">[docs]</a>    <span class="k">def</span> <span class="nf">overview_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a FeaturedFacets to a SeriesFacets suitable for</span>
<span class="sd">        use in a grouped feed. Our contribution to a grouped feed will</span>
<span class="sd">        be ordered by series position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SeriesFacets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">collection</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">,</span>
            <span class="n">availability</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SeriesLane.modify_search_filter_hook"><a class="viewcode-back" href="../../api.html#api.lanes.SeriesLane.modify_search_filter_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>
        <span class="k">return</span> <span class="nb">filter</span></div></div>


<div class="viewcode-block" id="ContributorFacets"><a class="viewcode-back" href="../../api.html#api.lanes.ContributorFacets">[docs]</a><span class="k">class</span> <span class="nc">ContributorFacets</span><span class="p">(</span><span class="n">DefaultSortOrderFacets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list with a contributor restriction is, by default, sorted by</span>
<span class="sd">    title.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_SORT_ORDER</span> <span class="o">=</span> <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_TITLE</span></div>


<div class="viewcode-block" id="ContributorLane"><a class="viewcode-back" href="../../api.html#api.lanes.ContributorLane">[docs]</a><span class="k">class</span> <span class="nc">ContributorLane</span><span class="p">(</span><span class="n">DynamicLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane of Works written by a particular contributor&quot;&quot;&quot;</span>

    <span class="n">ROUTE</span> <span class="o">=</span> <span class="s1">&#39;contributor&#39;</span>
    <span class="c1"># Cache for 24 hours -- would ideally be longer but availability</span>
    <span class="c1"># information goes stale.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">CONTRIBUTOR_TYPE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">contributor</span><span class="p">,</span>
                 <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param library: A Library.</span>
<span class="sd">        :param contributor: A Contributor or ContributorData object.</span>
<span class="sd">        :param parent: A WorkList.</span>
<span class="sd">        :param languages: An extra restriction on the languages of Works.</span>
<span class="sd">        :param audiences: An extra restriction on the audience for Works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contributor</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;ContributorLane can&#39;t be created without contributor&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contributor</span> <span class="o">=</span> <span class="n">contributor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contributor_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">sort_name</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ContributorLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contributor_key</span><span class="p">,</span>
            <span class="n">audiences</span><span class="o">=</span><span class="n">audiences</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">contributor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contributor_key</span><span class="p">,</span>
            <span class="n">languages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language_key</span><span class="p">,</span>
            <span class="n">audiences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">audience_key</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE</span><span class="p">,</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="ContributorLane.overview_facets"><a class="viewcode-back" href="../../api.html#api.lanes.ContributorLane.overview_facets">[docs]</a>    <span class="k">def</span> <span class="nf">overview_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a FeaturedFacets to a ContributorFacets suitable for</span>
<span class="sd">        use in a grouped feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ContributorFacets</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">collection</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">,</span>
            <span class="n">availability</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">facets</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ContributorLane.modify_search_filter_hook"><a class="viewcode-back" href="../../api.html#api.lanes.ContributorLane.modify_search_filter_hook">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contributor</span>
        <span class="k">return</span> <span class="nb">filter</span></div></div>


<div class="viewcode-block" id="RelatedBooksLane"><a class="viewcode-back" href="../../api.html#api.lanes.RelatedBooksLane">[docs]</a><span class="k">class</span> <span class="nc">RelatedBooksLane</span><span class="p">(</span><span class="n">WorkBasedLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane of Works all related to a given Work by various criteria.</span>

<span class="sd">    Each criterion is represented by another WorkBaseLane class:</span>

<span class="sd">    * ContributorLane: Works by one of the contributors to this work.</span>
<span class="sd">    * SeriesLane: Works in the same series.</span>
<span class="sd">    * RecommendationLane: Works provided by a third-party recommendation</span>
<span class="sd">      service.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">RELATED_TYPE</span>
    <span class="n">DISPLAY_NAME</span> <span class="o">=</span> <span class="s2">&quot;Related Books&quot;</span>
    <span class="n">ROUTE</span> <span class="o">=</span> <span class="s1">&#39;related_books&#39;</span>

    <span class="c1"># Cache this lane for the shortest amount of time any of its</span>
    <span class="c1"># component lane should be cached.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ContributorLane</span><span class="o">.</span><span class="n">MAX_CACHE_AGE</span><span class="p">,</span>
                        <span class="n">SeriesLane</span><span class="o">.</span><span class="n">MAX_CACHE_AGE</span><span class="p">,</span>
                        <span class="n">RecommendationLane</span><span class="o">.</span><span class="n">MAX_CACHE_AGE</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">novelist_api</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RelatedBooksLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">sublanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sublanes</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">novelist_api</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sublanes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No related books for </span><span class="si">%s</span><span class="s2"> by </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">sublanes</span>

<div class="viewcode-block" id="RelatedBooksLane.works"><a class="viewcode-back" href="../../api.html#api.lanes.RelatedBooksLane.works">[docs]</a>    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This lane never has works of its own.</span>

<span class="sd">        Only its sublanes have works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_get_sublanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">novelist_api</span><span class="p">):</span>
        <span class="n">sublanes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">contributor_lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contributor_sublanes</span><span class="p">(</span><span class="n">_db</span><span class="p">):</span>
            <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor_lane</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">recommendation_lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recommendation_sublane</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">novelist_api</span><span class="p">):</span>
            <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation_lane</span><span class="p">)</span>

        <span class="c1"># Create a series sublane.</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">series</span>
        <span class="k">if</span> <span class="n">series_name</span><span class="p">:</span>
            <span class="n">sublanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeriesLane</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">series_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sublanes</span>

    <span class="k">def</span> <span class="nf">_contributor_sublanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create contributor sublanes&quot;&quot;&quot;</span>
        <span class="n">viable_contributors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">roles_by_priority</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">author_contributor_tiers</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">while</span> <span class="n">roles_by_priority</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">viable_contributors</span><span class="p">:</span>
            <span class="n">author_roles</span> <span class="o">=</span> <span class="n">roles_by_priority</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">viable_contributors</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">contributor</span>
                                   <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="o">.</span><span class="n">contributions</span>
                                   <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">role</span> <span class="ow">in</span> <span class="n">author_roles</span><span class="p">]</span>

        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">contributor</span> <span class="ow">in</span> <span class="n">viable_contributors</span><span class="p">:</span>
            <span class="n">contributor_lane</span> <span class="o">=</span> <span class="n">ContributorLane</span><span class="p">(</span>
                <span class="n">library</span><span class="p">,</span> <span class="n">contributor</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">languages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">,</span> <span class="n">audiences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">audiences</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">contributor_lane</span>

    <span class="k">def</span> <span class="nf">_recommendation_sublane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">novelist_api</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a recommendations sublane.&quot;&quot;&quot;</span>
        <span class="n">lane_name</span> <span class="o">=</span> <span class="s2">&quot;Similar titles recommended by NoveList&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recommendation_lane</span> <span class="o">=</span> <span class="n">RecommendationLane</span><span class="p">(</span>
                <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">_db</span><span class="p">),</span> <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">,</span>
                <span class="n">display_name</span><span class="o">=</span><span class="n">lane_name</span><span class="p">,</span> <span class="n">novelist_api</span><span class="o">=</span><span class="n">novelist_api</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">recommendation_lane</span><span class="o">.</span><span class="n">recommendations</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">recommendation_lane</span>
        <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># NoveList isn&#39;t configured. This isn&#39;t fatal -- we just won&#39;t</span>
            <span class="c1"># use this sublane.</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="CrawlableFacets"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableFacets">[docs]</a><span class="k">class</span> <span class="nc">CrawlableFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A special Facets class for crawlable feeds.&quot;&quot;&quot;</span>

    <span class="n">CACHED_FEED_TYPE</span> <span class="o">=</span> <span class="n">CachedFeed</span><span class="o">.</span><span class="n">CRAWLABLE_TYPE</span>

    <span class="c1"># These facet settings are definitive of a crawlable feed.</span>
    <span class="c1"># Library configuration settings don&#39;t matter.</span>
    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_FACET_GROUP_NAME</span> <span class="p">:</span> <span class="n">Facets</span><span class="o">.</span><span class="n">ORDER_LAST_UPDATE</span><span class="p">,</span>
        <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">:</span> <span class="n">Facets</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span>
        <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FACET_GROUP_NAME</span><span class="p">:</span> <span class="n">Facets</span><span class="o">.</span><span class="n">COLLECTION_FULL</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="CrawlableFacets.available_facets"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableFacets.available_facets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available_facets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">SETTINGS</span><span class="p">[</span><span class="n">facet_group_name</span><span class="p">]]</span></div>

<div class="viewcode-block" id="CrawlableFacets.default_facet"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableFacets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SETTINGS</span><span class="p">[</span><span class="n">facet_group_name</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="CrawlableLane"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableLane">[docs]</a><span class="k">class</span> <span class="nc">CrawlableLane</span><span class="p">(</span><span class="n">DynamicLane</span><span class="p">):</span>

    <span class="c1"># By default, crawlable feeds are cached for 12 hours.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span></div>


<div class="viewcode-block" id="CrawlableCollectionBasedLane"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableCollectionBasedLane">[docs]</a><span class="k">class</span> <span class="nc">CrawlableCollectionBasedLane</span><span class="p">(</span><span class="n">CrawlableLane</span><span class="p">):</span>

    <span class="c1"># Since these collections may be shared collections, for which</span>
    <span class="c1"># recent information is very important, these feeds are only</span>
    <span class="c1"># cached for 2 hours.</span>
    <span class="n">MAX_CACHE_AGE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="n">LIBRARY_ROUTE</span> <span class="o">=</span> <span class="s2">&quot;crawlable_library_feed&quot;</span>
    <span class="n">COLLECTION_ROUTE</span> <span class="o">=</span> <span class="s2">&quot;crawlable_collection_feed&quot;</span>

<div class="viewcode-block" id="CrawlableCollectionBasedLane.initialize"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableCollectionBasedLane.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library_or_collections</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_feed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">library_or_collections</span><span class="p">,</span> <span class="n">Library</span><span class="p">):</span>
            <span class="c1"># We&#39;re looking at all the collections in a given library.</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">library_or_collections</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">collections</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We&#39;re looking at collections directly, without respect</span>
            <span class="c1"># to the libraries that might use them.</span>
            <span class="n">library</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="n">library_or_collections</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot; / &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection_feed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CrawlableCollectionBasedLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="s2">&quot;Crawlable feed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">collections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># initialize() set the collection IDs to all collections</span>
            <span class="c1"># associated with the library. We may want to restrict that</span>
            <span class="c1"># further.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_feed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_ROUTE</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION_ROUTE</span><span class="p">,</span> <span class="n">kwargs</span></div>


<div class="viewcode-block" id="CrawlableCustomListBasedLane"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableCustomListBasedLane">[docs]</a><span class="k">class</span> <span class="nc">CrawlableCustomListBasedLane</span><span class="p">(</span><span class="n">CrawlableLane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lane that consists of all works in a single CustomList.&quot;&quot;&quot;</span>

    <span class="n">ROUTE</span> <span class="o">=</span> <span class="s2">&quot;crawlable_list_feed&quot;</span>

    <span class="n">uses_customlists</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CrawlableCustomListBasedLane.initialize"><a class="viewcode-back" href="../../api.html#api.lanes.CrawlableCustomListBasedLane.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">customlist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customlist_name</span> <span class="o">=</span> <span class="n">customlist</span><span class="o">.</span><span class="n">name</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrawlableCustomListBasedLane</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="s2">&quot;Crawlable feed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">customlist_name</span><span class="p">,</span>
            <span class="n">customlists</span><span class="o">=</span><span class="p">[</span><span class="n">customlist</span><span class="p">]</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">list_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customlist_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE</span><span class="p">,</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="KnownOverviewFacetsWorkList"><a class="viewcode-back" href="../../api.html#api.lanes.KnownOverviewFacetsWorkList">[docs]</a><span class="k">class</span> <span class="nc">KnownOverviewFacetsWorkList</span><span class="p">(</span><span class="n">WorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList whose defining feature is that the Facets object</span>
<span class="sd">    to be used when generating a grouped feed is known in advance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param facets: A Facets object to be used when generating a grouped</span>
<span class="sd">           feed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KnownOverviewFacetsWorkList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span>

<div class="viewcode-block" id="KnownOverviewFacetsWorkList.overview_facets"><a class="viewcode-back" href="../../api.html#api.lanes.KnownOverviewFacetsWorkList.overview_facets">[docs]</a>    <span class="k">def</span> <span class="nf">overview_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the faceting object to be used when generating a grouped</span>
<span class="sd">        feed.</span>

<span class="sd">        :param _db: Ignored -- only present for API compatibility.</span>
<span class="sd">        :param facets: Ignored -- only present for API compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span></div></div>


<div class="viewcode-block" id="JackpotFacets"><a class="viewcode-back" href="../../api.html#api.lanes.JackpotFacets">[docs]</a><span class="k">class</span> <span class="nc">JackpotFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A faceting object for a jackpot feed.</span>

<span class="sd">    Unlike other faceting objects, AVAILABLE_NOT_NOW is an acceptable</span>
<span class="sd">    option for the availability facet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="JackpotFacets.default_facet"><a class="viewcode-back" href="../../api.html#api.lanes.JackpotFacets.default_facet">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_facet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JackpotFacets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">default_facet</span><span class="p">(</span>
                <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_NOW</span></div>

<div class="viewcode-block" id="JackpotFacets.available_facets"><a class="viewcode-back" href="../../api.html#api.lanes.JackpotFacets.available_facets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available_facets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">facet_group_name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABILITY_FACET_GROUP_NAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JackpotFacets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">available_facets</span><span class="p">(</span>
                <span class="n">config</span><span class="p">,</span> <span class="n">facet_group_name</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_NOW</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_NOT_NOW</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_ALL</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AVAILABLE_OPEN_ACCESS</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="HasSeriesFacets"><a class="viewcode-back" href="../../api.html#api.lanes.HasSeriesFacets">[docs]</a><span class="k">class</span> <span class="nc">HasSeriesFacets</span><span class="p">(</span><span class="n">Facets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A faceting object for a feed containg books guaranteed</span>
<span class="sd">    to belong to _some_ series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HasSeriesFacets.modify_search_filter"><a class="viewcode-back" href="../../api.html#api.lanes.HasSeriesFacets.modify_search_filter">[docs]</a>    <span class="k">def</span> <span class="nf">modify_search_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="JackpotWorkList"><a class="viewcode-back" href="../../api.html#api.lanes.JackpotWorkList">[docs]</a><span class="k">class</span> <span class="nc">JackpotWorkList</span><span class="p">(</span><span class="n">WorkList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WorkList guaranteed to, so far as possible, contain the exact</span>
<span class="sd">    selection of books necessary to perform common QA tasks.</span>

<span class="sd">    This makes it easy to write integration tests that work on real</span>
<span class="sd">    circulation managers and real books.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param library: A Library</span>
<span class="sd">        :param facets: A Facets object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JackpotWorkList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># Initialize a list of child Worklists; one for each test that</span>
        <span class="c1"># a client might need to run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Add one or more WorkLists for every collection in the</span>
        <span class="c1"># system, so that a client can test borrowing a book from</span>
        <span class="c1"># every collection.</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">medium</span> <span class="ow">in</span> <span class="n">Edition</span><span class="o">.</span><span class="n">FULFILLABLE_MEDIA</span><span class="p">:</span>
                <span class="c1"># Give each Worklist a name that is distinctive</span>
                <span class="c1"># and easy for a client to parse.</span>
                <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span><span class="p">:</span>
                    <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_source_name</span> <span class="o">=</span> <span class="s2">&quot;[Unknown]&quot;</span>
                <span class="n">display_name</span> <span class="o">=</span> <span class="s2">&quot;License source {</span><span class="si">%s</span><span class="s2">} - Medium {</span><span class="si">%s</span><span class="s2">} - Collection name {</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_source_name</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">KnownOverviewFacetsWorkList</span><span class="p">(</span><span class="n">facets</span><span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
                    <span class="n">library</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="p">[</span><span class="n">medium</span><span class="p">],</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span>
                <span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">collection_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

<div class="viewcode-block" id="JackpotWorkList.works"><a class="viewcode-back" href="../../api.html#api.lanes.JackpotWorkList.works">[docs]</a>    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This worklist never has works of its own.</span>

<span class="sd">        Only its children have works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>