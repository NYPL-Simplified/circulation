
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.axis &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.axis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">certifi</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">core.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>

<span class="kn">from</span> <span class="nn">core.config</span> <span class="kn">import</span> <span class="n">CannotLoadConfiguration</span>

<span class="kn">from</span> <span class="nn">core.coverage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BibliographicCoverageProvider</span><span class="p">,</span>
    <span class="n">CoverageFailure</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">ContributorData</span><span class="p">,</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">IdentifierData</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">Metadata</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">SubjectData</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LinkRelations</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">MediaTypes</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.monitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionMonitor</span><span class="p">,</span>
    <span class="n">IdentifierSweepMonitor</span><span class="p">,</span>
    <span class="n">TimelineMonitor</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">DatabaseTest</span>

<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_utc</span><span class="p">,</span>
    <span class="n">strptime_utc</span><span class="p">,</span>
    <span class="n">utc_now</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.flask_util</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HTTP</span><span class="p">,</span>
    <span class="n">RequestNetworkException</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.string_helpers</span> <span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="nn">core.util.xmlparser</span> <span class="kn">import</span> <span class="n">XMLParser</span>

<span class="kn">from</span> <span class="nn">.authenticator</span> <span class="kn">import</span> <span class="n">Authenticator</span>

<span class="kn">from</span> <span class="nn">.circulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">APIAwareFulfillmentInfo</span><span class="p">,</span>
    <span class="n">LoanInfo</span><span class="p">,</span>
    <span class="n">FulfillmentInfo</span><span class="p">,</span>
    <span class="n">HoldInfo</span><span class="p">,</span>
    <span class="n">BaseCirculationAPI</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.circulation_exceptions</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">.selftest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HasCollectionSelfTests</span><span class="p">,</span>
    <span class="n">SelfTestResult</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.web_publication_manifest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FindawayManifest</span><span class="p">,</span>
    <span class="n">SpineItem</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="Axis360APIConstants"><a class="viewcode-back" href="../../api.html#api.axis.Axis360APIConstants">[docs]</a><span class="k">class</span> <span class="nc">Axis360APIConstants</span><span class="p">:</span>
    <span class="n">VERIFY_SSL</span> <span class="o">=</span> <span class="s2">&quot;verify_certificate&quot;</span></div>


<div class="viewcode-block" id="Axis360API"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API">[docs]</a><span class="k">class</span> <span class="nc">Axis360API</span><span class="p">(</span><span class="n">Authenticator</span><span class="p">,</span> <span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">Axis360APIConstants</span><span class="p">,</span> <span class="n">HasCollectionSelfTests</span><span class="p">):</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span>

    <span class="n">SET_DELIVERY_MECHANISM_AT</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">BORROW_STEP</span>

    <span class="n">ALLOW_ANONYMOUS_ACCESS_SETTING</span> <span class="o">=</span> <span class="s2">&quot;allow_anonymous_access&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Axis 360&quot;</span>
    <span class="n">PRODUCTION_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://axis360api.baker-taylor.com/Services/VendorAPI/&quot;</span>
    <span class="n">QA_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;http://axis360apiqa.baker-taylor.com/Services/VendorAPI/&quot;</span>
    <span class="n">SERVER_NICKNAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;production&quot;</span> <span class="p">:</span> <span class="n">PRODUCTION_BASE_URL</span><span class="p">,</span>
        <span class="s2">&quot;qa&quot;</span> <span class="p">:</span> <span class="n">QA_BASE_URL</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2">-%Y %H:%M:%S&quot;</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Username&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library ID&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Server&quot;</span><span class="p">),</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">PRODUCTION_BASE_URL</span><span class="p">,</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span>
          <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">SERVER_NICKNAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Axis360APIConstants</span><span class="o">.</span><span class="n">VERIFY_SSL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Verify SSL Certificate&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;This should always be True in production, it may need to be set to False to use the&quot;</span>
            <span class="s2">&quot;Axis 360 QA Environment.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">),</span>
              <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;False&quot;</span><span class="p">),</span>
              <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ALLOW_ANONYMOUS_ACCESS_SETTING</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Allow anonymous access&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;If you&#39;re associating an Axis 360 collection with a library that doesn&#39;t take any steps to authenticate its patrons, you&#39;ll need to disable this safety setting to explicitly allow anonymous access to the collection. Most libraries authenticate their patrons, so allowing only authenticated access is the right choice in almost all situations.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Allow only authenticated access to this collection&#39;s titles&quot;</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Allow anonymous access to this collection&#39;s titles&quot;</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">DEFAULT_LOAN_DURATION_SETTING</span>
    <span class="p">]</span>

    <span class="n">access_token_endpoint</span> <span class="o">=</span> <span class="s1">&#39;accesstoken&#39;</span>
    <span class="n">availability_endpoint</span> <span class="o">=</span> <span class="s1">&#39;availability/v2&#39;</span>
    <span class="n">fulfillment_endpoint</span> <span class="o">=</span> <span class="s1">&#39;getfullfillmentInfo/v2&#39;</span>
    <span class="n">audiobook_metadata_endpoint</span> <span class="o">=</span> <span class="s1">&#39;getaudiobookmetadata/v2&#39;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Axis 360 API&quot;</span><span class="p">)</span>

    <span class="c1"># Create a lookup table between common DeliveryMechanism identifiers</span>
    <span class="c1"># and Axis 360 format types.</span>
    <span class="n">epub</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span>
    <span class="n">adobe_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
    <span class="n">findaway_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span>
    <span class="n">no_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span>
    <span class="n">axisnow_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">AXISNOW_DRM</span>

    <span class="c1"># The name Axis 360 gives to its web interface. We use it as the</span>
    <span class="c1"># name for the underlying access control system.</span>
    <span class="n">AXISNOW</span> <span class="o">=</span> <span class="s2">&quot;AxisNow&quot;</span>

    <span class="n">delivery_mechanism_to_internal_format</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">epub</span><span class="p">,</span> <span class="n">no_drm</span><span class="p">):</span> <span class="s1">&#39;ePub&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">epub</span><span class="p">,</span> <span class="n">adobe_drm</span><span class="p">):</span> <span class="s1">&#39;ePub&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">no_drm</span><span class="p">):</span> <span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">adobe_drm</span><span class="p">):</span> <span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">findaway_drm</span><span class="p">):</span> <span class="s1">&#39;Acoustik&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axisnow_drm</span><span class="p">):</span> <span class="n">AXISNOW</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection protocol is </span><span class="si">%s</span><span class="s2">, but passed into Axis360API!&quot;</span> <span class="o">%</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>

        <span class="c1"># Anonymous access is only allowed a) for libraries that don&#39;t</span>
        <span class="c1"># authenticate patrons, b) if this setting is set to True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_anonymous_access</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALLOW_ANONYMOUS_ACCESS_SETTING</span>
        <span class="p">)</span><span class="o">.</span><span class="n">bool_value</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="c1"># Convert the nickname for a server into an actual URL.</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRODUCTION_BASE_URL</span>
        <span class="k">if</span> <span class="n">base_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVER_NICKNAMES</span><span class="p">:</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVER_NICKNAMES</span><span class="p">[</span><span class="n">base_url</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Axis 360 configuration is incomplete.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Use utf8 instead of unicode encoding</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">setting</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="n">verify_certificate</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VERIFY_SSL</span><span class="p">)</span><span class="o">.</span><span class="n">bool_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_certificate</span> <span class="o">=</span> <span class="n">verify_certificate</span> <span class="k">if</span> <span class="n">verify_certificate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authorization_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">])</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">authorization</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf_16_le&quot;</span><span class="p">)</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">authorization</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Authorization</span><span class="o">=</span><span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">authorization</span><span class="p">)</span>

<div class="viewcode-block" id="Axis360API.external_integration"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span></div>

<div class="viewcode-block" id="Axis360API.can_fulfill_without_loan"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.can_fulfill_without_loan">[docs]</a>    <span class="k">def</span> <span class="nf">can_fulfill_without_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A LicensePool can be fulfilled without a loan</span>
<span class="sd">        if a) the library allows for it, and b) the delivery mechanism</span>
<span class="sd">        is either AxisNow or unspecified (in which case AxisNow is an option).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">patron</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_anonymous_access</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">lpdm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                 <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">drm_scheme</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">axisnow_drm</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Refreshing bearer token&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_bearer_token</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t get a bearer token, there&#39;s no point running</span>
            <span class="c1"># the rest of the tests.</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">_count_events</span><span class="p">():</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
            <span class="n">five_minutes_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recent_activity</span><span class="p">(</span><span class="n">since</span><span class="o">=</span><span class="n">five_minutes_ago</span><span class="p">)))</span>
            <span class="k">return</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> event(s)&quot;</span> <span class="o">%</span> <span class="n">count</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Asking for circulation events for the last five minutes&quot;</span><span class="p">,</span>
            <span class="n">_count_events</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_patrons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">SelfTestResult</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>
                <span class="k">continue</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">def</span> <span class="nf">_count_activity</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_activity</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> loans/holds&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
                <span class="s2">&quot;Checking activity for test patron for library </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">_count_activity</span>
            <span class="p">)</span>

        <span class="c1"># Run the tests defined by HasCollectionSelfTests</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">Axis360API</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_run_self_tests</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">result</span>

<div class="viewcode-block" id="Axis360API.refresh_bearer_token"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.refresh_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token_endpoint</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_headers</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_token</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Axis360API.request"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exception_on_401</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request, acquiring/refreshing a bearer token</span>
<span class="sd">        if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_bearer_token</span><span class="p">()</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span>
        <span class="k">if</span> <span class="n">exception_on_401</span><span class="p">:</span>
            <span class="n">disallowed_response_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;401&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">disallowed_response_codes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">disallowed_response_codes</span><span class="o">=</span><span class="n">disallowed_response_codes</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
            <span class="c1"># This must be our first 401, since our second 401 will</span>
            <span class="c1"># make _make_request raise a RemoteIntegrationException.</span>
            <span class="c1">#</span>
            <span class="c1"># The token has expired. Get a new token and try again.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="n">extra_headers</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">exception_on_401</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Axis360API.availability"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.availability">[docs]</a>    <span class="k">def</span> <span class="nf">availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title_ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability_endpoint</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">since</span><span class="p">:</span>
            <span class="n">since</span> <span class="o">=</span> <span class="n">since</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;updatedDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">since</span>
        <span class="k">if</span> <span class="n">patron_id</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;patronId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patron_id</span>
        <span class="k">if</span> <span class="n">title_ids</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;titleIds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title_ids</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Axis360API.get_fulfillment_info"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.get_fulfillment_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_fulfillment_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a call to the getFulfillmentInfoAPI.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulfillment_endpoint</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">TransactionID</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="Axis360API.get_audiobook_metadata"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.get_audiobook_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_audiobook_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">findaway_content_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a call to the getaudiobookmetadata endpoint.&quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">audiobook_metadata_endpoint</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fndcontentid</span><span class="o">=</span><span class="n">findaway_content_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Axis360API.checkin"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a book early.</span>

<span class="sd">        :param patron: The Patron who wants to return their book.</span>
<span class="sd">        :param pin: Not used.</span>
<span class="sd">        :param licensepool: LicensePool for the book to be returned.</span>
<span class="sd">        :raise CirculationException: If the API can&#39;t carry out the operation.</span>
<span class="sd">        :raise RemoteInitiatedServerError: If the API is down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkin</span><span class="p">(</span><span class="n">title_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CheckinResponseParser</span><span class="p">(</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span>
            <span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLSyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a request to the EarlyCheckInTitle endpoint.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;EarlyCheckInTitle/v3?itemID=</span><span class="si">%s</span><span class="s2">&amp;patronID=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">title_id</span><span class="p">),</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Axis360API.checkout"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="n">title_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="c1"># Patron object was provided; this is the normal path.</span>
            <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># patron ID was provided directly, probably because it&#39;s</span>
            <span class="c1"># a UUID generated by fulfill()</span>
            <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkout</span><span class="p">(</span><span class="n">title_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CheckoutResponseParser</span><span class="p">(</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLSyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;checkout/v2&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">titleId</span><span class="o">=</span><span class="n">title_id</span><span class="p">,</span> <span class="n">patronId</span><span class="o">=</span><span class="n">patron_id</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="n">internal_format</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="Axis360API.fulfill"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fulfill a patron&#39;s request for a specific book.</span>

<span class="sd">        :param kwargs: A container for arguments to fulfill()</span>
<span class="sd">           which are not relevant to this vendor.</span>

<span class="sd">        :return: a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">patron</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># An attempt to fulfill anonymously.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_fulfill_without_loan</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># This collection does not allow anonymous fulfillment.</span>
                <span class="k">raise</span> <span class="n">NoActiveLoan</span><span class="p">()</span>

            <span class="c1"># Make up a throwaway patron ID and check out the book</span>
            <span class="c1"># under that ID.</span>
            <span class="n">patron</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">checkout_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span>
                <span class="n">patron</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span>
            <span class="p">)</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="c1"># Check if the Patron&#39;s Loan has</span>
            <span class="c1"># a transaction ID as an external_identifier</span>
            <span class="n">loan</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="n">licensepool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loan</span> <span class="ow">and</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">:</span>
                <span class="c1"># Skip the availability API call and return fulfillment</span>
                <span class="n">fulfillment</span> <span class="o">=</span> <span class="n">Axis360FulfillmentInfo</span><span class="p">(</span>
                    <span class="n">api</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">,</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">fulfillment</span>

        <span class="c1"># This should include only one &#39;activity&#39;.</span>
        <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_activity</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">LoanInfo</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">loan</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">==</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span>
                    <span class="ow">and</span> <span class="n">loan</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># We&#39;ve found the remote loan corresponding to this</span>
            <span class="c1"># license pool.</span>
            <span class="n">fulfillment</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">fulfillment_info</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fulfillment</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fulfillment</span><span class="p">,</span> <span class="n">FulfillmentInfo</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">Patron</span><span class="p">)</span> <span class="ow">and</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">:</span>
                <span class="c1"># Save the external_identifier to the Patron&#39;s Loan for future retrieval</span>
                <span class="n">patron_loan</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">=</span><span class="n">licensepool</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">patron_loan</span><span class="p">:</span>
                    <span class="n">patron_loan</span><span class="o">.</span><span class="n">external_identifier</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span>

            <span class="k">return</span> <span class="n">fulfillment</span>
        <span class="c1"># If we made it to this point, the patron does not have this</span>
        <span class="c1"># book checked out.</span>
        <span class="k">raise</span> <span class="n">NoActiveLoan</span><span class="p">()</span></div>

<div class="viewcode-block" id="Axis360API.place_hold"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">hold_notification_email</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold_notification_email</span><span class="p">:</span>
            <span class="n">hold_notification_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_notification_email_address</span><span class="p">(</span>
                <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span>
            <span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;addtoHold/v2&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">title_id</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">titleId</span><span class="o">=</span><span class="n">title_id</span><span class="p">,</span> <span class="n">patronId</span><span class="o">=</span><span class="n">patron_id</span><span class="p">,</span>
                      <span class="n">email</span><span class="o">=</span><span class="n">hold_notification_email</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">hold_info</span> <span class="o">=</span> <span class="n">HoldResponseParser</span><span class="p">(</span><span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold_info</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="c1"># The Axis 360 API doesn&#39;t return the identifier of the</span>
            <span class="c1"># item that was placed on hold, so we have to fill it in</span>
            <span class="c1"># based on our own knowledge.</span>
            <span class="n">hold_info</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">type</span>
            <span class="n">hold_info</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">return</span> <span class="n">hold_info</span></div>

<div class="viewcode-block" id="Axis360API.release_hold"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;removeHold/v2&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">title_id</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">titleId</span><span class="o">=</span><span class="n">title_id</span><span class="p">,</span> <span class="n">patronId</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">HoldReleaseResponseParser</span><span class="p">(</span><span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotOnHold</span><span class="p">:</span>
            <span class="c1"># Fine, it wasn&#39;t on hold and now it&#39;s still not on hold.</span>
            <span class="k">pass</span>
        <span class="c1"># If we didn&#39;t raise an exception, we&#39;re fine.</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Axis360API.patron_activity"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">internal_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="c1"># This is the normal path.</span>
            <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is the path of anonymous fulfillment; the &quot;patron&quot;</span>
            <span class="c1"># is a UUID corresponding to a throwaway account.</span>
            <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">title_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">(</span>
            <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">,</span>
            <span class="n">title_ids</span><span class="o">=</span><span class="n">title_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">AvailabilityResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
            <span class="n">availability</span><span class="o">.</span><span class="n">content</span><span class="p">))</span></div>

<div class="viewcode-block" id="Axis360API.update_availability"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.update_availability">[docs]</a>    <span class="k">def</span> <span class="nf">update_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the availability information for a single LicensePool.</span>

<span class="sd">        Part of the CirculationAPI interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_licensepools_for_identifiers</span><span class="p">([</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="p">])</span></div>

<div class="viewcode-block" id="Axis360API.update_licensepools_for_identifiers"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.update_licensepools_for_identifiers">[docs]</a>    <span class="k">def</span> <span class="nf">update_licensepools_for_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update availability and bibliographic information for</span>
<span class="sd">        a list of books.</span>

<span class="sd">        If the book has never been seen before, a new LicensePool</span>
<span class="sd">        will be created for the book.</span>

<span class="sd">        The book&#39;s LicensePool will be updated with current</span>
<span class="sd">        circulation information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">availability</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_remote_availability</span><span class="p">(</span>
                <span class="n">identifiers</span>
        <span class="p">):</span>
            <span class="n">edition</span><span class="p">,</span> <span class="n">ignore1</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">ignore2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_book</span><span class="p">(</span>
                <span class="n">bibliographic</span><span class="p">,</span> <span class="n">availability</span>
            <span class="p">)</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">remainder</span><span class="p">:</span>
                <span class="n">remainder</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

        <span class="c1"># We asked Axis about n books. It sent us n-k responses. Those</span>
        <span class="c1"># k books are the identifiers in `remainder`. These books have</span>
        <span class="c1"># been removed from the collection without us being notified.</span>
        <span class="k">for</span> <span class="n">removed_identifier</span> <span class="ow">in</span> <span class="n">remainder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reap</span><span class="p">(</span><span class="n">removed_identifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="Axis360API.update_book"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.update_book">[docs]</a>    <span class="k">def</span> <span class="nf">update_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">availability</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create or update a single book based on bibliographic</span>
<span class="sd">        and availability data from the Axis 360 API.</span>

<span class="sd">        :param bibliographic: A Metadata object containing</span>
<span class="sd">            bibliographic data about this title.</span>
<span class="sd">        :param availability: A CirculationData object containing</span>
<span class="sd">            availability data about this title.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analytics</span> <span class="o">=</span> <span class="n">analytics</span> <span class="ow">or</span> <span class="n">Analytics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">new_license_pool</span> <span class="o">=</span> <span class="n">availability</span><span class="o">.</span><span class="n">license_pool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">analytics</span>
        <span class="p">)</span>
        <span class="n">edition</span><span class="p">,</span> <span class="n">new_edition</span> <span class="o">=</span> <span class="n">bibliographic</span><span class="o">.</span><span class="n">edition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">license_pool</span><span class="o">.</span><span class="n">edition</span> <span class="o">=</span> <span class="n">edition</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="n">analytics</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># NOTE: availability is bibliographic.circulation, so it&#39;s a</span>
        <span class="c1"># little redundant to call availability.apply() -- it&#39;s taken</span>
        <span class="c1"># care of inside bibliographic.apply().</span>
        <span class="n">bibliographic</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">availability</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edition</span><span class="p">,</span> <span class="n">new_edition</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">new_license_pool</span></div>

    <span class="k">def</span> <span class="nf">_fetch_remote_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve availability information for the specified identifiers.</span>

<span class="sd">        :yield: A stream of (Metadata, CirculationData) 2-tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_identifier_strings</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">(</span><span class="n">title_ids</span><span class="o">=</span><span class="n">identifier_strings</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">BibliographicParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update our local circulation information to reflect the fact that</span>
<span class="sd">        the identified book has been removed from the remote</span>
<span class="sd">        collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Was about to reap </span><span class="si">%r</span><span class="s2"> but no local license pool in this collection.&quot;</span><span class="p">,</span>
                <span class="n">identifier</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Already reaped.</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reaping </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

        <span class="n">availability</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">licenses_owned</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">licenses_available</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">licenses_reserved</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">patrons_in_hold_queue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">availability</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span>
            <span class="n">ReplacementPolicy</span><span class="o">.</span><span class="n">from_license_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Axis360API.recent_activity"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.recent_activity">[docs]</a>    <span class="k">def</span> <span class="nf">recent_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">since</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find books that have had recent activity.</span>

<span class="sd">        :yield: A sequence of (Metadata, CirculationData) 2-tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">(</span><span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">availability</span><span class="o">.</span><span class="n">content</span>
        <span class="k">for</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span> <span class="ow">in</span> <span class="n">BibliographicParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">content</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span></div>

<div class="viewcode-block" id="Axis360API.create_identifier_strings"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.create_identifier_strings">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_identifier_strings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="n">identifier_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">identifier</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">identifier_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">identifier_strings</span></div>

<div class="viewcode-block" id="Axis360API.parse_token"><a class="viewcode-back" href="../../api.html#api.axis.Axis360API.parse_token">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_token</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually make an HTTP request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">request_with_timeout</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Axis360CirculationMonitor"><a class="viewcode-back" href="../../api.html#api.axis.Axis360CirculationMonitor">[docs]</a><span class="k">class</span> <span class="nc">Axis360CirculationMonitor</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">,</span> <span class="n">TimelineMonitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Maintain LicensePools for Axis 360 titles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Axis 360 Circulation Monitor&quot;</span>
    <span class="n">INTERVAL_SECONDS</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span>

    <span class="n">DEFAULT_START_TIME</span> <span class="o">=</span> <span class="n">datetime_utc</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">Axis360API</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Axis360CirculationMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">Axis360API</span><span class="p">):</span>
            <span class="c1"># Use a preexisting Axis360API instance rather than</span>
            <span class="c1"># creating a new one.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BATCH_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Axis360BibliographicCoverageProvider</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Axis360CirculationMonitor.catch_up_from"><a class="viewcode-back" href="../../api.html#api.axis.Axis360CirculationMonitor.catch_up_from">[docs]</a>    <span class="k">def</span> <span class="nf">catch_up_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find Axis 360 books that changed recently.</span>

<span class="sd">        :progress: A TimestampData representing the time previously</span>
<span class="sd">            covered by this Monitor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">recent_activity</span><span class="p">(</span><span class="n">start</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_book</span><span class="p">(</span><span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">achievements</span> <span class="o">=</span> <span class="s2">&quot;Modified titles: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">count</span></div>

<div class="viewcode-block" id="Axis360CirculationMonitor.process_book"><a class="viewcode-back" href="../../api.html#api.axis.Axis360CirculationMonitor.process_book">[docs]</a>    <span class="k">def</span> <span class="nf">process_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span><span class="p">):</span>
        <span class="n">edition</span><span class="p">,</span> <span class="n">new_edition</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">new_license_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">update_book</span><span class="p">(</span>
            <span class="n">bibliographic</span><span class="p">,</span> <span class="n">circulation</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">new_license_pool</span> <span class="ow">or</span> <span class="n">new_edition</span><span class="p">:</span>
            <span class="c1"># At this point we have done work equivalent to that done by</span>
            <span class="c1"># the Axis360BibliographicCoverageProvider. Register that the</span>
            <span class="c1"># work has been done so we don&#39;t have to do it again.</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span><span class="o">.</span><span class="n">handle_success</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span><span class="o">.</span><span class="n">add_coverage_record_for</span><span class="p">(</span>
                <span class="n">identifier</span>
            <span class="p">)</span>


        <span class="k">return</span> <span class="n">edition</span><span class="p">,</span> <span class="n">license_pool</span></div></div>


<div class="viewcode-block" id="MockAxis360API"><a class="viewcode-back" href="../../api.html#api.axis.MockAxis360API">[docs]</a><span class="k">class</span> <span class="nc">MockAxis360API</span><span class="p">(</span><span class="n">Axis360API</span><span class="p">):</span>
<div class="viewcode-block" id="MockAxis360API.mock_collection"><a class="viewcode-back" href="../../api.html#api.axis.MockAxis360API.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test Axis 360 Collection&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mock Axis 360 collection for use in tests.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://axis.test/&quot;</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">with_token</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: Get Axis 360 credentials from this</span>
<span class="sd">            Collection.</span>

<span class="sd">        :param with_token: If True, this class will assume that</span>
<span class="sd">            it already has a valid token, and will not go through</span>
<span class="sd">            the motions of negotiating one with the mock server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockAxis360API</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_token</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;mock token&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MockAxis360API.queue_response"><a class="viewcode-back" href="../../api.html#api.axis.MockAxis360API.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">MockRequestsResponse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Axis360BibliographicCoverageProvider"><a class="viewcode-back" href="../../api.html#api.axis.Axis360BibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">Axis360BibliographicCoverageProvider</span><span class="p">(</span><span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill in bibliographic metadata for Axis 360 records.</span>

<span class="sd">    Currently this is only used by BibliographicRefreshScript. It&#39;s</span>
<span class="sd">    not normally necessary because the Axis 360 API combines</span>
<span class="sd">    bibliographic and availability data. We rely on Monitors to fetch</span>
<span class="sd">    availability data and fill in the bibliographic data as necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Axis 360 Bibliographic Coverage Provider&quot;</span>
    <span class="n">DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span>
    <span class="n">INPUT_IDENTIFIER_TYPES</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">Axis360API</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: Provide bibliographic coverage to all</span>
<span class="sd">            Axis 360 books in the given Collection.</span>
<span class="sd">        :param api_class: Instantiate this class with the given Collection,</span>
<span class="sd">            rather than instantiating Axis360API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Axis360BibliographicCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">Axis360API</span><span class="p">):</span>
            <span class="c1"># We were given a specific Axis360API instance to use.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A web application should not use this option because it</span>
            <span class="c1"># will put a non-scoped session in the mix.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">BibliographicParser</span><span class="p">()</span>

<div class="viewcode-block" id="Axis360BibliographicCoverageProvider.process_batch"><a class="viewcode-back" href="../../api.html#api.axis.Axis360BibliographicCoverageProvider.process_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="n">identifier_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">create_identifier_strings</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">availability</span><span class="p">(</span><span class="n">title_ids</span><span class="o">=</span><span class="n">identifier_strings</span><span class="p">)</span>
        <span class="n">seen_identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">availability</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
                <span class="c1"># Axis 360 told us about a book we didn&#39;t ask</span>
                <span class="c1"># for. This shouldn&#39;t happen, but if it does we should</span>
                <span class="c1"># do nothing further.</span>
                <span class="k">continue</span>
            <span class="n">seen_identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">CoverageFailure</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_success</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Create a CoverageFailure object for each original identifier</span>
        <span class="c1"># not mentioned in the results.</span>
        <span class="k">for</span> <span class="n">identifier_string</span> <span class="ow">in</span> <span class="n">identifier_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier_string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_identifiers</span><span class="p">:</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">,</span> <span class="n">identifier_string</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span>
                    <span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;Book not in collection&quot;</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_results</span></div>

<div class="viewcode-block" id="Axis360BibliographicCoverageProvider.handle_success"><a class="viewcode-back" href="../../api.html#api.axis.Axis360BibliographicCoverageProvider.handle_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_presentation_ready</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="Axis360BibliographicCoverageProvider.process_item"><a class="viewcode-back" href="../../api.html#api.axis.Axis360BibliographicCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">([</span><span class="n">identifier</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="AxisCollectionReaper"><a class="viewcode-back" href="../../api.html#api.axis.AxisCollectionReaper">[docs]</a><span class="k">class</span> <span class="nc">AxisCollectionReaper</span><span class="p">(</span><span class="n">IdentifierSweepMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for books that are in the local collection but have left our</span>
<span class="sd">    Axis 360 collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Axis Collection Reaper&quot;</span>
    <span class="n">INTERVAL_SECONDS</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">*</span><span class="mi">12</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">AXIS_360</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">Axis360API</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AxisCollectionReaper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">Axis360API</span><span class="p">):</span>
            <span class="c1"># Use a preexisting Axis360API instance rather than</span>
            <span class="c1"># creating a new one.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="AxisCollectionReaper.process_items"><a class="viewcode-back" href="../../api.html#api.axis.AxisCollectionReaper.process_items">[docs]</a>    <span class="k">def</span> <span class="nf">process_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">update_licensepools_for_identifiers</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Axis360Parser"><a class="viewcode-back" href="../../api.html#api.axis.Axis360Parser">[docs]</a><span class="k">class</span> <span class="nc">Axis360Parser</span><span class="p">(</span><span class="n">XMLParser</span><span class="p">):</span>

    <span class="n">NS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;axis&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axis360api.baker-taylor.com/vendorAPI&quot;</span><span class="p">}</span>

    <span class="n">SHORT_DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span>
    <span class="n">FULL_DATE_FORMAT_IMPLICIT_UTC</span> <span class="o">=</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p&quot;</span>
    <span class="n">FULL_DATE_FORMAT_EXPLICIT_UTC</span> <span class="o">=</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p +00:00&quot;</span>

    <span class="k">def</span> <span class="nf">_pd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stupid function to parse a date.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">date</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FULL_DATE_FORMAT_IMPLICIT_UTC</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FULL_DATE_FORMAT_EXPLICIT_UTC</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_xpath1_boolean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_xpath1_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pd</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliographicParser"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser">[docs]</a><span class="k">class</span> <span class="nc">BibliographicParser</span><span class="p">(</span><span class="n">Axis360Parser</span><span class="p">):</span>

    <span class="n">DELIVERY_DATA_FOR_AXIS_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Blio&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>   <span class="c1"># Legacy format, handled the same way as AxisNow</span>
        <span class="s2">&quot;Acoustik&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span><span class="p">),</span> <span class="c1"># Audiobooks</span>
        <span class="s2">&quot;AxisNow&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Handled specially, for ebooks only.</span>
        <span class="s2">&quot;ePub&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span><span class="p">),</span>
        <span class="s2">&quot;PDF&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="n">Representation</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Axis 360 Bibliographic Parser&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BibliographicParser.parse_list"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.parse_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn strings like this into lists:</span>

<span class="sd">        FICTION / Thrillers; FICTION / Suspense; FICTION / General</span>
<span class="sd">        Ursu, Anne ; Fortune, Eric (ILT)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_availability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_bibliographic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_availability</span> <span class="o">=</span> <span class="n">include_availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_bibliographic</span> <span class="o">=</span> <span class="n">include_bibliographic</span>

<div class="viewcode-block" id="BibliographicParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">BibliographicParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:title&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span></div>

<div class="viewcode-block" id="BibliographicParser.extract_availability"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.extract_availability">[docs]</a>    <span class="k">def</span> <span class="nf">extract_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circulation_data</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:titleId&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">circulation_data</span><span class="p">:</span>
            <span class="n">circulation_data</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:availability&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">total_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_subtag</span><span class="p">(</span><span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:totalCopies&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">available_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_subtag</span><span class="p">(</span>
            <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:availableCopies&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">size_of_hold_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_subtag</span><span class="p">(</span>
            <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:holdsQueueSize&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="n">availability_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:updateDate&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">availability_updated</span><span class="p">:</span>
            <span class="c1"># NOTE: We don&#39;t actually do anything with this.</span>
            <span class="n">availability_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pd</span><span class="p">(</span><span class="n">availability_updated</span><span class="p">)</span>

        <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_owned</span><span class="o">=</span><span class="n">total_copies</span>
        <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_available</span><span class="o">=</span><span class="n">available_copies</span>
        <span class="n">circulation_data</span><span class="o">.</span><span class="n">licenses_reserved</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">circulation_data</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span><span class="o">=</span><span class="n">size_of_hold_queue</span>

        <span class="k">return</span> <span class="n">circulation_data</span></div>


    <span class="c1"># Axis authors with a special role have an abbreviation after their names,</span>
    <span class="c1"># e.g. &quot;San Ruby (FRW)&quot;</span>
    <span class="n">role_abbreviation</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\(([A-Z][A-Z][A-Z])\)$&quot;</span><span class="p">)</span>
    <span class="n">generic_author</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
    <span class="n">role_abbreviation_to_role</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">INT</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">INTRODUCTION_ROLE</span><span class="p">,</span>
        <span class="n">EDT</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">EDITOR_ROLE</span><span class="p">,</span>
        <span class="n">PHT</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">PHOTOGRAPHER_ROLE</span><span class="p">,</span>
        <span class="n">ILT</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">ILLUSTRATOR_ROLE</span><span class="p">,</span>
        <span class="n">TRN</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">TRANSLATOR_ROLE</span><span class="p">,</span>
        <span class="n">FRW</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">FOREWORD_ROLE</span><span class="p">,</span>
        <span class="n">ADP</span><span class="o">=</span><span class="n">generic_author</span><span class="p">,</span> <span class="c1"># Author of adaptation</span>
        <span class="n">COR</span><span class="o">=</span><span class="n">generic_author</span><span class="p">,</span> <span class="c1"># Corporate author</span>
    <span class="p">)</span>

<div class="viewcode-block" id="BibliographicParser.parse_contributor"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.parse_contributor">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_contributor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">primary_author_found</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">force_role</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse an Axis 360 contributor string.</span>

<span class="sd">        The contributor string looks like &quot;Butler, Octavia&quot; or &quot;Walt</span>
<span class="sd">        Disney Pictures (COR)&quot; or &quot;Rex, Adam (ILT)&quot;. The optional</span>
<span class="sd">        three-letter code describes the contributor&#39;s role in the</span>
<span class="sd">        book.</span>

<span class="sd">        :param author: The string to parse.</span>

<span class="sd">        :param primary_author_found: If this is false, then a</span>
<span class="sd">            contributor with no three-letter code will be treated as</span>
<span class="sd">            the primary author. If this is true, then a contributor</span>
<span class="sd">            with no three-letter code will be treated as just a</span>
<span class="sd">            regular author.</span>

<span class="sd">        :param force_role: If this is set, the contributor will be</span>
<span class="sd">            assigned this role, no matter what. This takes precedence</span>
<span class="sd">            over the value implied by primary_author_found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">primary_author_found</span><span class="p">:</span>
            <span class="n">default_author_role</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_author_role</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">default_author_role</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">role_abbreviation</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">role_type</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">role</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">role_abbreviation_to_role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">role_type</span><span class="p">,</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">UNKNOWN_ROLE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="bp">cls</span><span class="o">.</span><span class="n">generic_author</span><span class="p">:</span>
                <span class="n">role</span> <span class="o">=</span> <span class="n">default_author_role</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force_role</span><span class="p">:</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">force_role</span>
        <span class="k">return</span> <span class="n">ContributorData</span><span class="p">(</span>
            <span class="n">sort_name</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BibliographicParser.extract_bibliographic"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.extract_bibliographic">[docs]</a>    <span class="k">def</span> <span class="nf">extract_bibliographic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn bibliographic metadata into a Metadata and a CirculationData objects,</span>
<span class="sd">        and return them as a tuple.&quot;&quot;&quot;</span>

        <span class="c1"># TODO: These are consistently empty (some are clearly for</span>
        <span class="c1"># audiobooks) so I don&#39;t know what they do and/or what format</span>
        <span class="c1"># they&#39;re in.</span>
        <span class="c1">#</span>
        <span class="c1"># edition</span>
        <span class="c1"># runtime</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:titleId&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">isbn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:isbn&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:productTitle&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="n">contributor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:contributor&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">contributors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_primary_author</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">contributor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_list</span><span class="p">(</span><span class="n">contributor</span><span class="p">):</span>
                <span class="n">contributor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_contributor</span><span class="p">(</span>
                    <span class="n">c</span><span class="p">,</span> <span class="n">found_primary_author</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span> <span class="ow">in</span> <span class="n">contributor</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                    <span class="n">found_primary_author</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

        <span class="n">narrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:narrator&#39;</span><span class="p">,</span> <span class="n">ns</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">narrator</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_list</span><span class="p">(</span><span class="n">narrator</span><span class="p">):</span>
                <span class="n">contributor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_contributor</span><span class="p">(</span>
                    <span class="n">n</span><span class="p">,</span> <span class="n">force_role</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">NARRATOR_ROLE</span>
                <span class="p">)</span>
                <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:annotation&#39;</span><span class="p">,</span> <span class="n">ns</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">LinkData</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                    <span class="n">media_type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">TEXT_PLAIN</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:subject&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">subject</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subject_identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_list</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span>
                <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SubjectData</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">BISAC</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">subject_identifier</span><span class="p">,</span>
                        <span class="n">weight</span><span class="o">=</span><span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">publication_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:publicationDate&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publication_date</span><span class="p">:</span>
            <span class="n">publication_date</span> <span class="o">=</span> <span class="n">strptime_utc</span><span class="p">(</span>
                <span class="n">publication_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHORT_DATE_FORMAT</span>
            <span class="p">)</span>

        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:series&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:publisher&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">imprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:imprint&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="n">audience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:audience&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audience</span><span class="p">:</span>
            <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SubjectData</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">AXIS_360_AUDIENCE</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:language&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:imageUrl&#39;</span><span class="p">,</span> <span class="n">ns</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">thumbnail_url</span><span class="p">:</span>
            <span class="c1"># We presume all images from this service are JPEGs.</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">JPEG_MEDIA_TYPE</span>
            <span class="k">if</span> <span class="s1">&#39;/Medium/&#39;</span> <span class="ow">in</span> <span class="n">thumbnail_url</span><span class="p">:</span>
                <span class="c1"># We know about a URL hack for this service that lets us</span>
                <span class="c1"># get a larger image.</span>
                <span class="n">full_size_url</span> <span class="o">=</span> <span class="n">thumbnail_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/Medium/&quot;</span><span class="p">,</span> <span class="s2">&quot;/Large/&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the URL hack won&#39;t work, treat the image we got</span>
                <span class="c1"># as both the full-sized image and its thumbnail.</span>
                <span class="c1"># This won&#39;t happen unless B&amp;T changes the service.</span>
                <span class="n">full_size_url</span> <span class="o">=</span> <span class="n">thumbnail_url</span>

            <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">LinkRelations</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="n">thumbnail_url</span><span class="p">,</span>
                <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span>
            <span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">LinkRelations</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="n">full_size_url</span><span class="p">,</span>
                <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">,</span>
                <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnail</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># We don&#39;t use this for anything.</span>
        <span class="c1"># file_size = self.int_of_optional_subtag(element, &#39;axis:fileSize&#39;, ns)</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IdentifierData</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">isbn</span><span class="p">))</span>

        <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">acceptable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">seen_formats</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># All of the formats we don&#39;t support, like Blio, are ebook</span>
        <span class="c1"># formats. If this is an audiobook format (Acoustik), we&#39;ll</span>
        <span class="c1"># hear about it below.</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>

        <span class="c1"># If AxisNow is mentioned as a format, and this turns out to be a book,</span>
        <span class="c1"># we&#39;ll be adding an extra delivery mechanism.</span>
        <span class="n">axisnow_seen</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Blio is an older ebook format now used as an alias for AxisNow.</span>
        <span class="n">blio_seen</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">format_tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;axis:availability/axis:availableFormats/axis:formatName&#39;</span><span class="p">,</span>
            <span class="n">ns</span>
        <span class="p">):</span>
            <span class="n">informal_name</span> <span class="o">=</span> <span class="n">format_tag</span><span class="o">.</span><span class="n">text</span>
            <span class="n">seen_formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informal_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">informal_name</span> <span class="o">==</span> <span class="s2">&quot;Blio&quot;</span><span class="p">:</span>
                <span class="c1"># We will be adding an AxisNow FormatData.</span>
                <span class="n">blio_seen</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">informal_name</span> <span class="o">==</span> <span class="n">Axis360API</span><span class="o">.</span><span class="n">AXISNOW</span><span class="p">:</span>
                <span class="c1"># We will only be adding an AxisNow FormatData if this</span>
                <span class="c1"># turns out to be an ebook.</span>
                <span class="n">axisnow_seen</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">informal_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELIVERY_DATA_FOR_AXIS_FORMAT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unrecognized Axis format name for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">identifier</span><span class="p">,</span> <span class="n">informal_name</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELIVERY_DATA_FOR_AXIS_FORMAT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">informal_name</span><span class="p">):</span>
                <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELIVERY_DATA_FOR_AXIS_FORMAT</span><span class="p">[</span>
                    <span class="n">informal_name</span>
                <span class="p">]</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">FormatData</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="o">=</span><span class="n">drm_scheme</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">drm_scheme</span> <span class="o">==</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span><span class="p">:</span>
                    <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blio_seen</span> <span class="ow">or</span> <span class="p">(</span><span class="n">axisnow_seen</span> <span class="ow">and</span> <span class="n">medium</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">)):</span>
            <span class="c1"># This ebook is available through AxisNow. Add an</span>
            <span class="c1"># appropriate FormatData.</span>
            <span class="c1">#</span>
            <span class="c1"># Audiobooks may also be available through AxisNow, but we</span>
            <span class="c1"># currently ignore that fact.</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">FormatData</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">AXISNOW_DRM</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">formats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;No supported format for </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)! Saw: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span>
                <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seen_formats</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">imprint</span><span class="o">=</span><span class="n">imprint</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="n">publication_date</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
            <span class="n">contributors</span><span class="o">=</span><span class="n">contributors</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">circulationdata</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulationdata</span>
        <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="BibliographicParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.BibliographicParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_bibliographic</span><span class="p">:</span>
            <span class="n">bibliographic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_bibliographic</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bibliographic</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">passed_availability</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bibliographic</span> <span class="ow">and</span> <span class="n">bibliographic</span><span class="o">.</span><span class="n">circulation</span><span class="p">:</span>
            <span class="n">passed_availability</span> <span class="o">=</span> <span class="n">bibliographic</span><span class="o">.</span><span class="n">circulation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_availability</span><span class="p">:</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_availability</span><span class="p">(</span><span class="n">circulation_data</span><span class="o">=</span><span class="n">passed_availability</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">bibliographic</span><span class="p">,</span> <span class="n">availability</span></div></div>

<div class="viewcode-block" id="ResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.ResponseParser">[docs]</a><span class="k">class</span> <span class="nc">ResponseParser</span><span class="p">(</span><span class="n">Axis360Parser</span><span class="p">):</span>

    <span class="n">id_type</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">AXIS_360_ID</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Axis 360&quot;</span>

    <span class="c1"># Map Axis 360 error codes to our circulation exceptions.</span>
    <span class="n">code_to_exception</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">315</span>  <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># Bad password</span>
        <span class="mi">316</span>  <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># DRM account already exists</span>
        <span class="mi">1000</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">1001</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">1002</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">1003</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">2000</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">2001</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">2002</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">2003</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># &quot;Encoded input parameters exceed limit&quot;, whatever that meaus</span>
        <span class="mi">2004</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span>
        <span class="mi">2005</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Invalid credentials</span>
        <span class="mi">2005</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Wrong library ID</span>
        <span class="mi">2007</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Invalid library ID</span>
        <span class="mi">2008</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Invalid library ID</span>
        <span class="mi">3100</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing title ID</span>
        <span class="mi">3101</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing patron ID</span>
        <span class="mi">3102</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing email address (for hold notification)</span>
        <span class="mi">3103</span> <span class="p">:</span> <span class="n">NotFoundOnRemote</span><span class="p">,</span> <span class="c1"># Invalid title ID</span>
        <span class="mi">3104</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid Email Address (for hold notification)</span>
        <span class="mi">3105</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Invalid Account Credentials</span>
        <span class="mi">3106</span> <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># Loan Period is out of bounds</span>
        <span class="mi">3108</span> <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># DRM Credentials Required</span>
        <span class="mi">3109</span> <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># Hold already exists or hold does not exist, depending.</span>
        <span class="mi">3110</span> <span class="p">:</span> <span class="n">AlreadyCheckedOut</span><span class="p">,</span>
        <span class="mi">3111</span> <span class="p">:</span> <span class="n">CurrentlyAvailable</span><span class="p">,</span>
        <span class="mi">3112</span> <span class="p">:</span> <span class="n">CannotFulfill</span><span class="p">,</span>
        <span class="mi">3113</span> <span class="p">:</span> <span class="n">CannotLoan</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">3113</span><span class="p">,</span> <span class="s2">&quot;Title ID is not available for checkout&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="n">NoAvailableCopies</span><span class="p">,</span>
        <span class="mi">3114</span> <span class="p">:</span> <span class="n">PatronLoanLimitReached</span><span class="p">,</span>
        <span class="mi">3115</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing DRM format</span>
        <span class="mi">3116</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># No patron session ID provided -- we don&#39;t use this</span>
        <span class="mi">3117</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid DRM format</span>
        <span class="mi">3118</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid Patron credentials</span>
        <span class="mi">3119</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># No Blio account</span>
        <span class="mi">3120</span> <span class="p">:</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># No Acoustikaccount</span>
        <span class="mi">3123</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Patron Session ID expired</span>
        <span class="mi">3124</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Patron SessionID is required</span>
        <span class="mi">3126</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid checkout format</span>
        <span class="mi">3127</span> <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># First name is required</span>
        <span class="mi">3128</span> <span class="p">:</span> <span class="n">InvalidInputException</span><span class="p">,</span> <span class="c1"># Last name is required</span>
        <span class="mi">3129</span> <span class="p">:</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">,</span> <span class="c1"># Invalid Patron Session Id</span>
        <span class="mi">3130</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid hold format (?)</span>
        <span class="mi">3131</span> <span class="p">:</span> <span class="n">RemoteInitiatedServerError</span><span class="p">,</span> <span class="c1"># Custom error message (?)</span>
        <span class="mi">3132</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Invalid delta datetime format</span>
        <span class="mi">3134</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Delta datetime format must not be in the future</span>
        <span class="mi">3135</span> <span class="p">:</span> <span class="n">NoAcceptableFormat</span><span class="p">,</span>
        <span class="mi">3136</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing checkout format</span>
        <span class="mi">4058</span> <span class="p">:</span> <span class="n">NoActiveLoan</span><span class="p">,</span> <span class="c1"># No checkout is associated with patron for the title.</span>
        <span class="mi">5000</span> <span class="p">:</span> <span class="n">RemoteInitiatedServerError</span><span class="p">,</span>
        <span class="mi">5003</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing TransactionID</span>
        <span class="mi">5004</span> <span class="p">:</span> <span class="n">LibraryInvalidInputException</span><span class="p">,</span> <span class="c1"># Missing TransactionID</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: A Collection, in case parsing this document</span>
<span class="sd">        results in the creation of LoanInfo or HoldInfo objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

<div class="viewcode-block" id="ResponseParser.raise_exception_on_error"><a class="viewcode-back" href="../../api.html#api.axis.ResponseParser.raise_exception_on_error">[docs]</a>    <span class="k">def</span> <span class="nf">raise_exception_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">custom_error_classes</span><span class="o">=</span><span class="p">{},</span>
                                 <span class="n">ignore_error_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise an error if the given lxml node represents an Axis 360 error</span>
<span class="sd">        condition.</span>

<span class="sd">        :param e: An lxml Element</span>
<span class="sd">        :param ns: A dictionary of namespaces</span>
<span class="sd">        :param custom_error_classes: A dictionary of errors to map to custom</span>
<span class="sd">           classes rather than the defaults.</span>
<span class="sd">        :param ignore_error_codes: A list of error codes to treat as success</span>
<span class="sd">           rather than as cause to raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;//axis:status/axis:code&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;//axis:status/axis:statusMessage&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Something is so wrong that we don&#39;t know what to do.</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception_on_error</span><span class="p">(</span>
            <span class="n">code</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">custom_error_classes</span><span class="p">,</span> <span class="n">ignore_error_codes</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_raise_exception_on_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">custom_error_classes</span><span class="o">=</span><span class="p">{},</span>
                                  <span class="n">ignore_error_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Non-numeric code? Inconcievable!</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid response code from Axis 360: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ignore_error_codes</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">ignore_error_codes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">custom_error_classes</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">code_to_exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">d</span><span class="p">[(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="c1"># Something went wrong and we know how to turn it into a</span>
                <span class="c1"># specific exception.</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error_class</span> <span class="ow">is</span> <span class="n">RemoteInitiatedServerError</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">error_class</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">error_class</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span></div>


<div class="viewcode-block" id="CheckinResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.CheckinResponseParser">[docs]</a><span class="k">class</span> <span class="nc">CheckinResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>

<div class="viewcode-block" id="CheckinResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.CheckinResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">CheckinResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:EarlyCheckinRestResult&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="CheckinResponseParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.CheckinResponseParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Either raise an appropriate exception, or do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception_on_error</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">ignore_error_codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4058</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="CheckoutResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.CheckoutResponseParser">[docs]</a><span class="k">class</span> <span class="nc">CheckoutResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>

<div class="viewcode-block" id="CheckoutResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.CheckoutResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">CheckoutResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:checkoutResult&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="CheckoutResponseParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.CheckoutResponseParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Either turn the given document into a LoanInfo</span>
<span class="sd">        object, or raise an appropriate exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception_on_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>

        <span class="c1"># If we get to this point it&#39;s because the checkout succeeded.</span>
        <span class="n">expiration_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;//axis:expirationDate&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
        <span class="n">fulfillment_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;//axis:url&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fulfillment_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fulfillment_url</span> <span class="o">=</span> <span class="n">fulfillment_url</span><span class="o">.</span><span class="n">text</span>

        <span class="k">if</span> <span class="n">expiration_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expiration_date</span> <span class="o">=</span> <span class="n">expiration_date</span><span class="o">.</span><span class="n">text</span>
            <span class="n">expiration_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pd</span><span class="p">(</span><span class="n">expiration_date</span><span class="p">)</span>

        <span class="n">loan_start</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">loan_start</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">expiration_date</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">loan</span></div></div>

<div class="viewcode-block" id="HoldResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.HoldResponseParser">[docs]</a><span class="k">class</span> <span class="nc">HoldResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>

<div class="viewcode-block" id="HoldResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.HoldResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">HoldResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:addtoholdResult&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="HoldResponseParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.HoldResponseParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Either turn the given document into a HoldInfo</span>
<span class="sd">        object, or raise an appropriate exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception_on_error</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="p">{</span><span class="mi">3109</span> <span class="p">:</span> <span class="n">AlreadyOnHold</span><span class="p">})</span>

        <span class="c1"># If we get to this point it&#39;s because the hold place succeeded.</span>
        <span class="n">queue_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="s1">&#39;//axis:holdsQueuePosition&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">queue_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queue_position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">queue_position</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid queue position: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">queue_position</span><span class="p">)</span>
                <span class="n">queue_position</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">hold_start</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="c1"># NOTE: The caller needs to fill in Collection -- we have no idea</span>
        <span class="c1"># what collection this is.</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="n">HoldInfo</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">hold_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hold_position</span><span class="o">=</span><span class="n">queue_position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hold</span></div></div>

<div class="viewcode-block" id="HoldReleaseResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.HoldReleaseResponseParser">[docs]</a><span class="k">class</span> <span class="nc">HoldReleaseResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>

<div class="viewcode-block" id="HoldReleaseResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.HoldReleaseResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">HoldReleaseResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:removeholdResult&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="HoldReleaseResponseParser.post_process"><a class="viewcode-back" href="../../api.html#api.axis.HoldReleaseResponseParser.post_process">[docs]</a>    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unlike other ResponseParser subclasses, we don&#39;t return any type of</span>
<span class="sd">            \*Info object, so there&#39;s no need to do any post-processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">i</span></div>

<div class="viewcode-block" id="HoldReleaseResponseParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.HoldReleaseResponseParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="c1"># There&#39;s no data to gather here. Either there was an error</span>
        <span class="c1"># or we were successful.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception_on_error</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="p">{</span><span class="mi">3109</span> <span class="p">:</span> <span class="n">NotOnHold</span><span class="p">})</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>

<div class="viewcode-block" id="AvailabilityResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.AvailabilityResponseParser">[docs]</a><span class="k">class</span> <span class="nc">AvailabilityResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">internal_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param api: An Axis360API instance, in case the parsing of an</span>
<span class="sd">           availability document triggers additional API requests.</span>

<span class="sd">        :param internal_format: The name Axis 360 gave to the format</span>
<span class="sd">           the user requested. Used to distinguish books</span>
<span class="sd">           checked out through the AxisNow Book Vault from books checked</span>
<span class="sd">           out through ACS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_format</span> <span class="o">=</span> <span class="n">internal_format</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AvailabilityResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="AvailabilityResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.axis.AvailabilityResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">AvailabilityResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//axis:title&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
            <span class="c1"># Filter out books where nothing in particular is</span>
            <span class="c1"># happening.</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">info</span></div>

<div class="viewcode-block" id="AvailabilityResponseParser.process_one"><a class="viewcode-back" href="../../api.html#api.axis.AvailabilityResponseParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>

        <span class="c1"># Figure out which book we&#39;re talking about.</span>
        <span class="n">axis_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;axis:titleId&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;axis:availability&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">availability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">reserved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_boolean</span><span class="p">(</span><span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:isReserved&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">checked_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_boolean</span><span class="p">(</span><span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:isCheckedout&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
        <span class="n">on_hold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_boolean</span><span class="p">(</span><span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:isInHoldQueue&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">checked_out</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_date</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:checkoutStartDate&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_date</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:checkoutEndDate&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="n">download_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:downloadUrl&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:transactionID&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Arguments common to FulfillmentInfo and</span>
            <span class="c1"># Axis360FulfillmentInfo.</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">axis_identifier</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">download_url</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_format</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">AXISNOW</span><span class="p">:</span>
                <span class="c1"># The patron wants a direct link to the book, which we can deliver</span>
                <span class="c1"># immediately, without making any more API requests.</span>
                <span class="n">fulfillment</span> <span class="o">=</span> <span class="n">Axis360AcsFulfillmentInfo</span><span class="p">(</span>
                    <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">content_link</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
                    <span class="n">content_type</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">content_expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">verify_certificate</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">transaction_id</span><span class="p">:</span>
                <span class="c1"># We will eventually need to make a request to the</span>
                <span class="c1"># &quot;getfulfillmentInfo&quot; endpoint, using this</span>
                <span class="c1"># transaction ID.</span>
                <span class="c1">#</span>
                <span class="c1"># For a book delivered in AxisNow format, this will give</span>
                <span class="c1"># us the Book Vault UUID and ISBN.</span>
                <span class="c1">#</span>
                <span class="c1"># For an audiobook, this will give us the Findaway</span>
                <span class="c1"># content ID, license ID, and session key. We&#39;ll also</span>
                <span class="c1"># need to make a second request to get the audiobook</span>
                <span class="c1"># metadata.</span>
                <span class="c1">#</span>
                <span class="c1"># Axis360FulfillmentInfo can handle both cases.</span>
                <span class="n">fulfillment</span> <span class="o">=</span> <span class="n">Axis360FulfillmentInfo</span><span class="p">(</span>
                    <span class="n">api</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;re out of luck -- we can&#39;t fulfill this loan.</span>
                <span class="n">fulfillment</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">LoanInfo</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">axis_identifier</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">fulfillment_info</span><span class="o">=</span><span class="n">fulfillment</span><span class="p">,</span>
                <span class="n">external_identifier</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">reserved</span><span class="p">:</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath1_date</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:reservedEndDate&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">axis_identifier</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">on_hold</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_optional_subtag</span><span class="p">(</span>
                <span class="n">availability</span><span class="p">,</span> <span class="s1">&#39;axis:holdsQueuePosition&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">data_source_name</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">AXIS_360</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">axis_identifier</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span></div></div>


<div class="viewcode-block" id="JSONResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.JSONResponseParser">[docs]</a><span class="k">class</span> <span class="nc">JSONResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Most ResponseParsers parse XML documents; subclasses of</span>
<span class="sd">    JSONResponseParser parse JSON documents.</span>

<span class="sd">    This only subclasses ResponseParser so it can reuse</span>
<span class="sd">    _raise_exception_on_error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_required_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise an exception if the given key is not present in the given</span>
<span class="sd">        object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">json_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="s2">&quot;Required key </span><span class="si">%s</span><span class="s2"> not present in Axis 360 fulfillment document: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">json_obj</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">json_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="JSONResponseParser.verify_status_code"><a class="viewcode-back" href="../../api.html#api.axis.JSONResponseParser.verify_status_code">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">verify_status_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assert that the incoming JSON document represents a successful</span>
<span class="sd">        response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_required_key</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">)</span>

        <span class="c1"># If the document describes an error condition, raise</span>
        <span class="c1"># an appropriate exception immediately.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_raise_exception_on_error</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="JSONResponseParser.parse"><a class="viewcode-back" href="../../api.html#api.axis.JSONResponseParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a JSON document.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">data</span> <span class="c1"># already parsed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># It&#39;s not JSON.</span>
                <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid response from Axis 360 (was expecting JSON): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
                <span class="p">)</span>

        <span class="c1"># If the response indicates an error condition, don&#39;t continue --</span>
        <span class="c1"># raise an exception immediately.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_status_code</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a document we know to represent success on the</span>
<span class="sd">        API level. Called by parse() once the high-level details</span>
<span class="sd">        have been worked out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="Axis360FulfillmentInfoResponseParser"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfoResponseParser">[docs]</a><span class="k">class</span> <span class="nc">Axis360FulfillmentInfoResponseParser</span><span class="p">(</span><span class="n">JSONResponseParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse JSON documents into Findaway audiobook manifests or AxisNow manifests.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param api: An Axis360API instance, in case the parsing of</span>
<span class="sd">        a fulfillment document triggers additional API requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Axis360FulfillmentInfoResponseParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">collection</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract all useful information from a parsed FulfillmentInfo</span>
<span class="sd">        response.</span>

<span class="sd">        :param parsed: A dictionary corresponding to a parsed JSON</span>
<span class="sd">        document.</span>

<span class="sd">        :param license_pool: The LicensePool for the book that&#39;s</span>
<span class="sd">        being fulfilled.</span>

<span class="sd">        :return: A 2-tuple (manifest, expiration_date). `manifest` is either</span>
<span class="sd">            a FindawayManifest (for an audiobook) or an AxisNowManifest (for an ebook).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expiration_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_key</span><span class="p">(</span><span class="s1">&#39;ExpirationDate&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">expiration_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">expiration_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;FNDTransactionID&#39;</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_findaway</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_axisnow</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">expiration_date</span>

<div class="viewcode-block" id="Axis360FulfillmentInfoResponseParser.parse_date"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfoResponseParser.parse_date">[docs]</a>    <span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="c1"># Remove 7(?!) decimal places of precision and</span>
            <span class="c1"># UTC timezone, which are more trouble to parse</span>
            <span class="c1"># than they&#39;re worth.</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span><span class="n">date</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="s2">&quot;Could not parse expiration date: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">date</span></div>


<div class="viewcode-block" id="Axis360FulfillmentInfoResponseParser.parse_findaway"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfoResponseParser.parse_findaway">[docs]</a>    <span class="k">def</span> <span class="nf">parse_findaway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_key</span>
        <span class="n">fulfillmentId</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;FNDContentID&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">licenseId</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;FNDLicenseID&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">sessionKey</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;FNDSessionKey&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">checkoutId</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;FNDTransactionID&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>

        <span class="c1"># Acquire the TOC information</span>
        <span class="n">metadata_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_audiobook_metadata</span><span class="p">(</span><span class="n">fulfillmentId</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">AudiobookMetadataParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">accountId</span><span class="p">,</span> <span class="n">spine_items</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">metadata_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FindawayManifest</span><span class="p">(</span>
            <span class="n">license_pool</span><span class="p">,</span> <span class="n">accountId</span><span class="o">=</span><span class="n">accountId</span><span class="p">,</span> <span class="n">checkoutId</span><span class="o">=</span><span class="n">checkoutId</span><span class="p">,</span>
            <span class="n">fulfillmentId</span><span class="o">=</span><span class="n">fulfillmentId</span><span class="p">,</span> <span class="n">licenseId</span><span class="o">=</span><span class="n">licenseId</span><span class="p">,</span>
            <span class="n">sessionKey</span><span class="o">=</span><span class="n">sessionKey</span><span class="p">,</span> <span class="n">spine_items</span><span class="o">=</span><span class="n">spine_items</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Axis360FulfillmentInfoResponseParser.parse_axisnow"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfoResponseParser.parse_axisnow">[docs]</a>    <span class="k">def</span> <span class="nf">parse_axisnow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_key</span>
        <span class="n">isbn</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;ISBN&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="n">book_vault_uuid</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="s1">&#39;BookVaultUUID&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AxisNowManifest</span><span class="p">(</span><span class="n">book_vault_uuid</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AudiobookMetadataParser"><a class="viewcode-back" href="../../api.html#api.axis.AudiobookMetadataParser">[docs]</a><span class="k">class</span> <span class="nc">AudiobookMetadataParser</span><span class="p">(</span><span class="n">JSONResponseParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the results of Axis 360&#39;s audiobook metadata API call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parsed</span><span class="p">):</span>
        <span class="n">spine_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">accountId</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fndaccountid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readingOrder&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">spine_item</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_extract_spine_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spine_item</span><span class="p">:</span>
                <span class="n">spine_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spine_item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accountId</span><span class="p">,</span> <span class="n">spine_items</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_extract_spine_item</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an element of the &#39;readingOrder&#39; list to a SpineItem.&quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="c1"># Incoming duration is measured in seconds.</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">part_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fndpart&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fndsequence&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">SpineItem</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">part_number</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span></div>


<div class="viewcode-block" id="AxisNowManifest"><a class="viewcode-back" href="../../api.html#api.axis.AxisNowManifest">[docs]</a><span class="k">class</span> <span class="nc">AxisNowManifest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple media type for conveying an entry point into the AxisNow access control</span>
<span class="sd">    system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MEDIA_TYPE</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">AXISNOW_DRM</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">book_vault_uuid</span><span class="p">,</span> <span class="n">isbn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param book_vault_uuid: The UUID of a Book Vault.</span>
<span class="sd">        :param isbn: The ISBN of a book in that Book Vault.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book_vault_uuid</span> <span class="o">=</span> <span class="n">book_vault_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="n">isbn</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isbn</span><span class="p">,</span> <span class="n">book_vault_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book_vault_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Axis360FulfillmentInfo"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfo">[docs]</a><span class="k">class</span> <span class="nc">Axis360FulfillmentInfo</span><span class="p">(</span><span class="n">APIAwareFulfillmentInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Axis 360-specific FulfillmentInfo implementation for audiobooks</span>
<span class="sd">    and books served through AxisNow.</span>

<span class="sd">    We use these instead of normal FulfillmentInfo objects because</span>
<span class="sd">    putting all this information into FulfillmentInfo would require</span>
<span class="sd">    one or two extra HTTP requests, and there&#39;s often no need to make</span>
<span class="sd">    those requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Axis360FulfillmentInfo.do_fetch"><a class="viewcode-back" href="../../api.html#api.axis.Axis360FulfillmentInfo.do_fetch">[docs]</a>    <span class="k">def</span> <span class="nf">do_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">license_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_pool</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_fulfillment_info</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">Axis360FulfillmentInfoResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">MEDIA_TYPE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_expires</span> <span class="o">=</span> <span class="n">expires</span>

        <span class="k">if</span> <span class="n">manifest</span><span class="o">.</span><span class="n">MEDIA_TYPE</span> <span class="o">==</span> <span class="n">AxisNowManifest</span><span class="o">.</span><span class="n">MEDIA_TYPE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can_cache_manifest</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="Axis360AcsFulfillmentInfo"><a class="viewcode-back" href="../../api.html#api.axis.Axis360AcsFulfillmentInfo">[docs]</a><span class="k">class</span> <span class="nc">Axis360AcsFulfillmentInfo</span><span class="p">(</span><span class="n">FulfillmentInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This implements a Axis 360 specific FulfillmentInfo for ACS content</span>
<span class="sd">    served through AxisNow. The AxisNow API gives us a link that we can use</span>
<span class="sd">    to get the ACSM file that we serve to the mobile apps.</span>
<span class="sd">    This link resolves to a redirect, which resolves to the actual ACSM file.</span>
<span class="sd">    The URL we are given in the redirect has a percent encoded query string</span>
<span class="sd">    in it. The encoding used in this string has lower case characters in it</span>
<span class="sd">    like &quot;%3a&quot; for :.</span>
<span class="sd">    In versions of urllib3 &gt; 1.24.3 the library normalizes the query string</span>
<span class="sd">    before doing the actual request. In doing the normalization it follows the</span>
<span class="sd">    recommendation of RFC 3986 and uppercases the percent encoded bytes.</span>
<span class="sd">    This causes the Axis360 API to return an error from Adobe ACS:</span>
<span class="sd">    ```</span>
<span class="sd">    &lt;error xmlns=&quot;http://ns.adobe.com/adept&quot; data=&quot;E_URLLINK_AUTH</span>
<span class="sd">    https://acsqa.digitalcontentcafe.com/fulfillment/URLLink.acsm&quot;/&gt;</span>
<span class="sd">    ```</span>
<span class="sd">    instead of the correct ACSM file.</span>
<span class="sd">    Others have noted that this is a problem in the urllib3 github but they</span>
<span class="sd">    do not seem interested in providing an option to override this behavior</span>
<span class="sd">    and closed the ticket.</span>
<span class="sd">    https://github.com/urllib3/urllib3/issues/1677</span>
<span class="sd">    This FulfillmentInfo implementation uses the built in Python urllib</span>
<span class="sd">    implementation instead of requests (and urllib3) to make this request</span>
<span class="sd">    to the Axis 360 API, sidestepping the problem, but taking a different</span>
<span class="sd">    code path than most of our external HTTP requests.</span>

<span class="sd">    Copyright The Palace Project for code licensed under the Apache 2.0 License.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">verify</span>

<div class="viewcode-block" id="Axis360AcsFulfillmentInfo.problem_detail_document"><a class="viewcode-back" href="../../api.html#api.axis.Axis360AcsFulfillmentInfo.problem_detail_document">[docs]</a>    <span class="k">def</span> <span class="nf">problem_detail_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_details</span><span class="p">):</span>
        <span class="n">service_name</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_link</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">INTEGRATION_ERROR</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="n">RequestNetworkException</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">service_name</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="n">RequestNetworkException</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">debug_message</span><span class="o">=</span><span class="n">error_details</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">as_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">service_name</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_link</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">:</span>
                <span class="c1"># Actually verify the ssl certificates</span>
                <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS</span><span class="p">)</span>
                <span class="n">ssl_context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
                <span class="n">ssl_context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ssl_context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default context does no ssl verification</span>
                <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">()</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_link</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ssl_context</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>

        <span class="c1"># Mimic the behavior of the HTTP.request_with_timeout class and</span>
        <span class="c1"># wrap the exceptions thrown by urllib and ssl returning a ProblemDetail document.</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_detail_document</span><span class="p">(</span>
                <span class="s2">&quot;The server received a bad status code (</span><span class="si">{}</span><span class="s2">) while contacting </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">service_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_detail_document</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error connecting to </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2">. Timeout occurred.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_detail_document</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error connecting to </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>