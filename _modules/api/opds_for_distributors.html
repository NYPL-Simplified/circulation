
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.opds_for_distributors &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.opds_for_distributors</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">feedparser</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">core.opds_import</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSImporter</span><span class="p">,</span>
    <span class="n">OPDSImportMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">TimestampData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.selftest</span> <span class="kn">import</span> <span class="n">HasSelfTests</span>
<span class="kn">from</span> <span class="nn">.circulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseCirculationAPI</span><span class="p">,</span>
    <span class="n">LoanInfo</span><span class="p">,</span>
    <span class="n">FulfillmentInfo</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="n">HTTP</span>
<span class="kn">from</span> <span class="nn">core.util.string_helpers</span> <span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatabaseTest</span><span class="p">,</span>
    <span class="n">MockRequestsResponse</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">IntegrationException</span>
<span class="kn">from</span> <span class="nn">.circulation_exceptions</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="OPDSForDistributorsAPI"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsAPI</span><span class="p">(</span><span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;OPDS for Distributors&quot;</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Import books from a distributor that requires authentication to get the OPDS feed and download books.&quot;</span><span class="p">)</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">OPDSImporter</span><span class="o">.</span><span class="n">BASE_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library&#39;s username or access key&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library&#39;s password or secret key&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># In OPDS For Distributors, all items are gated through the</span>
    <span class="c1"># BEARER_TOKEN access control scheme.</span>
    <span class="c1">#</span>
    <span class="c1"># If the default client supports a given media type when</span>
    <span class="c1"># combined with the BEARER_TOKEN scheme, then we should import</span>
    <span class="c1"># titles with that media type...</span>
    <span class="n">SUPPORTED_MEDIA_TYPES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">format</span> <span class="k">for</span> <span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">drm</span><span class="p">)</span> <span class="ow">in</span>
        <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">default_client_can_fulfill_lookup</span>
        <span class="k">if</span> <span class="n">drm</span> <span class="o">==</span> <span class="p">(</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">]</span>

    <span class="c1"># ...and we should map requests for delivery of that media type to</span>
    <span class="c1"># the (type, BEARER_TOKEN) DeliveryMechanism.</span>
    <span class="n">delivery_mechanism_to_internal_format</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">):</span> <span class="nb">type</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">SUPPORTED_MEDIA_TYPES</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_url</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="OPDSForDistributorsAPI.external_integration"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
                       <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to get a token.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Negotiate a fulfillment token&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_token</span><span class="p">,</span> <span class="n">_db</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_with_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around HTTP.request_with_timeout to be overridden for tests.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">request_with_timeout</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="c1"># If this is the first time we&#39;re getting a token, we</span>
        <span class="c1"># need to find the authenticate url in the OPDS</span>
        <span class="c1"># authentication document.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_url</span><span class="p">:</span>
            <span class="c1"># Keep track of the most recent URL we retrieved for error</span>
            <span class="c1"># reporting purposes.</span>
            <span class="n">current_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_with_timeout</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">current_url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                <span class="c1"># This feed doesn&#39;t require authentication, so</span>
                <span class="c1"># we need to find a link to the authentication document.</span>
                <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">auth_doc_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http://opds-spec.org/auth/document&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_doc_links</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span><span class="s2">&quot;No authentication document link found in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>
                <span class="n">current_url</span> <span class="o">=</span> <span class="n">auth_doc_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>

                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_with_timeout</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">current_url</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">auth_doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span><span class="s2">&quot;Could not load authentication document from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>
            <span class="n">auth_types</span> <span class="o">=</span> <span class="n">auth_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authentication&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">credentials_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">auth_types</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http://opds-spec.org/auth/oauth/client_credentials&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">credentials_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span><span class="s2">&quot;Could not find any credential-based authentication mechanisms in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>

            <span class="n">links</span> <span class="o">=</span> <span class="n">credentials_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">auth_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;authenticate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_links</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span><span class="s2">&quot;Could not find any authentication links in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_url</span> <span class="o">=</span> <span class="n">auth_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">credential</span><span class="p">):</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="s2">&quot;Basic </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_header</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">grant_type</span><span class="o">=</span><span class="s1">&#39;client_credentials&#39;</span><span class="p">)</span>
            <span class="n">token_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_with_timeout</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">access_token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span>
            <span class="n">expires_in</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_in&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">access_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expires_in</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span>
                    <span class="s2">&quot;Document retrieved from </span><span class="si">%s</span><span class="s2"> is not a bearer token: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="c1"># Response comes in as a byte string.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">auth_url</span><span class="p">,</span> <span class="n">token_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">credential</span><span class="o">.</span><span class="n">credential</span> <span class="o">=</span> <span class="n">access_token</span>
            <span class="n">expires_in</span> <span class="o">=</span> <span class="n">expires_in</span>
            <span class="c1"># We&#39;ll avoid edge cases by assuming the token expires 75%</span>
            <span class="c1"># into its useful lifetime.</span>
            <span class="n">credential</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span><span class="o">*</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Credential</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span>
                                 <span class="s2">&quot;OPDS For Distributors Bearer Token&quot;</span><span class="p">,</span>
                                 <span class="n">patron</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">refresher_method</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span>
                                 <span class="p">)</span>

<div class="viewcode-block" id="OPDSForDistributorsAPI.can_fulfill_without_loan"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.can_fulfill_without_loan">[docs]</a>    <span class="k">def</span> <span class="nf">can_fulfill_without_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Since OPDS For Distributors delivers books to the library rather</span>
<span class="sd">        than creating loans, any book can be fulfilled without</span>
<span class="sd">        identifying the patron, assuming the library&#39;s policies</span>
<span class="sd">        allow it.</span>

<span class="sd">        Just to be safe, though, we require that the</span>
<span class="sd">        DeliveryMechanism&#39;s drm_scheme be either &#39;no DRM&#39; or &#39;bearer</span>
<span class="sd">        token&#39;, since other DRM schemes require identifying a patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lpdm</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">drm_scheme</span>
        <span class="k">if</span> <span class="n">drm_scheme</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OPDSForDistributorsAPI.checkin"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="c1"># Delete the patron&#39;s loan for this licensepool.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loan</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span>
                <span class="n">patron_id</span><span class="o">=</span><span class="n">patron</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">license_pool_id</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># The patron didn&#39;t have this book checked out.</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="OPDSForDistributorsAPI.checkout"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OPDSForDistributorsAPI.fulfill"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a bearer token that can be used to download the book.</span>

<span class="sd">        :param kwargs: A container for arguments to fulfill()</span>
<span class="sd">           which are not relevant to this vendor.</span>

<span class="sd">        :return: a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">links</span>
        <span class="c1"># Find the acquisition link with the right media type.</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">media_type</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">GENERIC_OPDS_ACQUISITION</span> <span class="ow">and</span> <span class="n">media_type</span> <span class="o">==</span> <span class="n">internal_format</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span><span class="o">.</span><span class="n">url</span>

                <span class="c1"># Obtain a Credential with the information from our</span>
                <span class="c1"># bearer token.</span>
                <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>
                <span class="n">credential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_token</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

                <span class="c1"># Build a application/vnd.librarysimplified.bearer-token</span>
                <span class="c1"># document using information from the credential.</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">credential</span><span class="o">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="n">token_document</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
                    <span class="n">access_token</span><span class="o">=</span><span class="n">credential</span><span class="o">.</span><span class="n">credential</span><span class="p">,</span>
                    <span class="n">expires_in</span><span class="o">=</span><span class="n">expiration</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">content_link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">content_type</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">token_document</span><span class="p">),</span>
                    <span class="n">content_expires</span><span class="o">=</span><span class="n">credential</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># We couldn&#39;t find an acquisition link for this book.</span>
        <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span></div>

<div class="viewcode-block" id="OPDSForDistributorsAPI.patron_activity"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsAPI.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="c1"># Look up loans for this collection in the database.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">LoanInfo</span><span class="p">(</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">end</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">loans</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="OPDSForDistributorsImporter"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsImporter">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsImporter</span><span class="p">(</span><span class="n">OPDSImporter</span><span class="p">):</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="n">OPDSForDistributorsAPI</span><span class="o">.</span><span class="n">NAME</span>

<div class="viewcode-block" id="OPDSForDistributorsImporter.update_work_for_edition"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsImporter.update_work_for_edition">[docs]</a>    <span class="k">def</span> <span class="nf">update_work_for_edition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;After importing a LicensePool, set its availability</span>
<span class="sd">        appropriately. Books imported through OPDS For Distributors are</span>
<span class="sd">        not open-access, but a library that can perform this import has</span>
<span class="sd">        a license for the title and can distribute unlimited copies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span><span class="p">,</span> <span class="n">work</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span>
            <span class="n">OPDSForDistributorsImporter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update_work_for_edition</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">update_availability</span><span class="p">(</span>
            <span class="n">new_licenses_owned</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_licenses_available</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">new_licenses_reserved</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_patrons_in_hold_queue</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pool</span><span class="p">,</span> <span class="n">work</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_add_format_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">circulation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">circulation</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">GENERIC_OPDS_ACQUISITION</span>
                <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">media_type</span> <span class="ow">in</span>
                <span class="n">OPDSForDistributorsAPI</span><span class="o">.</span><span class="n">SUPPORTED_MEDIA_TYPES</span><span class="p">):</span>
                <span class="n">circulation</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">FormatData</span><span class="p">(</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
                        <span class="n">drm_scheme</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">,</span>
                        <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
                        <span class="n">rights_uri</span><span class="o">=</span><span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="OPDSForDistributorsImportMonitor"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsImportMonitor</span><span class="p">(</span><span class="n">OPDSImportMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Monitor an OPDS feed that requires or allows authentication,</span>
<span class="sd">    such as Biblioboard or Plympton.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">OPDSForDistributorsImporter</span><span class="o">.</span><span class="n">NAME</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPDSForDistributorsImportMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">OPDSForDistributorsAPI</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a normal HTTP request for an OPDS feed, but add in an</span>
<span class="sd">        auth header with the credentials for the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">_get_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">credential</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="s2">&quot;Bearer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">token</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_header</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">OPDSForDistributorsImportMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span></div>

<div class="viewcode-block" id="OPDSForDistributorsReaperMonitor"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsReaperMonitor">[docs]</a><span class="k">class</span> <span class="nc">OPDSForDistributorsReaperMonitor</span><span class="p">(</span><span class="n">OPDSForDistributorsImportMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an unusual import monitor that crawls the entire OPDS feed</span>
<span class="sd">    and keeps track of every identifier it sees, to find out if anything</span>
<span class="sd">    has been removed from the collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPDSForDistributorsReaperMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="OPDSForDistributorsReaperMonitor.feed_contains_new_data"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsReaperMonitor.feed_contains_new_data">[docs]</a>    <span class="k">def</span> <span class="nf">feed_contains_new_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="c1"># Always return True so that the importer will crawl the</span>
        <span class="c1"># entire feed.</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OPDSForDistributorsReaperMonitor.import_one_feed"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsReaperMonitor.import_one_feed">[docs]</a>    <span class="k">def</span> <span class="nf">import_one_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="c1"># Collect all the identifiers in the feed.</span>
        <span class="n">parsed_feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">parsed_feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_identifiers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="OPDSForDistributorsReaperMonitor.run_once"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.OPDSForDistributorsReaperMonitor.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check to see if any identifiers we know about are no longer</span>
<span class="sd">        present on the remote. If there are any, remove them.</span>

<span class="sd">        :param progress: A TimestampData, ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPDSForDistributorsReaperMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

        <span class="c1"># self.seen_identifiers is full of URNs. We need the values</span>
        <span class="c1"># that go in Identifier.identifier.</span>
        <span class="n">identifiers</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urns</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_identifiers</span>
        <span class="p">)</span>
        <span class="n">identifier_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">identifiers</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>

        <span class="c1"># At this point we&#39;ve gone through the feed and collected all the identifiers.</span>
        <span class="c1"># If there&#39;s anything we didn&#39;t see, we know it&#39;s no longer available.</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">LicensePool</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Identifier</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="o">~</span><span class="n">Identifier</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">identifier_ids</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">pools_reaped</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Reaping </span><span class="si">%s</span><span class="s2"> license pools for collection </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pools_reaped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">qu</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">achievements</span> <span class="o">=</span> <span class="s2">&quot;License pools removed: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">pools_reaped</span>
        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">achievements</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MockOPDSForDistributorsAPI"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.MockOPDSForDistributorsAPI">[docs]</a><span class="k">class</span> <span class="nc">MockOPDSForDistributorsAPI</span><span class="p">(</span><span class="n">OPDSForDistributorsAPI</span><span class="p">):</span>

<div class="viewcode-block" id="MockOPDSForDistributorsAPI.mock_collection"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.MockOPDSForDistributorsAPI.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mock OPDS For Distributors collection to use in tests.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test OPDS For Distributors Collection&quot;</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="s2">&quot;http://opds&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">OPDSForDistributorsAPI</span><span class="o">.</span><span class="n">NAME</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockOPDSForDistributorsAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MockOPDSForDistributorsAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.opds_for_distributors.MockOPDSForDistributorsAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_request_with_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>