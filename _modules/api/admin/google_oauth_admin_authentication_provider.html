
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.admin.google_oauth_admin_authentication_provider &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.admin.google_oauth_admin_authentication_provider</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="k">import</span> <span class="n">set_trace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">api.admin.template_styles</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">admin_authentication_provider</span> <span class="k">import</span> <span class="n">AdminAuthenticationProvider</span>
<span class="kn">from</span> <span class="nn">problem_details</span> <span class="k">import</span> <span class="n">GOOGLE_OAUTH_FAILURE</span><span class="p">,</span> <span class="n">INVALID_ADMIN_CREDENTIALS</span>
<span class="kn">from</span> <span class="nn">oauth2client</span> <span class="k">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">GoogleClient</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="k">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Admin</span><span class="p">,</span>
    <span class="n">AdminRole</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider">[docs]</a><span class="k">class</span> <span class="nc">GoogleOAuthAdminAuthenticationProvider</span><span class="p">(</span><span class="n">AdminAuthenticationProvider</span><span class="p">):</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">GOOGLE_OAUTH</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;How to Configure a Google OAuth Integration&quot;</span><span class="p">)</span>
    <span class="n">DOMAINS</span> <span class="o">=</span> <span class="s2">&quot;domains&quot;</span>

    <span class="n">INSTRUCTIONS</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Configuring a Google OAuth integration in the Circulation Manager &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;will allow admins to sign into the Admin interface with their Google/GMail credentials.&lt;/p&gt;&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&lt;p&gt;Configure the Google OAuth Service: &lt;/p&gt;&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&lt;ol&gt;&lt;li&gt;To use this integration, visit the &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&lt;a href=&#39;https://console.developers.google.com/apis/dashboard?pli=1&#39; rel=&#39;noopener&#39; &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;rel=&#39;noreferer&#39; target=&#39;_blank&#39;&gt;Google developer console.&lt;/a&gt; &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;Create a project, click &#39;Create Credentials&#39; in the left sidebar, and select &#39;OAuth client ID&#39;. &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;If you get a warning about the consent screen, click &#39;Configure consent screen&#39; and enter your &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;library name as the product name. Save the consent screen information.&lt;/li&gt;&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&lt;li&gt;Choose &#39;Web Application&#39; as the application type.&lt;/li&gt;&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&lt;li&gt;Leave &#39;Authorized JavaScript origins&#39; blank, but under &#39;Authorized redirect URIs&#39;, add the url &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;of your circulation manager followed by &#39;/admin/GoogleAuth/callback&#39;, e.g. &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;&#39;http://mycircmanager.org/admin/GoogleAuth/callback&#39;.&lt;/li&gt;&quot;</span>
                    <span class="s2">&quot;&lt;li&gt;Click create, and you&#39;ll get a popup with your new client ID and secret. &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;Copy these values and enter them in the form below.&lt;/li&gt;&lt;/ol&gt;&quot;</span><span class="p">)</span>


    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Authentication URI&quot;</span><span class="p">),</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="p">,</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Client ID&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Client Secret&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">DOMAINS</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Allowed Domains&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Anyone who logs in with an email address from one of these domains will automatically have librarian-level access to this library. Library manager roles must still be granted individually by other admins. If you want to set up admins individually but still allow them to log in with Google, you can create the admin authentication service without adding any libraries.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span> <span class="p">},</span>
    <span class="p">]</span>
    <span class="n">SITEWIDE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;a style=&#39;</span><span class="si">{}</span><span class="s2">&#39; href=</span><span class="si">%(auth_uri)s</span><span class="s2">&gt;Sign in with Google&lt;/a&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link_style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GoogleOAuthAdminAuthenticationProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">redirect_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">test_mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_client</span> <span class="o">=</span> <span class="n">DummyGoogleClient</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_client</span>

        <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;auth_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">url</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">username</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">password</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_uri</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://www.googleapis.com/auth/userinfo.email&quot;</span>
        <span class="k">return</span> <span class="n">GoogleClient</span><span class="o">.</span><span class="n">OAuth2WebServerFlow</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="p">:</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                <span class="n">setting</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOMAINS</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">json_value</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">setting</span><span class="o">.</span><span class="n">json_value</span><span class="p">:</span>
                        <span class="n">domains</span><span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">domains</span>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.sign_in_template"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.sign_in_template">[docs]</a>    <span class="k">def</span> <span class="nf">sign_in_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">auth_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_uri</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span></div>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.auth_uri"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.auth_uri">[docs]</a>    <span class="k">def</span> <span class="nf">auth_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">step1_get_authorize_url</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">redirect_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.callback"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.callback">[docs]</a>    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Google OAuth sign-in flow&quot;&quot;&quot;</span>

        <span class="c1"># The Google OAuth client sometimes hits the callback with an error.</span>
        <span class="c1"># These will be returned as a problem detail.</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_error_problem_detail</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="kc">None</span>
        <span class="n">auth_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_code</span><span class="p">:</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">step2_exchange</span><span class="p">(</span><span class="n">auth_code</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GoogleClient</span><span class="o">.</span><span class="n">FlowExchangeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_error_problem_detail</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">),</span> <span class="kc">None</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">id_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_email</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">INVALID_ADMIN_CREDENTIALS</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">roles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">domain</span><span class="p">]:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">AdminRole</span><span class="o">.</span><span class="n">LIBRARIAN</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">:</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span> <span class="p">})</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
                <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
                <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">,</span>
            <span class="p">),</span> <span class="n">redirect_url</span></div>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.google_error_problem_detail"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.google_error_problem_detail">[docs]</a>    <span class="k">def</span> <span class="nf">google_error_problem_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># ProblemDetail.detailed requires the detail to be an internationalized</span>
        <span class="c1"># string, so pass the combined string through _ as well even though the</span>
        <span class="c1"># components were translated already. Space is a variable so it doesn&#39;t</span>
        <span class="c1"># end up in the translation template.</span>
        <span class="n">space</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">GOOGLE_OAUTH_FAILURE</span><span class="o">.</span><span class="n">detail</span><span class="p">)</span> <span class="o">+</span> <span class="n">space</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">error_detail</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">GOOGLE_OAUTH_FAILURE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">error_detail</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.active_credentials"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.active_credentials">[docs]</a>    <span class="k">def</span> <span class="nf">active_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that existing credentials aren&#39;t expired&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">admin</span><span class="o">.</span><span class="n">credential</span><span class="p">:</span>
            <span class="n">oauth_credentials</span> <span class="o">=</span> <span class="n">GoogleClient</span><span class="o">.</span><span class="n">OAuth2Credentials</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">credential</span><span class="p">)</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">oauth_credentials</span><span class="o">.</span><span class="n">access_token_expired</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GoogleOAuthAdminAuthenticationProvider.staff_email"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.GoogleOAuthAdminAuthenticationProvider.staff_email">[docs]</a>    <span class="k">def</span> <span class="nf">staff_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="c1"># If the admin already exists in the database, they can log in regardless of</span>
        <span class="c1"># whether their domain has been whitelisted for a library.</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Admin</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">admin</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Otherwise, their email must match one of the configured domains.</span>
        <span class="n">staff_domains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">staff_domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">staff_domain</span> <span class="ow">in</span> <span class="n">staff_domains</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="DummyGoogleClient"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient">[docs]</a><span class="k">class</span> <span class="nc">DummyGoogleClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock Google OAuth client for testing&quot;&quot;&quot;</span>

    <span class="n">expired</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DummyGoogleClient.Credentials"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.Credentials">[docs]</a>    <span class="k">class</span> <span class="nc">Credentials</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mock OAuth2Credentials object for testing&quot;&quot;&quot;</span>

        <span class="n">access_token_expired</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_token</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hd&quot;</span> <span class="p">:</span> <span class="n">domain</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span> <span class="p">:</span> <span class="n">email</span><span class="p">}</span>

<div class="viewcode-block" id="DummyGoogleClient.Credentials.to_json"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.Credentials.to_json">[docs]</a>        <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">id_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_token</span><span class="p">))</span></div>

<div class="viewcode-block" id="DummyGoogleClient.Credentials.from_json"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.Credentials.from_json">[docs]</a>        <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span></div></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;example@nypl.org&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Credentials</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OAuth2Credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span>

<div class="viewcode-block" id="DummyGoogleClient.flow_from_client_secrets"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.flow_from_client_secrets">[docs]</a>    <span class="k">def</span> <span class="nf">flow_from_client_secrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DummyGoogleClient.step2_exchange"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.step2_exchange">[docs]</a>    <span class="k">def</span> <span class="nf">step2_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_code</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span></div>

<div class="viewcode-block" id="DummyGoogleClient.step1_get_authorize_url"><a class="viewcode-back" href="../../../api.admin.html#api.admin.google_oauth_admin_authentication_provider.DummyGoogleClient.step1_get_authorize_url">[docs]</a>    <span class="k">def</span> <span class="nf">step1_get_authorize_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;GOOGLE REDIRECT&quot;</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>