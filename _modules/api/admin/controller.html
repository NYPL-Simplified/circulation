
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.admin.controller &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.admin.controller</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">lgt</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">and_</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">distinct</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">nullslast</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">api.admin.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ADMIN_AUTH_MECHANISM_NOT_CONFIGURED</span><span class="p">,</span> <span class="n">ADMIN_AUTH_NOT_CONFIGURED</span><span class="p">,</span>
    <span class="n">CANNOT_CHANGE_LIBRARY_FOR_CUSTOM_LIST</span><span class="p">,</span> <span class="n">CANNOT_CHANGE_PROTOCOL</span><span class="p">,</span>
    <span class="n">CANNOT_EDIT_DEFAULT_LANE</span><span class="p">,</span> <span class="n">CANNOT_SHOW_LANE_WITH_HIDDEN_PARENT</span><span class="p">,</span>
    <span class="n">COLLECTION_NOT_ASSOCIATED_WITH_LIBRARY</span><span class="p">,</span> <span class="n">CUSTOM_LIST_NAME_ALREADY_IN_USE</span><span class="p">,</span>
    <span class="n">DUPLICATE_INTEGRATION</span><span class="p">,</span> <span class="n">INCOMPLETE_CONFIGURATION</span><span class="p">,</span>
    <span class="n">INTEGRATION_NAME_ALREADY_IN_USE</span><span class="p">,</span> <span class="n">INTEGRATION_URL_ALREADY_IN_USE</span><span class="p">,</span>
    <span class="n">INVALID_ADMIN_CREDENTIALS</span><span class="p">,</span> <span class="n">INVALID_CONFIGURATION_OPTION</span><span class="p">,</span>
    <span class="n">INVALID_CSRF_TOKEN</span><span class="p">,</span> <span class="n">LANE_WITH_PARENT_AND_DISPLAY_NAME_ALREADY_EXISTS</span><span class="p">,</span>
    <span class="n">MISSING_COLLECTION</span><span class="p">,</span> <span class="n">MISSING_CUSTOM_LIST</span><span class="p">,</span> <span class="n">MISSING_LANE</span><span class="p">,</span> <span class="n">MISSING_SERVICE</span><span class="p">,</span>
    <span class="n">NO_CUSTOM_LISTS_FOR_LANE</span><span class="p">,</span> <span class="n">NO_DISPLAY_NAME_FOR_LANE</span><span class="p">,</span>
    <span class="n">NO_PROTOCOL_FOR_NEW_SERVICE</span><span class="p">,</span> <span class="n">NO_SUCH_LIBRARY</span><span class="p">,</span> <span class="n">NO_SUCH_PATRON</span><span class="p">,</span>
    <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="p">,</span> <span class="n">UNKNOWN_PROTOCOL</span><span class="p">,</span> <span class="n">AdminNotAuthorized</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.admin.google_oauth_admin_authentication_provider</span> <span class="kn">import</span> <span class="n">GoogleOAuthAdminAuthenticationProvider</span>
<span class="kn">from</span> <span class="nn">api.admin.opds</span> <span class="kn">import</span> <span class="n">AdminAnnotator</span><span class="p">,</span> <span class="n">AdminFeed</span>
<span class="kn">from</span> <span class="nn">api.admin.password_admin_authentication_provider</span> <span class="kn">import</span> <span class="n">PasswordAdminAuthenticationProvider</span>
<span class="kn">from</span> <span class="nn">api.admin.template_styles</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">body_style</span><span class="p">,</span> <span class="n">error_style</span><span class="p">,</span> <span class="n">hr_style</span><span class="p">,</span> <span class="n">section_style</span><span class="p">,</span> <span class="n">small_link_style</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.admin.templates</span> <span class="kn">import</span> <span class="n">admin</span> <span class="k">as</span> <span class="n">admin_template</span>
<span class="kn">from</span> <span class="nn">api.admin.validator</span> <span class="kn">import</span> <span class="n">Validator</span>
<span class="kn">from</span> <span class="nn">api.util.short_client_token</span> <span class="kn">import</span> <span class="n">ShortClientTokenUtility</span>
<span class="kn">from</span> <span class="nn">api.authenticator</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CannotCreateLocalPatron</span><span class="p">,</span> <span class="n">LibraryAuthenticator</span><span class="p">,</span> <span class="n">PatronData</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.axis</span> <span class="kn">import</span> <span class="n">Axis360API</span>
<span class="kn">from</span> <span class="nn">api.bibliotheca</span> <span class="kn">import</span> <span class="n">BibliothecaAPI</span>
<span class="kn">from</span> <span class="nn">api.config</span> <span class="kn">import</span> <span class="n">CannotLoadConfiguration</span><span class="p">,</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">api.controller</span> <span class="kn">import</span> <span class="n">CirculationManagerController</span>
<span class="kn">from</span> <span class="nn">api.enki</span> <span class="kn">import</span> <span class="n">EnkiAPI</span>
<span class="kn">from</span> <span class="nn">api.feedbooks</span> <span class="kn">import</span> <span class="n">FeedbooksOPDSImporter</span>
<span class="kn">from</span> <span class="nn">api.lanes</span> <span class="kn">import</span> <span class="n">create_default_lanes</span>
<span class="kn">from</span> <span class="nn">api.lcp.collection</span> <span class="kn">import</span> <span class="n">LCPAPI</span>
<span class="kn">from</span> <span class="nn">api.local_analytics_exporter</span> <span class="kn">import</span> <span class="n">LocalAnalyticsExporter</span>
<span class="kn">from</span> <span class="nn">api.odilo</span> <span class="kn">import</span> <span class="n">OdiloAPI</span>
<span class="kn">from</span> <span class="nn">api.odl</span> <span class="kn">import</span> <span class="n">ODLAPI</span><span class="p">,</span> <span class="n">SharedODLAPI</span>
<span class="kn">from</span> <span class="nn">api.opds_for_distributors</span> <span class="kn">import</span> <span class="n">OPDSForDistributorsAPI</span>
<span class="kn">from</span> <span class="nn">api.overdrive</span> <span class="kn">import</span> <span class="n">OverdriveAPI</span>
<span class="kn">from</span> <span class="nn">api.proquest.importer</span> <span class="kn">import</span> <span class="n">ProQuestOPDS2Importer</span>
<span class="kn">from</span> <span class="nn">api.rbdigital</span> <span class="kn">import</span> <span class="n">RBDigitalAPI</span>
<span class="kn">from</span> <span class="nn">core.app_server</span> <span class="kn">import</span> <span class="n">load_pagination_from_request</span>
<span class="kn">from</span> <span class="nn">core.classifier</span> <span class="kn">import</span> <span class="n">genres</span>
<span class="kn">from</span> <span class="nn">core.external_search</span> <span class="kn">import</span> <span class="n">ExternalSearchIndex</span>
<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">WorkList</span>
<span class="kn">from</span> <span class="nn">core.local_analytics_provider</span> <span class="kn">import</span> <span class="n">LocalAnalyticsProvider</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Admin</span><span class="p">,</span> <span class="n">AdminRole</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
                        <span class="n">ConfigurationSetting</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span> <span class="n">CustomListEntry</span><span class="p">,</span>
                        <span class="n">DataSource</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">,</span>
                        <span class="n">Library</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="n">Patron</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">,</span> <span class="n">Work</span><span class="p">,</span>
                        <span class="n">create</span><span class="p">,</span> <span class="n">get_one</span><span class="p">,</span> <span class="n">get_one_or_create</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">core.opds</span> <span class="kn">import</span> <span class="n">AcquisitionFeed</span>
<span class="kn">from</span> <span class="nn">core.opds2_import</span> <span class="kn">import</span> <span class="n">OPDS2Importer</span>
<span class="kn">from</span> <span class="nn">core.opds_import</span> <span class="kn">import</span> <span class="n">OPDSImporter</span><span class="p">,</span> <span class="n">OPDSImportMonitor</span>
<span class="kn">from</span> <span class="nn">core.s3</span> <span class="kn">import</span> <span class="n">S3UploaderConfiguration</span>
<span class="kn">from</span> <span class="nn">core.selftest</span> <span class="kn">import</span> <span class="n">HasSelfTests</span>
<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">utc_now</span>
<span class="kn">from</span> <span class="nn">core.util.flask_util</span> <span class="kn">import</span> <span class="n">OPDSFeedResponse</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="n">HTTP</span>
<span class="kn">from</span> <span class="nn">core.util.problem_detail</span> <span class="kn">import</span> <span class="n">ProblemDetail</span>


<div class="viewcode-block" id="setup_admin_controllers"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.setup_admin_controllers">[docs]</a><span class="k">def</span> <span class="nf">setup_admin_controllers</span><span class="p">(</span><span class="n">manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up all the controllers that will be used by the admin parts of the web app.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not load configuration file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">admin_view_controller</span> <span class="o">=</span> <span class="n">ViewController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_sign_in_controller</span> <span class="o">=</span> <span class="n">SignInController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">timestamps_controller</span> <span class="o">=</span> <span class="n">TimestampsController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.work_editor</span> <span class="kn">import</span> <span class="n">WorkController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_work_controller</span> <span class="o">=</span> <span class="n">WorkController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_feed_controller</span> <span class="o">=</span> <span class="n">FeedController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_custom_lists_controller</span> <span class="o">=</span> <span class="n">CustomListsController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_lanes_controller</span> <span class="o">=</span> <span class="n">LanesController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_dashboard_controller</span> <span class="o">=</span> <span class="n">DashboardController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_settings_controller</span> <span class="o">=</span> <span class="n">SettingsController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_patron_controller</span> <span class="o">=</span> <span class="n">PatronController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.self_tests</span> <span class="kn">import</span> <span class="n">SelfTestsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_self_tests_controller</span> <span class="o">=</span> <span class="n">SelfTestsController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.discovery_services</span> <span class="kn">import</span> <span class="n">DiscoveryServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_discovery_services_controller</span> <span class="o">=</span> <span class="n">DiscoveryServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.discovery_service_library_registrations</span> <span class="kn">import</span> <span class="n">DiscoveryServiceLibraryRegistrationsController</span>  <span class="c1"># noqa: E501</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_discovery_service_library_registrations_controller</span> <span class="o">=</span> <span class="n">DiscoveryServiceLibraryRegistrationsController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.cdn_services</span> <span class="kn">import</span> <span class="n">CDNServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_cdn_services_controller</span> <span class="o">=</span> <span class="n">CDNServicesController</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.analytics_services</span> <span class="kn">import</span> <span class="n">AnalyticsServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_analytics_services_controller</span> <span class="o">=</span> <span class="n">AnalyticsServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.metadata_services</span> <span class="kn">import</span> <span class="n">MetadataServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_metadata_services_controller</span> <span class="o">=</span> <span class="n">MetadataServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.metadata_service_self_tests</span> <span class="kn">import</span> <span class="n">MetadataServiceSelfTestsController</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.patron_auth_services</span> <span class="kn">import</span> <span class="n">PatronAuthServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_metadata_service_self_tests_controller</span> <span class="o">=</span> <span class="n">MetadataServiceSelfTestsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_patron_auth_services_controller</span> <span class="o">=</span> <span class="n">PatronAuthServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.patron_auth_service_self_tests</span> <span class="kn">import</span> <span class="n">PatronAuthServiceSelfTestsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_patron_auth_service_self_tests_controller</span> <span class="o">=</span> <span class="n">PatronAuthServiceSelfTestsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.admin_auth_services</span> <span class="kn">import</span> <span class="n">AdminAuthServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_auth_services_controller</span> <span class="o">=</span> <span class="n">AdminAuthServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.collection_settings</span> <span class="kn">import</span> <span class="n">CollectionSettingsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_collection_settings_controller</span> <span class="o">=</span> <span class="n">CollectionSettingsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.collection_self_tests</span> <span class="kn">import</span> <span class="n">CollectionSelfTestsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_collection_self_tests_controller</span> <span class="o">=</span> <span class="n">CollectionSelfTestsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.collection_library_registrations</span> <span class="kn">import</span> <span class="n">CollectionLibraryRegistrationsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_collection_library_registrations_controller</span> <span class="o">=</span> <span class="n">CollectionLibraryRegistrationsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.sitewide_settings</span> <span class="kn">import</span> <span class="n">SitewideConfigurationSettingsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_sitewide_configuration_settings_controller</span> <span class="o">=</span> <span class="n">SitewideConfigurationSettingsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.library_settings</span> <span class="kn">import</span> <span class="n">LibrarySettingsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_library_settings_controller</span> <span class="o">=</span> <span class="n">LibrarySettingsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.individual_admin_settings</span> <span class="kn">import</span> <span class="n">IndividualAdminSettingsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_individual_admin_settings_controller</span> <span class="o">=</span> <span class="n">IndividualAdminSettingsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.sitewide_services</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">LoggingServicesController</span><span class="p">,</span> <span class="n">SearchServicesController</span><span class="p">,</span> <span class="n">SitewideServicesController</span>
    <span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_sitewide_services_controller</span> <span class="o">=</span> <span class="n">SitewideServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_logging_services_controller</span> <span class="o">=</span> <span class="n">LoggingServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.search_service_self_tests</span> <span class="kn">import</span> <span class="n">SearchServiceSelfTestsController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_search_service_self_tests_controller</span> <span class="o">=</span> <span class="n">SearchServiceSelfTestsController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_search_services_controller</span> <span class="o">=</span> <span class="n">SearchServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.storage_services</span> <span class="kn">import</span> <span class="n">StorageServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_storage_services_controller</span> <span class="o">=</span> <span class="n">StorageServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">api.admin.controller.catalog_services</span> <span class="kn">import</span> <span class="n">CatalogServicesController</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">admin_catalog_services_controller</span> <span class="o">=</span> <span class="n">CatalogServicesController</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdminController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController">[docs]</a><span class="k">class</span> <span class="nc">AdminController</span><span class="p">:</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">url_for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_url_for</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">cdn_url_for</span>

<div class="viewcode-block" id="AdminController.admin_auth_provider"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.admin_auth_provider">[docs]</a>    <span class="k">def</span> <span class="nf">admin_auth_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an auth provider with the given type.</span>
<span class="sd">        If no auth provider has this type, return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="nb">type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">provider</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AdminController.authenticated_admin_from_request"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.authenticated_admin_from_request">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_admin_from_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an authenticated admin or a problem detail.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_NOT_CONFIGURED</span>

        <span class="n">email</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;admin_email&quot;</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auth_type&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">email</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">:</span>
            <span class="n">admin</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Admin</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_provider</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ADMIN_AUTH_MECHANISM_NOT_CONFIGURED</span>

            <span class="k">if</span> <span class="n">admin</span> <span class="ow">and</span> <span class="n">auth</span><span class="o">.</span><span class="n">active_credentials</span><span class="p">(</span><span class="n">admin</span><span class="p">):</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="n">admin</span>
                <span class="k">return</span> <span class="n">admin</span>

        <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">INVALID_ADMIN_CREDENTIALS</span></div>

<div class="viewcode-block" id="AdminController.authenticated_admin"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.authenticated_admin">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_details</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates or updates an admin with the given details&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">admin</span><span class="p">,</span> <span class="n">is_new</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Admin</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">admin_details</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">update_credentials</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">credential</span><span class="o">=</span><span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;credentials&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">AdminRole</span><span class="o">.</span><span class="n">ROLES</span><span class="p">:</span>
                    <span class="n">library</span> <span class="o">=</span> <span class="n">Library</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">library</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> authentication provider specifiec an unknown library for a new admin: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library&quot;</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">admin</span><span class="o">.</span><span class="n">add_role</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">),</span> <span class="n">library</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> authentication provider specified an unknown role for a new admin: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="n">role</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)))</span>

        <span class="c1"># Set up the admin&#39;s flask session.</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;admin_email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;auth_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

        <span class="c1"># A permanent session expires after a fixed time, rather than when the user closes the browser.</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If this is the first time an admin has been authenticated, make sure there is a value set for</span>
        <span class="c1"># the sitewide BASE_URL_KEY setting. If it&#39;s not set, set it to the hostname of the current</span>
        <span class="c1"># request. This assumes the first authenticated admin is accessing the admin interface through</span>
        <span class="c1"># the hostname they want to be used for the site itself.</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">BASE_URL_KEY</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">base_url</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">admin</span></div>

<div class="viewcode-block" id="AdminController.check_csrf_token"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.check_csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">check_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the CSRF token in the form data or X-CSRF-Token header matches the one in the session cookie.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cookie_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">()</span>
        <span class="n">header_token</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-CSRF-Token&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_token</span> <span class="ow">or</span> <span class="n">cookie_token</span> <span class="o">!=</span> <span class="n">header_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_CSRF_TOKEN</span>

        <span class="k">return</span> <span class="n">cookie_token</span></div>

<div class="viewcode-block" id="AdminController.get_csrf_token"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.get_csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the CSRF token for the current session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AdminController.generate_csrf_token"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminController.generate_csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">generate_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a random CSRF token.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">admin_auth_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">auth_providers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auth_service</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">admin_authentication</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">auth_service</span> <span class="ow">and</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">GOOGLE_OAUTH</span><span class="p">:</span>
            <span class="n">auth_providers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GoogleOAuthAdminAuthenticationProvider</span><span class="p">(</span>
                <span class="n">auth_service</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;google_auth_callback&#39;</span><span class="p">),</span> <span class="n">test_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="n">Admin</span><span class="o">.</span><span class="n">with_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">auth_providers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">PasswordAdminAuthenticationProvider</span><span class="p">(</span><span class="n">auth_service</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">auth_providers</span></div>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="AdminCirculationManagerController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController">[docs]</a><span class="k">class</span> <span class="nc">AdminCirculationManagerController</span><span class="p">(</span><span class="n">CirculationManagerController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent class that provides methods for verifying an admin&#39;s roles.&quot;&quot;&quot;</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
<div class="viewcode-block" id="AdminCirculationManagerController.require_system_admin"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController.require_system_admin">[docs]</a>    <span class="k">def</span> <span class="nf">require_system_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">is_system_admin</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">AdminNotAuthorized</span><span class="p">()</span></div>

<div class="viewcode-block" id="AdminCirculationManagerController.require_sitewide_library_manager"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController.require_sitewide_library_manager">[docs]</a>    <span class="k">def</span> <span class="nf">require_sitewide_library_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">is_sitewide_library_manager</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">AdminNotAuthorized</span><span class="p">()</span></div>

<div class="viewcode-block" id="AdminCirculationManagerController.require_library_manager"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController.require_library_manager">[docs]</a>    <span class="k">def</span> <span class="nf">require_library_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">is_library_manager</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AdminNotAuthorized</span><span class="p">()</span></div>

<div class="viewcode-block" id="AdminCirculationManagerController.require_librarian"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController.require_librarian">[docs]</a>    <span class="k">def</span> <span class="nf">require_librarian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">is_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AdminNotAuthorized</span><span class="p">()</span></div>

<div class="viewcode-block" id="AdminCirculationManagerController.require_higher_than_librarian"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.AdminCirculationManagerController.require_higher_than_librarian">[docs]</a>    <span class="k">def</span> <span class="nf">require_higher_than_librarian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A quick way to check the admin&#39;s permissions level without needing to already know the library;</span>
        <span class="c1"># used as a fail-safe in AnalyticsServicesController.process_post in case a librarian somehow manages</span>
        <span class="c1"># to submit a Local Analytics form despite the checks on the front end.</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">roles</span> <span class="ow">or</span> <span class="n">admin</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;librarian&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AdminNotAuthorized</span><span class="p">()</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="ViewController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.ViewController">[docs]</a><span class="k">class</span> <span class="nc">ViewController</span><span class="p">(</span><span class="n">AdminController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">setting_up</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span> <span class="o">==</span> <span class="p">[])</span>
        <span class="n">email</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">setting_up</span><span class="p">:</span>
            <span class="n">admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_admin_from_request</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
                <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">collection</span><span class="p">):</span>
                    <span class="n">quoted_collection</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">redirect_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="n">quoted_collection</span><span class="p">,</span>
                        <span class="n">quoted_collection</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2F</span><span class="s2">&quot;</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">book</span><span class="p">):</span>
                    <span class="n">quoted_book</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">redirect_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="n">quoted_book</span><span class="p">,</span>
                        <span class="n">quoted_book</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2F</span><span class="s2">&quot;</span><span class="p">))</span>

                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin_sign_in&#39;</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="n">redirect_url</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">book</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Find the first library the admin is a librarian of.</span>
                    <span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Library</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">asc</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">admin</span><span class="o">.</span><span class="n">is_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
                            <span class="n">library_name</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">library_name</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Your admin account doesn&#39;t have access to any libraries. &quot;</span>
                            <span class="s2">&quot;Contact your library manager for assistance.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin_view&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">library_name</span><span class="p">))</span>

            <span class="n">email</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">email</span>

            <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">admin</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">library</span><span class="p">:</span>
                    <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">:</span> <span class="n">role</span><span class="o">.</span><span class="n">library</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="o">.</span><span class="n">role</span><span class="p">})</span>

        <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_csrf_token</span><span class="p">()</span>

        <span class="c1"># Find the URL and text to use when rendering the Terms of Service link in the footer.</span>
        <span class="n">sitewide_tos_href</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">CUSTOM_TOS_HREF</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">DEFAULT_TOS_HREF</span>

        <span class="n">sitewide_tos_text</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">CUSTOM_TOS_TEXT</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">DEFAULT_TOS_TEXT</span>

        <span class="n">local_analytics</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">LocalAnalyticsProvider</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="n">goal</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">ANALYTICS_GOAL</span>
        <span class="p">)</span>
        <span class="n">show_circ_events_download</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">local_analytics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">render_template_string</span><span class="p">(</span>
            <span class="n">admin_template</span><span class="p">,</span>
            <span class="n">csrf_token</span><span class="o">=</span><span class="n">csrf_token</span><span class="p">,</span>
            <span class="n">sitewide_tos_href</span><span class="o">=</span><span class="n">sitewide_tos_href</span><span class="p">,</span>
            <span class="n">sitewide_tos_text</span><span class="o">=</span><span class="n">sitewide_tos_text</span><span class="p">,</span>
            <span class="n">show_circ_events_download</span><span class="o">=</span><span class="n">show_circ_events_download</span><span class="p">,</span>
            <span class="n">setting_up</span><span class="o">=</span><span class="n">setting_up</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
            <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">,</span>
        <span class="p">))</span>

        <span class="c1"># The CSRF token is in its own cookie instead of the session cookie,</span>
        <span class="c1"># because if your session expires and you log in again, you should</span>
        <span class="c1"># be able to submit a form you already had open. The CSRF token lasts</span>
        <span class="c1"># until the user closes the browser window.</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="TimestampsController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.TimestampsController">[docs]</a><span class="k">class</span> <span class="nc">TimestampsController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dict: each key is a type of service (script, monitor, or coverage provider);</span>
<span class="sd">    each value is a nested dict in which timestamps are organized by service name and then by collection ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>

<div class="viewcode-block" id="TimestampsController.diagnostics"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.TimestampsController.diagnostics">[docs]</a>    <span class="k">def</span> <span class="nf">diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_system_admin</span><span class="p">()</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_by_type</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">services</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
                <span class="n">by_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_by_collection</span><span class="p">(</span><span class="nb">sorted</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">service</span><span class="p">])</span>
                <span class="nb">sorted</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">service</span><span class="p">]</span> <span class="o">=</span> <span class="n">by_collection</span>

        <span class="k">return</span> <span class="nb">sorted</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="k">def</span> <span class="nf">_sort_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of Timestamp objects.  Returns a dict: each key is a type of service</span>
<span class="sd">        (script, monitor, or coverage provider); each value is a dict in which the keys are the names</span>
<span class="sd">        of services and the values are lists of timestamps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_info</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">ts</span><span class="o">.</span><span class="n">service_type</span> <span class="ow">or</span> <span class="s2">&quot;other&quot;</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">result</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_by_service</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_sort_by_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict: each key is the name of a service; each value is a list of timestamps.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;service&quot;</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_sort_by_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of timestamps; turns it into a dict in which each key is a</span>
<span class="sd">        collection ID and each value is a list of the timestamps associated with that collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;collection_name&quot;</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_extract_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a Timestamp object and returns a dict&quot;&quot;&quot;</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">finish</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">finish</span> <span class="o">-</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&quot;No associated collection&quot;</span>
        <span class="k">if</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="n">collection_name</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">timestamp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">timestamp</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
            <span class="n">exception</span><span class="o">=</span><span class="n">timestamp</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span>
            <span class="n">service</span><span class="o">=</span><span class="n">timestamp</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">achievements</span><span class="o">=</span><span class="n">timestamp</span><span class="o">.</span><span class="n">achievements</span>
        <span class="p">)</span></div>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="SignInController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController">[docs]</a><span class="k">class</span> <span class="nc">SignInController</span><span class="p">(</span><span class="n">AdminController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>
    <span class="n">ERROR_RESPONSE_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;!DOCTYPE HTML&gt;&#39;</span>
        <span class="s1">&#39;&lt;html lang=&quot;en&quot;&gt;&#39;</span>
        <span class="s1">&#39;&lt;head&gt;&lt;meta charset=&quot;utf8&quot;&gt;&lt;/head&gt;&#39;</span>
        <span class="s1">&#39;&lt;body style=&quot;</span><span class="si">{error}</span><span class="s1">&quot;&gt;&#39;</span>
        <span class="s1">&#39;&lt;p&gt;&lt;strong&gt;</span><span class="si">%(status_code)d</span><span class="s1"> ERROR:&lt;/strong&gt; </span><span class="si">%(message)s</span><span class="s1">&lt;/p&gt;&#39;</span>
        <span class="s1">&#39;&lt;hr style=&quot;</span><span class="si">{hr}</span><span class="s1">&quot;&gt;&#39;</span>
        <span class="s1">&#39;&lt;a href=&quot;/admin/sign_in&quot; style=&quot;</span><span class="si">{link}</span><span class="s1">&quot;&gt;Try again&lt;/a&gt;&#39;</span>
        <span class="s1">&#39;&lt;/body&gt;&#39;</span>
        <span class="s1">&#39;&lt;/html&gt;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">error_style</span><span class="p">,</span> <span class="n">hr</span><span class="o">=</span><span class="n">hr_style</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="n">small_link_style</span><span class="p">)</span>

    <span class="n">SIGN_IN_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;!DOCTYPE HTML&gt;&#39;</span>
        <span class="s1">&#39;&lt;html lang=&quot;en&quot;&gt;&#39;</span>
        <span class="s1">&#39;&lt;head&gt;&lt;meta charset=&quot;utf8&quot;&gt;&lt;/head&gt;&#39;</span>
        <span class="s1">&#39;&lt;body style=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;&#39;</span>
        <span class="s1">&#39;&lt;h1&gt;Library Simplified&lt;/h1&gt;&#39;</span>
        <span class="s1">&#39;</span><span class="si">%(auth_provider_html)s</span><span class="s1">&#39;</span>
        <span class="s1">&#39;&lt;/body&gt;&#39;</span>
        <span class="s1">&#39;&lt;/html&gt;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_style</span><span class="p">)</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
<div class="viewcode-block" id="SignInController.sign_in"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.sign_in">[docs]</a>    <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirects admin if they&#39;re signed in, or shows the sign in page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_NOT_CONFIGURED</span>

        <span class="n">admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_admin_from_request</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redirect&quot;</span><span class="p">)</span>
            <span class="n">auth_provider_html</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">sign_in_template</span><span class="p">(</span>
                <span class="n">redirect_url</span><span class="p">)</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">]</span>
            <span class="n">auth_provider_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                &lt;section style=&quot;</span><span class="si">{section}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                &lt;hr style=&quot;</span><span class="si">{hr}</span><span class="s2">&quot;&gt;or&lt;hr style=&quot;</span><span class="si">{hr}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                &lt;/section&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section_style</span><span class="p">,</span> <span class="n">hr</span><span class="o">=</span><span class="n">hr_style</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">auth_provider_html</span><span class="p">)</span>

            <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIGN_IN_TEMPLATE</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">auth_provider_html</span><span class="o">=</span><span class="n">auth_provider_html</span>
            <span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text/html&quot;</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">admin</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redirect&quot;</span><span class="p">),</span> <span class="n">Response</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignInController.redirect_after_google_sign_in"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.redirect_after_google_sign_in">[docs]</a>    <span class="k">def</span> <span class="nf">redirect_after_google_sign_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses the Google OAuth client to determine admin details upon</span>
<span class="sd">        callback. Barring error, redirects to the provided redirect url..&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_NOT_CONFIGURED</span>

        <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_provider</span><span class="p">(</span>
            <span class="n">GoogleOAuthAdminAuthenticationProvider</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_MECHANISM_NOT_CONFIGURED</span>

        <span class="n">admin_details</span><span class="p">,</span> <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_details</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">admin_details</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_admin</span><span class="p">(</span><span class="n">admin_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">Response</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignInController.password_sign_in"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.password_sign_in">[docs]</a>    <span class="k">def</span> <span class="nf">password_sign_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_providers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_NOT_CONFIGURED</span>

        <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_auth_provider</span><span class="p">(</span>
            <span class="n">PasswordAdminAuthenticationProvider</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADMIN_AUTH_MECHANISM_NOT_CONFIGURED</span>

        <span class="n">admin_details</span><span class="p">,</span> <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_details</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">INVALID_ADMIN_CREDENTIALS</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_admin</span><span class="p">(</span><span class="n">admin_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">Response</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignInController.change_password"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.change_password">[docs]</a>    <span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_password</span><span class="p">:</span>
            <span class="n">admin</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">new_password</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignInController.sign_out"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.sign_out">[docs]</a>    <span class="k">def</span> <span class="nf">sign_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clear out the admin&#39;s flask session.</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;admin_email&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;auth_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">redirect_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;admin_sign_in&quot;</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;admin_view&quot;</span><span class="p">),</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignInController.error_response"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SignInController.error_response">[docs]</a>    <span class="k">def</span> <span class="nf">error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem_detail</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a problem detail as an HTML response&quot;&quot;&quot;</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_RESPONSE_TEMPLATE</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">problem_detail</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">problem_detail</span><span class="o">.</span><span class="n">detail</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">problem_detail</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="PatronController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.PatronController">[docs]</a><span class="k">class</span> <span class="nc">PatronController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
<div class="viewcode-block" id="PatronController.lookup_patron"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.PatronController.lookup_patron">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look up personal information about a patron via the ILS.</span>

<span class="sd">        :param authenticator: A LibraryAuthenticator. This is for mocking</span>
<span class="sd">            during tests; it&#39;s not necessary to provide it normally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_patrondata</span><span class="p">(</span><span class="n">authenticator</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">return</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">to_dict</span></div>

<div class="viewcode-block" id="PatronController.reset_adobe_id"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.PatronController.reset_adobe_id">[docs]</a>    <span class="k">def</span> <span class="nf">reset_adobe_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all Credentials for a patron that are relevant to the patron&#39;s Adobe Account ID.</span>

<span class="sd">        :param authenticator: A LibraryAuthenticator. This is for mocking during tests; it&#39;s not necessary to provide it normal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_patrondata</span><span class="p">(</span><span class="n">authenticator</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="c1"># Turn the Identifier into a Patron object.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">get_or_create_patron</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">CannotCreateLocalPatron</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_SUCH_PATRON</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span>
                    <span class="s2">&quot;Could not create local patron object for </span><span class="si">%(patron_identifier)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">patron_identifier</span><span class="o">=</span><span class="n">patrondata</span><span class="o">.</span><span class="n">authorization_identifier</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Wipe the Patron&#39;s &#39;identifier for Adobe ID purposes&#39;.</span>
        <span class="k">for</span> <span class="n">credential</span> <span class="ow">in</span> <span class="n">ShortClientTokenUtility</span><span class="o">.</span><span class="n">adobe_relevant_credentials</span><span class="p">(</span><span class="n">patron</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">credential</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patron</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">username</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;with identifier &quot;</span> <span class="o">+</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Adobe ID for patron </span><span class="si">%(name_or_auth_id)s</span><span class="s2"> has been reset.&quot;</span><span class="p">,</span>
                <span class="n">name_or_auth_id</span><span class="o">=</span><span class="n">identifier</span><span class="p">)),</span>
            <span class="mi">200</span>
        <span class="p">)</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>
    <span class="k">def</span> <span class="nf">_load_patrondata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a patron identifier from an incoming form submission, and ask the library&#39;s</span>
<span class="sd">        LibraryAuthenticator to turn it into a PatronData by doing a remote lookup in the ILS.</span>

<span class="sd">        :param authenticator: A LibraryAuthenticator. This is for mocking during tests;</span>
<span class="sd">            it&#39;s not necessary to provide it normally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_SUCH_PATRON</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Please enter a patron identifier&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">authenticator</span><span class="p">:</span>
            <span class="n">authenticator</span> <span class="o">=</span> <span class="n">LibraryAuthenticator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">patron_data</span> <span class="o">=</span> <span class="n">PatronData</span><span class="p">(</span><span class="n">authorization_identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">complete_patron_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_SUCH_PATRON</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;This library has no authentication providers, so it has no patrons.&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">complete_patron_data</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">remote_patron_lookup</span><span class="p">(</span><span class="n">patron_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">complete_patron_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">complete_patron_data</span>

        <span class="c1"># If we get here, none of the providers succeeded.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">complete_patron_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_SUCH_PATRON</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;No patron with identifier </span><span class="si">%(patron_identifier)s</span><span class="s2"> was found at your library&quot;</span><span class="p">,</span>
                    <span class="n">patron_identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">),</span>
            <span class="p">)</span></div>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="FeedController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.FeedController">[docs]</a><span class="k">class</span> <span class="nc">FeedController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
<div class="viewcode-block" id="FeedController.complaints"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.FeedController.complaints">[docs]</a>    <span class="k">def</span> <span class="nf">complaints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">this_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;complaints&#39;</span><span class="p">)</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="n">AdminAnnotator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">pagination</span> <span class="o">=</span> <span class="n">load_pagination_from_request</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pagination</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pagination</span>

        <span class="n">opds_feed</span> <span class="o">=</span> <span class="n">AdminFeed</span><span class="o">.</span><span class="n">complaints</span><span class="p">(</span>
            <span class="n">library</span><span class="o">=</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Complaints&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">this_url</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">,</span>
            <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">OPDSFeedResponse</span><span class="p">(</span><span class="n">opds_feed</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeedController.suppressed"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.FeedController.suppressed">[docs]</a>    <span class="k">def</span> <span class="nf">suppressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">this_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;suppressed&#39;</span><span class="p">)</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="n">AdminAnnotator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">pagination</span> <span class="o">=</span> <span class="n">load_pagination_from_request</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pagination</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pagination</span>

        <span class="n">opds_feed</span> <span class="o">=</span> <span class="n">AdminFeed</span><span class="o">.</span><span class="n">suppressed</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Hidden Books&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">this_url</span><span class="p">,</span> <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span><span class="p">,</span>
            <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">OPDSFeedResponse</span><span class="p">(</span><span class="n">opds_feed</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeedController.genres"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.FeedController.genres">[docs]</a>    <span class="k">def</span> <span class="nf">genres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span>
            <span class="s2">&quot;Fiction&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">({}),</span>
            <span class="s2">&quot;Nonfiction&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="p">})</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="s2">&quot;Fiction&quot;</span> <span class="k">if</span> <span class="n">genres</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">is_fiction</span> <span class="k">else</span> <span class="s2">&quot;Nonfiction&quot;</span>
            <span class="n">data</span><span class="p">[</span><span class="n">top</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">parents</span><span class="p">],</span>
                <span class="s2">&quot;subgenres&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">subgenre</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">subgenre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">subgenres</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">data</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="CustomListsController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.CustomListsController">[docs]</a><span class="k">class</span> <span class="nc">CustomListsController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>
<div class="viewcode-block" id="CustomListsController.custom_lists"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.CustomListsController.custom_lists">[docs]</a>    <span class="k">def</span> <span class="nf">custom_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="n">custom_lists</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">custom_lists</span><span class="p">:</span>
                <span class="n">collections</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="nb">list</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                    <span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>

                <span class="n">custom_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="n">collections</span><span class="p">,</span> <span class="n">entry_count</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">custom_lists</span><span class="o">=</span><span class="n">custom_lists</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJSONFromRequest</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">))</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJSONFromRequest</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_update_list</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomListsController.url_for_custom_list"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.CustomListsController.url_for_custom_list">[docs]</a>    <span class="k">def</span> <span class="nf">url_for_custom_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">url_fn</span><span class="p">(</span><span class="n">after</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;custom_list&quot;</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">list_id</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url_fn</span></div>

<div class="viewcode-block" id="CustomListsController.custom_list"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.CustomListsController.custom_list">[docs]</a>    <span class="k">def</span> <span class="nf">custom_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>

        <span class="nb">list</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">,</span>
                       <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_CUSTOM_LIST</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="n">pagination</span> <span class="o">=</span> <span class="n">load_pagination_from_request</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pagination</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pagination</span>

            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Work</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Work</span><span class="o">.</span><span class="n">custom_list_entries</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">CustomListEntry</span><span class="o">.</span><span class="n">list_id</span> <span class="o">==</span> <span class="n">list_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;custom_list&quot;</span><span class="p">,</span> <span class="n">list_name</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                               <span class="n">list_id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>

            <span class="n">worklist</span> <span class="o">=</span> <span class="n">WorkList</span><span class="p">()</span>
            <span class="n">worklist</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">customlists</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">])</span>

            <span class="n">annotator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">annotator</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span>
            <span class="n">url_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for_custom_list</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">list</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">url_fn</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">worklist</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">OPDSFeedResponse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">feed</span><span class="p">),</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJSONFromRequest</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">))</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJSONFromRequest</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">))</span>
            <span class="n">deletedEntries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJSONFromRequest</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deletedEntries&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_update_list</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span>
                                               <span class="n">deletedEntries</span><span class="o">=</span><span class="n">deletedEntries</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="c1"># Deleting requires a library manager.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

            <span class="c1"># Build the list of affected lanes before modifying the CustomList.</span>
            <span class="n">affected_lanes</span> <span class="o">=</span> <span class="n">Lane</span><span class="o">.</span><span class="n">affected_by_customlist</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">surviving_lanes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">affected_lanes</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">list_datasource</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">customlist_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># This Lane is based solely upon this custom list, which is about to be deleted.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>   <span class="c1"># Delete the Lane itself.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">surviving_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">list</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># Update the size for any lanes affected by this CustomList which _weren&#39;t_ deleted.</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">surviving_lanes</span><span class="p">:</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">update_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_engine</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Deleted&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>
    <span class="k">def</span> <span class="nf">_getJSONFromRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_get_work_from_urn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">urn</span><span class="p">):</span>
        <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse_urn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">urn</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">Work</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="n">Work</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Collection</span><span class="p">,</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">Collection</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">identifier_id</span> <span class="o">==</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Collection</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">all_collections</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">work</span>

    <span class="k">def</span> <span class="nf">_create_or_update_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="n">deletedEntries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>
        <span class="n">old_list_with_name</span> <span class="o">=</span> <span class="n">CustomList</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">list</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span>
                           <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MISSING_CUSTOM_LIST</span>

            <span class="k">if</span> <span class="nb">list</span><span class="o">.</span><span class="n">library</span> <span class="o">!=</span> <span class="n">library</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CANNOT_CHANGE_LIBRARY_FOR_CUSTOM_LIST</span>

            <span class="k">if</span> <span class="n">old_list_with_name</span> <span class="ow">and</span> <span class="n">old_list_with_name</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CUSTOM_LIST_NAME_ALREADY_IN_USE</span>

        <span class="k">elif</span> <span class="n">old_list_with_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CUSTOM_LIST_NAME_ALREADY_IN_USE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">list</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span>
                                  <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">library</span> <span class="o">=</span> <span class="n">library</span>

        <span class="nb">list</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">membership_change</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">works_to_update_in_search</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">urn</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_work_from_urn</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">urn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">entry_is_new</span> <span class="o">=</span> <span class="nb">list</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">featured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry_is_new</span><span class="p">:</span>
                    <span class="n">works_to_update_in_search</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                    <span class="n">membership_change</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">deletedEntries</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">deletedEntries</span><span class="p">:</span>
                <span class="n">urn</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_work_from_urn</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">urn</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                    <span class="nb">list</span><span class="o">.</span><span class="n">remove_entry</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                    <span class="n">works_to_update_in_search</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                    <span class="n">membership_change</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">membership_change</span><span class="p">:</span>
            <span class="c1"># We need to update the search index entries for works that caused a membership change,</span>
            <span class="c1"># so the upstream counts can be calculated correctly.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_engine</span><span class="o">.</span><span class="n">bulk_update</span><span class="p">(</span><span class="n">works_to_update_in_search</span><span class="p">)</span>

            <span class="c1"># If this list was used to populate any lanes, those lanes need to have their counts updated.</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">Lane</span><span class="o">.</span><span class="n">affected_by_customlist</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">update_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_engine</span><span class="p">)</span>

        <span class="n">new_collections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">collection_id</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">collection_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">MISSING_COLLECTION</span>

            <span class="k">if</span> <span class="nb">list</span><span class="o">.</span><span class="n">library</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">COLLECTION_NOT_ASSOCIATED_WITH_LIBRARY</span>

            <span class="n">new_collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>

        <span class="nb">list</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="n">new_collections</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="mi">201</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="LanesController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController">[docs]</a><span class="k">class</span> <span class="nc">LanesController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>

<div class="viewcode-block" id="LanesController.lanes"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.lanes">[docs]</a>    <span class="k">def</span> <span class="nf">lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">lanes_for_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Lane</span><span class="o">.</span><span class="n">library</span> <span class="o">==</span> <span class="n">library</span>
                <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Lane</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">parent</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                        <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="n">lane</span><span class="o">.</span><span class="n">visible</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">lane</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                        <span class="s2">&quot;sublanes&quot;</span><span class="p">:</span> <span class="n">lanes_for_parent</span><span class="p">(</span><span class="n">lane</span><span class="p">),</span>
                        <span class="s2">&quot;custom_list_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">],</span>
                        <span class="s2">&quot;inherit_parent_restrictions&quot;</span><span class="p">:</span> <span class="n">lane</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span><span class="p">,</span>
                    <span class="p">}</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span>
                <span class="p">]</span>

            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lanes</span><span class="o">=</span><span class="n">lanes_for_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

            <span class="nb">id</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">parent_id</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_name&quot;</span><span class="p">)</span>
            <span class="n">custom_list_ids</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_list_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;[]&quot;</span><span class="p">))</span>
            <span class="n">inherit_parent_restrictions</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;inherit_parent_restrictions&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inherit_parent_restrictions</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                <span class="n">inherit_parent_restrictions</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inherit_parent_restrictions</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">display_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NO_DISPLAY_NAME_FOR_LANE</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_list_ids</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_list_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NO_CUSTOM_LISTS_FOR_LANE</span>

            <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">MISSING_LANE</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">CANNOT_EDIT_DEFAULT_LANE</span>

                <span class="k">if</span> <span class="n">display_name</span> <span class="o">!=</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span><span class="p">:</span>
                    <span class="n">old_lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old_lane</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">LANE_WITH_PARENT_AND_DISPLAY_NAME_ALREADY_EXISTS</span>

                <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">parent_id</span><span class="p">:</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The specified parent lane does not exist, or is associated with a different library.&quot;</span>
                        <span class="k">return</span> <span class="n">MISSING_LANE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

                <span class="n">old_lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">old_lane</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">LANE_WITH_PARENT_AND_DISPLAY_NAME_ALREADY_EXISTS</span>

                <span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">is_new</span><span class="p">)</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span>
                                        <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                    <span class="n">lane</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Make a new lane the first child of its parent and bump all the siblings down in priority.</span>
                <span class="n">siblings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Lane</span><span class="o">.</span><span class="n">library</span> <span class="o">==</span> <span class="n">library</span>
                <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Lane</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">lane</span><span class="o">.</span><span class="n">parent</span>
                <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Lane</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">sibling</span> <span class="ow">in</span> <span class="n">siblings</span><span class="p">:</span>
                    <span class="n">sibling</span><span class="o">.</span><span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">lane</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">lane</span><span class="o">.</span><span class="n">inherit_parent_restrictions</span> <span class="o">=</span> <span class="n">inherit_parent_restrictions</span>

            <span class="k">for</span> <span class="n">list_id</span> <span class="ow">in</span> <span class="n">custom_list_ids</span><span class="p">:</span>
                <span class="nb">list</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span>
                               <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">MISSING_CUSTOM_LIST</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                        <span class="n">lgt</span><span class="p">(</span>
                            <span class="s2">&quot;The list with id </span><span class="si">%(list_id)s</span><span class="s2"> does not exist or is associated with a different library.&quot;</span><span class="p">,</span>
                            <span class="n">list_id</span><span class="o">=</span><span class="n">list_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

            <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">list</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">custom_list_ids</span><span class="p">:</span>
                    <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

            <span class="n">lane</span><span class="o">.</span><span class="n">update_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_engine</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="mi">201</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanesController.lane"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.lane">[docs]</a>    <span class="k">def</span> <span class="nf">lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

            <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MISSING_LANE</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CANNOT_EDIT_DEFAULT_LANE</span>

            <span class="c1"># Recursively delete all the lane&#39;s sublanes.</span>
            <span class="k">def</span> <span class="nf">delete_lane_and_sublanes</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sublane</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">sublanes</span><span class="p">:</span>
                    <span class="n">delete_lane_and_sublanes</span><span class="p">(</span><span class="n">sublane</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="n">delete_lane_and_sublanes</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Deleted&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanesController.show_lane"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.show_lane">[docs]</a>    <span class="k">def</span> <span class="nf">show_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_LANE</span>

        <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CANNOT_SHOW_LANE_WITH_HIDDEN_PARENT</span>

        <span class="n">lane</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanesController.hide_lane"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.hide_lane">[docs]</a>    <span class="k">def</span> <span class="nf">hide_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="n">lane</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Lane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_LANE</span>

        <span class="n">lane</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanesController.reset"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">create_default_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="LanesController.change_order"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.LanesController.change_order">[docs]</a>    <span class="k">def</span> <span class="nf">change_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_library_manager</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">submitted_lanes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">update_lane_order</span><span class="p">(</span><span class="n">lanes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">lane_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lanes</span><span class="p">):</span>
                <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Lane</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Lane</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">lane_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">update_lane_order</span><span class="p">(</span><span class="n">lane_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sublanes&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="n">update_lane_order</span><span class="p">(</span><span class="n">submitted_lanes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="DashboardController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.DashboardController">[docs]</a><span class="k">class</span> <span class="nc">DashboardController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>

<div class="viewcode-block" id="DashboardController.stats"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.DashboardController.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an accounting of library statistics</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Stats total licenses, available licenses, and patrons for each library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_title_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_license_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_available_license_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">collection_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">can_see_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">licensed_title_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">LicensePool</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span>       <span class="c1"># noqa: E712</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">open_title_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">LicensePool</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">True</span>             <span class="c1"># noqa: E712</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="c1"># The sum queries return None instead of 0 if there are no license pools in the db.</span>

            <span class="n">license_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span>           <span class="c1"># noqa: E712</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>

            <span class="n">available_license_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LicensePool</span><span class="o">.</span><span class="n">licenses_available</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LicensePool</span><span class="o">.</span><span class="n">open_access</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span>           <span class="c1"># noqa: E712</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>

            <span class="n">total_title_count</span> <span class="o">+=</span> <span class="n">licensed_title_count</span> <span class="o">+</span> <span class="n">open_title_count</span>
            <span class="n">total_license_count</span> <span class="o">+=</span> <span class="n">license_count</span>
            <span class="n">total_available_license_count</span> <span class="o">+=</span> <span class="n">available_license_count</span>

            <span class="n">collection_counts</span><span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">licensed_titles</span><span class="o">=</span><span class="n">licensed_title_count</span><span class="p">,</span>
                <span class="n">open_access_titles</span><span class="o">=</span><span class="n">open_title_count</span><span class="p">,</span>
                <span class="n">licenses</span><span class="o">=</span><span class="n">license_count</span><span class="p">,</span>
                <span class="n">available_licenses</span><span class="o">=</span><span class="n">available_license_count</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">):</span>
            <span class="c1"># Only include libraries this admin has librarian access to.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">is_librarian</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">patron_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Patron</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">active_loans_patron_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">distinct</span><span class="p">(</span><span class="n">Patron</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">loans</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">active_patrons</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">Patron</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span>
                    <span class="n">Loan</span><span class="p">,</span>
                    <span class="n">Patron</span><span class="p">,</span>
                    <span class="n">and_</span><span class="p">(</span>
                        <span class="n">Patron</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Loan</span><span class="o">.</span><span class="n">patron_id</span><span class="p">,</span>
                        <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">Loan</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>                        <span class="c1"># noqa: E711</span>
                        <span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">Patron</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span>
                        <span class="n">Hold</span><span class="p">,</span>
                        <span class="n">Patron</span><span class="p">,</span>
                        <span class="n">and_</span><span class="p">(</span>
                            <span class="n">Patron</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Hold</span><span class="o">.</span><span class="n">patron_id</span><span class="p">,</span>
                            <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">Hold</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

            <span class="n">active_loans_or_holds_patron_count_query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distinct</span><span class="p">(</span><span class="n">active_patrons</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">active_patrons</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">active_loans_or_holds_patron_count_query</span><span class="p">)</span>
            <span class="n">active_loans_or_holds_patron_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">loan_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Loan</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">hold_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Hold</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">patron</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">title_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">license_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">available_license_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">library_collection_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">all_collections</span><span class="p">:</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">collection_counts</span><span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">library_collection_counts</span><span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
                <span class="n">title_count</span> <span class="o">+=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;licensed_titles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;open_access_titles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">license_count</span> <span class="o">+=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;licenses&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">available_license_count</span> <span class="o">+=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_licenses&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">library_stats</span><span class="p">[</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">patrons</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">patron_count</span><span class="p">,</span>
                    <span class="n">with_active_loans</span><span class="o">=</span><span class="n">active_loans_patron_count</span><span class="p">,</span>
                    <span class="n">with_active_loans_or_holds</span><span class="o">=</span><span class="n">active_loans_or_holds_patron_count</span><span class="p">,</span>
                    <span class="n">loans</span><span class="o">=</span><span class="n">loan_count</span><span class="p">,</span>
                    <span class="n">holds</span><span class="o">=</span><span class="n">hold_count</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">inventory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">titles</span><span class="o">=</span><span class="n">title_count</span><span class="p">,</span>
                    <span class="n">licenses</span><span class="o">=</span><span class="n">license_count</span><span class="p">,</span>
                    <span class="n">available_licenses</span><span class="o">=</span><span class="n">available_license_count</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">collections</span><span class="o">=</span><span class="n">library_collection_counts</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">total_patrons</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patrons&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>
        <span class="n">total_with_active_loans</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patrons&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;with_active_loans&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>
        <span class="n">total_with_active_loans_or_holds</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patrons&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;with_active_loans_or_holds&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                                <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>

        <span class="c1"># TODO: show shared collection loans and holds for libraries outside this circ manager?</span>
        <span class="n">total_loans</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patrons&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loans&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>
        <span class="n">total_holds</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patrons&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;holds&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>

        <span class="n">library_stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">patrons</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_patrons</span><span class="p">,</span>
                <span class="n">with_active_loans</span><span class="o">=</span><span class="n">total_with_active_loans</span><span class="p">,</span>
                <span class="n">with_active_loans_or_holds</span><span class="o">=</span><span class="n">total_with_active_loans_or_holds</span><span class="p">,</span>
                <span class="n">loans</span><span class="o">=</span><span class="n">total_loans</span><span class="p">,</span>
                <span class="n">holds</span><span class="o">=</span><span class="n">total_holds</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">inventory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">titles</span><span class="o">=</span><span class="n">total_title_count</span><span class="p">,</span>
                <span class="n">licenses</span><span class="o">=</span><span class="n">total_license_count</span><span class="p">,</span>
                <span class="n">available_licenses</span><span class="o">=</span><span class="n">total_available_license_count</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">collections</span><span class="o">=</span><span class="n">collection_counts</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">library_stats</span></div>

<div class="viewcode-block" id="DashboardController.circulation_events"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.DashboardController.circulation_events">[docs]</a>    <span class="k">def</span> <span class="nf">circulation_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dict of circulation events for a given work.</span>

<span class="sd">        Optional &quot;num&quot; parameter in request to change number of results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="n">AdminAnnotator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="s2">&quot;100&quot;</span><span class="p">)),</span> <span class="mi">500</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CirculationEvent</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataSource</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">nullslast</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">CirculationEvent</span><span class="o">.</span><span class="n">start</span><span class="p">)))</span> \
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">events</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">annotator</span><span class="o">.</span><span class="n">permalink_for</span><span class="p">(</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">work</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">license_pool</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">({</span><span class="s2">&quot;circulation_events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">})</span></div>

<div class="viewcode-block" id="DashboardController.bulk_circulation_events"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.DashboardController.bulk_circulation_events">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_circulation_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytics_exporter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">date_format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">get_date</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="c1"># Return a date or datetime object representing the</span>
            <span class="c1"># _beginning_ of the asked-for day, local time.</span>
            <span class="c1">#</span>
            <span class="c1"># Unlike most places in this application we do not</span>
            <span class="c1"># use UTC since the sime was selected by a human user.</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">today</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># This won&#39;t happen in real life since the format is</span>
                <span class="c1"># controlled by the calendar widget. There&#39;s no need</span>
                <span class="c1"># to send an error message -- just use the default</span>
                <span class="c1"># date.</span>
                <span class="k">return</span> <span class="n">today</span>

        <span class="c1"># For the start date we should use the _beginning_ of the day,</span>
        <span class="c1"># which is what get_date returns.</span>
        <span class="n">date_start</span> <span class="o">=</span> <span class="n">get_date</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

        <span class="c1"># When running the search, the cutoff is the first moment of</span>
        <span class="c1"># the day _after_ the end date. When generating the filename,</span>
        <span class="c1"># though, we should use the date provided by the user.</span>
        <span class="n">date_end_label</span> <span class="o">=</span> <span class="n">get_date</span><span class="p">(</span><span class="s2">&quot;dateEnd&quot;</span><span class="p">)</span>
        <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_end_label</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">library</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">library_short_name</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span> <span class="k">if</span> <span class="n">library</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">analytics_exporter</span> <span class="o">=</span> <span class="n">analytics_exporter</span> <span class="ow">or</span> <span class="n">LocalAnalyticsExporter</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">analytics_exporter</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">library</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">date_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">),</span>
                <span class="n">date_end_label</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">),</span> <span class="n">library_short_name</span><span class="p">)</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>


<div class="viewcode-block" id="SettingsController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController">[docs]</a><span class="k">class</span> <span class="nc">SettingsController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>
    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="n">METADATA_SERVICE_URI_TYPE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;application/opds+json;profile=https://librarysimplified.org/rel/profile/metadata-service&#39;</span>
    <span class="p">)</span>

    <span class="n">NO_MIRROR_INTEGRATION</span> <span class="o">=</span> <span class="s2">&quot;NO_MIRROR&quot;</span>

    <span class="n">PROVIDER_APIS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">OPDSImporter</span><span class="p">,</span>
        <span class="n">OPDSForDistributorsAPI</span><span class="p">,</span>
        <span class="n">OPDS2Importer</span><span class="p">,</span>
        <span class="n">ProQuestOPDS2Importer</span><span class="p">,</span>
        <span class="n">OverdriveAPI</span><span class="p">,</span>
        <span class="n">OdiloAPI</span><span class="p">,</span>
        <span class="n">BibliothecaAPI</span><span class="p">,</span>
        <span class="n">Axis360API</span><span class="p">,</span>
        <span class="n">RBDigitalAPI</span><span class="p">,</span>
        <span class="n">EnkiAPI</span><span class="p">,</span>
        <span class="n">ODLAPI</span><span class="p">,</span>
        <span class="n">SharedODLAPI</span><span class="p">,</span>
        <span class="n">FeedbooksOPDSImporter</span><span class="p">,</span>
        <span class="n">LCPAPI</span>
    <span class="p">]</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>

<div class="viewcode-block" id="SettingsController.check_name_unique"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.check_name_unique">[docs]</a>    <span class="k">def</span> <span class="nf">check_name_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_service</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A service cannot be created with, or edited to have, the same name as a service that</span>
<span class="sd">        already exists. This method is used by analytics_services, cdn_services,</span>
<span class="sd">        discovery_services, metadata_services, and sitewide_services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing_service</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_service</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">existing_service</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_service</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c1"># Without checking that the IDs are different, you can&#39;t save</span>
            <span class="c1"># changes to an existing service unless you&#39;ve also changed its name.</span>
            <span class="k">return</span> <span class="n">INTEGRATION_NAME_ALREADY_IN_USE</span></div>

<div class="viewcode-block" id="SettingsController.check_url_unique"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.check_url_unique">[docs]</a>    <span class="k">def</span> <span class="nf">check_url_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_service</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforce a rule that a given circulation manager can only have one integration that</span>
<span class="sd">        uses a given URL for a certain purpose.</span>

<span class="sd">        Whether to enforce this rule for a given type of integration is up to you -- it&#39;s</span>
<span class="sd">        a good general rule but there are conceivable exceptions.</span>

<span class="sd">        This method is used by discovery_services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Look for the given URL as well as minor variations.</span>
        <span class="c1">#</span>
        <span class="c1"># We can&#39;t use urlparse to ignore minor differences in URLs</span>
        <span class="c1"># because we&#39;re doing the comparison in the database.</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_variants</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

        <span class="n">qu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">settings</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="c1"># Protocol must match.</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">protocol</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="c1"># Goal must match.</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">goal</span> <span class="o">==</span> <span class="n">goal</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="c1"># URL must be one of the URLs we&#39;re concerned about.</span>
            <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="c1"># But don&#39;t count the service we&#39;re trying to edit.</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">new_service</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">qu</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INTEGRATION_URL_ALREADY_IN_USE</span></div>

<div class="viewcode-block" id="SettingsController.look_up_service_by_id"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.look_up_service_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">look_up_service_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find an existing service, and make sure that the user is not trying to edit its protocol.</span>
<span class="sd">        This method is used by analytics_services, cdn_services, metadata_services,</span>
<span class="sd">        and sitewide_services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span>

        <span class="n">service</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">service</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_SERVICE</span>

        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">and</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">protocol</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CANNOT_CHANGE_PROTOCOL</span>

        <span class="k">return</span> <span class="n">service</span></div>

<div class="viewcode-block" id="SettingsController.set_protocols"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.set_protocols">[docs]</a>    <span class="k">def</span> <span class="nf">set_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">protocols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the protocol that the user has submitted; depending on whether the validations pass,</span>
<span class="sd">        either save it to this metadata service or return an error message. This method is used by</span>
<span class="sd">        analytics_services, cdn_services, discovery_services, metadata_services, and sitewide_services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span>

        <span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">protocol</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_integration_settings_and_libraries</span><span class="p">(</span>
            <span class="n">service</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SettingsController.validate_protocol"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.validate_protocol">[docs]</a>    <span class="k">def</span> <span class="nf">validate_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="n">protocols</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span>
        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">UNKNOWN_PROTOCOL</span></div>

<div class="viewcode-block" id="SettingsController.validate_formats"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.validate_formats">[docs]</a>    <span class="k">def</span> <span class="nf">validate_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If the service has self.protocols set, we can extract the list of settings here;</span>
        <span class="c1"># otherwise, the settings have to be passed in as an argument--either a list or</span>
        <span class="c1"># a string.</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">validator</span> <span class="ow">or</span> <span class="n">Validator</span><span class="p">()</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_settings</span><span class="p">()</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="k">def</span> <span class="nf">_get_integration_library_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="n">library_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_settings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
                <span class="p">)</span><span class="o">.</span><span class="n">json_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
                <span class="p">)</span><span class="o">.</span><span class="n">value</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">library_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">library_info</span>

    <span class="k">def</span> <span class="nf">_get_integration_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">protocols</span><span class="p">):</span>
        <span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">goal</span> <span class="o">==</span> <span class="n">goal</span><span class="p">):</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">service</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">protocol</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">libraries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sitewide&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_settings&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">service</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_integration_library_info</span><span class="p">(</span>
                        <span class="n">service</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">protocol</span><span class="p">))</span>

            <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

                <span class="c1"># If the setting is a covers or books mirror, we need to get the value from</span>
                <span class="c1"># ExternalIntegrationLink and not from a ConfigurationSetting.</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mirror_integration_id&#39;</span><span class="p">):</span>
                    <span class="n">storage_integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="p">,</span> <span class="n">external_integration_id</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">storage_integration</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">storage_integration</span><span class="o">.</span><span class="n">other_integration_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_MIRROR_INTEGRATION</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;menu&quot;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_externalintegration</span><span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span><span class="o">.</span><span class="n">json_value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_externalintegration</span><span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

                <span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">service_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span> <span class="n">libraries</span><span class="o">=</span><span class="n">libraries</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;test_search_term&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">)]:</span>
                <span class="n">service_info</span><span class="p">[</span><span class="s2">&quot;self_test_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prior_test_results</span><span class="p">(</span>
                    <span class="n">service</span><span class="p">)</span>

            <span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">services</span>

    <span class="k">def</span> <span class="nf">_set_integration_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="n">setting_key</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="n">setting_type</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span>
                <span class="n">setting_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s1">&#39;menu&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_menu_values</span><span class="p">(</span><span class="n">setting_key</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">setting_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">):</span>
            <span class="c1"># This setting can only take on values that are in its list of options.</span>
            <span class="n">allowed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">)]</span>
            <span class="n">submitted_values</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">submitted_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">submitted_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">submitted_values</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">submitted_value</span> <span class="ow">in</span> <span class="n">submitted_values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">submitted_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">INVALID_CONFIGURATION_OPTION</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span>
                        <span class="s2">&quot;The configuration value for </span><span class="si">%(setting)s</span><span class="s2"> is invalid.&quot;</span><span class="p">,</span>
                        <span class="n">setting</span><span class="o">=</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span>
                    <span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">INCOMPLETE_CONFIGURATION</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;The configuration is missing a required setting: </span><span class="si">%(setting)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">setting</span><span class="o">=</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">setting_key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_set_integration_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">library_info</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Library</span><span class="p">,</span>
                          <span class="n">short_name</span><span class="o">=</span><span class="n">library_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;short_name&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;You attempted to add the integration to </span><span class="si">%(library_short_name)s</span><span class="s2">, but it does not exist.&quot;</span>
            <span class="k">return</span> <span class="n">NO_SUCH_LIBRARY</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="n">library_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;short_name&quot;</span><span class="p">)))</span>

        <span class="n">integration</span><span class="o">.</span><span class="n">libraries</span> <span class="o">+=</span> <span class="p">[</span><span class="n">library</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_settings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">library_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="n">INVALID_CONFIGURATION_OPTION</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span>
                    <span class="s2">&quot;The configuration value for </span><span class="si">%(setting)s</span><span class="s2"> is invalid.&quot;</span><span class="p">,</span>
                    <span class="n">setting</span><span class="o">=</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span>
                <span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">INCOMPLETE_CONFIGURATION</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                    <span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;The configuration is missing a required setting: </span><span class="si">%(setting)s</span><span class="s2"> for library </span><span class="si">%(library)s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">setting</span><span class="o">=</span><span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span>
                        <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,))</span>

            <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_set_integration_settings_and_libraries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">setting</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mirror_integration_id&#39;</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_integration_setting</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sitewide&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_settings&quot;</span><span class="p">):</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">libraries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">libraries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;libraries&quot;</span><span class="p">):</span>
                <span class="n">libraries</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;libraries&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">library_info</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_integration_library</span><span class="p">(</span>
                    <span class="n">integration</span><span class="p">,</span> <span class="n">library_info</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_delete_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration_id</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">require_system_admin</span><span class="p">()</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span>
                              <span class="nb">id</span><span class="o">=</span><span class="n">integration_id</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_SERVICE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Deleted&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_collection_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_apis</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_integration_protocols</span><span class="p">(</span>
            <span class="n">provider_apis</span><span class="p">,</span> <span class="n">protocol_name_attr</span><span class="o">=</span><span class="s2">&quot;NAME&quot;</span><span class="p">)</span>
        <span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">MANUAL</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">lgt</span><span class="p">(</span><span class="s1">&#39;Manual import&#39;</span><span class="p">),</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">lgt</span><span class="p">(</span><span class="s1">&#39;Books will be manually added to the circulation manager, &#39;</span>
                                   <span class="s1">&#39;not imported automatically through a protocol.&#39;</span><span class="p">),</span>
                <span class="s1">&#39;settings&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">protocols</span>

    <span class="k">def</span> <span class="nf">_get_prior_test_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">protocol_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_args</span><span class="p">):</span>
        <span class="c1"># :param item: An ExternalSearchIndex, an ExternalIntegration for patron authentication, or a Collection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol_class</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protocol_class&quot;</span><span class="p">):</span>
            <span class="n">protocol_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_class</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">self_test_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;collection&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">protocol</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="n">provider_apis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROVIDER_APIS</span><span class="p">)</span>
                <span class="n">provider_apis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPDSImportMonitor</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">OPDSImportMonitor</span><span class="o">.</span><span class="n">PROTOCOL</span><span class="p">:</span>
                    <span class="n">protocol_class</span> <span class="o">=</span> <span class="n">OPDSImportMonitor</span>

                <span class="k">if</span> <span class="n">protocol_class</span> <span class="ow">in</span> <span class="n">provider_apis</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">protocol_class</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">OPDSImportMonitor</span><span class="o">.</span><span class="n">PROTOCOL</span><span class="p">):</span>
                        <span class="n">extra_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">OPDSImporter</span><span class="p">,)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">extra_args</span> <span class="o">=</span> <span class="p">()</span>

                    <span class="n">self_test_results</span> <span class="o">=</span> <span class="n">protocol_class</span><span class="o">.</span><span class="n">prior_test_results</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">protocol_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_args</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;search service&quot;</span><span class="p">:</span>
                <span class="n">self_test_results</span> <span class="o">=</span> <span class="n">ExternalSearchIndex</span><span class="o">.</span><span class="n">prior_test_results</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">item</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;metadata service&quot;</span> <span class="ow">and</span> <span class="n">protocol_class</span><span class="p">:</span>
                <span class="n">self_test_results</span> <span class="o">=</span> <span class="n">protocol_class</span><span class="o">.</span><span class="n">prior_test_results</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_args</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;patron authentication service&quot;</span><span class="p">:</span>
                <span class="n">library</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">libraries</span><span class="p">):</span>
                    <span class="n">library</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">libraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">self_test_results</span> <span class="o">=</span> <span class="n">protocol_class</span><span class="o">.</span><span class="n">prior_test_results</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">item</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;You must associate this service with at least one library &quot;</span>
                        <span class="s2">&quot;before you can run self tests for it.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">self_test_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="n">lgt</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This is bad, but not so bad that we should short-circuit</span>
            <span class="c1"># this whole process -- that might prevent an admin from</span>
            <span class="c1"># making the configuration changes necessary to fix</span>
            <span class="c1"># this problem.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">lgt</span><span class="p">(</span><span class="s2">&quot;Exception getting self-test results for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>
            <span class="n">self_test_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="n">message</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">self_test_results</span>

    <span class="k">def</span> <span class="nf">_mirror_integration_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a setting interface for selecting a storage integration to</span>
<span class="sd">        be used when mirroring items from a collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">integrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ExternalIntegration</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">goal</span> <span class="o">==</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">STORAGE_GOAL</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">integrations</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">mirror_integration_settings</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
            <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COLLECTION_MIRROR_SETTINGS</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">integration</span> <span class="ow">in</span> <span class="n">integrations</span><span class="p">:</span>
            <span class="n">book_covers_bucket</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="n">S3UploaderConfiguration</span><span class="o">.</span><span class="n">BOOK_COVERS_BUCKET_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">open_access_bucket</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="n">S3UploaderConfiguration</span><span class="o">.</span><span class="n">OA_CONTENT_BUCKET_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">protected_access_bucket</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
                <span class="n">S3UploaderConfiguration</span><span class="o">.</span><span class="n">PROTECTED_CONTENT_BUCKET_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">mirror_integration_settings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS_KEY</span> <span class="ow">and</span> <span class="n">book_covers_bucket</span><span class="p">:</span>
                    <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">integration</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">OPEN_ACCESS_BOOKS_KEY</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">open_access_bucket</span><span class="p">:</span>
                        <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">integration</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">PROTECTED_ACCESS_BOOKS_KEY</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">protected_access_bucket</span><span class="p">:</span>
                        <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">integration</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">mirror_integration_settings</span>

    <span class="k">def</span> <span class="nf">_create_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol_definitions</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new ExternalIntegration for the given protocol and goal, assuming that doing</span>
<span class="sd">        so is compatible with the protocol&#39;s definition.</span>

<span class="sd">        :return: A 2-tuple (result, is_new). `result` will be an ExternalIntegration if one</span>
<span class="sd">            could be created, and a ProblemDetail otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_PROTOCOL_FOR_NEW_SERVICE</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protocol_definitions</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">protocol</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNKNOWN_PROTOCOL</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Most of the time there can be multiple ExternalIntegrations with the same protocol and goal...</span>
        <span class="n">allow_multiple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">create</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="n">goal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cardinality&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># ...but not all the time.</span>
            <span class="n">allow_multiple</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We were asked to create a new ExternalIntegration but there&#39;s already one for</span>
                <span class="c1"># this protocol, which is not allowed.</span>
                <span class="k">return</span> <span class="n">DUPLICATE_INTEGRATION</span><span class="p">,</span> <span class="kc">False</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">get_one_or_create</span>

        <span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="n">is_new</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_multiple</span><span class="p">:</span>
            <span class="c1"># This can happen, despite our check above, in a race condition where two clients</span>
            <span class="c1"># try simultaneously to create two integrations of the same type.</span>
            <span class="k">return</span> <span class="n">DUPLICATE_INTEGRATION</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">integration</span><span class="p">,</span> <span class="n">is_new</span>

    <span class="k">def</span> <span class="nf">_get_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;protocols&#39;</span><span class="p">):</span>
            <span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>
<div class="viewcode-block" id="SettingsController.url_variants"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SettingsController.url_variants">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">url_variants</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">check_protocol_variant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate minor variants of a URL -- HTTP vs HTTPS, trailing slash vs not, etc.</span>

<span class="sd">        Technically these are all distinct URLs, but in real life they generally mean someone</span>
<span class="sd">        typed the same URL slightly differently. Since this isn&#39;t an exact science, this doesn&#39;t</span>
<span class="sd">        need to catch all variant URLs, only the most common ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Validator</span><span class="p">()</span><span class="o">.</span><span class="n">_is_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">[]):</span>    <span class="c1"># An invalid URL has no variants.</span>
            <span class="k">return</span>

        <span class="c1"># A URL is a &#39;variant&#39; of itself.</span>
        <span class="k">yield</span> <span class="n">url</span>

        <span class="c1"># Adding or removing a slash creates a variant.</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

        <span class="c1"># Changing protocols may create one or more variants.</span>
        <span class="n">https</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span>
        <span class="n">http</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span>

        <span class="k">if</span> <span class="n">check_protocol_variant</span><span class="p">:</span>
            <span class="n">protocol_variant</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">https</span><span class="p">):</span>
                <span class="n">protocol_variant</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">https</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">http</span><span class="p">):</span>
                <span class="n">protocol_variant</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">http</span><span class="p">,</span> <span class="n">https</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">protocol_variant</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">url_variants</span><span class="p">(</span><span class="n">protocol_variant</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">v</span></div>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_integration_protocols</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">provider_apis</span><span class="p">,</span> <span class="n">protocol_name_attr</span><span class="o">=</span><span class="s2">&quot;__module__&quot;</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">provider_apis</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">protocol_name_attr</span><span class="p">)</span>
            <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="n">label</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

            <span class="n">description</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;DESCRIPTION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

            <span class="n">instructions</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;INSTRUCTIONS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instructions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;instructions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instructions</span>

            <span class="n">sitewide</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SITEWIDE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sitewide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;sitewide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sitewide</span>

            <span class="n">settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SETTINGS&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

            <span class="n">child_settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;CHILD_SETTINGS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;child_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">child_settings</span><span class="p">)</span>

            <span class="n">library_settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;LIBRARY_SETTINGS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">library_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;library_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">library_settings</span><span class="p">)</span>

            <span class="n">cardinality</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s1">&#39;CARDINALITY&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cardinality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s1">&#39;cardinality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cardinality</span>

            <span class="n">supports_registration</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SUPPORTS_REGISTRATION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">supports_registration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s1">&#39;supports_registration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supports_registration</span>
            <span class="n">supports_staging</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SUPPORTS_STAGING&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">supports_staging</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">protocol</span><span class="p">[</span><span class="s1">&#39;supports_staging&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supports_staging</span>

            <span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">protocols</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_menu_values</span><span class="p">(</span><span class="n">setting_key</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;circulation-web returns &quot;menu&quot; values in a different format not compatible with werkzeug.MultiDict semantics:</span>
<span class="sd">            {setting_key}_{menu} = {value_in_the_dropdown_box}</span>
<span class="sd">            {setting_key}_{setting_value1} = {setting_label1}</span>
<span class="sd">            {setting_key}_{setting_value2} = {setting_label2}</span>
<span class="sd">            ...</span>
<span class="sd">            {setting_key}_{setting_valueN} = {setting_labelN}</span>

<span class="sd">        It means we can&#39;t use werkzeug.MultiDict.getlist method and have to extract them manually.</span>

<span class="sd">        :param setting_key: Setting&#39;s key</span>
<span class="sd">        :type setting_key: str</span>

<span class="sd">        :param form: Multi-dictionary containing input values submitted by the user</span>
<span class="sd">            and sent back to CM by circulation-web</span>
<span class="sd">        :type form: werkzeug.MultiDict</span>

<span class="sd">        :return: List of &quot;menu&quot; values</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">form_item_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">setting_key</span> <span class="ow">in</span> <span class="n">form_item_key</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">form_item_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">setting_key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;menu&#39;</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="SitewideRegistrationController"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController">[docs]</a><span class="k">class</span> <span class="nc">SitewideRegistrationController</span><span class="p">(</span><span class="n">SettingsController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A controller for managing a circulation manager&#39;s registrations with external services.</span>

<span class="sd">    Currently the only supported site-wide registration is with a metadata wrangler.</span>
<span class="sd">    The protocol for registration with library registries and ODL collections is similar,</span>
<span class="sd">    but those registrations happen on the level of the individual library, not on the level</span>
<span class="sd">    of the circulation manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">##### Class Constants ####################################################  # noqa: E266</span>

    <span class="c1">##### Public Interface / Magic Methods ###################################  # noqa: E266</span>

<div class="viewcode-block" id="SitewideRegistrationController.process_sitewide_registration"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.process_sitewide_registration">[docs]</a>    <span class="k">def</span> <span class="nf">process_sitewide_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">HTTP</span><span class="o">.</span><span class="n">debuggable_get</span><span class="p">,</span> <span class="n">do_post</span><span class="o">=</span><span class="n">HTTP</span><span class="o">.</span><span class="n">debuggable_post</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a sitewide registration for a particular service.</span>

<span class="sd">        :return: A ProblemDetail or, if successful, None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">require_system_admin</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">integration</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MISSING_SERVICE</span>

        <span class="n">catalog_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_catalog</span><span class="p">(</span><span class="n">do_get</span><span class="p">,</span> <span class="n">integration</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">catalog_response</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">catalog_response</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_content_type</span><span class="p">(</span><span class="n">catalog_response</span><span class="p">),</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_content_type</span><span class="p">(</span><span class="n">catalog_response</span><span class="p">)</span>

        <span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">register_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_registration_link</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">register_url</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">register_url</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_headers</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">headers</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">register_url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">do_post</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="n">shared_secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_secret</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">shared_secret</span>

        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">sitewide_key_pair</span>
        <span class="n">decryptor</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">cipher</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="n">shared_secret</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">))</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">shared_secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.get_catalog"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.get_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_get</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the catalog for this service.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">do_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.check_content_type"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.check_content_type">[docs]</a>    <span class="k">def</span> <span class="nf">check_content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure the catalog for the service is in a valid format.&quot;&quot;&quot;</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">catalog_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">!=</span> <span class="s1">&#39;application/opds+json&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s1">&#39;The service did not provide a valid catalog.&#39;</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.get_registration_link"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.get_registration_link">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the link for registration from the catalog.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_register_link_filter</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rel&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;register&#39;</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">METADATA_SERVICE_URI_TYPE</span><span class="p">)</span>

        <span class="n">register_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">_register_link_filter</span><span class="p">,</span> <span class="n">links</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">register_urls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s1">&#39;The service did not provide a register link.&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Get the full registration url.</span>
        <span class="n">register_url</span> <span class="o">=</span> <span class="n">register_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">register_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
            <span class="c1"># We have a relative path. Create a full registration url.</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">register_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">register_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">register_url</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.update_headers"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.update_headers">[docs]</a>    <span class="k">def</span> <span class="nf">update_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the integration has an existing shared_secret, use it to access the</span>
<span class="sd">        server and update it.&quot;&quot;&quot;</span>

        <span class="c1"># NOTE: This is no longer technically necessary since we prove</span>
        <span class="c1"># ownership with a signed JWT.</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">integration</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">integration</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">token</span>
        <span class="k">return</span> <span class="n">headers</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.register"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">register_url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">do_post</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this server using the sitewide registration document.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sitewide_registration_document</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span>
                <span class="n">register_url</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2xx&#39;</span><span class="p">],</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.get_shared_secret"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.get_shared_secret">[docs]</a>    <span class="k">def</span> <span class="nf">get_shared_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the shared secret which we need to use in order to register this</span>
<span class="sd">        service, or return an error message if there is no shared secret.&quot;&quot;&quot;</span>

        <span class="n">registration_info</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">shared_secret</span> <span class="o">=</span> <span class="n">registration_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared_secret&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_secret</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">lgt</span><span class="p">(</span><span class="s1">&#39;The service did not provide registration information.&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">shared_secret</span></div>

<div class="viewcode-block" id="SitewideRegistrationController.sitewide_registration_document"><a class="viewcode-back" href="../../../api.admin.controller.html#api.admin.controller.SitewideRegistrationController.sitewide_registration_document">[docs]</a>    <span class="k">def</span> <span class="nf">sitewide_registration_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the document to be sent as part of a sitewide registration</span>
<span class="sd">        request.</span>

<span class="sd">        :return: A dictionary with keys &#39;url&#39; and &#39;jwt&#39;. &#39;url&#39; is the URL to</span>
<span class="sd">            this site&#39;s public key document, and &#39;jwt&#39; is a JSON Web Token</span>
<span class="sd">            proving control over that URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">public_key</span><span class="p">,</span> <span class="n">private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">sitewide_key_pair</span>
        <span class="c1"># Advertise the public key so that the foreign site can encrypt things for us.</span>
        <span class="n">public_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;RSA&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">public_key</span><span class="p">)</span>    <span class="c1"># noqa: F841</span>
        <span class="n">public_key_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;public_key_document&#39;</span><span class="p">)</span>
        <span class="n">in_one_minute</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">in_one_minute</span><span class="p">}</span>
        <span class="c1"># Sign a JWT with the private key to prove ownership of the site.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;RS256&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">public_key_url</span><span class="p">,</span> <span class="n">jwt</span><span class="o">=</span><span class="n">token</span><span class="p">)</span></div></div>

    <span class="c1">##### Private Methods ####################################################  # noqa: E266</span>

    <span class="c1">##### Properties and Getters/Setters #####################################  # noqa: E266</span>

    <span class="c1">##### Class Methods ######################################################  # noqa: E266</span>

    <span class="c1">##### Private Class Methods ##############################################  # noqa: E266</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>