
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.admin.controller.work_editor &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.admin.controller.work_editor</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">AdminCirculationManagerController</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">core.opds</span> <span class="kn">import</span> <span class="n">AcquisitionFeed</span>
<span class="kn">from</span> <span class="nn">api.admin.opds</span> <span class="kn">import</span> <span class="n">AdminAnnotator</span><span class="p">,</span> <span class="n">AdminFeed</span>
<span class="kn">from</span> <span class="nn">api.admin.problem_details</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">api.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">CannotLoadConfiguration</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">api.metadata_wrangler</span> <span class="kn">import</span> <span class="n">MetadataWranglerCollectionRegistrar</span>
<span class="kn">from</span> <span class="nn">api.admin.validator</span> <span class="kn">import</span> <span class="n">Validator</span>
<span class="kn">from</span> <span class="nn">core.app_server</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_pagination_from_request</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.classifier</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">genres</span><span class="p">,</span>
    <span class="n">SimplifiedGenreClassifier</span><span class="p">,</span>
    <span class="n">NO_NUMBER</span><span class="p">,</span>
    <span class="n">NO_VALUE</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.mirror</span> <span class="kn">import</span> <span class="n">MirrorUploader</span>
<span class="kn">from</span> <span class="nn">core.util.problem_detail</span> <span class="kn">import</span> <span class="n">ProblemDetail</span>
<span class="kn">from</span> <span class="nn">core.util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Metadata</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Lane</span><span class="p">,</span> <span class="n">WorkList</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Complaint</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">Genre</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Measurement</span><span class="p">,</span>
    <span class="n">PresentationCalculationPolicy</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Work</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model.configuration</span> <span class="kn">import</span> <span class="n">ExternalIntegrationLink</span>
<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">strptime_utc</span><span class="p">,</span>
    <span class="n">utc_now</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>


<div class="viewcode-block" id="WorkController"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController">[docs]</a><span class="k">class</span> <span class="nc">WorkController</span><span class="p">(</span><span class="n">AdminCirculationManagerController</span><span class="p">):</span>

    <span class="n">STAFF_WEIGHT</span> <span class="o">=</span> <span class="mi">1000</span>

<div class="viewcode-block" id="WorkController.details"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.details">[docs]</a>    <span class="k">def</span> <span class="nf">details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an OPDS entry with detailed information for admins.</span>

<span class="sd">        This includes relevant links for editing the book.</span>

<span class="sd">        :return: An OPDSEntryResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="n">AdminAnnotator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># single_entry returns an OPDSEntryResponse that will not be</span>
        <span class="c1"># cached, which is perfect. We want the admin interface</span>
        <span class="c1"># to update immediately when an admin makes a change.</span>
        <span class="k">return</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">single_entry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.complaints"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.complaints">[docs]</a>    <span class="k">def</span> <span class="nf">complaints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return detailed complaint information for admins.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_complaints_for_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span>
            <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;identifier_type&quot;</span><span class="p">:</span> <span class="n">identifier_type</span><span class="p">,</span>
                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">identifier</span>
            <span class="p">},</span>
            <span class="s2">&quot;complaints&quot;</span><span class="p">:</span> <span class="n">counter</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="WorkController.roles"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.roles">[docs]</a>    <span class="k">def</span> <span class="nf">roles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a mapping from MARC codes to contributor roles.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: The admin interface only allows a subset of the roles</span>
        <span class="c1"># listed in model.py since it uses the OPDS representation of</span>
        <span class="c1"># the data, and some of the roles map to the same MARC code.</span>
        <span class="n">CODES</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">MARC_ROLE_CODES</span>
        <span class="n">marc_to_role</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ACTOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ADAPTER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">AFTERWORD_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ARTIST_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ASSOCIATED_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">COMPILER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">COMPOSER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">CONTRIBUTOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">COPYRIGHT_HOLDER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">DESIGNER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">DIRECTOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">EDITOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ENGINEER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">FOREWORD_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">ILLUSTRATOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">INTRODUCTION_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">LYRICIST_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">MUSICIAN_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">NARRATOR_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">PERFORMER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">PHOTOGRAPHER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">PRODUCER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">TRANSCRIBER_ROLE</span><span class="p">,</span>
            <span class="n">Contributor</span><span class="o">.</span><span class="n">TRANSLATOR_ROLE</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">marc_to_role</span><span class="p">[</span><span class="n">CODES</span><span class="p">[</span><span class="n">role</span><span class="p">]]</span> <span class="o">=</span> <span class="n">role</span>
        <span class="k">return</span> <span class="n">marc_to_role</span></div>

<div class="viewcode-block" id="WorkController.languages"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.languages">[docs]</a>    <span class="k">def</span> <span class="nf">languages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the supported language codes and their English names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">english_names</span></div>

<div class="viewcode-block" id="WorkController.media"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.media">[docs]</a>    <span class="k">def</span> <span class="nf">media</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the supported media types for a work and their schema.org values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Edition</span><span class="o">.</span><span class="n">additional_type_to_medium</span></div>

<div class="viewcode-block" id="WorkController.rights_status"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.rights_status">[docs]</a>    <span class="k">def</span> <span class="nf">rights_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the supported rights status values with their names and whether they are open access.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">uri</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                          <span class="n">open_access</span><span class="o">=</span><span class="p">(</span><span class="n">uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">OPEN_ACCESS</span><span class="p">),</span>
                          <span class="n">allows_derivatives</span><span class="o">=</span><span class="p">(</span><span class="n">uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">ALLOWS_DERIVATIVES</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">uri</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">RightsStatus</span><span class="o">.</span><span class="n">NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span></div>

<div class="viewcode-block" id="WorkController.edit"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.edit">[docs]</a>    <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Edit a work&#39;s metadata.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># TODO: It would be nice to use the metadata layer for this, but</span>
        <span class="c1"># this code handles empty values differently than other metadata</span>
        <span class="c1"># sources. When a staff member deletes a value, that indicates</span>
        <span class="c1"># they think it should be empty. This needs to be indicated in the</span>
        <span class="c1"># db so that it can overrule other data sources that set a value,</span>
        <span class="c1"># unlike other sources which set empty fields to None.</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">staff_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="n">staff_edition</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Edition</span><span class="p">,</span>
            <span class="n">primary_identifier_id</span><span class="o">=</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">data_source_id</span><span class="o">=</span><span class="n">staff_data_source</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">primary_identifier</span><span class="p">)</span>

        <span class="n">new_title</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_title</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">title</span> <span class="o">!=</span> <span class="n">new_title</span><span class="p">:</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_title</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_subtitle</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subtitle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">!=</span> <span class="n">new_subtitle</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">subtitle</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_subtitle</span><span class="p">:</span>
                <span class="n">new_subtitle</span> <span class="o">=</span> <span class="n">NO_VALUE</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_subtitle</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The form data includes roles and names for contributors in the same order.</span>
        <span class="n">new_contributor_roles</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;contributor-role&quot;</span><span class="p">)</span>
        <span class="n">new_contributor_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;contributor-name&quot;</span><span class="p">)]</span>
        <span class="c1"># The first author in the form is considered the primary author, even</span>
        <span class="c1"># though there&#39;s no separate MARC code for that.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">role</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_contributor_roles</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">:</span>
                <span class="n">new_contributor_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">PRIMARY_AUTHOR_ROLE</span>
                <span class="k">break</span>
        <span class="n">roles_and_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">new_contributor_roles</span><span class="p">,</span> <span class="n">new_contributor_names</span><span class="p">))</span>

        <span class="c1"># Remove any contributions that weren&#39;t in the form, and remove contributions</span>
        <span class="c1"># that already exist from the list so they won&#39;t be added again.</span>
        <span class="n">deleted_contributions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">contributions</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roles_and_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>
                <span class="n">deleted_contributions</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roles_and_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">contribution</span><span class="o">.</span><span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">deleted_contributions</span><span class="p">:</span>
            <span class="c1"># Ensure the staff edition&#39;s contributions are up-to-date when</span>
            <span class="c1"># calculating the presentation edition later.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">staff_edition</span><span class="p">)</span>

        <span class="c1"># Any remaining roles and names are new contributions.</span>
        <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">roles_and_names</span><span class="p">:</span>
            <span class="c1"># There may be one extra role at the end from the input for</span>
            <span class="c1"># adding a contributor, in which case it will have no</span>
            <span class="c1"># corresponding name and can be ignored.</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Contributor</span><span class="o">.</span><span class="n">MARC_ROLE_CODES</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">UNKNOWN_ROLE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Role </span><span class="si">%(role)s</span><span class="s2"> is not one of the known contributor roles.&quot;</span><span class="p">,</span>
                          <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">))</span>
                <span class="n">contributor</span> <span class="o">=</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">add_contributor</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">role</span><span class="p">])</span>
                <span class="n">contributor</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_series</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">series</span> <span class="o">!=</span> <span class="n">new_series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">series</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_series</span><span class="p">:</span>
                <span class="n">new_series</span> <span class="o">=</span> <span class="n">NO_VALUE</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_series</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_series_position</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;series_position&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_series_position</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_series_position</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_series_position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_series_position</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">INVALID_SERIES_POSITION</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_series_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">series_position</span> <span class="o">!=</span> <span class="n">new_series_position</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">series_position</span> <span class="ow">and</span> <span class="n">new_series_position</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_series_position</span> <span class="o">=</span> <span class="n">NO_NUMBER</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">series_position</span> <span class="o">=</span> <span class="n">new_series_position</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_medium</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_medium</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_medium</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Edition</span><span class="o">.</span><span class="n">medium_to_additional_type</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">UNKNOWN_MEDIUM</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Medium </span><span class="si">%(medium)s</span><span class="s2"> is not one of the known media.&quot;</span><span class="p">,</span>
                      <span class="n">medium</span><span class="o">=</span><span class="n">new_medium</span><span class="p">))</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">new_medium</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_language</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_language</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_language</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">new_language</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">string_to_alpha_3</span><span class="p">(</span><span class="n">new_language</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_language</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">UNKNOWN_LANGUAGE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_language</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">new_language</span> <span class="o">!=</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">new_language</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_publisher</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_publisher</span> <span class="o">!=</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">publisher</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_publisher</span><span class="p">:</span>
                <span class="n">new_publisher</span> <span class="o">=</span> <span class="n">NO_VALUE</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_publisher</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_imprint</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imprint&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_imprint</span> <span class="o">!=</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">imprint</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">imprint</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_imprint</span><span class="p">:</span>
                <span class="n">new_imprint</span> <span class="o">=</span> <span class="n">NO_VALUE</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">imprint</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_imprint</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_issued</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issued&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_issued</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_issued</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_issued</span> <span class="o">=</span> <span class="n">strptime_utc</span><span class="p">(</span><span class="n">new_issued</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">INVALID_DATE_FORMAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_issued</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">new_issued</span> <span class="o">!=</span> <span class="n">staff_edition</span><span class="o">.</span><span class="n">issued</span><span class="p">:</span>
            <span class="n">staff_edition</span><span class="o">.</span><span class="n">issued</span> <span class="o">=</span> <span class="n">new_issued</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO: This lets library staff add a 1-5 rating, which is used in the</span>
        <span class="c1"># quality calculation. However, this doesn&#39;t work well if there are any</span>
        <span class="c1"># other measurements that contribute to the quality. The form will show</span>
        <span class="c1"># the calculated quality rather than the staff rating, which will be</span>
        <span class="c1"># confusing. It might also be useful to make it more clear how this</span>
        <span class="c1"># relates to the quality threshold in the library settings.</span>
        <span class="n">changed_rating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_rating</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_rating</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_rating</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_rating</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_rating</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">INVALID_RATING</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">RATING_SCALES</span><span class="p">[</span><span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_rating</span> <span class="o">&lt;</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">new_rating</span> <span class="o">&gt;</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">INVALID_RATING</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The rating must be a number between </span><span class="si">%(low)s</span><span class="s2"> and </span><span class="si">%(high)s</span><span class="s2">.&quot;</span><span class="p">,</span>
                      <span class="n">low</span><span class="o">=</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span><span class="o">=</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">new_rating</span> <span class="o">-</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">work</span><span class="o">.</span><span class="n">quality</span><span class="p">:</span>
                <span class="n">primary_identifier</span><span class="o">.</span><span class="n">add_measurement</span><span class="p">(</span>
                    <span class="n">staff_data_source</span><span class="p">,</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">RATING</span><span class="p">,</span> <span class="n">new_rating</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span><span class="p">)</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">changed_rating</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">changed_summary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_summary</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_summary</span> <span class="o">!=</span> <span class="n">work</span><span class="o">.</span><span class="n">summary_text</span><span class="p">:</span>
            <span class="n">old_summary</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">staff_data_source</span><span class="p">:</span>
                <span class="n">old_summary</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">summary</span>

            <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">staff_data_source</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">new_summary</span><span class="p">)</span>

            <span class="c1"># Delete previous staff summary</span>
            <span class="k">if</span> <span class="n">old_summary</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">old_summary</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">old_summary</span><span class="p">)</span>

            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">changed_summary</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="c1"># Even if the presentation doesn&#39;t visibly change, we want</span>
            <span class="c1"># to regenerate the OPDS entries and update the search</span>
            <span class="c1"># index for the work, because that might be the &#39;real&#39;</span>
            <span class="c1"># problem the user is trying to fix.</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
                <span class="n">classify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">update_search_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">calculate_quality</span><span class="o">=</span><span class="n">changed_rating</span><span class="p">,</span>
                <span class="n">choose_summary</span><span class="o">=</span><span class="n">changed_summary</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.suppress"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.suppress">[docs]</a>    <span class="k">def</span> <span class="nf">suppress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suppress the license pool associated with a book.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># Turn source + identifier into a LicensePool</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_licensepools</span><span class="p">(</span>
            <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pools</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="c1"># Something went wrong.</span>
            <span class="k">return</span> <span class="n">pools</span>

        <span class="c1"># Assume that the Work is being suppressed from the catalog, and</span>
        <span class="c1"># not just the LicensePool.</span>
        <span class="c1"># TODO: Suppress individual LicensePools when it&#39;s not that deep.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">suppressed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.unsuppress"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.unsuppress">[docs]</a>    <span class="k">def</span> <span class="nf">unsuppress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unsuppress all license pools associated with a book.</span>

<span class="sd">        TODO: This will need to be revisited when we distinguish</span>
<span class="sd">        between complaints about a work and complaints about a</span>
<span class="sd">        LicensePoool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># Turn source + identifier into a group of LicensePools</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_licensepools</span><span class="p">(</span>
            <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pools</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="c1"># Something went wrong.</span>
            <span class="k">return</span> <span class="n">pools</span>

        <span class="c1"># Unsuppress each pool.</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">suppressed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.refresh_metadata"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.refresh_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refresh the metadata for a book from the content server&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">provider</span> <span class="o">=</span> <span class="n">MetadataWranglerCollectionRegistrar</span><span class="p">(</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">license_pools</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CannotLoadConfiguration</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">METADATA_REFRESH_FAILURE</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">ensure_coverage</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># The coverage provider may raise an HTTPIntegrationException.</span>
            <span class="k">return</span> <span class="n">REMOTE_INTEGRATION_FAILED</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
            <span class="c1"># There was a coverage failure.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;201&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;202&quot;</span><span class="p">)):</span>
                <span class="c1"># A 201/202 error means it&#39;s never looked up this work before</span>
                <span class="c1"># so it&#39;s started the resolution process or looking for sources.</span>
                <span class="k">return</span> <span class="n">METADATA_REFRESH_PENDING</span>
            <span class="c1"># Otherwise, it just doesn&#39;t know anything.</span>
            <span class="k">return</span> <span class="n">METADATA_REFRESH_FAILURE</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.resolve_complaints"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.resolve_complaints">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_complaints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve all complaints for a particular license pool and complaint type.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">resolved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">requested_type</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requested_type</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">complaint</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">complaints</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">complaint</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">requested_type</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">complaint</span><span class="o">.</span><span class="n">resolved</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">complaint</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                        <span class="n">resolved</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNRECOGNIZED_COMPLAINT</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">resolved</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">COMPLAINT_ALREADY_RESOLVED</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.classifications"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.classifications">[docs]</a>    <span class="k">def</span> <span class="nf">classifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of this work&#39;s classifications.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier_type (string): Type of identifier e.g ISBN</span>
<span class="sd">            identifier (string): Identifier for a work</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dict of work with list of classifications for the work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">identifier_id</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">id</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> \
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classification</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Subject</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataSource</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">identifier_id</span> <span class="o">==</span> <span class="n">identifier_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Classification</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span> \
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">weight</span>
            <span class="p">}))</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">({</span>
            <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;identifier_type&quot;</span><span class="p">:</span> <span class="n">identifier_type</span><span class="p">,</span>
                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">identifier</span>
            <span class="p">},</span>
            <span class="s2">&quot;classifications&quot;</span><span class="p">:</span> <span class="n">data</span>
        <span class="p">})</span></div>

<div class="viewcode-block" id="WorkController.edit_classifications"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.edit_classifications">[docs]</a>    <span class="k">def</span> <span class="nf">edit_classifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Edit a work&#39;s audience, target age, fiction status, and genres.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">staff_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>

        <span class="c1"># Previous staff classifications</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span>
        <span class="n">old_classifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> \
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classification</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Subject</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Classification</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">primary_identifier</span><span class="p">,</span>
                <span class="n">Classification</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">staff_data_source</span>
            <span class="p">)</span>
        <span class="n">old_genre_classifications</span> <span class="o">=</span> <span class="n">old_classifications</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">genre_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">old_staff_genres</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_genre_classifications</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">genre</span>
        <span class="p">]</span>
        <span class="n">old_computed_genres</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">work_genre</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">work_genre</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">work_genres</span>
        <span class="p">]</span>

        <span class="c1"># New genres should be compared to previously computed genres</span>
        <span class="n">new_genres</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;genres&quot;</span><span class="p">)</span>
        <span class="n">genres_changed</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_genres</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">old_computed_genres</span><span class="p">)</span>

        <span class="c1"># Update audience</span>
        <span class="n">new_audience</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audience&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_audience</span> <span class="o">!=</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span><span class="p">:</span>
            <span class="c1"># Delete all previous staff audience classifications</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_classifications</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">FREEFORM_AUDIENCE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Create a new classification with a high weight</span>
            <span class="n">primary_identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span>
                <span class="n">subject_type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">FREEFORM_AUDIENCE</span><span class="p">,</span>
                <span class="n">subject_identifier</span><span class="o">=</span><span class="n">new_audience</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Update target age if present</span>
        <span class="n">new_target_age_min</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_age_min&quot;</span><span class="p">)</span>
        <span class="n">new_target_age_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">new_target_age_min</span><span class="p">)</span> <span class="k">if</span> <span class="n">new_target_age_min</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">new_target_age_max</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_age_max&quot;</span><span class="p">)</span>
        <span class="n">new_target_age_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">new_target_age_max</span><span class="p">)</span> <span class="k">if</span> <span class="n">new_target_age_max</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">new_target_age_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_target_age_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="n">new_target_age_max</span> <span class="o">&lt;</span> <span class="n">new_target_age_min</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_EDIT</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Minimum target age must be less than maximum target age.&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">target_age</span><span class="p">:</span>
            <span class="n">old_target_age_min</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">lower</span>
            <span class="n">old_target_age_max</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">target_age</span><span class="o">.</span><span class="n">upper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_target_age_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">old_target_age_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">new_target_age_min</span> <span class="o">!=</span> <span class="n">old_target_age_min</span> <span class="ow">or</span> <span class="n">new_target_age_max</span> <span class="o">!=</span> <span class="n">old_target_age_max</span><span class="p">:</span>
            <span class="c1"># Delete all previous staff target age classifications</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_classifications</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">AGE_RANGE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Create a new classification with a high weight - higher than audience</span>
            <span class="k">if</span> <span class="n">new_target_age_min</span> <span class="ow">and</span> <span class="n">new_target_age_max</span><span class="p">:</span>
                <span class="n">age_range_identifier</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">new_target_age_min</span><span class="p">,</span> <span class="n">new_target_age_max</span><span class="p">)</span>
                <span class="n">primary_identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                    <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span>
                    <span class="n">subject_type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">AGE_RANGE</span><span class="p">,</span>
                    <span class="n">subject_identifier</span><span class="o">=</span><span class="n">age_range_identifier</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Update fiction status</span>
        <span class="c1"># If fiction status hasn&#39;t changed but genres have changed,</span>
        <span class="c1"># we still want to ensure that there&#39;s a staff classification</span>
        <span class="n">new_fiction</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fiction&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;fiction&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_fiction</span> <span class="o">!=</span> <span class="n">work</span><span class="o">.</span><span class="n">fiction</span> <span class="ow">or</span> <span class="n">genres_changed</span><span class="p">:</span>
            <span class="c1"># Delete previous staff fiction classifications</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_classifications</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_FICTION_STATUS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Create a new classification with a high weight (higher than genre)</span>
            <span class="n">fiction_term</span> <span class="o">=</span> <span class="s2">&quot;Fiction&quot;</span> <span class="k">if</span> <span class="n">new_fiction</span> <span class="k">else</span> <span class="s2">&quot;Nonfiction&quot;</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="n">primary_identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span>
                <span class="n">subject_type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_FICTION_STATUS</span><span class="p">,</span>
                <span class="n">subject_identifier</span><span class="o">=</span><span class="n">fiction_term</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">classification</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">fiction</span> <span class="o">=</span> <span class="n">new_fiction</span>

        <span class="c1"># Update genres</span>
        <span class="c1"># make sure all new genres are legit</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">new_genres</span><span class="p">:</span>
            <span class="n">genre</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Genre</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="n">Genre</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">GENRE_NOT_FOUND</span>
            <span class="k">if</span> <span class="n">genres</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">is_fiction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">genres</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">is_fiction</span> <span class="o">!=</span> <span class="n">new_fiction</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">INCOMPATIBLE_GENRE</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Erotica&quot;</span> <span class="ow">and</span> <span class="n">new_audience</span> <span class="o">!=</span> <span class="s2">&quot;Adults Only&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">EROTICA_FOR_ADULTS_ONLY</span>

        <span class="k">if</span> <span class="n">genres_changed</span><span class="p">:</span>
            <span class="c1"># delete existing staff classifications for genres that aren&#39;t being kept</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_genre_classifications</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_genres</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># add new staff classifications for new genres</span>
            <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">new_genres</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_staff_genres</span><span class="p">:</span>
                    <span class="n">classification</span> <span class="o">=</span> <span class="n">primary_identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                        <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span>
                        <span class="n">subject_type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span><span class="p">,</span>
                        <span class="n">subject_identifier</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span>
                        <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span>
                    <span class="p">)</span>

            <span class="c1"># add NONE genre classification if we aren&#39;t keeping any genres</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_genres</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">primary_identifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
                    <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span>
                    <span class="n">subject_type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">SIMPLIFIED_GENRE</span><span class="p">,</span>
                    <span class="n">subject_identifier</span><span class="o">=</span><span class="n">SimplifiedGenreClassifier</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">WorkController</span><span class="o">.</span><span class="n">STAFF_WEIGHT</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise delete existing NONE genre classification</span>
                <span class="n">none_classifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> \
                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classification</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Subject</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">Classification</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">primary_identifier</span><span class="p">,</span>
                        <span class="n">Subject</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">SimplifiedGenreClassifier</span><span class="o">.</span><span class="n">NONE</span>
                    <span class="p">)</span> \
                    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">none_classifications</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># Update presentation</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
            <span class="n">classify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">update_search_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

    <span class="n">MINIMUM_COVER_WIDTH</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="n">MINIMUM_COVER_HEIGHT</span> <span class="o">=</span> <span class="mi">900</span>
    <span class="n">TOP</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
    <span class="n">CENTER</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
    <span class="n">BOTTOM</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
    <span class="n">TITLE_POSITIONS</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOP</span><span class="p">,</span> <span class="n">CENTER</span><span class="p">,</span> <span class="n">BOTTOM</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_validate_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">image_width</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MINIMUM_COVER_WIDTH</span> <span class="ow">or</span> <span class="n">image_height</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MINIMUM_COVER_HEIGHT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_IMAGE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cover image must be at least </span><span class="si">%(width)s</span><span class="s2">px in width and </span><span class="si">%(height)s</span><span class="s2">px in height.&quot;</span><span class="p">,</span>
                                            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MINIMUM_COVER_WIDTH</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MINIMUM_COVER_HEIGHT</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_process_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">title_position</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">author</span>
        <span class="k">if</span> <span class="n">author</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">UNKNOWN_AUTHOR</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">title_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TITLE_POSITIONS</span><span class="p">:</span>
            <span class="c1"># Convert image to &#39;RGB&#39; mode if it&#39;s not already, so drawing on it works.</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;RGB&#39;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>

            <span class="n">admin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">package_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admin_dir</span><span class="p">,</span> <span class="s2">&quot;../..&quot;</span><span class="p">)</span>
            <span class="n">bold_font_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;resources/OpenSans-Bold.ttf&quot;</span><span class="p">)</span>
            <span class="n">regular_font_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;resources/OpenSans-Regular.ttf&quot;</span><span class="p">)</span>
            <span class="n">font_size</span> <span class="o">=</span> <span class="n">image_width</span> <span class="o">//</span> <span class="mi">20</span>
            <span class="n">bold_font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">bold_font_path</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
            <span class="n">regular_font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">regular_font_path</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>

            <span class="n">padding</span> <span class="o">=</span> <span class="n">image_width</span> <span class="o">/</span> <span class="mi">40</span>

            <span class="n">max_line_width</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bold_char_width</span> <span class="o">=</span> <span class="n">bold_font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bold_char_count</span> <span class="o">=</span> <span class="n">image_width</span> <span class="o">/</span> <span class="n">bold_char_width</span>
            <span class="n">regular_char_width</span> <span class="o">=</span> <span class="n">regular_font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">regular_char_count</span> <span class="o">=</span> <span class="n">image_width</span> <span class="o">/</span> <span class="n">regular_char_width</span>
            <span class="n">title_lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">bold_char_count</span><span class="p">)</span>
            <span class="n">author_lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">regular_char_count</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lines</span><span class="p">,</span> <span class="n">font</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">title_lines</span><span class="p">,</span> <span class="n">bold_font</span><span class="p">),</span> <span class="p">(</span><span class="n">author_lines</span><span class="p">,</span> <span class="n">regular_font</span><span class="p">)]:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">line_width</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line_width</span> <span class="o">&gt;</span> <span class="n">max_line_width</span><span class="p">:</span>
                        <span class="n">max_line_width</span> <span class="o">=</span> <span class="n">line_width</span>

            <span class="n">ascent</span><span class="p">,</span> <span class="n">descent</span> <span class="o">=</span> <span class="n">bold_font</span><span class="o">.</span><span class="n">getmetrics</span><span class="p">()</span>
            <span class="n">line_height</span> <span class="o">=</span> <span class="n">ascent</span> <span class="o">+</span> <span class="n">descent</span>

            <span class="n">total_text_height</span> <span class="o">=</span> <span class="n">line_height</span> <span class="o">*</span> \
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">title_lines</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">author_lines</span><span class="p">))</span>
            <span class="n">rectangle_height</span> <span class="o">=</span> <span class="n">total_text_height</span> <span class="o">+</span> <span class="n">line_height</span>

            <span class="n">rectangle_width</span> <span class="o">=</span> <span class="n">max_line_width</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span>

            <span class="n">start_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_width</span> <span class="o">-</span> <span class="n">rectangle_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">title_position</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
                <span class="n">start_y</span> <span class="o">=</span> <span class="n">image_height</span> <span class="o">-</span> <span class="n">rectangle_height</span> <span class="o">-</span> <span class="n">image_height</span> <span class="o">/</span> <span class="mi">14</span>
            <span class="k">elif</span> <span class="n">title_position</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CENTER</span><span class="p">:</span>
                <span class="n">start_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_height</span> <span class="o">-</span> <span class="n">rectangle_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_y</span> <span class="o">=</span> <span class="n">image_height</span> <span class="o">/</span> <span class="mi">14</span>

            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">([(</span><span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">start_x</span> <span class="o">+</span> <span class="n">rectangle_width</span><span class="p">,</span> <span class="n">start_y</span> <span class="o">+</span> <span class="n">rectangle_height</span><span class="p">)],</span>
                           <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

            <span class="n">current_y</span> <span class="o">=</span> <span class="n">start_y</span> <span class="o">+</span> <span class="n">line_height</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">lines</span><span class="p">,</span> <span class="n">font</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">title_lines</span><span class="p">,</span> <span class="n">bold_font</span><span class="p">),</span> <span class="p">(</span><span class="n">author_lines</span><span class="p">,</span> <span class="n">regular_font</span><span class="p">)]:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">line_width</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">rectangle_width</span> <span class="o">-</span> <span class="n">line_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">current_y</span><span class="p">),</span>
                              <span class="n">line</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
                    <span class="n">current_y</span> <span class="o">+=</span> <span class="n">line_height</span>

            <span class="k">del</span> <span class="n">draw</span>

        <span class="k">return</span> <span class="n">image</span>

<div class="viewcode-block" id="WorkController.preview_book_cover"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.preview_book_cover">[docs]</a>    <span class="k">def</span> <span class="nf">preview_book_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a preview of the submitted cover image information.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cover_image</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">image</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
        <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;data:image/png;base64,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b64</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>

<div class="viewcode-block" id="WorkController.generate_cover_image"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.generate_cover_image">[docs]</a>    <span class="k">def</span> <span class="nf">generate_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">preview</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cover_file&quot;</span><span class="p">)</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cover_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">image_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_IMAGE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Image file or image URL is required.&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">image_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Validator</span><span class="p">()</span><span class="o">.</span><span class="n">_is_url</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="n">INVALID_URL</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%(url)s</span><span class="s1">&quot; is not a valid URL.&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">image_url</span><span class="p">))</span>
            
        <span class="c1">#TODO remove unused title_position.</span>
        <span class="n">title_position</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title_position&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">image_file</span><span class="p">:</span>
            <span class="n">image_file</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_cover_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">preview</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_title_position</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span></div>

    <span class="k">def</span> <span class="nf">_title_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">title_position</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title_position&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title_position</span> <span class="ow">and</span> <span class="n">title_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TITLE_POSITIONS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cover_image</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">title_position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="k">def</span> <span class="nf">_original_cover_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">,</span> <span class="n">rights_explanation</span><span class="p">):</span>
        <span class="n">original</span><span class="p">,</span> <span class="n">derivation_settings</span><span class="p">,</span> <span class="n">cover_href</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">cover_rights_explanation</span> <span class="o">=</span> <span class="n">rights_explanation</span>
        <span class="n">title_position</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title_position&quot;</span><span class="p">)</span>
        <span class="n">cover_url</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cover_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TITLE_POSITIONS</span><span class="p">:</span>
            <span class="n">original_href</span> <span class="o">=</span> <span class="n">cover_url</span>
            <span class="n">original_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">original_buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
            <span class="n">original_content</span> <span class="o">=</span> <span class="n">original_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">original_href</span><span class="p">:</span>
                <span class="n">original_href</span> <span class="o">=</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">generic_uri</span><span class="p">(</span>
                    <span class="n">data_source</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">original_content</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cover_image</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">title_position</span><span class="p">)</span>

            <span class="n">original_rights_explanation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">rights_uri</span> <span class="o">!=</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">:</span>
                <span class="n">original_rights_explanation</span> <span class="o">=</span> <span class="n">rights_explanation</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
                <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">original_href</span><span class="p">,</span> <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
                <span class="n">rights_explanation</span><span class="o">=</span><span class="n">original_rights_explanation</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">original_content</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">derivation_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">title_position</span><span class="o">=</span><span class="n">title_position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rights_uri</span> <span class="ow">in</span> <span class="n">RightsStatus</span><span class="o">.</span><span class="n">ALLOWS_DERIVATIVES</span><span class="p">:</span>
                <span class="n">cover_rights_explanation</span> <span class="o">=</span> <span class="s2">&quot;The original image license allows derivatives.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cover_href</span> <span class="o">=</span> <span class="n">cover_url</span>

        <span class="k">return</span> <span class="n">original</span><span class="p">,</span> <span class="n">derivation_settings</span><span class="p">,</span> <span class="n">cover_href</span><span class="p">,</span> <span class="n">cover_rights_explanation</span>

    <span class="k">def</span> <span class="nf">_get_collection_from_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_licensepools</span><span class="p">(</span>
            <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pools</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pools</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pools</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NO_LICENSES</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">pools</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">collection</span>
        <span class="k">return</span> <span class="n">collection</span>

<div class="viewcode-block" id="WorkController.change_book_cover"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.change_book_cover">[docs]</a>    <span class="k">def</span> <span class="nf">change_book_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save a new book cover based on the submitted form.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                              <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">rights_uri</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rights_status&quot;</span><span class="p">)</span>
        <span class="n">rights_explanation</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rights_explanation&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rights_uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_IMAGE</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You must specify the image&#39;s license.&quot;</span><span class="p">))</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_collection_from_pools</span><span class="p">(</span>
            <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">collection</span>

        <span class="c1"># Look for an appropriate mirror to store this cover image. Since the</span>
        <span class="c1"># mirror should be used for covers, we don&#39;t need a mirror for books.</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">mirrors</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">covers_mirror</span><span class="o">=</span><span class="n">MirrorUploader</span><span class="o">.</span><span class="n">for_collection</span><span class="p">(</span>
                <span class="n">collection</span><span class="p">,</span> <span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">),</span>
            <span class="n">books_mirror</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExternalIntegrationLink</span><span class="o">.</span><span class="n">COVERS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">INVALID_CONFIGURATION_OPTION</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not find a storage integration for uploading the cover.&quot;</span><span class="p">))</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cover_image</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">image</span>

        <span class="n">original</span><span class="p">,</span> <span class="n">derivation_settings</span><span class="p">,</span> <span class="n">cover_href</span><span class="p">,</span> <span class="n">cover_rights_explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_cover_info</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">rights_uri</span><span class="p">,</span> <span class="n">rights_explanation</span><span class="p">)</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cover_href</span><span class="p">:</span>
            <span class="n">cover_href</span> <span class="o">=</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">generic_uri</span><span class="p">(</span>
                <span class="n">data_source</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">primary_identifier</span><span class="p">,</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

        <span class="n">cover_data</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
            <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">cover_href</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">PNG_MEDIA_TYPE</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">rights_uri</span><span class="o">=</span><span class="n">rights_uri</span><span class="p">,</span>
            <span class="n">rights_explanation</span><span class="o">=</span><span class="n">cover_rights_explanation</span><span class="p">,</span>
            <span class="n">original</span><span class="o">=</span><span class="n">original</span><span class="p">,</span> <span class="n">transformation_settings</span><span class="o">=</span><span class="n">derivation_settings</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">presentation_policy</span> <span class="o">=</span> <span class="n">PresentationCalculationPolicy</span><span class="p">(</span>
            <span class="n">choose_edition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">set_edition_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">classify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">choose_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">calculate_quality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">choose_cover</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">regenerate_opds_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">regenerate_marc_record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">update_search_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">replacement_policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
            <span class="n">links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="c1"># link_content is false because we already have the content.</span>
            <span class="c1"># We don&#39;t want the metadata layer to try to fetch it again.</span>
            <span class="n">link_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="n">mirrors</span><span class="p">,</span>
            <span class="n">presentation_calculation_policy</span><span class="o">=</span><span class="n">presentation_policy</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="p">[</span><span class="n">cover_data</span><span class="p">])</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">,</span>
                       <span class="n">collection</span><span class="p">,</span>
                       <span class="n">replace</span><span class="o">=</span><span class="n">replacement_policy</span><span class="p">)</span>

        <span class="c1"># metadata.apply only updates the edition, so we also need</span>
        <span class="c1"># to update the work.</span>
        <span class="n">work</span><span class="o">.</span><span class="n">calculate_presentation</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">presentation_policy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_count_complaints_for_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="n">complaint_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">complaint</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">complaint</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">complaints</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">complaint</span><span class="o">.</span><span class="n">resolved</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">complaint_types</span><span class="p">)</span>

<div class="viewcode-block" id="WorkController.custom_lists"><a class="viewcode-back" href="../../../../api.admin.controller.html#api.admin.controller.work_editor.WorkController.custom_lists">[docs]</a>    <span class="k">def</span> <span class="nf">custom_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_librarian</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="n">library</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_work</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">work</span>

        <span class="n">staff_data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">LIBRARY_STAFF</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">custom_list_entries</span><span class="p">:</span>
                <span class="nb">list</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">customlist</span>
                <span class="n">lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">list</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">custom_lists</span><span class="o">=</span><span class="n">lists</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lists&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lists</span><span class="p">:</span>
                <span class="n">lists</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lists</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lists</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">affected_lanes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="c1"># Remove entries for lists that were not in the submitted form.</span>
            <span class="n">submitted_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lists</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">custom_list_entries</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">list_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">submitted_ids</span><span class="p">:</span>
                    <span class="nb">list</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">customlist</span>
                    <span class="nb">list</span><span class="o">.</span><span class="n">remove_entry</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">Lane</span><span class="o">.</span><span class="n">affected_by_customlist</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">affected_lanes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="c1"># Add entries for any new lists.</span>
            <span class="k">for</span> <span class="n">list_info</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">list_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">list_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="n">is_new</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">list</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                        <span class="nb">id</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">MISSING_CUSTOM_LIST</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not find list </span><span class="se">\&quot;</span><span class="si">%(list_name)s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">list_name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">list</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">CustomList</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">staff_data_source</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">)</span>
                    <span class="nb">list</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">was_new</span> <span class="o">=</span> <span class="nb">list</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">featured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">was_new</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">Lane</span><span class="o">.</span><span class="n">affected_by_customlist</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">affected_lanes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="c1"># If any list changes affected lanes, update their sizes.</span>
            <span class="c1"># NOTE: This may not make a difference until the</span>
            <span class="c1"># works are actually re-indexed.</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">affected_lanes</span><span class="p">:</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">update_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_engine</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../controller.html">api.admin.controller</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>