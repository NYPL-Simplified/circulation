
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.authenticator &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.authenticator</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">nose.tools</span> <span class="k">import</span> <span class="n">set_trace</span>
<span class="kn">from</span> <span class="nn">api.annotations</span> <span class="k">import</span> <span class="n">AnnotationWriter</span>
<span class="kn">from</span> <span class="nn">api.opds</span> <span class="k">import</span> <span class="n">LibraryAnnotator</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">IntegrationException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.selftest</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HasSelfTests</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.opds</span> <span class="k">import</span> <span class="n">OPDSFeed</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">PatronProfileStorage</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.problem_detail</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ProblemDetail</span><span class="p">,</span>
    <span class="n">json</span> <span class="k">as</span> <span class="n">pd_json</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.authentication_for_opds</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AuthenticationForOPDSDocument</span><span class="p">,</span>
    <span class="n">OPDSAuthenticationFlow</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="k">import</span> <span class="n">RemoteIntegrationException</span>
<span class="kn">from</span> <span class="nn">core.user_profile</span> <span class="k">import</span> <span class="n">ProfileController</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="k">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="k">import</span> <span class="n">NoResultFound</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">problem_details</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">util.patron</span> <span class="k">import</span> <span class="n">PatronUtility</span>
<span class="kn">from</span> <span class="nn">api.custom_patron_catalog</span> <span class="k">import</span> <span class="n">CustomPatronCatalog</span>
<span class="kn">from</span> <span class="nn">api.adobe_vendor_id</span> <span class="k">import</span> <span class="n">AuthdataUtility</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">money</span> <span class="k">import</span> <span class="n">Money</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Response</span><span class="p">,</span>
    <span class="n">redirect</span><span class="p">,</span>
    <span class="n">url_for</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">werkzeug.datastructures</span> <span class="k">import</span> <span class="n">Headers</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="k">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">import</span> <span class="nn">importlib</span>


<div class="viewcode-block" id="CannotCreateLocalPatron"><a class="viewcode-back" href="../../api.html#api.authenticator.CannotCreateLocalPatron">[docs]</a><span class="k">class</span> <span class="nc">CannotCreateLocalPatron</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A remote system provided information about a patron, but we could</span>
<span class="sd">    not put it into our database schema.</span>

<span class="sd">    Probably because it was too vague.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="PatronData"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData">[docs]</a><span class="k">class</span> <span class="nc">PatronData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for basic information about a patron.</span>

<span class="sd">    Like Metadata and CirculationData, this offers a layer of</span>
<span class="sd">    abstraction between various account managment systems and the</span>
<span class="sd">    circulation manager database. Unlike with those classes, some of</span>
<span class="sd">    this data cannot be written to the database for data retention</span>
<span class="sd">    reasons. But it can be passed from the account management system</span>
<span class="sd">    to the client application.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Used to distinguish between &quot;value has been unset&quot; and &quot;value</span>
    <span class="c1"># has not changed&quot;.</span>
<div class="viewcode-block" id="PatronData.NoValue"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData.NoValue">[docs]</a>    <span class="k">class</span> <span class="nc">NoValue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;We want this object to act like None or False.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="kc">False</span></div>
    <span class="n">NO_VALUE</span> <span class="o">=</span> <span class="n">NoValue</span><span class="p">()</span>

    <span class="c1"># Reasons why a patron might be blocked.</span>
    <span class="n">UNKNOWN_BLOCK</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">CARD_REPORTED_LOST</span> <span class="o">=</span> <span class="s1">&#39;card reported lost&#39;</span>
    <span class="n">EXCESSIVE_FINES</span> <span class="o">=</span> <span class="s1">&#39;excessive fines&#39;</span>
    <span class="n">EXCESSIVE_FEES</span> <span class="o">=</span> <span class="s1">&#39;excessive fees&#39;</span>
    <span class="n">NO_BORROWING_PRIVILEGES</span> <span class="o">=</span> <span class="s1">&#39;no borrowing privileges&#39;</span>
    <span class="n">TOO_MANY_LOANS</span> <span class="o">=</span> <span class="s1">&#39;too many active loans&#39;</span>
    <span class="n">TOO_MANY_RENEWALS</span> <span class="o">=</span> <span class="s1">&#39;too many renewals&#39;</span>
    <span class="n">TOO_MANY_OVERDUE</span> <span class="o">=</span> <span class="s1">&#39;too many items overdue&#39;</span>
    <span class="n">TOO_MANY_LOST</span> <span class="o">=</span> <span class="s1">&#39;too many items lost&#39;</span>

    <span class="c1"># Patron is being billed for too many items (as opposed to</span>
    <span class="c1"># excessive fines, which means patron&#39;s fines have exceeded a</span>
    <span class="c1"># certain amount).</span>
    <span class="n">TOO_MANY_ITEMS_BILLED</span> <span class="o">=</span> <span class="s1">&#39;too many items billed&#39;</span>

    <span class="c1"># Patron was asked to return an item so someone else could borrow it,</span>
    <span class="c1"># but didn&#39;t return the item.</span>
    <span class="n">RECALL_OVERDUE</span> <span class="o">=</span> <span class="s1">&#39;recall overdue&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">permanent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">authorization_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">personal_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">email_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">authorization_expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">external_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">block_reason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">library_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">complete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store basic information about a patron.</span>

<span class="sd">        :param permanent_id: A unique and unchanging identifier for</span>
<span class="sd">        the patron, as used by the account management system and</span>
<span class="sd">        probably never seen by the patron. This is not required, but</span>
<span class="sd">        it is very useful to have because other identifiers tend to</span>
<span class="sd">        change.</span>

<span class="sd">        :param authorization_identifier: One or more assigned</span>
<span class="sd">        identifiers (usually numeric) the patron may use to identify</span>
<span class="sd">        themselves. This may be a list, because patrons may have</span>
<span class="sd">        multiple authorization identifiers. For example, an NYPL</span>
<span class="sd">        patron may have an NYPL library card, a Brooklyn Public</span>
<span class="sd">        Library card, and an IDNYC card: three different barcodes that</span>
<span class="sd">        all authenticate the same patron.</span>

<span class="sd">        The circulation manager does the best it can to maintain</span>
<span class="sd">        continuity of the patron&#39;s identity in the face of changes to</span>
<span class="sd">        this list. The two assumptions made are:</span>

<span class="sd">        1) A patron tends to pick one of their authorization</span>
<span class="sd">        identifiers and stick with it until it stops working, rather</span>
<span class="sd">        than switching back and forth. This identifier is the one</span>
<span class="sd">        stored in Patron.authorization_identifier.</span>

<span class="sd">        2) In the absence of any other information, the authorization</span>
<span class="sd">        identifier at the _beginning_ of this list is the one that</span>
<span class="sd">        should be stored in Patron.authorization_identifier.</span>

<span class="sd">        :param username: An identifier (usually alphanumeric) chosen</span>
<span class="sd">        by the patron and used to identify themselves.</span>

<span class="sd">        :param personal_name: The name of the patron. This information</span>
<span class="sd">        is not stored in the circulation manager database but may be</span>
<span class="sd">        passed on to the client.</span>

<span class="sd">        :param authorization_expires: The date, if any, at which the patron&#39;s</span>
<span class="sd">        authorization to borrow items from the library expires.</span>

<span class="sd">        :param external_type: A string classifying the patron</span>
<span class="sd">        according to some library-specific scheme.</span>

<span class="sd">        :param fines: A Money object representing the amount the</span>
<span class="sd">        patron owes in fines. Note that only the value portion of the</span>
<span class="sd">        Money object will be stored in the database; the currency portion</span>
<span class="sd">        will be ignored. (e.g. &quot;20 USD&quot; will become 20)</span>

<span class="sd">        :param block_reason: A string indicating why the patron is</span>
<span class="sd">        blocked from borrowing items. (Even if this is set to None, it</span>
<span class="sd">        may turn out the patron cannot borrow items because their card</span>
<span class="sd">        has expired or their fines are excessive.)</span>

<span class="sd">        :param library_identifier: A string pulled from the ILS that</span>
<span class="sd">        is used to determine if this user belongs to the current library.</span>

<span class="sd">        :param complete: Does this PatronData represent the most</span>
<span class="sd">        complete data we are likely to get for this patron from this</span>
<span class="sd">        data source, or is it an abbreviated version of more complete</span>
<span class="sd">        data we could get some other way?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span> <span class="o">=</span> <span class="n">permanent_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_authorization_identifier</span><span class="p">(</span><span class="n">authorization_identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_expires</span> <span class="o">=</span> <span class="n">authorization_expires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_type</span> <span class="o">=</span> <span class="n">external_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fines</span> <span class="o">=</span> <span class="n">fines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_reason</span> <span class="o">=</span> <span class="n">block_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier</span> <span class="o">=</span> <span class="n">library_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">complete</span>

        <span class="c1"># We do not store personal_name in the database, but we provide</span>
        <span class="c1"># it to the client if possible.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">personal_name</span> <span class="o">=</span> <span class="n">personal_name</span>

        <span class="c1"># We do not store email address in the database, but we need</span>
        <span class="c1"># to have it available for notifications.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">email_address</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;PatronData permanent_id=</span><span class="si">%r</span><span class="s2"> authorization_identifier=</span><span class="si">%r</span><span class="s2"> username=</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
        <span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">fines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fines</span>

    <span class="nd">@fines</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When setting patron fines, only store the numeric portion of</span>
<span class="sd">        a Money object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Money</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fines</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="PatronData.apply"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take the portion of this data that can be stored in the database</span>
<span class="sd">        and write it to the given Patron record.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First, handle the easy stuff -- everything except authorization</span>
        <span class="c1"># identifier.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;external_identifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;external_type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;authorization_expires&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">authorization_expires</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;fines&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;block_reason&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_reason</span><span class="p">)</span>

        <span class="c1"># Now handle authorization identifier.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
            <span class="c1"># We have a complete picture of data from the ILS,</span>
            <span class="c1"># so we can be comfortable setting the authorization</span>
            <span class="c1"># identifier if necessary.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="ow">not</span> <span class="ow">in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifiers</span><span class="p">):</span>
                <span class="c1"># The patron&#39;s authorization_identifier is not set, or is</span>
                <span class="c1"># set to a value that is no longer valid. Set it again.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;authorization_identifier&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
            <span class="c1"># It looks like we need to change</span>
            <span class="c1"># Patron.authorization_identifier.  However, we do not</span>
            <span class="c1"># have a complete picture of the patron&#39;s record. We don&#39;t</span>
            <span class="c1"># know if the current identifier is better than the one</span>
            <span class="c1"># the patron provided.</span>

            <span class="c1"># However, we can provisionally</span>
            <span class="c1"># Patron.authorization_identifier if it&#39;s not already set.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="s1">&#39;authorization_identifier&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">patron</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="o">==</span> <span class="n">patron</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
                <span class="c1"># This should be fine. It looks like the patron&#39;s</span>
                <span class="c1"># .authorization_identifier is set to their barcode,</span>
                <span class="c1"># and they authenticated with their username. In this</span>
                <span class="c1"># case we can be confident there is no need to change</span>
                <span class="c1"># Patron.authorization_identifier.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We don&#39;t know what&#39;s going on and we need to sync</span>
                <span class="c1"># with the remote ASAP.</span>
                <span class="n">patron</span><span class="o">.</span><span class="n">last_external_sync</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Note that we do not store personal_name or email_address in the</span>
        <span class="c1"># database model.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
            <span class="c1"># We got a complete dataset from the ILS, which is what an</span>
            <span class="c1"># external sync does, so we can reset the timer on</span>
            <span class="c1"># external sync.</span>
            <span class="n">patron</span><span class="o">.</span><span class="n">last_external_sync</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span></div>

<div class="viewcode-block" id="PatronData.set_value"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do nothing</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_VALUE</span><span class="p">:</span>
            <span class="c1"># Unset a previous value.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronData.get_or_create_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData.get_or_create_patron">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">library_id</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Patron with this information.</span>

<span class="sd">        TODO: I&#39;m concerned in the general case with race</span>
<span class="sd">        conditions. It&#39;s theoretically possible that two newly created</span>
<span class="sd">        patrons could have the same username or authorization</span>
<span class="sd">        identifier, violating a uniqueness constraint. This could</span>
<span class="sd">        happen if one was identified by permanent ID and the other had</span>
<span class="sd">        no permanent ID and was identified by username. (This would</span>
<span class="sd">        only come up if the authentication provider has permanent IDs</span>
<span class="sd">        for some patrons but not others.)</span>

<span class="sd">        Something similar can happen if the authentication provider</span>
<span class="sd">        provides username and authorization identifier, but not</span>
<span class="sd">        permanent ID, and the patron&#39;s authorization identifier (but</span>
<span class="sd">        not their username) changes while two different circulation</span>
<span class="sd">        manager authentication requests are pending.</span>

<span class="sd">        When these race conditions do happen, I think the worst that</span>
<span class="sd">        will happen is the second request will fail. But it&#39;s very</span>
<span class="sd">        important that authorization providers give some unique,</span>
<span class="sd">        preferably unchanging way of identifying patrons.</span>

<span class="sd">        :param library_id: Database ID of the Library with which this</span>
<span class="sd">            patron is associated.</span>

<span class="sd">        :param analytics: Analytics instance to track the new patron</span>
<span class="sd">            creation event.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We must be very careful when checking whether the patron</span>
        <span class="c1"># already exists because three different fields might be in use</span>
        <span class="c1"># as the patron identifier.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">:</span>
            <span class="n">search_by</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">external_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="n">search_by</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
            <span class="n">search_by</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">authorization_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotCreateLocalPatron</span><span class="p">(</span>
                <span class="s2">&quot;Cannot create patron without some way of identifying them uniquely.&quot;</span>
            <span class="p">)</span>
        <span class="n">search_by</span><span class="p">[</span><span class="s1">&#39;library_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">library_id</span>
        <span class="n">__transaction</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
        <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Patron</span><span class="p">,</span> <span class="o">**</span><span class="n">search_by</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="n">analytics</span><span class="p">:</span>
            <span class="c1"># Send out an analytics event to record the fact</span>
            <span class="c1"># that a new patron was created.</span>
            <span class="n">analytics</span><span class="o">.</span><span class="n">collect_event</span><span class="p">(</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">NEW_PATRON</span><span class="p">)</span>

        <span class="c1"># This makes sure the Patron is brought into sync with the</span>
        <span class="c1"># other fields of this PatronData object, regardless of</span>
        <span class="c1"># whether or not it is newly created.</span>
        <span class="k">if</span> <span class="n">patron</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">__transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_response_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return information about this patron which the client might</span>
<span class="sd">        find useful.</span>

<span class="sd">        This information will be sent to the client immediately after</span>
<span class="sd">        a patron&#39;s credentials are verified by an OAuth provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">personal_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">personal_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the information in this PatronData to a dictionary</span>
<span class="sd">        which can be converted to JSON and sent out to a client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">scrub</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_VALUE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">permanent_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">,</span>
            <span class="n">authorization_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">external_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_type</span><span class="p">,</span>
            <span class="n">block_reason</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_reason</span><span class="p">,</span>
            <span class="n">personal_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">personal_name</span><span class="p">,</span>
            <span class="n">email_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">scrub</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="c1"># Handle the data items that aren&#39;t just strings.</span>

        <span class="c1"># A date</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">scrub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_expires</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_expires</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;authorization_expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expires</span>

        <span class="c1"># A Money</span>
        <span class="n">fines</span> <span class="o">=</span> <span class="n">scrub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fines</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fines</span>

        <span class="c1"># A list</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;authorization_identifiers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrub</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifiers</span><span class="p">,</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="PatronData.set_authorization_identifier"><a class="viewcode-back" href="../../api.html#api.authenticator.PatronData.set_authorization_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">set_authorization_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to set both .authorization_identifier</span>
<span class="sd">        and .authorization_identifiers appropriately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The first authorization identifier in the list is the one</span>
        <span class="c1"># we should use for Patron.authorization_identifier, assuming</span>
        <span class="c1"># Patron.authorization_identifier needs to be updated.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="n">authorization_identifier</span>
            <span class="n">authorization_identifier</span> <span class="o">=</span> <span class="n">authorization_identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">authorization_identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">authorization_identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">authorization_identifier</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_VALUE</span><span class="p">:</span>
            <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">authorization_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">authorization_identifier</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="o">=</span> <span class="n">authorization_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="n">authorization_identifiers</span></div></div>

<div class="viewcode-block" id="CirculationPatronProfileStorage"><a class="viewcode-back" href="../../api.html#api.authenticator.CirculationPatronProfileStorage">[docs]</a><span class="k">class</span> <span class="nc">CirculationPatronProfileStorage</span><span class="p">(</span><span class="n">PatronProfileStorage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A patron profile storage that can also provide short client tokens&quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CirculationPatronProfileStorage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">profile_document</span>
        <span class="n">drm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">device_link</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">authdata</span> <span class="o">=</span> <span class="n">AuthdataUtility</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">authdata</span><span class="p">:</span>
            <span class="n">vendor_id</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">authdata</span><span class="o">.</span><span class="n">short_client_token_for_patron</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">)</span>
            <span class="n">adobe_drm</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">adobe_drm</span><span class="p">[</span><span class="s1">&#39;drm:vendor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vendor_id</span>
            <span class="n">adobe_drm</span><span class="p">[</span><span class="s1">&#39;drm:clientToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
            <span class="n">adobe_drm</span><span class="p">[</span><span class="s1">&#39;drm:scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/drm/scheme/ACS&quot;</span>
            <span class="n">drm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adobe_drm</span><span class="p">)</span>

            <span class="n">device_link</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://librarysimplified.org/terms/drm/rel/devices&#39;</span>
            <span class="n">device_link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s2">&quot;adobe_drm_devices&quot;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device_link</span><span class="p">)</span>

            <span class="n">annotations_link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/ns/oa#annotationService&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">AnnotationWriter</span><span class="o">.</span><span class="n">CONTENT_TYPE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;annotations&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotations_link</span><span class="p">)</span>

            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">links</span>

        <span class="k">if</span> <span class="n">drm</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;drm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm</span>

        <span class="k">return</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="Authenticator"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator">[docs]</a><span class="k">class</span> <span class="nc">Authenticator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Route requests to the appropriate LibraryAuthenticator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_authenticators</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_authenticators</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_library_short_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span>

<div class="viewcode-block" id="Authenticator.populate_authenticators"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.populate_authenticators">[docs]</a>    <span class="k">def</span> <span class="nf">populate_authenticators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">analytics</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_authenticators</span><span class="p">[</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">LibraryAuthenticator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.invoke_authenticator_method"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.invoke_authenticator_method">[docs]</a>    <span class="k">def</span> <span class="nf">invoke_authenticator_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">short_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_library_short_name</span>
        <span class="k">if</span> <span class="n">short_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_authenticators</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LIBRARY_NOT_FOUND</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_authenticators</span><span class="p">[</span><span class="n">short_name</span><span class="p">],</span> <span class="n">method_name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.authenticated_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.authenticated_patron">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span><span class="s2">&quot;authenticated_patron&quot;</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.create_authentication_document"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.create_authentication_document">[docs]</a>    <span class="k">def</span> <span class="nf">create_authentication_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span><span class="s2">&quot;create_authentication_document&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.create_authentication_headers"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.create_authentication_headers">[docs]</a>    <span class="k">def</span> <span class="nf">create_authentication_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span><span class="s2">&quot;create_authentication_headers&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.get_credential_from_header"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.get_credential_from_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_credential_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span><span class="s2">&quot;get_credential_from_header&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.create_bearer_token"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.create_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">create_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span>
            <span class="s2">&quot;create_bearer_token&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.oauth_provider_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.oauth_provider_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">oauth_provider_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span>
            <span class="s2">&quot;oauth_provider_lookup&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Authenticator.decode_bearer_token"><a class="viewcode-back" href="../../api.html#api.authenticator.Authenticator.decode_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">decode_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_authenticator_method</span><span class="p">(</span>
            <span class="s2">&quot;decode_bearer_token&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="LibraryAuthenticator"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator">[docs]</a><span class="k">class</span> <span class="nc">LibraryAuthenticator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use the registered AuthenticationProviders to turn incoming</span>
<span class="sd">    credentials into Patron objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LibraryAuthenticator.from_config"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_catalog_source</span><span class="o">=</span><span class="n">CustomPatronCatalog</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an Authenticator for the given Library based on its</span>
<span class="sd">        configured ExternalIntegrations.</span>

<span class="sd">        :param custom_catalog_source: The lookup class for CustomPatronCatalogs.</span>
<span class="sd">            Intended for mocking during tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">custom_catalog</span> <span class="o">=</span> <span class="n">custom_catalog_source</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="c1"># Start with an empty list of authenticators.</span>
        <span class="n">authenticator</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">_db</span><span class="o">=</span><span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">library</span><span class="p">,</span>
            <span class="n">authentication_document_annotator</span><span class="o">=</span><span class="n">custom_catalog</span>
        <span class="p">)</span>

        <span class="c1"># Find all of this library&#39;s ExternalIntegrations set up with</span>
        <span class="c1"># the goal of authenticating patrons.</span>
        <span class="n">integrations</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">for_library_and_goal</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PATRON_AUTH_GOAL</span>
        <span class="p">)</span>
        <span class="c1"># Turn each such ExternalIntegration into an</span>
        <span class="c1"># AuthenticationProvider.</span>
        <span class="k">for</span> <span class="n">integration</span> <span class="ow">in</span> <span class="n">integrations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authenticator</span><span class="o">.</span><span class="n">register_provider</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="n">CannotLoadConfiguration</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># These are the two types of error that might be caused</span>
                <span class="c1"># by misconfiguration, as opposed to bad code.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Error registering authentication provider </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">integration</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">integration</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>
                <span class="n">authenticator</span><span class="o">.</span><span class="n">initialization_exceptions</span><span class="p">[</span><span class="n">integration</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>

        <span class="k">if</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">:</span>
            <span class="c1"># NOTE: this will immediately commit the database session,</span>
            <span class="c1"># which may not be what you want during a test. To avoid</span>
            <span class="c1"># this, you can create the bearer token signing secret as</span>
            <span class="c1"># a regular site-wide ConfigurationSetting.</span>
            <span class="n">authenticator</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span> <span class="o">=</span> <span class="n">OAuthAuthenticationProvider</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span><span class="p">(</span>
                <span class="n">_db</span>
            <span class="p">)</span>
        <span class="n">authenticator</span><span class="o">.</span><span class="n">assert_ready_for_oauth</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">authenticator</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">basic_auth_provider</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">oauth_providers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bearer_token_signing_secret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">authentication_document_annotator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a LibraryAuthenticator from a list of AuthenticationProviders.</span>

<span class="sd">        :param _db: A database session (probably a scoped session, which is</span>
<span class="sd">            why we can&#39;t derive it from `library`)</span>

<span class="sd">        :param library: The Library to which this LibraryAuthenticator guards</span>
<span class="sd">        access.</span>

<span class="sd">        :param basic_auth_provider: The AuthenticatonProvider that handles</span>
<span class="sd">        HTTP Basic Auth requests.</span>

<span class="sd">        :param oauth_providers: A list of AuthenticationProviders that handle</span>
<span class="sd">        OAuth requests.</span>

<span class="sd">        :param bearer_token_signing_secret: The secret to use when</span>
<span class="sd">        signing JWTs for use as bearer tokens.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_uuid</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_short_name</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">short_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authentication_document_annotator</span><span class="o">=</span><span class="n">authentication_document_annotator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="o">=</span> <span class="n">basic_auth_provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span> <span class="o">=</span> <span class="n">bearer_token_signing_secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialization_exceptions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Make sure there&#39;s a public/private key pair for this</span>
        <span class="c1"># library. This makes it possible to register the library with</span>
        <span class="c1"># discovery services. Store the public key here for</span>
        <span class="c1"># convenience; leave the private key in the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_pair</span>

        <span class="k">if</span> <span class="n">oauth_providers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">oauth_providers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">[</span><span class="n">provider</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_ready_for_oauth</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supports_patron_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this library have any way of authenticating patrons at all?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identifies_individuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this library require that individual patrons be identified?</span>

<span class="sd">        Most libraries require authentication as an individual. Some</span>
<span class="sd">        libraries don&#39;t identify patrons at all; others may have a way</span>
<span class="sd">        of identifying the patron population without identifying</span>
<span class="sd">        individuals, such as an IP gate.</span>

<span class="sd">        If some of a library&#39;s authentication mechanisms identify individuals,</span>
<span class="sd">        and others do not, the library does not identify individuals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_patron_authentication</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matches</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">IDENTIFIES_INDIVIDUALS</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Library</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span>

<div class="viewcode-block" id="LibraryAuthenticator.assert_ready_for_oauth"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.assert_ready_for_oauth">[docs]</a>    <span class="k">def</span> <span class="nf">assert_ready_for_oauth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this LibraryAuthenticator has OAuth providers, ensure that it</span>
<span class="sd">        also has a secret it can use to sign bearer tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;OAuth providers are configured, but secret for signing bearer tokens is not.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.register_provider"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.register_provider">[docs]</a>    <span class="k">def</span> <span class="nf">register_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an ExternalIntegration object into an AuthenticationProvider</span>
<span class="sd">        object, and register it.</span>

<span class="sd">        :param integration: An ExternalIntegration that configures</span>
<span class="sd">            a way of authenticating patrons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">integration</span><span class="o">.</span><span class="n">goal</span> <span class="o">!=</span> <span class="n">integration</span><span class="o">.</span><span class="n">PATRON_AUTH_GOAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Was asked to register an integration with goal=</span><span class="si">%s</span><span class="s2"> as though it were a way of authenticating patrons.&quot;</span> <span class="o">%</span> <span class="n">integration</span><span class="o">.</span><span class="n">goal</span>
            <span class="p">)</span>

        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span>
        <span class="k">if</span> <span class="n">library</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">integration</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Was asked to register an integration with library </span><span class="si">%s</span><span class="s2">, which doesn&#39;t use it.&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="n">module_name</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">protocol</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_name</span><span class="p">:</span>
            <span class="c1"># This should be impossible since protocol is not nullable.</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Authentication provider configuration does not specify protocol.&quot;</span>
            <span class="p">)</span>
        <span class="n">provider_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">provider_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">provider_module</span><span class="p">,</span> <span class="s2">&quot;AuthenticationProvider&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Loaded module </span><span class="si">%s</span><span class="s2"> but could not find a class called AuthenticationProvider inside.&quot;</span> <span class="o">%</span> <span class="n">module_name</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">provider_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Could not instantiate </span><span class="si">%s</span><span class="s2"> authentication provider for library </span><span class="si">%s</span><span class="s2">, possibly due to a network connection problem.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">provider_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">provider_class</span><span class="p">,</span> <span class="n">BasicAuthenticationProvider</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_basic_auth_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
            <span class="c1"># TODO: Run a self-test, or at least check that we have</span>
            <span class="c1"># the ability to run one.</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">provider_class</span><span class="p">,</span> <span class="n">OAuthAuthenticationProvider</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_oauth_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Authentication provider </span><span class="si">%s</span><span class="s2"> is neither a BasicAuthenticationProvider nor an OAuthAuthenticationProvider. I can create it, but not sure where to put it.&quot;</span> <span class="o">%</span> <span class="n">provider_class</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.register_basic_auth_provider"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.register_basic_auth_provider">[docs]</a>    <span class="k">def</span> <span class="nf">register_basic_auth_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="o">!=</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="o">!=</span> <span class="n">provider</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Two basic auth providers configured&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="o">=</span> <span class="n">provider</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.register_oauth_provider"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.register_oauth_provider">[docs]</a>    <span class="k">def</span> <span class="nf">register_oauth_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="n">already_registered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">NAME</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">already_registered</span> <span class="ow">and</span> <span class="n">already_registered</span> <span class="o">!=</span> <span class="n">provider</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s1">&#39;Two different OAuth providers claim the name &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">provider</span><span class="o">.</span><span class="n">NAME</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">[</span><span class="n">provider</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">providers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator over all registered AuthenticationProviders.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">provider</span>

<div class="viewcode-block" id="LibraryAuthenticator.authenticated_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.authenticated_patron">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go from an Authorization header value to a Patron object.</span>

<span class="sd">        :param header: If Basic Auth is in use, this is a dictionary</span>
<span class="sd">            with &#39;user&#39; and &#39;password&#39; components, derived from the HTTP</span>
<span class="sd">            header `Authorization`. Otherwise, this is the literal value</span>
<span class="sd">            of the `Authorization` HTTP header.</span>

<span class="sd">        :return: A Patron, if one can be authenticated. None, if the</span>
<span class="sd">            credentials do not authenticate any particular patron. A</span>
<span class="sd">            ProblemDetail if an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">):</span>
            <span class="c1"># The patron wants to authenticate with the</span>
            <span class="c1"># BasicAuthenticationProvider.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span><span class="o">.</span><span class="n">authenticated_patron</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span>
              <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
              <span class="ow">and</span> <span class="s1">&#39;bearer&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>

            <span class="c1"># The patron wants to use an</span>
            <span class="c1"># OAuthAuthenticationProvider. Figure out which one.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">provider_name</span><span class="p">,</span> <span class="n">provider_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_bearer_token_from_header</span><span class="p">(</span>
                    <span class="n">header</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">INVALID_OAUTH_BEARER_TOKEN</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_provider_lookup</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
                <span class="c1"># There was a problem turning the provider name into</span>
                <span class="c1"># a registered OAuthAuthenticationProvider.</span>
                <span class="k">return</span> <span class="n">provider</span>

            <span class="c1"># Ask the OAuthAuthenticationProvider to turn its token</span>
            <span class="c1"># into a Patron.</span>
            <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="n">authenticated_patron</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">provider_token</span><span class="p">)</span>

        <span class="c1"># We were unable to determine what was going on with the</span>
        <span class="c1"># Authenticate header.</span>
        <span class="k">return</span> <span class="n">UNSUPPORTED_AUTHENTICATION_MECHANISM</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.get_credential_from_header"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.get_credential_from_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_credential_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a password credential from a WWW-Authenticate header</span>
<span class="sd">        (or equivalent).</span>

<span class="sd">        This is used to pass on a patron&#39;s credential to a content provider,</span>
<span class="sd">        such as Overdrive, which performs independent validation of</span>
<span class="sd">        a patron&#39;s credentials.</span>

<span class="sd">        :return: The patron&#39;s password, or None if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">credential</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_credential_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">credential</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">credential</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.oauth_provider_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.oauth_provider_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">oauth_provider_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up the OAuthAuthenticationProvider with the given name. If that</span>
<span class="sd">        doesn&#39;t work, return an appropriate ProblemDetail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">:</span>
            <span class="c1"># We don&#39;t support OAuth at all.</span>
            <span class="k">return</span> <span class="n">UNKNOWN_OAUTH_PROVIDER</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No OAuth providers are configured.&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">provider_name</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">provider_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">):</span>
            <span class="c1"># The patron neglected to specify a provider, or specified</span>
            <span class="c1"># one we don&#39;t support.</span>
            <span class="n">possibilities</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">UNKNOWN_OAUTH_PROVIDER</span><span class="o">.</span><span class="n">detailed</span><span class="p">(</span>
                <span class="n">UNKNOWN_OAUTH_PROVIDER</span><span class="o">.</span><span class="n">detail</span> <span class="o">+</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot; The known providers are: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">possibilities</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_providers_by_name</span><span class="p">[</span><span class="n">provider_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.create_bearer_token"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.create_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">create_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">provider_token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a JSON web token with the given provider name and access</span>
<span class="sd">        token.</span>

<span class="sd">        The patron will use this as a bearer token in lieu of the</span>
<span class="sd">        token we got from their OAuth provider. The big advantage of</span>
<span class="sd">        this token is that it tells us _which_ OAuth provider the</span>
<span class="sd">        patron authenticated against.</span>

<span class="sd">        When the patron uses the bearer token in the Authenticate header,</span>
<span class="sd">        it will be decoded with `decode_bearer_token_from_header`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">token</span><span class="o">=</span><span class="n">provider_token</span><span class="p">,</span>
            <span class="c1"># I&#39;m not sure this is the correct way to use an</span>
            <span class="c1"># Issuer claim (https://tools.ietf.org/html/rfc7519#section-4.1.1).</span>
            <span class="c1"># Maybe we should use something custom instead.</span>
            <span class="n">iss</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.decode_bearer_token_from_header"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.decode_bearer_token_from_header">[docs]</a>    <span class="k">def</span> <span class="nf">decode_bearer_token_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract auth provider name and access token from an Authenticate</span>
<span class="sd">        header value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simplified_token</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_bearer_token</span><span class="p">(</span><span class="n">simplified_token</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.decode_bearer_token"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.decode_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">decode_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract auth provider name and access token from JSON web token.&quot;&quot;&quot;</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearer_token_signing_secret</span><span class="p">,</span>
                             <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[</span><span class="s1">&#39;iss&#39;</span><span class="p">]</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.authentication_document_url"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.authentication_document_url">[docs]</a>    <span class="k">def</span> <span class="nf">authentication_document_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the URL of the authentication document for the</span>
<span class="sd">        given library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;authentication_document&quot;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAuthenticator.create_authentication_document"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.create_authentication_document">[docs]</a>    <span class="k">def</span> <span class="nf">create_authentication_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the Authentication For OPDS document to be used when</span>
<span class="sd">        a request comes in with no authentication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span>

        <span class="c1"># Add the same links that we would show in an OPDS feed, plus</span>
        <span class="c1"># some extra like &#39;registration&#39; that are specific to Authentication</span>
        <span class="c1"># For OPDS.</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="p">(</span><span class="n">LibraryAnnotator</span><span class="o">.</span><span class="n">CONFIGURATION_LINKS</span> <span class="o">+</span>
                    <span class="n">Configuration</span><span class="o">.</span><span class="n">AUTHENTICATION_FOR_OPDS_LINKS</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http:&#39;</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="p">)):</span>
                <span class="c1"># We assume that HTTP URLs lead to HTML, but we don&#39;t</span>
                <span class="c1"># assume anything about other URL schemes.</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text/html&quot;</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

        <span class="c1"># Add a rel=&quot;start&quot; link pointing to the root OPDS feed.</span>
        <span class="n">index_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="n">loans_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;active_loans&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>
        <span class="n">profile_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;patron_profile&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>

        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">index_url</span><span class="p">,</span>
                 <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://opds-spec.org/shelf&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">loans_url</span><span class="p">,</span>
                 <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">ProfileController</span><span class="o">.</span><span class="n">LINK_RELATION</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">profile_url</span><span class="p">,</span>
                 <span class="nb">type</span><span class="o">=</span><span class="n">ProfileController</span><span class="o">.</span><span class="n">MEDIA_TYPE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If there is a Designated Agent email address, add it as a</span>
        <span class="c1"># link.</span>
        <span class="n">designated_agent_uri</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">copyright_designated_agent_uri</span><span class="p">(</span>
            <span class="n">library</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">designated_agent_uri</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">Configuration</span><span class="o">.</span><span class="n">COPYRIGHT_DESIGNATED_AGENT_REL</span><span class="p">,</span>
                     <span class="n">href</span><span class="o">=</span><span class="n">designated_agent_uri</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add a rel=&quot;help&quot; link for every type of URL scheme that</span>
        <span class="c1"># leads to library-specific help.</span>
        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">help_uris</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">))</span>

        <span class="c1"># Add a link to the web page of the library itself.</span>
        <span class="n">library_uri</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">WEBSITE_URL</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">library_uri</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">library_uri</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add the library&#39;s logo, if it has one.</span>
        <span class="n">logo</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">LOGO</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">logo</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;logo&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">logo</span><span class="p">))</span>

        <span class="c1"># Add the library&#39;s custom CSS file, if it has one.</span>
        <span class="n">css_file</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">WEB_CSS_FILE</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">css_file</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">css_file</span><span class="p">))</span>

        <span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="ow">or</span> <span class="n">unicode</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library&quot;</span><span class="p">))</span>
        <span class="n">auth_doc_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_document_url</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">AuthenticationForOPDSDocument</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">auth_doc_url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">library_name</span><span class="p">,</span>
            <span class="n">authentication_flows</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">),</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="c1"># Add the library&#39;s mobile color scheme, if it has one.</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">COLOR_SCHEME</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;color_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="c1"># Add the library&#39;s web colors, if it has any.</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">WEB_BACKGROUND_COLOR</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">foreground</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">WEB_FOREGROUND_COLOR</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">background</span> <span class="ow">or</span> <span class="n">foreground</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;web_color_scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="n">foreground</span><span class="p">)</span>

        <span class="c1"># Add the description of the library as the OPDS feed&#39;s</span>
        <span class="c1"># service_description.</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">LIBRARY_DESCRIPTION</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;service_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="c1"># Add the library&#39;s focus area and service area, if either is</span>
        <span class="c1"># specified.</span>
        <span class="n">focus_area</span><span class="p">,</span> <span class="n">service_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geographic_areas</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">focus_area</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;focus_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">focus_area</span>
        <span class="k">if</span> <span class="n">service_area</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;service_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_area</span>

        <span class="c1"># Add the library&#39;s public key.</span>
        <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RSA&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>

        <span class="c1"># Add feature flags to signal to clients what features they should</span>
        <span class="c1"># offer.</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">disabled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">library</span><span class="o">.</span><span class="n">allow_holds</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">enabled</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">disabled</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Configuration</span><span class="o">.</span><span class="n">RESERVATIONS_FEATURE</span><span class="p">)</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">enabled</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">disabled</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_document_annotator</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_document_annotator</span><span class="o">.</span><span class="n">annotate_authentication_document</span><span class="p">(</span>
                <span class="n">library</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">url_for</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up or create a public/private key pair for use by this library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">KEY_PAIR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">key_pair</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_geographic_areas</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the library&#39;s focus area and service area.</span>

<span class="sd">        :param library: A Library</span>
<span class="sd">        :return: A 2-tuple (focus_area, service_area)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">focus_area</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_geographic_area</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">LIBRARY_FOCUS_AREA</span><span class="p">,</span> <span class="n">library</span>
        <span class="p">)</span>
        <span class="n">service_area</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_geographic_area</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">LIBRARY_SERVICE_AREA</span><span class="p">,</span> <span class="n">library</span>
        <span class="p">)</span>

        <span class="c1"># If only one value is provided, both values are considered to</span>
        <span class="c1"># be the same.</span>
        <span class="k">if</span> <span class="n">focus_area</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">service_area</span><span class="p">:</span>
            <span class="n">service_area</span> <span class="o">=</span> <span class="n">focus_area</span>
        <span class="k">if</span> <span class="n">service_area</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">focus_area</span><span class="p">:</span>
            <span class="n">focus_area</span> <span class="o">=</span> <span class="n">service_area</span>
        <span class="k">return</span> <span class="n">focus_area</span><span class="p">,</span> <span class="n">service_area</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_geographic_area</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a geographic area from a ConfigurationSetting</span>
<span class="sd">        for the given `library`.</span>

<span class="sd">        See https://github.com/NYPL-Simplified/Simplified/wiki/Authentication-For-OPDS-Extensions#service_area and #focus_area</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setting</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">setting</span>
        <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s1">&#39;everywhere&#39;</span><span class="p">:</span>
            <span class="c1"># This literal string may be served as is.</span>
            <span class="k">return</span> <span class="n">setting</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If we can load the setting as JSON, it is either a list</span>
            <span class="c1"># of place names or a GeoJSON object.</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># The most common outcome -- treat the value as a single place</span>
            <span class="c1"># name by turning it into a list.</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="p">[</span><span class="n">setting</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">setting</span>

<div class="viewcode-block" id="LibraryAuthenticator.create_authentication_headers"><a class="viewcode-back" href="../../api.html#api.authenticator.LibraryAuthenticator.create_authentication_headers">[docs]</a>    <span class="k">def</span> <span class="nf">create_authentication_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the HTTP headers to return with the OPDS</span>
<span class="sd">        authentication document.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">Library</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">()</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">AuthenticationForOPDSDocument</span><span class="o">.</span><span class="n">MEDIA_TYPE</span><span class="p">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Link&#39;</span><span class="p">,</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;; rel=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authentication_document_url</span><span class="p">(</span><span class="n">library</span><span class="p">),</span>
            <span class="n">AuthenticationForOPDSDocument</span><span class="o">.</span><span class="n">LINK_RELATION</span>
        <span class="p">))</span>
        <span class="c1"># if requested from a web client, don&#39;t include WWW-Authenticate header,</span>
        <span class="c1"># which forces the default browser authentication prompt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Requested-With&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;XMLHttpRequest&quot;</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_provider</span><span class="o">.</span><span class="n">authentication_header</span><span class="p">)</span>

        <span class="c1"># TODO: We&#39;re leaving out headers for other providers to avoid breaking iOS</span>
        <span class="c1"># clients that don&#39;t support multiple auth headers. It&#39;s not clear what</span>
        <span class="c1"># the header for an oauth provider should look like. This means that there&#39;s</span>
        <span class="c1"># no auth header for app without a basic auth provider, but we don&#39;t have</span>
        <span class="c1"># any apps like that yet.</span>

        <span class="k">return</span> <span class="n">headers</span></div></div>


<div class="viewcode-block" id="AuthenticationProvider"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider">[docs]</a><span class="k">class</span> <span class="nc">AuthenticationProvider</span><span class="p">(</span><span class="n">OPDSAuthenticationFlow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle a specific patron authentication scheme.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># NOTE: Each subclass MUST define an attribute called NAME, which</span>
    <span class="c1"># is displayed in the admin interface when configuring patron auth,</span>
    <span class="c1"># used to create the name of the log channel used by this</span>
    <span class="c1"># subclass, used to distinguish between tokens from different</span>
    <span class="c1"># OAuth providers, etc.</span>

    <span class="c1"># Each subclass SHOULD define an attribute called DESCRIPTION, which</span>
    <span class="c1"># is displayed in the admin interface when an admin is configuring</span>
    <span class="c1"># the authentication provider.</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Each subclass MUST define a value for FLOW_TYPE. This is used in the</span>
    <span class="c1"># Authentication for OPDS document to distinguish between</span>
    <span class="c1"># different types of authentication.</span>
    <span class="n">FLOW_TYPE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If an AuthenticationProvider authenticates patrons without identifying</span>
    <span class="c1"># then as specific individuals (the way a geographic gate does),</span>
    <span class="c1"># it should override this value and set it to False.</span>
    <span class="n">IDENTIFIES_INDIVIDUALS</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># An AuthenticationProvider may define a custom button image for</span>
    <span class="c1"># clients to display when letting a user choose between different</span>
    <span class="c1"># AuthenticationProviders. Image files MUST be stored in the</span>
    <span class="c1"># `resources/images` directory - the value here should be the</span>
    <span class="c1"># file name.</span>
    <span class="n">LOGIN_BUTTON_IMAGE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Each authentication mechanism may have a list of SETTINGS that</span>
    <span class="c1"># must be configured for that mechanism, and may have a list of</span>
    <span class="c1"># LIBRARY_SETTINGS that must be configured for each library using that</span>
    <span class="c1"># mechanism. Each setting must have a key that is used to store the</span>
    <span class="c1"># setting in the database, and a label that is displayed when configuring</span>
    <span class="c1"># the authentication mechanism in the admin interface.</span>
    <span class="c1"># For example: { &quot;key&quot;: &quot;username&quot;, &quot;label&quot;: _(&quot;Client ID&quot;) }.</span>
    <span class="c1"># A setting is optional by default, but may have &quot;required&quot; set to True.</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Each library and authentication mechanism may have a regular</span>
    <span class="c1"># expression for deriving a patron&#39;s external type from their</span>
    <span class="c1"># authentication identifier.</span>
    <span class="n">EXTERNAL_TYPE_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="s1">&#39;external_type_regular_expression&#39;</span>

    <span class="c1"># When multiple libraries share an ILS, a person may be able to</span>
    <span class="c1"># authenticate with the ILS but not be considered a patron of</span>
    <span class="c1"># _this_ library. This setting contains the rule for determining</span>
    <span class="c1"># whether an identifier is valid for a specific library.</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE</span> <span class="o">=</span> <span class="s1">&#39;library_identifier_restriction_type&#39;</span>

    <span class="c1"># This field lets the user choose the data source for the patron match.</span>
    <span class="n">LIBRARY_IDENTIFIER_FIELD</span> <span class="o">=</span> <span class="s1">&#39;library_identifier_field&#39;</span>

    <span class="c1"># Usually this is a string which is compared against the</span>
    <span class="c1"># patron&#39;s identifiers using the comparison method chosen in</span>
    <span class="c1"># LIBRARY_IDENTIFIER_RESTRICTION_TYPE.</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION</span> <span class="o">=</span> <span class="s1">&#39;library_identifier_restriction&#39;</span>

    <span class="c1"># Different types of patron restrictions.</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_BARCODE</span> <span class="o">=</span> <span class="s1">&#39;barcode&#39;</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_REGEX</span> <span class="o">=</span> <span class="s1">&#39;regex&#39;</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;prefix&#39;</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_STRING</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
    <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_LIST</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>

    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">EXTERNAL_TYPE_REGULAR_EXPRESSION</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;External Type Regular Expression&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Derive a patron&#39;s type from their identifier.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Identifier Restriction Type&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;When multiple libraries share an ILS, a person may be able to &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;authenticate with the ILS but not be considered a patron of &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;&lt;em&gt;this&lt;/em&gt; library. This setting contains the rule for determining &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;whether an identifier is valid for this specific library. &lt;p/&gt; &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;If this setting it set to &#39;No Restriction&#39; then the values for &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;&lt;em&gt;Library Identifier Field&lt;/em&gt; and &lt;em&gt;Library Identifier &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;Restriction&lt;/em&gt; will not be used.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
             <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No restriction&quot;</span><span class="p">)},</span>
             <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_PREFIX</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Prefix Match&quot;</span><span class="p">)},</span>
             <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_STRING</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Exact Match&quot;</span><span class="p">)},</span>
             <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_REGEX</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Regex Match&quot;</span><span class="p">)},</span>
             <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_LIST</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Exact Match, comma separated list&quot;</span><span class="p">)},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_FIELD</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Identifier Field&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_BARCODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Barcode&quot;</span><span class="p">)},</span>
          <span class="p">],</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is the field on the patron record that the &lt;em&gt;Library Identifier Restriction &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;Type&lt;/em&gt; is applied to, different patron authentication methods provide different &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;values here. This value is not used if &lt;em&gt;Library Identifier Restriction Type&lt;/em&gt; &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;is set to &#39;No restriction&#39;.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION_BARCODE</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">LIBRARY_IDENTIFIER_RESTRICTION</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Identifier Restriction&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is the restriction applied to the &lt;em&gt;Library Identifier Field&lt;/em&gt; &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;using the method chosen in &lt;em&gt;Library Identifier Restriction Type&lt;/em&gt;. &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;This value is not used if &lt;em&gt;Library Identifier Restriction Type&lt;/em&gt; &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;is set to &#39;No restriction&#39;.&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Basic constructor.</span>

<span class="sd">        :param library: Patrons authenticated through this provider</span>
<span class="sd">        are associated with this Library. Don&#39;t store this object!</span>
<span class="sd">        It&#39;s associated with a scoped database session. Just pull</span>
<span class="sd">        normal Python objects out of it.</span>

<span class="sd">        :param integration: The ExternalIntegration that</span>
<span class="sd">        configures this AuthenticationProvider. Don&#39;t store this</span>
<span class="sd">        object! It&#39;s associated with a scoped database session. Just</span>
<span class="sd">        pull normal Python objects out of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">Library</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Expected library to be a Library, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Expected integration to be an ExternalIntegration, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">integration</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">analytics</span>
        <span class="c1"># If there&#39;s a regular expression that maps authorization</span>
        <span class="c1"># identifier to external type, find it now.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXTERNAL_TYPE_REGULAR_EXPRESSION</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">regexp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regexp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not configure external type regular expression: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
                <span class="p">)</span>
                <span class="n">regexp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_type_regular_expression</span> <span class="o">=</span> <span class="n">regexp</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_FIELD</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_field</span> <span class="o">=</span> <span class="n">field</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span>

        <span class="n">restriction</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_REGEX</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_LIST</span><span class="p">:</span>
            <span class="n">restriction</span> <span class="o">=</span> <span class="n">restriction</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">restriction</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restriction</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span> <span class="o">=</span> <span class="n">restriction</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span> <span class="o">=</span> <span class="n">restriction</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_restriction_matches</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">restriction</span><span class="p">,</span> <span class="n">match_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the given patron match the given library restriction restriction?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">restriction</span><span class="p">:</span>
            <span class="c1"># No restriction -- anything matches.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
            <span class="c1"># No field -- it won&#39;t match any restriction.</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">match_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_REGEX</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restriction</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">match_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_PREFIX</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">restriction</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">match_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_STRING</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">restriction</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">match_type</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_LIST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">restriction</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AuthenticationProvider.enforce_library_identifier_restriction"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.enforce_library_identifier_restriction">[docs]</a>    <span class="k">def</span> <span class="nf">enforce_library_identifier_restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the given patron match the configured library identifier restriction?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">==</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">library_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">patrondata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_TYPE_NONE</span><span class="p">:</span>
            <span class="c1"># No restriction to enforce.</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_field</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span><span class="p">:</span>
            <span class="c1"># Restriction field is blank, so everything matches.</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_RESTRICTION_BARCODE</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
                <span class="c1"># Get full patron information</span>
                <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_patron_lookup</span><span class="p">(</span><span class="n">patrondata</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">library_identifier</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restriction_matches</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_restriction_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">patrondata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AuthenticationProvider.library"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.library">[docs]</a>    <span class="k">def</span> <span class="nf">library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Library</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AuthenticationProvider.external_integration"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_integration_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AuthenticationProvider.authenticated_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.authenticated_patron">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go from a WWW-Authenticate header (or equivalent) to a Patron object.</span>

<span class="sd">        If the Patron needs to have their metadata updated, it happens</span>
<span class="sd">        transparently at this point.</span>

<span class="sd">        :return: A Patron if one can be authenticated; a ProblemDetail</span>
<span class="sd">            if an error occurs; None if the credentials are missing or wrong.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">patron</span>
        <span class="k">if</span> <span class="n">PatronUtility</span><span class="o">.</span><span class="n">needs_external_sync</span><span class="p">(</span><span class="n">patron</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_patron_metadata</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">patron</span></div>

<div class="viewcode-block" id="AuthenticationProvider.update_patron_metadata"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.update_patron_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">update_patron_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refresh our local record of this patron&#39;s account information.</span>

<span class="sd">        :param patron: A Patron object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remote_patron_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_patron_lookup</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_patron_info</span><span class="p">,</span> <span class="n">PatronData</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_patrondata</span><span class="p">(</span><span class="n">remote_patron_info</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span></div>

<div class="viewcode-block" id="AuthenticationProvider.update_patron_external_type"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.update_patron_external_type">[docs]</a>    <span class="k">def</span> <span class="nf">update_patron_external_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure the patron&#39;s external type reflects</span>
<span class="sd">        what external_type_regular_expression says.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_type_regular_expression</span><span class="p">:</span>
            <span class="c1"># External type is not determined by a regular expression.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
            <span class="c1"># Patron has no authorization identifier. Leave their</span>
            <span class="c1"># external_type alone.</span>
            <span class="k">return</span>

        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_type_regular_expression</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># Patron&#39;s authorization identifier doesn&#39;t match the</span>
            <span class="c1"># regular expression at all. Leave their external_type</span>
            <span class="c1"># alone.</span>
            <span class="k">return</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># The regular expression matched but didn&#39;t contain any groups.</span>
            <span class="c1"># This is a configuration error; do nothing.</span>
            <span class="k">return</span>

        <span class="n">patron</span><span class="o">.</span><span class="n">external_type</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="AuthenticationProvider.authenticate"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Authenticate a patron based on a WWW-Authenticate header</span>
<span class="sd">        (or equivalent).</span>

<span class="sd">        :return: A Patron if one can be authenticated; a ProblemDetail if an</span>
<span class="sd">            error occurs; None if the credentials are missing or wrong.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="AuthenticationProvider.get_credential_from_header"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.get_credential_from_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_credential_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a password credential from a WWW-Authenticate header</span>
<span class="sd">        (or equivalent).</span>

<span class="sd">        This is used to pass on a patron&#39;s credential to a content provider,</span>
<span class="sd">        such as Overdrive, which performs independent validation of</span>
<span class="sd">        a patron&#39;s credentials.</span>

<span class="sd">        :return: The patron&#39;s password, or None if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AuthenticationProvider.remote_patron_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.AuthenticationProvider.remote_patron_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_patrondata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask the remote for detailed information about a patron&#39;s account.</span>

<span class="sd">        This may be called in the course of authenticating a patron,</span>
<span class="sd">        or it may be called when the patron isn&#39;t around, for purposes</span>
<span class="sd">        of learning some personal information (primarily email</span>
<span class="sd">        address) that can&#39;t be stored in the database.</span>

<span class="sd">        The default implementation assumes there is no special</span>
<span class="sd">        lookup functionality, and returns exactly the information</span>
<span class="sd">        present in the object that was passed in.</span>

<span class="sd">        :param patron_or_patrondata: Either a Patron object, a PatronData</span>
<span class="sd">            object, or None (if no further information could be provided).</span>

<span class="sd">        :return: An updated PatronData object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron_or_patrondata</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_patrondata</span><span class="p">,</span> <span class="n">PatronData</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_patrondata</span><span class="p">,</span> <span class="n">Patron</span><span class="p">)):</span>



            <span class="k">return</span> <span class="n">patron_or_patrondata</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Unexpected object </span><span class="si">%r</span><span class="s2"> passed into remote_patron_lookup.&quot;</span> <span class="o">%</span>
            <span class="n">patron_or_patrondata</span>
        <span class="p">)</span></div>


    <span class="c1"># BasicAuthenticationProvider defines remote_patron_lookup to call this</span>
    <span class="c1"># method and then do something additional; by default, we want the core</span>
    <span class="c1"># lookup mechanism to work the same way as AuthenticationProvider.remote_patron_lookup.</span>

    <span class="n">_remote_patron_lookup</span> <span class="o">=</span> <span class="n">remote_patron_lookup</span>

    <span class="k">def</span> <span class="nf">_authentication_flow_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Authentication Flow object for use in an Authentication for</span>
<span class="sd">        OPDS document.</span>

<span class="sd">        :return: A dictionary suitable for inclusion as one of the</span>
<span class="sd">        &#39;authentication&#39; list in an Authentication for OPDS document.</span>

<span class="sd">        For example:</span>

<span class="sd">        {</span>
<span class="sd">          &quot;authentication&quot;: [</span>
<span class="sd">            { &quot;type&quot;: &quot;http://opds-spec.org/auth/basic&quot;,</span>
<span class="sd">              &quot;labels&quot;: {&quot;login&quot;: &quot;Barcode&quot;, &quot;password&quot;: &quot;PIN&quot;} }</span>
<span class="sd">          ]</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="BasicAuthenticationProvider"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider">[docs]</a><span class="k">class</span> <span class="nc">BasicAuthenticationProvider</span><span class="p">(</span><span class="n">AuthenticationProvider</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify a username/password, obtained through HTTP Basic Auth, with</span>
<span class="sd">    a remote source of truth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: Each subclass MUST define an attribute called NAME, which</span>
    <span class="c1"># is used to configure that subclass in the configuration file,</span>
    <span class="c1"># used to create the name of the log channel used by this</span>
    <span class="c1"># subclass, used to distinguish between tokens from different</span>
    <span class="c1"># OAuth providers, etc.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MAY override the default value for DISPLAY_NAME.</span>
    <span class="c1"># This becomes the human-readable name of the authentication</span>
    <span class="c1"># mechanism in the OPDS authentication document.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MAY override the default values for</span>
    <span class="c1"># DEFAULT_LOGIN_LABEL and DEFAULT_PASSWORD_LABEL. These become the</span>
    <span class="c1"># default human-readable labels for username and password in the</span>
    <span class="c1"># OPDS authentication document</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MAY override the default value for</span>
    <span class="c1"># AUTHENTICATION_REALM. This becomes the name of the HTTP Basic</span>
    <span class="c1"># Auth authentication realm.</span>
    <span class="c1">#</span>
    <span class="c1"># It&#39;s generally not necessary for a subclass to override URI, but</span>
    <span class="c1"># you might want to do it if your username/password doesn&#39;t fit</span>
    <span class="c1"># into the &#39;library barcode&#39; paradigm.</span>
    <span class="c1">#</span>
    <span class="c1"># It&#39;s probably not necessary for a subclass to override METHOD,</span>
    <span class="c1"># since the default indicates HTTP Basic Auth.</span>

    <span class="n">DISPLAY_NAME</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Barcode&quot;</span><span class="p">)</span>
    <span class="n">AUTHENTICATION_REALM</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library card&quot;</span><span class="p">)</span>
    <span class="n">FLOW_TYPE</span> <span class="o">=</span> <span class="s2">&quot;http://opds-spec.org/auth/basic&quot;</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s1">&#39;Generic Basic Authentication provider&#39;</span>

    <span class="c1"># By default, patron identifiers can only contain alphanumerics and</span>
    <span class="c1"># a few other characters. By default, there are no restrictions on</span>
    <span class="c1"># passwords.</span>
    <span class="n">alphanumerics_plus</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9@.-]+$&quot;</span><span class="p">)</span>
    <span class="n">DEFAULT_IDENTIFIER_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="n">alphanumerics_plus</span>
    <span class="n">DEFAULT_PASSWORD_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Configuration settings that are common to all Basic Auth-type</span>
    <span class="c1"># authentication techniques.</span>
    <span class="c1">#</span>

    <span class="c1"># Identifiers can be presumed invalid if they don&#39;t match</span>
    <span class="c1"># this regular expression.</span>
    <span class="n">IDENTIFIER_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;identifier_regular_expression&#39;</span>

    <span class="c1"># Passwords can be presumed invalid if they don&#39;t match this regular</span>
    <span class="c1"># expression.</span>
    <span class="n">PASSWORD_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;password_regular_expression&#39;</span>

    <span class="c1"># The client should prefer one keyboard over another.</span>
    <span class="n">IDENTIFIER_KEYBOARD</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;identifier_keyboard&#39;</span>
    <span class="n">PASSWORD_KEYBOARD</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;password_keyboard&#39;</span>

    <span class="c1"># Constants describing different types of keyboards.</span>
    <span class="n">DEFAULT_KEYBOARD</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Default&quot;</span>
    <span class="n">EMAIL_ADDRESS_KEYBOARD</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Email address&quot;</span>
    <span class="n">NUMBER_PAD</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Number pad&quot;</span>
    <span class="n">NULL_KEYBOARD</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;No input&quot;</span>

    <span class="c1"># The identifier and password can have a maximum</span>
    <span class="c1"># supported length.</span>
    <span class="n">IDENTIFIER_MAXIMUM_LENGTH</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;identifier_maximum_length&quot;</span>
    <span class="n">PASSWORD_MAXIMUM_LENGTH</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;password_maximum_length&quot;</span>

    <span class="c1"># The client should use a certain string when asking for a patron&#39;s</span>
    <span class="c1"># &quot;identifier&quot; and &quot;password&quot;</span>
    <span class="n">IDENTIFIER_LABEL</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;identifier_label&#39;</span>
    <span class="n">PASSWORD_LABEL</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;password_label&#39;</span>
    <span class="n">DEFAULT_IDENTIFIER_LABEL</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Barcode&quot;</span>
    <span class="n">DEFAULT_PASSWORD_LABEL</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;PIN&quot;</span>

    <span class="c1"># If the identifier label is one of these strings, it will be</span>
    <span class="c1"># automatically localized. Otherwise, the same label will be displayed</span>
    <span class="c1"># to everyone.</span>
    <span class="n">COMMON_IDENTIFIER_LABELS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">u</span><span class="s2">&quot;Barcode&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Barcode&quot;</span><span class="p">),</span>
        <span class="sa">u</span><span class="s2">&quot;Email Address&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Email Address&quot;</span><span class="p">),</span>
        <span class="sa">u</span><span class="s2">&quot;Username&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Username&quot;</span><span class="p">),</span>
        <span class="sa">u</span><span class="s2">&quot;Library Card&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Card&quot;</span><span class="p">),</span>
        <span class="sa">u</span><span class="s2">&quot;Card Number&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Card Number&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># If the password label is one of these strings, it will be</span>
    <span class="c1"># automatically localized. Otherwise, the same label will be</span>
    <span class="c1"># displayed to everyone.</span>
    <span class="n">COMMON_PASSWORD_LABELS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">u</span><span class="s2">&quot;Password&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">),</span>
        <span class="sa">u</span><span class="s2">&quot;PIN&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PIN&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">IDENTIFIER_BARCODE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;identifier_barcode_format&quot;</span>
    <span class="n">BARCODE_FORMAT_CODABAR</span> <span class="o">=</span> <span class="s2">&quot;Codabar&quot;</span> <span class="c1"># Constant defined in the extension</span>
    <span class="n">BARCODE_FORMAT_NONE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># These identifier and password are supposed to be valid</span>
    <span class="c1"># credentials.  If there&#39;s a problem using them, there&#39;s a problem</span>
    <span class="c1"># with the authenticator or with the way we have it configured.</span>
    <span class="n">TEST_IDENTIFIER</span> <span class="o">=</span> <span class="s1">&#39;test_identifier&#39;</span>
    <span class="n">TEST_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;test_password&#39;</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">TEST_IDENTIFIER</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Test Identifier&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A valid identifier that can be used to test that patron authentication is working.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">TEST_PASSWORD</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Test Password&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The password for the test identifier.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span> <span class="p">:</span> <span class="n">IDENTIFIER_BARCODE_FORMAT</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron identifier barcode format&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Many libraries render patron identifiers as barcodes on physical library cards. If you specify the barcode format, patrons will be able to scan their library cards with a camera instead of manually typing in their identifiers.&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">BARCODE_FORMAT_CODABAR</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron identifiers are are rendered as barcodes in Codabar format&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">BARCODE_FORMAT_NONE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron identifiers are not rendered as barcodes&quot;</span><span class="p">)</span> <span class="p">},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">BARCODE_FORMAT_NONE</span><span class="p">,</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">IDENTIFIER_REGULAR_EXPRESSION</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Identifier Regular Expression&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A patron&#39;s identifier will be immediately rejected if it doesn&#39;t match this regular expression.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">PASSWORD_REGULAR_EXPRESSION</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password Regular Expression&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A patron&#39;s password will be immediately rejected if it doesn&#39;t match this regular expression.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">IDENTIFIER_KEYBOARD</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Keyboard for identifier entry&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">DEFAULT_KEYBOARD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;System default&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">EMAIL_ADDRESS_KEYBOARD</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Email address entry&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NUMBER_PAD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Number pad&quot;</span><span class="p">)</span> <span class="p">},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">DEFAULT_KEYBOARD</span><span class="p">,</span>
          <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">PASSWORD_KEYBOARD</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Keyboard for password entry&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">DEFAULT_KEYBOARD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;System default&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NUMBER_PAD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Number pad&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NULL_KEYBOARD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patrons have no password and should not be prompted for one.&quot;</span><span class="p">)</span> <span class="p">},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">DEFAULT_KEYBOARD</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">IDENTIFIER_MAXIMUM_LENGTH</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Maximum identifier length&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">PASSWORD_MAXIMUM_LENGTH</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Maximum password length&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">IDENTIFIER_LABEL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Label for identifier entry&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">PASSWORD_LABEL</span><span class="p">,</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Label for password entry&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">AuthenticationProvider</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="c1"># Used in the constructor to signify that the default argument</span>
    <span class="c1"># value for the class should be used (as distinct from None, which</span>
    <span class="c1"># indicates that no value should be used.)</span>
    <span class="n">class_default</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a BasicAuthenticationProvider.</span>

<span class="sd">        :param library: Patrons authenticated through this provider</span>
<span class="sd">        are associated with this Library. Don&#39;t store this object!</span>
<span class="sd">        It&#39;s associated with a scoped database session. Just pull</span>
<span class="sd">        normal Python objects out of it.</span>

<span class="sd">        :param externalintegration: The ExternalIntegration that</span>
<span class="sd">        configures this AuthenticationProvider. Don&#39;t store this</span>
<span class="sd">        object! It&#39;s associated with a scoped database session. Just</span>
<span class="sd">        pull normal Python objects out of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BasicAuthenticationProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
        <span class="n">identifier_regular_expression</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_REGULAR_EXPRESSION</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_IDENTIFIER_REGULAR_EXPRESSION</span>

        <span class="k">if</span> <span class="n">identifier_regular_expression</span><span class="p">:</span>
            <span class="n">identifier_regular_expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="n">identifier_regular_expression</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_re</span> <span class="o">=</span> <span class="n">identifier_regular_expression</span>

        <span class="n">password_regular_expression</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PASSWORD_REGULAR_EXPRESSION</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_PASSWORD_REGULAR_EXPRESSION</span>
        <span class="k">if</span> <span class="n">password_regular_expression</span><span class="p">:</span>
            <span class="n">password_regular_expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="n">password_regular_expression</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_re</span> <span class="o">=</span> <span class="n">password_regular_expression</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_username</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_IDENTIFIER</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_password</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PASSWORD</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_maximum_length</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_MAXIMUM_LENGTH</span><span class="p">)</span><span class="o">.</span><span class="n">int_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_maximum_length</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PASSWORD_MAXIMUM_LENGTH</span><span class="p">)</span><span class="o">.</span><span class="n">int_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_keyboard</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_KEYBOARD</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_KEYBOARD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_keyboard</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PASSWORD_KEYBOARD</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_KEYBOARD</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_barcode_format</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_BARCODE_FORMAT</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">BARCODE_FORMAT_NONE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_label</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_IDENTIFIER_LABEL</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_label</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PASSWORD_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_PASSWORD_LABEL</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BasicAuthenticationProvider.remote_patron_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.remote_patron_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_patrondata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask the remote for information about this patron, and then make sure</span>
<span class="sd">        the patron belongs to the library associated with thie BasicAuthenticationProvider.&quot;&quot;&quot;</span>

        <span class="n">patron_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_patron_lookup</span><span class="p">(</span><span class="n">patron_or_patrondata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patron_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_library_identifier_restriction</span><span class="p">(</span><span class="n">patron_info</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">patron_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">patron_info</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collects_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does this BasicAuthenticationProvider expect a username</span>
<span class="sd">        and a password, or just a username?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_keyboard</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL_KEYBOARD</span>

<div class="viewcode-block" id="BasicAuthenticationProvider.testing_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.testing_patron">[docs]</a>    <span class="k">def</span> <span class="nf">testing_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up a Patron object reserved for testing purposes.</span>

<span class="sd">        :return: A 2-tuple (Patron, password)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_password</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_password</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_patron</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">header</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_password</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.testing_patron_or_bust"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.testing_patron_or_bust">[docs]</a>    <span class="k">def</span> <span class="nf">testing_patron_or_bust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up the Patron object reserved for testing purposes,</span>
<span class="sd">        raising CannotLoadConfiguration if none is configured.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;No test patron identifier is configured.&quot;</span>
            <span class="p">)</span>

        <span class="n">patron</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing_patron</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="p">:</span>
            <span class="c1"># We ran to completion but ended up with no patron.</span>
            <span class="k">raise</span> <span class="n">IntegrationException</span><span class="p">(</span>
                <span class="s2">&quot;Remote declined to authenticate the test patron.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The patron may not exist or its password may be wrong.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">patron</span><span class="p">,</span> <span class="n">password</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the credentials of the test patron for this integration,</span>
<span class="sd">        and update its metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Authenticating test patron&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing_patron_or_bust</span><span class="p">,</span> <span class="n">_db</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">patron_test</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron_test</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># We can&#39;t run the rest of the tests.</span>
            <span class="k">return</span>

        <span class="n">patron</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">patron_test</span><span class="o">.</span><span class="n">result</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Syncing patron metadata&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_patron_metadata</span><span class="p">,</span>
            <span class="n">patron</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BasicAuthenticationProvider.authenticate"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a set of credentials into a Patron object.</span>

<span class="sd">        :param credentials: A dictionary with keys `username` and `password`.</span>

<span class="sd">        :return: A Patron if one can be authenticated; a ProblemDetail</span>
<span class="sd">            if an error occurs; None if the credentials are missing or wrong.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="n">server_side_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_side_validation</span><span class="p">(</span>
            <span class="n">username</span><span class="p">,</span> <span class="n">password</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_side_validation_result</span><span class="p">:</span>
            <span class="c1"># False =&gt; None</span>
            <span class="n">server_side_validation_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">server_side_validation_result</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server_side_validation_result</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">)):</span>
            <span class="c1"># The credentials are prima facie invalid and do not</span>
            <span class="c1"># need to be checked with the source of truth.</span>
            <span class="k">return</span> <span class="n">server_side_validation_result</span>

        <span class="c1"># Check these credentials with the source of truth.</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="c1"># Either an error occured or the credentials did not correspond</span>
            <span class="c1"># to any patron.</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="c1"># Check that the patron belongs to this library.</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_library_identifier_restriction</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PATRON_OF_ANOTHER_LIBRARY</span>

        <span class="c1"># At this point we know there is _some_ authenticated patron,</span>
        <span class="c1"># but it might not correspond to a Patron in our database, and</span>
        <span class="c1"># if it does, that Patron&#39;s authorization_identifier might be</span>
        <span class="c1"># different from the `username` passed in as part of the</span>
        <span class="c1"># credentials.</span>

        <span class="c1"># First, try to look up the Patron object in our database.</span>
        <span class="n">patron</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_patron_lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patron</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">patrondata</span><span class="o">.</span><span class="n">complete</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">PatronUtility</span><span class="o">.</span><span class="n">needs_external_sync</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># We found them! And there is no need to do a separate</span>
            <span class="c1"># lookup for purposes of external sync -- either because</span>
            <span class="c1"># they don&#39;t need to be synced or because we got a</span>
            <span class="c1"># complete PatronData as a side effect of the authentication</span>
            <span class="c1"># check.</span>
            <span class="c1">#</span>
            <span class="c1"># Just make sure our local data is up to date with</span>
            <span class="c1"># whatever we just got from remote.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_patrondata</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">patron</span>

        <span class="c1"># At this point there are two possibilities:</span>
        <span class="c1">#</span>
        <span class="c1"># 1. We didn&#39;t find them. Now the question is: _why_ didn&#39;t</span>
        <span class="c1"># the patron show up locally? Have we never seen them before</span>
        <span class="c1"># or has their authorization identifier changed?</span>
        <span class="c1">#</span>
        <span class="c1"># 2. We found them, they need an external sync, and we found</span>
        <span class="c1"># them in a way that didn&#39;t provide that information.</span>
        <span class="c1">#</span>
        <span class="c1"># In both cases, the next step is to look up the patron&#39;s</span>
        <span class="c1"># account details remotely. In some providers this step may</span>
        <span class="c1"># be a no-op. But we have to try it, because if the patron&#39;s</span>
        <span class="c1"># account details are out of sync, the rest of the request (the</span>
        <span class="c1"># thing they&#39;re actually trying to do) might fail.</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_patron_lookup</span><span class="p">(</span><span class="n">patrondata</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="c1"># Either there was a problem looking up the patron data, or</span>
            <span class="c1"># the patron does not exist on the remote. How we passed</span>
            <span class="c1"># remote validation is a mystery, but ours not to reason</span>
            <span class="c1"># why. There is no authenticated patron.</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="c1"># For whatever reason, the remote lookup implementation</span>
            <span class="c1"># returned a Patron object instead of a PatronData. Just</span>
            <span class="c1"># use that Patron object.</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="c1"># At this point we have a _complete_ PatronData object which we</span>
        <span class="c1"># know represents an existing patron on the remote side. Try</span>
        <span class="c1"># the local lookup again.</span>
        <span class="n">patron</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_patron_lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span><span class="p">:</span>
            <span class="c1"># We have a PatronData from the ILS that does not</span>
            <span class="c1"># correspond to any local Patron. Create the local Patron.</span>
            <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">get_or_create_patron</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analytics</span>
            <span class="p">)</span>

        <span class="c1"># The lookup failed in the first place either because the</span>
        <span class="c1"># Patron did not exist on the local side, or because one of</span>
        <span class="c1"># the patron&#39;s identifiers changed; or, the lookup succeeded</span>
        <span class="c1"># but we needed to do a separate validation step. Either way,</span>
        <span class="c1"># we now need to update the Patron record with the account</span>
        <span class="c1"># information we just got from the source of truth.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_patrondata</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">patron</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.apply_patrondata"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.apply_patrondata">[docs]</a>    <span class="k">def</span> <span class="nf">apply_patrondata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a PatronData object to the given patron and make sure</span>
<span class="sd">        any fields that need to be updated as a result of new data</span>
<span class="sd">        are updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patrondata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_type_regular_expression</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_patron_external_type</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.get_credential_from_header"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.get_credential_from_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_credential_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a password credential from a WWW-Authenticate header</span>
<span class="sd">        (or equivalent).</span>

<span class="sd">        This is used to pass on a patron&#39;s credential to a content provider,</span>
<span class="sd">        such as Overdrive, which performs independent validation of</span>
<span class="sd">        a patron&#39;s credentials.</span>

<span class="sd">        :param header: A dictionary with keys `username` and `password`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.server_side_validation"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.server_side_validation">[docs]</a>    <span class="k">def</span> <span class="nf">server_side_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do these credentials even look right?</span>

<span class="sd">        Sometimes egregious problems can be caught without needing to</span>
<span class="sd">        check with the ILS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_re</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifier_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collects_password</span><span class="p">:</span>
            <span class="c1"># The only legal password is an empty one.</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_re</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">password_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_maximum_length</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_maximum_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_maximum_length</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_maximum_length</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">valid</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.remote_authenticate"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.remote_authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">remote_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the source of truth approve of these credentials?</span>

<span class="sd">        :return: If the credentials are valid, but nothing more is</span>
<span class="sd">            known about the patron, return True.</span>

<span class="sd">        If the credentials are valid, _and_ enough information came</span>
<span class="sd">        back in the request to also create a PatronInfo object, you</span>
<span class="sd">        may create that object and return it to save a</span>
<span class="sd">        remote patron lookup later.</span>

<span class="sd">        If the credentials are invalid, return False or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="BasicAuthenticationProvider.local_patron_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.BasicAuthenticationProvider.local_patron_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">local_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to find a Patron object in the local database.</span>

<span class="sd">        :param username: An HTTP Basic Auth username. May or may not</span>
<span class="sd">            correspond to the `Patron.username` field.</span>

<span class="sd">        :param patrondata: A PatronData object recently obtained from</span>
<span class="sd">            the source of truth, possibly as a side effect of validating</span>
<span class="sd">            the username and password. This may make it possible to</span>
<span class="sd">            identify the patron more precisely. Or it may be None, in</span>
<span class="sd">            which case it&#39;s no help at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We&#39;re going to try a number of different strategies to look</span>
        <span class="c1"># up the appropriate patron based on PatronData. In theory we</span>
        <span class="c1"># could employ all these strategies at once (see the code at</span>
        <span class="c1"># the end of this method), but if the source of truth is</span>
        <span class="c1"># well-behaved, the first available lookup should work, and if</span>
        <span class="c1"># it&#39;s not, it&#39;s better to check the more reliable mechanisms</span>
        <span class="c1"># before the less reliable.</span>
        <span class="n">lookups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">patrondata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">:</span>
                <span class="c1"># Permanent ID is the most reliable way of identifying</span>
                <span class="c1"># a patron, since this is supposed to be an internal</span>
                <span class="c1"># ID that never changes.</span>
                <span class="n">lookups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">external_identifier</span><span class="o">=</span><span class="n">patrondata</span><span class="o">.</span><span class="n">permanent_id</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
                <span class="c1"># Username is fairly reliable, since the patron</span>
                <span class="c1"># generally has to decide to change it.</span>
                <span class="n">lookups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">patrondata</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
                <span class="c1"># Authorization identifiers change all the time so</span>
                <span class="c1"># they&#39;re not terribly reliable.</span>
                <span class="n">lookups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">authorization_identifier</span><span class="o">=</span>
                        <span class="n">patrondata</span><span class="o">.</span><span class="n">authorization_identifier</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">patron</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">lookups</span><span class="p">:</span>
            <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;library_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span>
            <span class="n">patron</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Patron</span><span class="p">,</span> <span class="o">**</span><span class="n">lookup</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">patron</span><span class="p">:</span>
                <span class="c1"># We found them!</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron</span> <span class="ow">and</span> <span class="n">username</span><span class="p">:</span>
            <span class="c1"># This is a Basic Auth username, but it might correspond</span>
            <span class="c1"># to either Patron.authorization_identifier or</span>
            <span class="c1"># Patron.username.</span>
            <span class="c1">#</span>
            <span class="c1"># NOTE: If patrons are allowed to choose their own</span>
            <span class="c1"># usernames, it&#39;s possible that a username and</span>
            <span class="c1"># authorization_identifier can conflict. In that case it&#39;s</span>
            <span class="c1"># undefined which Patron is returned from this query. If</span>
            <span class="c1"># this happens, it&#39;s a problem with the ILS and needs to</span>
            <span class="c1"># be resolved over there.</span>
            <span class="n">clause</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span><span class="n">Patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="o">==</span><span class="n">username</span><span class="p">,</span>
                         <span class="n">Patron</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">username</span><span class="p">)</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Patron</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Patron</span><span class="o">.</span><span class="n">library_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">patron</span> <span class="o">=</span> <span class="n">qu</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
                <span class="n">patron</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">patron</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authentication_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Basic realm=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTHENTICATION_REALM</span>

    <span class="k">def</span> <span class="nf">_authentication_flow_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Authentication Flow object for use in an Authentication for</span>
<span class="sd">        OPDS document.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">login_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keyboard</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier_keyboard</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_maximum_length</span><span class="p">:</span>
            <span class="n">login_inputs</span><span class="p">[</span><span class="s1">&#39;maximum_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_maximum_length</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_barcode_format</span><span class="p">:</span>
            <span class="n">login_inputs</span><span class="p">[</span><span class="s1">&#39;barcode_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_barcode_format</span>

        <span class="n">password_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keyboard</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password_keyboard</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_maximum_length</span><span class="p">:</span>
            <span class="n">password_inputs</span><span class="p">[</span><span class="s1">&#39;maximum_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_maximum_length</span>

        <span class="c1"># Localize the labels if possible.</span>
        <span class="n">localized_identifier_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMMON_IDENTIFIER_LABELS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_label</span>
        <span class="p">)</span>
        <span class="n">localized_password_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMMON_PASSWORD_LABELS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password_label</span>
        <span class="p">)</span>
        <span class="n">flow_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISPLAY_NAME</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">login</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="n">localized_identifier_label</span><span class="p">),</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="n">localized_password_label</span><span class="p">)),</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">login</span><span class="o">=</span><span class="n">login_inputs</span><span class="p">,</span>
                          <span class="n">password</span><span class="o">=</span><span class="n">password_inputs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_BUTTON_IMAGE</span><span class="p">:</span>
            <span class="c1"># TODO: I&#39;m not sure if logo is appropriate for this, since it&#39;s a button</span>
            <span class="c1"># with the logo on it rather than a plain logo. Perhaps we should use plain</span>
            <span class="c1"># logos instead.</span>
            <span class="n">flow_doc</span><span class="p">[</span><span class="s2">&quot;links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;logo&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;static_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_BUTTON_IMAGE</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">flow_doc</span></div>


<div class="viewcode-block" id="OAuthAuthenticationProvider"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider">[docs]</a><span class="k">class</span> <span class="nc">OAuthAuthenticationProvider</span><span class="p">(</span><span class="n">AuthenticationProvider</span><span class="p">):</span>

    <span class="c1"># NOTE: Each subclass must define URI as per</span>
    <span class="c1"># AuthenticationProvider superclass. This is the URI used to</span>
    <span class="c1"># identify this particular authentication provider.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MAY define a value for FLOW_TYPE. This is the URI</span>
    <span class="c1"># used to identify the authentication mechanism in Authentication</span>
    <span class="c1"># For OPDS documents. The default is used to indicate the Library</span>
    <span class="c1"># Simplified variant of OAuth.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MUST define an attribute called</span>
    <span class="c1"># NAME, which is the name used to configure that</span>
    <span class="c1"># subclass in the configuration file. Failure to define this</span>
    <span class="c1"># attribute will result in an error in the constructor.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MUST define an attribute called TOKEN_TYPE, which</span>
    <span class="c1"># is the name used in the database to distinguish this provider&#39;s</span>
    <span class="c1"># tokens from other provider&#39;s tokens.</span>
    <span class="c1">#</span>
    <span class="c1"># Each subclass MUST define an attribute called</span>
    <span class="c1"># TOKEN_DATA_SOURCE_NAME, which is the name of the DataSource</span>
    <span class="c1"># under which bearer tokens for patrons will be registered.</span>

    <span class="c1"># Finally, each subclass MUST define an attribute called</span>
    <span class="c1"># EXTERNAL_AUTHENTICATE_URL. When the patron hits the</span>
    <span class="c1"># oauth_authentication_redirect controller, they will be</span>
    <span class="c1"># redirected to this URL on the OAuth provider&#39;s site.</span>
    <span class="c1">#</span>
    <span class="c1"># This URL template MUST contain Python variable interpolations</span>
    <span class="c1"># for &#39;client_id&#39;, &#39;oauth_callback_url&#39;, &#39;state&#39;. This way the</span>
    <span class="c1"># OAuth provider knows which client is asking to authenticate a</span>
    <span class="c1"># user, and it knows to send the client back to our</span>
    <span class="c1"># oauth_authentication_callback controller. Finally, the</span>
    <span class="c1"># oauth_callback controller can maintain any state from the</span>
    <span class="c1"># initial request to oauth_authentication_redirect.</span>
    <span class="c1">#</span>
    <span class="c1"># As an example, here&#39;s the EXTERNAL_AUTHENTICATE_URL for the</span>
    <span class="c1"># Clever OAuth provider:</span>
    <span class="c1">#</span>
    <span class="c1"># EXTERNAL_AUTHENTICATE_URL = &quot;https://clever.com/oauth/authorize?response_type=code&amp;client_id=%(client_id)s&amp;redirect_uri=%(oauth_callback_url)s&amp;state=%(state)s&quot;</span>

    <span class="n">FLOW_TYPE</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/authtype/OAuth-with-intermediary&quot;</span>

    <span class="c1"># After verifying the patron&#39;s OAuth credentials, we send them a</span>
    <span class="c1"># token. This configuration setting controls how long they can use</span>
    <span class="c1"># that token before we check their OAuth credentials again.</span>
    <span class="n">OAUTH_TOKEN_EXPIRATION_DAYS</span> <span class="o">=</span> <span class="s1">&#39;token_expiration_days&#39;</span>

    <span class="c1"># This is the default value for that configuration setting.</span>
    <span class="n">DEFAULT_TOKEN_EXPIRATION_DAYS</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">OAUTH_TOKEN_EXPIRATION_DAYS</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Days until OAuth token expires&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">AuthenticationProvider</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="c1"># Name of the site-wide ConfigurationSetting containing the secret</span>
    <span class="c1"># used to sign bearer tokens.</span>
    <span class="n">BEARER_TOKEN_SIGNING_SECRET</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">BEARER_TOKEN_SIGNING_SECRET</span>

<div class="viewcode-block" id="OAuthAuthenticationProvider.bearer_token_signing_secret"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.bearer_token_signing_secret">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bearer_token_signing_secret</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find or generate the site-wide bearer token signing secret.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">sitewide_secret</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">BEARER_TOKEN_SIGNING_SECRET</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize this OAuthAuthenticationProvider.</span>

<span class="sd">        :param library: Patrons authenticated through this provider</span>
<span class="sd">            are associated with this Library. Don&#39;t store this object!</span>
<span class="sd">            It&#39;s associated with a scoped database session. Just pull</span>
<span class="sd">            normal Python objects out of it.</span>
<span class="sd">        :param externalintegration: The ExternalIntegration that</span>
<span class="sd">            configures this AuthenticationProvider. Don&#39;t store this</span>
<span class="sd">            object! It&#39;s associated with a scoped database session. Just</span>
<span class="sd">            pull normal Python objects out of it.</span>
<span class="sd">        :param client_id: An ID given to us by the OAuth provider, used</span>
<span class="sd">            to distinguish between us and its other clients.</span>
<span class="sd">        :param client_secret: A secret key given to us by the OAuth</span>
<span class="sd">            provider, used to validate that we are who we say we are.</span>
<span class="sd">        :param token_expiration_days: This many days may elapse before</span>
<span class="sd">            we ask the patron to go through the OAuth validation</span>
<span class="sd">            process again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OAuthAuthenticationProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_expiration_days</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OAUTH_TOKEN_EXPIRATION_DAYS</span>
        <span class="p">)</span><span class="o">.</span><span class="n">int_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_TOKEN_EXPIRATION_DAYS</span>

<div class="viewcode-block" id="OAuthAuthenticationProvider.authenticated_patron"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.authenticated_patron">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go from an OAuth provider token to an authenticated Patron.</span>

<span class="sd">        :param token: The provider token extracted from the Authorization</span>
<span class="sd">            header. This is _not_ the bearer token found in</span>
<span class="sd">            the Authorization header; it&#39;s the provider-specific token</span>
<span class="sd">            embedded in that token.</span>

<span class="sd">        :return: A Patron, if one can be authenticated. None, if the</span>
<span class="sd">            credentials do not authenticate any particular patron. A</span>
<span class="sd">            ProblemDetail if an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_source</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">Credential</span><span class="o">.</span><span class="n">lookup_by_token</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_TYPE</span><span class="p">,</span> <span class="n">token</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">credential</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">credential</span><span class="o">.</span><span class="n">patron</span>

        <span class="c1"># This token wasn&#39;t in our database, or was expired. The</span>
        <span class="c1"># patron will have to log in through the OAuth provider again</span>
        <span class="c1"># to get a new token.</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OAuthAuthenticationProvider.create_token"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.create_token">[docs]</a>    <span class="k">def</span> <span class="nf">create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Credential object that ties the given patron to the</span>
<span class="sd">        given provider token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_source</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_data_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_expiration_days</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Credential</span><span class="o">.</span><span class="n">temporary_token_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_TYPE</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">token</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_patrondata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask the remote for detailed information about a patron&#39;s account.</span>

<span class="sd">        By default, there is no way to ask an OAuth provider for</span>
<span class="sd">        information about a specific patron after the fact.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="OAuthAuthenticationProvider.external_authenticate_url"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.external_authenticate_url">[docs]</a>    <span class="k">def</span> <span class="nf">external_authenticate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the URL provided by the OAuth provider which will present</span>
<span class="sd">        the patron with a login form.</span>

<span class="sd">        :param state: A state variable to be propagated through to the OAuth</span>
<span class="sd">            callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXTERNAL_AUTHENTICATE_URL</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_authenticate_url_parameters</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">arguments</span></div>

<div class="viewcode-block" id="OAuthAuthenticationProvider.external_authenticate_url_parameters"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.external_authenticate_url_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">external_authenticate_url_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Arguments used to fill in the template EXTERNAL_AUTHENTICATE_URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library_short_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">short_name</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="c1"># When the patron finishes logging in to the OAuth provider,</span>
            <span class="c1"># we want them to send the patron to this URL.</span>
            <span class="n">oauth_callback_url</span><span class="o">=</span><span class="n">OAuthController</span><span class="o">.</span><span class="n">oauth_authentication_callback_url</span><span class="p">(</span><span class="n">library_short_name</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="OAuthAuthenticationProvider.oauth_callback"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.oauth_callback">[docs]</a>    <span class="k">def</span> <span class="nf">oauth_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the incoming parameters with the OAuth provider. Exchange</span>
<span class="sd">        the authorization code for an access token. Create or look up</span>
<span class="sd">        appropriate database records.</span>

<span class="sd">        :param code: The authorization code generated by the</span>
<span class="sd">            authorization server, as per section 4.1.2 of RFC 6749. This</span>
<span class="sd">            method will exchange the authorization code for an access token.</span>

<span class="sd">        :return: A ProblemDetail if there&#39;s a problem. Otherwise, a</span>
<span class="sd">            3-tuple (Credential, Patron, PatronData). The Credential</span>
<span class="sd">            contains the access token provided by the OAuth provider. The</span>
<span class="sd">            Patron object represents the authenticated Patron, and the</span>
<span class="sd">            PatronData object includes information about the patron</span>
<span class="sd">            obtained from the OAuth provider which cannot be stored in the</span>
<span class="sd">            circulation manager&#39;s database, but which should be passed on</span>
<span class="sd">            to the client.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ask the OAuth provider to verify the code that was passed</span>
        <span class="c1"># in.  This will give us an access token we can use to look up</span>
        <span class="c1"># detailed patron information.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_exchange_code_for_access_token</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">token</span>

        <span class="c1"># Now that we have a bearer token, use it to look up patron</span>
        <span class="c1"># information.</span>
        <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_patron_lookup</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patrondata</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">authorization_identifiers</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_library_identifier_restriction</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">patrondata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">patrondata</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># None of the patron&#39;s authorization identifiers match.</span>
            <span class="c1"># This patron was able to validate with the OAuth provider,</span>
            <span class="c1"># but they are not a patron of _this_ library.</span>
            <span class="k">return</span> <span class="n">PATRON_OF_ANOTHER_LIBRARY</span>

        <span class="c1"># Convert the PatronData into a Patron object.</span>
        <span class="n">patron</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">patrondata</span><span class="o">.</span><span class="n">get_or_create_patron</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analytics</span>
        <span class="p">)</span>

        <span class="c1"># Create a credential for the Patron.</span>
        <span class="n">credential</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_token</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">credential</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">patrondata</span></div>

<div class="viewcode-block" id="OAuthAuthenticationProvider.remote_exchange_authorization_code_for_access_token"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.remote_exchange_authorization_code_for_access_token">[docs]</a>    <span class="k">def</span> <span class="nf">remote_exchange_authorization_code_for_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask the OAuth provider to convert a code (passed in to the OAuth</span>
<span class="sd">        callback) into a bearer token.</span>

<span class="sd">        We can use the bearer token to act on behalf of a specific</span>
<span class="sd">        patron. It also gives us confidence that the patron</span>
<span class="sd">        authenticated correctly with the OAuth provider.</span>

<span class="sd">        :return: A ProblemDetail if there&#39;s a problem; otherwise, the</span>
<span class="sd">            bearer token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="OAuthAuthenticationProvider.remote_patron_lookup"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.remote_patron_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use a bearer token to look up as much information as possible about</span>
<span class="sd">        a patron.</span>

<span class="sd">        :return: A ProblemDetail if there&#39;s a problem. Otherwise, a PatronData.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_internal_authenticate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A patron who wants to log in should hit this URL on the circulation</span>
<span class="sd">        manager. They&#39;ll be redirected to the OAuth provider, which will</span>
<span class="sd">        take care of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;oauth_authenticate&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
                       <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_authentication_flow_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Authentication Flow object for use in an Authentication for</span>
<span class="sd">        OPDS document.</span>

<span class="sd">        Example:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;type&quot;: &quot;http://librarysimplified.org/authtype/OAuth-with-intermediary&quot;</span>
<span class="sd">            &quot;description&quot;: &quot;My OAuth Provider&quot;,</span>
<span class="sd">            &quot;links&quot;: [</span>
<span class="sd">              { &quot;rel&quot; : &quot;authenticate&quot;</span>
<span class="sd">                &quot;href&quot;: &quot;https://circulation.library.org/oauth_authenticate?provider=MyOAuth&quot; }</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flow_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;authenticate&quot;</span><span class="p">,</span>
                        <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_authenticate_url</span><span class="p">(</span><span class="n">_db</span><span class="p">))]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_BUTTON_IMAGE</span><span class="p">:</span>
            <span class="c1"># TODO: I&#39;m not sure if logo is appropriate for this, since it&#39;s a button</span>
            <span class="c1"># with the logo on it rather than a plain logo. Perhaps we should use plain</span>
            <span class="c1"># logos instead.</span>
            <span class="n">flow_doc</span><span class="p">[</span><span class="s2">&quot;links&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;logo&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;static_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_BUTTON_IMAGE</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">flow_doc</span>

<div class="viewcode-block" id="OAuthAuthenticationProvider.token_data_source"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthAuthenticationProvider.token_data_source">[docs]</a>    <span class="k">def</span> <span class="nf">token_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_DATA_SOURCE_NAME</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="OAuthController"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthController">[docs]</a><span class="k">class</span> <span class="nc">OAuthController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A controller for handling requests that are part of the OAuth</span>
<span class="sd">    credential dance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>

<div class="viewcode-block" id="OAuthController.oauth_authentication_callback_url"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthController.oauth_authentication_callback_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">oauth_authentication_callback_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">library_short_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The URL to the oauth_authentication_callback controller.</span>

<span class="sd">        This is its own method because sometimes an</span>
<span class="sd">        OAuthAuthenticationProvider needs to send it to the OAuth</span>
<span class="sd">        provider to demonstrate that it knows which URL a patron was</span>
<span class="sd">        redirected to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;oauth_callback&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="n">library_short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAuthController.oauth_authentication_redirect"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthController.oauth_authentication_redirect">[docs]</a>    <span class="k">def</span> <span class="nf">oauth_authentication_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirect an unauthenticated patron to the authentication URL of the</span>
<span class="sd">        appropriate OAuth provider.</span>

<span class="sd">        Over on that other site, the patron will authenticate and be</span>
<span class="sd">        redirected back to the circulation manager, ending up in</span>
<span class="sd">        oauth_authentication_callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticator</span><span class="o">.</span><span class="n">oauth_provider_lookup</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redirect_with_error</span><span class="p">(</span><span class="n">redirect_uri</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="n">redirect_uri</span>
        <span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">external_authenticate_url</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">_db</span><span class="p">))</span></div>

<div class="viewcode-block" id="OAuthController.oauth_authentication_callback"><a class="viewcode-back" href="../../api.html#api.authenticator.OAuthController.oauth_authentication_callback">[docs]</a>    <span class="k">def</span> <span class="nf">oauth_authentication_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Patron object and a bearer token for a patron who has just</span>
<span class="sd">        authenticated with one of our OAuth providers.</span>

<span class="sd">        :return: A redirect to the `redirect_uri` kept in</span>
<span class="sd">            `params[&#39;state&#39;]`, with the bearer token encoded into the</span>
<span class="sd">            fragment identifier as `access_token` and useful information</span>
<span class="sd">            about the patron encoded into the fragment identifier as</span>
<span class="sd">            `patron_info`. For example, if params is</span>

<span class="sd">            dict(state=&quot;http://oauthprovider.org/success&quot;)</span>

<span class="sd">        Then the redirect URI might be:</span>

<span class="sd">            http://oauthprovider.org/success#access_token=1234&amp;patron_info=%7B%22name%22%3A+%22Mary+Shell%22%7D</span>

<span class="sd">        It&#39;s the client&#39;s responsibility to extract the access_token,</span>
<span class="sd">        start using it as a bearer token, and make sense of the</span>
<span class="sd">        patron_info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">INVALID_OAUTH_CALLBACK_PARAMETERS</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="n">client_redirect_uri</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticator</span><span class="o">.</span><span class="n">oauth_provider_lookup</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redirect_with_error</span><span class="p">(</span><span class="n">client_redirect_uri</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>

        <span class="c1"># Send the incoming parameters to the OAuth provider and get</span>
        <span class="c1"># back a provider token (a Credential object), the</span>
        <span class="c1"># authenticated patron (a Patron object), and a PatronData</span>
        <span class="c1"># including any personal information obtained from the OAuth</span>
        <span class="c1"># provider (such as patron name) which we can&#39;t store in the</span>
        <span class="c1"># database.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">oauth_callback</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ProblemDetail</span><span class="p">):</span>
            <span class="c1"># Most likely the OAuth provider didn&#39;t like the credentials</span>
            <span class="c1"># we sent.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redirect_with_error</span><span class="p">(</span>
                <span class="n">client_redirect_uri</span><span class="p">,</span> <span class="n">response</span>
            <span class="p">)</span>
        <span class="n">provider_token</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">patrondata</span> <span class="o">=</span> <span class="n">response</span>

        <span class="c1"># Turn the provider token into a bearer token we can give to</span>
        <span class="c1"># the patron.</span>
        <span class="n">simplified_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticator</span><span class="o">.</span><span class="n">create_bearer_token</span><span class="p">(</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">provider_token</span><span class="o">.</span><span class="n">credential</span>
        <span class="p">)</span>

        <span class="n">patron_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">patrondata</span><span class="o">.</span><span class="n">to_response_parameters</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">simplified_token</span><span class="p">,</span>
            <span class="n">patron_info</span><span class="o">=</span><span class="n">patron_info</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">client_redirect_uri</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_redirect_with_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">pd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirect the patron to the given URL, with the given ProblemDetail</span>
<span class="sd">        encoded into the fragment identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_uri</span><span class="p">(</span><span class="n">redirect_uri</span><span class="p">,</span> <span class="n">pd</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_error_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">,</span> <span class="n">pd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encode the given ProblemDetail into the fragment identifier</span>
<span class="sd">        of the given URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">problem_detail_json</span> <span class="o">=</span> <span class="n">pd_json</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">debug_message</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">problem_detail_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect_uri</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>