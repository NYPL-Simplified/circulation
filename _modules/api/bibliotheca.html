
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.bibliotheca &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.bibliotheca</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="n">set_trace</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">web_publication_manifest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FindawayManifest</span><span class="p">,</span>
    <span class="n">SpineItem</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">circulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FulfillmentInfo</span><span class="p">,</span>
    <span class="n">HoldInfo</span><span class="p">,</span>
    <span class="n">LoanInfo</span><span class="p">,</span>
    <span class="n">BaseCirculationAPI</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">selftest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HasSelfTests</span><span class="p">,</span>
    <span class="n">SelfTestResult</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">Hold</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">Measurement</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Timestamp</span><span class="p">,</span>
    <span class="n">WorkCoverageRecord</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">temp_config</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.coverage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BibliographicCoverageProvider</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.monitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionMonitor</span><span class="p">,</span>
    <span class="n">IdentifierSweepMonitor</span><span class="p">,</span>
    <span class="n">TimelineMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.xmlparser</span> <span class="kn">import</span> <span class="n">XMLParser</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BadResponseException</span><span class="p">,</span>
    <span class="n">HTTP</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">circulation_exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">core.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>

<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContributorData</span><span class="p">,</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">Metadata</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">IdentifierData</span><span class="p">,</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">MeasurementData</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">SubjectData</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">DatabaseTest</span>

<div class="viewcode-block" id="BibliothecaAPI"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaAPI</span><span class="p">(</span><span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>
    <span class="n">AUTH_TIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span>
    <span class="n">ARGUMENT_TIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span>
    <span class="n">AUTHORIZATION_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;3MCLAUTH </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span>

    <span class="n">DATETIME_HEADER</span> <span class="o">=</span> <span class="s2">&quot;3mcl-Datetime&quot;</span>
    <span class="n">AUTHORIZATION_HEADER</span> <span class="o">=</span> <span class="s2">&quot;3mcl-Authorization&quot;</span>
    <span class="n">VERSION_HEADER</span> <span class="o">=</span> <span class="s2">&quot;3mcl-Version&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Bibliotheca API&quot;</span><span class="p">)</span>

    <span class="n">DEFAULT_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
    <span class="n">DEFAULT_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://partner.yourcloudlibrary.com/&quot;</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Account ID&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Account Key&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library ID&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">DEFAULT_LOAN_DURATION_SETTING</span>
    <span class="p">]</span>

    <span class="n">MAX_AGE</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">730</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
    <span class="n">CAN_REVOKE_HOLD_WHEN_RESERVED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">SET_DELIVERY_MECHANISM_AT</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Bibliotheca&quot;</span>

    <span class="c1"># Create a lookup table between common DeliveryMechanism identifiers</span>
    <span class="c1"># and Overdrive format types.</span>
    <span class="n">adobe_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
    <span class="n">findaway_drm</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span>
    <span class="n">delivery_mechanism_to_internal_format</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">adobe_drm</span><span class="p">):</span> <span class="s1">&#39;ePub&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">Representation</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span><span class="p">,</span> <span class="n">adobe_drm</span><span class="p">):</span> <span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">findaway_drm</span><span class="p">)</span> <span class="p">:</span> <span class="s1">&#39;MP3&#39;</span>
    <span class="p">}</span>
    <span class="n">internal_format_to_delivery_mechanism</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">delivery_mechanism_to_internal_format</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection protocol is </span><span class="si">%s</span><span class="s2">, but passed into BibliothecaAPI!&quot;</span> <span class="o">%</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_VERSION</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_key</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BASE_URL</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Bibliotheca configuration is incomplete.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Use utf8 instead of unicode encoding</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">setting</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_list_parser</span> <span class="o">=</span> <span class="n">ItemListParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">)</span>

<div class="viewcode-block" id="BibliothecaAPI.now"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.now">[docs]</a>    <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current GMT time in the format 3M expects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTH_TIME_FORMAT</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span></div>

<div class="viewcode-block" id="BibliothecaAPI.sign"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.sign">[docs]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add appropriate headers to a request.&quot;&quot;&quot;</span>
        <span class="n">authorization</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DATETIME_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
        <span class="n">headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">VERSION_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="n">headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTHORIZATION_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="n">authorization</span></div>

<div class="viewcode-block" id="BibliothecaAPI.authorization"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.authorization">[docs]</a>    <span class="k">def</span> <span class="nf">authorization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">signature</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTHORIZATION_FORMAT</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">auth</span><span class="p">,</span> <span class="n">now</span></div>

<div class="viewcode-block" id="BibliothecaAPI.signature"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">signature_components</span> <span class="o">=</span> <span class="p">[</span><span class="n">now</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
        <span class="n">signature_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature_components</span><span class="p">)</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account_key</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">signature_string</span><span class="p">,</span>
                    <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signature</span><span class="p">,</span> <span class="n">now</span></div>

<div class="viewcode-block" id="BibliothecaAPI.full_url"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.full_url">[docs]</a>    <span class="k">def</span> <span class="nf">full_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/cirrus&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.full_path"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.full_path">[docs]</a>    <span class="k">def</span> <span class="nf">full_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/cirrus&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/cirrus/library/</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="BibliothecaAPI.replacement_policy"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.replacement_policy">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">replacement_policy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="o">.</span><span class="n">from_license_source</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analytics</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">analytics</span>
        <span class="k">return</span> <span class="n">policy</span></div>

<div class="viewcode-block" id="BibliothecaAPI.request"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accept&quot;</span> <span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="c1"># print headers</span>
        <span class="c1"># self.log.debug(&quot;3M request: %s %s&quot;, method, url)</span>
        <span class="k">if</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">representation</span><span class="p">,</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">extra_request_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">do_get</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simple_http_get</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
                <span class="n">exception_handler</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">reraise_exception</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">representation</span><span class="o">.</span><span class="n">content</span>
            <span class="k">return</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_with_timeout</span><span class="p">(</span>
                <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.get_bibliographic_info_for"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.get_bibliographic_info_for">[docs]</a>    <span class="k">def</span> <span class="nf">get_bibliographic_info_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editions</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">primary_identifier</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_lookup</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">max_age</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="BibliothecaAPI.bibliographic_lookup_request"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.bibliographic_lookup_request">[docs]</a>    <span class="k">def</span> <span class="nf">bibliographic_lookup_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request to look up current bibliographic and</span>
<span class="sd">        circulation information for the given `identifiers`.</span>

<span class="sd">        :param identifiers: Strings containing Bibliotheca identifiers.</span>
<span class="sd">        :return: A string containing an XML document, or None if there was</span>
<span class="sd">           an error not handled as an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/items/&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span></div>

<div class="viewcode-block" id="BibliothecaAPI.bibliographic_lookup"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.bibliographic_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">bibliographic_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up current bibliographic and circulation information for the</span>
<span class="sd">        given `identifiers`.</span>

<span class="sd">        :param identifiers: A list containing either Identifier</span>
<span class="sd">            objects or Bibliotheca identifier strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)):</span>
            <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">identifiers</span><span class="p">]</span>
        <span class="n">identifier_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">identifier</span>
            <span class="n">identifier_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_lookup_request</span><span class="p">(</span><span class="n">identifier_strings</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_list_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_request_with_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will be overridden in MockBibliothecaAPI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">request_with_timeout</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simple_http_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will be overridden in MockBibliothecaAPI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Representation</span><span class="o">.</span><span class="n">simple_http_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="BibliothecaAPI.external_integration"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_count_events</span><span class="p">():</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">five_minutes_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_events_between</span><span class="p">(</span><span class="n">five_minutes_ago</span><span class="p">,</span> <span class="n">now</span><span class="p">)))</span>
            <span class="k">return</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> event(s)&quot;</span> <span class="o">%</span> <span class="n">count</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Asking for circulation events for the last five minutes&quot;</span><span class="p">,</span>
            <span class="n">_count_events</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_patrons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">SelfTestResult</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>
                <span class="k">continue</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">def</span> <span class="nf">_count_activity</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_activity</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> loans/holds&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
                <span class="s2">&quot;Checking activity for test patron for library </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">_count_activity</span>
            <span class="p">)</span>

<div class="viewcode-block" id="BibliothecaAPI.get_events_between"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.get_events_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_events_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">cache_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_events_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return event objects for events between the given times.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENT_TIME_FORMAT</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENT_TIME_FORMAT</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;data/cloudevents?startdate=</span><span class="si">%s</span><span class="s2">&amp;enddate=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_result</span><span class="p">:</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_AGE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="n">EventParser</span><span class="p">()</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">no_events_error</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error parsing Bibliotheca response content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">events</span></div>

<div class="viewcode-block" id="BibliothecaAPI.update_availability"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.update_availability">[docs]</a>    <span class="k">def</span> <span class="nf">update_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the availability information for a single LicensePool.&quot;&quot;&quot;</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="n">BibliothecaCirculationSweep</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">monitor</span><span class="o">.</span><span class="n">process_items</span><span class="p">([</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_patron_activity_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;circulation/patron/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">patron_id</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="BibliothecaAPI.patron_activity"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patron_activity_request</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
        <span class="k">return</span> <span class="n">PatronCirculationParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span></div>

    <span class="n">TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">%(request_type)s</span><span class="s2">&gt;&lt;ItemId&gt;</span><span class="si">%(item_id)s</span><span class="s2">&lt;/ItemId&gt;&lt;PatronId&gt;</span><span class="si">%(patron_id)s</span><span class="s2">&lt;/PatronId&gt;&lt;/</span><span class="si">%(request_type)s</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="BibliothecaAPI.checkout"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">patron_obj</span><span class="p">,</span> <span class="n">patron_password</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span>
            <span class="n">delivery_mechanism</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Check out a book on behalf of a patron.</span>

<span class="sd">        :param patron_obj: a Patron object for the patron who wants</span>
<span class="sd">            to check out the book.</span>

<span class="sd">        :param patron_password: The patron&#39;s alleged password.  Not used here</span>
<span class="sd">            since Bibliotheca trusts Simplified to do the check ahead of time.</span>

<span class="sd">        :param licensepool: LicensePool for the book to be checked out.</span>

<span class="sd">        :return: a LoanInfo object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bibliotheca_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">patron_identifier</span> <span class="o">=</span> <span class="n">patron_obj</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;CheckoutRequest&#39;</span><span class="p">,</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_identifier</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="c1"># New loan</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># Old loan -- we don&#39;t know the start date</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Error condition.</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ErrorParser</span><span class="p">()</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">AlreadyCheckedOut</span><span class="p">):</span>
                <span class="c1"># It&#39;s already checked out. No problem.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span>

        <span class="c1"># At this point we know we have a loan.</span>
        <span class="n">loan_expires</span> <span class="o">=</span> <span class="n">CheckoutResponseParser</span><span class="p">()</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">loan_expires</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">loan</span></div>

<div class="viewcode-block" id="BibliothecaAPI.fulfill"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the actual resource file to the patron.</span>

<span class="sd">        :param kwargs: A container for standard arguments to fulfill()</span>
<span class="sd">           which are not relevant to this implementation.</span>

<span class="sd">        :return: a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">media_type</span><span class="p">,</span> <span class="n">drm_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_format_to_delivery_mechanism</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">internal_format</span><span class="p">,</span> <span class="n">internal_format</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">drm_scheme</span> <span class="o">==</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span><span class="p">:</span>
            <span class="n">fulfill_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_audio_fulfillment_file</span>
            <span class="n">content_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findaway_license_to_webpub_manifest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fulfill_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fulfillment_file</span>
            <span class="n">content_transformation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">fulfill_method</span><span class="p">(</span>
            <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">content_transformation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content_type</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">content_transformation</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Error transforming fulfillment document: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">content_link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">),</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">content_expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.get_fulfillment_file"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.get_fulfillment_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_fulfillment_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">bibliotheca_id</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;ACSMRequest&#39;</span><span class="p">,</span>
                   <span class="n">item_id</span><span class="o">=</span><span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GetItemACSM&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.get_audio_fulfillment_file"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.get_audio_fulfillment_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_audio_fulfillment_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">bibliotheca_id</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;AudioFulfillmentRequest&#39;</span><span class="p">,</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GetItemAudioFulfillment&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.checkin"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;CheckinRequest&#39;</span><span class="p">,</span>
                   <span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;checkin&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.place_hold"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span>
                   <span class="n">hold_notification_email</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place a hold.</span>

<span class="sd">        :return: a HoldInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;PlaceHoldRequest&#39;</span><span class="p">,</span>
                   <span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;placehold&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">HoldResponseParser</span><span class="p">()</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotHold</span><span class="p">()</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ErrorParser</span><span class="p">()</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">error</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotHold</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaAPI.release_hold"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;CancelHoldRequest&#39;</span><span class="p">,</span>
                   <span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE</span> <span class="o">%</span> <span class="n">args</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;cancelhold&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span></div>

<div class="viewcode-block" id="BibliothecaAPI.findaway_license_to_webpub_manifest"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaAPI.findaway_license_to_webpub_manifest">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">findaway_license_to_webpub_manifest</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">findaway_license</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Bibliotheca license document to a FindawayManifest</span>
<span class="sd">        suitable for serving to a mobile client.</span>

<span class="sd">        :param license_pool: A LicensePool for the title in question.</span>
<span class="sd">            This will be used to fill in basic bibliographic information.</span>

<span class="sd">        :param findaway_license: A string containing a Findaway</span>
<span class="sd">            license document via Bibliotheca, or a dictionary</span>
<span class="sd">            representing such a document loaded into JSON form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">findaway_license</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">findaway_license</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">findaway_license</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">findaway_extension</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;accountId&#39;</span><span class="p">,</span> <span class="s1">&#39;checkoutId&#39;</span><span class="p">,</span> <span class="s1">&#39;fulfillmentId&#39;</span><span class="p">,</span> <span class="s1">&#39;licenseId&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sessionKey&#39;</span>
        <span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">findaway_license</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">findaway_extension</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">findaway_extension</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Create the SpineItem objects.</span>
        <span class="n">audio_format</span> <span class="o">=</span> <span class="n">findaway_license</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audio_format</span> <span class="o">==</span> <span class="s1">&#39;MP3&#39;</span><span class="p">:</span>
            <span class="n">part_media_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">MP3_MEDIA_TYPE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown Findaway audio format encountered: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">audio_format</span><span class="p">)</span>
            <span class="n">part_media_type</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">spine_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">findaway_license</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>

            <span class="c1"># TODO: Incoming duration appears to be measured in</span>
            <span class="c1"># milliseconds. This assumption makes our example</span>
            <span class="c1"># audiobook take about 7.9 hours, and no other reasonable</span>
            <span class="c1"># assumption is in the right order of magnitude. But this</span>
            <span class="c1"># needs to be explicitly verified.</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>

            <span class="n">part_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;part&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">sequence</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">spine_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SpineItem</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">part_number</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Create a FindawayManifest object and then convert it</span>
        <span class="c1"># to a string.</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">FindawayManifest</span><span class="p">(</span>
            <span class="n">license_pool</span><span class="o">=</span><span class="n">license_pool</span><span class="p">,</span> <span class="n">spine_items</span><span class="o">=</span><span class="n">spine_items</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DummyBibliothecaAPIResponse"><a class="viewcode-back" href="../../api.html#api.bibliotheca.DummyBibliothecaAPIResponse">[docs]</a><span class="k">class</span> <span class="nc">DummyBibliothecaAPIResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">response_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span></div>

<div class="viewcode-block" id="MockBibliothecaAPI"><a class="viewcode-back" href="../../api.html#api.bibliotheca.MockBibliothecaAPI">[docs]</a><span class="k">class</span> <span class="nc">MockBibliothecaAPI</span><span class="p">(</span><span class="n">BibliothecaAPI</span><span class="p">):</span>

<div class="viewcode-block" id="MockBibliothecaAPI.mock_collection"><a class="viewcode-back" href="../../api.html#api.bibliotheca.MockBibliothecaAPI.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mock Bibliotheca collection for use in tests.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test Bibliotheca Collection&quot;</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;a&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;b&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://bibliotheca.test&quot;</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockBibliothecaAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MockBibliothecaAPI.now"><a class="viewcode-back" href="../../api.html#api.bibliotheca.MockBibliothecaAPI.now">[docs]</a>    <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an unvarying time in the format Bibliotheca expects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTH_TIME_FORMAT</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MockBibliothecaAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.bibliotheca.MockBibliothecaAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">MockRequestsResponse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_request_with_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate HTTP.request_with_timeout.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simple_http_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate Representation.simple_http_get.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_with_timeout</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span></div>

<div class="viewcode-block" id="ItemListParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser">[docs]</a><span class="k">class</span> <span class="nc">ItemListParser</span><span class="p">(</span><span class="n">XMLParser</span><span class="p">):</span>

    <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
    <span class="n">YEAR_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y&quot;</span>

    <span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ItemListParser.parse"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="s2">&quot;//Item&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span></div>

    <span class="n">parenthetical</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot; \([^)]+\)$&quot;</span><span class="p">)</span>


    <span class="n">format_data_for_bibliotheca_format</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;EPUB&quot;</span> <span class="p">:</span> <span class="p">(</span>
            <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
        <span class="p">),</span>
        <span class="s2">&quot;EPUB3&quot;</span> <span class="p">:</span> <span class="p">(</span>
            <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
        <span class="p">),</span>
        <span class="s2">&quot;PDF&quot;</span> <span class="p">:</span> <span class="p">(</span>
            <span class="n">Representation</span><span class="o">.</span><span class="n">PDF_MEDIA_TYPE</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
        <span class="p">),</span>
        <span class="s2">&quot;MP3&quot;</span> <span class="p">:</span> <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FINDAWAY_DRM</span>
        <span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ItemListParser.contributors_from_string"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser.contributors_from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">contributors_from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">):</span>
        <span class="n">contributors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contributors</span>

        <span class="k">for</span> <span class="n">sort_name</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">sort_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parenthetical</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sort_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ContributorData</span><span class="p">(</span>
                    <span class="n">sort_name</span><span class="o">=</span><span class="n">sort_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">contributors</span></div>

<div class="viewcode-block" id="ItemListParser.parse_genre_string"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser.parse_genre_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_genre_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">genres</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SubjectData</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">BISAC</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">genres</span></div>


<div class="viewcode-block" id="ItemListParser.process_one"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an &lt;item&gt; tag into a Metadata and an encompassed CirculationData</span>
<span class="sd">        objects, and return the Metadata.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">bibliotheca_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">bibliotheca_key</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">BIBLIOTHECA_ID</span><span class="p">,</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;ItemId&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ISBN13&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalISBN&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">IdentifierData</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_genre_string</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;Genre&quot;</span><span class="p">))</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;SubTitle&quot;</span><span class="p">)</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;Publisher&quot;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;Language&quot;</span><span class="p">)</span>

        <span class="n">authors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contributors_from_string</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;Authors&#39;</span><span class="p">)))</span>
        <span class="n">narrators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contributors_from_string</span><span class="p">(</span>
                <span class="n">value</span><span class="p">(</span><span class="s1">&#39;Narrator&#39;</span><span class="p">),</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">NARRATOR_ROLE</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">published_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">published</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;PubDate&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">published</span><span class="p">:</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">YEAR_FORMAT</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">published</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;PubYear&quot;</span><span class="p">)</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">YEAR_FORMAT</span><span class="p">]</span>

        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">published_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">published</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">LinkData</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Presume all images from Bibliotheca are JPEG.</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">JPEG_MEDIA_TYPE</span>
        <span class="n">cover_url</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;CoverLinkURL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>
        <span class="n">cover_link</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">cover_url</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span>
        <span class="p">)</span>

        <span class="c1"># Unless the URL format has drastically changed, we should be</span>
        <span class="c1"># able to generate a thumbnail URL based on the full-size</span>
        <span class="c1"># cover URL found in the response document.</span>
        <span class="c1">#</span>
        <span class="c1"># NOTE: this is an undocumented feature of the Bibliotheca API</span>
        <span class="c1"># which was discovered by investigating the BookLinkURL.</span>
        <span class="k">if</span> <span class="s1">&#39;/delivery/img&#39;</span> <span class="ow">in</span> <span class="n">cover_url</span><span class="p">:</span>
            <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">cover_url</span> <span class="o">+</span> <span class="s2">&quot;&amp;size=NORMAL&quot;</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">LinkData</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="n">thumbnail_url</span><span class="p">,</span>
                <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span>
            <span class="p">)</span>
            <span class="n">cover_link</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">thumbnail</span>
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_link</span><span class="p">)</span>

        <span class="n">alternate_url</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;BookLinkURL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LinkData</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="s1">&#39;alternate&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">alternate_url</span><span class="p">))</span>

        <span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;NumberOfPages&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
            <span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">MeasurementData</span><span class="p">(</span><span class="n">quantity_measured</span><span class="o">=</span><span class="n">Measurement</span><span class="o">.</span><span class="n">PAGE_COUNT</span><span class="p">,</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">pages</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">circulation</span><span class="p">,</span> <span class="n">medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_circulation_data</span><span class="p">(</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">primary_identifier</span>
        <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="n">published_date</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
            <span class="n">contributors</span><span class="o">=</span><span class="n">authors</span><span class="o">+</span><span class="n">narrators</span><span class="p">,</span>
            <span class="n">measurements</span><span class="o">=</span><span class="n">measurements</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span>
            <span class="n">circulation</span><span class="o">=</span><span class="n">circulation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata</span></div>

    <span class="k">def</span> <span class="nf">_make_circulation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">primary_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse out a CirculationData containing current circulation</span>
<span class="sd">        and formatting information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">bibliotheca_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">bibliotheca_key</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">intvalue</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">book_format</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="s2">&quot;BookFormat&quot;</span><span class="p">)</span>
        <span class="n">medium</span><span class="p">,</span> <span class="n">formats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_formats</span><span class="p">(</span><span class="n">book_format</span><span class="p">)</span>

        <span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">intvalue</span><span class="p">(</span><span class="s2">&quot;TotalCopies&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">licenses_available</span> <span class="o">=</span> <span class="n">intvalue</span><span class="p">(</span><span class="s2">&quot;AvailableCopies&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No information on available copies for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>
            <span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">intvalue</span><span class="p">(</span><span class="s2">&quot;OnHoldCount&quot;</span><span class="p">)</span>
        <span class="n">licenses_reserved</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">circulation</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">licenses_owned</span><span class="o">=</span><span class="n">licenses_owned</span><span class="p">,</span>
            <span class="n">licenses_available</span><span class="o">=</span><span class="n">licenses_available</span><span class="p">,</span>
            <span class="n">licenses_reserved</span><span class="o">=</span><span class="n">licenses_reserved</span><span class="p">,</span>
            <span class="n">patrons_in_hold_queue</span><span class="o">=</span><span class="n">patrons_in_hold_queue</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">circulation</span><span class="p">,</span> <span class="n">medium</span>

<div class="viewcode-block" id="ItemListParser.internal_formats"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ItemListParser.internal_formats">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">internal_formats</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">book_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the term Bibliotheca uses to refer to a book</span>
<span class="sd">        format into a (medium [formats]) 2-tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">book_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_data_for_bibliotheca_format</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized BookFormat: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">book_format</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">medium</span><span class="p">,</span> <span class="p">[]</span>

        <span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_data_for_bibliotheca_format</span><span class="p">[</span>
            <span class="n">book_format</span>
        <span class="p">]</span>

        <span class="nb">format</span> <span class="o">=</span> <span class="n">FormatData</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="o">=</span><span class="n">drm_scheme</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">book_format</span> <span class="o">==</span> <span class="s1">&#39;MP3&#39;</span><span class="p">:</span>
            <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="k">return</span> <span class="n">medium</span><span class="p">,</span> <span class="p">[</span><span class="nb">format</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="BibliothecaParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaParser">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaParser</span><span class="p">(</span><span class="n">XMLParser</span><span class="p">):</span>

    <span class="n">INPUT_TIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span>

<div class="viewcode-block" id="BibliothecaParser.parse_date"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaParser.parse_date">[docs]</a>    <span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the string Bibliotheca sends as a date.</span>

<span class="sd">        Usually this is a string in INPUT_TIME_FORMAT, but it might be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_TIME_FORMAT</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Unable to parse Bibliotheca date: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="BibliothecaParser.date_from_subtag"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaParser.date_from_subtag">[docs]</a>    <span class="k">def</span> <span class="nf">date_from_subtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BibliothecaException"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaException">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="WorkflowException"><a class="viewcode-back" href="../../api.html#api.bibliotheca.WorkflowException">[docs]</a><span class="k">class</span> <span class="nc">WorkflowException</span><span class="p">(</span><span class="n">BibliothecaException</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual_status</span><span class="p">,</span> <span class="n">statuses_that_would_work</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual_status</span> <span class="o">=</span> <span class="n">actual_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statuses_that_would_work</span> <span class="o">=</span> <span class="n">statuses_that_would_work</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Book status is </span><span class="si">%s</span><span class="s2">, must be: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actual_status</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statuses_that_would_work</span><span class="p">))</span></div>

<div class="viewcode-block" id="ErrorParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ErrorParser">[docs]</a><span class="k">class</span> <span class="nc">ErrorParser</span><span class="p">(</span><span class="n">BibliothecaParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn an error document from the Bibliotheca web service into a CheckoutException&quot;&quot;&quot;</span>

    <span class="n">wrong_status</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;the patron document status was ([^ ]+) and not one of ([^ ]+)&quot;</span><span class="p">)</span>

    <span class="n">loan_limit_reached</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;Patron cannot loan more than [0-9]+ document&quot;</span>
    <span class="p">)</span>

    <span class="n">hold_limit_reached</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;Patron cannot have more than [0-9]+ hold&quot;</span>
    <span class="p">)</span>

    <span class="n">error_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;The patron does not have the book on hold&quot;</span> <span class="p">:</span> <span class="n">NotOnHold</span><span class="p">,</span>
        <span class="s2">&quot;The patron has no eBooks checked out&quot;</span> <span class="p">:</span> <span class="n">NotCheckedOut</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ErrorParser.process_all"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ErrorParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">ErrorParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                    <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//Error&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># The server sent us an error with an incorrect or</span>
            <span class="c1"># nonstandard syntax.</span>
            <span class="k">return</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span>

        <span class="c1"># We were not able to interpret the result as an error.</span>
        <span class="c1"># The most likely cause is that the Bibliotheca app server is down.</span>
        <span class="k">return</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
            <span class="s2">&quot;Unknown error&quot;</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ErrorParser.process_one"><a class="viewcode-back" href="../../api.html#api.bibliotheca.ErrorParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">error_tag</span><span class="p">,</span> <span class="s2">&quot;Message&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown error&quot;</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">SERVICE_NAME</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_mapping</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_mapping</span><span class="p">[</span><span class="n">message</span><span class="p">](</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Authentication failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown error&#39;</span><span class="p">):</span>
            <span class="c1"># &#39;Unknown error&#39; is an unknown error on the Bibliotheca side.</span>
            <span class="c1">#</span>
            <span class="c1"># &#39;Authentication failed&#39; could _in theory_ be an error on</span>
            <span class="c1"># our side, but if authentication is set up improperly we</span>
            <span class="c1"># actually get a 401 and no body. When we get a real error</span>
            <span class="c1"># document with &#39;Authentication failed&#39;, it&#39;s always a</span>
            <span class="c1"># transient error on the Bibliotheca side. Possibly some</span>
            <span class="c1"># authentication internal to Bibliotheca has failed? Anyway, it</span>
            <span class="c1"># happens relatively frequently.</span>
            <span class="k">return</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loan_limit_reached</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PatronLoanLimitReached</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_limit_reached</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PatronHoldLimitReached</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrong_status</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BibliothecaException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;CAN_WISH&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NoLicenses</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_LOAN&#39;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;CAN_HOLD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NoAvailableCopies</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_LOAN&#39;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AlreadyOnHold</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_LOAN&#39;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;LOAN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AlreadyCheckedOut</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_HOLD&#39;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;CAN_LOAN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CurrentlyAvailable</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_HOLD&#39;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">actual</span> <span class="o">==</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AlreadyOnHold</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_HOLD&#39;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CannotHold</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CAN_LOAN&#39;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CannotLoan</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BibliothecaException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PatronCirculationParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser">[docs]</a><span class="k">class</span> <span class="nc">PatronCirculationParser</span><span class="p">(</span><span class="n">BibliothecaParser</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Parse Bibliotheca&#39;s patron circulation status document into a list of</span>
<span class="sd">    LoanInfo and HoldInfo objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">id_type</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">BIBLIOTHECA_ID</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PatronCirculationParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

<div class="viewcode-block" id="PatronCirculationParser.process_all"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="n">parser</span><span class="p">)</span>
        <span class="n">sup</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PatronCirculationParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="n">sup</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
            <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;//Checkouts/Item&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">process_one_loan</span><span class="p">)</span>
        <span class="n">holds</span> <span class="o">=</span> <span class="n">sup</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
            <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;//Holds/Item&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">process_one_hold</span><span class="p">)</span>
        <span class="n">reserves</span> <span class="o">=</span> <span class="n">sup</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
            <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;//Reserves/Item&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">process_one_reserve</span><span class="p">)</span>

        <span class="n">everything</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">loans</span><span class="p">,</span> <span class="n">holds</span><span class="p">,</span> <span class="n">reserves</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">everything</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span></div>

<div class="viewcode-block" id="PatronCirculationParser.process_one_loan"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser.process_one_loan">[docs]</a>    <span class="k">def</span> <span class="nf">process_one_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_one</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">LoanInfo</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronCirculationParser.process_one_hold"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser.process_one_hold">[docs]</a>    <span class="k">def</span> <span class="nf">process_one_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_one</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">HoldInfo</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatronCirculationParser.process_one_reserve"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser.process_one_reserve">[docs]</a>    <span class="k">def</span> <span class="nf">process_one_reserve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="n">hold_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_one</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">HoldInfo</span><span class="p">)</span>
        <span class="n">hold_info</span><span class="o">.</span><span class="n">hold_position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">hold_info</span></div>

<div class="viewcode-block" id="PatronCirculationParser.process_one"><a class="viewcode-back" href="../../api.html#api.bibliotheca.PatronCirculationParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">source_class</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;ItemId&quot;</span><span class="p">):</span>
            <span class="c1"># This happens for events associated with books</span>
            <span class="c1"># no longer in our collection.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">datevalue</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">ARGUMENT_TIME_FORMAT</span><span class="p">)</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;ItemId&quot;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datevalue</span><span class="p">(</span><span class="s2">&quot;EventStartDateInUTC&quot;</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datevalue</span><span class="p">(</span><span class="s2">&quot;EventEndDateInUTC&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span>
             <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">source_class</span> <span class="ow">is</span> <span class="n">HoldInfo</span><span class="p">:</span>
            <span class="n">hold_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;Position&quot;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hold_position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fulfillment info -- not available from this API</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source_class</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="DateResponseParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.DateResponseParser">[docs]</a><span class="k">class</span> <span class="nc">DateResponseParser</span><span class="p">(</span><span class="n">BibliothecaParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract a date from a response.&quot;&quot;&quot;</span>
    <span class="n">RESULT_TAG_NAME</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DATE_TAG_NAME</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DateResponseParser.process_all"><a class="viewcode-back" href="../../api.html#api.bibliotheca.DateResponseParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="n">parser</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESULT_TAG_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATE_TAG_NAME</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">due_date</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">due_date</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">due_date</span><span class="p">,</span> <span class="n">EventParser</span><span class="o">.</span><span class="n">INPUT_TIME_FORMAT</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CheckoutResponseParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.CheckoutResponseParser">[docs]</a><span class="k">class</span> <span class="nc">CheckoutResponseParser</span><span class="p">(</span><span class="n">DateResponseParser</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Extract due date from a checkout response.&quot;&quot;&quot;</span>
    <span class="n">RESULT_TAG_NAME</span> <span class="o">=</span> <span class="s2">&quot;CheckoutResult&quot;</span>
    <span class="n">DATE_TAG_NAME</span> <span class="o">=</span> <span class="s2">&quot;DueDateInUTC&quot;</span></div>


<div class="viewcode-block" id="HoldResponseParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.HoldResponseParser">[docs]</a><span class="k">class</span> <span class="nc">HoldResponseParser</span><span class="p">(</span><span class="n">DateResponseParser</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Extract availability date from a hold response.&quot;&quot;&quot;</span>
    <span class="n">RESULT_TAG_NAME</span> <span class="o">=</span> <span class="s2">&quot;PlaceHoldResult&quot;</span>
    <span class="n">DATE_TAG_NAME</span> <span class="o">=</span> <span class="s2">&quot;AvailabilityDateInUTC&quot;</span></div>


<div class="viewcode-block" id="EventParser"><a class="viewcode-back" href="../../api.html#api.bibliotheca.EventParser">[docs]</a><span class="k">class</span> <span class="nc">EventParser</span><span class="p">(</span><span class="n">BibliothecaParser</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Parse Bibliotheca&#39;s event file format into our native event objects.&quot;&quot;&quot;</span>

    <span class="n">EVENT_SOURCE</span> <span class="o">=</span> <span class="s2">&quot;Bibliotheca&quot;</span>

    <span class="n">SET_DELIVERY_MECHANISM_AT</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">BORROW_STEP</span>

    <span class="c1"># Map Bibliotheca&#39;s event names to our names.</span>
    <span class="n">EVENT_NAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CHECKOUT&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKOUT</span><span class="p">,</span>
        <span class="s2">&quot;CHECKIN&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_CHECKIN</span><span class="p">,</span>
        <span class="s2">&quot;HOLD&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_HOLD_PLACE</span><span class="p">,</span>
        <span class="s2">&quot;RESERVED&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_AVAILABILITY_NOTIFY</span><span class="p">,</span>
        <span class="s2">&quot;PURCHASE&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_ADD</span><span class="p">,</span>
        <span class="s2">&quot;REMOVED&quot;</span> <span class="p">:</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_LICENSE_REMOVE</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="EventParser.process_all"><a class="viewcode-back" href="../../api.html#api.bibliotheca.EventParser.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">no_events_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">has_events</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">EventParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_all</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;//CloudLibraryEvent&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span>
            <span class="n">has_events</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If we are catching up on events and we expect to have a time</span>
        <span class="c1"># period where there are no events, we don&#39;t want to consider that</span>
        <span class="c1"># action as an error. By default, not having events is not</span>
        <span class="c1"># considered to be an error.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_events</span> <span class="ow">and</span> <span class="n">no_events_error</span><span class="p">:</span>
            <span class="c1"># An empty list of events may mean nothing happened, or it</span>
            <span class="c1"># may indicate an unreported server-side error. To be</span>
            <span class="c1"># safe, we&#39;ll treat this as a server-initiated error</span>
            <span class="c1"># condition. If this is just a slow day, normal behavior</span>
            <span class="c1"># will resume as soon as something happens.</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span>
                <span class="s2">&quot;No events returned from server. This may not be an error, but treating it as one to be safe.&quot;</span><span class="p">,</span>
                <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">SERVICE_NAME</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="EventParser.process_one"><a class="viewcode-back" href="../../api.html#api.bibliotheca.EventParser.process_one">[docs]</a>    <span class="k">def</span> <span class="nf">process_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="n">isbn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;ISBN&quot;</span><span class="p">)</span>
        <span class="n">bibliotheca_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;ItemId&quot;</span><span class="p">)</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_optional_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;PatronId&quot;</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_from_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;EventStartDateTimeInUTC&quot;</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_from_subtag</span><span class="p">(</span>
            <span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;EventEndDateTimeInUTC&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">bibliotheca_event_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_of_subtag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;EventType&quot;</span><span class="p">)</span>
        <span class="n">internal_event_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EVENT_NAMES</span><span class="p">[</span><span class="n">bibliotheca_event_type</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                <span class="n">internal_event_type</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BibliothecaCirculationSweep"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaCirculationSweep">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaCirculationSweep</span><span class="p">(</span><span class="n">IdentifierSweepMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check on the current circulation status of each Bibliotheca book in our</span>
<span class="sd">    collection.</span>

<span class="sd">    In some cases this will lead to duplicate events being logged,</span>
<span class="sd">    because this monitor and the main Bibliotheca circulation monitor will</span>
<span class="sd">    count the same event.  However it will greatly improve our current</span>
<span class="sd">    view of our Bibliotheca circulation, which is more important.</span>

<span class="sd">    If Bibliotheca has updated its metadata for a book, that update will</span>
<span class="sd">    also take effect during the circulation sweep.</span>

<span class="sd">    If a Bibliotheca license has expired, and we didn&#39;t hear about it for</span>
<span class="sd">    whatever reason, we&#39;ll find out about it here, because Bibliotheca</span>
<span class="sd">    will act like they never heard of it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Bibliotheca Circulation Sweep&quot;</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">BibliothecaAPI</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BibliothecaCirculationSweep</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span> <span class="o">=</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">replacement_policy</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span><span class="o">.</span><span class="n">analytics</span>

<div class="viewcode-block" id="BibliothecaCirculationSweep.process_items"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaCirculationSweep.process_items">[docs]</a>    <span class="k">def</span> <span class="nf">process_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="n">identifiers_by_bibliotheca_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bibliotheca_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="n">bibliotheca_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">identifiers_by_bibliotheca_id</span><span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>

        <span class="n">identifiers_not_mentioned_by_bibliotheca</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">bibliographic_lookup</span><span class="p">(</span><span class="n">bibliotheca_ids</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_metadata</span><span class="p">(</span>
                <span class="n">metadata</span><span class="p">,</span> <span class="n">identifiers_by_bibliotheca_id</span><span class="p">,</span>
                <span class="n">identifiers_not_mentioned_by_bibliotheca</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># At this point there may be some license pools left over</span>
        <span class="c1"># that Bibliotheca doesn&#39;t know about.  This is a pretty reliable</span>
        <span class="c1"># indication that we no longer own any licenses to the</span>
        <span class="c1"># book.</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers_not_mentioned_by_bibliotheca</span><span class="p">:</span>
            <span class="n">pools</span> <span class="o">=</span> <span class="p">[</span><span class="n">lp</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span>
                     <span class="k">if</span> <span class="n">lp</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>
                     <span class="ow">and</span> <span class="n">lp</span><span class="o">.</span><span class="n">collection</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pools</span><span class="p">:</span>
                <span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">=</span> <span class="n">pools</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2"> from circulation.&quot;</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
                <span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">update_availability</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="p">,</span> <span class="n">as_of</span><span class="o">=</span><span class="n">now</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_process_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">identifiers_by_bibliotheca_id</span><span class="p">,</span>
        <span class="n">identifiers_not_mentioned_by_bibliotheca</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a single Metadata object (containing CirculationData)</span>
<span class="sd">        retrieved from Bibliotheca.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bibliotheca_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifiers_by_bibliotheca_id</span><span class="p">[</span><span class="n">bibliotheca_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers_not_mentioned_by_bibliotheca</span><span class="p">:</span>
            <span class="c1"># Bibliotheca mentioned this identifier. Remove it from</span>
            <span class="c1"># this list so we know the title is still in the collection.</span>
            <span class="n">identifiers_not_mentioned_by_bibliotheca</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

        <span class="n">edition</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">edition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">pool</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">license_pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="c1"># We didn&#39;t have a license pool for this work. That</span>
            <span class="c1"># shouldn&#39;t happen--how did we know about the</span>
            <span class="c1"># identifier?--but now we do.</span>
            <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="o">.</span><span class="n">collect_event</span><span class="p">(</span>
                    <span class="n">library</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_TITLE_ADD</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="p">)</span>
        <span class="n">edition</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">edition</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                                         <span class="n">replace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span><span class="p">)</span></div>

<div class="viewcode-block" id="BibliothecaEventMonitor"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaEventMonitor">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaEventMonitor</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">,</span> <span class="n">TimelineMonitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Register CirculationEvents for Bibliotheca titles.</span>

<span class="sd">    Most of the time we will just be finding out that someone checked</span>
<span class="sd">    in or checked out a copy of a book we already knew about.</span>

<span class="sd">    But when a new book comes on the scene, this is where we first</span>
<span class="sd">    find out about it. When this happens, we create a LicensePool and</span>
<span class="sd">    immediately ensure that we get coverage from the</span>
<span class="sd">    BibliothecaBibliographicCoverageProvider.</span>

<span class="sd">    But getting up-to-date circulation data for that new book requires</span>
<span class="sd">    either that we process further events, or that we encounter it in</span>
<span class="sd">    the BibliothecaCirculationSweep.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Bibliotheca Event Monitor&quot;</span>
    <span class="n">DEFAULT_START_TIME</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">365</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">BibliothecaAPI</span><span class="p">,</span>
                 <span class="n">cli_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">analytics</span> <span class="ow">or</span> <span class="n">Analytics</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BibliothecaEventMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="p">):</span>
            <span class="c1"># We were given an actual API object. Just use it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span> <span class="o">=</span> <span class="n">BibliothecaAPI</span><span class="o">.</span><span class="n">replacement_policy</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span> <span class="o">=</span> <span class="n">BibliothecaBibliographicCoverageProvider</span><span class="p">(</span>
            <span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">replacement_policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replacement_policy</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cli_date</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_default_start_time</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span>  <span class="n">cli_date</span>
            <span class="p">)</span>

<div class="viewcode-block" id="BibliothecaEventMonitor.create_default_start_time"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaEventMonitor.create_default_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">create_default_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">cli_date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the default start time if it&#39;s passed as an argument.</span>

<span class="sd">        The command line date argument should have the format YYYY-MM-DD.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We don&#39;t use Monitor.timestamp() because that will create</span>
        <span class="c1"># the timestamp if it doesn&#39;t exist -- we want to see whether</span>
        <span class="c1"># or not it exists.</span>
        <span class="n">initialized</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="p">,</span>
            <span class="n">service_type</span><span class="o">=</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">MONITOR_TYPE</span>
        <span class="p">)</span>
        <span class="n">default_start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_START_TIME</span>

        <span class="k">if</span> <span class="n">cli_date</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cli_date</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">cli_date</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">cli_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Date argument wasn&#39;t in the proper format.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">. Using default date instead: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
                    <span class="n">default_start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">default_start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Initializing </span><span class="si">%s</span><span class="s2"> from date: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="p">,</span>
                <span class="n">default_start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">default_start_time</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BibliothecaEventMonitor.catch_up_from"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaEventMonitor.catch_up_from">[docs]</a>    <span class="k">def</span> <span class="nf">catch_up_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="n">added_books</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">timespan_to_check</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Not having events in a time period is not considered to be</span>
        <span class="c1"># an error.</span>
        <span class="n">no_events_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># But in this case, we do want to consider not getting events as</span>
        <span class="c1"># an error. Each subsequent time this is run after the first time,</span>
        <span class="c1"># the timespan to check for event increases by 5 minutes until we</span>
        <span class="c1"># reach a 70-hour timespan to check for events.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">no_events_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">timespan_to_check</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>

            <span class="n">import_time_delta</span> <span class="o">=</span> <span class="n">cutoff</span> <span class="o">-</span> <span class="n">start</span>
            <span class="c1"># If we want to check for events in a time period that&#39;s</span>
            <span class="c1"># longer than 70 hours, then revert back to the initial</span>
            <span class="c1"># import configuration.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">import_time_delta</span> <span class="o">&gt;</span> <span class="n">timespan_to_check</span><span class="p">):</span>
                <span class="n">no_events_error</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Start by checking for events in a 5 minute timespan.</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">timespan_to_check</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">slice_start</span><span class="p">,</span> <span class="n">slice_cutoff</span><span class="p">,</span> <span class="n">full_slice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_timespan</span><span class="p">(</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">timespan_to_check</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Asking for events between </span><span class="si">%r</span><span class="s2"> and </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">slice_start</span><span class="p">,</span>
                <span class="n">slice_cutoff</span>
            <span class="p">)</span>
            <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_events_between</span><span class="p">(</span>
                <span class="n">slice_start</span><span class="p">,</span> <span class="n">slice_cutoff</span><span class="p">,</span> <span class="n">full_slice</span><span class="p">,</span> <span class="n">no_events_error</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">event_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_event</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">achievements</span> <span class="o">=</span> <span class="s2">&quot;Events handled: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="c1"># If we are in &quot;catch up&quot; mode and we encounter some events, we can</span>
        <span class="c1"># reset the counter back to 0. Otherwise, keep the counter at 1. This</span>
        <span class="c1"># will also set it to 1 after the initial run.</span>
        <span class="k">if</span> <span class="n">progress</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="BibliothecaEventMonitor.handle_event"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaEventMonitor.handle_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">foreign_patron_id</span><span class="p">,</span>
                     <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">internal_event_type</span><span class="p">):</span>
        <span class="c1"># Find or lookup the LicensePool for this event.</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">BIBLIOTHECA_ID</span><span class="p">,</span>
            <span class="n">bibliotheca_id</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="c1"># This is a new book. Immediately acquire bibliographic</span>
            <span class="c1"># coverage for it.  This will set the</span>
            <span class="c1"># DistributionMechanisms and make the book</span>
            <span class="c1"># presentation-ready. However, its circulation information</span>
            <span class="c1"># might not be up to date until we process some more</span>
            <span class="c1"># events.</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span><span class="o">.</span><span class="n">ensure_coverage</span><span class="p">(</span>
                <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">bibliotheca_identifier</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">isbn</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span>

        <span class="n">edition</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">BIBLIOTHECA_ID</span><span class="p">,</span> <span class="n">bibliotheca_id</span><span class="p">)</span>

        <span class="c1"># The ISBN and the Bibliotheca identifier are exactly equivalent.</span>
        <span class="n">bibliotheca_identifier</span><span class="o">.</span><span class="n">equivalent_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Log the event.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span> <span class="ow">or</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">NO_DATE</span>

        <span class="c1"># Make sure the effects of the event reported by Bibliotheca</span>
        <span class="c1"># are made visible on the LicensePool and turned into</span>
        <span class="c1"># analytics events. This is not 100% reliable, but it</span>
        <span class="c1"># should be mostly accurate, and the BibliothecaCirculationSweep</span>
        <span class="c1"># will periodically correct the errors.</span>
        <span class="n">license_pool</span><span class="o">.</span><span class="n">update_availability_from_delta</span><span class="p">(</span>
            <span class="n">internal_event_type</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="c1"># This is our first time seeing this LicensePool. Log its</span>
            <span class="c1"># occurance as a separate event.</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">collect_analytics_event</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_TITLE_ADD</span><span class="p">,</span>
                <span class="n">license_pool</span><span class="o">.</span><span class="n">last_checked</span> <span class="ow">or</span> <span class="n">start_time</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">edition</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="s2">&quot;[no title]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">internal_event_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start_time</span></div></div>

<div class="viewcode-block" id="BibliothecaBibliographicCoverageProvider"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaBibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">BibliothecaBibliographicCoverageProvider</span><span class="p">(</span><span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill in bibliographic metadata for Bibliotheca records.</span>

<span class="sd">    This will occasionally fill in some availability information for a</span>
<span class="sd">    single Collection, but we rely on Monitors to keep availability</span>
<span class="sd">    information up to date for all Collections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Bibliotheca Bibliographic Coverage Provider&quot;</span>
    <span class="n">DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">BIBLIOTHECA</span>
    <span class="n">INPUT_IDENTIFIER_TYPES</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">BIBLIOTHECA_ID</span>

    <span class="c1"># 25 is the maximum batch size for the Bibliotheca API.</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">BibliothecaAPI</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: Provide bibliographic coverage to all</span>
<span class="sd">            Bibliotheca books in the given Collection.</span>
<span class="sd">        :param api_class: Instantiate this class with the given Collection,</span>
<span class="sd">            rather than instantiating BibliothecaAPI.</span>
<span class="sd">        :param input_identifiers: Passed in by RunCoverageProviderScript.</span>
<span class="sd">            A list of specific identifiers to get coverage for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BibliothecaBibliographicCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">BibliothecaAPI</span><span class="p">):</span>
            <span class="c1"># This is an already instantiated API object. Use it</span>
            <span class="c1"># instead of creating a new one.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A web application should not use this option because it</span>
            <span class="c1"># will put a non-scoped session in the mix.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="BibliothecaBibliographicCoverageProvider.process_item"><a class="viewcode-back" href="../../api.html#api.bibliotheca.BibliothecaBibliographicCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">bibliographic_lookup</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span>
                <span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;Bibliotheca bibliographic lookup failed.&quot;</span>
            <span class="p">)</span>
        <span class="p">[</span><span class="n">metadata</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>