
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.opds &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.opds</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.parse</span><span class="o">,</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">lazyload</span>

<span class="kn">from</span> <span class="nn">core.cdn</span> <span class="kn">import</span> <span class="n">cdnify</span>
<span class="kn">from</span> <span class="nn">core.classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">core.entrypoint</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EverythingEntryPoint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.external_search</span> <span class="kn">import</span> <span class="n">WorkSearchResult</span>
<span class="kn">from</span> <span class="nn">core.opds</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Annotator</span><span class="p">,</span>
    <span class="n">AcquisitionFeed</span><span class="p">,</span>
    <span class="n">UnfulfillableWork</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.flask_util</span> <span class="kn">import</span> <span class="n">OPDSFeedResponse</span>
<span class="kn">from</span> <span class="nn">core.util.opds_writer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSFeed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">CustomList</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Hold</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">LicensePoolDeliveryMechanism</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.lane</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Lane</span><span class="p">,</span>
    <span class="n">WorkList</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="n">from_timestamp</span>
<span class="kn">from</span> <span class="nn">api.lanes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamicLane</span><span class="p">,</span>
    <span class="n">CrawlableCustomListBasedLane</span><span class="p">,</span>
    <span class="n">CrawlableCollectionBasedLane</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.app_server</span> <span class="kn">import</span> <span class="n">cdn_url_for</span>

<span class="kn">from</span> <span class="nn">.util.short_client_token</span> <span class="kn">import</span> <span class="n">ShortClientTokenUtility</span>
<span class="kn">from</span> <span class="nn">.annotations</span> <span class="kn">import</span> <span class="n">AnnotationWriter</span>
<span class="kn">from</span> <span class="nn">.circulation</span> <span class="kn">import</span> <span class="n">BaseCirculationAPI</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">Configuration</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.novelist</span> <span class="kn">import</span> <span class="n">NoveListAPI</span>
<span class="kn">from</span> <span class="nn">core.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>

<div class="viewcode-block" id="CirculationManagerAnnotator"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator">[docs]</a><span class="k">class</span> <span class="nc">CirculationManagerAnnotator</span><span class="p">(</span><span class="n">Annotator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span>
                 <span class="n">active_loans_by_work</span><span class="o">=</span><span class="p">{},</span> <span class="n">active_holds_by_work</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="p">{},</span> <span class="n">hidden_content_types</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lane</span><span class="p">:</span>
            <span class="n">logger_name</span> <span class="o">=</span> <span class="s2">&quot;Circulation Manager Annotator for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger_name</span> <span class="o">=</span> <span class="s2">&quot;Circulation Manager Annotator&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="n">lane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_loans_by_work</span> <span class="o">=</span> <span class="n">active_loans_by_work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_holds_by_work</span> <span class="o">=</span> <span class="n">active_holds_by_work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_fulfillments_by_work</span> <span class="o">=</span> <span class="n">active_fulfillments_by_work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_content_types</span> <span class="o">=</span> <span class="n">hidden_content_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">test_mode</span>

<div class="viewcode-block" id="CirculationManagerAnnotator.is_work_entry_solo"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.is_work_entry_solo">[docs]</a>    <span class="k">def</span> <span class="nf">is_work_entry_solo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a boolean value indicating whether the work&#39;s OPDS catalog entry is served by itself,</span>
<span class="sd">            rather than as a part of the feed.</span>

<span class="sd">        :param work: Work object</span>
<span class="sd">        :type work: core.model.work.Work</span>

<span class="sd">        :return: Boolean value indicating whether the work&#39;s OPDS catalog entry is served by itself,</span>
<span class="sd">            rather than as a part of the feed</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">work</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_loans_by_work</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_holds_by_work</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_fulfillments_by_work</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_lane_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="CirculationManagerAnnotator.top_level_title"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.top_level_title">[docs]</a>    <span class="k">def</span> <span class="nf">top_level_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.default_lane_url"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.default_lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">default_lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.lane_url"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.url_for"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.url_for">[docs]</a>    <span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">:</span>
            <span class="n">new_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">new_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_url_for</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.cdn_url_for"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.cdn_url_for">[docs]</a>    <span class="k">def</span> <span class="nf">cdn_url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_url_for</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cdn_url_for</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.test_url_for"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.test_url_for">[docs]</a>    <span class="k">def</span> <span class="nf">test_url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Generate a plausible-looking URL that doesn&#39;t depend on Flask</span>
        <span class="c1"># being set up.</span>
        <span class="k">if</span> <span class="n">cdn</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;cdn&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;host&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="n">connector</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">connector</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.facet_url"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.facet_url">[docs]</a>    <span class="k">def</span> <span class="nf">facet_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_view</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.feed_url"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.feed_url">[docs]</a>    <span class="k">def</span> <span class="nf">feed_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">WorkList</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s1">&#39;url_arguments&#39;</span><span class="p">)):</span>
            <span class="n">route</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">url_arguments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">route</span> <span class="o">=</span> <span class="n">default_route</span>
            <span class="n">lane_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_identifier</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lane_identifier</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">facets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">pagination</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">extra_kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_url_for</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.navigation_url"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.navigation_url">[docs]</a>    <span class="k">def</span> <span class="nf">navigation_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_url_for</span><span class="p">(</span>
            <span class="s2">&quot;navigation_feed&quot;</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lane_identifier</span><span class="p">(</span><span class="n">lane</span><span class="p">),</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.active_licensepool_for"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.active_licensepool_for">[docs]</a>    <span class="k">def</span> <span class="nf">active_licensepool_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_loans_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_holds_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">loan</span><span class="p">:</span>
            <span class="c1"># The active license pool is the one associated with</span>
            <span class="c1"># the loan/hold.</span>
            <span class="k">return</span> <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There is no active loan. Use the default logic for</span>
            <span class="c1"># determining the active license pool.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span>
                <span class="n">CirculationManagerAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">active_licensepool_for</span><span class="p">(</span><span class="n">work</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.visible_delivery_mechanisms"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.visible_delivery_mechanisms">[docs]</a>    <span class="k">def</span> <span class="nf">visible_delivery_mechanisms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter the given `licensepool`&#39;s LicensePoolDeliveryMechanisms</span>
<span class="sd">        to those with content types that are not hidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_content_types</span>
        <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
            <span class="n">mechanism</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mechanism</span><span class="p">:</span>
                <span class="c1"># This shouldn&#39;t happen, but just in case.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">mechanism</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="n">hidden</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">lpdm</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.annotate_work_entry"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.annotate_work_entry">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_work_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If ElasticSearch included a more accurate last_update_time,</span>
        <span class="c1"># use it instead of Work.last_update_time</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">last_update_time</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">WorkSearchResult</span><span class="p">):</span>
            <span class="c1"># Elasticsearch puts this field in a list, but we&#39;ve set it up</span>
            <span class="c1"># so there will be at most one value.</span>
            <span class="n">last_updates</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">_hit</span><span class="p">,</span> <span class="s1">&#39;last_update&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">last_updates</span><span class="p">:</span>
                <span class="c1"># last_update is seconds-since epoch; convert to UTC datetime.</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="n">from_timestamp</span><span class="p">(</span><span class="n">last_updates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># There&#39;s a chance that work.last_updated has been</span>
                <span class="c1"># modified but the change hasn&#39;t made it to the search</span>
                <span class="c1"># engine yet. Even then, we stick with the search</span>
                <span class="c1"># engine value, because a sorted list is more</span>
                <span class="c1"># important to the import process than an up-to-date</span>
                <span class="c1"># &#39;last update&#39; value.</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CirculationManagerAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">annotate_work_entry</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">updated</span>
        <span class="p">)</span>
        <span class="n">active_loan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_loans_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">active_hold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_holds_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">active_fulfillment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_fulfillments_by_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="c1"># Now we need to generate a &lt;link&gt; tag for every delivery mechanism</span>
        <span class="c1"># that has well-defined media types.</span>
        <span class="n">link_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_links</span><span class="p">(</span>
            <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span> <span class="n">active_fulfillment</span><span class="p">,</span>
            <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">link_tags</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.acquisition_links"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.acquisition_links">[docs]</a>    <span class="k">def</span> <span class="nf">acquisition_links</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span>
            <span class="n">active_fulfillment</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">can_hold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">can_revoke_hold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">set_mechanism_at_borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">direct_fulfillment_delivery_mechanisms</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a number of &lt;link&gt; tags that enumerate all acquisition</span>
<span class="sd">        methods.</span>

<span class="sd">        :param direct_fulfillment_delivery_mechanisms: A way to</span>
<span class="sd">            fulfill each LicensePoolDeliveryMechanism in this list will be</span>
<span class="sd">            presented as a link with</span>
<span class="sd">            rel=&quot;http://opds-spec.org/acquisition/open-access&quot;, indicating</span>
<span class="sd">            that it can be downloaded with no intermediate steps such as</span>
<span class="sd">            authentication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">can_borrow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">can_fulfill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">can_revoke</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">active_loan</span><span class="p">:</span>
            <span class="n">can_fulfill</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">can_revoke</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">active_hold</span><span class="p">:</span>
            <span class="c1"># We display the borrow link even if the patron can&#39;t</span>
            <span class="c1"># borrow the book right this minute.</span>
            <span class="n">can_borrow</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">can_revoke</span> <span class="o">=</span> <span class="n">can_revoke_hold</span>
        <span class="k">elif</span> <span class="n">active_fulfillment</span><span class="p">:</span>
            <span class="n">can_fulfill</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">can_revoke</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The patron has no existing relationship with this</span>
            <span class="c1"># work. Give them the opportunity to check out the work</span>
            <span class="c1"># or put it on hold.</span>
            <span class="n">can_borrow</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If there is something to be revoked for this book,</span>
        <span class="c1"># add a link to revoke it.</span>
        <span class="n">revoke_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">can_revoke</span><span class="p">:</span>
            <span class="n">revoke_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revoke_link</span><span class="p">(</span><span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">))</span>

        <span class="c1"># Add next-step information for every useful delivery</span>
        <span class="c1"># mechanism.</span>
        <span class="n">borrow_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">can_borrow</span><span class="p">:</span>
            <span class="c1"># Borrowing a book gives you an OPDS entry that gives you</span>
            <span class="c1"># fulfillment links for every visible delivery mechanism.</span>
            <span class="n">visible_mechanisms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_delivery_mechanisms</span><span class="p">(</span>
                <span class="n">active_license_pool</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">set_mechanism_at_borrow</span> <span class="ow">and</span> <span class="n">active_license_pool</span><span class="p">:</span>
                <span class="c1"># The ebook distributor requires that the delivery</span>
                <span class="c1"># mechanism be set at the point of checkout. This means</span>
                <span class="c1"># a separate borrow link for each mechanism.</span>
                <span class="k">for</span> <span class="n">mechanism</span> <span class="ow">in</span> <span class="n">visible_mechanisms</span><span class="p">:</span>
                    <span class="n">borrow_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">borrow_link</span><span class="p">(</span>
                            <span class="n">active_license_pool</span><span class="p">,</span>
                            <span class="n">mechanism</span><span class="p">,</span> <span class="p">[</span><span class="n">mechanism</span><span class="p">],</span>
                            <span class="n">active_hold</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">active_license_pool</span><span class="p">:</span>
                <span class="c1"># The ebook distributor does not require that the</span>
                <span class="c1"># delivery mechanism be set at the point of</span>
                <span class="c1"># checkout. This means a single borrow link with</span>
                <span class="c1"># indirectAcquisition tags for every visible delivery</span>
                <span class="c1"># mechanism. If a delivery mechanism must be set, it</span>
                <span class="c1"># will be set at the point of fulfillment.</span>
                <span class="n">borrow_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">borrow_link</span><span class="p">(</span>
                        <span class="n">active_license_pool</span><span class="p">,</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="n">visible_mechanisms</span><span class="p">,</span>
                        <span class="n">active_hold</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Generate the licensing tags that tell you whether the book</span>
            <span class="c1"># is available.</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">borrow_links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">license_tags</span><span class="p">(</span>
                        <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span>
                    <span class="p">):</span>
                        <span class="n">link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Add links for fulfilling an active loan.</span>
        <span class="n">fulfill_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">can_fulfill</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active_fulfillment</span><span class="p">:</span>
                <span class="c1"># We&#39;re making an entry for a specific fulfill link.</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">active_fulfillment</span><span class="o">.</span><span class="n">content_type</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">active_fulfillment</span><span class="o">.</span><span class="n">content_link</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_REL</span>
                <span class="n">link_tag</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">acquisition_link</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="nb">type</span><span class="p">],</span> <span class="n">active_loan</span><span class="o">=</span><span class="n">active_loan</span><span class="p">)</span>
                <span class="n">fulfill_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_tag</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">active_loan</span> <span class="ow">and</span> <span class="n">active_loan</span><span class="o">.</span><span class="n">fulfillment</span><span class="p">:</span>
                <span class="c1"># The delivery mechanism for this loan has been</span>
                <span class="c1"># set. There is one link for the delivery mechanism</span>
                <span class="c1"># that was locked in, and links for any streaming</span>
                <span class="c1"># delivery mechanisms.</span>
                <span class="c1">#</span>
                <span class="c1"># Since the delivery mechanism has already been locked in,</span>
                <span class="c1"># we choose not to use visible_delivery_mechanisms --</span>
                <span class="c1"># they already chose it and they&#39;re stuck with it.</span>
                <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">lpdm</span> <span class="ow">is</span> <span class="n">active_loan</span><span class="o">.</span><span class="n">fulfillment</span> <span class="ow">or</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">:</span>
                        <span class="n">fulfill_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fulfill_link</span><span class="p">(</span>
                                <span class="n">active_license_pool</span><span class="p">,</span>
                                <span class="n">active_loan</span><span class="p">,</span>
                                <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The delivery mechanism for this loan has not been</span>
                <span class="c1"># set. There is one fulfill link for every visible</span>
                <span class="c1"># delivery mechanism.</span>
                <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_delivery_mechanisms</span><span class="p">(</span>
                        <span class="n">active_license_pool</span>
                <span class="p">):</span>
                    <span class="n">fulfill_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fulfill_link</span><span class="p">(</span>
                            <span class="n">active_license_pool</span><span class="p">,</span>
                            <span class="n">active_loan</span><span class="p">,</span>
                            <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">open_access_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">direct_fulfillment_delivery_mechanisms</span><span class="p">:</span>
            <span class="c1"># These links use the OPDS &#39;open-access&#39; link relation not</span>
            <span class="c1"># because they are open access in the licensing sense, but</span>
            <span class="c1"># because they are ways to download the book &quot;without any</span>
            <span class="c1"># requirement, which includes payment and registration.&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># To avoid confusion, we explicitly add a dc:rights</span>
            <span class="c1"># statement to each link explaining what the rights are to</span>
            <span class="c1"># this title.</span>
            <span class="n">direct_fulfill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulfill_link</span><span class="p">(</span>
                <span class="n">active_license_pool</span><span class="p">,</span>
                <span class="n">active_loan</span><span class="p">,</span>
                <span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">OPEN_ACCESS_REL</span>
            <span class="p">)</span>
            <span class="n">direct_fulfill</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rights_attributes</span><span class="p">(</span><span class="n">lpdm</span><span class="p">))</span>
            <span class="n">open_access_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direct_fulfill</span><span class="p">)</span>

        <span class="c1"># If this is an open-access book, add an open-access link for</span>
        <span class="c1"># every delivery mechanism with an associated resource.</span>
        <span class="k">if</span> <span class="n">active_license_pool</span> <span class="ow">and</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="p">:</span>
                    <span class="n">open_access_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_access_link</span><span class="p">(</span><span class="n">active_license_pool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">borrow_links</span> <span class="o">+</span> <span class="n">fulfill_links</span> <span class="o">+</span> <span class="n">open_access_links</span> <span class="o">+</span> <span class="n">revoke_links</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.revoke_link"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.revoke_link">[docs]</a>    <span class="k">def</span> <span class="nf">revoke_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.borrow_link"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.borrow_link">[docs]</a>    <span class="k">def</span> <span class="nf">borrow_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span>
                    <span class="n">borrow_mechanism</span><span class="p">,</span> <span class="n">fulfillment_mechanisms</span><span class="p">,</span> <span class="n">active_hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.fulfill_link"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.fulfill_link">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">,</span>
                     <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_REL</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.open_access_link"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.open_access_link">[docs]</a>    <span class="k">def</span> <span class="nf">open_access_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">lpdm</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">cdnify</span><span class="p">(</span><span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">OPEN_ACCESS_REL</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Start off assuming that the URL associated with the</span>
        <span class="c1"># LicensePoolDeliveryMechanism&#39;s Resource is the URL we should</span>
        <span class="c1"># send for download purposes. This will be the case unless we</span>
        <span class="c1"># previously mirrored that URL somewhere else.</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span>

        <span class="n">rep</span> <span class="o">=</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">representation</span>
        <span class="k">if</span> <span class="n">rep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rep</span><span class="o">.</span><span class="n">media_type</span><span class="p">:</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="o">.</span><span class="n">media_type</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">rep</span><span class="o">.</span><span class="n">public_url</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdnify</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
        <span class="n">link_tag</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rights_attributes</span><span class="p">(</span><span class="n">lpdm</span><span class="p">))</span>
        <span class="n">always_available</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span>
            <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}availability&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">OPDS_NS</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;available&quot;</span>
        <span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">always_available</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">link_tag</span></div>

<div class="viewcode-block" id="CirculationManagerAnnotator.rights_attributes"><a class="viewcode-back" href="../../api.html#api.opds.CirculationManagerAnnotator.rights_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">rights_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a dictionary of tag attributes that explain the</span>
<span class="sd">        rights status of a LicensePoolDeliveryMechanism.</span>

<span class="sd">        If nothing is known, the dictionary will be empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lpdm</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span><span class="o">.</span><span class="n">uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">rights_attr</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}rights&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DCTERMS_NS</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">rights_attr</span> <span class="p">:</span> <span class="n">lpdm</span><span class="o">.</span><span class="n">rights_status</span><span class="o">.</span><span class="n">uri</span> <span class="p">}</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_single_entry_response</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">feed_class</span><span class="o">=</span><span class="n">AcquisitionFeed</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to create an OPDSEntryResponse for a single OPDS entry.</span>

<span class="sd">        :param _db: A database connection.</span>
<span class="sd">        :param work: A Work</span>
<span class="sd">        :param annotator: An Annotator</span>
<span class="sd">        :param url: The URL of the feed to be served. Used only if there&#39;s</span>
<span class="sd">            a problem with the Work.</span>
<span class="sd">        :param feed_class: A replacement for AcquisitionFeed, for use in tests.</span>
<span class="sd">        :param response_kwargs: A set of extra keyword arguments to</span>
<span class="sd">            be passed into the OPDSEntryResponse constructor.</span>

<span class="sd">        :return: An OPDSEntryResponse if everything goes well; otherwise an OPDSFeedResponse</span>
<span class="sd">            containing an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">feed_class</span><span class="p">(</span>
                <span class="n">_db</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Unknown work&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">works</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">annotator</span><span class="o">=</span><span class="n">annotator</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_error_response</span><span class="p">()</span>

        <span class="c1"># This method is generally used for reporting the results of</span>
        <span class="c1"># authenticated transactions such as borrowing and hold</span>
        <span class="c1"># placement.</span>
        <span class="c1">#</span>
        <span class="c1"># This means the document contains up-to-date information</span>
        <span class="c1"># specific to the authenticated client. The client should</span>
        <span class="c1"># cache this document for a while, but no one else should</span>
        <span class="c1"># cache it.</span>
        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;max_age&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feed_class</span><span class="o">.</span><span class="n">single_entry</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="LibraryAnnotator"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator">[docs]</a><span class="k">class</span> <span class="nc">LibraryAnnotator</span><span class="p">(</span><span class="n">CirculationManagerAnnotator</span><span class="p">):</span>

    <span class="n">TERMS_OF_SERVICE</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">TERMS_OF_SERVICE</span>
    <span class="n">PRIVACY_POLICY</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">PRIVACY_POLICY</span>
    <span class="n">COPYRIGHT</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">COPYRIGHT</span>
    <span class="n">ABOUT</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">ABOUT</span>
    <span class="n">LICENSE</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">LICENSE</span>
    <span class="n">REGISTER</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">REGISTER</span>

    <span class="n">CONFIGURATION_LINKS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">TERMS_OF_SERVICE</span><span class="p">,</span>
        <span class="n">PRIVACY_POLICY</span><span class="p">,</span>
        <span class="n">COPYRIGHT</span><span class="p">,</span>
        <span class="n">ABOUT</span><span class="p">,</span>
        <span class="n">LICENSE</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">HELP_LINKS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">HELP_EMAIL</span><span class="p">,</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">HELP_WEB</span><span class="p">,</span>
        <span class="n">Configuration</span><span class="o">.</span><span class="n">HELP_URI</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circulation</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">active_loans_by_work</span><span class="o">=</span><span class="p">{},</span> <span class="n">active_holds_by_work</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">facet_view</span><span class="o">=</span><span class="s1">&#39;feed&#39;</span><span class="p">,</span>
                 <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">top_level_title</span><span class="o">=</span><span class="s2">&quot;All Books&quot;</span><span class="p">,</span>
                 <span class="n">library_identifies_patrons</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">facets</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param library_identifies_patrons: A boolean indicating</span>
<span class="sd">          whether or not this library can distinguish between its</span>
<span class="sd">          patrons. A library might not authenticate patrons at</span>
<span class="sd">          all, or it might distinguish patrons from non-patrons in a</span>
<span class="sd">          way that does not allow it to keep track of individuals.</span>

<span class="sd">          If this is false, links that imply the library can</span>
<span class="sd">          distinguish between patrons will not be included. Depending</span>
<span class="sd">          on the configured collections, some extra links may be</span>
<span class="sd">          added, for direct acquisition of titles that would normally</span>
<span class="sd">          require a loan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">lane</span><span class="p">,</span> <span class="n">active_loans_by_work</span><span class="o">=</span><span class="n">active_loans_by_work</span><span class="p">,</span>
            <span class="n">active_holds_by_work</span><span class="o">=</span><span class="n">active_holds_by_work</span><span class="p">,</span>
            <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="n">active_fulfillments_by_work</span><span class="p">,</span>
            <span class="n">hidden_content_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_content_types</span><span class="p">(</span><span class="n">library</span><span class="p">),</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library</span> <span class="o">=</span> <span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patron</span> <span class="o">=</span> <span class="n">patron</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facet_view</span> <span class="o">=</span> <span class="n">facet_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adobe_id_tags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_level_title</span> <span class="o">=</span> <span class="n">top_level_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span> <span class="o">=</span> <span class="n">library_identifies_patrons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hidden_content_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all content types which this library should not be</span>
<span class="sd">        presenting to patrons.</span>

<span class="sd">        This is stored as a per-library setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">library</span><span class="p">:</span>
            <span class="c1"># This shouldn&#39;t happen, but we shouldn&#39;t crash if it does.</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">Configuration</span><span class="o">.</span><span class="n">HIDDEN_CONTENT_TYPES</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hidden_types</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">json_value</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">hidden_types</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span>
        <span class="n">hidden_types</span> <span class="o">=</span> <span class="n">hidden_types</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hidden_types</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">hidden_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">hidden_types</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hidden_types</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">hidden_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hidden_types</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hidden_types</span>

<div class="viewcode-block" id="LibraryAnnotator.top_level_title"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.top_level_title">[docs]</a>    <span class="k">def</span> <span class="nf">top_level_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_level_title</span></div>

<div class="viewcode-block" id="LibraryAnnotator.permalink_for"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.permalink_for">[docs]</a>    <span class="k">def</span> <span class="nf">permalink_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s1">&#39;permalink&#39;</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ENTRY_TYPE</span></div>

<div class="viewcode-block" id="LibraryAnnotator.groups_url"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.groups_url">[docs]</a>    <span class="k">def</span> <span class="nf">groups_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lane_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_identifier</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_url_for</span><span class="p">(</span>
            <span class="s2">&quot;acquisition_groups&quot;</span><span class="p">,</span>
            <span class="n">lane_identifier</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.default_lane_url"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.default_lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">default_lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.feed_url"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.feed_url">[docs]</a>    <span class="k">def</span> <span class="nf">feed_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;feed&#39;</span><span class="p">):</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">:</span>
            <span class="n">extra_kwargs</span><span class="p">[</span><span class="s1">&#39;library_short_name&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">default_route</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.search_url"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.search_url">[docs]</a>    <span class="k">def</span> <span class="nf">search_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lane_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_identifier</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">facets</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">pagination</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;lane_search&quot;</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.group_uri"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.group_uri">[docs]</a>    <span class="k">def</span> <span class="nf">group_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="n">lanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="c1"># I don&#39;t think this should ever happen?</span>
            <span class="n">lane_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_url_for</span><span class="p">(</span><span class="s1">&#39;acquisition_groups&#39;</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;All Books&quot;</span>
            <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span>

        <span class="n">lane</span> <span class="o">=</span> <span class="n">lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">lanes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">lane_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">show_feed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">show_feed</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link_to_list_feed&#39;</span><span class="p">,</span> <span class="n">show_feed</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">lane_name</span><span class="p">)</span>
            <span class="n">lane</span> <span class="o">=</span> <span class="n">lane</span><span class="p">[</span><span class="s1">&#39;lane&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lane</span><span class="p">,</span> <span class="n">lane_name</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s1">&#39;display_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">display_name</span>

        <span class="k">if</span> <span class="n">show_feed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span><span class="p">),</span> <span class="n">title</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span><span class="p">),</span> <span class="n">title</span></div>

<div class="viewcode-block" id="LibraryAnnotator.lane_url"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If the lane has sublanes, the URL identifying the group will</span>
        <span class="c1"># take the user to another set of groups for the</span>
        <span class="c1"># sublanes. Otherwise it will take the user to a list of the</span>
        <span class="c1"># books in the lane by author.</span>

        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">sublanes</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lane</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">Lane</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">DynamicLane</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This lane isn&#39;t part of our lane hierarchy. It&#39;s probably</span>
            <span class="c1"># a WorkList created to represent the top-level. Use the top-level</span>
            <span class="c1"># url for it.</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_lane_url</span><span class="p">(</span><span class="n">facets</span><span class="o">=</span><span class="n">facets</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="LibraryAnnotator.annotate_work_entry"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.annotate_work_entry">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_work_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="c1"># Add a link for reporting problems.</span>
        <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
            <span class="n">entry</span><span class="p">,</span>
            <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;issues&#39;</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;report&#39;</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">annotate_work_entry</span><span class="p">(</span>
            <span class="n">work</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">edition</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span>
        <span class="p">)</span>

        <span class="c1"># Add a link to each author tag.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_author_links</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

        <span class="c1"># And a series, if there is one.</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_series_link</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">NoveListAPI</span><span class="o">.</span><span class="n">is_configured</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">):</span>
            <span class="c1"># If NoveList Select is configured, there might be</span>
            <span class="c1"># recommendations, too.</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;recommendations&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Recommended Works&#39;</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s1">&#39;recommendations&#39;</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add a link for related books if available.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_books_available</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">):</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;related&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Recommended Works&#39;</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s1">&#39;related_books&#39;</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add a link to get a patron&#39;s annotations for this book.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/ns/oa#annotationService&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">AnnotationWriter</span><span class="o">.</span><span class="n">CONTENT_TYPE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s1">&#39;annotations_for_work&#39;</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">Analytics</span><span class="o">.</span><span class="n">is_configured</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">):</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://librarysimplified.org/terms/rel/analytics/open-book&quot;</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s1">&#39;track_analytics_event&#39;</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">event_type</span><span class="o">=</span><span class="n">CirculationEvent</span><span class="o">.</span><span class="n">OPEN_BOOK</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.related_books_available"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.related_books_available">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">related_books_available</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:return: bool asserting whether related books might exist for a particular Work</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">sort_author</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">sort_author</span> <span class="o">!=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">UNKNOWN_AUTHOR</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">contributions</span>
                <span class="ow">or</span> <span class="n">work</span><span class="o">.</span><span class="n">series</span>
                <span class="ow">or</span> <span class="n">NoveListAPI</span><span class="o">.</span><span class="n">is_configured</span><span class="p">(</span><span class="n">library</span><span class="p">))</span></div>

<div class="viewcode-block" id="LibraryAnnotator.language_and_audience_key_from_work"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.language_and_audience_key_from_work">[docs]</a>    <span class="k">def</span> <span class="nf">language_and_audience_key_from_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">):</span>
        <span class="n">language_key</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">language</span>

        <span class="n">audiences</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_YOUNG_ADULT</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_JUVENILE</span>
        <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="p">[</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_CHILDREN</span><span class="p">,</span>
                <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_ALL_AGES</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="ow">in</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_ADULT</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES_NO_RESEARCH</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">work</span><span class="o">.</span><span class="n">audience</span> <span class="o">==</span> <span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCE_RESEARCH</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audiences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">audience_key</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">audiences</span><span class="p">:</span>
            <span class="n">audience_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">audiences</span><span class="p">)]</span>
            <span class="n">audience_key</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">audience_strings</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">language_key</span><span class="p">,</span> <span class="n">audience_key</span></div>

<div class="viewcode-block" id="LibraryAnnotator.add_author_links"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.add_author_links">[docs]</a>    <span class="k">def</span> <span class="nf">add_author_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all the &lt;author&gt; tags and add a link</span>
<span class="sd">        to each one that points to the author&#39;s other works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">author_tag</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}author&#39;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ATOM_NS</span>
        <span class="n">author_entries</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">author_tag</span><span class="p">)</span>

        <span class="n">languages</span><span class="p">,</span> <span class="n">audiences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_and_audience_key_from_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">author_entry</span> <span class="ow">in</span> <span class="n">author_entries</span><span class="p">:</span>
            <span class="n">name_tag</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}name&#39;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ATOM_NS</span>

            <span class="c1"># A database ID would be better than a name, but the</span>
            <span class="c1"># &lt;author&gt; tag was created as part of the work&#39;s cached</span>
            <span class="c1"># OPDS entry, and as a rule we don&#39;t put database IDs into</span>
            <span class="c1"># the cached OPDS entry.</span>
            <span class="c1">#</span>
            <span class="c1"># So we take the content of the &lt;author&gt; tag, use it in</span>
            <span class="c1"># the link, and -- only if the user decides to fetch this feed</span>
            <span class="c1"># -- we do a little extra work to turn this name back into</span>
            <span class="c1"># one or more contributors.</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: If we reliably had VIAF IDs for our contributors,</span>
            <span class="c1"># we could stick them in the &lt;author&gt; tags and get the</span>
            <span class="c1"># best of both worlds.</span>
            <span class="n">contributor_name</span> <span class="o">=</span> <span class="n">author_entry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name_tag</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contributor_name</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
                <span class="n">author_entry</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;contributor&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">contributor_name</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s1">&#39;contributor&#39;</span><span class="p">,</span>
                    <span class="n">contributor_name</span><span class="o">=</span><span class="n">contributor_name</span><span class="p">,</span>
                    <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
                    <span class="n">audiences</span><span class="o">=</span><span class="n">audiences</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.add_series_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.add_series_link">[docs]</a>    <span class="k">def</span> <span class="nf">add_series_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">series_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">schema_</span><span class="p">(</span><span class="s1">&#39;Series&#39;</span><span class="p">)</span>
        <span class="n">series_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">series_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">series_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># There is no &lt;series&gt; tag, and thus nothing to annotate.</span>
            <span class="c1"># This probably indicates an out-of-date OPDS entry.</span>
            <span class="n">work_id</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">id</span>
            <span class="n">work_title</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;add_series_link() called on work </span><span class="si">%s</span><span class="s1"> (&quot;</span><span class="si">%s</span><span class="s1">&quot;), which has no &lt;schema:Series&gt; tag in its OPDS entry.&#39;</span><span class="p">,</span>
                <span class="n">work_id</span><span class="p">,</span> <span class="n">work_title</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">series_name</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">series</span>
        <span class="n">languages</span><span class="p">,</span> <span class="n">audiences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_and_audience_key_from_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">href</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s1">&#39;series&#39;</span><span class="p">,</span>
            <span class="n">series_name</span><span class="o">=</span><span class="n">series_name</span><span class="p">,</span>
            <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
            <span class="n">audiences</span><span class="o">=</span><span class="n">audiences</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_entry</span><span class="p">(</span>
            <span class="n">series_entry</span><span class="p">,</span>
            <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;series&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">series_name</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="n">href</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.annotate_feed"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.annotate_feed">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">:</span>
            <span class="c1"># A patron is authenticated.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_patron</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No patron is authenticated. Show them how to</span>
            <span class="c1"># authenticate (or that authentication is not supported).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_authentication_document_link</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>

        <span class="c1"># Add a &#39;search&#39; link if the lane is searchable.</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">search_target</span><span class="p">:</span>
            <span class="n">search_facet_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span><span class="o">.</span><span class="n">entrypoint_is_default</span><span class="p">:</span>
                    <span class="c1"># The currently selected entry point is a default.</span>
                    <span class="c1"># Rather than using it, we want the &#39;default&#39; behavior</span>
                    <span class="c1"># for search, which is to search everything.</span>
                    <span class="n">search_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span><span class="o">.</span><span class="n">navigate</span><span class="p">(</span>
                        <span class="n">entrypoint</span><span class="o">=</span><span class="n">EverythingEntryPoint</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">search_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets</span>
                <span class="n">search_facet_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">search_facets</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>


            <span class="n">lane_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_identifier</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="n">search_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;lane_search&#39;</span><span class="p">,</span> <span class="n">lane_identifier</span><span class="o">=</span><span class="n">lane_identifier</span><span class="p">,</span>
                <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">search_facet_kwargs</span>
            <span class="p">)</span>
            <span class="n">search_link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;application/opensearchdescription+xml&quot;</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="n">search_url</span>
            <span class="p">)</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">search_link</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="c1"># Since this library authenticates patrons it can offer</span>
            <span class="c1"># a bookshelf and an annotation service.</span>
            <span class="n">shelf_link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://opds-spec.org/shelf&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;active_loans&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">shelf_link</span><span class="p">)</span>

            <span class="n">annotations_link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/ns/oa#annotationService&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">AnnotationWriter</span><span class="o">.</span><span class="n">CONTENT_TYPE</span><span class="p">,</span>
                <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;annotations&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">annotations_link</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lane</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">uses_customlists</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s2">&quot;customlists&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">customlists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
                <span class="n">customlist</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">get_customlists</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">customlist</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">customlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">crawlable_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                    <span class="s2">&quot;crawlable_list_feed&quot;</span><span class="p">,</span> <span class="n">list_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
                    <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">crawlable_link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;http://opds-spec.org/crawlable&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_FEED_TYPE</span><span class="p">,</span>
                    <span class="n">href</span><span class="o">=</span><span class="n">crawlable_url</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">crawlable_link</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_configuration_links</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.add_configuration_links"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.add_configuration_links">[docs]</a>    <span class="k">def</span> <span class="nf">add_configuration_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_add_link</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">OPDSFeed</span><span class="p">):</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="o">**</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is an ElementTree object.</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="o">**</span><span class="n">l</span><span class="p">)</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIGURATION_LINKS</span><span class="p">:</span>
            <span class="n">setting</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">setting</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">)</span>
                <span class="n">_add_link</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">navigation_urls</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
            <span class="n">Configuration</span><span class="o">.</span><span class="n">WEB_HEADER_LINKS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">json_value</span>
        <span class="k">if</span> <span class="n">navigation_urls</span><span class="p">:</span>
            <span class="n">navigation_labels</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library</span><span class="p">(</span>
                <span class="n">Configuration</span><span class="o">.</span><span class="n">WEB_HEADER_LABELS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span><span class="o">.</span><span class="n">json_value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">navigation_urls</span><span class="p">,</span> <span class="n">navigation_labels</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;related&quot;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;navigation&quot;</span><span class="p">)</span>
                <span class="n">_add_link</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">help_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;help&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
            <span class="n">_add_link</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.acquisition_links"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.acquisition_links">[docs]</a>    <span class="k">def</span> <span class="nf">acquisition_links</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span>
            <span class="n">active_fulfillment</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span>
            <span class="n">direct_fulfillment_delivery_mechanisms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mock_api</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate one or more &lt;link&gt; tags that can be used to borrow,</span>
<span class="sd">        reserve, or fulfill a book, depending on the state of the book</span>
<span class="sd">        and the current patron.</span>

<span class="sd">        :param active_license_pool: The LicensePool for which we&#39;re trying to</span>
<span class="sd">           generate &lt;link&gt; tags.</span>
<span class="sd">        :param active_loan: A Loan object representing the current patron&#39;s</span>
<span class="sd">           existing loan for this title, if any.</span>
<span class="sd">        :param active_hold: A Hold object representing the current patron&#39;s</span>
<span class="sd">           existing hold on this title, if any.</span>
<span class="sd">        :param active_fulfillment: A LicensePoolDeliveryMechanism object</span>
<span class="sd">           representing the mechanism, if any, which the patron has chosen</span>
<span class="sd">           to fulfill this work.</span>
<span class="sd">        :param feed: The OPDSFeed that will eventually contain these &lt;link&gt;</span>
<span class="sd">           tags.</span>
<span class="sd">        :param identifier: The Identifier of the title for which we&#39;re</span>
<span class="sd">           trying to generate &lt;link&gt; tags.</span>
<span class="sd">        :param direct_fulfillment_delivery_mechanisms: A list of</span>
<span class="sd">           LicensePoolDeliveryMechanisms for the given LicensePool</span>
<span class="sd">           that should have fulfillment-type &lt;link&gt; tags generated for</span>
<span class="sd">           them, even if this method wouldn&#39;t normally think that</span>
<span class="sd">           makes sense.</span>
<span class="sd">        :param mock_api: A mock object to stand in for the API to the</span>
<span class="sd">           vendor who provided this LicensePool. If this is not provided, a</span>
<span class="sd">           live API for that vendor will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">direct_fulfillment_delivery_mechanisms</span> <span class="o">=</span> <span class="n">direct_fulfillment_delivery_mechanisms</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">mock_api</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span> <span class="ow">and</span> <span class="n">active_license_pool</span><span class="p">:</span>
            <span class="n">api</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">api_for_license_pool</span><span class="p">(</span><span class="n">active_license_pool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api</span><span class="p">:</span>
            <span class="n">set_mechanism_at_borrow</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">api</span><span class="o">.</span><span class="n">SET_DELIVERY_MECHANISM_AT</span> <span class="o">==</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">BORROW_STEP</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">active_license_pool</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">active_loan</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">delivery_mechanisms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">can_fulfill_without_loan</span><span class="p">(</span>
                            <span class="kc">None</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">lpdm</span>
                    <span class="p">):</span>
                        <span class="c1"># This title can be fulfilled without an</span>
                        <span class="c1"># active loan, so we&#39;re going to add an acquisition</span>
                        <span class="c1"># link that goes directly to the fulfillment step</span>
                        <span class="c1"># without the &#39;borrow&#39; step.</span>
                        <span class="n">direct_fulfillment_delivery_mechanisms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lpdm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is most likely an open-access book. Just put one</span>
            <span class="c1"># borrow link and figure out the rest later.</span>
            <span class="n">set_mechanism_at_borrow</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">acquisition_links</span><span class="p">(</span>
            <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span> <span class="n">active_fulfillment</span><span class="p">,</span>
            <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">can_hold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">allow_holds</span><span class="p">,</span>
            <span class="n">can_revoke_hold</span><span class="o">=</span><span class="p">(</span><span class="n">active_hold</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulation</span><span class="o">.</span><span class="n">can_revoke_hold</span><span class="p">(</span><span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">))),</span>
            <span class="n">set_mechanism_at_borrow</span><span class="o">=</span><span class="n">set_mechanism_at_borrow</span><span class="p">,</span>
            <span class="n">direct_fulfillment_delivery_mechanisms</span><span class="o">=</span><span class="n">direct_fulfillment_delivery_mechanisms</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.revoke_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.revoke_link">[docs]</a>    <span class="k">def</span> <span class="nf">revoke_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s1">&#39;revoke_loan_or_hold&#39;</span><span class="p">,</span>
            <span class="n">license_pool_id</span><span class="o">=</span><span class="n">active_license_pool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">REVOKE_LOAN_REL</span><span class="p">)</span>
        <span class="n">revoke_link_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">revoke_link_tag</span></div>

<div class="viewcode-block" id="LibraryAnnotator.borrow_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.borrow_link">[docs]</a>    <span class="k">def</span> <span class="nf">borrow_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span>
                    <span class="n">borrow_mechanism</span><span class="p">,</span> <span class="n">fulfillment_mechanisms</span><span class="p">,</span> <span class="n">active_hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">if</span> <span class="n">borrow_mechanism</span><span class="p">:</span>
            <span class="c1"># Following this link will both borrow the book and set</span>
            <span class="c1"># its delivery mechanism.</span>
            <span class="n">mechanism_id</span> <span class="o">=</span> <span class="n">borrow_mechanism</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Following this link will borrow the book but not set</span>
            <span class="c1"># its delivery mechanism.</span>
            <span class="n">mechanism_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">borrow_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;borrow&quot;</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">mechanism_id</span><span class="o">=</span><span class="n">mechanism_id</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">BORROW_REL</span>
        <span class="n">borrow_link</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">borrow_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ENTRY_TYPE</span>
        <span class="p">)</span>

        <span class="n">indirect_acquisitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">fulfillment_mechanisms</span><span class="p">:</span>
            <span class="c1"># We have information about one or more delivery</span>
            <span class="c1"># mechanisms that will be available at the point of</span>
            <span class="c1"># fulfillment. To the extent possible, put information</span>
            <span class="c1"># about these mechanisms into the &lt;link&gt; tag as</span>
            <span class="c1"># &lt;opds:indirectAcquisition&gt; tags.</span>

            <span class="c1"># These are the formats mentioned in the indirect</span>
            <span class="c1"># acquisition.</span>
            <span class="n">format_types</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">format_types</span><span class="p">(</span><span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">)</span>

            <span class="c1"># If we can borrow this book, add this delivery mechanism</span>
            <span class="c1"># to the borrow link as an &lt;opds:indirectAcquisition&gt;.</span>
            <span class="k">if</span> <span class="n">format_types</span><span class="p">:</span>
                <span class="n">indirect_acquisition</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">indirect_acquisition</span><span class="p">(</span>
                    <span class="n">format_types</span>
                <span class="p">)</span>
                <span class="n">indirect_acquisitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indirect_acquisition</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">indirect_acquisitions</span><span class="p">:</span>
            <span class="c1"># If there&#39;s no way to actually get the book, cancel the creation</span>
            <span class="c1"># of an OPDS entry altogether.</span>
            <span class="k">raise</span> <span class="n">UnfulfillableWork</span><span class="p">()</span>

        <span class="n">borrow_link</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">indirect_acquisitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">borrow_link</span></div>

<div class="viewcode-block" id="LibraryAnnotator.fulfill_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.fulfill_link">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">,</span>
                     <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_REL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new fulfillment link.</span>

<span class="sd">        This link may include tags from the OPDS Extensions for DRM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span> <span class="ow">and</span> <span class="n">rel</span> <span class="o">!=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">OPEN_ACCESS_REL</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delivery_mechanism</span><span class="p">,</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LicensePoolDeliveryMechanism passed into fulfill_link instead of DeliveryMechanism!&quot;</span><span class="p">)</span>
            <span class="n">delivery_mechanism</span> <span class="o">=</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">delivery_mechanism</span>
        <span class="n">format_types</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">format_types</span><span class="p">(</span><span class="n">delivery_mechanism</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">format_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fulfill_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;fulfill&quot;</span><span class="p">,</span>
            <span class="n">license_pool_id</span><span class="o">=</span><span class="n">license_pool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">mechanism_id</span><span class="o">=</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">link_tag</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">acquisition_link</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">fulfill_url</span><span class="p">,</span>
            <span class="n">types</span><span class="o">=</span><span class="n">format_types</span><span class="p">,</span>
            <span class="n">active_loan</span><span class="o">=</span><span class="n">active_loan</span>
        <span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">license_tags</span><span class="p">(</span><span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_device_registration_tags</span><span class="p">(</span>
            <span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">delivery_mechanism</span>
        <span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">link_tag</span></div>

<div class="viewcode-block" id="LibraryAnnotator.open_access_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.open_access_link">[docs]</a>    <span class="k">def</span> <span class="nf">open_access_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">):</span>
        <span class="n">link_tag</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">open_access_link</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">lpdm</span><span class="p">)</span>
        <span class="n">fulfill_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;fulfill&quot;</span><span class="p">,</span>
            <span class="n">license_pool_id</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">mechanism_id</span><span class="o">=</span><span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">fulfill_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">link_tag</span></div>

<div class="viewcode-block" id="LibraryAnnotator.drm_device_registration_tags"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.drm_device_registration_tags">[docs]</a>    <span class="k">def</span> <span class="nf">drm_device_registration_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span>
                                     <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct OPDS Extensions for DRM tags that explain how to</span>
<span class="sd">        register a device with the DRM server that manages this loan.</span>
<span class="sd">        :param delivery_mechanism: A DeliveryMechanism</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_loan</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">delivery_mechanism</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">drm_scheme</span> <span class="o">==</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span><span class="p">:</span>
            <span class="c1"># Get an identifier for the patron that will be registered</span>
            <span class="c1"># with the DRM server.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">active_loan</span><span class="p">)</span>
            <span class="n">patron</span> <span class="o">=</span> <span class="n">active_loan</span><span class="o">.</span><span class="n">patron</span>

            <span class="c1"># Generate a &lt;drm:licensor&gt; tag that can feed into the</span>
            <span class="c1"># Vendor ID service.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe_id_tags</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="LibraryAnnotator.adobe_id_tags"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.adobe_id_tags">[docs]</a>    <span class="k">def</span> <span class="nf">adobe_id_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct tags using the DRM Extensions for OPDS standard that</span>
<span class="sd">        explain how to get an Adobe ID for this patron, and how to</span>
<span class="sd">        manage their list of device IDs.</span>
<span class="sd">        :param delivery_mechanism: A DeliveryMechanism</span>
<span class="sd">        :return: If Adobe Vendor ID delegation is configured, a list</span>
<span class="sd">        containing a &lt;drm:licensor&gt; tag. If not, an empty list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># CirculationManagerAnnotators are created per request.</span>
        <span class="c1"># Within the context of a single request, we can cache the</span>
        <span class="c1"># tags that explain how the patron can get an Adobe ID, and</span>
        <span class="c1"># reuse them across &lt;entry&gt; tags. This saves a little time,</span>
        <span class="c1"># makes tests more reliable, and stops us from providing a</span>
        <span class="c1"># different Short Client Token for every &lt;entry&gt; tag.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_identifier</span><span class="p">,</span> <span class="n">Patron</span><span class="p">):</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="n">patron_identifier</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="n">patron_identifier</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adobe_id_tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">authdata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authdata</span> <span class="o">=</span> <span class="n">ShortClientTokenUtility</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CannotLoadConfiguration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot load Short Client Token configuration; outgoing OPDS entries will not have DRM autodiscovery support&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">authdata</span><span class="p">:</span>
                <span class="n">vendor_id</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">authdata</span><span class="o">.</span><span class="n">short_client_token_for_patron</span><span class="p">(</span><span class="n">patron_identifier</span><span class="p">)</span>
                <span class="n">drm_licensor</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}licensor&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DRM_NS</span><span class="p">)</span>
                <span class="n">vendor_attr</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}vendor&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DRM_NS</span>
                <span class="n">drm_licensor</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">vendor_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">vendor_id</span>
                <span class="n">patron_key</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}clientToken&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DRM_NS</span><span class="p">)</span>
                <span class="n">patron_key</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">token</span>
                <span class="n">drm_licensor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patron_key</span><span class="p">)</span>

                <span class="n">cached</span> <span class="o">=</span> <span class="p">[</span><span class="n">drm_licensor</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_adobe_id_tags</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached</span></div>

<div class="viewcode-block" id="LibraryAnnotator.add_patron"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.add_patron">[docs]</a>    <span class="k">def</span> <span class="nf">add_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patrons</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">patron_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="n">patron_details</span><span class="p">[</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}username&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">username</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">:</span>
            <span class="n">patron_details</span><span class="p">[</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}authorizationIdentifier&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>

        <span class="n">patron_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}patron&quot;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">SIMPLIFIED_NS</span><span class="p">,</span> <span class="n">patron_details</span><span class="p">)</span>
        <span class="n">feed_obj</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patron_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibraryAnnotator.add_authentication_document_link"><a class="viewcode-back" href="../../api.html#api.opds.LibraryAnnotator.add_authentication_document_link">[docs]</a>    <span class="k">def</span> <span class="nf">add_authentication_document_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a &lt;link&gt; tag that points to the circulation</span>
<span class="sd">        manager&#39;s Authentication for OPDS document</span>
<span class="sd">        for the current library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Even if self.identifies_patrons is false, we include this link,</span>
        <span class="c1"># because this document is the one that explains there is no</span>
        <span class="c1"># patron authentication at this library.</span>
        <span class="n">feed_obj</span><span class="o">.</span><span class="n">add_link_to_feed</span><span class="p">(</span>
            <span class="n">feed_obj</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span>
            <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;http://opds-spec.org/auth/document&#39;</span><span class="p">,</span>
            <span class="n">href</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;authentication_document&#39;</span><span class="p">,</span>
                <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="SharedCollectionAnnotator"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator">[docs]</a><span class="k">class</span> <span class="nc">SharedCollectionAnnotator</span><span class="p">(</span><span class="n">CirculationManagerAnnotator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span>
                 <span class="n">active_loans_by_work</span><span class="o">=</span><span class="p">{},</span> <span class="n">active_holds_by_work</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SharedCollectionAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">active_loans_by_work</span><span class="o">=</span><span class="n">active_loans_by_work</span><span class="p">,</span>
                                                        <span class="n">active_holds_by_work</span><span class="o">=</span><span class="n">active_holds_by_work</span><span class="p">,</span>
                                                        <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="n">active_fulfillments_by_work</span><span class="p">,</span>
                                                        <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

<div class="viewcode-block" id="SharedCollectionAnnotator.top_level_title"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.top_level_title">[docs]</a>    <span class="k">def</span> <span class="nf">top_level_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.default_lane_url"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.default_lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">default_lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;crawlable_collection_feed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.lane_url"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.lane_url">[docs]</a>    <span class="k">def</span> <span class="nf">lane_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;crawlable_collection_feed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.feed_url"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.feed_url">[docs]</a>    <span class="k">def</span> <span class="nf">feed_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;feed&#39;</span><span class="p">):</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SharedCollectionAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">feed_url</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">pagination</span><span class="p">,</span> <span class="n">default_route</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.acquisition_links"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.acquisition_links">[docs]</a>    <span class="k">def</span> <span class="nf">acquisition_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span> <span class="n">active_fulfillment</span><span class="p">,</span>
                          <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a number of &lt;link&gt; tags that enumerate all acquisition methods.&quot;&quot;&quot;</span>
        <span class="n">links</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SharedCollectionAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">acquisition_links</span><span class="p">(</span>
            <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">,</span> <span class="n">active_fulfillment</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

        <span class="n">info_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">active_loan</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;shared_collection_loan_info&#39;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">loan_id</span><span class="o">=</span><span class="n">active_loan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
            <span class="n">info_link_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">info_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_link_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">active_hold</span> <span class="ow">and</span> <span class="n">active_hold</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;shared_collection_hold_info&#39;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">hold_id</span><span class="o">=</span><span class="n">active_hold</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
            <span class="n">info_link_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">info_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_link_tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">links</span> <span class="o">+</span> <span class="n">info_links</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.revoke_link"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.revoke_link">[docs]</a>    <span class="k">def</span> <span class="nf">revoke_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">active_hold</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">active_loan</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;shared_collection_revoke_loan&#39;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">loan_id</span><span class="o">=</span><span class="n">active_loan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">active_hold</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s1">&#39;shared_collection_revoke_hold&#39;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">hold_id</span><span class="o">=</span><span class="n">active_hold</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">REVOKE_LOAN_REL</span><span class="p">)</span>
            <span class="n">revoke_link_tag</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">revoke_link_tag</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.borrow_link"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.borrow_link">[docs]</a>    <span class="k">def</span> <span class="nf">borrow_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_license_pool</span><span class="p">,</span>
                    <span class="n">borrow_mechanism</span><span class="p">,</span> <span class="n">fulfillment_mechanisms</span><span class="p">,</span> <span class="n">active_hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">open_access</span><span class="p">:</span>
            <span class="c1"># No need to borrow from a shared collection when the book</span>
            <span class="c1"># already has an open access link.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">active_license_pool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">if</span> <span class="n">active_hold</span><span class="p">:</span>
            <span class="n">borrow_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s2">&quot;shared_collection_borrow&quot;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">hold_id</span><span class="o">=</span><span class="n">active_hold</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">borrow_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
                <span class="s2">&quot;shared_collection_borrow&quot;</span><span class="p">,</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">BORROW_REL</span>
        <span class="n">borrow_link</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">link</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">borrow_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ENTRY_TYPE</span>
        <span class="p">)</span>

        <span class="n">indirect_acquisitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lpdm</span> <span class="ow">in</span> <span class="n">fulfillment_mechanisms</span><span class="p">:</span>
            <span class="c1"># We have information about one or more delivery</span>
            <span class="c1"># mechanisms that will be available at the point of</span>
            <span class="c1"># fulfillment. To the extent possible, put information</span>
            <span class="c1"># about these mechanisms into the &lt;link&gt; tag as</span>
            <span class="c1"># &lt;opds:indirectAcquisition&gt; tags.</span>

            <span class="c1"># These are the formats mentioned in the indirect</span>
            <span class="c1"># acquisition.</span>
            <span class="n">format_types</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">format_types</span><span class="p">(</span><span class="n">lpdm</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="p">)</span>

            <span class="c1"># If we can borrow this book, add this delivery mechanism</span>
            <span class="c1"># to the borrow link as an &lt;opds:indirectAcquisition&gt;.</span>
            <span class="k">if</span> <span class="n">format_types</span><span class="p">:</span>
                <span class="n">indirect_acquisition</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">indirect_acquisition</span><span class="p">(</span>
                    <span class="n">format_types</span>
                <span class="p">)</span>
                <span class="n">indirect_acquisitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indirect_acquisition</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">indirect_acquisitions</span><span class="p">:</span>
            <span class="c1"># If there&#39;s no way to actually get the book, cancel the creation</span>
            <span class="c1"># of an OPDS entry altogether.</span>
            <span class="k">raise</span> <span class="n">UnfulfillableWork</span><span class="p">()</span>

        <span class="n">borrow_link</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">indirect_acquisitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">borrow_link</span></div>

<div class="viewcode-block" id="SharedCollectionAnnotator.fulfill_link"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionAnnotator.fulfill_link">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">,</span>
                     <span class="n">rel</span><span class="o">=</span><span class="n">OPDSFeed</span><span class="o">.</span><span class="n">ACQUISITION_REL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new fulfillment link.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delivery_mechanism</span><span class="p">,</span> <span class="n">LicensePoolDeliveryMechanism</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LicensePoolDeliveryMechanism passed into fulfill_link instead of DeliveryMechanism!&quot;</span><span class="p">)</span>
            <span class="n">delivery_mechanism</span> <span class="o">=</span> <span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">delivery_mechanism</span>
        <span class="n">format_types</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">format_types</span><span class="p">(</span><span class="n">delivery_mechanism</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">format_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fulfill_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;shared_collection_fulfill&quot;</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">loan_id</span><span class="o">=</span><span class="n">active_loan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">mechanism_id</span><span class="o">=</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">link_tag</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">acquisition_link</span><span class="p">(</span>
            <span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">fulfill_url</span><span class="p">,</span>
            <span class="n">types</span><span class="o">=</span><span class="n">format_types</span><span class="p">,</span>
            <span class="n">active_loan</span><span class="o">=</span><span class="n">active_loan</span>
        <span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="o">.</span><span class="n">license_tags</span><span class="p">(</span><span class="n">license_pool</span><span class="p">,</span> <span class="n">active_loan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">link_tag</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">link_tag</span></div></div>

<div class="viewcode-block" id="LibraryLoanAndHoldAnnotator"><a class="viewcode-back" href="../../api.html#api.opds.LibraryLoanAndHoldAnnotator">[docs]</a><span class="k">class</span> <span class="nc">LibraryLoanAndHoldAnnotator</span><span class="p">(</span><span class="n">LibraryAnnotator</span><span class="p">):</span>

<div class="viewcode-block" id="LibraryLoanAndHoldAnnotator.active_loans_for"><a class="viewcode-back" href="../../api.html#api.opds.LibraryLoanAndHoldAnnotator.active_loans_for">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">active_loans_for</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">circulation</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">active_loans_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">patron</span><span class="o">.</span><span class="n">loans</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">work</span>
            <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">active_loans_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">loan</span>
        <span class="n">active_holds_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">patron</span><span class="o">.</span><span class="n">holds</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">work</span>
            <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">active_holds_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">hold</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">circulation</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">active_loans_by_work</span><span class="p">,</span> <span class="n">active_holds_by_work</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span>
        <span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;active_loans&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">works</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">works_on_loan_or_on_hold</span><span class="p">()</span>

        <span class="n">feed_obj</span> <span class="o">=</span> <span class="n">AcquisitionFeed</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;Active loans and holds&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">works</span><span class="p">,</span> <span class="n">annotator</span><span class="p">)</span>
        <span class="n">annotator</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span><span class="n">feed_obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">feed_obj</span><span class="o">.</span><span class="n">as_response</span><span class="p">(</span><span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">last_modified</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">last_loan_activity_sync</span>
        <span class="k">if</span> <span class="n">last_modified</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">last_modified</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="LibraryLoanAndHoldAnnotator.single_item_feed"><a class="viewcode-back" href="../../api.html#api.opds.LibraryLoanAndHoldAnnotator.single_item_feed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">single_item_feed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">circulation</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">fulfillment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">feed_class</span><span class="o">=</span><span class="n">AcquisitionFeed</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a response containing a single OPDS entry representing an active loan</span>
<span class="sd">        or hold.</span>

<span class="sd">        :param circulation: A CirculationAPI</span>
<span class="sd">        :param item: A Loan, Hold, or LicensePool if first two are missing.</span>
<span class="sd">        :param fulfillment: A FulfillmentInfo representing the format in which an active loan</span>
<span class="sd">            should be fulfilled.</span>
<span class="sd">        :param test_mode: Passed along to the constructor for this annotator class.</span>
<span class="sd">        :param feed_class: A drop-in replacement for AcquisitionFeed, for use in tests.</span>
<span class="sd">        :param response_kwargs: Extra keyword arguments to be passed into the OPDSEntryResponse</span>
<span class="sd">            constructor.</span>

<span class="sd">        :return: An OPDSEntryResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;item&#39; must be non-empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">):</span>
            <span class="n">license_pool</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">circulation</span><span class="o">.</span><span class="n">library</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">Loan</span><span class="p">,</span> <span class="n">Hold</span><span class="p">)):</span>
            <span class="n">license_pool</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">license_pool</span>
            <span class="n">library</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">library</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Argument &#39;item&#39; must be an instance of </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">, or </span><span class="si">{2}</span><span class="s2"> classes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">Loan</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">LicensePool</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">work</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span>
        <span class="n">active_loans_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">active_holds_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">active_fulfillments_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">item_dictionary</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Loan</span><span class="p">):</span>
            <span class="n">item_dictionary</span> <span class="o">=</span> <span class="n">active_loans_by_work</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Hold</span><span class="p">):</span>
            <span class="n">item_dictionary</span> <span class="o">=</span> <span class="n">active_holds_by_work</span>

        <span class="k">if</span> <span class="n">item_dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_dictionary</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="k">if</span> <span class="n">fulfillment</span><span class="p">:</span>
            <span class="n">active_fulfillments_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">fulfillment</span>

        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">circulation</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span>
            <span class="n">active_loans_by_work</span><span class="o">=</span><span class="n">active_loans_by_work</span><span class="p">,</span>
            <span class="n">active_holds_by_work</span><span class="o">=</span><span class="n">active_holds_by_work</span><span class="p">,</span>
            <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="n">active_fulfillments_by_work</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span>
        <span class="p">)</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s1">&#39;loan_or_hold_detail&#39;</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">library_short_name</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">annotator</span><span class="o">.</span><span class="n">_single_entry_response</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">feed_class</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LibraryLoanAndHoldAnnotator.drm_device_registration_feed_tags"><a class="viewcode-back" href="../../api.html#api.opds.LibraryLoanAndHoldAnnotator.drm_device_registration_feed_tags">[docs]</a>    <span class="k">def</span> <span class="nf">drm_device_registration_feed_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tags that provide information on DRM device deregistration</span>
<span class="sd">        independent of any particular loan. These tags will go under</span>
<span class="sd">        the &lt;feed&gt; tag.</span>

<span class="sd">        This allows us to deregister an Adobe ID, in preparation for</span>
<span class="sd">        logout, even if there is no active loan that requires one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe_id_tags</span><span class="p">(</span><span class="n">patron</span><span class="p">))</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}scheme&#39;</span> <span class="o">%</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">DRM_NS</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://librarysimplified.org/terms/drm/scheme/ACS&quot;</span>
        <span class="k">return</span> <span class="n">tags</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_profile_management_protocol_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a &lt;link&gt; tag that points to the circulation</span>
<span class="sd">        manager&#39;s User Profile Management Protocol endpoint</span>
<span class="sd">        for the current patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">OPDSFeed</span><span class="o">.</span><span class="n">makeelement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">)</span>
        <span class="n">link</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://librarysimplified.org/terms/rel/user-profile&#39;</span>
        <span class="n">link</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="s1">&#39;patron_profile&#39;</span><span class="p">,</span> <span class="n">library_short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">link</span>

<div class="viewcode-block" id="LibraryLoanAndHoldAnnotator.annotate_feed"><a class="viewcode-back" href="../../api.html#api.opds.LibraryLoanAndHoldAnnotator.annotate_feed">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotate the feed with top-level DRM device registration tags</span>
<span class="sd">        and a link to the User Profile Management Protocol endpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibraryLoanAndHoldAnnotator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">annotate_feed</span><span class="p">(</span>
            <span class="n">feed</span><span class="p">,</span> <span class="n">lane</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drm_device_registration_feed_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_profile_management_protocol_link</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SharedCollectionLoanAndHoldAnnotator"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionLoanAndHoldAnnotator">[docs]</a><span class="k">class</span> <span class="nc">SharedCollectionLoanAndHoldAnnotator</span><span class="p">(</span><span class="n">SharedCollectionAnnotator</span><span class="p">):</span>

<div class="viewcode-block" id="SharedCollectionLoanAndHoldAnnotator.single_item_feed"><a class="viewcode-back" href="../../api.html#api.opds.SharedCollectionLoanAndHoldAnnotator.single_item_feed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">single_item_feed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">fulfillment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">feed_class</span><span class="o">=</span><span class="n">AcquisitionFeed</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an OPDS entry representing a single loan or hold.</span>

<span class="sd">        TODO: This and LibraryLoanAndHoldAnnotator.single_item_feed</span>
<span class="sd">        can potentially be refactored. The main obstacle is different</span>
<span class="sd">        routes and arguments for &#39;loan info&#39; and &#39;hold info&#39;.</span>

<span class="sd">        :return: An OPDSEntryResponse</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">license_pool</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">work</span> <span class="ow">or</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">work</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>

        <span class="n">active_loans_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">active_holds_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">active_fulfillments_by_work</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fulfillment</span><span class="p">:</span>
            <span class="n">active_fulfillments_by_work</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">fulfillment</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Loan</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">active_loans_by_work</span>
            <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;shared_collection_loan_info&#39;</span>
            <span class="n">route_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">loan_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Hold</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">active_holds_by_work</span>
            <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;shared_collection_hold_info&#39;</span>
            <span class="n">route_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hold_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">work</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">collection</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">active_loans_by_work</span><span class="o">=</span><span class="n">active_loans_by_work</span><span class="p">,</span>
            <span class="n">active_holds_by_work</span><span class="o">=</span><span class="n">active_holds_by_work</span><span class="p">,</span>
            <span class="n">active_fulfillments_by_work</span><span class="o">=</span><span class="n">active_fulfillments_by_work</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span>
        <span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
            <span class="n">route</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">route_kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">annotator</span><span class="o">.</span><span class="n">_single_entry_response</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">annotator</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">feed_class</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
        <span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>