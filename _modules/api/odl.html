
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.odl &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.odl</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">import</span> <span class="nn">feedparser</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">.problem_details</span> <span class="kn">import</span> <span class="n">NO_LICENSES</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">uritemplate</span> <span class="kn">import</span> <span class="n">URITemplate</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">or_</span>

<span class="kn">from</span> <span class="nn">core.opds_import</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OPDSXMLParser</span><span class="p">,</span>
    <span class="n">OPDSImporter</span><span class="p">,</span>
    <span class="n">OPDSImportMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.monitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionMonitor</span><span class="p">,</span>
    <span class="n">TimelineMonitor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Hold</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">IntegrationClient</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">MediaTypes</span><span class="p">,</span>
    <span class="n">RightsStatus</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">create</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">IdentifierData</span><span class="p">,</span>
    <span class="n">LicenseData</span><span class="p">,</span>
    <span class="n">TimestampData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.circulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseCirculationAPI</span><span class="p">,</span>
    <span class="n">LoanInfo</span><span class="p">,</span>
    <span class="n">FulfillmentInfo</span><span class="p">,</span>
    <span class="n">HoldInfo</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>
<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">utc_now</span><span class="p">,</span>
    <span class="n">strptime_utc</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HTTP</span><span class="p">,</span>
    <span class="n">BadResponseException</span><span class="p">,</span>
    <span class="n">RemoteIntegrationException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.string_helpers</span> <span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatabaseTest</span><span class="p">,</span>
    <span class="n">MockRequestsResponse</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.circulation_exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.shared_collection</span> <span class="kn">import</span> <span class="n">BaseSharedCollectionAPI</span>

<div class="viewcode-block" id="ODLAPI"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI">[docs]</a><span class="k">class</span> <span class="nc">ODLAPI</span><span class="p">(</span><span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">BaseSharedCollectionAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ODL (Open Distribution to Libraries) is a specification that allows</span>
<span class="sd">    libraries to manage their own loans and holds. It offers a deeper level</span>
<span class="sd">    of control to the library, but it requires the circulation manager to</span>
<span class="sd">    keep track of individual copies rather than just license pools, and</span>
<span class="sd">    manage its own holds queues.</span>

<span class="sd">    In addition to circulating books to patrons of a library on the current circulation</span>
<span class="sd">    manager, this API can be used to circulate books to patrons of external libraries.</span>
<span class="sd">    Only one circulation manager per ODL collection should use an ODLAPI</span>
<span class="sd">    - the others should use a SharedODLAPI and configure it to connect to the main</span>
<span class="sd">    circulation manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;ODL&quot;</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Import books from a distributor that uses ODL (Open Distribution to Libraries).&quot;</span><span class="p">)</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ODL feed URL&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library&#39;s API username&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library&#39;s API password&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Data source name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">DEFAULT_RESERVATION_PERIOD_KEY</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Default Reservation Period (in Days)&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The number of days a patron has to check out a book after a hold becomes available.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">STANDARD_DEFAULT_RESERVATION_PERIOD</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">BaseSharedCollectionAPI</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">EBOOK_LOAN_DURATION_SETTING</span>
    <span class="p">]</span>

    <span class="n">SET_DELIVERY_MECHANISM_AT</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">FULFILL_STEP</span>

    <span class="c1"># Possible status values in the License Status Document:</span>

    <span class="c1"># The license is available but the user hasn&#39;t fulfilled it yet.</span>
    <span class="n">READY_STATUS</span> <span class="o">=</span> <span class="s2">&quot;ready&quot;</span>

    <span class="c1"># The license is available and has been fulfilled on at least one device.</span>
    <span class="n">ACTIVE_STATUS</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>

    <span class="c1"># The license has been revoked by the distributor.</span>
    <span class="n">REVOKED_STATUS</span> <span class="o">=</span> <span class="s2">&quot;revoked&quot;</span>

    <span class="c1"># The license has been returned early by the user.</span>
    <span class="n">RETURNED_STATUS</span> <span class="o">=</span> <span class="s2">&quot;returned&quot;</span>

    <span class="c1"># The license was returned early and was never fulfilled.</span>
    <span class="n">CANCELLED_STATUS</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>

    <span class="c1"># The license has expired.</span>
    <span class="n">EXPIRED_STATUS</span> <span class="o">=</span> <span class="s2">&quot;expired&quot;</span>

    <span class="n">STATUS_VALUES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">READY_STATUS</span><span class="p">,</span>
        <span class="n">ACTIVE_STATUS</span><span class="p">,</span>
        <span class="n">REVOKED_STATUS</span><span class="p">,</span>
        <span class="n">RETURNED_STATUS</span><span class="p">,</span>
        <span class="n">CANCELLED_STATUS</span><span class="p">,</span>
        <span class="n">EXPIRED_STATUS</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection protocol is </span><span class="si">%s</span><span class="s2">, but passed into ODLAPI!&quot;</span> <span class="o">%</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Create the data source if it doesn&#39;t exist yet.</span>
        <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">Analytics</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="ODLAPI.internal_format"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.internal_format">[docs]</a>    <span class="k">def</span> <span class="nf">internal_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Each consolidated copy is only available in one format, so we don&#39;t need</span>
<span class="sd">        a mapping to internal formats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">delivery_mechanism</span></div>

<div class="viewcode-block" id="ODLAPI.collection"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.collection">[docs]</a>    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a normal HTTP request, but include an authentication</span>
<span class="sd">        header with the credentials for the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="s2">&quot;Basic </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_header</span>

        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">get_with_timeout</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around flask&#39;s url_for to be overridden for tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ODLAPI.get_license_status_document"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.get_license_status_document">[docs]</a>    <span class="k">def</span> <span class="nf">get_license_status_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the License Status Document for a loan.</span>

<span class="sd">        For a new loan, create a local loan with no external identifier and</span>
<span class="sd">        pass it in to this method.</span>

<span class="sd">        This will create the remote loan if one doesn&#39;t exist yet. The loan&#39;s</span>
<span class="sd">        internal database id will be used to receive notifications from the</span>
<span class="sd">        distributor when the loan&#39;s status changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">identifier</span>
            <span class="n">checkout_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">patron</span><span class="p">:</span>
                <span class="n">default_loan_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: should integration clients be able to specify their own loan period?</span>
                <span class="n">default_loan_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">integration_client</span>
                 <span class="p">)</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                <span class="n">days</span><span class="o">=</span><span class="n">default_loan_period</span>
            <span class="p">)</span>
            <span class="c1"># The patron UUID is generated randomly on each loan, so the distributor</span>
            <span class="c1"># doesn&#39;t know when multiple loans come from the same patron.</span>
            <span class="n">patron_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">patron</span><span class="p">:</span>
                <span class="n">library_short_name</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">short_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If this is for an integration client, choose an arbitrary library.</span>
                <span class="n">library_short_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">libraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">short_name</span>
            <span class="n">notification_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_for</span><span class="p">(</span>
                <span class="s2">&quot;odl_notify&quot;</span><span class="p">,</span>
                <span class="n">library_short_name</span><span class="o">=</span><span class="n">library_short_name</span><span class="p">,</span>
                <span class="n">loan_id</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">url_template</span> <span class="o">=</span> <span class="n">URITemplate</span><span class="p">(</span><span class="n">loan</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">checkout_url</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">checkout_id</span><span class="o">=</span><span class="n">checkout_id</span><span class="p">,</span>
                <span class="n">patron_id</span><span class="o">=</span><span class="n">patron_id</span><span class="p">,</span>
                <span class="n">expires</span><span class="o">=</span><span class="p">(</span><span class="n">expires</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span><span class="p">),</span>
                <span class="n">notification_url</span><span class="o">=</span><span class="n">notification_url</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">status_doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;License Status Document was not valid JSON.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_VALUES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;License Status Document had an unknown status value.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status_doc</span></div>

<div class="viewcode-block" id="ODLAPI.checkin"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a loan early.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loan</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkin</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loan</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_license_status_document</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">REVOKED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RETURNED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CANCELLED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRED_STATUS</span><span class="p">]:</span>
            <span class="c1"># This loan was already returned early or revoked by the distributor, or it expired.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>

        <span class="n">return_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
                <span class="n">return_url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_url</span><span class="p">:</span>
            <span class="c1"># The distributor didn&#39;t provide a link to return this loan.</span>
            <span class="c1"># This may be because the book has already been fulfilled and</span>
            <span class="c1"># must be returned through the DRM system. If that&#39;s true, the</span>
            <span class="c1"># app will already be doing that on its own, so we&#39;ll silently</span>
            <span class="c1"># do nothing.</span>
            <span class="k">return</span>

        <span class="c1"># Hit the distributor&#39;s return link.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>
        <span class="c1"># Get the status document again to make sure the return was successful,</span>
        <span class="c1"># and if so update the pool availability and delete the local loan.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>

        <span class="c1"># At this point, if the loan still exists, something went wrong.</span>
        <span class="c1"># However, it might be because the loan has already been fulfilled</span>
        <span class="c1"># and must be returned through the DRM system, which the app will</span>
        <span class="c1"># do on its own, so we can ignore the problem.</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Loan</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ODLAPI.checkout"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new loan.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loan</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlreadyCheckedOut</span><span class="p">()</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span> <span class="n">license_pool_id</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkout</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="n">external_identifier</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_client</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>

        <span class="n">unexpired_licenses</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">licenses</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">is_expired</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">unexpired_licenses</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NoLicenses</span><span class="p">()</span>

        <span class="c1"># Make sure pool info is updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_hold_end_date</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="c1"># If there&#39;s a holds queue, the patron or client must have a non-expired hold</span>
        <span class="c1"># with position 0 to check out the book.</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">hold</span> <span class="ow">or</span>
             <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
             <span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="ow">and</span> <span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">utc_now</span><span class="p">()))</span> <span class="ow">and</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&lt;</span> <span class="mi">1</span>
            <span class="p">):</span>
            <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">()</span>

        <span class="c1"># Create a local loan so its database id can be used to</span>
        <span class="c1"># receive notifications from the distributor.</span>
        <span class="n">license</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">best_available_license</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">license</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">()</span>
        <span class="n">loan</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">license</span><span class="o">.</span><span class="n">loan_to</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_license_status_document</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">READY_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVE_STATUS</span><span class="p">]:</span>
            <span class="c1"># Something went wrong with this loan and we don&#39;t actually</span>
            <span class="c1"># have the book checked out. This should never happen.</span>
            <span class="c1"># Remove the loan we created.</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">external_identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">external_identifier</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_identifier</span><span class="p">:</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_rights&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>

        <span class="c1"># We need to set the start and end dates on our local loan since</span>
        <span class="c1"># the code that calls this only sets them when a new loan is created.</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">expires</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span> <span class="o">=</span> <span class="n">external_identifier</span>

        <span class="c1"># We also need to update the remaining checkouts for the license.</span>
        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">remaining_checkouts</span><span class="p">:</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">remaining_checkouts</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># We have successfully borrowed this book.</span>
        <span class="k">if</span> <span class="n">hold</span><span class="p">:</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loan</span>

<div class="viewcode-block" id="ODLAPI.fulfill"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the actual resource file to the patron.</span>

<span class="sd">        :param kwargs: A container for arguments to fulfill()</span>
<span class="sd">           which are not relevant to this vendor.</span>

<span class="sd">        :return: a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loan</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fulfill</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loan</span><span class="p">):</span>
        <span class="n">licensepool</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_license_status_document</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">READY_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVE_STATUS</span><span class="p">]:</span>
            <span class="c1"># This loan isn&#39;t available for some reason. It&#39;s possible</span>
            <span class="c1"># the distributor revoked it or the patron already returned it</span>
            <span class="c1"># through the DRM system, and we didn&#39;t get a notification</span>
            <span class="c1"># from the distributor yet.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>

        <span class="n">expires</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;potential_rights&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">content_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="c1"># Depending on the format being served, the crucial information</span>
            <span class="c1"># may be in &#39;manifest&#39; or in &#39;license&#39;.</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: when both links are present, access to the</span>
            <span class="c1"># DeliveryMechanism would be great for figuring out which</span>
            <span class="c1"># one to use.</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;manifest&quot;</span><span class="p">,</span> <span class="s2">&quot;license&quot;</span><span class="p">):</span>
                <span class="n">content_link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">content_link</span><span class="p">,</span>
            <span class="n">content_type</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">expires</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_count_holds_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="c1"># Count holds on the license pool that started before this hold and</span>
        <span class="c1"># aren&#39;t expired.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">hold</span><span class="o">.</span><span class="n">license_pool_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">start</span><span class="o">&lt;</span><span class="n">hold</span><span class="o">.</span><span class="n">start</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;</span><span class="n">utc_now</span><span class="p">(),</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">position</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_hold_end_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span>

        <span class="c1"># First make sure the hold position is up-to-date, since we&#39;ll</span>
        <span class="c1"># need it to calculate the end date.</span>
        <span class="n">original_position</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hold_position</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="n">default_loan_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">library</span> <span class="ow">or</span> <span class="n">hold</span><span class="o">.</span><span class="n">integration_client</span>
        <span class="p">)</span>
        <span class="n">default_reservation_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">default_reservation_period</span>

        <span class="c1"># If the hold was already to check out and already has an end date,</span>
        <span class="c1"># it doesn&#39;t need an update.</span>
        <span class="k">if</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">original_position</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">hold</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If the patron is in the queue, we need to estimate when the book</span>
        <span class="c1"># will be available for check out. We can do slightly better than the</span>
        <span class="c1"># default calculation since we know when all current loans will expire,</span>
        <span class="c1"># but we&#39;re still calculating the worst case.</span>
        <span class="k">elif</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find the current loans and reserved holds for the licenses.</span>
            <span class="n">current_loans</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">pool</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;</span><span class="n">utc_now</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">current_holds</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">pool</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;</span><span class="n">utc_now</span><span class="p">(),</span>
                    <span class="n">Hold</span><span class="o">.</span><span class="n">position</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Hold</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">licenses_reserved</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_loans</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_holds</span><span class="p">))</span>
            <span class="n">current_reservations</span> <span class="o">=</span> <span class="n">current_holds</span><span class="p">[:</span><span class="n">licenses_reserved</span><span class="p">]</span>

            <span class="c1"># The licenses will have to go through some number of cycles</span>
            <span class="c1"># before one of them gets to this hold. This leavs out the first cycle -</span>
            <span class="c1"># it&#39;s already started so we&#39;ll handle it separately.</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">licenses_reserved</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span>

            <span class="c1"># Each of the owned licenses is currently either on loan or reserved.</span>
            <span class="c1"># Figure out which license this hold will eventually get if every</span>
            <span class="c1"># patron keeps their loans and holds for the maximum time.</span>
            <span class="n">copy_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">licenses_reserved</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="o">%</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span>

            <span class="c1"># In the worse case, the first cycle ends when a current loan expires, or</span>
            <span class="c1"># after a current reservation is checked out and then expires.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_loans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">copy_index</span><span class="p">:</span>
                <span class="n">next_cycle_start</span> <span class="o">=</span> <span class="n">current_loans</span><span class="p">[</span><span class="n">copy_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reservation</span> <span class="o">=</span> <span class="n">current_reservations</span><span class="p">[</span><span class="n">copy_index</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_loans</span><span class="p">)]</span>
                <span class="n">next_cycle_start</span> <span class="o">=</span> <span class="n">reservation</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">default_loan_period</span><span class="p">)</span>

            <span class="c1"># Assume all cycles after the first cycle take the maximum time.</span>
            <span class="n">cycle_period</span> <span class="o">=</span> <span class="n">default_loan_period</span> <span class="o">+</span> <span class="n">default_reservation_period</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">next_cycle_start</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">cycle_period</span> <span class="o">*</span> <span class="n">cycles</span><span class="p">))</span>

        <span class="c1"># If the end date isn&#39;t set yet or the position just became 0, the</span>
        <span class="c1"># hold just became available. The patron&#39;s reservation period starts now.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">default_reservation_period</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_hold_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="n">loans_count</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">pool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">utc_now</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">holds_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_holds_before</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="n">remaining_licenses</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">-</span> <span class="n">loans_count</span>

        <span class="k">if</span> <span class="n">remaining_licenses</span> <span class="o">&gt;</span> <span class="n">holds_count</span><span class="p">:</span>
            <span class="c1"># The hold is ready to check out.</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add 1 since position 0 indicates the hold is ready.</span>
            <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">holds_count</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="ODLAPI.update_hold_queue"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.update_hold_queue">[docs]</a>    <span class="k">def</span> <span class="nf">update_hold_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="c1"># Update the pool and the next holds in the queue when a license is reserved.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="n">loans_count</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;</span><span class="n">utc_now</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">remaining_licenses</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">-</span> <span class="n">loans_count</span>

        <span class="n">holds</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;</span><span class="n">utc_now</span><span class="p">(),</span>
                <span class="n">Hold</span><span class="o">.</span><span class="n">position</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">start</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">remaining_licenses</span><span class="p">:</span>
            <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">new_licenses_reserved</span> <span class="o">=</span> <span class="n">remaining_licenses</span>
            <span class="n">new_patrons_in_hold_queue</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_licenses_available</span> <span class="o">=</span> <span class="n">remaining_licenses</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span>
            <span class="n">new_licenses_reserved</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span>
            <span class="n">new_patrons_in_hold_queue</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">holds</span><span class="p">)</span>
        <span class="n">licensepool</span><span class="o">.</span><span class="n">update_availability</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_owned</span><span class="p">,</span>
            <span class="n">new_licenses_available</span><span class="p">,</span>
            <span class="n">new_licenses_reserved</span><span class="p">,</span>
            <span class="n">new_patrons_in_hold_queue</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="p">,</span>
            <span class="n">as_of</span><span class="o">=</span><span class="n">utc_now</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">holds</span><span class="p">[:</span><span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_reserved</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">hold</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># This hold just got a reserved license.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_hold_end_date</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLAPI.place_hold"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">notification_email_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new hold.&quot;&quot;&quot;</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_hold</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HoldInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="n">hold_position</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_client</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>

        <span class="c1"># Make sure pool info is updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CurrentlyAvailable</span><span class="p">()</span>

        <span class="c1"># Create local hold.</span>
        <span class="n">hold</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">on_hold_to</span><span class="p">(</span><span class="n">patron_or_client</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_new</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlreadyOnHold</span><span class="p">()</span>

        <span class="n">licensepool</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hold_end_date</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hold</span>

<div class="viewcode-block" id="ODLAPI.release_hold"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel a hold.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span>
            <span class="n">license_pool_id</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotOnHold</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_hold</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="c1"># If the book was ready and the patron revoked the hold instead</span>
        <span class="c1"># of checking it out, but no one else had the book on hold, the</span>
        <span class="c1"># book is now available for anyone to check out. If someone else</span>
        <span class="c1"># had a hold, the license is now reserved for the next patron.</span>
        <span class="c1"># If someone else had a hold, the license is now reserved for the</span>
        <span class="c1"># next patron, and we need to update that hold.</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="n">licensepool</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ODLAPI.patron_activity"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up non-expired loans for this collection in the database.&quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">end</span><span class="o">&gt;=</span><span class="n">utc_now</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Get the patron&#39;s holds. If there are any expired holds, delete them.</span>
        <span class="c1"># Update the end date and position for the remaining holds.</span>
        <span class="n">holds</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Hold</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span>
        <span class="n">remaining_holds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">holds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="ow">and</span> <span class="n">hold</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">utc_now</span><span class="p">():</span>
                <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_hold_end_date</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
                <span class="n">remaining_holds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">LoanInfo</span><span class="p">(</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">loan</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                <span class="n">external_identifier</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">loans</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">remaining_holds</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="ODLAPI.update_loan"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.update_loan">[docs]</a>    <span class="k">def</span> <span class="nf">update_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">status_doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check a loan&#39;s status, and if it is no longer active, delete the loan</span>
<span class="sd">        and update its pool&#39;s availability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_doc</span><span class="p">:</span>
            <span class="n">status_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_license_status_document</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">status_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
        <span class="c1"># We already check that the status is valid in get_license_status_document,</span>
        <span class="c1"># but if the document came from a notification it hasn&#39;t been checked yet.</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_VALUES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="s2">&quot;The License Status Document had an unknown status value.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">REVOKED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RETURNED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CANCELLED_STATUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRED_STATUS</span><span class="p">]:</span>
            <span class="c1"># This loan is no longer active. Update the pool&#39;s availability</span>
            <span class="c1"># and delete the loan.</span>

            <span class="c1"># If there are holds, the license is reserved for the next patron.</span>
            <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLAPI.checkout_to_external_library"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.checkout_to_external_library">[docs]</a>    <span class="k">def</span> <span class="nf">checkout_to_external_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkout</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoAvailableCopies</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_hold</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLAPI.checkin_from_external_library"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.checkin_from_external_library">[docs]</a>    <span class="k">def</span> <span class="nf">checkin_from_external_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">loan</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkin</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLAPI.fulfill_for_external_library"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.fulfill_for_external_library">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill_for_external_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">mechanism</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fulfill</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLAPI.release_hold_from_external_library"><a class="viewcode-back" href="../../api.html#api.odl.ODLAPI.release_hold_from_external_library">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold_from_external_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">hold</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_hold</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ODLXMLParser"><a class="viewcode-back" href="../../api.html#api.odl.ODLXMLParser">[docs]</a><span class="k">class</span> <span class="nc">ODLXMLParser</span><span class="p">(</span><span class="n">OPDSXMLParser</span><span class="p">):</span>
    <span class="n">NAMESPACES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">OPDSXMLParser</span><span class="o">.</span><span class="n">NAMESPACES</span><span class="p">,</span>
                      <span class="n">odl</span><span class="o">=</span><span class="s2">&quot;http://opds-spec.org/odl&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ODLImporter"><a class="viewcode-back" href="../../api.html#api.odl.ODLImporter">[docs]</a><span class="k">class</span> <span class="nc">ODLImporter</span><span class="p">(</span><span class="n">OPDSImporter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import information and formats from an ODL feed.</span>

<span class="sd">    The only change from OPDSImporter is that this importer extracts</span>
<span class="sd">    format information from &#39;odl:license&#39; tags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ODLAPI</span><span class="o">.</span><span class="n">NAME</span>
    <span class="n">PARSER_CLASS</span> <span class="o">=</span> <span class="n">ODLXMLParser</span>

    <span class="c1"># The media type for a License Info Docuemnt, used to get information</span>
    <span class="c1"># about the license.</span>
    <span class="n">LICENSE_INFO_DOCUMENT_MEDIA_TYPE</span> <span class="o">=</span> <span class="s1">&#39;application/vnd.odl.info+json&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_detail_for_elementtree_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">do_get</span> <span class="o">=</span> <span class="n">do_get</span> <span class="ow">or</span> <span class="n">Representation</span><span class="o">.</span><span class="n">cautious_http_get</span>

        <span class="c1"># TODO: Review for consistency when updated ODL spec is ready.</span>
        <span class="n">subtag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">text_of_optional_subtag</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">OPDSImporter</span><span class="o">.</span><span class="n">_detail_for_elementtree_entry</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">)</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">odl_license_tags</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;odl:license&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">odl_license_tag</span> <span class="ow">in</span> <span class="n">odl_license_tags</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">odl_license_tag</span><span class="p">,</span> <span class="s1">&#39;dcterms:identifier&#39;</span><span class="p">)</span>
            <span class="n">full_content_type</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">odl_license_tag</span><span class="p">,</span> <span class="s1">&#39;dcterms:format&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">medium</span><span class="p">:</span>
                <span class="n">medium</span> <span class="o">=</span> <span class="n">Edition</span><span class="o">.</span><span class="n">medium_from_media_type</span><span class="p">(</span><span class="n">full_content_type</span><span class="p">)</span>

            <span class="c1"># By default, dcterms:format includes the media type of a</span>
            <span class="c1"># DRM-free resource.</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">full_content_type</span>
            <span class="n">drm_schemes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># But it may instead describe an audiobook protected with</span>
            <span class="c1"># the Feedbooks access-control scheme.</span>
            <span class="n">feedbooks_audio</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">; protection=</span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span>
                <span class="n">MediaTypes</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">,</span>
                <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FEEDBOOKS_AUDIOBOOK_DRM</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">full_content_type</span> <span class="o">==</span> <span class="n">feedbooks_audio</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span>
                <span class="n">drm_schemes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">FEEDBOOKS_AUDIOBOOK_DRM</span><span class="p">)</span>

            <span class="c1"># Additional DRM schemes may be described in &lt;odl:protection&gt;</span>
            <span class="c1"># tags.</span>
            <span class="n">protection_tags</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span>
                <span class="n">odl_license_tag</span><span class="p">,</span> <span class="s1">&#39;odl:protection&#39;</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">protection_tag</span> <span class="ow">in</span> <span class="n">protection_tags</span><span class="p">:</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">protection_tag</span><span class="p">,</span> <span class="s1">&#39;dcterms:format&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">drm_scheme</span><span class="p">:</span>
                    <span class="n">drm_schemes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drm_scheme</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">drm_scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="n">drm_schemes</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]):</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">FormatData</span><span class="p">(</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
                        <span class="n">drm_scheme</span><span class="o">=</span><span class="n">drm_scheme</span><span class="p">,</span>
                        <span class="n">rights_uri</span><span class="o">=</span><span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medium</span>

            <span class="n">expires</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">available_checkouts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">concurrent_checkouts</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">checkout_link</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">link_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">odl_license_tag</span><span class="p">,</span> <span class="s1">&#39;odl:tlink&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">BORROW</span><span class="p">:</span>
                    <span class="n">checkout_link</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># Look for a link to the License Info Document for this license.</span>
            <span class="n">odl_status_link</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">link_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">odl_license_tag</span><span class="p">,</span> <span class="s1">&#39;atom:link&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">attrib</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rel</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span>
                    <span class="ow">and</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">LICENSE_INFO_DOCUMENT_MEDIA_TYPE</span><span class="p">)):</span>
                    <span class="n">odl_status_link</span> <span class="o">=</span> <span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># If we found one, retrieve it and get licensing information about this book.</span>
            <span class="k">if</span> <span class="n">odl_status_link</span><span class="p">:</span>
                <span class="n">ignore</span><span class="p">,</span> <span class="n">ignore</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">do_get</span><span class="p">(</span><span class="n">odl_status_link</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{})</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">checkouts</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkouts&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">remaining_checkouts</span> <span class="o">=</span> <span class="n">checkouts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">available_checkouts</span> <span class="o">=</span> <span class="n">checkouts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span>

            <span class="n">terms</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">odl_license_tag</span><span class="p">,</span> <span class="s2">&quot;odl:terms&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">terms</span><span class="p">:</span>
                <span class="n">concurrent_checkouts</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;odl:concurrent_checkouts&quot;</span><span class="p">)</span>
                <span class="n">expires</span> <span class="o">=</span> <span class="n">subtag</span><span class="p">(</span><span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;odl:expires&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
                    <span class="n">expires</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>

            <span class="n">licenses_owned</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">concurrent_checkouts</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">licenses_available</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">available_checkouts</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">licenses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LicenseData</span><span class="p">(</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">checkout_url</span><span class="o">=</span><span class="n">checkout_link</span><span class="p">,</span>
                <span class="n">status_url</span><span class="o">=</span><span class="n">odl_status_link</span><span class="p">,</span>
                <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
                <span class="n">remaining_checkouts</span><span class="o">=</span><span class="n">remaining_checkouts</span><span class="p">,</span>
                <span class="n">concurrent_checkouts</span><span class="o">=</span><span class="n">concurrent_checkouts</span><span class="p">,</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;circulation&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;formats&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;formats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">formats</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;licenses&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;licenses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;licenses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;licenses_owned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licenses_owned</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">][</span><span class="s1">&#39;licenses_available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licenses_available</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ODLImportMonitor"><a class="viewcode-back" href="../../api.html#api.odl.ODLImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">ODLImportMonitor</span><span class="p">(</span><span class="n">OPDSImportMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import information from an ODL feed.&quot;&quot;&quot;</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ODLImporter</span><span class="o">.</span><span class="n">NAME</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;ODL Import Monitor&quot;</span></div>

<div class="viewcode-block" id="ODLHoldReaper"><a class="viewcode-back" href="../../api.html#api.odl.ODLHoldReaper">[docs]</a><span class="k">class</span> <span class="nc">ODLHoldReaper</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for holds that have expired and delete them, and update</span>
<span class="sd">    the holds queues for their pools.&quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;ODL Hold Reaper&quot;</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ODLAPI</span><span class="o">.</span><span class="n">NAME</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ODLHoldReaper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span> <span class="ow">or</span> <span class="n">ODLAPI</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="ODLHoldReaper.run_once"><a class="viewcode-back" href="../../api.html#api.odl.ODLHoldReaper.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="c1"># Find holds that have expired.</span>
        <span class="n">expired_holds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">license_pool</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">end</span><span class="o">&lt;</span><span class="n">utc_now</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">position</span><span class="o">==</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">changed_pools</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">total_deleted_holds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">expired_holds</span><span class="p">:</span>
            <span class="n">changed_pools</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
            <span class="n">total_deleted_holds</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">changed_pools</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">update_hold_queue</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Holds deleted: </span><span class="si">%d</span><span class="s2">. License pools updated: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">total_deleted_holds</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">changed_pools</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">progress</span></div></div>

<div class="viewcode-block" id="MockODLAPI"><a class="viewcode-back" href="../../api.html#api.odl.MockODLAPI">[docs]</a><span class="k">class</span> <span class="nc">MockODLAPI</span><span class="p">(</span><span class="n">ODLAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock API for tests that overrides _get and _url_for and tracks requests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MockODLAPI.mock_collection"><a class="viewcode-back" href="../../api.html#api.odl.MockODLAPI.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mock ODL collection to use in tests.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test ODL Collection&quot;</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="s2">&quot;http://odl&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">ODLAPI</span><span class="o">.</span><span class="n">NAME</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://metadata&#39;</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockODLAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MockODLAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.odl.MockODLAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_external&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())]))</span></div>


<div class="viewcode-block" id="SharedODLAPI"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI">[docs]</a><span class="k">class</span> <span class="nc">SharedODLAPI</span><span class="p">(</span><span class="n">BaseCirculationAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An API for circulation managers to use to connect to an ODL collection that&#39;s shared</span>
<span class="sd">    by another circulation manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;Shared ODL For Consortia&quot;</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Import books from an ODL collection that&#39;s hosted by another circulation manager in the consortium. If this circulation manager will be the main host for the collection, select </span><span class="si">%(odl_name)s</span><span class="s2"> instead.&quot;</span><span class="p">,</span> <span class="n">odl_name</span><span class="o">=</span><span class="n">ODLAPI</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Base URL&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The base URL for the collection on the other circulation manager.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Data source name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">SUPPORTS_REGISTRATION</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">SUPPORTS_STAGING</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection protocol is </span><span class="si">%s</span><span class="s2">, but passed into SharedODLPI!&quot;</span> <span class="o">%</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Create the data source if it doesn&#39;t exist yet.</span>
        <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>

<div class="viewcode-block" id="SharedODLAPI.internal_format"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.internal_format">[docs]</a>    <span class="k">def</span> <span class="nf">internal_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Each consolidated copy is only available in one format, so we don&#39;t need</span>
<span class="sd">        a mapping to internal formats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">delivery_mechanism</span></div>

<div class="viewcode-block" id="SharedODLAPI.collection"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.collection">[docs]</a>    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_one</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="n">HTTP</span><span class="o">.</span><span class="n">get_with_timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a normal HTTP request, but include an authentication</span>
<span class="sd">        header with the credentials for the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_response_codes</span> <span class="o">=</span> <span class="n">allowed_response_codes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">]</span>
        <span class="n">patron</span> <span class="o">=</span> <span class="n">patron</span> <span class="ow">or</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">patron</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">shared_secret</span> <span class="o">=</span> <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_secret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LibraryAuthorizationFailedException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library </span><span class="si">%(library)s</span><span class="s2"> is not registered with the collection.&quot;</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_header</span>

        <span class="k">return</span> <span class="n">do_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="n">allowed_response_codes</span><span class="p">)</span>

<div class="viewcode-block" id="SharedODLAPI.checkout"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loans</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">loans</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlreadyCheckedOut</span><span class="p">()</span>

        <span class="n">holds</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">holds</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hold</span> <span class="o">=</span> <span class="n">holds</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hold_info_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">hold</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hold_info_response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ready&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">()</span>
            <span class="n">checkout_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">BORROW</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkout_links</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">()</span>
            <span class="n">checkout_url</span> <span class="o">=</span> <span class="n">checkout_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">borrow_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">links</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">BORROW</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">borrow_links</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
            <span class="n">checkout_url</span> <span class="o">=</span> <span class="n">borrow_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">checkout_url</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;403&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">NO_LICENSES</span><span class="o">.</span><span class="n">uri</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoLicenses</span><span class="p">()</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;since&quot;</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until&quot;</span><span class="p">))</span>
        <span class="c1"># Get the loan base url from a link.</span>
        <span class="n">info_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_links</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span>
        <span class="n">external_identifier</span> <span class="o">=</span> <span class="n">info_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LoanInfo</span><span class="p">(</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="p">,</span>
                <span class="n">external_identifier</span><span class="o">=</span><span class="n">external_identifier</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="s2">&quot;reserved&quot;</span><span class="p">]:</span>
            <span class="c1"># We tried to borrow this book but it wasn&#39;t available,</span>
            <span class="c1"># so we got a hold.</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_holds&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">position</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                <span class="n">external_identifier</span><span class="o">=</span><span class="n">external_identifier</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We didn&#39;t get an error, but something went wrong and we don&#39;t have a</span>
            <span class="c1"># loan or hold either.</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">()</span></div>

<div class="viewcode-block" id="SharedODLAPI.checkin"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loan</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

        <span class="n">info_url</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">info_url</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReturn</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReturn</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">revoke_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;http://librarysimplified.org/terms/rel/revoke&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">revoke_links</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReturn</span><span class="p">()</span>
        <span class="n">revoke_url</span> <span class="o">=</span> <span class="n">revoke_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">revoke_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReturn</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SharedODLAPI.fulfill"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the actual resource file to the patron.</span>

<span class="sd">        :param kwargs: A container for arguments to fulfill()</span>
<span class="sd">           which are not relevant to this vendor.</span>

<span class="sd">        :return: a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">loan</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="o">==</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

        <span class="n">info_url</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">info_url</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">()</span>

        <span class="n">requested_content_type</span> <span class="o">=</span> <span class="n">internal_format</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">content_type</span>
        <span class="n">requested_drm_scheme</span> <span class="o">=</span> <span class="n">internal_format</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">drm_scheme</span>

        <span class="c1"># The response data comes in as a byte string that we must</span>
        <span class="c1"># convert into a string.</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until&quot;</span><span class="p">))</span>

        <span class="c1"># The entry is parsed with etree to get indirect acquisitions</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">SharedODLImporter</span><span class="o">.</span><span class="n">PARSER_CLASS</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">response_content</span><span class="p">))</span>

        <span class="n">fulfill_url</span> <span class="o">=</span> <span class="n">SharedODLImporter</span><span class="o">.</span><span class="n">get_fulfill_url</span><span class="p">(</span><span class="n">response_content</span><span class="p">,</span> <span class="n">requested_content_type</span><span class="p">,</span> <span class="n">requested_drm_scheme</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fulfill_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FormatNotAvailable</span><span class="p">()</span>

        <span class="c1"># We need to hit the fulfill link here instead of returning it so we can</span>
        <span class="c1"># authenticate the library.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">fulfill_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">),</span>
            <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
            <span class="n">expires</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SharedODLAPI.place_hold"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">notification_email_address</span><span class="p">):</span>
        <span class="c1"># Just try to check out the book. If it&#39;s not available, we&#39;ll get a hold.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="SharedODLAPI.release_hold"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span>
            <span class="n">license_pool_id</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotOnHold</span><span class="p">()</span>

        <span class="n">info_url</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">external_identifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">info_url</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotOnHold</span><span class="p">()</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;reserved&quot;</span><span class="p">,</span> <span class="s2">&quot;ready&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span>
        <span class="n">revoke_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;http://librarysimplified.org/terms/rel/revoke&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">revoke_links</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span>
        <span class="n">revoke_url</span> <span class="o">=</span> <span class="n">revoke_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">revoke_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteIntegrationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotReleaseHold</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SharedODLAPI.patron_activity"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLAPI.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span>

        <span class="n">holds</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Hold</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Hold</span><span class="o">.</span><span class="n">license_pool</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">LicensePool</span><span class="o">.</span><span class="n">collection_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Hold</span><span class="o">.</span><span class="n">patron</span><span class="o">==</span><span class="n">patron</span>
        <span class="p">)</span>

        <span class="n">activity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">loans</span><span class="p">:</span>
            <span class="n">info_url</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">info_url</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="c1"># 404 is returned when the loan has been deleted. Leave this loan out of the result.</span>
                <span class="k">continue</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">()</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
                <span class="c1"># This loan might be expired.</span>
                <span class="k">continue</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;since&quot;</span><span class="p">))</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until&quot;</span><span class="p">))</span>

            <span class="n">activity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">LoanInfo</span><span class="p">(</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">loan</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">start</span><span class="p">,</span>
                    <span class="n">end</span><span class="p">,</span>
                    <span class="n">external_identifier</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">holds</span><span class="p">:</span>
            <span class="n">info_url</span> <span class="o">=</span> <span class="n">hold</span><span class="o">.</span><span class="n">external_identifier</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">info_url</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="n">patron</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">,</span> <span class="s2">&quot;404&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="c1"># 404 is returned when the hold has been deleted. Leave this hold out of the result.</span>
                <span class="k">continue</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">()</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_availability&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="s2">&quot;reserved&quot;</span><span class="p">]:</span>
                <span class="c1"># This hold might be expired.</span>
                <span class="k">continue</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;since&quot;</span><span class="p">))</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until&quot;</span><span class="p">))</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opds_holds&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>

            <span class="n">activity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">HoldInfo</span><span class="p">(</span>
                    <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">hold</span><span class="o">.</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">start</span><span class="p">,</span>
                    <span class="n">end</span><span class="p">,</span>
                    <span class="n">hold_position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                    <span class="n">external_identifier</span><span class="o">=</span><span class="n">hold</span><span class="o">.</span><span class="n">external_identifier</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">activity</span></div></div>


<div class="viewcode-block" id="SharedODLImporter"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLImporter">[docs]</a><span class="k">class</span> <span class="nc">SharedODLImporter</span><span class="p">(</span><span class="n">OPDSImporter</span><span class="p">):</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="n">SharedODLAPI</span><span class="o">.</span><span class="n">NAME</span>

<div class="viewcode-block" id="SharedODLImporter.get_fulfill_url"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLImporter.get_fulfill_url">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fulfill_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">requested_content_type</span><span class="p">,</span> <span class="n">requested_drm_scheme</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PARSER_CLASS</span><span class="p">()</span>
        <span class="c1"># The entry may come from an HTTP response which is a bytestring.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>

        <span class="n">fulfill_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">link_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;atom:link&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">GENERIC_OPDS_ACQUISITION</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

                <span class="n">indirect_acquisition</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">link_tag</span><span class="p">,</span> <span class="s2">&quot;opds:indirectAcquisition&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indirect_acquisition</span><span class="p">:</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="n">indirect_acquisition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="n">drm_scheme</span>
                    <span class="n">drm_scheme</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="n">requested_content_type</span> <span class="ow">and</span> <span class="n">drm_scheme</span> <span class="o">==</span> <span class="n">requested_drm_scheme</span><span class="p">:</span>
                    <span class="n">fulfill_url</span> <span class="o">=</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">fulfill_url</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_detail_for_elementtree_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_get</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">OPDSImporter</span><span class="o">.</span><span class="n">_detail_for_elementtree_entry</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">entry_tag</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">)</span>
        <span class="n">borrow_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">rel</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">BORROW</span><span class="p">]</span>

        <span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">link_tag</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">entry_tag</span><span class="p">,</span> <span class="s1">&#39;atom:link&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">link_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">BORROW</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">indirect_acquisition</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">link_tag</span><span class="p">,</span> <span class="s2">&quot;opds:indirectAcquisition&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indirect_acquisition</span><span class="p">:</span>
                    <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">indirect_acquisition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

                    <span class="n">second_indirect_acquisition</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">indirect_acquisition</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;opds:indirectAcquisition&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">second_indirect_acquisition</span><span class="p">:</span>
                        <span class="n">content_type</span> <span class="o">=</span> <span class="n">second_indirect_acquisition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">content_type</span> <span class="o">=</span> <span class="n">drm_scheme</span>
                        <span class="n">drm_scheme</span> <span class="o">=</span> <span class="kc">None</span>


                <span class="n">copies_tags</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">link_tag</span><span class="p">,</span> <span class="s1">&#39;opds:copies&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">copies_tags</span><span class="p">:</span>
                    <span class="n">copies_tag</span> <span class="o">=</span> <span class="n">copies_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">licenses_available</span> <span class="o">=</span> <span class="n">copies_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">licenses_available</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">licenses_available</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">licenses_available</span><span class="p">)</span>
                    <span class="n">licenses_owned</span> <span class="o">=</span> <span class="n">copies_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">licenses_owned</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">licenses_owned</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">licenses_owned</span><span class="p">)</span>
                <span class="n">holds_tags</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_xpath</span><span class="p">(</span><span class="n">link_tag</span><span class="p">,</span> <span class="s1">&#39;opds:holds&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">holds_tags</span><span class="p">:</span>
                    <span class="n">holds_tag</span> <span class="o">=</span> <span class="n">holds_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="n">holds_tag</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">patrons_in_hold_queue</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">patrons_in_hold_queue</span><span class="p">)</span>

                <span class="nb">format</span> <span class="o">=</span> <span class="n">FormatData</span><span class="p">(</span>
                    <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
                    <span class="n">drm_scheme</span><span class="o">=</span><span class="n">drm_scheme</span><span class="p">,</span>
                    <span class="n">link</span><span class="o">=</span><span class="n">borrow_links</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">rights_uri</span><span class="o">=</span><span class="n">RightsStatus</span><span class="o">.</span><span class="n">IN_COPYRIGHT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
        <span class="n">circulation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">licenses_available</span><span class="o">=</span><span class="n">licenses_available</span><span class="p">,</span>
            <span class="n">licenses_owned</span><span class="o">=</span><span class="n">licenses_owned</span><span class="p">,</span>
            <span class="n">patrons_in_hold_queue</span><span class="o">=</span><span class="n">patrons_in_hold_queue</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;circulation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circulation</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SharedODLImportMonitor"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">SharedODLImportMonitor</span><span class="p">(</span><span class="n">OPDSImportMonitor</span><span class="p">):</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">SharedODLImporter</span><span class="o">.</span><span class="n">NAME</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Shared ODL Import Monitor&quot;</span>

<div class="viewcode-block" id="SharedODLImportMonitor.opds_url"><a class="viewcode-back" href="../../api.html#api.odl.SharedODLImportMonitor.opds_url">[docs]</a>    <span class="k">def</span> <span class="nf">opds_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>
        <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;/crawlable&quot;</span></div></div>

<div class="viewcode-block" id="MockSharedODLAPI"><a class="viewcode-back" href="../../api.html#api.odl.MockSharedODLAPI">[docs]</a><span class="k">class</span> <span class="nc">MockSharedODLAPI</span><span class="p">(</span><span class="n">SharedODLAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock API for tests that overrides _get and tracks requests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MockSharedODLAPI.mock_collection"><a class="viewcode-back" href="../../api.html#api.odl.MockSharedODLAPI.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mock ODL collection to use in tests.&quot;&quot;&quot;</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test Shared ODL Collection&quot;</span><span class="p">,</span> <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="s2">&quot;http://shared-odl&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">SharedODLAPI</span><span class="o">.</span><span class="n">NAME</span>
        <span class="p">)</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MockSharedODLAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MockSharedODLAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.odl.MockSharedODLAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">patron</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">allowed_response_codes</span> <span class="o">=</span> <span class="n">allowed_response_codes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;2xx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">patron</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">allowed_response_codes</span><span class="o">=</span><span class="n">allowed_response_codes</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>