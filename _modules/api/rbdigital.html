
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.rbdigital &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.rbdigital</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">.circulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">APIAwareFulfillmentInfo</span><span class="p">,</span>
    <span class="n">BaseCirculationAPI</span><span class="p">,</span>
    <span class="n">FulfillmentInfo</span><span class="p">,</span>
    <span class="n">HoldInfo</span><span class="p">,</span>
    <span class="n">LoanInfo</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.circulation_exceptions</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Configuration</span>

<span class="kn">from</span> <span class="nn">core.analytics</span> <span class="kn">import</span> <span class="n">Analytics</span>

<span class="kn">from</span> <span class="nn">core.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">temp_config</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.coverage</span> <span class="kn">import</span> <span class="n">BibliographicCoverageProvider</span><span class="p">,</span> <span class="n">CoverageFailure</span>

<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationData</span><span class="p">,</span>
    <span class="n">ContributorData</span><span class="p">,</span>
    <span class="n">FormatData</span><span class="p">,</span>
    <span class="n">IdentifierData</span><span class="p">,</span>
    <span class="n">LinkData</span><span class="p">,</span>
    <span class="n">Metadata</span><span class="p">,</span>
    <span class="n">ReplacementPolicy</span><span class="p">,</span>
    <span class="n">SubjectData</span><span class="p">,</span>
    <span class="n">TimestampData</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CirculationEvent</span><span class="p">,</span>
    <span class="n">Classification</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">ConfigurationSetting</span><span class="p">,</span>
    <span class="n">Contributor</span><span class="p">,</span>
    <span class="n">Credential</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Edition</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">Library</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
    <span class="n">Representation</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">Subject</span><span class="p">,</span>
    <span class="n">Work</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.monitor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionMonitor</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">DatabaseTest</span>
<span class="kn">from</span> <span class="nn">core.util</span> <span class="kn">import</span> <span class="n">LanguageCodes</span>

<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BadResponseException</span><span class="p">,</span>
    <span class="n">HTTP</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.util.personal_names</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">name_tidy</span><span class="p">,</span>
    <span class="n">sort_name_to_display_name</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">core.util.web_publication_manifest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AudiobookManifest</span> <span class="k">as</span> <span class="n">CoreAudiobookManifest</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.string_helpers</span> <span class="kn">import</span> <span class="n">random_string</span>

<span class="kn">from</span> <span class="nn">.selftest</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HasSelfTests</span><span class="p">,</span>
    <span class="n">SelfTestResult</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalAPI</span><span class="p">(</span><span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">HasSelfTests</span><span class="p">):</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span>

    <span class="c1"># The loan duration must be specified when connecting a library to an</span>
    <span class="c1"># RBdigital account, but if it&#39;s not specified, try one week.</span>

    <span class="n">DEFAULT_LOAN_DURATION</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;v1&quot;</span>
    <span class="n">PRODUCTION_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.rbdigital.com/&quot;</span>
    <span class="n">QA_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;http://api.rbdigitalstage.com/&quot;</span>
    <span class="n">SERVER_NICKNAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;production&quot;</span> <span class="p">:</span> <span class="n">PRODUCTION_BASE_URL</span><span class="p">,</span>
        <span class="s2">&quot;qa&quot;</span> <span class="p">:</span> <span class="n">QA_BASE_URL</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">BASE_SETTINGS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">SETTINGS</span>
                     <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">DEFAULT_LOAN_PERIOD</span><span class="p">]</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Basic Token&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">Collection</span><span class="o">.</span><span class="n">EXTERNAL_ACCOUNT_ID_KEY</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library ID (numeric)&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">),</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">PRODUCTION_BASE_URL</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span> <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">BASE_SETTINGS</span>

    <span class="n">my_audiobook_setting</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">AUDIOBOOK_LOAN_DURATION_SETTING</span>
    <span class="p">)</span>
    <span class="n">my_audiobook_setting</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_LOAN_DURATION</span><span class="p">)</span>
    <span class="n">my_ebook_setting</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">EBOOK_LOAN_DURATION_SETTING</span>
    <span class="p">)</span>
    <span class="n">my_ebook_setting</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_LOAN_DURATION</span><span class="p">)</span>
    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">my_audiobook_setting</span><span class="p">,</span>
        <span class="n">my_ebook_setting</span>
    <span class="p">]</span>

    <span class="n">EXPIRATION_DATE_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>

    <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="c1">#ex: 2013-12-27</span>

    <span class="c1"># a complete response returns the json structure with more data fields than a basic response does</span>
    <span class="n">RESPONSE_VERBOSITY</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;basic&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s1">&#39;compact&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s1">&#39;extended&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="s1">&#39;hypermedia&#39;</span><span class="p">}</span>

    <span class="n">CACHED_IDENTIFIER_PROPERTY</span> <span class="o">=</span> <span class="s1">&#39;patronId&#39;</span>
    <span class="n">BEARER_TOKEN_PROPERTY</span> <span class="o">=</span> <span class="s1">&#39;bearer&#39;</span>

    <span class="c1"># Parameterize credentials.</span>
    <span class="c1"># - The `label` property maps to Credential `type`.</span>
    <span class="c1"># - The `lifetime` is used to calculate Credential `expires`</span>
    <span class="c1">#   and is specified in seconds. If it is None, then the</span>
    <span class="c1">#   Credential does not expire.</span>
    <span class="n">CREDENTIAL_TYPES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">CACHED_IDENTIFIER_PROPERTY</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">Credential</span><span class="o">.</span><span class="n">IDENTIFIER_FROM_REMOTE_SERVICE</span><span class="p">,</span>
            <span class="n">lifetime</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">),</span>
        <span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Patron Bearer Token&quot;</span><span class="p">,</span>
            <span class="c1"># RBdigital advertises a 24 hour lifetime, but we&#39;ll</span>
            <span class="c1"># cache it for only 23.5 hours, just in case.</span>
            <span class="n">lifetime</span><span class="o">=</span><span class="p">((</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="c1"># Because we don&#39;t allow proxied requests to refresh the bearer</span>
    <span class="c1"># token, we need to ensure that there is enough time to complete</span>
    <span class="c1"># those requests before the token expires. If there&#39;s not then</span>
    <span class="c1"># we&#39;ll refresh it before returning the proxied URLs. This</span>
    <span class="c1"># property specifies (in seconds) the length of time we allocate</span>
    <span class="c1"># to complete those requests. It must be shorter than the Patron</span>
    <span class="c1"># Bearer Token lifetime and is currently set to 30 minutes.</span>
    <span class="n">PROXY_BEARER_GRACE_PERIOD</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;RBDigital Patron API&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Collection protocol is </span><span class="si">%s</span><span class="s2">, but passed into RBDigitalAPI!&quot;</span> <span class="o">%</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">password</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;RBDigital configuration is incomplete.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert the nickname for a server into an actual URL.</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span><span class="o">.</span><span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRODUCTION_BASE_URL</span>
        <span class="k">if</span> <span class="n">base_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVER_NICKNAMES</span><span class="p">:</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SERVER_NICKNAMES</span><span class="p">[</span><span class="n">base_url</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">RBDigitalBibliographicCoverageProvider</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI.external_integration"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span></div>

    <span class="k">def</span> <span class="nf">_run_self_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">media_type</span><span class="p">):</span>
            <span class="c1"># Call get_ebook_availability_info and count how many titles</span>
            <span class="c1"># are available/unavailable. If our credentials are bad,</span>
            <span class="c1"># we&#39;ll get an error message.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebook_availability_info</span><span class="p">(</span><span class="n">media_type</span><span class="p">)</span>

            <span class="n">available</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">unavailable</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># This is most likely an error condition.</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Unexpected response from server&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">IntegrationException</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;availability&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">available</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unavailable</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Total items: </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> currently loanable, </span><span class="si">%d</span><span class="s2"> currently not loanable)&quot;</span>
            <span class="k">return</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">available</span><span class="p">,</span> <span class="n">unavailable</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Counting ebooks in collection&quot;</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;eBook&#39;</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">response</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t even see the collection properly, something is</span>
            <span class="c1"># wrong and we should not continue.</span>
            <span class="k">return</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
            <span class="s2">&quot;Counting audiobooks in collection&quot;</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;eAudio&#39;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_patrons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">SelfTestResult</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>
                <span class="k">continue</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;Checking patron activity, using test patron for library </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">library</span><span class="o">.</span><span class="n">name</span>
            <span class="k">def</span> <span class="nf">count_loans_and_holds</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
                <span class="n">activity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_activity</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Total loans and holds: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">count_loans_and_holds</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span>
            <span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI.create_identifier_strings"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.create_identifier_strings">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_identifier_strings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="n">identifier_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">identifier</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">identifier_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">identifier_strings</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authorization_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the token given us by RBDigital is already utf/base64-encoded</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Authorization</span><span class="o">=</span><span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">authorization</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually make an HTTP request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">request_with_timeout</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI.request"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;complete&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESPONSE_VERBOSITY</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESPONSE_VERBOSITY</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept-Media&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_headers</span><span class="p">)</span>

        <span class="c1"># prevent the code throwing a BadResponseException when RBDigital</span>
        <span class="c1"># responds with a 500, because RBDigital uses 500s to indicate bad input,</span>
        <span class="c1"># rather than server error.</span>
        <span class="c1"># must list all 9 possibilities to use</span>
        <span class="n">allowed_response_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1xx&#39;</span><span class="p">,</span> <span class="s1">&#39;2xx&#39;</span><span class="p">,</span> <span class="s1">&#39;3xx&#39;</span><span class="p">,</span> <span class="s1">&#39;4xx&#39;</span><span class="p">,</span> <span class="s1">&#39;5xx&#39;</span><span class="p">,</span> <span class="s1">&#39;6xx&#39;</span><span class="p">,</span> <span class="s1">&#39;7xx&#39;</span><span class="p">,</span> <span class="s1">&#39;8xx&#39;</span><span class="p">,</span> <span class="s1">&#39;9xx&#39;</span><span class="p">]</span>
        <span class="c1"># for now, do nothing with disallowed error codes, but in the future might have</span>
        <span class="c1"># some that will warrant repeating the request.</span>
        <span class="n">disallowed_response_codes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">allowed_response_codes</span><span class="o">=</span><span class="n">allowed_response_codes</span><span class="p">,</span>
            <span class="n">disallowed_response_codes</span><span class="o">=</span><span class="n">disallowed_response_codes</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="ow">and</span> <span class="s1">&#39;Invalid Basic Token or permission denied&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="s2">&quot;Permission denied. This may be a temporary rate-limiting issue, or the credentials for this collection may be wrong.&quot;</span><span class="p">,</span>
                <span class="n">debug_message</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">502</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="RBDigitalAPI.checkin"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.checkin">[docs]</a>    <span class="k">def</span> <span class="nf">checkin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow a patron to return an ebook or audio before its due date.</span>

<span class="sd">        :param patron: a Patron object for the patron who wants to return the book.</span>
<span class="sd">        :param pin: The patron&#39;s password (not used).</span>
<span class="sd">        :param licensepool: The Identifier of the book to be checked out is</span>
<span class="sd">            attached to this licensepool.</span>

<span class="sd">        :return True on success, raises circulation exceptions on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">(</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">item_media</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_item</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="n">resp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulate_item</span><span class="p">(</span><span class="n">patron_id</span><span class="o">=</span><span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">return_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patron </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> returned item </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
                <span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_rbdigital_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># should never happen</span>
        <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">(</span>
            <span class="s2">&quot;Unknown error </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> checking in </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">patron_rbdigital_id</span><span class="p">,</span>
                <span class="n">item_rbdigital_id</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.checkout"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associate an eBook or eAudio with a patron.</span>

<span class="sd">        :param patron: a Patron object for the patron who wants to check out the book.</span>
<span class="sd">        :param pin: The patron&#39;s password (not used).</span>
<span class="sd">        :param licensepool: The Identifier of the book to be checked out is</span>
<span class="sd">            attached to this licensepool.</span>
<span class="sd">        :param internal_format: Represents the patron&#39;s desired book format.  Ignored for now.</span>

<span class="sd">        :return LoanInfo on success, None on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">(</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">item_media</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_item</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">library</span> <span class="o">=</span> <span class="n">patron</span><span class="o">.</span><span class="n">library</span>

        <span class="k">if</span> <span class="n">item_media</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">AUDIOBOOK_LOAN_DURATION_KEY</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
            <span class="n">days</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span>
                <span class="p">)</span><span class="o">.</span><span class="n">int_value</span> <span class="ow">or</span> <span class="n">Collection</span><span class="o">.</span><span class="n">STANDARD_DEFAULT_LOAN_PERIOD</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

        <span class="n">resp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulate_item</span><span class="p">(</span><span class="n">patron_id</span><span class="o">=</span><span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">return_item</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp_dict</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;error_code&#39;</span> <span class="ow">in</span> <span class="n">resp_dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patron </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> checked out item </span><span class="si">%s</span><span class="s2"> with transaction id </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
            <span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">resp_dict</span><span class="p">[</span><span class="s1">&#39;transactionId&#39;</span><span class="p">])</span>

        <span class="n">expires</span> <span class="o">=</span> <span class="n">today</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
            <span class="n">fulfillment_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">loan</span></div>

<div class="viewcode-block" id="RBDigitalAPI.circulate_item"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.circulate_item">[docs]</a>    <span class="k">def</span> <span class="nf">circulate_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_item</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Borrow or return a catalog item.</span>
<span class="sd">        :param patron_id RBDigital internal id</span>
<span class="sd">        :param item_id isbn</span>
<span class="sd">        :return A dictionary of information on the transaction or error status and message</span>
<span class="sd">        Calling methods are expected to use this dictionary to create XxxInfo objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;checkouts&quot;</span>
        <span class="k">if</span> <span class="n">hold</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;holds&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">item_id</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;post&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;checkout&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_item</span> <span class="ow">and</span> <span class="n">days</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s2">&quot;?days=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">days</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hold</span> <span class="ow">and</span> <span class="n">return_item</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;checkin&quot;</span>
        <span class="k">elif</span> <span class="n">hold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_item</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;place_hold&quot;</span>
        <span class="k">elif</span> <span class="n">hold</span> <span class="ow">and</span> <span class="n">return_item</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;release_hold&quot;</span>

        <span class="n">resp_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">resp_obj</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

                <span class="c1"># checkout responses are dictionaries, hold responses are strings</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Item circulation request failed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp_obj</span></div>

<div class="viewcode-block" id="RBDigitalAPI.patron_fulfillment_request"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_fulfillment_request">[docs]</a>    <span class="k">def</span> <span class="nf">patron_fulfillment_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">reauthorize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a fulfillment request on behalf of a patron, using the</span>
<span class="sd">        a bearer token either previously cached or newly retrieved on</span>
<span class="sd">        behalf of the patron.</span>

<span class="sd">        If the `reauthorize` parameter is set to True, then if the request</span>
<span class="sd">        fails with status code 401 (invalid bearer token), then we will</span>
<span class="sd">        attempt to obtain a new bearer token for the patron and repeat</span>
<span class="sd">        the request.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :param url: URL for a resource.</span>
<span class="sd">        :param reauthorize: (Optional) Boolean indicating whether to</span>
<span class="sd">            reauthorize the patron bearer token if we receive status code 401.</span>
<span class="sd">        :return: The request response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;application/json;charset=UTF-8&#39;</span>

        <span class="k">def</span> <span class="nf">perform_request</span><span class="p">(</span><span class="n">reauthorize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">bearer_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_bearer_token</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s1">&#39;Bearer </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bearer_token</span><span class="p">),</span>
                       <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">reauthorize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reauthorize_patron_bearer_token</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">perform_request</span><span class="p">(</span><span class="n">reauthorize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">perform_request</span><span class="p">(</span><span class="n">reauthorize</span><span class="o">=</span><span class="n">reauthorize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="RBDigitalAPI.fulfill"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">,</span> <span class="n">part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fulfill_part_url</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an actual resource file to the patron. This may</span>
<span class="sd">        represent the entire book or only one part of it.</span>

<span class="sd">        :param part: When the patron wants to fulfill a specific part</span>
<span class="sd">            of the book, rather than the title as a whole, this will be</span>
<span class="sd">            set to a string representation of the numeric position of the</span>
<span class="sd">            desired part.</span>

<span class="sd">        :param fulfill_part_url: When the book can be fulfilled in</span>
<span class="sd">            parts, this function will take a part number and generate the</span>
<span class="sd">            URL to fulfill that specific part.</span>

<span class="sd">        :return a FulfillmentInfo object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">(</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">item_media</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_item</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="c1"># If we are going to return a manifest to the client, then its</span>
        <span class="c1"># links should proxy through this CM. If we&#39;re going to fulfill</span>
        <span class="c1"># an access document for a part, we&#39;ll need the true RBdigital</span>
        <span class="c1"># access document URL, so that we can fetch and return the real</span>
        <span class="c1"># fulfillment link to the client.</span>
        <span class="n">fulfillment_proxy</span> <span class="o">=</span> <span class="n">RBDigitalFulfillmentProxy</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_part</span><span class="o">=</span><span class="n">part</span><span class="p">)</span>
        <span class="n">checkouts_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patron_checkouts</span><span class="p">(</span><span class="n">patron_id</span><span class="o">=</span><span class="n">patron_rbdigital_id</span><span class="p">,</span>
                                                   <span class="n">fulfill_part_url</span><span class="o">=</span><span class="n">fulfill_part_url</span><span class="p">,</span>
                                                   <span class="n">request_fulfillment</span><span class="o">=</span><span class="n">fulfillment_proxy</span><span class="o">.</span><span class="n">make_request</span><span class="p">,</span>
                                                   <span class="n">fulfillment_proxy</span><span class="o">=</span><span class="n">fulfillment_proxy</span><span class="p">)</span>

        <span class="c1"># find this licensepool in patron&#39;s checkouts</span>
        <span class="n">found_checkout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">checkout</span> <span class="ow">in</span> <span class="n">checkouts_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">checkout</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">item_rbdigital_id</span><span class="p">:</span>
                <span class="n">found_checkout</span> <span class="o">=</span> <span class="n">checkout</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_checkout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoActiveLoan</span><span class="p">(</span>
                <span class="s2">&quot;Cannot fulfill </span><span class="si">%s</span><span class="s2"> - patron </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> has no such checkout.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
                    <span class="n">patron_rbdigital_id</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">fulfillment</span> <span class="o">=</span> <span class="n">found_checkout</span><span class="o">.</span><span class="n">fulfillment_info</span>
        <span class="k">if</span> <span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># They want the whole thing.</span>
            <span class="k">return</span> <span class="n">fulfillment</span>

        <span class="c1"># They want only one part of the book.</span>
        <span class="k">return</span> <span class="n">fulfillment</span><span class="o">.</span><span class="n">fulfill_part</span><span class="p">(</span><span class="n">part</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.place_hold"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">notification_email_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place a book on hold.</span>

<span class="sd">        Note: If the requested book is available for checkout, RBDigital will respond</span>
<span class="sd">        with a &quot;success&quot; to the hold request.  Then, at the next database clean-up sweep,</span>
<span class="sd">        RBDigital will automatically convert the hold record to a checkout record.</span>

<span class="sd">        :param patron: a Patron object for the patron who wants to check out the book.</span>
<span class="sd">        :param pin: The patron&#39;s password (not used).</span>
<span class="sd">        :param licensepool: The Identifier of the book to be checked out is</span>
<span class="sd">            attached to this licensepool.</span>
<span class="sd">        :param internal_format: Represents the patron&#39;s desired book format.  Ignored for now.</span>

<span class="sd">        :return: A HoldInfo object on success, None on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">(</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">item_media</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_item</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="n">resp_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulate_item</span><span class="p">(</span><span class="n">patron_id</span><span class="o">=</span><span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_item</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># successful holds return a numeric transaction id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transaction_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Item hold request failed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CannotHold</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patron </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> reserved item </span><span class="si">%s</span><span class="s2"> with transaction id </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
            <span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">resp_obj</span><span class="p">)</span>

        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="n">HoldInfo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">identifier_type</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span>
            <span class="c1"># RBDigital sets hold expirations to 2050-12-31, as a &quot;forever&quot;</span>
            <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">hold_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">hold</span></div>

<div class="viewcode-block" id="RBDigitalAPI.release_hold"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release a patron&#39;s hold on a book.</span>

<span class="sd">        :param patron: a Patron object for the patron who wants to return the book.</span>
<span class="sd">        :param pin: The patron&#39;s password (not used).</span>
<span class="sd">        :param licensepool: The Identifier of the book to be checked out is</span>
<span class="sd">            attached to this licensepool.</span>

<span class="sd">        :return True on success, raises circulation exceptions on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">(</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">item_media</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_item</span><span class="p">(</span><span class="n">licensepool</span><span class="p">)</span>

        <span class="n">resp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulate_item</span><span class="p">(</span><span class="n">patron_id</span><span class="o">=</span><span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patron </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> released hold </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
                <span class="n">patron_rbdigital_id</span><span class="p">,</span> <span class="n">item_rbdigital_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># should never happen</span>
        <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">(</span>
            <span class="s2">&quot;Unknown error </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> releasing </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">patron_rbdigital_id</span><span class="p">,</span>
                <span class="n">item_rbdigital_id</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_circulation_replacement_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ReplacementPolicy</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">subjects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">contributions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">analytics</span><span class="o">=</span><span class="n">Analytics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI.update_licensepool_for_identifier"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.update_licensepool_for_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">update_licensepool_for_identifier</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">availability</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update availability information for a single book.</span>

<span class="sd">        If the book has never been seen before, a new LicensePool</span>
<span class="sd">        will be created for the book.</span>

<span class="sd">        The book&#39;s LicensePool will be updated with current approximate</span>
<span class="sd">        circulation information (we can tell if it&#39;s available, but</span>
<span class="sd">        not how many copies).</span>
<span class="sd">        Bibliographic coverage will be ensured for the RBDigital Identifier.</span>
<span class="sd">        Work will be created for the LicensePool and set as presentation-ready.</span>

<span class="sd">        :param isbn the identifier RBDigital uses</span>
<span class="sd">        :param availability boolean denoting if book can be lent to patrons</span>
<span class="sd">        :param medium: The name RBDigital uses for the book&#39;s medium.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find a license pool to match the isbn, and see if it&#39;ll need a metadata update later</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new_pool</span> <span class="o">=</span> <span class="n">LicensePool</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_new_pool</span><span class="p">:</span>
            <span class="c1"># This is the first time we&#39;ve seen this book. Make sure its</span>
            <span class="c1"># identifier has bibliographic coverage.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span><span class="o">.</span><span class="n">ensure_coverage</span><span class="p">(</span>
                <span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span>
            <span class="p">)</span>

        <span class="c1"># now tell the licensepool if it&#39;s lendable</span>

        <span class="c1"># We don&#39;t know exactly how many licenses are available, but</span>
        <span class="c1"># we know that it&#39;s either zero (book is not lendable) or greater</span>
        <span class="c1"># than zero (book is lendable)</span>
        <span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">availability</span><span class="p">:</span>
            <span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Because the book showed up in availability, we know we own</span>
        <span class="c1"># at least one license to it.</span>
        <span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_new_pool</span> <span class="ow">and</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">==</span> <span class="n">licenses_owned</span> <span class="ow">and</span>
            <span class="n">license_pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">==</span> <span class="n">licenses_available</span><span class="p">):</span>
            <span class="c1"># Optimization: Nothing has changed, so don&#39;t even bother</span>
            <span class="c1"># calling CirculationData.apply()</span>
            <span class="k">return</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new_pool</span><span class="p">,</span> <span class="kc">False</span>

        <span class="c1"># If possible, create a FormatData object representing</span>
        <span class="c1"># how the book is available.</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Note that these strings are different from the similar strings</span>
        <span class="c1"># found in &quot;fileFormat&quot; when looking at a patron&#39;s loans.</span>
        <span class="c1"># &quot;ebook&quot; (a medium) versus &quot;EPUB&quot; (a format). Unfortunately we</span>
        <span class="c1"># don&#39;t get the file format when checking the book&#39;s</span>
        <span class="c1"># availability before a patron has checked it out.</span>
        <span class="n">delivery_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">drm_scheme</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">medium</span> <span class="o">==</span> <span class="s1">&#39;ebook&#39;</span><span class="p">:</span>
            <span class="n">delivery_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
            <span class="c1"># RBDigital doesn&#39;t tell us the DRM scheme at this</span>
            <span class="c1"># point, but some of their EPUBs do have Adobe DRM.</span>
            <span class="c1"># Also, their DRM usage may change in the future.</span>
            <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
        <span class="k">elif</span> <span class="n">medium</span> <span class="o">==</span> <span class="s1">&#39;eaudio&#39;</span><span class="p">:</span>
            <span class="n">delivery_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span>

        <span class="k">if</span> <span class="n">delivery_type</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FormatData</span><span class="p">(</span><span class="n">delivery_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">))</span>

        <span class="n">circulation_data</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">license_pool</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">licenses_owned</span><span class="o">=</span><span class="n">licenses_owned</span><span class="p">,</span>
            <span class="n">licenses_available</span><span class="o">=</span><span class="n">licenses_available</span><span class="p">,</span>
            <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_circulation_replacement_policy</span>
        <span class="n">license_pool</span><span class="p">,</span> <span class="n">circulation_changed</span> <span class="o">=</span> <span class="n">circulation_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new_pool</span><span class="p">,</span> <span class="n">circulation_changed</span></div>

<div class="viewcode-block" id="RBDigitalAPI.update_availability"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.update_availability">[docs]</a>    <span class="k">def</span> <span class="nf">update_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the availability information for a single LicensePool.</span>
<span class="sd">        Part of the CirculationAPI interface.</span>
<span class="sd">        Inactive for now, because we&#39;d have to request and go through all availabilities</span>
<span class="sd">        from RBDigital just to pick the one licensepool we want.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RBDigitalAPI.internal_format"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.internal_format">[docs]</a>    <span class="k">def</span> <span class="nf">internal_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We don&#39;t need to do any mapping between delivery mechanisms and</span>
<span class="sd">        internal formats, because each title is only available in one</span>
<span class="sd">        format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">delivery_mechanism</span></div>

<span class="c1">### Patron account handling</span>

<div class="viewcode-block" id="RBDigitalAPI.patron_credential"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_credential">[docs]</a>    <span class="k">def</span> <span class="nf">patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the credential of the given type for the given Patron,</span>
<span class="sd">        either from the cache or by retrieving it from the remote service.</span>

<span class="sd">        The behavior is as follows:</span>
<span class="sd">            - If a value is specified, we&#39;ll cache it.</span>
<span class="sd">            - If no value is specified and no cached credential is present</span>
<span class="sd">              and unexpired, then we&#39;ll retrieve a value from the remote</span>
<span class="sd">              service and cache it.</span>
<span class="sd">            - The cached value will be returned.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :param kind: The type of credential.</span>
<span class="sd">        :param value: An optional value for the credential, which, if</span>
<span class="sd">            provided, will replace replace the value in the cache.</span>
<span class="sd">        :return: The credential value for type `type` for the patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patron_credential</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">credential</span> <span class="k">if</span> <span class="n">credential</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">_patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the credential of the given type for the given Patron,</span>
<span class="sd">        either from the cache or by retrieving it from the remote service.</span>

<span class="sd">        The behavior is as follows:</span>
<span class="sd">            - If a value is specified, we&#39;ll cache it.</span>
<span class="sd">            - If no value is specified and no cached credential is present</span>
<span class="sd">              and unexpired, then we&#39;ll retrieve a value from the remote</span>
<span class="sd">              service and cache it.</span>
<span class="sd">            - The cached value will be returned.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :param kind: The type of credential.</span>
<span class="sd">        :param value: An optional value for the credential, which, if</span>
<span class="sd">            provided, will replace replace the value in the cache.</span>
<span class="sd">        :return: The `Credential` of type `type` for the patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">credential_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREDENTIAL_TYPES</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">lifetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREDENTIAL_TYPES</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lifetime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_persistent</span> <span class="o">=</span> <span class="p">(</span><span class="n">lifetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Force refresh if we&#39;ve specified a value for the credential. That</span>
        <span class="c1"># ensures that both the expiration date and value are updated.</span>
        <span class="n">force_refresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Credential.lookup() expects to pass a Credential to this refresh method</span>
        <span class="k">def</span> <span class="nf">refresh_credential</span><span class="p">(</span><span class="n">credential</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lifetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">credential</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">lifetime</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">credential</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value_</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># retrieve the credential from the remote service</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CACHED_IDENTIFIER_PROPERTY</span><span class="p">:</span>
                    <span class="c1"># value_ = self.fetch_patron_identifier(patron)</span>
                    <span class="c1"># From self.patron_remote_identifier</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_or_create_remote_account</span><span class="p">(</span>
                            <span class="n">patron</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="n">CirculationException</span><span class="p">:</span>
                        <span class="c1"># If an exception was thrown by _find_or_create_remote_account</span>
                        <span class="c1"># delete the credential so we don&#39;t create a credential with</span>
                        <span class="c1"># None stored in credential.credential, then continue to raise</span>
                        <span class="c1"># the exception.</span>
                        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">credential</span><span class="p">)</span>
                        <span class="n">_db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">credential</span><span class="p">)</span>
                        <span class="k">raise</span>
                <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">:</span>
                    <span class="n">value_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_patron_bearer_token</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No RBDigital credential of type &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>

            <span class="n">credential</span><span class="o">.</span><span class="n">credential</span> <span class="o">=</span> <span class="n">value_</span>
            <span class="k">return</span> <span class="n">credential</span>

        <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">Credential</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span> <span class="n">credential_type</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span>
            <span class="n">refresh_credential</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">,</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span> <span class="n">allow_persistent_token</span><span class="o">=</span><span class="n">is_persistent</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">credential</span>

<div class="viewcode-block" id="RBDigitalAPI.get_credential_by_token"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_credential_by_token">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_credential_by_token</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">credential_type</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Credential</span><span class="o">.</span><span class="n">lookup_by_token</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">credential_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.fetch_patron_bearer_token"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.fetch_patron_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_patron_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain a patron bearer token for an RBdigital Patron.</span>

<span class="sd">        A patron bearer token for an account within an RBdigital collection</span>
<span class="sd">        can be obtained with the patron&#39;s RBdigital `userId` for that</span>
<span class="sd">        collection. (An initial bearer token also can also be captured</span>
<span class="sd">        when an RBdigital account is first created, but that is not</span>
<span class="sd">        applicable here.)</span>

<span class="sd">        We don&#39;t cache `userId&#39;s locally, but can retrieve them with the</span>
<span class="sd">        account&#39;s `username`. (This usually has the same value as the</span>
<span class="sd">        patron&#39;s barcode/authorization_identifier; but, because of the</span>
<span class="sd">        `Barcode+6` technique used to create accounts for patrons who don&#39;t</span>
<span class="sd">        have a registered email address, this is not always the case, so we</span>
<span class="sd">        cannot rely on it.) So, we obtain the username by looking it up</span>
<span class="sd">        using the `patronId`, a property that we cache locally.</span>

<span class="sd">        So, the process, in summary:</span>
<span class="sd">            - Get `patronId` from cache or RBdigital,</span>
<span class="sd">            - Fetch `username` using `patronId`.</span>
<span class="sd">            - Fetch `userId` using `username`.</span>
<span class="sd">            - Obtain `bearer` token using `userId`.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :return: A bearer token associated with the patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">request_helper</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;(unspecified action)&#39;</span><span class="p">,</span>
                           <span class="n">allowed_response_codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,):</span>
            <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span>
            <span class="k">if</span> <span class="n">allowed_response_codes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">allowed_response_codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">allowed_response_codes</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PatronAuthorizationFailedException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span>
                <span class="s2">&quot;: http=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># start with a patron_id</span>
        <span class="n">patron_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CACHED_IDENTIFIER_PROPERTY</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">request_helper</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">),</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;lookup username&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;userName&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request_helper</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/rpc/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">username</span><span class="p">),</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;lookup userId&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bearer_token</span> <span class="o">=</span> <span class="n">request_helper</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/tokens&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;userId&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}),</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;obtain patron bearer token&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;bearer&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">bearer_token</span></div>

<div class="viewcode-block" id="RBDigitalAPI.cache_patron_bearer_token"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.cache_patron_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">cache_patron_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.patron_bearer_token"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">patron_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.reauthorize_patron_bearer_token"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.reauthorize_patron_bearer_token">[docs]</a>    <span class="k">def</span> <span class="nf">reauthorize_patron_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_patron_bearer_token</span><span class="p">(</span>
            <span class="n">patron</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_patron_bearer_token</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.patron_remote_identifier"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_remote_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">patron_remote_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locate the identifier for the given Patron&#39;s account on the</span>
<span class="sd">        RBdigital side, creating a new RBdigital account if necessary.</span>

<span class="sd">        The identifier is cached in a persistent Credential object.</span>

<span class="sd">        The logic is complicated and spread out over multiple methods,</span>
<span class="sd">        so here it is all in one place:</span>

<span class="sd">        If an already-cached identifier is present, we use it.</span>

<span class="sd">        Otherwise, we look up the patron&#39;s barcode on RBdigital to try</span>
<span class="sd">        to find their existing RBdigital account.</span>

<span class="sd">        If we find an existing RBdigital account, we cache the</span>
<span class="sd">        identifier associated with that account.</span>

<span class="sd">        Otherwise, we need to create an RBdigital account for this patron:</span>

<span class="sd">        If the ILS provides access to the patron&#39;s email address, we</span>
<span class="sd">        create an account using the patron&#39;s actual barcode and email</span>
<span class="sd">        address. This will let them use the &#39;recover password&#39; feature</span>
<span class="sd">        if they want to use the RBdigital web site.</span>

<span class="sd">        If the ILS does not provide access to the patron&#39;s email</span>
<span class="sd">        address, we create an account using the patron&#39;s actual</span>
<span class="sd">        barcode but with six random characters appended. This will let</span>
<span class="sd">        the patron create a new RBdigital account using their actual</span>
<span class="sd">        barcode, if they want to use the web site.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :return: The identifier associated with the patron&#39;s (possibly</span>
<span class="sd">            newly created) RBdigital account. This is an</span>
<span class="sd">            RBdigital-internal identifier with no connection to any</span>
<span class="sd">            identifier used by the patron, the circulation manager,</span>
<span class="sd">            and the ILS.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CACHED_IDENTIFIER_PROPERTY</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_find_or_create_remote_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up a patron on RBdigital, creating an account if necessary.</span>

<span class="sd">        :param patron: A Patron.</span>
<span class="sd">        :return: The identifier associated with the (possibly newly</span>
<span class="sd">            created) RBdigital account. This is an RBdigital-internal</span>
<span class="sd">            patron ID and has no connection to any identifier used</span>
<span class="sd">            by the patron, the circulation manager, and the ILS.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Try the easy case -- the patron already set up an RBdigital</span>
        <span class="c1"># account using their authorization identifier.</span>
        <span class="n">remote_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier_lookup</span><span class="p">(</span>
            <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_identifier</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">remote_identifier</span>

        <span class="c1"># There is no RBdigital account associated with the patron&#39;s</span>
        <span class="c1"># authorization identifier. And there is no preexisting</span>
        <span class="c1"># Credential representing a dummy account, or this method</span>
        <span class="c1"># wouldn&#39;t have been called. We must create a new account.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_patron</span><span class="p">(</span>
                <span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">patron</span><span class="o">.</span><span class="n">authorization_identifier</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patron_email_address</span><span class="p">(</span><span class="n">patron</span><span class="p">),</span>
                <span class="n">bearer_token_handler</span><span class="o">=</span><span class="k">lambda</span> <span class="n">token</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_patron_bearer_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">RemotePatronCreationFailedException</span><span class="p">:</span>
            <span class="c1"># Its possible to get a RemotePatronCreationFailedException if an account</span>
            <span class="c1"># was already created for this patron, but never put in the DB due to an</span>
            <span class="c1"># error. Here we try to recover that account using its email address.</span>
            <span class="n">remote_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier_lookup</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patron_email_address</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_identifier</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">remote_identifier</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>


<div class="viewcode-block" id="RBDigitalAPI.create_patron"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.create_patron">[docs]</a>    <span class="k">def</span> <span class="nf">create_patron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">email_address</span><span class="p">,</span>
                      <span class="n">bearer_token_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ask RBdigital to create a new patron record.</span>

<span class="sd">        :param library: Library for the patron that needs a new RBdigital</span>
<span class="sd">            account. This has no necessary connection to the &#39;library_id&#39;</span>
<span class="sd">            associated with the RBDigitalAPI, since multiple circulation</span>
<span class="sd">            manager libraries may share an RBdigital account.</span>
<span class="sd">        :param authorization_identifier: The identifier the patron uses</span>
<span class="sd">            to authenticate with their library.</span>
<span class="sd">        :param email_address: The email address, if any, which the patron</span>
<span class="sd">            has shared with their library.</span>

<span class="sd">        :return The internal RBdigital identifier for this patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/patrons/&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">)</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create_patron&quot;</span>

        <span class="n">post_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_patron_body</span><span class="p">(</span>
            <span class="n">library</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">,</span> <span class="n">email_address</span>
        <span class="p">)</span>

        <span class="n">resp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_args</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">resp_dict</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># general validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span>
        <span class="p">)</span>

        <span class="c1"># Extract the patron&#39;s RBDigital ID from the response document.</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="n">patron_info</span> <span class="o">=</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patron&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">patron_info</span><span class="p">:</span>
                <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="n">patron_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patronId&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bearer_token_handler</span> <span class="ow">and</span> <span class="s1">&#39;bearer&#39;</span> <span class="ow">in</span> <span class="n">resp_dict</span><span class="p">:</span>
                <span class="n">bearer_token_handler</span><span class="p">(</span><span class="n">resp_dict</span><span class="p">[</span><span class="s1">&#39;bearer&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patron_rbdigital_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemotePatronCreationFailedException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span>
                <span class="s2">&quot;: http=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">patron_rbdigital_id</span></div>

    <span class="k">def</span> <span class="nf">_create_patron_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">,</span>
                            <span class="n">email_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the entity-body for a patron creation request.</span>

<span class="sd">        :param library: Library for the patron that needs a new RBdigital</span>
<span class="sd">            account.</span>
<span class="sd">        :param authorization_identifier: The identifier the patron uses</span>
<span class="sd">            to authenticate with their library.</span>
<span class="sd">        :param email_address: The email address, if any, which the patron</span>
<span class="sd">            has shared with their library.</span>

<span class="sd">        :return: A dictionary of key-value pairs to go along with an</span>
<span class="sd">        HTTP POST request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">email_address</span><span class="p">:</span>
            <span class="c1"># We know the patron&#39;s email address. We can create an</span>
            <span class="c1"># account they can also use in other contexts.</span>
            <span class="n">patron_identifier</span> <span class="o">=</span> <span class="n">authorization_identifier</span>
            <span class="n">email_address</span> <span class="o">=</span> <span class="n">email_address</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We don&#39;t know the patron&#39;s email address. We will create</span>
            <span class="c1"># a dummy account to avoid locking them out of the ability</span>
            <span class="c1"># to use an RBdigital account in other contexts.</span>
            <span class="n">patron_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_patron_identifier</span><span class="p">(</span>
                <span class="n">authorization_identifier</span>
            <span class="p">)</span>
            <span class="n">email_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_email_address</span><span class="p">(</span>
                <span class="n">library</span><span class="p">,</span> <span class="n">authorization_identifier</span>
            <span class="p">)</span>

        <span class="c1"># If we are using the patron&#39;s actual authorization identifier,</span>
        <span class="c1"># then our best guess at a username is that same identifier.</span>
        <span class="c1">#</span>
        <span class="c1"># If we&#39;re making up a dummy authorization identifier, then</span>
        <span class="c1"># using that as the username will minimize the risk of taking</span>
        <span class="c1"># someone&#39;s username.</span>
        <span class="c1">#</span>
        <span class="c1"># Either way:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">patron_identifier</span>

        <span class="n">post_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;libraryCard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patron_identifier</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;userName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_address</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;firstName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Library&#39;</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;lastName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Simplified&#39;</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;postalCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;11111&#39;</span>

        <span class="c1"># We have no way of communicating the password to this patron.</span>
        <span class="c1"># Set it to a random value and forget it. If we&#39;re creating an</span>
        <span class="c1"># account with the patron&#39;s email address, they&#39;ll be able to</span>
        <span class="c1"># recover their password. If not, at least we didn&#39;t claim</span>
        <span class="c1"># their barcode, and they can make a new account if they want.</span>
        <span class="n">post_args</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">post_args</span>

<div class="viewcode-block" id="RBDigitalAPI.dummy_patron_identifier"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.dummy_patron_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">dummy_patron_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add six random alphanumeric characters to the end of</span>
<span class="sd">        the given `authorization_identifier`.</span>

<span class="sd">        :return: A random identifier based on the input identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alphabet</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span>
        <span class="n">addendum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">alphabet</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">authorization_identifier</span> <span class="o">+</span> <span class="n">addendum</span></div>

<div class="viewcode-block" id="RBDigitalAPI.dummy_email_address"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.dummy_email_address">[docs]</a>    <span class="k">def</span> <span class="nf">dummy_email_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">authorization_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The fake email address to send to RBdigital when</span>
<span class="sd">        creating an account for the given patron.</span>

<span class="sd">        :param library: A Library.</span>
<span class="sd">        :param authorization_identifier: A patron&#39;s authorization identifier.</span>
<span class="sd">        :return: An email address unique to this patron which will</span>
<span class="sd">            bounce or reject all mail sent to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_notification_email_address</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemotePatronCreationFailedException</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cannot create remote account for patron because library&#39;s default notification address is not set.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># notifications@library.org</span>
        <span class="c1">#   =&gt;</span>
        <span class="c1"># notifications+rbdigital-1234567890@library.org</span>
        <span class="n">replace_with</span> <span class="o">=</span> <span class="s1">&#39;+rbdigital-</span><span class="si">%s</span><span class="s1">@&#39;</span> <span class="o">%</span> <span class="n">authorization_identifier</span>
        <span class="k">return</span> <span class="n">default</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalAPI.patron_remote_identifier_lookup"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_remote_identifier_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">patron_remote_identifier_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up a patron&#39;s RBdigital account based on an identifier</span>
<span class="sd">        associated with their circulation manager account.</span>

<span class="sd">        :param remote_identifier: Depending on the context, this may</span>
<span class="sd">            be the patron&#39;s actual barcode, or a random string _based_ on</span>
<span class="sd">            their barcode.</span>

<span class="sd">        :return: The internal RBdigital patron ID for the given</span>
<span class="sd">            identifier, or None if there is no corresponding RBdigital</span>
<span class="sd">            account.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;patron_id&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/rpc/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">,</span> <span class="n">remote_identifier</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">resp_dict</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">PatronNotFoundOnRemote</span><span class="p">,</span> <span class="n">NotFoundOnRemote</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># That&#39;s okay.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">internal_patron_id</span> <span class="o">=</span> <span class="n">resp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patronId&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">internal_patron_id</span></div>

<div class="viewcode-block" id="RBDigitalAPI.get_patron_checkouts"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_patron_checkouts">[docs]</a>    <span class="k">def</span> <span class="nf">get_patron_checkouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">,</span> <span class="n">fulfill_part_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">request_fulfillment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fulfillment_proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the books and audio the patron currently has checked out.</span>
<span class="sd">        Obtains fulfillment info for each item -- the way to fulfill a book</span>
<span class="sd">        is to get this list of possibilities first, and then call individual</span>
<span class="sd">        fulfillment endpoints on the individual items.</span>

<span class="sd">        :param patron_id RBDigital internal id for the patron.</span>

<span class="sd">        :param fulfill_part_url: A function that generates circulation</span>
<span class="sd">           manager fulfillment URLs for individual parts of a book.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">/checkouts/&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">patron_id</span><span class="p">)</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;patron_checkouts&quot;</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">resp_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">resp_obj</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="c1"># if we succeeded, then we got back a list of checkouts</span>
                <span class="c1"># if we failed, then we got back a dictionary with an error message</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Patron checkouts failed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

        <span class="c1"># by now we can assume response is either empty or a list</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp_obj</span><span class="p">:</span>
            <span class="n">loan_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_loan_info</span><span class="p">(</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">fulfill_part_url</span><span class="o">=</span><span class="n">fulfill_part_url</span><span class="p">,</span>
                <span class="n">request_fulfillment</span><span class="o">=</span><span class="n">request_fulfillment</span><span class="p">,</span>
                <span class="n">fulfillment_proxy</span><span class="o">=</span><span class="n">fulfillment_proxy</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">loan_info</span><span class="p">:</span>
                <span class="n">loans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loan_info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loans</span></div>



    <span class="k">def</span> <span class="nf">_make_loan_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">fulfill_part_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">request_fulfillment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fulfillment_proxy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert one of the items returned by a request to /checkouts into a</span>
<span class="sd">        LoanInfo with an RBFulfillmentInfo.</span>

<span class="sd">        :param fulfill_part_url: A function that generates circulation</span>
<span class="sd">           manager fulfillment URLs for individual parts of a book.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">media_type</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mediaType&#39;</span><span class="p">,</span> <span class="s1">&#39;eBook&#39;</span><span class="p">)</span>
        <span class="n">isbn</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isbn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># &#39;expiration&#39; here refers to the expiration date of the loan, not</span>
        <span class="c1"># of the fulfillment URL.</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expiration&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">expires</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRATION_DATE_FORMAT</span>
            <span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">identifier</span><span class="p">,</span> <span class="n">made_new</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">for_foreign_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">foreign_identifier_type</span><span class="o">=</span><span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span><span class="p">,</span>
            <span class="n">foreign_id</span><span class="o">=</span><span class="n">isbn</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="c1"># We have never heard of this book, which means the patron</span>
            <span class="c1"># didn&#39;t borrow it through us.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fulfillment_info</span> <span class="o">=</span> <span class="n">RBFulfillmentInfo</span><span class="p">(</span>
            <span class="n">fulfill_part_url</span><span class="p">,</span>
            <span class="n">request_fulfillment</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">item</span><span class="p">,</span>
            <span class="n">fulfillment_proxy</span><span class="o">=</span><span class="n">fulfillment_proxy</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">LoanInfo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span><span class="p">,</span>
            <span class="n">isbn</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
            <span class="n">fulfillment_info</span><span class="o">=</span><span class="n">fulfillment_info</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RBDigitalAPI.get_patron_holds"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_patron_holds">[docs]</a>    <span class="k">def</span> <span class="nf">get_patron_holds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param patron_id RBDigital internal id for the patron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/patrons/</span><span class="si">%s</span><span class="s2">/holds/&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">patron_id</span><span class="p">)</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;patron_holds&quot;</span>
        <span class="n">holds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">resp_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">resp_obj</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="c1"># if we succeeded, then we got back a list of holds</span>
                <span class="c1"># if we failed, then we got back a dictionary with an error message</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Patron holds failed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

        <span class="c1"># by now we can assume response is either empty or a list</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp_obj</span><span class="p">:</span>
            <span class="c1"># go through patron&#39;s holds and HoldInfo objects.</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mediaType&#39;</span><span class="p">,</span> <span class="s1">&#39;eBook&#39;</span><span class="p">)</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isbn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expiration&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
                <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRATION_DATE_FORMAT</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

            <span class="n">identifier</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">from_asin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">autocreate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Note: if RBDigital knows about a patron&#39;s checked-out item that wasn&#39;t</span>
            <span class="c1"># checked out through us, we ignore it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">hold</span> <span class="o">=</span> <span class="n">HoldInfo</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
                <span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span><span class="p">,</span>
                <span class="n">isbn</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
                <span class="n">hold_position</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>

            <span class="n">holds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">holds</span></div>

<div class="viewcode-block" id="RBDigitalAPI.patron_activity"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a patron&#39;s current checkouts and holds.</span>

<span class="sd">        :param patron: a Patron object for the patron who wants to return the book.</span>
<span class="sd">        :param pin: The patron&#39;s password (not used).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patron_rbdigital_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_remote_identifier</span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>

        <span class="n">patron_checkouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patron_checkouts</span><span class="p">(</span><span class="n">patron_rbdigital_id</span><span class="p">)</span>
        <span class="n">patron_holds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patron_holds</span><span class="p">(</span><span class="n">patron_rbdigital_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patron_checkouts</span> <span class="o">+</span> <span class="n">patron_holds</span></div>


    <span class="sd">&#39;&#39;&#39; -------------------------- Validation Handling -------------------------- &#39;&#39;&#39;</span>
<div class="viewcode-block" id="RBDigitalAPI.validate_item"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.validate_item">[docs]</a>    <span class="k">def</span> <span class="nf">validate_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Are we performing operations on a book that exists and can be</span>
<span class="sd">        uniquely identified?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item_rbdigital_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">media</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">identifier</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">item_rbdigital_id</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item_rbdigital_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInputException</span><span class="p">(</span><span class="s2">&quot;Licensepool </span><span class="si">%r</span><span class="s2"> doesn&#39;t know its ISBN.&quot;</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">work</span> <span class="ow">and</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
            <span class="n">media</span> <span class="o">=</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">medium</span>

        <span class="k">return</span> <span class="n">item_rbdigital_id</span><span class="p">,</span> <span class="n">media</span></div>

<div class="viewcode-block" id="RBDigitalAPI.validate_response"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.validate_response">[docs]</a>    <span class="k">def</span> <span class="nf">validate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; RBDigital tries to communicate statuses and errors through http codes.</span>
<span class="sd">        Malformed url requests will throw a 500, non-existent ids will get a 404,</span>
<span class="sd">        trying an action like checkout on a patron/item combo that&#39;s blocked</span>
<span class="sd">        (like if the item is already checked out, for example) will get a 409, etc..</span>
<span class="sd">        Further details are usually elaborated on in the &quot;message&quot; field of the response.</span>

<span class="sd">        :param response http response object</span>
<span class="sd">        :message RBDigital puts error explanation into &#39;message&#39; field in response dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> call failed: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                <span class="c1"># yes, it could be a server error, but it can also be a malformed value in the request</span>
                <span class="c1"># sometimes those cause nice sql stack traces, which end up in 500s.</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;eXtensible Framework encountered a SqlException&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InvalidInputException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;A patron account with the specified username, email address, or card number already exists for this library.&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RemotePatronCreationFailedException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RemoteInitiatedServerError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

            <span class="c1"># a 409 conflict code can mean many things</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;checkout&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Maximum checkout count reached.&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PatronLoanLimitReached</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Checkout item already exists&quot;</span><span class="p">:</span>
                    <span class="c1"># we tried to borrow something the patron already has</span>
                    <span class="k">raise</span> <span class="n">AlreadyCheckedOut</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Title is not available for checkout&quot;</span><span class="p">:</span>
                    <span class="c1"># This will put the book on hold, and if it ever</span>
                    <span class="c1"># shows up again it&#39;ll be checked out</span>
                    <span class="c1"># automatically. If it doesn&#39;t show up again...</span>
                    <span class="c1"># best not to think about that.</span>
                    <span class="k">raise</span> <span class="n">NoAvailableCopies</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;checkin&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Checkout does not exists or it is already terminated or expired.&quot;</span><span class="p">:</span>
                    <span class="c1"># we tried to return something the patron doesn&#39;t own</span>
                    <span class="k">raise</span> <span class="n">NotCheckedOut</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CannotReturn</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotFoundOnRemote</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInputException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
                <span class="c1"># There is no additional information to be had.</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;eXtensible Framework was unable to locate the resource for RB.API.OneClick.UserPatron.Get&quot;</span><span class="p">):</span>
                <span class="c1"># http code was OK, but info wasn&#39;t sucessfully read from db</span>
                <span class="k">raise</span> <span class="n">PatronNotFoundOnRemote</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not retrieved: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="RBDigitalAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Allows smoother faster creation of unit tests by letting</span>
<span class="sd">        us live-test as we write. &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="sd">&#39;&#39;&#39; --------------------- Getters and Setters -------------------------- &#39;&#39;&#39;</span>

<div class="viewcode-block" id="RBDigitalAPI.get_all_available_through_search"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_all_available_through_search">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_available_through_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a list of ebook and eaudio items this library has access to, that are currently</span>
<span class="sd">        available to lend.  Uses the &quot;availability&quot; facet of the search function.</span>
<span class="sd">        An alternative to self.get_availability_info().</span>
<span class="sd">        Calls paged search until done.</span>
<span class="sd">        Uses minimal verbosity for result set.</span>

<span class="sd">        Note:  Some libraries can see other libraries&#39; catalogs, even if the patron</span>
<span class="sd">        cannot checkout the items.  The library ownership information is in the &quot;interest&quot;</span>
<span class="sd">        fields of the response.</span>

<span class="sd">        :return A dictionary representation of the response, containing catalog count and ebook item - interest pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">availability</span><span class="o">=</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESPONSE_VERBOSITY</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">respdict</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="s2">&quot;availability_search&quot;</span><span class="p">,</span> <span class="s2">&quot;RBDigital availability response not parseable.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">respdict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="s2">&quot;availability_search&quot;</span><span class="p">,</span> <span class="s2">&quot;RBDigital availability response not parseable - has no structure.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;pageIndex&#39;</span> <span class="ow">in</span> <span class="n">respdict</span> <span class="ow">and</span> <span class="s1">&#39;pageCount&#39;</span> <span class="ow">in</span> <span class="n">respdict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="s2">&quot;availability_search&quot;</span><span class="p">,</span> <span class="s2">&quot;RBDigital availability response not parseable - has no page counts.&quot;</span><span class="p">)</span>

        <span class="n">page_index</span> <span class="o">=</span> <span class="n">respdict</span><span class="p">[</span><span class="s1">&#39;pageIndex&#39;</span><span class="p">]</span>
        <span class="n">page_count</span> <span class="o">=</span> <span class="n">respdict</span><span class="p">[</span><span class="s1">&#39;pageCount&#39;</span><span class="p">]</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">page_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">page_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">page_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">availability</span><span class="o">=</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESPONSE_VERBOSITY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">page_index</span><span class="o">=</span><span class="n">page_index</span><span class="p">)</span>
            <span class="n">tempdict</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">tempdict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="s2">&quot;availability_search&quot;</span><span class="p">,</span> <span class="s2">&quot;RBDigital availability response not parseable - has no next dict.&quot;</span><span class="p">)</span>
            <span class="n">item_interest_pairs</span> <span class="o">=</span> <span class="n">tempdict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
            <span class="n">respdict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item_interest_pairs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">respdict</span></div>


<div class="viewcode-block" id="RBDigitalAPI.get_all_catalog"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_all_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the entire RBDigital catalog for a particular library.</span>

<span class="sd">        Note:  This call taxes RBDigital&#39;s servers, and is to be performed sparingly.</span>
<span class="sd">        The results are returned unpaged.</span>

<span class="sd">        Also, the endpoint returns about as much metadata per item as the media/{isbn} endpoint does.</span>
<span class="sd">        If want more metadata, perform a search.</span>

<span class="sd">        :return A list of dictionaries representation of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/media/all&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">resplist</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital all catalog response not parseable.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="RBDigitalAPI.get_delta"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_delta">[docs]</a>    <span class="k">def</span> <span class="nf">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the changes to the library&#39;s catalog.</span>

<span class="sd">        :return A dictionary listing items added/removed/modified in the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/book-holdings/delta&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">))</span>

        <span class="c1"># can&#39;t reverse time direction</span>
        <span class="k">if</span> <span class="n">from_date</span> <span class="ow">and</span> <span class="n">to_date</span> <span class="ow">and</span> <span class="p">(</span><span class="n">from_date</span> <span class="o">&gt;</span> <span class="n">to_date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;from_date </span><span class="si">%s</span><span class="s2"> cannot be after to_date </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">))</span>

        <span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_dates_to_available_snapshots</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_date</span> <span class="o">==</span> <span class="n">to_date</span><span class="p">:</span>
            <span class="c1"># This can happen because from_date and to_date from the call were the same,</span>
            <span class="c1"># but can also occur for the following reasons:</span>
            <span class="c1"># - only a single snapshot is available</span>
            <span class="c1"># - both dates are less than the date of the first snapshot</span>
            <span class="c1"># - both dates are greater than the date of the last snapshot</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The effective begin and end RBDigital catalog snapshot dates cannot be the same.&quot;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_date</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_date</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

    <span class="k">class</span> <span class="nc">_FuzzyBinarySearcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A fuzzy binary searcher sorts an array by its key, and then must either:</span>
<span class="sd">          - find an exact match, if one exists; or</span>
<span class="sd">          - return an &quot;adjacent&quot; index and the direction in which a match</span>
<span class="sd">            would have been found, had one existed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">INDEXED_GREATER_THAN_MATCH</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">INDEXED_EQUALS_MATCH</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">INDEXED_LESS_THAN_MATCH</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize the object with a sorted array.</span>

<span class="sd">            :param array: An array</span>
<span class="sd">            :param key: A function of one argument that is used to extract</span>
<span class="sd">                a comparison key from each element in array and by which</span>
<span class="sd">                the array is sorted. The default value is None (compare</span>
<span class="sd">                value to complete array element).</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;key&#39; must be &#39;None&#39; or a callable.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sorted_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sorted_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Search for value in array, returning a matching or &quot;adjacent&quot; index.</span>
<span class="sd">            Return the selected index and the relative direction to a match.</span>
<span class="sd">            (0 =&gt; match, -1 =&gt; value &lt; match&#39;s value, 1 =&gt; value &gt; match&#39;s value).</span>
<span class="sd">            An empty array returns None for both offset and direction.</span>

<span class="sd">            :param value: the value to find</span>
<span class="sd">            :return: offset (index), direction</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>
            <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sorted_list</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INDEXED_LESS_THAN_MATCH</span>
                <span class="k">elif</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INDEXED_GREATER_THAN_MATCH</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INDEXED_EQUALS_MATCH</span>
            <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span>

<div class="viewcode-block" id="RBDigitalAPI.align_dates_to_available_snapshots"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.align_dates_to_available_snapshots">[docs]</a>    <span class="k">def</span> <span class="nf">align_dates_to_available_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given specified begin and end dates for a delta, return the best dates from those available.</span>

<span class="sd">        Note: It might be useful to raise an exception or log a message if either of the</span>
<span class="sd">        &quot;best&quot; dates is too distant from the associated specified date.</span>

<span class="sd">        The endpoint utilized returns a JSON array of &quot;snapshot&quot; objects (nb: tenantId is the library ID):</span>
<span class="sd">            Example snapshot format:</span>
<span class="sd">                &quot;tenantId&quot;: 525,</span>
<span class="sd">                &quot;asOf&quot;: &quot;2020-04-07&quot;,</span>
<span class="sd">                &quot;eBookCount&quot;: 1630,</span>
<span class="sd">                &quot;eAudioCount&quot;: 13414,</span>
<span class="sd">                &quot;totalCount&quot;: 15044</span>

<span class="sd">        :return Best available begin and end dates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SNAPSHOT_DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/book-holdings/delta/available-dates&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snapshots</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital available-dates response not parsable.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital available-dates response contains no snapshots.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_snapshot_date</span><span class="p">(</span><span class="n">snapshot</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;asOf&quot;</span><span class="p">]</span>

        <span class="n">fuzzy_snapshot_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FuzzyBinarySearcher</span><span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_snapshot_date</span><span class="p">)</span>
        <span class="n">snapshots</span> <span class="o">=</span> <span class="n">fuzzy_snapshot_search</span><span class="o">.</span><span class="n">sorted_list</span>

        <span class="c1"># need date strings here</span>
        <span class="k">if</span> <span class="n">from_date</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">from_date</span> <span class="o">=</span> <span class="n">from_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">SNAPSHOT_DATE_FORMAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_date</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">to_date</span> <span class="o">=</span> <span class="n">to_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">((</span><span class="n">SNAPSHOT_DATE_FORMAT</span><span class="p">))</span>

        <span class="c1"># Find the best snapshot for the begin date and for the end date.</span>
        <span class="c1"># The approach here is to widen the net when there is not an exact</span>
        <span class="c1"># match, such that begin date would be adjusted back and end date</span>
        <span class="c1"># forward. A missing begin date will be assigned the date of the</span>
        <span class="c1"># earliest snapshot; a missing end date, gets the date of the latest.</span>
        <span class="k">if</span> <span class="n">from_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">begin_date</span> <span class="o">=</span> <span class="n">get_snapshot_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">relative</span> <span class="o">=</span> <span class="n">fuzzy_snapshot_search</span><span class="p">(</span><span class="n">from_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relative</span> <span class="o">==</span> <span class="n">fuzzy_snapshot_search</span><span class="o">.</span><span class="n">INDEXED_GREATER_THAN_MATCH</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">begin_date</span> <span class="o">=</span> <span class="n">get_snapshot_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">to_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">get_snapshot_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">relative</span> <span class="o">=</span> <span class="n">fuzzy_snapshot_search</span><span class="p">(</span><span class="n">to_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relative</span> <span class="o">==</span> <span class="n">fuzzy_snapshot_search</span><span class="o">.</span><span class="n">INDEXED_LESS_THAN_MATCH</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">get_snapshot_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span></div>

<div class="viewcode-block" id="RBDigitalAPI.get_ebook_availability_info"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_ebook_availability_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebook_availability_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;ebook&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a list of ebook items this library has access to, through the &quot;availability&quot; endpoint.</span>
<span class="sd">        The response at this endpoint is laconic -- just enough fields per item to</span>
<span class="sd">        identify the item and declare it either available to lend or not.</span>

<span class="sd">        :param media_type &#39;eBook&#39;/&#39;eAudio&#39;</span>

<span class="sd">        :return A list of dictionary items, each item giving &quot;yes/no&quot; answer on a book&#39;s current availability to lend.</span>
<span class="sd">            Example of returned item format:</span>
<span class="sd">                &quot;timeStamp&quot;: &quot;2016-10-07T16:11:52.5887333Z&quot;</span>
<span class="sd">                &quot;isbn&quot;: &quot;9781420128567&quot;</span>
<span class="sd">                &quot;mediaType&quot;: &quot;eBook&quot;</span>
<span class="sd">                &quot;availability&quot;: false</span>
<span class="sd">                &quot;titleId&quot;: 39764</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/media/</span><span class="si">%s</span><span class="s2">/availability&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">media_type</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">resplist</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital availability response not parsable.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resplist</span></div>

<div class="viewcode-block" id="RBDigitalAPI.get_metadata_by_isbn"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.get_metadata_by_isbn">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata_by_isbn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets metadata, s.a. publisher, date published, genres, etc for the</span>
<span class="sd">        eBook or eAudio item passed, using isbn to search on.</span>
<span class="sd">        If isbn is not found, the response we get from RBDigital is an error message,</span>
<span class="sd">        and we throw an error.</span>

<span class="sd">        :return the json dictionary of the response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need valid identifier to get metadata.&quot;</span><span class="p">)</span>

        <span class="n">identifier_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_identifier_strings</span><span class="p">([</span><span class="n">identifier</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/media/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">identifier_string</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">respdict</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital isbn search response not parseable.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">respdict</span><span class="p">:</span>
            <span class="c1"># should never happen</span>
            <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;RBDigital isbn search response not parseable - has no respdict.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">respdict</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">respdict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;MediaType&#39;, &#39;TitleId&#39; or &#39;ISBN&#39; token value supplied: &quot;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;eXtensible Framework was unable to locate the resource&quot;</span><span class="p">)):</span>
                <span class="c1"># we searched for item that&#39;s not in library&#39;s catalog -- a mistake, but not an exception</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># something more serious went wrong</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;get_metadata_by_isbn(</span><span class="si">%s</span><span class="s2">) in library #</span><span class="si">%s</span><span class="s2"> catalog ran into problems: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identifier_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">),</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">BadResponseException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">respdict</span></div>

<div class="viewcode-block" id="RBDigitalAPI.populate_all_catalog"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.populate_all_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">populate_all_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call get_all_catalog to get all of library&#39;s book info from RBDigital.</span>
<span class="sd">        Create Work, Edition, LicensePool objects in our database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">catalog_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_catalog</span><span class="p">()</span>
        <span class="n">items_transmitted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog_list</span><span class="p">)</span>
        <span class="n">items_created</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># the default policy doesn&#39;t update delivery mechanisms, which we do want to do</span>
        <span class="n">metadata_replacement_policy</span> <span class="o">=</span> <span class="n">ReplacementPolicy</span><span class="o">.</span><span class="n">from_metadata_source</span><span class="p">()</span>
        <span class="n">metadata_replacement_policy</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">coverage_provider</span> <span class="o">=</span> <span class="n">RBDigitalBibliographicCoverageProvider</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">replacement_policy</span><span class="o">=</span><span class="n">metadata_replacement_policy</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">catalog_item</span> <span class="ow">in</span> <span class="n">catalog_list</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">coverage_provider</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span>
                <span class="n">catalog_item</span><span class="o">=</span><span class="n">catalog_item</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">CoverageFailure</span><span class="p">):</span>
                <span class="n">items_created</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                    <span class="c1"># calls work.set_presentation_ready() for us</span>
                    <span class="n">coverage_provider</span><span class="o">.</span><span class="n">handle_success</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                    <span class="c1"># We&#39;re populating the catalog, so we can assume the list RBDigital</span>
                    <span class="c1"># sent us is of books we own licenses to.</span>
                    <span class="c1"># NOTE:  TODO later:  For the 4 out of 2000 libraries that chose to display</span>
                    <span class="c1"># books they don&#39;t own, we&#39;d need to call the search endpoint to get</span>
                    <span class="c1"># the interest field, and then deal with licenses_owned.</span>
                    <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lp</span><span class="o">.</span><span class="n">collection</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
                            <span class="n">lp</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="c1"># Start off by assuming the book is available.</span>
                            <span class="c1"># If it&#39;s not, we&#39;ll hear differently the</span>
                            <span class="c1"># next time we use the collection delta API.</span>
                            <span class="n">lp</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items_created</span> <span class="o">%</span> <span class="mi">100</span><span class="p">:</span>
                <span class="c1"># Periodically commit the work done so that if there&#39;s</span>
                <span class="c1"># a failure, the subsequent run through this code will</span>
                <span class="c1"># take less time.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># stay data, stay!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_created</span></div>

<div class="viewcode-block" id="RBDigitalAPI.populate_delta"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.populate_delta">[docs]</a>    <span class="k">def</span> <span class="nf">populate_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call get_delta for the last month to get all of the library&#39;s book info changes</span>
<span class="sd">        from RBDigital.  Update Work, Edition, LicensePool objects in our database.</span>

<span class="sd">        :param today: A date to use instead of the current date, for use in tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">today</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">time_ago</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delta</span><span class="p">(</span><span class="n">from_date</span><span class="o">=</span><span class="p">(</span><span class="n">today</span> <span class="o">-</span> <span class="n">time_ago</span><span class="p">),</span> <span class="n">to_date</span><span class="o">=</span><span class="n">today</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">delta</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">items_added</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;addedBooks&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">items_removed</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;removedBooks&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">items_transmitted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_added</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_removed</span><span class="p">)</span>
        <span class="n">items_updated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">coverage_provider</span> <span class="o">=</span> <span class="n">RBDigitalBibliographicCoverageProvider</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_added</span><span class="p">:</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;isbn&quot;</span><span class="p">]</span>
            <span class="n">catalog_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata_by_isbn</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">coverage_provider</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="n">catalog_item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">CoverageFailure</span><span class="p">):</span>
                <span class="n">items_updated</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># NOTE: To be consistent with populate_all_catalog, we</span>
                <span class="c1"># should start off assuming that this title is owned</span>
                <span class="c1"># and lendable. In practice, this isn&#39;t a big deal,</span>
                <span class="c1"># because process_availability() will give us the</span>
                <span class="c1"># right answer soon enough.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
                    <span class="c1"># calls work.set_presentation_ready() for us</span>
                    <span class="n">coverage_provider</span><span class="o">.</span><span class="n">handle_success</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">catalog_item</span> <span class="ow">in</span> <span class="n">items_removed</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">RBDigitalRepresentationExtractor</span><span class="o">.</span><span class="n">isbn_info_to_metadata</span><span class="p">(</span><span class="n">catalog_item</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="c1"># generate a CoverageFailure to let the system know to revisit this book</span>
                <span class="c1"># TODO:  if did not create a Work, but have a CoverageFailure for the isbn,</span>
                <span class="c1"># check that re-processing that coverage would generate the work.</span>
                <span class="c1"># e = &quot;Could not extract metadata from RBDigital data: %r&quot; % catalog_item</span>
                <span class="c1"># make_note = CoverageFailure(identifier, e, data_source=self.data_source, transient=True)</span>
                <span class="k">continue</span>

            <span class="c1"># convert IdentifierData into Identifier, if can</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">made_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">made_new</span><span class="p">:</span>
                <span class="c1"># Don&#39;t delete works from the database.  Set them to &quot;not ours anymore&quot;.</span>
                <span class="c1"># TODO: This was broken but it didn&#39;t cause any test failures,</span>
                <span class="c1"># which means it needs a test.</span>
                <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">identifier</span><span class="o">.</span><span class="n">licensed_through</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) from circulation&quot;</span><span class="p">,</span>
                                          <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">presentation_edition</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Removing unknown work </span><span class="si">%s</span><span class="s2"> from circulation.&quot;</span><span class="p">,</span>
                                <span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
                            <span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">licenses_owned</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">licenses_available</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">licenses_reserved</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">patrons_in_hold_queue</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">last_checked</span> <span class="o">=</span> <span class="n">today</span>

                <span class="n">items_updated</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># stay data, stay!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_updated</span></div>

<div class="viewcode-block" id="RBDigitalAPI.search"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalAPI.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mediatype</span><span class="o">=</span><span class="s1">&#39;ebook&#39;</span><span class="p">,</span> <span class="n">genres</span><span class="o">=</span><span class="p">[],</span> <span class="n">audience</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">availability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">page_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">page_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Form a rest-ful search query, send to RBDigital, and obtain the results.</span>

<span class="sd">        :param mediatype: Facet to limit results by media type.  Options are: &quot;eAudio&quot;, &quot;eBook&quot;.</span>
<span class="sd">        :param genres: The books found lie at intersection of genres passed.</span>
<span class="sd">        :param audience: Facet to limit results by target age group.  Options include (there may be more): &quot;adult&quot;,</span>
<span class="sd">            &quot;beginning-reader&quot;, &quot;childrens&quot;, &quot;young-adult&quot;.</span>
<span class="sd">        :param availability: Facet to limit results by copies left.  Options are &quot;available&quot;, &quot;unavailable&quot;, or None</span>
<span class="sd">        :param author: Full name to search on.</span>
<span class="sd">        :param title: Book title to search on.</span>
<span class="sd">        :param page_index: Used for paginated result sets.  Zero-based.</span>
<span class="sd">        :param verbosity: &quot;basic&quot; returns smaller number of response json lines than &quot;complete&quot;, etc..</span>

<span class="sd">        :return the response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/libraries/</span><span class="si">%s</span><span class="s2">/search&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_id</span><span class="p">))</span>

        <span class="c1"># make sure availability is in allowed format</span>
        <span class="k">if</span> <span class="n">availability</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="s2">&quot;unavailable&quot;</span><span class="p">):</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mediatype</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;media-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mediatype</span>
        <span class="k">if</span> <span class="n">genres</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genres</span>
        <span class="k">if</span> <span class="n">audience</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;audience&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audience</span>
        <span class="k">if</span> <span class="n">availability</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;availability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">availability</span>
        <span class="k">if</span> <span class="n">author</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">author</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">page_size</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;page-size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span>
        <span class="k">if</span> <span class="n">page_index</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;page-index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_index</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="RBFulfillmentInfo"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBFulfillmentInfo">[docs]</a><span class="k">class</span> <span class="nc">RBFulfillmentInfo</span><span class="p">(</span><span class="n">APIAwareFulfillmentInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An RBdigital-specific FulfillmentInfo implementation.</span>

<span class="sd">    We use these instead of real FulfillmentInfo objects because</span>
<span class="sd">    generating a FulfillmentInfo object may require an extra HTTP request,</span>
<span class="sd">    and there&#39;s often no need to make that request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fulfill_part_url</span><span class="p">,</span> <span class="n">request_fulfillment</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Grab properties used to support proxy fulfillment.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulfillment_proxy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fulfillment_proxy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">RBFulfillmentInfo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulfill_part_url</span> <span class="o">=</span> <span class="n">fulfill_part_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_fulfillment</span> <span class="o">=</span> <span class="n">request_fulfillment</span>

<div class="viewcode-block" id="RBFulfillmentInfo.fulfill_part"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBFulfillmentInfo.fulfill_part">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fulfill a specific part of this book.</span>

<span class="sd">        This will navigate the access document and find a link to</span>
<span class="sd">        the actual MP3 file so that a client doesn&#39;t know how to</span>
<span class="sd">        parse access documents.</span>

<span class="sd">        :return: A FulfillmentInfo if the part could be fulfilled;</span>
<span class="sd">            a ProblemDetail otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">!=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotPartiallyFulfill</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This work does not support partial fulfillment.&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotPartiallyFulfill</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%(part)s</span><span class="s1">&quot; is not a valid part number&#39;</span><span class="p">,</span> <span class="n">part</span><span class="o">=</span><span class="n">part</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">readingOrder</span>
        <span class="k">if</span> <span class="n">part</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">part</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotPartiallyFulfill</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not locate part number </span><span class="si">%(part)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">part</span><span class="o">=</span><span class="n">part</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">part_url</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">part</span><span class="p">][</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
        <span class="n">content_type</span><span class="p">,</span> <span class="n">content_link</span><span class="p">,</span> <span class="n">content_expires</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_access_document</span><span class="p">(</span><span class="n">part_url</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">content_link</span><span class="p">,</span>
            <span class="n">content_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">content_expires</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RBFulfillmentInfo.do_fetch"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBFulfillmentInfo.do_fetch">[docs]</a>    <span class="k">def</span> <span class="nf">do_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get a list of files associated with this loan.</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Determine if we&#39;re fulfilling an audiobook (which means sending a</span>
        <span class="c1"># manifest) or an ebook (which means sending a download link).</span>
        <span class="n">individual_download_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">representation_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># If we have an ebook, there should only be one file in</span>
            <span class="c1"># the list. If we have an audiobook, the first file should</span>
            <span class="c1"># be representative of the whole.</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file_format</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileFormat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;EPUB&#39;</span><span class="p">:</span>
                <span class="n">file_format</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Audio books don&#39;t list a fileFormat at all. TODO:</span>
                <span class="c1"># they do list a mediaType, which could be useful.</span>
                <span class="n">file_format</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">file_format</span>
            <span class="n">individual_download_url</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;downloadUrl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">:</span>
            <span class="c1"># We have an audiobook. Convert it from the</span>
            <span class="c1"># proprietary format to the standard format.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">AudiobookManifest</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulfill_part_url</span>
            <span class="p">)</span>
            <span class="c1"># An upstream caller knows whether we need a proxied manifest</span>
            <span class="c1"># and, if so, how to structure its URLs, so we&#39;ll defer to</span>
            <span class="c1"># them when instructed.</span>
            <span class="n">fulfillment_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulfillment_proxy</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulfillment_proxy</span> <span class="ow">and</span> <span class="n">fulfillment_proxy</span><span class="o">.</span><span class="n">use_proxy_links</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">fulfillment_proxy</span><span class="o">.</span><span class="n">proxied_manifest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We have some other kind of file. The download link</span>
            <span class="c1"># points to an access document for that file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_link</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_expires</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fetch_access_document</span><span class="p">(</span><span class="n">individual_download_url</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="RBFulfillmentInfo.fetch_access_document"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBFulfillmentInfo.fetch_access_document">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_access_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve an access document from RBdigital and process it.</span>

<span class="sd">        An access document is a small JSON document containing a link</span>
<span class="sd">        to the URL we actually want to deliver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">access_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_fulfillment</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_access_document</span><span class="p">(</span><span class="n">access_document</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBFulfillmentInfo.process_access_document"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBFulfillmentInfo.process_access_document">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">process_access_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_document</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the intermediary document served by RBdigital to tell</span>
<span class="sd">        you how to actually download a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">access_document</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">content_link</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.adobe&#39;</span><span class="p">:</span>
            <span class="c1"># The manifest spells the media type wrong. Fix it.</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>

        <span class="c1"># Now that we&#39;ve found the download URL, the client has 15</span>
        <span class="c1"># minutes to use it. Set it to expire in 14 minutes to be</span>
        <span class="c1"># conservative.</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content_link</span><span class="p">,</span> <span class="n">expires</span></div></div>

<div class="viewcode-block" id="MockRBDigitalAPI"><a class="viewcode-back" href="../../api.html#api.rbdigital.MockRBDigitalAPI">[docs]</a><span class="k">class</span> <span class="nc">MockRBDigitalAPI</span><span class="p">(</span><span class="n">RBDigitalAPI</span><span class="p">):</span>

<div class="viewcode-block" id="MockRBDigitalAPI.mock_collection"><a class="viewcode-back" href="../../api.html#api.rbdigital.MockRBDigitalAPI.mock_collection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mock_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="n">DatabaseTest</span><span class="o">.</span><span class="n">make_default_library</span><span class="p">(</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="n">get_one_or_create</span><span class="p">(</span>
            <span class="n">_db</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test RBDigital Collection&quot;</span><span class="p">,</span>
            <span class="n">create_method_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">external_account_id</span><span class="o">=</span><span class="s1">&#39;library_id_123&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">integration</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">create_external_integration</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span>
        <span class="p">)</span>
        <span class="n">integration</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;abcdef123hijklm&#39;</span>
        <span class="n">library</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Library</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">AUDIOBOOK_LOAN_DURATION_KEY</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">EBOOK_LOAN_DURATION_KEY</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">ConfigurationSetting</span><span class="o">.</span><span class="n">for_library_and_externalintegration</span><span class="p">(</span>
                    <span class="n">_db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span>
                <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;rbdigital&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MockRBDigitalAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We can store the actual Collection object with a mock API,</span>
<span class="sd">        so there&#39;s no need to store the ID and do lookups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span>

<div class="viewcode-block" id="MockRBDigitalAPI.queue_response"><a class="viewcode-back" href="../../api.html#api.rbdigital.MockRBDigitalAPI.queue_response">[docs]</a>    <span class="k">def</span> <span class="nf">queue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">core.testing</span> <span class="kn">import</span> <span class="n">MockRequestsResponse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MockRequestsResponse</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">_process_response</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_response_codes&#39;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disallowed_response_codes&#39;</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MockRBDigitalAPI.get_data"><a class="viewcode-back" href="../../api.html#api.rbdigital.MockRBDigitalAPI.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="c1"># returns contents of sample file as string and as dict</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MockRBDigitalAPI.populate_all_catalog"><a class="viewcode-back" href="../../api.html#api.rbdigital.MockRBDigitalAPI.populate_all_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">populate_all_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up to use the smaller test catalog file, and then call the real</span>
<span class="sd">        populate_all_catalog.  Used to test import on non-test permanent database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datastr</span><span class="p">,</span> <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;response_catalog_all_sample.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">datastr</span><span class="p">)</span>
        <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_created</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MockRBDigitalAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">populate_all_catalog</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_created</span></div></div>

<div class="viewcode-block" id="RBDigitalRepresentationExtractor"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalRepresentationExtractor">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalRepresentationExtractor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Extract useful information from RBDigital&#39;s JSON representations. &quot;&quot;&quot;</span>
    <span class="n">DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span> <span class="c1">#ex: 2013-12-27T00:00:00Z</span>
    <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="c1">#ex: 2013-12-27</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;RBDigital representation extractor&quot;</span><span class="p">)</span>

    <span class="n">rbdigital_medium_to_simplified_medium</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;eBook&quot;</span> <span class="p">:</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">,</span>
        <span class="s2">&quot;eAudio&quot;</span> <span class="p">:</span> <span class="n">Edition</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="RBDigitalRepresentationExtractor.image_link_to_linkdata"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalRepresentationExtractor.image_link_to_linkdata">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">image_link_to_linkdata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">link_url</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">link_url</span> <span class="ow">or</span> <span class="p">(</span><span class="n">link_url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">media_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">link_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">):</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="s2">&quot;image/jpeg&quot;</span>

        <span class="k">return</span> <span class="n">LinkData</span><span class="p">(</span><span class="n">rel</span><span class="o">=</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">link_url</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalRepresentationExtractor.isbn_info_to_metadata"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalRepresentationExtractor.isbn_info_to_metadata">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isbn_info_to_metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">include_bibliographic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_formats</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn RBDigital&#39;s JSON representation of a book into a Metadata object.</span>
<span class="sd">        Assumes the JSON is in the format that comes from the media/{isbn} endpoint.</span>

<span class="sd">        TODO:  Use the seriesTotal field.</span>

<span class="sd">        :param book a json response-derived dictionary of book attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;isbn&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">rbdigital_id</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;isbn&#39;</span><span class="p">]</span>
        <span class="n">primary_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span>
            <span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span><span class="p">,</span> <span class="n">rbdigital_id</span>
        <span class="p">)</span>

        <span class="c1"># medium is both bibliographic and format information.</span>

        <span class="c1"># options are: &quot;eBook&quot;, &quot;eAudio&quot;</span>
        <span class="n">rbdigital_medium</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mediaType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbdigital_medium</span> <span class="ow">and</span> <span class="n">rbdigital_medium</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rbdigital_medium_to_simplified_medium</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Could not process medium </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rbdigital_medium</span><span class="p">,</span> <span class="n">rbdigital_id</span><span class="p">)</span>

        <span class="n">medium</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rbdigital_medium_to_simplified_medium</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">rbdigital_medium</span><span class="p">,</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span>
        <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
            <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
            <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_bibliographic</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># NOTE: An item that&#39;s part of a series, will have the seriesName field, and</span>
            <span class="c1"># will have its seriesPosition and seriesTotal fields set to &gt;0.</span>
            <span class="c1"># An item not part of a series will have the seriesPosition and seriesTotal fields</span>
            <span class="c1"># set to 0, and will not have a seriesName at all.</span>
            <span class="c1"># Sometimes, series position and total == 0, for many series items (ex: &quot;seriesName&quot;: &quot;EngLits&quot;).</span>
            <span class="c1"># Sometimes, seriesName is set to &quot;Default Blank&quot;, meaning &quot;not actually a series&quot;.</span>
            <span class="n">series_name</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seriesName&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">series_position</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">series_name</span> <span class="o">==</span> <span class="s1">&#39;Default Blank&#39;</span><span class="p">:</span>
                <span class="c1"># This is not actually a series.</span>
                <span class="n">series_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">series_position</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seriesPosition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">series_position</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">series_position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">series_position</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># not big enough deal to stop the whole process</span>
                        <span class="n">series_position</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># ignored for now</span>
            <span class="n">series_total</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seriesTotal&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># ignored for now</span>
            <span class="n">has_digital_rights</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hasDigitalRights&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">publisher</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;publicationDate&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="n">published</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="n">book</span><span class="p">[</span><span class="s1">&#39;publicationDate&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">published</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="s1">&#39;language&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">LanguageCodes</span><span class="o">.</span><span class="n">string_to_alpha_3</span><span class="p">(</span><span class="n">book</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;eng&#39;</span>

            <span class="n">contributors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;authors&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="n">authors</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
                    <span class="n">sort_name</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
                        <span class="n">sort_name</span> <span class="o">=</span> <span class="n">name_tidy</span><span class="p">(</span><span class="n">sort_name</span><span class="p">)</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="n">sort_name_to_display_name</span><span class="p">(</span><span class="n">sort_name</span><span class="p">)</span>
                        <span class="n">roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">AUTHOR_ROLE</span><span class="p">]</span>
                        <span class="n">contributor</span> <span class="o">=</span> <span class="n">ContributorData</span><span class="p">(</span><span class="n">sort_name</span><span class="o">=</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">)</span>
                        <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;narrators&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="n">narrators</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;narrators&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">narrator</span> <span class="ow">in</span> <span class="n">narrators</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
                    <span class="n">sort_name</span> <span class="o">=</span> <span class="n">narrator</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sort_name</span><span class="p">:</span>
                        <span class="n">sort_name</span> <span class="o">=</span> <span class="n">name_tidy</span><span class="p">(</span><span class="n">sort_name</span><span class="p">)</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="n">sort_name_to_display_name</span><span class="p">(</span><span class="n">sort_name</span><span class="p">)</span>
                        <span class="n">roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Contributor</span><span class="o">.</span><span class="n">NARRATOR_ROLE</span><span class="p">]</span>
                        <span class="n">contributor</span> <span class="o">=</span> <span class="n">ContributorData</span><span class="p">(</span><span class="n">sort_name</span><span class="o">=</span><span class="n">sort_name</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">)</span>
                        <span class="n">contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>

            <span class="n">trusted_weight</span> <span class="o">=</span> <span class="n">Classification</span><span class="o">.</span><span class="n">TRUSTED_DISTRIBUTOR_WEIGHT</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;genres&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="c1"># example: &quot;FICTION / Humorous / General&quot;</span>
                <span class="n">genres</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">]</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="n">SubjectData</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">BISAC</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">genres</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">trusted_weight</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;primaryGenre&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="c1"># example: &quot;humorous-fiction,mystery,womens-fiction&quot;</span>
                <span class="n">genres</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;primaryGenre&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">subject</span> <span class="o">=</span> <span class="n">SubjectData</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">RBDIGITAL</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">genre</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                        <span class="n">weight</span><span class="o">=</span><span class="n">trusted_weight</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

            <span class="c1"># audience options are: adult, beginning-reader, childrens, young-adult</span>
            <span class="c1"># NOTE: In RBDigital metadata, audience can be set to &quot;Adult&quot; while publisher is &quot;HarperTeen&quot;.</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;audience&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">audience</span><span class="p">:</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="n">SubjectData</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">Subject</span><span class="o">.</span><span class="n">RBDIGITAL_AUDIENCE</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">audience</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">trusted_weight</span>
                <span class="p">)</span>
                <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

            <span class="c1"># passed to metadata.apply, the isbn_identifier will create an equivalency</span>
            <span class="c1"># between the RBDigital-labeled and the ISBN-labeled identifier rows, which</span>
            <span class="c1"># will in turn allow us to ask the MetadataWrangler for more info about the book.</span>
            <span class="n">isbn_identifier</span> <span class="o">=</span> <span class="n">IdentifierData</span><span class="p">(</span><span class="n">Identifier</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">rbdigital_id</span><span class="p">)</span>

            <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_identifier</span><span class="p">,</span> <span class="n">isbn_identifier</span><span class="p">]</span>

            <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># A cover and its thumbnail become a single LinkData.</span>
            <span class="c1"># images come in small (ex: 71x108px), medium (ex: 95x140px),</span>
            <span class="c1"># and large (ex: 128x192px) sizes</span>
            <span class="k">if</span> <span class="s1">&#39;images&#39;</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span>
                        <span class="n">image_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">image_link_to_linkdata</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
                        <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">image_link_to_linkdata</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">:</span>
                        <span class="n">thumbnail_data_backup</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">image_link_to_linkdata</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">thumbnail_data</span> <span class="ow">and</span> <span class="n">thumbnail_data_backup</span><span class="p">:</span>
                    <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">thumbnail_data_backup</span>

                <span class="k">if</span> <span class="n">image_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">thumbnail_data</span><span class="p">:</span>
                        <span class="n">image_data</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">thumbnail_data</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>


            <span class="c1"># Descriptions become links.</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">LinkData</span><span class="p">(</span>
                        <span class="c1"># there can be fuller descriptions in the search endpoint output</span>
                        <span class="n">rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">SHORT_DESCRIPTION</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">metadata</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series_name</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">series_position</span> <span class="o">=</span> <span class="n">series_position</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">published</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">subjects</span> <span class="o">=</span> <span class="n">subjects</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">contributors</span> <span class="o">=</span> <span class="n">contributors</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>

        <span class="k">if</span> <span class="n">include_formats</span><span class="p">:</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">BOOK_MEDIUM</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">EPUB_MEDIA_TYPE</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">ADOBE_DRM</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FormatData</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">metadata</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="n">Edition</span><span class="o">.</span><span class="n">AUDIO_MEDIUM</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="n">Representation</span><span class="o">.</span><span class="n">AUDIOBOOK_MANIFEST_MEDIA_TYPE</span><span class="p">,</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FormatData</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unfamiliar format: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>

            <span class="c1"># Make a CirculationData so we can write the formats,</span>
            <span class="n">circulationdata</span> <span class="o">=</span> <span class="n">CirculationData</span><span class="p">(</span>
                <span class="n">data_source</span><span class="o">=</span><span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">,</span>
                <span class="n">primary_identifier</span><span class="o">=</span><span class="n">primary_identifier</span><span class="p">,</span>
                <span class="n">formats</span><span class="o">=</span><span class="n">formats</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">metadata</span><span class="o">.</span><span class="n">circulation</span> <span class="o">=</span> <span class="n">circulationdata</span>

        <span class="k">return</span> <span class="n">metadata</span></div></div>

<div class="viewcode-block" id="RBDigitalBibliographicCoverageProvider"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalBibliographicCoverageProvider">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalBibliographicCoverageProvider</span><span class="p">(</span><span class="n">BibliographicCoverageProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill in bibliographic metadata for RBDigital records.&quot;&quot;&quot;</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;RBDigital Bibliographic Coverage Provider&quot;</span>
    <span class="n">DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span>
    <span class="n">INPUT_IDENTIFIER_TYPES</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">RB_DIGITAL_ID</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">RBDigitalAPI</span><span class="p">,</span> <span class="n">api_class_kwargs</span><span class="o">=</span><span class="p">{},</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :param collection: Provide bibliographic coverage to all</span>
<span class="sd">            RBDigital books in the given Collection.</span>
<span class="sd">        :param api_class: Instantiate this class with the given Collection,</span>
<span class="sd">            rather than instantiating RBDigitalAPI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RBDigitalBibliographicCoverageProvider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">RBDigitalAPI</span><span class="p">):</span>
            <span class="c1"># We were passed in a specific API object. This is not</span>
            <span class="c1"># generally the done thing, but it is necessary when a</span>
            <span class="c1"># RBDigitalAPI object itself wants a</span>
            <span class="c1"># RBDigitalBibliographicCoverageProvider.</span>
            <span class="k">if</span> <span class="n">api_class</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">!=</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Coverage provider and its API are scoped to different collections! (</span><span class="si">%s</span><span class="s2"> vs. </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">api_class</span><span class="o">.</span><span class="n">collection_id</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A web application should not use this option because it</span>
            <span class="c1"># will put a non-scoped session in the mix.</span>
            <span class="n">_db</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">api_class_kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="RBDigitalBibliographicCoverageProvider.process_item"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalBibliographicCoverageProvider.process_item">[docs]</a>    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; RBDigital availability information is served separately from</span>
<span class="sd">        the book&#39;s metadata.  Furthermore, the metadata returned by the</span>
<span class="sd">        &quot;book by isbn&quot; request is less comprehensive than the data returned</span>
<span class="sd">        by the &quot;search titles/genres/etc.&quot; endpoint.</span>

<span class="sd">        This method hits the &quot;by isbn&quot; endpoint and updates the bibliographic</span>
<span class="sd">        metadata returned by it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_metadata_by_isbn</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadResponseException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response_dictionary</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Cannot find RBDigital metadata for </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="n">response_dictionary</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
            <span class="c1"># calls work.set_presentation_ready() for us</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_success</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="RBDigitalBibliographicCoverageProvider.update_metadata"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalBibliographicCoverageProvider.update_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog_item</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates db objects corresponding to the book info passed in.</span>

<span class="sd">        Note: It is expected that CoverageProvider.handle_success, which is responsible for</span>
<span class="sd">        setting the work to be presentation-ready is handled in the calling code.</span>

<span class="sd">        :catalog_item - JSON representation of the book&#39;s metadata, coming from RBDigital.</span>
<span class="sd">        :return CoverageFailure or a database object (Work, Identifier, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">RBDigitalRepresentationExtractor</span><span class="o">.</span><span class="n">isbn_info_to_metadata</span><span class="p">(</span><span class="n">catalog_item</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="c1"># generate a CoverageFailure to let the system know to revisit this book</span>
            <span class="c1"># TODO:  if did not create a Work, but have a CoverageFailure for the isbn,</span>
            <span class="c1"># check that re-processing that coverage would generate the work.</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Could not extract metadata from RBDigital data: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">catalog_item</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># convert IdentifierData into Identifier, if can</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">made_new</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_identifier</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Could not create identifier for RBDigital data: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">catalog_item</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="RBDigitalSyncMonitor"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalSyncMonitor">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalSyncMonitor</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">):</span>

    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">RBDigitalAPI</span><span class="p">,</span>
                 <span class="n">api_class_kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RBDigitalSyncMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_class</span><span class="p">,</span> <span class="n">RBDigitalAPI</span><span class="p">):</span>
            <span class="n">api_class</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">api_class_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span>

<div class="viewcode-block" id="RBDigitalSyncMonitor.run_once"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalSyncMonitor.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find books in the RBdigital collection that changed recently.</span>

<span class="sd">        :param progress: A TimestampData, ignored.</span>
<span class="sd">        :return: A TimestampData describing what was accomplished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">achievements</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Records received from vendor: </span><span class="si">%d</span><span class="s2">. Records written to database: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">items_transmitted</span><span class="p">,</span> <span class="n">items_created</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">achievements</span><span class="p">)</span></div>

<div class="viewcode-block" id="RBDigitalSyncMonitor.invoke"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalSyncMonitor.invoke">[docs]</a>    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="RBDigitalImportMonitor"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalImportMonitor</span><span class="p">(</span><span class="n">RBDigitalSyncMonitor</span><span class="p">):</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;RBDigital Full Import&quot;</span>

<div class="viewcode-block" id="RBDigitalImportMonitor.invoke"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalImportMonitor.invoke">[docs]</a>    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="ow">and</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Collection </span><span class="si">%s</span><span class="s2"> has already had its initial import; doing nothing.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">populate_all_catalog</span><span class="p">()</span>

        <span class="c1"># Record the work was done so it&#39;s not done again.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span><span class="p">:</span>
            <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timestamp</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span></div></div>

<div class="viewcode-block" id="RBDigitalDeltaMonitor"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalDeltaMonitor">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalDeltaMonitor</span><span class="p">(</span><span class="n">RBDigitalSyncMonitor</span><span class="p">):</span>

    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;RBDigital Delta Sync&quot;</span>

<div class="viewcode-block" id="RBDigitalDeltaMonitor.invoke"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalDeltaMonitor.invoke">[docs]</a>    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">populate_delta</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="RBDigitalCirculationMonitor"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalCirculationMonitor">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalCirculationMonitor</span><span class="p">(</span><span class="n">CollectionMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maintain LicensePools for RBDigital titles.</span>

<span class="sd">    Bibliographic data isn&#39;t inserted into new LicensePools until</span>
<span class="sd">    we hear from the metadata wrangler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s2">&quot;RBDigital CirculationMonitor&quot;</span>
    <span class="n">DEFAULT_START_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">DEFAULT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">RB_DIGITAL</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="n">RBDigitalAPI</span><span class="p">,</span>
                 <span class="n">api_class_kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RBDigitalCirculationMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BATCH_SIZE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">api_class_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibliographic_coverage_provider</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">RBDigitalBibliographicCoverageProvider</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span> <span class="o">=</span> <span class="n">Analytics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="RBDigitalCirculationMonitor.process_availability"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalCirculationMonitor.process_availability">[docs]</a>    <span class="k">def</span> <span class="nf">process_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;eBook&#39;</span><span class="p">):</span>
        <span class="c1"># get list of all titles, with availability info</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">default_circulation_replacement_policy</span>
        <span class="n">availability_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_ebook_availability_info</span><span class="p">(</span><span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">)</span>
        <span class="n">item_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">availability</span> <span class="ow">in</span> <span class="n">availability_list</span><span class="p">:</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="n">availability</span><span class="p">[</span><span class="s1">&#39;isbn&#39;</span><span class="p">]</span>
            <span class="c1"># boolean True/False value, not number of licenses</span>
            <span class="n">available</span> <span class="o">=</span> <span class="n">availability</span><span class="p">[</span><span class="s1">&#39;availability&#39;</span><span class="p">]</span>

            <span class="n">medium</span> <span class="o">=</span> <span class="n">availability</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mediaType&#39;</span><span class="p">)</span>
            <span class="n">license_pool</span><span class="p">,</span> <span class="n">is_new</span><span class="p">,</span> <span class="n">is_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">update_licensepool_for_identifier</span><span class="p">(</span>
                <span class="n">isbn</span><span class="p">,</span> <span class="n">available</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">policy</span>
            <span class="p">)</span>
            <span class="c1"># Log a circulation event for this work.</span>
            <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">libraries</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="o">.</span><span class="n">collect_event</span><span class="p">(</span>
                        <span class="n">library</span><span class="p">,</span> <span class="n">license_pool</span><span class="p">,</span> <span class="n">CirculationEvent</span><span class="o">.</span><span class="n">DISTRIBUTOR_TITLE_ADD</span><span class="p">,</span> <span class="n">license_pool</span><span class="o">.</span><span class="n">last_checked</span><span class="p">)</span>

            <span class="n">item_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">item_count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">item_count</span></div>

<div class="viewcode-block" id="RBDigitalCirculationMonitor.run_once"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalCirculationMonitor.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the availability information of all titles in the</span>
<span class="sd">        RBdigital collection.</span>

<span class="sd">        :param progress: A TimestampData, ignored.</span>
<span class="sd">        :return: A TimestampData describing what was accomplished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebook_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_availability</span><span class="p">(</span><span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;eBook&#39;</span><span class="p">)</span>
        <span class="n">eaudio_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_availability</span><span class="p">(</span><span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;eAudio&#39;</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Ebooks processed: </span><span class="si">%d</span><span class="s2">. Audiobooks processed: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ebook_count</span><span class="p">,</span> <span class="n">eaudio_count</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="AudiobookManifest"><a class="viewcode-back" href="../../api.html#api.rbdigital.AudiobookManifest">[docs]</a><span class="k">class</span> <span class="nc">AudiobookManifest</span><span class="p">(</span><span class="n">CoreAudiobookManifest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A standard AudiobookManifest derived from an RBdigital audiobook</span>
<span class="sd">    manifest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Information not used because it&#39;s redundant or not useful.</span>
    <span class="c1"># &quot;bookmarks&quot;: [],</span>
    <span class="c1"># &quot;hasBookmark&quot;: false,</span>
    <span class="c1"># &quot;mediaType&quot;: &quot;eAudio&quot;,</span>
    <span class="c1"># &quot;dateAdded&quot;: &quot;2011-03-28&quot;,</span>

    <span class="c1"># Information not used because it&#39;s loan-specific</span>
    <span class="c1"># &quot;expiration&quot;: &quot;2017-11-15&quot;,</span>
    <span class="c1"># &quot;canRenew&quot;: true,</span>
    <span class="c1"># &quot;transactionId&quot;: 101,</span>
    <span class="c1"># &quot;patronId&quot;: 111,</span>
    <span class="c1"># &quot;libraryId&quot;: 222</span>

    <span class="c1"># RBdigital audiobook manifests contain links to JSON documents</span>
    <span class="c1"># that contain links to MP3 files. This is a media type we</span>
    <span class="c1"># invented for these hypermedia documents, so that a client</span>
    <span class="c1"># examining a manifest can distinguish them from random JSON</span>
    <span class="c1"># files.</span>
    <span class="c1">#</span>
    <span class="c1"># Internally to the circulation manager, these documents can be processed</span>
    <span class="c1"># with RBFulfillmentInfo.process_access_document.</span>
    <span class="n">INTERMEDIATE_LINK_MEDIA_TYPE</span> <span class="o">=</span> <span class="s2">&quot;vnd.librarysimplified/rbdigital-access-document+json&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_dict</span><span class="p">,</span> <span class="n">fulfill_part_url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an audiobook manifest from the information provided</span>
<span class="sd">        by RBdigital.</span>

<span class="sd">        :param content_dict: A dictionary of data from RBdigital.</span>
<span class="sd">        :param fulfill_part_url: A function that takes a part number</span>
<span class="sd">            and returns a URL for fulfilling that part number on this</span>
<span class="sd">            circulation manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AudiobookManifest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">content_dict</span>

        <span class="c1"># Metadata values that map directly onto the core spec.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;isbn&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;narrators&#39;</span><span class="p">,</span> <span class="s1">&#39;narrator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Metadata values that have no equivalent in the core spec,</span>
        <span class="c1"># but are potentially useful.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;schema:contentSize&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;titleid&#39;</span><span class="p">,</span> <span class="s1">&#39;rbdigital:id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;hasDrm&#39;</span><span class="p">,</span> <span class="s1">&#39;rbdigital:hasDrm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_metadata</span><span class="p">(</span><span class="s1">&#39;encryptionKey&#39;</span><span class="p">,</span> <span class="s1">&#39;rbdigital:encryptionKey&#39;</span><span class="p">)</span>

        <span class="c1"># Spine items.</span>
        <span class="k">for</span> <span class="n">part_number</span><span class="p">,</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">proxy_url</span> <span class="o">=</span> <span class="n">fulfill_part_url</span><span class="p">(</span><span class="n">part_number</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_spine</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">proxy_url</span><span class="p">)</span>

        <span class="c1"># Links.</span>
        <span class="n">download_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;downloadUrl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">download_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="n">download_url</span><span class="p">,</span> <span class="s1">&#39;alternate&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">guess_url_media_type_from_path</span><span class="p">(</span><span class="n">download_url</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_cover</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">cover</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="n">cover</span><span class="p">,</span> <span class="s2">&quot;cover&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Representation</span><span class="o">.</span><span class="n">guess_url_media_type_from_path</span><span class="p">(</span><span class="n">cover</span><span class="p">)</span>
            <span class="p">)</span>

<div class="viewcode-block" id="AudiobookManifest.best_cover"><a class="viewcode-back" href="../../api.html#api.rbdigital.AudiobookManifest.best_cover">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">best_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">images</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Find the largest image that&#39;s large enough to use as a</span>
        <span class="c1"># cover.</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xx-large&#39;</span><span class="p">,</span> <span class="s1">&#39;x-large&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">]</span>
        <span class="n">images_by_size</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">href</span> <span class="ow">and</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
                <span class="n">images_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">href</span>

        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">images_by_size</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">images_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">]</span></div>

<div class="viewcode-block" id="AudiobookManifest.import_metadata"><a class="viewcode-back" href="../../api.html#api.rbdigital.AudiobookManifest.import_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">import_metadata</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">rbdigital_field</span><span class="p">,</span> <span class="n">standard_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map a field in an RBdigital manifest to the corresponding</span>
<span class="sd">        standard manifest field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">standard_field</span> <span class="o">=</span> <span class="n">standard_field</span> <span class="ow">or</span> <span class="n">rbdigital_field</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rbdigital_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">standard_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="AudiobookManifest.import_spine"><a class="viewcode-back" href="../../api.html#api.rbdigital.AudiobookManifest.import_spine">[docs]</a>    <span class="k">def</span> <span class="nf">import_spine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">proxy_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import an RBdigital spine item as a Web Publication Manifest</span>
<span class="sd">        spine item.</span>

<span class="sd">        :param file_data: A dictionary of information about this spine</span>
<span class="sd">            item, obtained from RBdigital.</span>

<span class="sd">        :param proxy_url: A URL generated by the circulation manager</span>
<span class="sd">            (as opposed to being generated by RBdigital) for fulfilling this</span>
<span class="sd">            spine item as an audio file (as opposed to a JSON document that</span>
<span class="sd">            links to an audio file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;downloadUrl&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERMEDIATE_LINK_MEDIA_TYPE</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extra</span><span class="p">[</span><span class="s1">&#39;proxy_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">href</span><span class="o">=</span><span class="n">proxy_url</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">transform</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;rbdigital:id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;schema:contentSize&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">60</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="n">extra</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_reading_order</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RBDProxyException"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDProxyException">[docs]</a><span class="k">class</span> <span class="nc">RBDProxyException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="RBDigitalFulfillmentProxy"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalFulfillmentProxy">[docs]</a><span class="k">class</span> <span class="nc">RBDigitalFulfillmentProxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">for_part</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patron</span> <span class="o">=</span> <span class="n">patron</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="n">for_part</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_proxy_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If no `part` was specified, then we&#39;re returning a full manifest</span>
        <span class="c1"># and should rewrite the links to use the proxy service.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span>

<div class="viewcode-block" id="RBDigitalFulfillmentProxy.proxy"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalFulfillmentProxy.proxy">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_db</span><span class="p">,</span> <span class="n">bearer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># This method supports retrieval of resources that (a) require</span>
        <span class="c1"># a patron bearer token for fulfillment and (b) cannot be</span>
        <span class="c1"># fulfilled in a request authenticated by the usual patron</span>
        <span class="c1"># credentials.</span>
        <span class="c1">#</span>
        <span class="c1"># The overall flow is as follows, given a URL and a bearer token:</span>
        <span class="c1"># - Look up the `Credential` for the bearer token. If it does not</span>
        <span class="c1">#   exist or is expired, then return 403 Forbidden.</span>
        <span class="c1"># - We use the credential&#39;s `Collection` to create an instance of</span>
        <span class="c1">#   `RBDigitalAPI`, which we use to fulfill the request.</span>

        <span class="n">api_class</span> <span class="o">=</span> <span class="n">api_class</span> <span class="ow">or</span> <span class="n">RBDigitalAPI</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RBDProxyException</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No proxy URL was supplied.&quot;</span><span class="p">))</span>

        <span class="c1"># If we the bearer token is cached and unexpired, then we&#39;ll allow it.</span>
        <span class="n">credential_type</span> <span class="o">=</span> <span class="n">api_class</span><span class="o">.</span><span class="n">CREDENTIAL_TYPES</span><span class="p">[</span><span class="n">api_class</span><span class="o">.</span><span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">RB_DIGITAL</span><span class="p">)</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">api_class</span><span class="o">.</span><span class="n">get_credential_by_token</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">credential_type</span><span class="p">,</span> <span class="n">bearer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">credential</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RBDProxyException</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Token not found or expired.&quot;</span><span class="p">))</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">api_class</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">credential</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="c1"># We don&#39;t want someone who sniffed this bearer token to be able</span>
        <span class="c1"># to generate another one, which could cause DOS to patron.</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_add_api_base_url</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">patron_fulfillment_request</span><span class="p">(</span><span class="n">credential</span><span class="o">.</span><span class="n">patron</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">reauthorize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span></div>

    <span class="c1"># The `_remove_api_base_url` and `_add_api_base_url` methods are used</span>
    <span class="c1"># in the construction and fulfillment of proxy URLs, respectively. They</span>
    <span class="c1"># are used to increase security in two ways:</span>
    <span class="c1"># - There is not enough context in the proxy URLs to fullfill content</span>
    <span class="c1">#   outside of this system.</span>
    <span class="c1"># - If an arbitrary URL is submitted to the service, it will have the</span>
    <span class="c1">#   API base URL prepended to it, rendering it useless, in practice.</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_remove_api_base_url</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c1"># Strip off the API&#39;s base URL, if present. Otherwise, do nothing.</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">PRODUCTION_BASE_URL</span>
        <span class="n">prefix_matches</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix_matches</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
        <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">prefix_matches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_api_base_url</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c1"># Add the API&#39;s base URL to this one, no matter what.</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">PRODUCTION_BASE_URL</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

<div class="viewcode-block" id="RBDigitalFulfillmentProxy.make_request"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalFulfillmentProxy.make_request">[docs]</a>    <span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">patron_fulfillment_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_proxy_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="c1"># Transform a fulfillment URL to its proxy form</span>
        <span class="n">url_components</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/rbdproxy/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_components</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">((</span>
            <span class="n">url_components</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span>
            <span class="n">url_components</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
            <span class="n">new_path</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">url_components</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
            <span class="n">url_components</span><span class="o">.</span><span class="n">fragment</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">_rewrite_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="c1"># Replace each part&#39;s base properties with those</span>
        <span class="c1"># from its own `proxy_link` dictionary.</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PreparedRequest</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">use_proxy</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
            <span class="c1"># We&#39;ll only do the replacement if the true download URL is</span>
            <span class="c1"># served by RBdigital and we have a proxy url.</span>
            <span class="n">downloadUrl</span><span class="p">,</span> <span class="n">is_api_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_api_base_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">is_api_link</span> <span class="ow">and</span> <span class="s1">&#39;proxy_link&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">proxy_link</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;proxy_link&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;href&#39;</span> <span class="ow">in</span> <span class="n">proxy_link</span><span class="p">:</span>
                    <span class="n">proxy_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_proxy_url</span><span class="p">(</span><span class="n">proxy_link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">],</span> <span class="n">token</span><span class="p">)</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">downloadUrl</span><span class="p">}</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">prepare_url</span><span class="p">(</span><span class="n">proxy_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="n">proxy_link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span>
                <span class="n">part</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proxy_link</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">part</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">as_dict</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;readingOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">use_proxy</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;readingOrder&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="RBDigitalFulfillmentProxy.proxied_manifest"><a class="viewcode-back" href="../../api.html#api.rbdigital.RBDigitalFulfillmentProxy.proxied_manifest">[docs]</a>    <span class="k">def</span> <span class="nf">proxied_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
        <span class="c1"># Ensure that we have a token with enough time to allow</span>
        <span class="c1"># upcoming proxy requests to be completed.</span>
        <span class="n">proxy_expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">PROXY_BEARER_GRACE_PERIOD</span><span class="p">))</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">_patron_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">BEARER_TOKEN_PROPERTY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">credential</span> <span class="k">if</span> <span class="n">credential</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="n">credential</span><span class="o">.</span><span class="n">expires</span> <span class="o">&lt;</span> <span class="n">proxy_expires</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">reauthorize_patron_bearer_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patron</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CirculationException</span><span class="p">(</span><span class="s2">&quot;Unable to refresh patron bearer token.&quot;</span><span class="p">)</span>

        <span class="c1"># Transform manifest links for proxying</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manifest</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>