
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>api.proquest.importer &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.proquest.importer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">core.util.webpub_manifest_parser.opds2.ast</span> <span class="k">as</span> <span class="nn">opds2_ast</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">core.util.webpub_manifest_parser.utils</span> <span class="kn">import</span> <span class="n">encode</span>

<span class="kn">from</span> <span class="nn">api.circulation</span> <span class="kn">import</span> <span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">FulfillmentInfo</span><span class="p">,</span> <span class="n">LoanInfo</span>
<span class="kn">from</span> <span class="nn">api.circulation_exceptions</span> <span class="kn">import</span> <span class="n">CannotFulfill</span><span class="p">,</span> <span class="n">CannotLoan</span>
<span class="kn">from</span> <span class="nn">api.proquest.client</span> <span class="kn">import</span> <span class="n">ProQuestAPIClientConfiguration</span><span class="p">,</span> <span class="n">ProQuestAPIClientFactory</span>
<span class="kn">from</span> <span class="nn">api.proquest.credential</span> <span class="kn">import</span> <span class="n">ProQuestCredentialManager</span>
<span class="kn">from</span> <span class="nn">api.proquest.identifier</span> <span class="kn">import</span> <span class="n">ProQuestIdentifierParser</span>
<span class="kn">from</span> <span class="nn">api.saml.metadata.model</span> <span class="kn">import</span> <span class="n">SAMLAttributeType</span>
<span class="kn">from</span> <span class="nn">core.classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">core.exceptions</span> <span class="kn">import</span> <span class="n">BaseError</span>
<span class="kn">from</span> <span class="nn">core.metadata_layer</span> <span class="kn">import</span> <span class="n">TimestampData</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">DeliveryMechanism</span><span class="p">,</span>
    <span class="n">Hyperlink</span><span class="p">,</span>
    <span class="n">Identifier</span><span class="p">,</span>
    <span class="n">LicensePool</span><span class="p">,</span>
    <span class="n">Loan</span><span class="p">,</span>
    <span class="n">MediaTypes</span><span class="p">,</span>
    <span class="n">get_one</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.model.configuration</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConfigurationAttributeType</span><span class="p">,</span>
    <span class="n">ConfigurationFactory</span><span class="p">,</span>
    <span class="n">ConfigurationGrouping</span><span class="p">,</span>
    <span class="n">ConfigurationMetadata</span><span class="p">,</span>
    <span class="n">ConfigurationOption</span><span class="p">,</span>
    <span class="n">ConfigurationStorage</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">HasExternalIntegration</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.opds2_import</span> <span class="kn">import</span> <span class="n">OPDS2Importer</span><span class="p">,</span> <span class="n">OPDS2ImportMonitor</span><span class="p">,</span> <span class="n">parse_feed</span>
<span class="kn">from</span> <span class="nn">core.opds_import</span> <span class="kn">import</span> <span class="n">OPDSImporter</span>

<span class="n">MISSING_AFFILIATION_ID</span> <span class="o">=</span> <span class="n">BaseError</span><span class="p">(</span>
    <span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Patron does not have a SAML affiliation ID. &quot;</span>
        <span class="s2">&quot;It can mean either incorrect configuration of a SAML authentication provider or &quot;</span>
        <span class="s2">&quot;that patron has not yet been authenticated using the SAML authentication provider.&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="parse_identifier"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.parse_identifier">[docs]</a><span class="k">def</span> <span class="nf">parse_identifier</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the identifier and return an Identifier object representing it.</span>

<span class="sd">    :param db: Database session</span>
<span class="sd">    :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">    :param identifier: String containing the identifier</span>
<span class="sd">    :type identifier: str</span>

<span class="sd">    :return: Identifier object</span>
<span class="sd">    :rtype: core.model.identifier.Identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">identifier</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">ProQuestIdentifierParser</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">identifier</span></div>


<div class="viewcode-block" id="CannotCreateProQuestTokenError"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.CannotCreateProQuestTokenError">[docs]</a><span class="k">class</span> <span class="nc">CannotCreateProQuestTokenError</span><span class="p">(</span><span class="n">BaseError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner_exception</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Can not create a ProQuest JWT bearer token&quot;</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">inner_exception</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CannotCreateProQuestTokenError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">inner_exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProQuestOPDS2ImporterConfiguration"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2ImporterConfiguration">[docs]</a><span class="k">class</span> <span class="nc">ProQuestOPDS2ImporterConfiguration</span><span class="p">(</span><span class="n">ConfigurationGrouping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains configuration settings of ProQuestOPDS2Importer.&quot;&quot;&quot;</span>

    <span class="n">DEFAULT_TOKEN_EXPIRATION_TIMEOUT_SECONDS</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="n">TEST_AFFILIATION_ID</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DEFAULT_AFFILIATION_ATTRIBUTES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">SAMLAttributeType</span><span class="o">.</span><span class="n">eduPersonPrincipalName</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">SAMLAttributeType</span><span class="o">.</span><span class="n">eduPersonScopedAffiliation</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">data_source_name</span> <span class="o">=</span> <span class="n">ConfigurationMetadata</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="n">Collection</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_SETTING</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Data source name&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Name of the data source associated with this collection.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ConfigurationAttributeType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ProQuest&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">token_expiration_timeout</span> <span class="o">=</span> <span class="n">ConfigurationMetadata</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;token_expiration_timeout&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;ProQuest JWT token&#39;s expiration timeout&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Determines how long in seconds can a ProQuest JWT token be valid.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ConfigurationAttributeType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TOKEN_EXPIRATION_TIMEOUT_SECONDS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">affiliation_attributes</span> <span class="o">=</span> <span class="n">ConfigurationMetadata</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;affiliation_attributes&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;List of SAML attributes containing an affiliation ID&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;ProQuest integration assumes that the SAML provider is used for authentication. &quot;</span>
            <span class="s2">&quot;ProQuest JWT bearer tokens required by the most ProQuest API services &quot;</span>
            <span class="s2">&quot;are created based on the affiliation ID - SAML attribute uniquely identifying the patron.&quot;</span>
            <span class="s2">&quot;This setting determines what attributes the ProQuest integration will use to look for affiliation IDs. &quot;</span>
            <span class="s2">&quot;The ProQuest integration will investigate the specified attributes sequentially &quot;</span>
            <span class="s2">&quot;and will take the first non-empty value.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ConfigurationAttributeType</span><span class="o">.</span><span class="n">MENU</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_AFFILIATION_ATTRIBUTES</span><span class="p">),</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ConfigurationOption</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">SAMLAttributeType</span>
        <span class="p">],</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;narrow&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">test_affiliation_id</span> <span class="o">=</span> <span class="n">ConfigurationMetadata</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test_affiliation_id&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Test SAML affiliation ID&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Test SAML affiliation ID used for testing ProQuest API. &quot;</span>
            <span class="s2">&quot;Please contact ProQuest before using it.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ConfigurationAttributeType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default_audience</span> <span class="o">=</span> <span class="n">ConfigurationMetadata</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="n">Collection</span><span class="o">.</span><span class="n">DEFAULT_AUDIENCE_KEY</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Default audience&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;If ProQuest does not specify the target audience for their books, &quot;</span>
            <span class="s2">&quot;assume the books have this target audience.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ConfigurationAttributeType</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">OPDSImporter</span><span class="o">.</span><span class="n">NO_DEFAULT_AUDIENCE</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ConfigurationOption</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">OPDSImporter</span><span class="o">.</span><span class="n">NO_DEFAULT_AUDIENCE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No default audience&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="o">+</span> <span class="p">[</span>
            <span class="n">ConfigurationOption</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">audience</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">audience</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Classifier</span><span class="o">.</span><span class="n">AUDIENCES</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;narrow&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ProQuestOPDS2Importer"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer">[docs]</a><span class="k">class</span> <span class="nc">ProQuestOPDS2Importer</span><span class="p">(</span><span class="n">OPDS2Importer</span><span class="p">,</span> <span class="n">BaseCirculationAPI</span><span class="p">,</span> <span class="n">HasExternalIntegration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allows to import ProQuest OPDS 2.0 feeds into Circulation Manager.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PROQUEST</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Import books from a ProQuest OPDS 2.0 feed.&quot;</span><span class="p">)</span>
    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ProQuestOPDS2ImporterConfiguration</span><span class="o">.</span><span class="n">to_settings</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">ProQuestAPIClientConfiguration</span><span class="o">.</span><span class="n">to_settings</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">BaseCirculationAPI</span><span class="o">.</span><span class="n">DEFAULT_LOAN_DURATION_SETTING</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db</span><span class="p">,</span>
        <span class="n">collection</span><span class="p">,</span>
        <span class="n">data_source_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">identifier_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">http_get</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">content_modifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">map_from_collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new instance of ProQuestOPDS2Importer class.</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :param collection: Circulation Manager&#39;s collection.</span>
<span class="sd">            LicensePools created by this OPDS2Import class will be associated with the given Collection.</span>
<span class="sd">            If this is None, no LicensePools will be created -- only Editions.</span>
<span class="sd">        :type collection: Collection</span>

<span class="sd">        :param data_source_name: Name of the source of this OPDS feed.</span>
<span class="sd">            All Editions created by this import will be associated with this DataSource.</span>
<span class="sd">            If there is no DataSource with this name, one will be created.</span>
<span class="sd">            NOTE: If `collection` is provided, its .data_source will take precedence over any value provided here.</span>
<span class="sd">            This is only for use when you are importing OPDS metadata without any particular Collection in mind.</span>
<span class="sd">        :type data_source_name: str</span>

<span class="sd">        :param identifier_mapping: Dictionary used for mapping external identifiers into a set of internal ones</span>
<span class="sd">        :type identifier_mapping: Dict</span>

<span class="sd">        :param metadata_client: A SimplifiedOPDSLookup object that is used to fill in missing metadata</span>
<span class="sd">        :type metadata_client: SimplifiedOPDSLookup</span>

<span class="sd">        :param content_modifier: A function that may modify-in-place representations (such as images and EPUB documents)</span>
<span class="sd">            as they come in from the network.</span>
<span class="sd">        :type content_modifier: Callable</span>

<span class="sd">        :param map_from_collection: Identifier mapping</span>
<span class="sd">        :type map_from_collection: Dict</span>

<span class="sd">        :param mirrors: A dictionary of different MirrorUploader objects for different purposes</span>
<span class="sd">        :type mirrors: Dict[MirrorUploader]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProQuestOPDS2Importer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">db</span><span class="p">,</span>
            <span class="n">collection</span><span class="p">,</span>
            <span class="n">data_source_name</span><span class="p">,</span>
            <span class="n">identifier_mapping</span><span class="p">,</span>
            <span class="n">http_get</span><span class="p">,</span>
            <span class="n">metadata_client</span><span class="p">,</span>
            <span class="n">content_modifier</span><span class="p">,</span>
            <span class="n">map_from_collection</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration_storage</span> <span class="o">=</span> <span class="n">ConfigurationStorage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration_factory</span> <span class="o">=</span> <span class="n">ConfigurationFactory</span><span class="p">()</span>

        <span class="n">factory</span> <span class="o">=</span> <span class="n">ProQuestAPIClientFactory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api_client</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_credential_manager</span> <span class="o">=</span> <span class="n">ProQuestCredentialManager</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_get_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the configuration object.</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :return: Configuration object</span>
<span class="sd">        :rtype: ProQuestOPDS2ImporterConfiguration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configuration_factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configuration_storage</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">ProQuestOPDS2ImporterConfiguration</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">configuration</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">configuration</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_affiliation_attributes</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a configured list of SAML attributes which can contain affiliation ID.</span>

<span class="sd">        :param configuration: Configuration object</span>
<span class="sd">        :type configuration: ProQuestOPDS2ImporterConfiguration</span>

<span class="sd">        :return: Configured list of SAML attributes which can contain affiliation ID</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">affiliation_attributes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ProQuestOPDS2ImporterConfiguration</span><span class="o">.</span><span class="n">DEFAULT_AFFILIATION_ATTRIBUTES</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">affiliation_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">affiliation_attributes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">affiliation_attributes</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">affiliation_attributes</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">affiliation_attributes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">affiliation_attributes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">affiliation_attributes</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Configuration setting &#39;affiliation_attributes&#39; has an incorrect format&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">affiliation_attributes</span>

    <span class="k">def</span> <span class="nf">_get_patron_affiliation_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a patron&#39;s affiliation ID.</span>

<span class="sd">        :param patron: Patron object</span>
<span class="sd">        :type patron: core.model.patron.Patron</span>

<span class="sd">        :param configuration: Configuration object</span>
<span class="sd">        :type configuration: ProQuestOPDS2ImporterConfiguration</span>

<span class="sd">        :return: Patron&#39;s affiliation ID</span>
<span class="sd">        :rtype: Optional[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">affiliation_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_affiliation_attributes</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">affiliation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_credential_manager</span><span class="o">.</span><span class="n">lookup_patron_affiliation_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">affiliation_attributes</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Patron </span><span class="si">{0}</span><span class="s2"> has the following SAML affiliation ID: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">patron</span><span class="p">,</span> <span class="n">affiliation_id</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">affiliation_id</span><span class="p">:</span>
            <span class="n">affiliation_id</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">test_affiliation_id</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">affiliation_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Patron </span><span class="si">{0}</span><span class="s2"> does not have neither real affiliation ID &quot;</span>
                    <span class="s2">&quot;nor test affiliation ID set up as a configuration setting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">patron</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">MISSING_AFFILIATION_ID</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Since patron doesn&#39;t have an affiliation ID we set it to the test one: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">patron</span><span class="p">,</span> <span class="n">affiliation_id</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">affiliation_id</span>

    <span class="k">def</span> <span class="nf">_create_proquest_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new ProQuest JWT bearer token.</span>

<span class="sd">        :param patron: Patron object</span>
<span class="sd">        :type patron: core.model.patron.Patron</span>

<span class="sd">        :param configuration: Configuration object</span>
<span class="sd">        :type configuration: ProQuestOPDS2ImporterConfiguration</span>

<span class="sd">        :return: ProQuest JWT bearer token</span>
<span class="sd">        :rtype: core.model.credential.Credential</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">affiliation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_patron_affiliation_id</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_client</span><span class="o">.</span><span class="n">create_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">affiliation_id</span><span class="p">)</span>
            <span class="n">token_expiration_timeout</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">token_expiration_timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">token_expiration_timeout</span>
                <span class="k">else</span> <span class="n">ProQuestOPDS2ImporterConfiguration</span><span class="o">.</span><span class="n">DEFAULT_TOKEN_EXPIRATION_TIMEOUT_SECONDS</span>
            <span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_credential_manager</span><span class="o">.</span><span class="n">save_proquest_token</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                <span class="n">patron</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">token_expiration_timeout</span><span class="p">),</span>
                <span class="n">token</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">token</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Cannot create a ProQuest JWT bearer token&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">CannotCreateProQuestTokenError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_or_create_proquest_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an existing or create a new ProQuest JWT bearer token.</span>

<span class="sd">        :param patron: Patron object</span>
<span class="sd">        :type patron: core.model.patron.Patron</span>

<span class="sd">        :param configuration: Configuration object</span>
<span class="sd">        :type configuration: ProQuestOPDS2ImporterConfiguration</span>

<span class="sd">        :return: ProQuest JWT bearer token</span>
<span class="sd">        :rtype: core.model.credential.Credential</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_credential_manager</span><span class="o">.</span><span class="n">lookup_proquest_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Patron </span><span class="si">{0}</span><span class="s2"> has the following token: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_proquest_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">_get_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">document_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a book&#39;s content (in the case of open-access books) or a book&#39;s link otherwise.</span>

<span class="sd">        :param patron: Patron object</span>
<span class="sd">        :type patron: core.model.patron.Patron</span>

<span class="sd">        :param configuration: Configuration object</span>
<span class="sd">        :type configuration: ProQuestOPDS2ImporterConfiguration</span>

<span class="sd">        :param document_id: ProQuest Doc ID</span>
<span class="sd">        :type document_id: str</span>

<span class="sd">        :return: Either an ACS link to the book or the book content</span>
<span class="sd">        :rtype: api.proquest.client.ProQuestBook</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_proquest_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_client</span><span class="o">.</span><span class="n">get_book</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">credential</span><span class="p">,</span> <span class="n">document_id</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">book</span>
            <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">iterations</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_proquest_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

            <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_extract_image_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publication</span><span class="p">,</span> <span class="n">feed_self_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts a list of LinkData objects containing information about artwork.</span>

<span class="sd">        :param publication: Publication object</span>
<span class="sd">        :type publication: ast_core.Publication</span>

<span class="sd">        :param feed_self_url: Feed&#39;s self URL</span>
<span class="sd">        :type feed_self_url: str</span>

<span class="sd">        :return: List of links metadata</span>
<span class="sd">        :rtype: List[LinkData]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Started extracting image links from </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">encode</span><span class="p">(</span><span class="n">publication</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">image_links</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">image_link</span> <span class="ow">in</span> <span class="n">publication</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">thumbnail_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_link</span><span class="p">(</span>
                <span class="n">image_link</span><span class="p">,</span>
                <span class="n">feed_self_url</span><span class="p">,</span>
                <span class="n">default_link_rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">thumbnail_link</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">THUMBNAIL_IMAGE</span>

            <span class="n">cover_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_link</span><span class="p">(</span>
                <span class="n">image_link</span><span class="p">,</span>
                <span class="n">feed_self_url</span><span class="p">,</span>
                <span class="n">default_link_rel</span><span class="o">=</span><span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cover_link</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="n">Hyperlink</span><span class="o">.</span><span class="n">IMAGE</span>
            <span class="n">cover_link</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">thumbnail_link</span>
            <span class="n">image_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_link</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Finished extracting image links from </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">encode</span><span class="p">(</span><span class="n">publication</span><span class="o">.</span><span class="n">images</span><span class="p">),</span> <span class="n">encode</span><span class="p">(</span><span class="n">image_links</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">image_links</span>

    <span class="k">def</span> <span class="nf">_extract_media_types_and_drm_scheme_from_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract information about content&#39;s media type and used DRM schema from the link.</span>

<span class="sd">        We consider viable the following two options:</span>
<span class="sd">        1. DRM-free books</span>
<span class="sd">        {</span>
<span class="sd">            &quot;rel&quot;: &quot;http://opds-spec.org/acquisition&quot;,</span>
<span class="sd">            &quot;href&quot;: &quot;http://distributor.com/bookID&quot;,</span>
<span class="sd">            &quot;type&quot;: &quot;application/epub+zip&quot;</span>
<span class="sd">        }</span>

<span class="sd">        2. DRM-protected books</span>
<span class="sd">        {</span>
<span class="sd">            &quot;rel&quot;: &quot;http://opds-spec.org/acquisition&quot;,</span>
<span class="sd">            &quot;href&quot;: &quot;http://distributor.com/bookID&quot;,</span>
<span class="sd">            &quot;type&quot;: &quot;application/vnd.adobe.adept+xml&quot;,</span>
<span class="sd">            &quot;properties&quot;: {</span>
<span class="sd">                &quot;indirectAcquisition&quot;: [</span>
<span class="sd">                    {</span>
<span class="sd">                        &quot;type&quot;: &quot;application/epub+zip&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        :param link: Link object</span>
<span class="sd">        :type link: ast_core.Link</span>

<span class="sd">        :return: 2-tuple containing information about the content&#39;s media type and its DRM schema</span>
<span class="sd">        :rtype: List[Tuple[str, str]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Started extracting media types and a DRM scheme from </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">encode</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">media_types_and_drm_scheme</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">availability</span>
                <span class="ow">or</span> <span class="n">link</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">availability</span><span class="o">.</span><span class="n">state</span>
                <span class="o">==</span> <span class="n">opds2_ast</span><span class="o">.</span><span class="n">OPDS2AvailabilityType</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="o">.</span><span class="n">value</span>
            <span class="p">):</span>
                <span class="n">drm_scheme</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">type</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">KNOWN_DRM_TYPES</span>
                    <span class="k">else</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">NO_DRM</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">acquisition_object</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">indirect_acquisition</span><span class="p">:</span>
                    <span class="n">media_types_and_drm_scheme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">acquisition_object</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">drm_scheme</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">link</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">BOOK_MEDIA_TYPES</span>
                <span class="ow">or</span> <span class="n">link</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">MediaTypes</span><span class="o">.</span><span class="n">AUDIOBOOK_MEDIA_TYPES</span>
            <span class="p">):</span>
                <span class="c1"># Despite the fact that the book is DRM-free, we set its DRM type as DeliveryMechanism.BEARER_TOKEN.</span>
                <span class="c1"># We need it to allow the book to be downloaded by a client app.</span>
                <span class="n">media_types_and_drm_scheme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Finished extracting media types and a DRM scheme from </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">encode</span><span class="p">(</span><span class="n">link</span><span class="p">),</span> <span class="n">encode</span><span class="p">(</span><span class="n">media_types_and_drm_scheme</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">media_types_and_drm_scheme</span>

    <span class="k">def</span> <span class="nf">_parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the identifier and return an Identifier object representing it.</span>

<span class="sd">        :param identifier: String containing the identifier</span>
<span class="sd">        :type identifier: str</span>

<span class="sd">        :return: Identifier object</span>
<span class="sd">        :rtype: Identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

<div class="viewcode-block" id="ProQuestOPDS2Importer.extract_next_links"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.extract_next_links">[docs]</a>    <span class="k">def</span> <span class="nf">extract_next_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract &quot;next&quot; links from the feed.</span>

<span class="sd">        :param feed: OPDS 2.0 feed</span>
<span class="sd">        :type feed: Union[str, opds2_ast.OPDS2Feed]</span>

<span class="sd">        :return: List of &quot;next&quot; links</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.patron_activity"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.patron_activity">[docs]</a>    <span class="k">def</span> <span class="nf">patron_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return patron&#39;s loans.</span>

<span class="sd">        TODO This and code from ODLAPI should be refactored into a generic set of rules</span>
<span class="sd">        for any situation where the CM, not the remote API, is responsible for managing loans and holds.</span>

<span class="sd">        :param patron: A Patron object for the patron who wants to check out the book</span>
<span class="sd">        :type patron: Patron</span>

<span class="sd">        :param pin: The patron&#39;s alleged password</span>
<span class="sd">        :type pin: string</span>

<span class="sd">        :return: List of patron&#39;s loans</span>
<span class="sd">        :rtype: List[LoanInfo]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">loans</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Loan</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Collection</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_id</span><span class="p">,</span>
                <span class="n">Loan</span><span class="o">.</span><span class="n">patron</span> <span class="o">==</span> <span class="n">patron</span><span class="p">,</span>
                <span class="n">or_</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Loan</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">),</span>
                <span class="n">or_</span><span class="p">(</span><span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Loan</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">loan_info_objects</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">loan</span> <span class="ow">in</span> <span class="n">loans</span><span class="p">:</span>
            <span class="n">licensepool</span> <span class="o">=</span> <span class="n">get_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">LicensePool</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">license_pool_id</span><span class="p">)</span>

            <span class="n">loan_info_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">LoanInfo</span><span class="p">(</span>
                    <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">start_date</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">end_date</span><span class="o">=</span><span class="n">loan</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                    <span class="n">fulfillment_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">external_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">loan_info_objects</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.place_hold"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.place_hold">[docs]</a>    <span class="k">def</span> <span class="nf">place_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">notification_email_address</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.release_hold"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.release_hold">[docs]</a>    <span class="k">def</span> <span class="nf">release_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.internal_format"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.internal_format">[docs]</a>    <span class="k">def</span> <span class="nf">internal_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delivery_mechanism</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up the internal format for this delivery mechanism or raise an exception.</span>

<span class="sd">        :param delivery_mechanism: A LicensePoolDeliveryMechanism</span>
<span class="sd">        :type delivery_mechanism: LicensePoolDeliveryMechanism</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">delivery_mechanism</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.checkout"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">licensepool</span><span class="p">,</span> <span class="n">internal_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checkout the book.</span>

<span class="sd">        NOTE: This method requires the patron to have either:</span>
<span class="sd">        - an active ProQuest JWT bearer token</span>
<span class="sd">        - or a SAML affiliation ID which will be used to create a new ProQuest JWT bearer token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Started checking out &#39;</span><span class="si">{0}</span><span class="s2">&#39; for patron </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">internal_format</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span> <span class="k">as</span> <span class="n">configuration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_proquest_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

                <span class="n">loan_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">default_loan_period</span><span class="p">(</span><span class="n">patron</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">loan_period</span><span class="p">)</span>
                <span class="n">loan</span> <span class="o">=</span> <span class="n">LoanInfo</span><span class="p">(</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                    <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">identifier_type</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">identifier</span><span class="o">=</span><span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                    <span class="n">start_date</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                    <span class="n">end_date</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                    <span class="n">fulfillment_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">external_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Finished checking out </span><span class="si">{0}</span><span class="s2"> for patron </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">internal_format</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">loan</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">loan</span>
        <span class="k">except</span> <span class="n">BaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to check out </span><span class="si">{0}</span><span class="s2"> for patron </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CannotLoan</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.fulfill"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.fulfill">[docs]</a>    <span class="k">def</span> <span class="nf">fulfill</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">patron</span><span class="p">,</span>
        <span class="n">pin</span><span class="p">,</span>
        <span class="n">licensepool</span><span class="p">,</span>
        <span class="n">internal_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fulfill_part_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fulfill the loan.</span>

<span class="sd">        NOTE: This method requires the patron to have either:</span>
<span class="sd">        - an active ProQuest JWT bearer token</span>
<span class="sd">        - or a SAML affiliation ID which will be used to create a new ProQuest JWT bearer token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Started fulfilling &#39;</span><span class="si">{0}</span><span class="s2">&#39; for patron </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">internal_format</span><span class="p">,</span> <span class="n">patron</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span> <span class="k">as</span> <span class="n">configuration</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_proquest_token</span><span class="p">(</span><span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
                <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_book</span><span class="p">(</span>
                    <span class="n">patron</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fulfillment_info</span> <span class="o">=</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                        <span class="n">content_link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">content_type</span>
                        <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">content_type</span>
                        <span class="k">else</span> <span class="n">internal_format</span><span class="o">.</span><span class="n">delivery_mechanism</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">content_expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="n">expires_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="n">token_document</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
                        <span class="n">access_token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">credential</span><span class="p">,</span>
                        <span class="n">expires_in</span><span class="o">=</span><span class="n">expires_in</span><span class="p">,</span>
                        <span class="n">location</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">link</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="n">FulfillmentInfo</span><span class="p">(</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="n">licensepool</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                        <span class="n">content_link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="n">DeliveryMechanism</span><span class="o">.</span><span class="n">BEARER_TOKEN</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">token_document</span><span class="p">),</span>
                        <span class="n">content_expires</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Finished fulfilling </span><span class="si">{0}</span><span class="s2"> for patron </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">internal_format</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">fulfillment_info</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">fulfillment_info</span>
        <span class="k">except</span> <span class="n">BaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to fulfill out </span><span class="si">{0}</span><span class="s2"> for patron </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">CannotFulfill</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProQuestOPDS2Importer.external_integration"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2Importer.external_integration">[docs]</a>    <span class="k">def</span> <span class="nf">external_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an external integration associated with this object.</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :return: External integration associated with this object</span>
<span class="sd">        :rtype: core.model.configuration.ExternalIntegration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">external_integration</span></div></div>


<div class="viewcode-block" id="ProQuestOPDS2ImportMonitor"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2ImportMonitor">[docs]</a><span class="k">class</span> <span class="nc">ProQuestOPDS2ImportMonitor</span><span class="p">(</span><span class="n">OPDS2ImportMonitor</span><span class="p">,</span> <span class="n">HasExternalIntegration</span><span class="p">):</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">PROQUEST</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client_factory</span><span class="p">,</span>
        <span class="n">db</span><span class="p">,</span>
        <span class="n">collection</span><span class="p">,</span>
        <span class="n">import_class</span><span class="p">,</span>
        <span class="n">force_reimport</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">process_removals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">import_class_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new instance of ProQuestOPDS2ImportMonitor class.</span>

<span class="sd">        :param client_factory: ProQuest API client</span>
<span class="sd">        :type client_factory: api.proquest.client.ProQuestAPIClientFactory</span>

<span class="sd">        :param db: Database session</span>
<span class="sd">        :type db: sqlalchemy.orm.session.Session</span>

<span class="sd">        :param collection: Collection instance</span>
<span class="sd">        :type collection: core.model.collection.Collection</span>

<span class="sd">        :param import_class: Class containing the import logic</span>
<span class="sd">        :type import_class: Type</span>

<span class="sd">        :param force_reimport: Boolean value indicating whether the import process must be started from scratch</span>
<span class="sd">        :type force_reimport: bool</span>

<span class="sd">        :param process_removals: Boolean value indicating whether</span>
<span class="sd">            the monitor must process removals and clean items</span>
<span class="sd">            that are no longer present in the ProQuest feed from the CM&#39;s catalog</span>
<span class="sd">        :type process_removals: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProQuestOPDS2ImportMonitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">db</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">import_class</span><span class="p">,</span> <span class="n">force_reimport</span><span class="p">,</span> <span class="o">**</span><span class="n">import_class_kwargs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_factory</span> <span class="o">=</span> <span class="n">client_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feeds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_removals</span> <span class="o">=</span> <span class="n">process_removals</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the publication&#39;s identifier from its metadata.</span>

<span class="sd">        :param identifier: String containing the identifier</span>
<span class="sd">        :type identifier: str</span>

<span class="sd">        :return: Identifier object</span>
<span class="sd">        :rtype: Identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_publications</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all the publications in the feed.</span>

<span class="sd">        :param feed: OPDS 2.0 feed</span>
<span class="sd">        :type feed: opds2_ast.OPDS2Feed</span>

<span class="sd">        :return: An iterable list of publications containing in the feed</span>
<span class="sd">        :rtype: Iterable[opds2_ast.OPDS2Publication]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feed</span><span class="o">.</span><span class="n">publications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">publication</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">publications</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">publication</span>

        <span class="k">if</span> <span class="n">feed</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">publications</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">publication</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">publications</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">publication</span>

    <span class="k">def</span> <span class="nf">_download_feed_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_pages_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download all the pages of the ProQuest OPDS feed.</span>

<span class="sd">        Downloaded feed pages are dumped to the local disk instead of storing them in memory</span>
<span class="sd">        in order to decrease the memory footprint.</span>

<span class="sd">        We have to wait until all the pages are downloaded because</span>
<span class="sd">        the ProQuest feed structure doesn&#39;t allow us to use short-circuit logic</span>
<span class="sd">        (there is no update date and ordering sometimes is incorrect),</span>
<span class="sd">        and we always have to start from scratch.</span>
<span class="sd">        Hence, we need to have all the pages locally before starting the import process.</span>
<span class="sd">        Otherwise, the import won&#39;t succeed.</span>

<span class="sd">        :param feed_pages_directory: Absolute path to the directory containing temporary files with feed pages</span>
<span class="sd">        :type feed_pages_directory: str</span>

<span class="sd">        :return: List of absolute file names containing feed pages</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started downloading feed pages&quot;</span><span class="p">)</span>

        <span class="n">feed_page_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">feed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">download_all_feed_pages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">):</span>
            <span class="n">feed_page_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">feed_pages_directory</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">feed_page_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="n">feed</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">feed_page_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">feed_page_content</span><span class="p">)</span>
                <span class="n">feed_page_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">feed_page_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feed_page_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;An unexpected error occurred during saving a feed page to a temporary file&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished downloading </span><span class="si">{0}</span><span class="s2"> feed pages&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feed_page_files</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">feed_page_files</span>

    <span class="k">def</span> <span class="nf">_parse_feed_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">feed_page_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the ProQuest feed page residing in a temporary file on a local disk.</span>

<span class="sd">        :param page: Index of the page</span>
<span class="sd">        :type page: int</span>

<span class="sd">        :param feed_page_file: Absolute path to a temporary file containing the feed page</span>
<span class="sd">        :type feed_page_file: str</span>

<span class="sd">        :return: Parsed OPDS feed page</span>
<span class="sd">        :rtype: opds2_ast.OPDS2Feed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Page # </span><span class="si">{0}</span><span class="s2">. Started parsing the feed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">feed_page_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">feed_page_file_handle</span><span class="p">:</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feed_page_file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">feed</span> <span class="o">=</span> <span class="n">parse_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Page # </span><span class="si">{0}</span><span class="s2">. Finished parsing the feed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">feed</span>

    <span class="k">def</span> <span class="nf">_collect_feed_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">feed_identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Keep track of all identifiers in the ProQuest feed and save them in a list.</span>

<span class="sd">        :param feed: ProQuest OPDS 2.0 feed</span>
<span class="sd">        :type feed: opds2_ast.OPDS2Feed</span>

<span class="sd">        :param feed_identifiers: List of identifiers in the ProQuest feed</span>
<span class="sd">        :type feed_identifiers: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">publication</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_publications</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">parse_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">publication</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

            <span class="n">feed_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_removed_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_identifiers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make items that are no longer present in the ProQuest feed to be invisible in the CM&#39;s catalog.</span>

<span class="sd">        :param feed_identifiers: List of identifiers present in the ProQuest feed</span>
<span class="sd">        :type feed_identifiers: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Started removing identifiers that are no longer present in the ProQuest feed&quot;</span>
        <span class="p">)</span>

        <span class="n">items_to_remove</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">LicensePool</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Collection</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Identifier</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Collection</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Identifier</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">feed_identifiers</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_to_remove</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">unlimited_access</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished removing identifiers that are no longer present in the ProQuest feed&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_feeds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a generator object traversing through a list of the ProQuest OPDS 2.0 feed pages.</span>

<span class="sd">        :return: Generator object traversing through a list of the ProQuest OPDS 2.0 feed pages</span>
<span class="sd">        :rtype: Iterable[opds2_ast.OPDS2Feed]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started fetching ProQuest paged OPDS 2.0 feeds&quot;</span><span class="p">)</span>

        <span class="n">feed_pages_directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">feed_page_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_feed_pages</span><span class="p">(</span><span class="n">feed_pages_directory</span><span class="p">)</span>

            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">processed_number_of_items</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_number_of_items</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started processing feed pages&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">feed_page_file</span> <span class="ow">in</span> <span class="n">feed_page_files</span><span class="p">:</span>
                <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_feed_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">feed_page_file</span><span class="p">)</span>

                <span class="c1"># FIXME: We cannot short-circuit the feed import process</span>
                <span class="c1">#  because ProQuest feed is not ordered by the publication&#39;s modified date.</span>
                <span class="c1">#  This issue will be addressed in https://jira.nypl.org/browse/SIMPLY-3343</span>
                <span class="c1"># if not self.feed_contains_new_data(feed):</span>
                <span class="c1">#     break</span>

                <span class="k">if</span> <span class="n">total_number_of_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total_number_of_items</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">feed</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">number_of_items</span>
                        <span class="k">if</span> <span class="n">feed</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">number_of_items</span>
                        <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>

                <span class="n">processed_number_of_items</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">feed</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items_per_page</span> <span class="k">if</span> <span class="n">feed</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items_per_page</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Page # </span><span class="si">{0}</span><span class="s2">. Processed </span><span class="si">{1}</span><span class="s2"> items out of </span><span class="si">{2}</span><span class="s2"> (</span><span class="si">{3:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">page</span><span class="p">,</span>
                        <span class="n">processed_number_of_items</span><span class="p">,</span>
                        <span class="n">total_number_of_items</span><span class="p">,</span>
                        <span class="n">processed_number_of_items</span> <span class="o">/</span> <span class="n">total_number_of_items</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">page</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">yield</span> <span class="kc">None</span><span class="p">,</span> <span class="n">feed</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Finished processing </span><span class="si">{0}</span><span class="s2"> feed pages&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feed_page_files</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An unexpected exception occurred during fetching ProQuest paged OPDS 2.0 feeds&quot;</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">feed_pages_directory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished fetching ProQuest paged OPDS 2.0 feeds&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ProQuestOPDS2ImportMonitor.run_once"><a class="viewcode-back" href="../../../api.proquest.html#api.proquest.importer.ProQuestOPDS2ImportMonitor.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_ignore</span><span class="p">):</span>
        <span class="c1"># This list is used to keep track of all identifiers in the ProQuest feed.</span>
        <span class="n">feed_identifiers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">feeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feeds</span><span class="p">()</span>
        <span class="n">total_imported</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_failures</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">link</span><span class="p">,</span> <span class="n">feed</span> <span class="ow">in</span> <span class="n">feeds</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_removals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_collect_feed_identifiers</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">feed_identifiers</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Importing next feed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
            <span class="n">imported_editions</span><span class="p">,</span> <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_one_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
            <span class="n">total_imported</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imported_editions</span><span class="p">)</span>
            <span class="n">total_failures</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">achievements</span> <span class="o">=</span> <span class="s2">&quot;Items imported: </span><span class="si">%d</span><span class="s2">. Failures: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">total_imported</span><span class="p">,</span>
            <span class="n">total_failures</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_removals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_removed_items</span><span class="p">(</span><span class="n">feed_identifiers</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TimestampData</span><span class="p">(</span><span class="n">achievements</span><span class="o">=</span><span class="n">achievements</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0b1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>