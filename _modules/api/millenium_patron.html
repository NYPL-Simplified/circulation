
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>api.millenium_patron &#8212; Library Simplified Circulation Manager  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for api.millenium_patron</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Money</span>
<span class="kn">from</span> <span class="nn">flask_babel</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">core.util.datetime_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_utc</span><span class="p">,</span>
    <span class="n">utc_now</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.xmlparser</span> <span class="kn">import</span> <span class="n">XMLParser</span>
<span class="kn">from</span> <span class="nn">.authenticator</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BasicAuthenticationProvider</span><span class="p">,</span>
    <span class="n">PatronData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">CannotLoadConfiguration</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_one</span><span class="p">,</span>
    <span class="n">get_one_or_create</span><span class="p">,</span>
    <span class="n">ExternalIntegration</span><span class="p">,</span>
    <span class="n">Patron</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">core.util.http</span> <span class="kn">import</span> <span class="n">HTTP</span>
<span class="kn">from</span> <span class="nn">core.util</span> <span class="kn">import</span> <span class="n">MoneyUtility</span>

<div class="viewcode-block" id="MilleniumPatronAPI"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI">[docs]</a><span class="k">class</span> <span class="nc">MilleniumPatronAPI</span><span class="p">(</span><span class="n">BasicAuthenticationProvider</span><span class="p">,</span> <span class="n">XMLParser</span><span class="p">):</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;Millenium&quot;</span>

    <span class="n">RECORD_NUMBER_FIELD</span> <span class="o">=</span> <span class="s1">&#39;RECORD #[p81]&#39;</span>
    <span class="n">PATRON_TYPE_FIELD</span> <span class="o">=</span> <span class="s1">&#39;P TYPE[p47]&#39;</span>
    <span class="n">EXPIRATION_FIELD</span> <span class="o">=</span> <span class="s1">&#39;EXP DATE[p43]&#39;</span>
    <span class="n">HOME_BRANCH_FIELD</span> <span class="o">=</span> <span class="s1">&#39;HOME LIBR[p53]&#39;</span>
    <span class="n">ADDRESS_FIELD</span> <span class="o">=</span> <span class="s1">&#39;ADDRESS[pa]&#39;</span>
    <span class="n">BARCODE_FIELD</span> <span class="o">=</span> <span class="s1">&#39;P BARCODE[pb]&#39;</span>
    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s1">&#39;ALT ID[pu]&#39;</span>
    <span class="n">FINES_FIELD</span> <span class="o">=</span> <span class="s1">&#39;MONEY OWED[p96]&#39;</span>
    <span class="n">BLOCK_FIELD</span> <span class="o">=</span> <span class="s1">&#39;MBLOCK[p56]&#39;</span>
    <span class="n">ERROR_MESSAGE_FIELD</span> <span class="o">=</span> <span class="s1">&#39;ERRMSG&#39;</span>
    <span class="n">PERSONAL_NAME_FIELD</span> <span class="o">=</span> <span class="s1">&#39;PATRN NAME[pn]&#39;</span>
    <span class="n">EMAIL_ADDRESS_FIELD</span> <span class="o">=</span> <span class="s1">&#39;EMAIL ADDR[pz]&#39;</span>
    <span class="n">EXPIRATION_DATE_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%y&#39;</span>

    <span class="n">MULTIVALUE_FIELDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;NOTE[px]&#39;</span><span class="p">,</span> <span class="n">BARCODE_FIELD</span><span class="p">])</span>

    <span class="n">DEFAULT_CURRENCY</span> <span class="o">=</span> <span class="s2">&quot;USD&quot;</span>

    <span class="c1"># Identifiers that contain any of these strings are ignored when</span>
    <span class="c1"># finding the &quot;correct&quot; identifier in a patron&#39;s record, even if</span>
    <span class="c1"># it means they end up with no identifier at all.</span>
    <span class="n">IDENTIFIER_BLACKLIST</span> <span class="o">=</span> <span class="s1">&#39;identifier_blacklist&#39;</span>

    <span class="c1"># A configuration value for whether or not to validate the SSL certificate</span>
    <span class="c1"># of the Millenium Patron API server.</span>
    <span class="n">VERIFY_CERTIFICATE</span> <span class="o">=</span> <span class="s2">&quot;verify_certificate&quot;</span>

    <span class="c1"># The field to use when validating a patron&#39;s credential.</span>
    <span class="n">AUTHENTICATION_MODE</span> <span class="o">=</span> <span class="s1">&#39;auth_mode&#39;</span>
    <span class="n">PIN_AUTHENTICATION_MODE</span> <span class="o">=</span> <span class="s1">&#39;pin&#39;</span>
    <span class="n">FAMILY_NAME_AUTHENTICATION_MODE</span> <span class="o">=</span> <span class="s1">&#39;family_name&#39;</span>

    <span class="n">NEIGHBORHOOD_MODE</span> <span class="o">=</span> <span class="s1">&#39;neighborhood_mode&#39;</span>
    <span class="n">NO_NEIGHBORHOOD_MODE</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span>
    <span class="n">HOME_BRANCH_NEIGHBORHOOD_MODE</span> <span class="o">=</span> <span class="s1">&#39;home_branch&#39;</span>
    <span class="n">POSTAL_CODE_NEIGHBORHOOD_MODE</span> <span class="o">=</span> <span class="s1">&#39;postal_code&#39;</span>
    <span class="n">NEIGHBORHOOD_MODES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">[</span><span class="n">NO_NEIGHBORHOOD_MODE</span><span class="p">,</span> <span class="n">HOME_BRANCH_NEIGHBORHOOD_MODE</span><span class="p">,</span> <span class="n">POSTAL_CODE_NEIGHBORHOOD_MODE</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># The field to use when seeing which values of MBLOCK[p56] mean a patron</span>
    <span class="c1"># is blocked. By default, any value other than &#39;-&#39; indicates a block.</span>
    <span class="n">BLOCK_TYPES</span> <span class="o">=</span> <span class="s1">&#39;block_types&#39;</span>

    <span class="n">AUTHENTICATION_MODES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PIN_AUTHENTICATION_MODE</span><span class="p">,</span> <span class="n">FAMILY_NAME_AUTHENTICATION_MODE</span>
    <span class="p">]</span>

    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">ExternalIntegration</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">),</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">VERIFY_CERTIFICATE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Certificate Verification&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Verify Certificate Normally (Required for production)&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Ignore Certificate Problems (For temporary testing only)&quot;</span><span class="p">)</span> <span class="p">},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">BLOCK_TYPES</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Block types&quot;</span><span class="p">),</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Values of MBLOCK[p56] which mean a patron is blocked. By default, any value other than &#39;-&#39; indicates a block.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">IDENTIFIER_BLACKLIST</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Identifier Blacklist&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Identifiers containing any of these strings are ignored when finding the &#39;correct&#39; &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;identifier for a patron&#39;s record, even if it means they end up with no identifier at all. &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;If librarians invalidate library cards by adding strings like </span><span class="se">\&quot;</span><span class="s2">EXPIRED</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">INVALID</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;on to the beginning of the card number, put those strings here so the Circulation Manager &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;knows they do not represent real card numbers.&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">AUTHENTICATION_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Authentication Mode&quot;</span><span class="p">),</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
          <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">PIN_AUTHENTICATION_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PIN&quot;</span><span class="p">)</span> <span class="p">},</span>
              <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">FAMILY_NAME_AUTHENTICATION_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Family Name&quot;</span><span class="p">)</span> <span class="p">},</span>
          <span class="p">],</span>
          <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">PIN_AUTHENTICATION_MODE</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NEIGHBORHOOD_MODE</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron neighborhood field&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;It&#39;s sometimes possible to guess a patron&#39;s neighborhood from their ILS record. You can use this when analyzing circulation activity by neighborhood. If you don&#39;t need to do this, it&#39;s better for patron privacy to disable this feature.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">NO_NEIGHBORHOOD_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Disable this feature&quot;</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">HOME_BRANCH_NEIGHBORHOOD_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron&#39;s home library branch is their neighborhood.&quot;</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">POSTAL_CODE_NEIGHBORHOOD_MODE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Patron&#39;s postal code is their neighborhood.&quot;</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">NO_NEIGHBORHOOD_MODE</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">BasicAuthenticationProvider</span><span class="o">.</span><span class="n">SETTINGS</span>

    <span class="c1"># Replace library settings to allow text in identifier field.</span>
    <span class="n">LIBRARY_SETTINGS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">BasicAuthenticationProvider</span><span class="o">.</span><span class="n">LIBRARY_SETTINGS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">BasicAuthenticationProvider</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_FIELD</span><span class="p">:</span>
            <span class="n">LIBRARY_SETTINGS</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">BasicAuthenticationProvider</span><span class="o">.</span><span class="n">LIBRARY_IDENTIFIER_FIELD</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Library Identifier Field&quot;</span><span class="p">),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is the field on the patron record that the &lt;em&gt;Library Identifier Restriction &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;Type&lt;/em&gt; is applied to. The option &#39;barcode&#39; matches the users barcode, other &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;values are pulled directly from the patron record for example: &#39;P TYPE[p47]&#39;. &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;This value is not used if &lt;em&gt;Library Identifier Restriction Type&lt;/em&gt; &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;is set to &#39;No restriction&#39;.&quot;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LIBRARY_SETTINGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MilleniumPatronAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Millenium Patron API server not configured.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_certificate</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VERIFY_CERTIFICATE</span><span class="p">)</span><span class="o">.</span><span class="n">json_value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_certificate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_certificate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">()</span>

        <span class="c1"># In a Sierra ILS, a patron may have a large number of</span>
        <span class="c1"># identifiers, some of which are not real library cards. A</span>
        <span class="c1"># blacklist allows us to exclude certain types of identifiers</span>
        <span class="c1"># from being considered as library cards.</span>
        <span class="n">authorization_identifier_blacklist</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_BLACKLIST</span><span class="p">)</span><span class="o">.</span><span class="n">json_value</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">authorization_identifier_blacklist</span><span class="p">]</span>

        <span class="n">auth_mode</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AUTHENTICATION_MODE</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">PIN_AUTHENTICATION_MODE</span>

        <span class="k">if</span> <span class="n">auth_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTHENTICATION_MODES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Unrecognized Millenium Patron API authentication mode: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">auth_mode</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">auth_mode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">block_types</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_TYPES</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="n">neighborhood_mode</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NEIGHBORHOOD_MODE</span>
        <span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_NEIGHBORHOOD_MODE</span>
        <span class="k">if</span> <span class="n">neighborhood_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEIGHBORHOOD_MODES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotLoadConfiguration</span><span class="p">(</span>
                <span class="s2">&quot;Unrecognized Millenium Patron API neighborhood mode: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">neighborhood_mode</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighborhood_mode</span> <span class="o">=</span> <span class="n">neighborhood_mode</span>


    <span class="c1"># Begin implementation of BasicAuthenticationProvider abstract</span>
    <span class="c1"># methods.</span>

    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP request and parse the response.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MilleniumPatronAPI.remote_authenticate"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI.remote_authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">remote_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the Millenium Patron API approve of these credentials?</span>

<span class="sd">        :return: False if the credentials are invalid. If they are</span>
<span class="sd">            valid, a PatronData that serves only to indicate which</span>
<span class="sd">            authorization identifier the patron prefers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collects_password</span><span class="p">:</span>
            <span class="c1"># We don&#39;t even look at the password. If the patron exists, they</span>
            <span class="c1"># are authenticated.</span>
            <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_patron_lookup</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">patrondata</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PIN_AUTHENTICATION_MODE</span><span class="p">:</span>
            <span class="c1"># Patrons are authenticated with a secret PIN.</span>
            <span class="c1">#</span>
            <span class="c1"># The PIN is URL-encoded. The username is not: as far as</span>
            <span class="c1"># we can tell Millenium Patron doesn&#39;t even try to decode</span>
            <span class="c1"># it.</span>
            <span class="n">quoted_password</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">password</span> <span class="k">else</span> <span class="n">password</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(barcode)s</span><span class="s2">/</span><span class="si">%(pin)s</span><span class="s2">/pintest&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">barcode</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="n">quoted_password</span>
            <span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="n">path</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_text_nodes</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RETCOD&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PatronData</span><span class="p">(</span><span class="n">authorization_identifier</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAMILY_NAME_AUTHENTICATION_MODE</span><span class="p">:</span>
            <span class="c1"># Patrons are authenticated by their family name.</span>
            <span class="n">patrondata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_patron_lookup</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">patrondata</span><span class="p">:</span>
                <span class="c1"># The patron doesn&#39;t even exist.</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># The patron exists; but do the last names match?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family_name_match</span><span class="p">(</span><span class="n">patrondata</span><span class="o">.</span><span class="n">personal_name</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
                <span class="c1"># Since this is a complete PatronData, we&#39;ll be able</span>
                <span class="c1"># to update their account without making a separate</span>
                <span class="c1"># call to /dump.</span>
                <span class="k">return</span> <span class="n">patrondata</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MilleniumPatronAPI.family_name_match"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI.family_name_match">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">family_name_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual_name</span><span class="p">,</span> <span class="n">supposed_family_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does `supposed_family_name` match `actual_name`?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actual_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">supposed_family_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">actual_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">actual_family_name</span> <span class="o">=</span> <span class="n">actual_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actual_name_split</span> <span class="o">=</span> <span class="n">actual_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">actual_family_name</span> <span class="o">=</span> <span class="n">actual_name_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">actual_family_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">supposed_family_name</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_patrondata_or_identifier</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patron_or_patrondata_or_identifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">patron_or_patrondata_or_identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">patron_or_patrondata_or_identifier</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="sd">&quot;&quot;&quot;Look up patron information for the given identifier.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(barcode)s</span><span class="s2">/dump&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">barcode</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="n">path</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patron_dump_to_patrondata</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>


    <span class="c1"># End implementation of BasicAuthenticationProvider abstract</span>
    <span class="c1"># methods.</span>

<div class="viewcode-block" id="MilleniumPatronAPI.request"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually make an HTTP request. This method exists only so the mock</span>
<span class="sd">        can override it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_request_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">request_with_timeout</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_request_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the kwargs to HTTP.request_with_timeout to reflect the API</span>
<span class="sd">        configuration, in a testable way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verify&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_certificate</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_patron_block_reason</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">block_types</span><span class="p">,</span> <span class="n">mblock_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn a value of the MBLOCK[56] field into a block type.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">block_types</span> <span class="ow">and</span> <span class="n">mblock_value</span> <span class="ow">in</span> <span class="n">block_types</span><span class="p">:</span>
            <span class="c1"># We are looking for a specific value, and we found it</span>
            <span class="k">return</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">UNKNOWN_BLOCK</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">block_types</span><span class="p">:</span>
            <span class="c1"># Apply the default rules.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mblock_value</span> <span class="ow">or</span> <span class="n">mblock_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="c1"># This patron is not blocked at all.</span>
                <span class="k">return</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This patron is blocked for an unknown reason.</span>
                <span class="k">return</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">UNKNOWN_BLOCK</span>

        <span class="c1"># We have specific types that mean the patron is blocked.</span>
        <span class="k">if</span> <span class="n">mblock_value</span> <span class="ow">in</span> <span class="n">block_types</span><span class="p">:</span>
            <span class="c1"># The patron has one of those types. They are blocked.</span>
            <span class="k">return</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">UNKNOWN_BLOCK</span>

        <span class="c1"># The patron does not have one of those types, so is not blocked.</span>
        <span class="k">return</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>

<div class="viewcode-block" id="MilleniumPatronAPI.patron_dump_to_patrondata"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI.patron_dump_to_patrondata">[docs]</a>    <span class="k">def</span> <span class="nf">patron_dump_to_patrondata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_identifier</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an HTML patron dump to a PatronData object.</span>

<span class="sd">        :param current_identifier: Either the authorization identifier</span>
<span class="sd">            the patron just logged in with, or the one currently</span>
<span class="sd">            associated with their Patron record. Keeping track of this</span>
<span class="sd">            ensures we don&#39;t change a patron&#39;s preferred authorization</span>
<span class="sd">            identifier out from under them.</span>

<span class="sd">        :param content: The HTML document containing the patron dump.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we don&#39;t see these fields, erase any previous value</span>
        <span class="c1"># rather than leaving the old value in place. This shouldn&#39;t</span>
        <span class="c1"># happen (unless the expiration date changes to an invalid</span>
        <span class="c1"># date), but just to be safe.</span>
        <span class="n">permanent_id</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">authorization_expires</span> <span class="o">=</span> <span class="n">personal_name</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="n">email_address</span> <span class="o">=</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">external_type</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="n">block_reason</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>

        <span class="n">potential_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_text_nodes</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BARCODE_FIELD</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">):</span>
                    <span class="c1"># This barcode contains a blacklisted</span>
                    <span class="c1"># string. Ignore it, even if this means the patron</span>
                    <span class="c1"># ends up with no barcode whatsoever.</span>
                    <span class="k">continue</span>
                <span class="c1"># We&#39;ll figure out which barcode is the &#39;right&#39; one</span>
                <span class="c1"># later.</span>
                <span class="n">potential_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="c1"># The millenium API doesn&#39;t care about spaces, so we add</span>
                <span class="c1"># a version of the barcode without spaces to our identifers</span>
                <span class="c1"># list as well.</span>
                <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">potential_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD_NUMBER_FIELD</span><span class="p">:</span>
                <span class="n">permanent_id</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">USERNAME_FIELD</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PERSONAL_NAME_FIELD</span><span class="p">:</span>
                <span class="n">personal_name</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMAIL_ADDRESS_FIELD</span><span class="p">:</span>
                <span class="n">email_address</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINES_FIELD</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fines</span> <span class="o">=</span> <span class="n">MoneyUtility</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Malformed fine amount for patron: &quot;</span><span class="si">%s</span><span class="s1">&quot;. Treating as no fines.&#39;</span>
                    <span class="p">)</span>
                    <span class="n">fines</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_FIELD</span><span class="p">:</span>
                <span class="n">block_reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patron_block_reason</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_types</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRATION_FIELD</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Parse the expiration date according to server local</span>
                    <span class="c1"># time, not UTC.</span>
                    <span class="n">expires_local</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                        <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRATION_DATE_FORMAT</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">tzinfo</span><span class="o">=</span><span class="n">dateutil</span><span class="o">.</span><span class="n">tz</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="n">expires_local</span> <span class="o">=</span> <span class="n">expires_local</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">authorization_expires</span> <span class="o">=</span> <span class="n">expires_local</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Malformed expiration date for patron: &quot;</span><span class="si">%s</span><span class="s1">&quot;. Treating as unexpirable.&#39;</span><span class="p">,</span>
                        <span class="n">v</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATRON_TYPE_FIELD</span><span class="p">:</span>
                <span class="n">external_type</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOME_BRANCH_FIELD</span>
                  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighborhood_mode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOME_BRANCH_NEIGHBORHOOD_MODE</span><span class="p">):</span>
                <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADDRESS_FIELD</span>
                  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighborhood_mode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSTAL_CODE_NEIGHBORHOOD_MODE</span><span class="p">):</span>
                <span class="n">neighborhood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_postal_code</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_MESSAGE_FIELD</span><span class="p">:</span>
                <span class="c1"># An error has occured. Most likely the patron lookup</span>
                <span class="c1"># failed.</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Set the library identifier field</span>
        <span class="n">library_identifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_text_nodes</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_identifier_field</span><span class="p">:</span>
                <span class="n">library_identifier</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># We may now have multiple authorization</span>
        <span class="c1"># identifiers. PatronData expects the best authorization</span>
        <span class="c1"># identifier to show up first in the list.</span>
        <span class="c1">#</span>
        <span class="c1"># The last identifier in the list is probably the most recently</span>
        <span class="c1"># added one. In the absence of any other information, it&#39;s the</span>
        <span class="c1"># one we should choose.</span>
        <span class="n">potential_identifiers</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="n">potential_identifiers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">authorization_identifiers</span><span class="p">:</span>
            <span class="n">authorization_identifiers</span> <span class="o">=</span> <span class="n">PatronData</span><span class="o">.</span><span class="n">NO_VALUE</span>
        <span class="k">elif</span> <span class="n">current_identifier</span> <span class="ow">in</span> <span class="n">authorization_identifiers</span><span class="p">:</span>
            <span class="c1"># Don&#39;t rock the boat. The patron is used to using this</span>
            <span class="c1"># identifier and there&#39;s no need to change it. Move the</span>
            <span class="c1"># currently used identifier to the front of the list.</span>
            <span class="n">authorization_identifiers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">current_identifier</span><span class="p">)</span>
            <span class="n">authorization_identifiers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_identifier</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">PatronData</span><span class="p">(</span>
            <span class="n">permanent_id</span><span class="o">=</span><span class="n">permanent_id</span><span class="p">,</span>
            <span class="n">authorization_identifier</span><span class="o">=</span><span class="n">authorization_identifiers</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">personal_name</span><span class="o">=</span><span class="n">personal_name</span><span class="p">,</span>
            <span class="n">email_address</span><span class="o">=</span><span class="n">email_address</span><span class="p">,</span>
            <span class="n">authorization_expires</span><span class="o">=</span><span class="n">authorization_expires</span><span class="p">,</span>
            <span class="n">external_type</span><span class="o">=</span><span class="n">external_type</span><span class="p">,</span>
            <span class="n">fines</span><span class="o">=</span><span class="n">fines</span><span class="p">,</span>
            <span class="n">block_reason</span><span class="o">=</span><span class="n">block_reason</span><span class="p">,</span>
            <span class="n">library_identifier</span><span class="o">=</span><span class="n">library_identifier</span><span class="p">,</span>
            <span class="n">neighborhood</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">,</span>
            <span class="c1"># We must cache neighborhood information in the patron&#39;s</span>
            <span class="c1"># database record because syncing with the ILS is so</span>
            <span class="c1"># expensive.</span>
            <span class="n">cached_neighborhood</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">,</span>
            <span class="n">complete</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">_extract_text_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the HTML representations sent by the Millenium Patron API.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;HTML&gt;&lt;BODY&gt;&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&lt;BR&gt;&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                <span class="c1"># This shouldn&#39;t happen, but there&#39;s no need to crash.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unexpected line in patron dump: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">kv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># A number of regular expressions for finding postal codes in</span>
    <span class="c1"># freeform addresses, with more reliable techniques at the front.</span>
    <span class="n">POSTAL_CODE_RES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;[^0-9]([0-9]</span><span class="si">{5}</span><span class="s2">)-[0-9]</span><span class="si">{4}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="c1"># ZIP+4 at end</span>
            <span class="s2">&quot;[^0-9]([0-9]</span><span class="si">{5}</span><span class="s2">)$&quot;</span><span class="p">,</span> <span class="c1"># ZIP at end</span>
            <span class="s2">&quot;.*[^0-9]([0-9]</span><span class="si">{5}</span><span class="s2">)-[0-9]</span><span class="si">{4}</span><span class="s2">[^0-9]&quot;</span><span class="p">,</span> <span class="c1"># ZIP+4 as close to end as possible without being at the end</span>
            <span class="s2">&quot;.*[^0-9]([0-9]</span><span class="si">{5}</span><span class="s2">)[^0-9]&quot;</span><span class="p">,</span> <span class="c1"># ZIP as close to end as possible without being at the end</span>
        <span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="MilleniumPatronAPI.extract_postal_code"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MilleniumPatronAPI.extract_postal_code">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_postal_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to extract a postal code from an address.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">POSTAL_CODE_RES</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="MockMilleniumPatronAPI"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MockMilleniumPatronAPI">[docs]</a><span class="k">class</span> <span class="nc">MockMilleniumPatronAPI</span><span class="p">(</span><span class="n">MilleniumPatronAPI</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This mocks the API on a higher level than the HTTP level.</span>

<span class="sd">    It is not used in the tests of the MilleniumPatronAPI class.  It</span>
<span class="sd">    is used in the Adobe Vendor ID tests but maybe it shouldn&#39;t.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># For expiration dates we&#39;re using UTC instead of local time for</span>
    <span class="c1"># convenience; the difference doesn&#39;t matter because the dates in</span>
    <span class="c1"># question are at least 10 days away from the current date.</span>

    <span class="c1"># This user&#39;s card has expired.</span>
    <span class="n">user1</span> <span class="o">=</span> <span class="n">PatronData</span><span class="p">(</span>
        <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
        <span class="n">authorization_identifier</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">authorization_expires</span> <span class="o">=</span> <span class="n">datetime_utc</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># This user&#39;s card still has ten days on it.</span>
    <span class="n">the_future</span> <span class="o">=</span> <span class="n">utc_now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">user2</span> <span class="o">=</span> <span class="n">PatronData</span><span class="p">(</span>
        <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;67890&quot;</span><span class="p">,</span>
        <span class="n">authorization_identifier</span><span class="o">=</span><span class="s2">&quot;5&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
        <span class="n">authorization_expires</span> <span class="o">=</span> <span class="n">the_future</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="MockMilleniumPatronAPI.remote_authenticate"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MockMilleniumPatronAPI.remote_authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">remote_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A barcode that&#39;s 14 digits long is treated as valid,</span>
<span class="sd">        no matter which PIN is used.</span>

<span class="sd">        That&#39;s so real barcode/PIN combos can be passed through to</span>
<span class="sd">        third parties.</span>

<span class="sd">        Otherwise, valid test PIN is the first character of the barcode</span>
<span class="sd">        repeated four times.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ERRNUM&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">14</span> <span class="ow">or</span> <span class="n">pin</span> <span class="o">==</span> <span class="n">barcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span></div>

<div class="viewcode-block" id="MockMilleniumPatronAPI.remote_patron_lookup"><a class="viewcode-back" href="../../api.html#api.millenium_patron.MockMilleniumPatronAPI.remote_patron_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">remote_patron_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron_or_patrondata</span><span class="p">):</span>
        <span class="c1"># We have a couple custom barcodes.</span>
        <span class="n">look_for</span> <span class="o">=</span> <span class="n">patron_or_patrondata</span><span class="o">.</span><span class="n">authorization_identifier</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">authorization_identifier</span> <span class="o">==</span> <span class="n">look_for</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">u</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>

<span class="n">AuthenticationProvider</span> <span class="o">=</span> <span class="n">MilleniumPatronAPI</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Library Simplified Circulation Manager</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">circulation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, The New York Public Library, Astor, Lenox, and Tilden Foundations.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>